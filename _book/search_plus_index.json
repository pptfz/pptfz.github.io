{"./":{"url":"./","title":"å…”æ¯”å–ƒæ³¢æ¹¾","keywords":"","body":"ğŸ˜‚ ğŸ˜‚ ğŸ˜‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"2bé—®é¢˜åˆé›†/2bé—®é¢˜åˆé›†ä¹‹sshå¯†é’¥é—®é¢˜.html":{"url":"2bé—®é¢˜åˆé›†/2bé—®é¢˜åˆé›†ä¹‹sshå¯†é’¥é—®é¢˜.html","title":"sshå¯†é’¥é—®é¢˜","keywords":"","body":"2bé—®é¢˜åˆé›†ä¹‹sshå¯†é’¥é—®é¢˜ ä¸€ã€ucloudå…å¯†ç™»é™†é—®é¢˜ èƒŒæ™¯è¯´æ˜ï¼š ucloudäº‘ä¸»æœºï¼Œæƒ³è¦ä½¿ç”¨å¯†é’¥ç™»é™†ï¼Œæucloudå·¥å•å¾—åˆ°å›å¤ucloudå¹¶ä¸æ”¯æŒåœ¨webç•Œé¢åˆ›å»ºå¯†é’¥å¹¶ç»‘å®š(åä¸ºäº‘ã€è…¾è®¯äº‘ã€é˜¿é‡Œäº‘éƒ½æ”¯æŒwebç•Œé¢åˆ›å»ºç»‘å®š)ï¼Œåªèƒ½ç™»é™†ç³»ç»Ÿæ‰‹åŠ¨åˆ›å»ºå¹¶ä¸‹è½½å¯†é’¥ï¼Œäºæ˜¯rootç”¨æˆ·ç™»é™†ucloudäº‘ä¸»æœºæ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ssh-keygenï¼Œä¸‹è½½id_rsaç§é’¥åˆ°æœ¬åœ°ï¼Œç»“æœä½¿ç”¨è¿™ä¸ªç§é’¥å§‹ç»ˆæ— æ³•ç™»é™†ç³»ç»Ÿï¼Œè¿˜ç‰¹ä¹ˆåˆæäº†1ä¸ªucloudå·¥å•é—®äººå®¶æ€ä¹ˆå›äº‹(è™½ç„¶è¿˜é‡åˆ°ä¸€ä¸ªå“¥ä»¬ç»™æˆ‘å›å¤æŠŠç§é’¥æƒé™æ”¹æˆ755è¯•è¯•ã€‚ã€‚ã€‚)ï¼Œæœ€ç»ˆå·¥å•å›å¤å¯†é’¥æœªæ³¨å†Œï¼Œè¯·è‡ªè¡Œæ’æŸ¥ï¼Œæœ€åæŠ˜è…¾åŠå¤©æ‰¾åˆ°ç­”æ¡ˆ åŸå› ï¼š âš ï¸centos7sshæœåŠ¡é…ç½®æ–‡ä»¶/etc/ssh/sshd_configä¸­æœ‰ä¸€é¡¹é…ç½®æ˜¯AuthorizedKeysFile .ssh/authorized_keysï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ç§é’¥å…å¯†ç™»é™†ï¼Œåˆ™å…¬é’¥å¿…é¡»å†™å…¥åˆ°æ–‡ä»¶.ssh/authorized_keysä¸­ï¼Œå³æ³¨å†Œç§é’¥ï¼Œå¦åˆ™å…å¯†ä¼šå¤±è´¥ï¼ï¼ï¼ æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤cat id_rsa.pub >> authorized_keysï¼ŒæŠŠå…¬é’¥æ³¨å†Œåé—®é¢˜è§£å†³ äºŒã€macæ¨é€ä»“åº“åˆ°ç äº‘ èƒŒæ™¯è¯´æ˜ï¼š macæœ¬æœºï¼Œåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºäº†ä¸€ä¸ªç›®å½•ï¼Œå‡†å¤‡æŠŠè¿™ä¸ªç›®å½•ä¸‹çš„å†…å®¹æ¨é€åˆ°ç äº‘æ–°å»ºçš„ä»“åº“ä¸­ï¼Œå·²ç»æ‰‹åŠ¨æŠŠuserç”¨æˆ·çš„å…¬é’¥ç²˜è´´åˆ°äº†ç äº‘çš„ä¸ªäººè´¦æˆ·ä¸­(ç äº‘ä¸­åªæœ‰æŠŠå…¬é’¥æ”¾åˆ°ä¸ªäººè´¦æˆ·ä¸­æ‰èƒ½å¯¹ä»“åº“æœ‰å†™æƒé™)ï¼Œä½†æ˜¯æ¨é€çš„æ—¶å€™å§‹ç»ˆæç¤ºæƒé™æ‹’ç»ï¼Œè€Œä½¿ç”¨å‘½ä»¤ssh -T git@gitee.comç¡®æ˜¯æç¤ºè®¤è¯æˆåŠŸçš„ åŸå› ï¼š åŸå› æ˜¯æ¨é€çš„æ—¶å€™ä½¿ç”¨äº†sudoï¼Œç”¨åˆ°çš„å› è¯¥æ˜¯rootç”¨æˆ·çš„å¯†é’¥ï¼Œä½†æ˜¯åªæŠŠuserç”¨æˆ·çš„å…¬é’¥æ”¾åˆ°äº†ç äº‘ä¸­ï¼Œæ‰€ä»¥æƒé™æ‹’ç»ï¼ŒæŠŠrootç”¨æˆ·çš„å…¬é’¥æ”¾åˆ°ç äº‘ä¸­å°±å¯ä»¥äº† æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/æ’é”™å®å…¸/ECSè¿ç»´æŒ‡å—ä¹‹Linuxç³»ç»Ÿè¯Šæ–­.html":{"url":"linux/æ’é”™å®å…¸/ECSè¿ç»´æŒ‡å—ä¹‹Linuxç³»ç»Ÿè¯Šæ–­.html","title":"ECSè¿ç»´æŒ‡å—ä¹‹Linuxç³»ç»Ÿè¯Šæ–­","keywords":"","body":"ECSè¿ç»´æŒ‡å—ä¹‹Linuxç³»ç»Ÿè¯Šæ–­ æ–‡æ¡£æŠ„è¢­äºé˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº ç›®å½• Linuxå¯åŠ¨ä¸ç™»é™†é—®é¢˜ è¶…è¯¦ç»†ç³»ç»Ÿå¯åŠ¨ä¸ç™»é™†å¼‚å¸¸æ’æŸ¥ç‚¹ grub.conf æ–‡ä»¶å†…å®¹è¢«æ¸…ç©ºäº†æ€ä¹ˆåŠ å·§å¦™åˆ©ç”¨ strace æŸ¥æ‰¾ä¸¢å¤±çš„æ–‡ä»¶ å°å¿ƒ PAM ä¸è®©ä½ ç™»å½• CentOS ç™»å½•å¡ä½çš„åŸå› è¢«æˆ‘æ‰¾åˆ°äº† Linux æ€§èƒ½é—®é¢˜ æ‰¾åˆ° Linux è™šæœº Load é«˜çš„\"å…ƒå‡¶\" OOM killer æ˜¯è¢«è°è§¦å‘çš„ æˆ‘çš„æœåŠ¡å™¨å†…å­˜å»å“ªå„¿äº† CPU å ç”¨ä¸é«˜ä½†ç½‘ç»œæ€§èƒ½å¾ˆå·®çš„ä¸€ä¸ªåŸå›  ä¸€æ¬¡ IO å¼‚å¸¸æ•è·è¿‡ç¨‹ Linux ä¸»æœºç½‘ç»œé—®é¢˜ ifdown ifup å‘½ä»¤ä¸¢å¤±å¤„ç† ç½‘ç»œä¸é€šï¼Ÿ strace äºŒåº¦å‡ºæ‰‹ TIME_WAIT & CLOSE_WAIT çš„è®¨è®ºæ€»ç»“ ä¸€æ¬¡ç½‘ç»œæŠ–åŠ¨ç»å…¸æ¡ˆä¾‹åˆ†æ Linux ç³»ç»ŸæœåŠ¡ä¸å‚æ•°é—®é¢˜ 4 ä¸ª limits ç”Ÿæ•ˆçš„é—®é¢˜ 6 æ­¥æ’æŸ¥ ss& netstat ç»Ÿè®¡ç»“æœä¸ä¸€æ ·çš„åŸå›  ä¸ºä»€ä¹ˆæ˜æ˜å†…å­˜å¾ˆå……è¶³ä½†æ˜¯ java ç¨‹åºä»ç”³è¯·ä¸åˆ°å†…å­˜ è¯·ä¸è¦å¿½ç•¥ min_free_kbytes çš„è®¾ç½® æœ€åçš„å½©è›‹ æŸåœ°åŒºå£ç½©é¡¹ç›®æ¶æ„æ¼”è¿›åŠä¼˜åŒ–ç»éªŒ ä¸€ã€Linuxå¯åŠ¨ä¸ç™»é™†é—®é¢˜ è¯´æ˜ Linux å¯åŠ¨ä¸ç™»å½•é—®é¢˜æ˜¯ ECS çš„é«˜é¢‘é—®é¢˜ï¼Œè€Œå¾€å¾€å¤„ç†ä¸åŠæ—¶ä¼šç›´æ¥å½±å“åˆ°ç”¨æˆ·ä¸šåŠ¡çš„æ­£å¸¸å¯æŒç»­è¿è¡Œï¼Œå› æ­¤ä¹Ÿå˜æˆäº†æˆ‘ä»¬å¤„ç†é—®é¢˜ä¼˜å…ˆçº§çš„é‡ä¸­ä¹‹é‡ã€‚ åœ¨äº‘ç¯å¢ƒä¸Šå½±å“ ECS å¯åŠ¨ä¸ç™»å½•çš„å› ç´ éå¸¸å¤šï¼Œé•œåƒã€ç®¡æ§ã€è™šæ‹ŸåŒ–ã€åº•å±‚ç¡¬ä»¶ã€ç³»ç»Ÿä¸æ–‡ä»¶å¼‚å¸¸ç­‰ç­‰ï¼Œæœ¬æ–‡ä»…ä»ç³»ç»Ÿä¸æ–‡ä»¶æœ¬èº«è§’åº¦ï¼Œåœ¨å¤§é‡å¤„ç†ç»éªŒçš„åŸºç¡€ä¸Šï¼Œå½’çº³æ€»ç»“äº†ä¸€äº›å¯èƒ½ä¼šå¼•èµ·ç³»ç»Ÿå¯åŠ¨ä¸ç™»å½•é—®é¢˜çš„æ’æŸ¥ç‚¹ï¼Œå¹¶ç»™å‡ºå‡ ä¸ªæ¯”è¾ƒå¸¸è§çš„å…¸å‹æ¡ˆä¾‹æ¥å…·ä½“å±•ç¤ºå’Œè¯´æ˜ã€‚ 1.1 è¶…è¯¦ç»†ç³»ç»Ÿå¯åŠ¨ä¸ç™»é™†å¼‚å¸¸æ’æŸ¥ç‚¹ 1.1.1 ç³»ç»Ÿå¯åŠ¨å¼‚å¸¸ éƒ¨åˆ† CentOS ç³»ç»Ÿå¯åŠ¨é»‘å±ï¼Œæ— å¼‚å¸¸æŠ¥é”™çš„åœºæ™¯ï¼Œå¯ä»¥ fsck ä¸€ä¸‹ç³»ç»Ÿç›˜ã€‚ æ ¹åˆ†åŒºç©ºé—´æ»¡ï¼Œä»¥åŠ inode æ•°é‡è€—å°½ã€‚ å‡çº§å†…æ ¸æˆ–è€…ä»è€çš„å…±äº«å®ä¾‹è¿ç§»åˆ°ç‹¬äº«è§„æ ¼å¯¼è‡´çš„å¯åŠ¨å¼‚å¸¸ã€‚ æ‰‹åŠ¨æ³¨å…¥é©±åŠ¨ (mkinitrd virtio ç›¸å…³é©±åŠ¨ )ã€‚ ä¿®æ”¹ grub çš„å¯åŠ¨é¡ºåºï¼Œä¼˜å…ˆå°è¯•ä½¿ç”¨è€å†…æ ¸å¯åŠ¨ã€‚ /boot ç›®å½•ä¸‹é¢å†…æ ¸çš„å…³è”æ–‡ä»¶æ˜¯å¦å…¨ï¼ˆä¸‹é¢ä»…ä¸º demoï¼Œä¸åŒç³»ç»Ÿå†…æ ¸ç‰ˆ æœ¬æ–‡ä»¶ä¸ä¸€è‡´ï¼Œéƒ¨åˆ†å†…æ ¸ç‰ˆæœ¬ boot ä¸‹çš„ i386 ç›®å½•ä¹Ÿæ˜¯æœ‰ç”¨çš„ï¼‰ã€‚ config-4.9.0-7-amd64 initrd.img-4.9.0-7-amd64 System.map-4.9.0-7-amd64 vmlinuz-4.9.0-7-amd64 /boot/grub/device.map é‡Œé¢çš„ hda æ”¹æˆ vdaã€‚ fstab/grub ä¸­çš„ uuid ä¸å¯¹ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ä¸º /dev/vda1 è¿™ç§å½¢å¼å°è¯•ã€‚ æ•°æ®ç›˜åˆ†åŒºå¼‚å¸¸åŠ è½½èµ·ä¸æ¥çš„åœºæ™¯ï¼Œå¯ä»¥å»æ³¨é‡Š fstab æ‰€æœ‰çš„è¡Œï¼Œæ·»åŠ ç±»ä¼¼ä¸‹é¢çš„å¯åŠ¨é¡¹å°è¯•ï¼Œ ä¹Ÿé€‚ç”¨äºç³»ç»Ÿç›˜å¿«ç…§åˆ›å»ºäº‘ç›˜æŒ‚è½½åï¼Œuuid ä¸€è‡´å¯¼è‡´çš„å¯åŠ¨å¼‚ å¸¸ï¼Œæ”¹æˆé UUID çš„æŒ‚è½½å³å¯ã€‚ /dev/vda1 / ext4 defaults 1 1 æ ¹ç›®å½•æƒé™ 777ï¼ˆéƒ¨åˆ†ç›®å½• 777ï¼‰ä¹Ÿä¼šå¯¼è‡´å¯åŠ¨å¼‚å¸¸ï¼Œæˆ–è€… ssh ç™»é™†å¼‚å¸¸ã€‚ å¯å‚è€ƒæ­¤æ–‡ç« æƒé™ä¿®å¤å°è¯• å¸¸è§çš„å…³é”®ç›®å½•ç¼ºå¤±ï¼Œæœ‰çš„æ˜¯è½¯é“¾ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹å¯¹åº”ç›®å½•ä¸‹é¢çš„æ–‡ä»¶æ•°é‡ï¼ˆæ–‡ä»¶æ•°é‡è¦è·ŸåŒå†…æ ¸ç‰ˆæœ¬æˆ–è€…ç›¸å·®ä¸å¤§çš„ç‰ˆæœ¬å¯¹æ¯”ï¼‰ï¼Œç®€å•åˆ¤æ–­ã€‚ /bin /sbin /lib /lib32 /lib64 /etc /boot /usr/bin /usr/sbin /usr/lib / usr/lib64 ç­‰ç›®å½•æˆ–æ–‡ä»¶ç¼ºå¤± for i in /bin /sbin /lib /lib32 /lib64 /etc /boot /usr/bin /usr/sbin / usr/lib /usr/lib64 ;do ls -l $i |wc -l ;done å½±å“å¯åŠ¨çš„å‚æ•°ã€‚ å¦‚æœå‚æ•°è®¾ç½®ä¸å½“ï¼Œæ˜¯ä¼šå¯¼è‡´å¯åŠ¨å¼‚å¸¸çš„ï¼Œå¦‚ /etc/sysctl.conf ä»¥åŠæ£€æŸ¥ rc.local çš„é…ç½®ï¼Œprofile çš„æ£€æŸ¥ã€‚ vm.nr_hugepages vm.min_free_kbytes CentOS çš„ selinux éœ€è¦å…³é—­ã€‚ # This file controls the state of SELinux on the system. # SELINUX= can take one of these three values: # enforcing - SELinux security policy is enforced. # permissive - SELinux prints warnings instead of enforcing. # disabled - No SELinux policy is loaded. SELINUX=disabled # SELINUXTYPE= can take one of three two values: # targeted - Targeted processes are protected, # minimum - Modification of targeted policy. Only selected processes are protected. # mls - Multi Level Security protection. SELINUXTYPE=targeted 1.1.2 root ç™»é™†å¼‚å¸¸ /etc/passwdã€/etc/shadow ( ç”¨æˆ·å root polikt dbus ç­‰å…³é”®ç”¨æˆ·å­˜åœ¨ä¸å¦ï¼Œæ–‡ ä»¶ä¸ºç©ºï¼Œæ ¼å¼ä¹±ï¼ˆdos2unix)ã€‚ /etc/pam.d ç›®å½•ä¸‹æ˜¯å¦æœ‰ä¸ºç©ºçš„æ–‡ä»¶åŠå‚æ•°è®¾ç½®æ˜¯å¦æ­£å¸¸ï¼Œ å¦‚å¸¸è§çš„ system-auth passwdã€‚ /etc/pam.d ä¸‹é¢æ‰€æœ‰æ–‡ä»¶é‡Œé¢æ¶‰åŠçš„ so æ–‡ä»¶ï¼Œçœ‹çœ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯å¦ä¸ºç©º / usr/lib64/securityã€‚ æŸ¥ /etc /lib64ã€ /binã€ /sbinã€/usr/binã€ /usr/sbin ç­‰ç›®å½•æœ‰æ²¡æœ‰ size ä¸º 0 çš„æ–‡ä»¶ã€‚ /etc/profileã€/etc/profile.d( æ‰“ å° åˆ— è¡¨ )ã€ /etc/bashrcã€ /root/.bash_profileã€/root/.bashrc ç­‰æ¶‰åŠç™»é™†ç¯å¢ƒè®¾ç½®çš„æ–‡ä»¶æ˜¯å¦å¼‚å¸¸ã€‚ æ³¨æ„å†…æ ¸ç‰ˆæœ¬ï¼Œæ˜¯å¦å­˜åœ¨æ–°è€å†…æ ¸ï¼Œå¤šæ›´æ¢å‡ ä¸ªå†…æ ¸è¯•ä¸‹ã€‚ ç³»ç»Ÿæ—¥å¿—ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ£€æŸ¥é¡¹ï¼ˆåé¢ä¼šä»‹ç»æ— æ³•ç™»é™†æ€ä¹ˆæ£€æŸ¥ï¼‰ã€‚ Ubuntu 12.04 ç™»é™†å¼‚å¸¸åœ¨ /etc/login.defs é‡Œé¢é…ç½®äº†é”™è¯¯çš„ ERASECHAR å¯¼è‡´ï¼Œæ¢å¤é»˜è®¤ 0177 å³å¯ã€‚ configuration error - cannot parse erasechar value è¾“å…¥ root åç›´æ¥ login å¤±è´¥ä¸‰è¿ï¼Œæ—¥å¿—å¦‚ä¸‹ã€‚ Feb 12 18:18:03 iZbp1cabe6lyx26ikmjie2Z login: FAILED LOGIN 1 FROM tty1 FOR root, Authentication failure Feb 12 18:18:03 iZbp1cabe6lyx26ikmjie2Z login: FAILED LOGIN 2 FROM tty1 FOR (unknown), Authentication failure Feb 12 18:18:03 iZbp1cabe6lyx26ikmjieZZ login: FAILED LOGIN SESSION FROM tty1 FOR (unknown), Authentication failure æ‰¾ä¸ªåŒå†…æ ¸ç‰ˆæœ¬çš„æœºå™¨å¯¹æ¯”å‘ç°æ²¡æœ‰ /etc/pam.d/loginã€‚ rpm åŒ…æ ¡éªŒä¸€ä¸‹ï¼Œç¡®è®¤ login æ–‡ä»¶æ²¡äº†ï¼Œæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªï¼Œå†…å®¹æ‹·è´è¿‡æ¥ï¼Œå¥½äº†ã€‚ [root@iZbp1cabe6lyx26ikmjie2Z pam.d]# rpm -V util-linux missing c /etc/pam.d/login [root@iZbp1cabe6lyx26ikmjie2Z pam.d]# rpm -ql util-linux|egrep -vi \"gz|mo|share\" /etc/mtab /etc/pam.d/chfn /etc/pam.d/chsh /etc/pam.d/login /etc/pam.d/runuser /etc/pam.d/runuser-l /etc/pam.d/su /etc/pam.d/su-l /etc/ssh/sshd_config ç›¸å…³å‚æ•°å¦‚ LoginGraceTime/Allowusers/PermitRootLoginã€‚ é—®é¢˜ä¸å¥½ç¡®è®¤çš„æ—¶å€™ï¼Œ å¯ä»¥å°† shadow å¯†ç å­—æ®µæ¸…ç©ºï¼Œ çœ‹çœ‹ç™»é™†æ˜¯å¦æ­£å¸¸ï¼Œ å¯ä»¥åˆ¤æ–­æ˜¯å¦åˆ°å¯†ç éªŒè¯é˜¶æ®µäº†ã€‚ ä¹‹å‰æœ‰è¿‡ä¸€ç¯‡å…³äº ssh é—®é¢˜æ’æŸ¥çš„æ–‡æ¡£ï¼Œå¯å‚è€ƒï¼šsshé—®é¢˜æ’æŸ¥æŒ‡å— 1.1.3 ç³»ç»Ÿç™»é™†ä¸è¿›å»äº†ï¼Œä¸æŒ‚ç›˜çš„æƒ…å†µä¸‹æ€ä¹ˆæ“ä½œï¼Ÿ ä¸Šé¢çš„æ£€æŸ¥ç‚¹å¾ˆå¤šæ˜¯éœ€è¦åˆ‡æ¢åˆ°å¦å¤–çš„ç³»ç»Ÿç¯å¢ƒä¸‹å»åšæ£€æŸ¥ï¼Œæ¯”å¦‚æŒ‚è½½ LiveCD æˆ–è€… chroot åˆ‡æ¢ï¼›ä½†å¯¹äºä½¿ç”¨ ECS çš„ç”¨æˆ·æ¥è¯´ï¼Œé˜¿é‡Œäº‘æš‚è¿˜æœªæä¾›å®ä¾‹æŒ‚è½½ ISO é•œåƒçš„åŠŸèƒ½ï¼Œé‚£ä¹ˆå¦‚ä½•è¿›è¡Œä¸Šé¢çš„æ“ä½œå‘¢ï¼Ÿå¯ä»¥å€ŸåŠ©é˜¿é‡Œäº‘æ–°æ¨å‡ºçš„å¸è½½ç³»ç»Ÿç›˜åŠŸèƒ½ï¼Œå¯ä»¥æŠŠç³»ç»Ÿç›˜å¸è½½æ‰ï¼Œä½œä¸ºæ•°æ®ç›˜æŒ‚è½½åˆ°ä¸€ä¸ªæ–°çš„æœºå™¨ï¼Œè¿™æ ·å°±å¯ä»¥æ‰§è¡Œä¸Šé¢çš„æ£€æŸ¥äº†ã€‚ å¸®åŠ©æ–‡æ¡£ 1.1.4 åœºæ™¯è¦†ç›– 1.1.4.1 Linux ç³»ç»Ÿå¸¸è§é—®é¢˜è¯Šæ–­è¦†ç›–ä»¥ä¸‹åœºæ™¯ å¸¸ç”¨ç«¯å£æ˜¯å¦æ­£ç¡®ç›‘å¬ï¼ˆåŒ…æ‹¬sshç«¯å£ã€80ã€443) å¸¸ç”¨ç«¯å£å®‰å…¨ç»„æ£€æµ‹ï¼ˆåŒ…æ‹¬sshç«¯å£ã€80ã€443) tcp_timestamps&tcp_tw_recycleå‚æ•°æ£€æµ‹ cpuå ç”¨é«˜åˆ†æ fstabé…ç½®é—®é¢˜ è½¯é“¾æ¥ç¼ºå¤± sshç›¸å…³æ–‡ä»¶æƒé™å¼‚å¸¸ï¼ˆæ¯”å¦‚æ–‡ä»¶æƒé™777) selinuxå¯ç”¨æ£€æµ‹ hugepageå‚æ•°æ£€æµ‹ iptableså¯ç”¨æ£€æµ‹ /etc/security/limits.confé…ç½®æ£€æŸ¥ /etc/passwdç­‰æ–‡ä»¶æ ¼å¼æ ¡éªŒ 1.1.4.2 Linux ç³»ç»Ÿå¸¸è§å¯åŠ¨é—®é¢˜ä¿®å¤è¦†ç›–ä»¥ä¸‹åœºæ™¯ ç³»ç»Ÿå¯åŠ¨-fsckæ£€æµ‹ä¿®å¤ ç³»ç»Ÿå¯åŠ¨-ç£ç›˜/inodeå æ»¡ ç³»ç»Ÿå¯åŠ¨-ç³»ç»Ÿæ–‡ä»¶/è½¯é“¾æ¥æ£€æµ‹ ç³»ç»Ÿå¯åŠ¨-æ ¹ç›®å½•/sshç›®å½•777 ç³»ç»Ÿå¯åŠ¨-fstab/grubæ ¡éªŒ ç³»ç»Ÿå¯åŠ¨-selinuxæ£€æµ‹ ç³»ç»Ÿå¯åŠ¨-sysctlå†…æ ¸å‚æ•°hugepage&minfreeæ£€æµ‹ vncç™»é™†-sshdconfigé…ç½®æ£€æµ‹ vncç™»é™†-passwd/shadowæ–‡ä»¶æ ¼å¼&ç”¨æˆ·æ£€æµ‹ vncç™»é™†-pam.dæ–‡ä»¶&é…ç½®æ£€æµ‹ vncç™»é™†-ç›¸å…³ç›®å½•0sizeæ–‡ä»¶æ£€æµ‹ vncç™»é™†-profile/bashrcæ£€æµ‹ vncç™»é™†-å¤šå†…æ ¸æ£€æµ‹ 1.1.5 å„ç§è„šæœ¬ OSå‚æ•°æ”¶é›†è„šæœ¬ OSä¼˜åŒ–è„šæœ¬ githubé“¾æ¥ OSä¼˜åŒ–è„šæœ¬OSSé“¾æ¥ OSç¦»çº¿ä¿®å¤è„šæœ¬ 1.2 grub.conf æ–‡ä»¶å†…å®¹è¢«æ¸…ç©ºäº†æ€ä¹ˆåŠ ç®€ä»‹ /boot/grub/grub.conf è¢«æ¸…ç©ºï¼Œç³»ç»Ÿå¯åŠ¨å°±è¿›å…¥ grub çŠ¶æ€ï¼ˆCentOS 6.8ï¼‰ã€‚ find /boot/grub/stage1ã€‚ æ˜¾ç¤ºä¸ºï¼ˆhd0,0ï¼‰ã€‚ ç¡®è®¤ä¸€ä¸‹å†…æ ¸çš„å…·ä½“ç‰ˆæœ¬ ls -l /boot æ‰‹åŠ¨è®¾ç½® grub å…·ä½“æ­¥éª¤å¦‚ä¸‹ grub> root (hd0,0) # æ˜¯è¯´è·Ÿåˆ†åŒºåœ¨ç¬¬ä¸€å—ç¡¬ç›˜çš„ç¬¬ 1 ä¸ªåˆ†åŒº å®é™…å¯¹äºå‰é¢çš„ find å‡ºæ¥çš„é‚£ä¸ªæ–‡ä»¶ grub> kernel /boot/vmlinuz-2.6.32-696.3.2.el6.x86_64 ro root=/dev/vda1 # æŒ‡æ˜å†…æ ¸è·¯å¾„å’Œæ ¹åˆ†åŒºï¼Œæ³¨æ„ ro æ˜¯åªè¯» grub> initrd /boot/initramfs-2.6.32-696.3.2.el6.x86_64.img # æŒ‡æ˜ initramfs è·¯å¾„å¯åŠ¨ç³»ç»ŸåŠ è½½é©±åŠ¨ grub> boot # å¯åŠ¨ä¸Šé¢æŒ‡å®šçš„ç³»ç»Ÿï¼Œå¦‚æœæ˜¯ reboot å°±ç­‰äºé‡å¯æ•´ä¸ªç³»ç»Ÿäº†ï¼Œåˆšæ‰çš„è®¾ç½®å°±å¤±æ•ˆäº† å¦‚æœæ²¡æœ‰æŠ¥é”™çš„è¯ï¼Œå³å¯æˆåŠŸå¯åŠ¨ï¼Œè¿›å…¥åˆ°ç³»ç»Ÿå†…éƒ¨åéœ€è¦ç»§ç»­æ”¯æŒã€‚ mount -e remount,rw / é‡æ–°æŒ‚è½½åˆ†åŒºä¸ºè¯»å†™ã€‚ service network restartã€‚ å¦‚æœæç¤º eth0 eth1 å¤±è´¥ï¼Œifconfig çœ‹ä¸åˆ°ç½‘å¡çš„è¯ã€‚ lsmod |grep netã€‚ çœ‹ä¸‹ virtio_net è¿™ä¸ªé©±åŠ¨æœ‰æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼ˆç½‘å¡æŠ¥é”™åŸºæœ¬éƒ½ä¸ä¼šæœ‰ï¼‰ã€‚ insmod /lib/modules/2.6.32-696.3.2.el6.x86_64/kernel/drivers/net/virtio_ net.koã€‚ é‡å¯ç½‘ç»œæœåŠ¡ï¼Œå—¨ ~ ç½‘é€šäº†ã€‚ ç™»é™† sshï¼Œ æ‰¾ä¸ªåŒç‰ˆæœ¬ç³»ç»Ÿçš„ grub.confï¼Œæ‹·è´ä¸€ä»½è¿‡æ¥ï¼Œ ä¸ç„¶é‡å¯ä¹‹ååˆè¿› grub äº†ã€‚å‚è€ƒæ–‡ç«  1.3 å·§å¦™åˆ©ç”¨ strace æŸ¥æ‰¾ä¸¢å¤±çš„æ–‡ä»¶ é—®é¢˜æè¿° å®¢æˆ·åé¦ˆç³»ç»Ÿæ— æ³•è¿œç¨‹ç™»é™†ï¼Œå®é™…ç³»ç»Ÿå¯åŠ¨æœ¬èº«å°±æœ‰é—®é¢˜ã€‚ æ ¹æ®æŠ¥é”™ä¿¡æ¯æ¥çœ‹ï¼Œæ˜¯ç³»ç»Ÿå†…è¯»å– user æœ‰é—®é¢˜ï¼Œéœ€è¦æŒ‚ç›˜æŸ¥çœ‹ã€‚ æŒ‚ç›˜å chroot å¦‚ä¸‹ ihave no nameï¼Œè¿™é‡Œæœ¬èº«å°±æ˜¯æœ‰é—®é¢˜äº†ï¼Œè¯´æ˜ç³»ç»Ÿå†…ç¼ºå°‘äº†ä»€ä¹ˆæ–‡ä»¶å¯¼è‡´å¼‚å¸¸ã€‚ root@debian:~# chroot/mnt [ I have no name !@debian / ] # strace è·Ÿè¸ªä¸€ä¸‹ chroot çš„è¿‡ç¨‹ï¼Œçœ‹ä¸‹ä¸¢å¤±çš„æ–‡ä»¶ã€‚ strace -F -ff -t -tt -s 256 -o ch.out chroot /mnt grep -i \"no such\" ch.out.pid |grep \"so\" æŸ¥çœ‹å¯¹åº”æ–‡ä»¶çš„å…³ç³»ï¼ˆæµ‹è¯•æœºè¡¥å›¾ï¼‰ã€‚ ç¡®è®¤ç³»ç»Ÿä¸Šä¸¢äº†æœ€ç»ˆçš„libnss_files-2.12.soï¼Œå°è¯•æ‹·è´ä¸€ä¸ªã€‚ ifconfig eth1 netmask route add default gw æ­¤æ—¶å·²ç»å¯ä»¥ä¸Šç½‘äº†ï¼Œå»æ‹·è´ä¸€ä¸ªåŒç‰ˆæœ¬çš„æ–‡ä»¶è¯•è¯•å§ã€‚ 1.4 å°å¿ƒ PAM ä¸è®©ä½ ç™»é™† é—®é¢˜æè¿° ssh å¯ä»¥ç™»é™†ï¼Œç®¡ç†ç»ˆç«¯æ— æ³•ç™»é™† rootï¼Œæç¤º login in... å…ˆé€šè¿‡ ssh æ–¹å¼ç™»å½•ç³»ç»Ÿï¼ŒæŸ¥çœ‹ç™»å½•æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸ã€‚ $ cat /var/log/secure Jun 2 09:26:48 iZbp1begsz1x269nxhtip4Z login: FAILED LOGIN 1 FROM tty1 FOR rootï¼ŒAuthentication failure ä¼¼ä¹æ˜¯ login éªŒè¯æ¨¡å—çš„é—®é¢˜è¿›ä¸€æ­¥æŸ¥çœ‹å¯¹åº”çš„é…ç½®æ–‡ä»¶ /etc/pam.d/loginã€‚ $ cat /etc/pam.d/login #%PAM-1.0 auth required pam_succeed_if.so user != root quiet auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_ securetty.so auth substack system-auth auth include postlogin account required pam_nologin.so account include system-auth password include system-auth # pam_selinux.so close should be the first session rule session required pam_selinux.so close session required pam_loginuid.so session optional pam_console.so # pam_selinux.so open should only be followed by sessions to be executed in the user context session required pam_selinux.so open session required pam_namespace.so session optional pam_keyinit.so force revoke session include system-auth session include postlogin -session optional pam_ck_connector.so å…¶ä¸­ä¸€è¡Œçš„ä½œç”¨ä¸ºç¦æ­¢æœ¬åœ°ç™»å½•ï¼Œå¯ä»¥å°†å…¶æ³¨é‡Šæ‰å³å¯ã€‚ auth required pam_succeed_if.so user != root quiet 1.5 CentOS ç™»é™†å¡ä½çš„åŸå› è¢«æˆ‘æ‰¾åˆ°äº† é—®é¢˜æè¿° ç³»ç»Ÿç™»é™†å¡ä½ï¼Œéœ€è¦ ctrl +c æ‰èƒ½è¿›å»ï¼Œå¦‚å›¾ã€‚ å¦‚æœä¸€ç›´ç­‰çš„è¯ï¼Œä¼šæç¤ºå¦‚ä¸‹æˆªå›¾ï¼š åŸå›  /etc/profile é‡Œé¢æœ‰ source /etc/profile å¼•èµ·æ­»å¾ªç¯ï¼Œæ³¨é‡Šå³å¯ã€‚ äºŒã€Linux æ€§èƒ½é—®é¢˜ è¯´æ˜ Linux æ€§èƒ½é—®é¢˜çš„æ’æŸ¥å’Œå¤„ç†ä¸€ç›´æ˜¯ç³»ç»Ÿç®¡ç†å’Œè¿ç»´äººå‘˜çš„\"å¿ƒå¤´ä¹‹æ‚£\"ï¼Œ CPU è´Ÿè½½é«˜ä½†æ‰¾ä¸åˆ°æ¶ˆè€—å¤§çš„è¿›ç¨‹ï¼›ç³»ç»Ÿå‡ºç° OOMï¼ˆOut of Memoryï¼‰åªä¼šä¸€å‘³åœ°å¢å¤§å†…å­˜å®¹é‡ï¼Œè€Œæ²¡æœ‰å¾ˆå¥½åœ°ç†è§£å’Œåˆ†æé—®é¢˜èƒŒåäº§ç”Ÿçš„æ ¹å› ã€‚è€Œè¿™äº›éƒ½å¯¹çº¿ä¸Šä¸šåŠ¡çš„å¯é å’Œç¨³å®šæ€§æå‡ºäº†æŒ‘æˆ˜ã€‚æœ¬æ–‡å°†é˜¿é‡Œäº‘å”®åé‡åˆ°çš„è¾ƒä¸ºå¸¸è§çš„å‡ ä¸ªç³»ç»Ÿæ€§èƒ½é—®é¢˜è¿›è¡Œå±•å¼€åˆ†æï¼Œå¹¶ç»™å‡ºä¸€äº›åˆç†çš„æ”¹è¿›å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚ 2.1 æ‰¾åˆ° Linux è™šæœº Load é«˜çš„\"å…ƒå‡¶\" é—®é¢˜æè¿° æœ‰å®¢æˆ·åé¦ˆä»–ä»¬çš„ä¸€å° ECS å‘¨æœŸæ€§åœ° load å‡é«˜ï¼Œä»–ä»¬çš„ä¸šåŠ¡æµé‡å¹¶æ²¡æœ‰ä¸Šå‡ï¼Œéœ€è¦ æˆ‘ä»¬æ’æŸ¥æ˜¯ä»€ä¹ˆåŸå› é€ æˆçš„ï¼Œæ˜¯å¦å› ä¸ºåº•å±‚å¼‚å¸¸ï¼Ÿ è¦å¼„æ¸… Linux è™šæœº load é«˜ï¼Œæˆ‘ä»¬è¦ææ¸…æ¥š Linux top å‘½ä»¤ä¸­ Load çš„å«ä¹‰ã€‚ 2.1.1 Load average çš„å€¼ä»ä½•è€Œæ¥ åœ¨ä½¿ç”¨ top å‘½ä»¤æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ° Load averages å­—æ®µï¼Œä½†æ˜¯è¿™ä¸ªå­—æ®µå¹¶ä¸æ˜¯è¡¨ç¤º CPU çš„ç¹å¿™ç¨‹åº¦ï¼Œè€Œæ˜¯åº¦é‡ç³»ç»Ÿæ•´ä½“è´Ÿè½½ã€‚ Load averages é‡‡æ ·æ˜¯ä» /proc/loadavg ä¸­è·å–çš„ï¼š 0.00 0.01 0.05 1/161 29703 æ¯ä¸ªå€¼çš„å«ä¹‰ä¾æ¬¡ä¸ºï¼š lavg_1 (0.00) 1- åˆ†é’Ÿå¹³å‡è´Ÿè½½ lavg_5 (0.01) 5- åˆ†é’Ÿå¹³å‡è´Ÿè½½ lavg_15(0.05) 15- åˆ†é’Ÿå¹³å‡è´Ÿè½½ nr_running (1) åœ¨é‡‡æ ·æ—¶åˆ»ï¼Œè¿è¡Œé˜Ÿåˆ—çš„ä»»åŠ¡çš„æ•°ç›®ï¼Œä¸ /proc/stat çš„ procs_running è¡¨ç¤ºç›¸åŒæ„æ€ï¼Œ è¿™ä¸ªæ•°å€¼æ˜¯å½“å‰å¯è¿è¡Œçš„å†…æ ¸è°ƒåº¦å¯¹è±¡ï¼ˆè¿›ç¨‹ï¼Œçº¿ç¨‹ï¼‰ã€‚ nr_threads (161) åœ¨é‡‡æ ·æ—¶åˆ»ï¼Œç³»ç»Ÿä¸­æ´»è·ƒçš„ä»»åŠ¡çš„ä¸ªæ•°ï¼ˆä¸åŒ…æ‹¬è¿è¡Œå·²ç»ç»“æŸçš„ä»»åŠ¡ï¼‰ï¼Œå³è¿™ä¸ªæ•°å€¼è¡¨ç¤ºå½“å‰å­˜ åœ¨ç³»ç»Ÿä¸­çš„å†…æ ¸å¯è°ƒåº¦å¯¹è±¡çš„æ•°é‡ã€‚ last_pid(29703) ç³»ç»Ÿæœ€è¿‘åˆ›å»ºçš„è¿›ç¨‹çš„ PIDï¼ŒåŒ…æ‹¬è½»é‡çº§è¿›ç¨‹ï¼Œå³çº¿ç¨‹ã€‚ å‡è®¾å½“å‰æœ‰ä¸¤ä¸ª CPUï¼Œåˆ™æ¯ä¸ª CPU çš„å½“å‰ä»»åŠ¡æ•°ä¸º 0.00/2=0.00 å¦‚æœä½ çœ‹åˆ° load average æ•°å€¼æ˜¯ 10ï¼Œ åˆ™è¡¨æ˜å¹³å‡æœ‰ 10 ä¸ªè¿›ç¨‹åœ¨è¿è¡Œæˆ–ç­‰å¾…çŠ¶æ€ã€‚ æœ‰å¯èƒ½ç³»ç»Ÿæœ‰å¾ˆé«˜çš„è´Ÿè½½ä½†æ˜¯ CPU ä½¿ç”¨ç‡å´å¾ˆä½ï¼Œæˆ–è€…è´Ÿè½½å¾ˆä½è€Œ CPU åˆ©ç”¨ç‡å¾ˆé«˜ï¼Œå› ä¸ºè¿™ä¸¤è€…æ²¡æœ‰ç›´æ¥å…³ç³»ã€‚æºç ä¸­å¯¹äºè¿™ä¸€å—çš„è¯´æ˜ static int loadavg_proc_show(struct seq_file *mï¼Œvoid *v) { unsigned long avnrun[3]; get_avenrun(avnrunï¼ŒFIXED_1/200ï¼Œ0); seq_printf(mï¼Œ\"%lu.%02lu %lu.%02lu %lu.%02lu %ld/%d %d\\n\", LOAD_INT(avnrun[0])ï¼ŒLOAD_FRAC(avnrun[0]), LOAD_INT(avnrun[1])ï¼ŒLOAD_FRAC(avnrun[1]), LOAD_INT(avnrun[2])ï¼ŒLOAD_FRAC(avnrun[2]), nr_running()ï¼Œnr_threads, task_active_pid_ns(current)->last_pid); return 0; } Load çš„è®¡ç®—å‡½æ•°ï¼š static unsigned long calc_load(unsigned long loadï¼Œunsigned long expï¼Œunsigned long active) { load *= exp; load += active * (FIXED_1 - exp); return load >> FSHIFT; } /* * calc_load - update the avenrun load estimates 10 ticks after the * CPUs have updated calc_load_tasks. */ void calc_global_load(void) { unsigned long upd = calc_load_update + 10; long active; if (time_before(jiffiesï¼Œupd)) return; active = atomic_long_read(&calc_load_tasks); active = active > 0 ? active * FIXED_1 : 0; avenrun[0] = calc_load(avenrun[0]ï¼ŒEXP_1ï¼Œactive); avenrun[1] = calc_load(avenrun[1]ï¼ŒEXP_5ï¼Œactive); avenrun[2] = calc_load(avenrun[2]ï¼ŒEXP_15ï¼Œactive); calc_load_update += LOAD_FREQ; } /* * These are the constant used to fake the fixed-point load-average * counting. Some notes: * - 11 bit fractions expand to 22 bits by the multiplies: this gives * a load-average precision of 10 bits integer + 11 bits fractional * - if you want to count load-averages more oftenï¼Œyou need more * precisionï¼Œor rounding will get you. With 2-second counting freq, * the EXP_n values would be 1981ï¼Œ2034 and 2043 if still using only * 11 bit fractions. */ extern unsigned long avenrun[]; /* Load averages */ extern void get_avenrun(unsigned long *loadsï¼Œunsigned long offsetï¼Œint shift); #define FSHIFT 11 /* nr of bits of precision */ #define FIXED_1 (1>= FSHIFT; ä»è¿™ä¸ªå‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ å†…æ ¸è®¡ç®— load é‡‡ç”¨çš„æ˜¯ä¸€ç§å¹³æ»‘ç§»åŠ¨çš„ç®—æ³•ï¼ŒLinux çš„ç³»ç»Ÿè´Ÿè½½æŒ‡è¿è¡Œé˜Ÿåˆ—çš„å¹³å‡é•¿åº¦ï¼Œ éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¯è¿è¡Œçš„è¿›ç¨‹æ˜¯æŒ‡å¤„äºè¿è¡Œé˜Ÿåˆ—çš„è¿›ç¨‹ï¼Œ ä¸æ˜¯æŒ‡æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚ å³è¿›ç¨‹çš„çŠ¶æ€æ˜¯ TASK_RUNNING æˆ–è€… TASK_ UNINTERRUPTIBLEã€‚ Linux å†…æ ¸å®šä¹‰ä¸€ä¸ªé•¿åº¦ä¸º3çš„åŒå­—æ•°ç»„ avenrunï¼ŒåŒå­—çš„ä½ 11 ä½ç”¨äºå­˜æ”¾è´Ÿè½½çš„å°æ•°éƒ¨åˆ†ï¼Œé«˜ 21 ä½ç”¨äºå­˜æ”¾æ•´æ•°éƒ¨åˆ†ã€‚å½“è¿›ç¨‹æ‰€è€—çš„ CPU æ—¶é—´ç‰‡æ•°è¶…è¿‡ CPU åœ¨5ç§’å†…èƒ½å¤Ÿæä¾›çš„æ—¶é—´ç‰‡æ•°æ—¶ï¼Œå†…æ ¸è®¡ç®—ä¸Šè¿°çš„ä¸‰ä¸ªè´Ÿè½½ï¼Œè´Ÿè½½åˆå§‹åŒ–ä¸º 0ã€‚ å‡è®¾æœ€è¿‘ 1ã€5ã€15 åˆ†é’Ÿå†…çš„å¹³å‡è´Ÿè½½åˆ†åˆ«ä¸º load1ã€load5 å’Œ load15ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªè®¡ç®—æ—¶åˆ»åˆ°æ¥æ—¶ï¼Œå†…æ ¸é€šè¿‡ä¸‹é¢çš„ç®—å¼è®¡ç®—è´Ÿè½½ï¼š load1 -= load1 - exp(-5 / 60) -+ n (1 - exp(-5 / 60 )) load5 -= load5 - exp(-5 / 300) + n (1 - exp(-5 / 300)) load15 = load15 exp(-5 / 900) + n (1 - exp(-5 / 900)) å…¶ä¸­ï¼Œexp(x) ä¸º e çš„ x æ¬¡å¹‚ï¼Œn ä¸ºå½“å‰è¿è¡Œé˜Ÿåˆ—çš„é•¿åº¦ã€‚ 2.1.2 å¦‚ä½•æ‰¾å‡ºç³»ç»Ÿä¸­ load é«˜æ—¶å¤„äºè¿è¡Œé˜Ÿåˆ—çš„è¿›ç¨‹ é€šè¿‡å‰é¢çš„è®²è§£ï¼Œ æˆ‘ä»¬å·²ç»æ˜ç™½æœ‰å¯èƒ½ç³»ç»Ÿæœ‰å¾ˆé«˜çš„è´Ÿè½½ä½†æ˜¯ CPU ä½¿ç”¨ç‡å´å¾ˆä½ï¼Œ æˆ–è€…è´Ÿè½½å¾ˆä½è€Œ CPU åˆ©ç”¨ç‡å¾ˆé«˜ï¼Œè¿™ä¸¤è€…æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œå¦‚ä½•ç”¨è„šæœ¬ç»Ÿè®¡å‡ºæ¥å¤„äºè¿è¡Œé˜Ÿåˆ—çš„è¿›ç¨‹å‘¢ï¼Ÿ æ¯éš” 1s ç»Ÿè®¡ä¸€æ¬¡ï¼š #!/bin/bash LANG=C PATH=/sbin:/usr/sbin:/bin:/usr/bin interval=1 length=86400 for i in $(seq 1 $(expr ${length} / ${interval}));do date LANG=C ps -eTo stat,pid,tid,ppid,comm --no-header | sed -e 's/^ \\*//' | perl -nE 'chomp;say if (m!^\\S*[RD]+\\S*!)' date cat /proc/loadavg echo -e \"\\n\" sleep ${interval} done ä»ç»Ÿè®¡å‡ºæ¥çš„ç»“æœå¯ä»¥çœ‹åˆ°ï¼š at Jan 20 15:54:12 CST 2018 D 958 958 957 nginx D 959 959 957 nginx D 960 960 957 nginx D 961 961 957 nginx R 962 962 957 nginx D 963 963 957 nginx D 964 964 957 nginx D 965 965 957 nginx D 966 966 957 nginx D 967 967 957 nginx D 968 968 957 nginx D 969 969 957 nginx D 970 970 957 nginx D 971 971 957 nginx D 972 972 957 nginx D 973 973 957 nginx D 974 974 957 nginx R 975 975 957 nginx D 976 976 957 nginx D 977 977 957 nginx D 978 978 957 nginx D 979 979 957 nginx R 980 980 957 nginx D 983 983 957 nginx D 984 984 957 nginx D 985 985 957 nginx D 986 986 957 nginx D 987 987 957 nginx D 988 988 957 nginx D 989 989 957 nginx R 11908 11908 18870 ps Sat Jan 20 15:54:12 CST 2018 25.76 20.60 19.00 12/404 11912 æ³¨ï¼šR ä»£è¡¨è¿è¡Œä¸­çš„é˜Ÿåˆ—ï¼ŒD æ˜¯ä¸å¯ä¸­æ–­çš„ç¡çœ è¿›ç¨‹ åœ¨ load æ¯”è¾ƒé«˜çš„æ—¶å€™ï¼Œæœ‰å¤§é‡çš„ nginx å¤„äº R æˆ–è€… D çŠ¶æ€ï¼Œä»–ä»¬æ‰æ˜¯é€ æˆ load ä¸Šå‡çš„å…ƒå‡¶ï¼Œå’Œæˆ‘ä»¬åº•å±‚çš„è´Ÿè½½ç¡®å®æ˜¯æ²¡æœ‰å…³ç³»çš„ã€‚ æœ€åä¹Ÿç»™å¤§å®¶ share ä¸€ä¸‹æŸ¥ CPU ä½¿ç”¨ç‡æ¯”è¾ƒé«˜çš„çº¿ç¨‹å°è„šæœ¬ï¼š #!/bin/bash LANG=C PATH=/sbin:/usr/sbin:/bin:/usr/bin interval=1 length=86400 for i in $(seq 1 $(expr ${length} / ${interval}));do date LANG=C ps -eT -o%cpu,pid,tid,ppid,comm | grep -v CPU | sort -n -r | head -20 date LANG=C cat /proc/loadavg { LANG=C ps -eT -o%cpu,pid,tid,ppid,comm | sed -e 's/^ *//' | tr -s ' ' | grep -v CPU | sort -n -r | cut -d ' ' -f 1 | xargs -I{} echo -n \"{} + \" && echo '0'; } | bc -l sleep ${interval} done fuser -k $0 2.2 OOM killer æ˜¯è¢«è°è§¦å‘çš„ 2.2.1 é—®é¢˜æè¿° ç”¨æˆ·å‘ç°è‡ªå·±çš„æœåŠ¡å™¨ CPU åœ¨æŸä¸€æ—¶åˆ»é™¡ç„¶å‡é«˜ï¼Œä½†ä»ç›‘æ§ä¸Šçœ‹ï¼ŒåŒä¸€æ—¶åˆ»çš„ä¸šåŠ¡é‡å´å¹¶ä¸é«˜ï¼Œå®¢æˆ·æ€€ç–‘æ˜¯äº‘æœåŠ¡å™¨æœ‰é—®é¢˜ï¼Œå¸Œæœ›æŠ€æœ¯æ”¯æŒå›¢é˜Ÿäºˆä»¥è§£å†³ã€‚ ç»è¿‡æˆ‘ä»¬çš„æ’æŸ¥ï¼Œ å‘ç° cpu çš„ä¸¤æ¬¡é—´æ­‡é£™é«˜æ˜¯ç”±äºå®¢æˆ·ç³»ç»Ÿå½“æ—¶å‘ç”Ÿäº† OOMï¼ˆout of memoryï¼‰çš„æƒ…å†µï¼Œ å¹¶è§¦å‘äº† oom-killer é€ æˆçš„ã€‚ ä½†å®¢æˆ·å¹¶ä¸æ¥å—è¿™ä¸ªç»“è®ºï¼Œ è®¤ä¸ºæ˜¯äº‘æœåŠ¡å™¨çš„å¼‚å¸¸å¯¼è‡´äº† cpu é£™é«˜ï¼Œè€Œ cpu çš„å‡é«˜åˆå¯¼è‡´äº† oom æƒ…å†µçš„å‘ç”Ÿã€‚ä¹Ÿå°±æ˜¯å¯¹äº cpu å‡é«˜å’Œ oom è°ä¸ºå› æœè¿™ä»¶äº‹ä¸Šï¼Œå®¢æˆ·å’Œæˆ‘ä»¬æŒå®Œå…¨ç›¸åçš„æ€åº¦ã€‚ ä¸‹é¢æˆ‘ä»¬å°†é€šè¿‡å¯¹ oom æ—¶ç³»ç»Ÿæ—¥å¿—çš„è§£è¯»æ¥è¯´æ˜ cpu å‡é«˜å’Œ oom ä¹‹é—´çš„å› æœå…³ç³»ã€‚ 2.2.2 çŸ¥è¯†ç‚¹æ¢³ç† 2.2.2.1 é¢„å¤‡çŸ¥è¯† åœ¨è§£è¯»æ—¥å¿—ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ linux å†…æ ¸çš„å†…å­˜ç®¡ç†ã€‚ 2.2.2.1.1 å‡ ä¸ªåŸºæœ¬çš„æ¦‚å¿µ (1) Page é¡µ å¤„ç†å™¨çš„æœ€å° 'å¯»å€å•å…ƒ' æ˜¯å­—èŠ‚æˆ–è€…å­—ï¼Œè€Œé¡µæ˜¯å†…å­˜çš„ 'ç®¡ç†å•å…ƒ'ã€‚ (2) Zone åŒº (a) åŒºå­˜åœ¨çš„åŸå› ï¼š æœ‰äº›ç¡¬ä»¶è®¾å¤‡åªèƒ½å¯¹ç‰¹å®šçš„å†…å­˜åœ°å€æ‰§è¡Œ DMAï¼ˆdirect memory accessï¼‰ æ“ä½œã€‚ åœ¨ä¸€äº›æ¶æ„ä¸­ï¼Œå®é™…ç‰©ç†å†…å­˜æ˜¯æ¯”ç³»ç»Ÿå¯å¯»å€çš„è™šæ‹Ÿå†…å­˜è¦å¤§çš„ï¼Œè¿™å°±å¯¼è‡´æœ‰äº›ç‰©ç†å†…å­˜æ²¡æœ‰åŠæ³•è¢«æ°¸ä¹…çš„æ˜ å°„åœ¨å†…æ ¸çš„åœ°å€ç©ºé—´ä¸­ã€‚ åŒºçš„åˆ’åˆ†ä¹Ÿæ˜¯ç›´æ¥ä»¥ä¸Šé¢ä¸¤ä¸ªåŸå› ä¸ºä¾æ®çš„ã€‚ (b) åŒºçš„ç§ç±» ZONE_DMA è¿™ä¸ªåŒºåŒ…å«çš„ page å¯ä»¥æ‰§è¡Œ DMA æ“ä½œã€‚è¿™éƒ¨åˆ†åŒºåŸŸçš„å¤§å°å’Œ CPU æ¶æ„æœ‰å…³ï¼Œåœ¨ x86 æ¶æ„ä¸­ï¼Œè¯¥éƒ¨åˆ†åŒºåŸŸå¤§å°é™åˆ¶ä¸º 16MBã€‚ ZONE_DMA32 ç±»ä¼¼äº ZOME_DMAï¼Œ è¿™ä¸ªåŒºä¹ŸåŒ…å«å¯ä»¥æ‰§è¡Œ DMA æ“ä½œçš„pageã€‚è¯¥åŒºåŸŸåªå­˜åœ¨äº64ä½ç³»ç»Ÿä¸­ï¼Œé€‚åˆ32ä½çš„è®¾å¤‡è®¿é—®ã€‚ ZONE_NORMAL è¿™ä¸ªåŒºåŒ…å«å¯ä»¥æ­£å¸¸æ˜ å°„åˆ°åœ°å€ç©ºé—´ä¸­çš„ pageï¼Œæˆ–è€…è¯´è¿™ä¸ªåŒºåŒ…å«äº†é™¤äº† DMA å’Œ HIGHMEM ä»¥å¤–çš„å†…å­˜ã€‚ è®¸å¤šå†…æ ¸æ“ä½œéƒ½ä»…åœ¨è¿™ä¸ªåŒºåŸŸè¿›è¡Œã€‚ ZONE_HIGHMEM è¿™ä¸ªåŒºåŒ…å«çš„æ˜¯ high memoryï¼Œä¹Ÿå°±æ˜¯é‚£äº›ä¸èƒ½è¢«æ°¸ä¹…æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´çš„é¡µã€‚ 32ä½çš„ x86 æ¶æ„ä¸­å­˜åœ¨ä¸‰ç§å†…å­˜åŒºåŸŸï¼ŒZONE_DMAï¼ŒZONE_NORMALï¼Œ ZONE_HIGHMEMã€‚æ ¹æ®åœ°å€ç©ºé—´åˆ’åˆ†çš„ä¸åŒï¼Œä¸‰ä¸ªåŒºåŸŸçš„å¤§å°ä¸ä¸€æ ·ï¼š 1G å†…æ ¸ç©ºé—´ /3G ç”¨æˆ·ç©ºé—´ | åŒºåŸŸ | å†…å­˜èŒƒå›´ | | ---------------- | -------------- | | ZONE_DMA | | | ZONE_NORMAL | 16M ~ 896M | | ZONE_HIGHMEM | > 896M | 4G å†…æ ¸ç©ºé—´ /4G ç”¨æˆ·ç©ºé—´ | åŒºåŸŸ | å†…å­˜èŒƒå›´ | | ---------------- | --------------- | | ZONE_DMA | | | ZONE_NORMAL | 16M ~ 3968M | | ZONE_HIGHMEM | > 3968M | 64ä½çš„ç³»ç»Ÿç”±äºå¯»å€èƒ½åŠ›çš„æé«˜ï¼Œ ä¸å­˜åœ¨ highmem åŒºï¼Œ æ‰€ä»¥64ä½ç³»ç»Ÿä¸­å­˜åœ¨çš„åŒºæœ‰ DMAï¼ŒDMA32 å’Œ NORMAL ä¸‰ä¸ªåŒºã€‚ | åŒºåŸŸ | å†…å­˜èŒƒå›´ | | --------------- | ------------ | | ZONE_DMA | | | ZONE_DMA32 | 16M ~ 4G | | ZONE_NORMAL | > 4G | 2.2.2.1.2 å†…æ ¸åˆ†é…å†…å­˜çš„å‡½æ•° ä¸‹é¢æ˜¯å†…æ ¸åˆ†é…å†…å­˜çš„æ ¸å¿ƒå‡½æ•°ä¹‹ä¸€ï¼Œå®ƒä¼šåˆ†é…2çš„ order æ¬¡æ–¹ä¸ªè¿ç»­çš„ç‰©ç†é¡µå†…å­˜ï¼Œå¹¶å°†ç¬¬ä¸€é¡µçš„é€»è¾‘åœ°å€è¿”å›ã€‚ unsigned long __get_free_pages(gfp_t gfp_maskï¼Œunsigned int order) å†…æ ¸ç©ºé—´çš„å†…å­˜åˆ†é…å‡½æ•°å’Œç”¨æˆ·ç©ºé—´æœ€å¤§çš„ä¸åŒå°±æ˜¯æ¯ä¸ªå‡½æ•°ä¼šæœ‰ä¸€ä¸ª gfp_ mask å‚æ•°ã€‚ å…¶ä¸­ gfp ä»£è¡¨çš„å°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„å†…å­˜åˆ†é…å‡½æ•°__get_free_pages()ã€‚ gfp_mask å¯ä»¥åˆ†æˆä¸‰ç§ï¼šè¡Œä¸ºä¿®é¥°ç¬¦ï¼ˆaction modifierï¼‰, åŒºä¿®é¥°ç¬¦ï¼ˆzone modifierï¼‰å’Œç±»å‹ï¼ˆtypeï¼‰ã€‚ è¡Œä¸ºä¿®é¥°ç¬¦æ˜¯ç”¨æ¥æŒ‡å®šå†…æ ¸è¯¥å¦‚ä½•åˆ†é…å†…å­˜çš„ã€‚ æ¯”å¦‚åˆ†é…å†…å­˜æ—¶æ˜¯å¦å¯ ä»¥è¿›è¡Œç£ç›˜ ioï¼Œæ˜¯å¦å¯ä»¥è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œå†…æ ¸æ˜¯å¦å¯ä»¥ç¡çœ ï¼ˆsleepï¼‰ ç­‰ç­‰ã€‚ åŒºä¿®é¥°ç¬¦æŒ‡å®šå†…å­˜éœ€è¦ä»å“ªä¸ªåŒºæ¥åˆ†é…ã€‚ ç±»å‹æ˜¯è¡Œä¸ºä¿®é¥°ç¬¦å’ŒåŒºä¿®é¥°ç¬¦ç»“åˆä¹‹åçš„äº§ç‰©ã€‚åœ¨ä¸€äº›ç‰¹å®šçš„å†…å­˜åˆ†é…åœº åˆä¸‹ï¼Œ æˆ‘ä»¬å¯èƒ½éœ€è¦åŒæ—¶æŒ‡å®šå¤šä¸ªè¡Œä¸ºä¿®é¥°ç¬¦å’ŒåŒºä¿®é¥°ç¬¦ï¼Œ è€Œ type å°±æ˜¯ é’ˆå¯¹è¿™äº›å›ºå®šçš„åœºåˆï¼Œå°†æ‰€éœ€è¦çš„è¡Œä¸ºä¿®é¥°ç¬¦å’ŒåŒºä¿®é¥°ç¬¦éƒ½æ•´åˆåˆ°äº†ä¸€èµ·ï¼Œ è¿™æ ·ä½¿ç”¨è€…åªè¦æŒ‡å®šä¸€ä¸ª type å°±å¯ä»¥äº†ã€‚ ä¸åŒ type æ‰€ä»£è¡¨çš„å«ä¹‰å¯ä»¥å‚çœ‹ä¸‹é¢çš„è¡¨æ ¼ï¼š 2.2.2.2 æ—¥å¿—è§£è¯» ä¸‹é¢æ˜¯ä» oom killer è¢«è§¦å‘åˆ°è¿›ç¨‹åˆ°è¢«æ€æ‰çš„ä¸€ä¸ªå¤§æ¦‚è¿‡ç¨‹ï¼Œ æˆ‘ä»¬æ¥å…·ä½“çœ‹ ä¸€ä¸‹ã€‚ nginx invoked oom-killer: gfp_mask=0x200daï¼Œorder=0ï¼Œoom_score_adj=0 nginx cpuset=6011a7f12bac1c4592ce41407bb41d49836197001a0e355f5a1d9589e4001e42 mems_allowed=0 CPU: 1 PID: 10242 Comm: nginx Not tainted 3.13.0-86-generic #130-Ubuntu Hardware name: Xen HVM domUï¼ŒBIOS 4.0.1 12/16/2014 0000000000000000 ffff880070611a00 ffffffff8172a3b4 ffff88012af6c800 0000000000000000 ffff880070611a88 ffffffff8172495d ffffffff81069b76 ffff880070611a60 ffffffff810ca5ac ffff88020fff7e38 0000000000000000 Node 0 DMA free:15908kB min:128kB low:160kB high:192kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:15992kB managed:15908kB mlocked:0kB dirty:0kB writeback:0kB mapped:0kB shmem:0kB slab_ reclaimable:0kB slab_unreclaimable:0kB kernel_stack:0kB pagetables:0kB unstable:0kB bounce:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:0 all_ unreclaimable? yes lowmem_reserve[]: 0 3746 7968 7968 Node 0 DMA32 free:48516kB min:31704kB low:39628kB high:47556kB active_ anon:3619272kB inactive_anon:216kB active_file:556kB inactive_file:1516kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:3915776kB managed:3836724kB mlocked:0kB dirty:4kB writeback:0kB mapped:324kB shmem:1008kB slab_reclaimable:67136kB slab_unreclaimable:67488kB kernel_ stack:1792kB pagetables:14540kB unstable:0kB bounce:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:7365 all_unreclaimable? yes lowmem_reserve[]: 0 0 4221 4221 Node 0 Normal free:35640kB min:35748kB low:44684kB high:53620kB active_ anon:4019124kB inactive_anon:292kB active_file:1292kB inactive_file:2972kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:4456448kB managed:4322984kB mlocked:0kB dirty:24kB writeback:4kB mapped:1296kB shmem:1324kB slab_reclaimable:81196kB slab_unreclaimable:83432kB kernel_ stack:3392kB pagetables:20252kB unstable:0kB bounce:0kB free_cma:0kB writeback_tmp:0kB pages_scanned: 7874 all_unreclaimable? yes lowmem_reserve[]: 0 0 0 0 Node 0 DMA: 1*4kB (U) 0*8kB 0*16kB 1*32kB (U) 2*64kB (U) 1*128kB (U) 1*256kB (U) 0*512kB 1*1024kB (U) 1*2048kB (R) 3*4096kB (M) = 15908kB Node 0 DMA32: 1101*4kB (UE) 745*8kB (UEM) 475*16kB (UEM) 263*32kB (EM) 88*64kB (UEM) 25*128kB (E)12*256kB (EM) 6*512kB (E) 7*1024kB (EM) 0*2048kB 0*4096kB = 48524kB Node 0 Normal: 5769*4kB (EM) 1495*8kB (EM) 24*16kB (UE) 0*32kB 0*64kB 0*128kB 0*256kB 0*512kB 0*1024kB 0*2048kB 0*4096kB = 35420kB Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_ size=2048kB 2273 total pagecache pages 0 pages in swap cache Swap cache stats: add 0ï¼Œdelete 0ï¼Œfind 0/0 Free swap = 0kB Total swap = 0kB 2097054 pages RAM 0 pages HighMem/MovableOnly 33366 pages reserved [ pid ] uid tgid total_vm rss nr_ptes swapents oom_score_adj name [ 355] 0 355 4868 66 13 0 0 upstart-udev-br [ 361] 0 361 12881 145 28 0 -1000 systemd-udevd [ 499] 0 499 3814 60 13 0 0 upstart-socket- [ 562] 0 562 5855 79 15 0 0 rpcbind [ 644] 106 644 5398 142 16 0 0 rpc. statd [ 775] 0 775 3818 58 12 0 0 upstart-file-br ...ï¼ˆæ­¤å¤„æœ‰çœç•¥ï¼‰ [10396] 104 10396 21140 12367 44 0 0 nginx [10397] 104 10397 21140 12324 44 0 0 nginx [10398] 104 10398 21140 12324 44 0 0 nginx [10399] 104 10399 21140 12367 44 0 0 nginx Out of memory: Kill process 10366 (nginx) score 6 or sacrifice child Killed process 10366 (nginx) total-vm:84784kBï¼Œanon-rss:49156kBï¼Œfilerss:520kB å…ˆæ¥çœ‹ä¸€ä¸‹ç¬¬ä¸€è¡Œï¼Œå®ƒç»™å‡ºäº† oom killer æ˜¯ç”±è°è§¦å‘çš„ä¿¡æ¯ã€‚ nginx invoked oom-killer: gfp_mask=0x200daï¼Œorder=0ï¼Œoom_score_adj=0 order=0 å‘Šè¯‰æˆ‘ä»¬æ‰€è¯·æ±‚çš„å†…å­˜çš„å¤§å°æ˜¯å¤šå°‘ï¼Œ å³ nginx è¯·æ±‚äº†2çš„0æ¬¡æ–¹è¿™ä¹ˆå¤šä¸ª page çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª pageï¼Œæˆ–è€…è¯´æ˜¯ 4KBã€‚ gfp_mask çš„æœ€åä¸¤ä¸ª bit ä»£è¡¨çš„æ˜¯ zone maskï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæŒ‡æ˜å†…å­˜åº”è¯¥ä»å“ªä¸ªåŒºæ¥åˆ†é…ã€‚ Flag value Description 0x00u 0 implicitly means allocate from ZONE_NORMAL __GFP_DMA 0x01u Allocate from ZONE_DMA if possible __GFP_HIGHMEM 0x02u Allocate from ZONE_HIGHMEM if possible (è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œåœ¨ 64 ä½çš„ x86 ç³»ç»Ÿä¸­ï¼Œæ˜¯æ²¡æœ‰ highmem åŒºçš„ï¼Œ64 ä½ç³»ç»Ÿä¸­çš„ normal åŒºå°±å¯¹åº”ä¸Šè¡¨ä¸­çš„ highmem åŒºã€‚ï¼‰ åœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œzonemaskæ˜¯2ï¼Œä¹Ÿå°±æ˜¯è¯´ nginx æ­£åœ¨ä» zone ï¼ normalï¼ˆ64 ä½ ç³»ç»Ÿï¼‰ä¸­è¯·æ±‚å†…å­˜ã€‚ å…¶ä»–æ ‡å¿—ä½çš„å«ä¹‰å¦‚ä¸‹ï¼š #define __GFP_WAIT 0x10u /* Can wait and reschedule? */ #define __GFP_HIGH 0x20u /* Should access emergency pools? */ #define __GFP_IO 0x40u /* Can start physical IO? */ #define __GFP_FS 0x80u /* Can call down to low-level FS? */ #define __GFP_COLD 0x100u /* Cache-cold page required */ #define __GFP_NOWARN */ 0x200u /* Suppress page allocation failure warning */ #define __GFP_REPEAT 0x400u /* Retry the allocation. Might fail */ #define __GFP_NOFAIL 0x800u /* Retry for ever. Cannot fail */ #define __GFP_NORETRY 0x1000u /* Do not retry. Might fail */ #define __GFP_NO_GROW 0x2000u /* Slab internal usage */ #define __GFP_COMP 0x4000u /* Add compound page metadata */ #define __GFP_ZERO 0x8000u /* Return zeroed page on success */ #define __GFP_NOMEMALLOC 0x10000u /* Donâ€™t use emergency reserves */ #define __GFP_NORECLAIM allocation 0x20000u /* No realy zone reclaim during */ æ‰€ä»¥æˆ‘ä»¬å½“å‰è¿™ä¸ªå†…å­˜è¯·æ±‚å¸¦æœ‰è¿™å‡ ä¸ªæ ‡å¿—ï¼šGFP_NORECLAIMï¼ŒGFP_FSï¼Œ GFP_IOï¼ŒGFP_WAITï¼Œéƒ½æ˜¯æ¯”è¾ƒæ­£å¸¸çš„å‡ ä¸ªæ ‡å¿—ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªè¯·æ±‚ä¸ºä»€ä¹ˆ ä¼šæœ‰é—®é¢˜å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„ä¿¡æ¯ï¼š Node 0 Normal free:35640kB min:35748kB low:44684kB high:53620kB active_ anon:4019124kB inactive_anon:292kB active_file:1292kB inactive_file:2972kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:4456448kB managed:4322984kB mlocked:0kB dirty:24kB writeback:4kB mapped:1296kB shmem:1324kB slab_reclaimable:81196kB slab_unreclaimable:83432kB kernel_ stack:3392kB pagetables:20252kB unstable:0kB bounce:0kB free_cma:0kB writeback_tmp:0kB pages_scanned: 7874 all_unreclaimable? yes å¯ä»¥çœ‹åˆ° normal åŒº free çš„å†…å­˜åªæœ‰ 35640KBï¼Œæ¯”ç³»ç»Ÿå…è®¸çš„æœ€å°å€¼ï¼ˆminï¼‰è¿˜è¦ä½ï¼Œè¿™æ„å‘³ç€ application å·²ç»æ— æ³•å†ä»ç³»ç»Ÿä¸­ç”³è¯·åˆ°å†…å­˜äº†ï¼Œå¹¶ä¸”ç³»ç»Ÿä¼šå¼€å§‹å¯åŠ¨ oom killer æ¥ç¼“è§£ç³»ç»Ÿå†…å­˜å‹åŠ›ã€‚ è¿™é‡Œæˆ‘ä»¬è¯´ä¸€ä¸‹ä¸€ä¸ªå¸¸è§çš„è¯¯åŒºï¼Œå°±æ˜¯æœ‰äººä¼šè®¤ä¸ºè§¦å‘äº† oom killer çš„è¿›ç¨‹å°±æ˜¯é—®é¢˜çš„ç½ªé­ç¥¸é¦–ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­çš„è¿™ä¸ª nginx è¿›ç¨‹ã€‚å…¶å®æ—¥å¿—ä¸­ invoke oom killer çš„è¿™ä¸ªè¿›ç¨‹æœ‰æ—¶å€™å¯èƒ½åªæ˜¯ä¸€ä¸ªå—å®³è€…ï¼Œ å› ä¸ºå…¶ä»–åº”ç”¨ï¼è¿›ç¨‹å·²å°†ç³»ç»Ÿå†…å­˜ç”¨å°½ï¼Œ è€Œè¿™ä¸ª invoke oomkiller çš„è¿›ç¨‹æ°å¥½åœ¨æ­¤æ—¶å‘èµ·äº†ä¸€ä¸ªåˆ†é…å†…å­˜çš„è¯·æ±‚è€Œå·²ã€‚ åœ¨ç³»ç»Ÿå†…å­˜å·²ç»ä¸è¶³çš„æƒ…å†µä¸‹ï¼Œ ä»»ä½•ä¸€ä¸ªå†…å­˜è¯·æ±‚éƒ½å¯èƒ½è§¦å‘ oom killer çš„å¯åŠ¨ã€‚ oom killer çš„å¯åŠ¨ä¼šä½¿ç³»ç»Ÿä»ç”¨æˆ·ç©ºé—´è½¬æ¢åˆ°å†…æ ¸ç©ºé—´ã€‚å†…æ ¸ä¼šåœ¨çŸ­æ—¶é—´å†…è¿›è¡Œå¤§é‡çš„å·¥ä½œï¼Œ æ¯”å¦‚è®¡ç®—æ¯ä¸ªè¿›ç¨‹çš„ oom åˆ†å€¼ï¼Œ ä»è€Œç­›é€‰å‡ºæœ€é€‚åˆæ€æ‰çš„è¿›ç¨‹ã€‚ æˆ‘ä»¬ä»æ—¥å¿—ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™ä¸€ç­›é€‰è¿‡ç¨‹ï¼š [ pid ] uid tgid total_vm rss nr_ptes swapents oom_score_adj name [ 355] 0 355 4868 66 13 0 0 upstart-udev-br [ 361] 0 361 12881 145 28 0 -1000 systemd-udevd [ 499] 0 499 3814 60 13 0 0 upstart-socket- [ 562] 0 562 5855 79 15 0 0 rpcbind [ 644] 106 644 5398 142 16 0 0 rpc. statd [ 775] 0 775 3818 58 12 0 0 upstart-file-br ... [10396] 104 10396 21140 12367 44 0 0 nginx [10397] 104 10397 21140 12324 44 0 0 nginx [10398] 104 10398 21140 12324 44 0 0 nginx [10399] 104 10399 21140 12367 44 0 0 nginx æœ¬ä¾‹ä¸­ï¼Œä¸€ä¸ª nginx è¿›ç¨‹è¢«é€‰ä¸­ä½œä¸ºç¼“è§£å†…å­˜å‹åŠ›çš„ç‰ºç‰²è¿›ç¨‹ï¼š Out of memory: Kill process 10366 (nginx) score 6 or sacrifice child Killed process 10366 (nginx) total-vm:84784kBï¼Œanon-rss:49156kBï¼Œ file-rss:520kB æ•´ä¸ªè¿‡ç¨‹è¿›è¡Œçš„æ—¶é—´å¾ˆçŸ­ï¼Œåªæœ‰æ¯«ç§’çº§åˆ«ï¼Œä½†æ˜¯å·¥ä½œé‡ï¼è®¡ç®—é‡å¾ˆå¤§ï¼Œè¿™å°±å¯¼è‡´äº† cpu çŸ­æ—¶é—´å†…è¿…é€Ÿé£™å‡ï¼Œ å‡ºç°å³°å€¼ã€‚ ä½†è¿™ä¸€åˆ‡å·¥ä½œéƒ½ç”±å†…æ ¸åœ¨å†…æ ¸ç©ºé—´ä¸­å®Œæˆï¼Œæ‰€ä»¥ç”¨æˆ·åœ¨è‡ªå·±çš„ä¸šåŠ¡ç›‘æ§æ•°æ®ä¸Šå¹¶ä¸ä¼šçœ‹åˆ°ä¸šåŠ¡é‡çš„å¼‚å¸¸ã€‚è¿™äº›çŸ­æ—¶é—´å‡é«˜çš„ cpu æ˜¯å†…æ ¸ä½¿ç”¨çš„ï¼Œè€Œä¸æ˜¯ç”¨æˆ·çš„ä¸šåŠ¡ã€‚ æœ¬ä¾‹ä¸­å®¢æˆ·åªæ˜¯å¶å°”çœ‹åˆ°è¿™ä¸ªç°è±¡ï¼Œä¸”ä¸šåŠ¡å¹¶æ²¡æœ‰å—åˆ°å½±å“ã€‚æˆ‘ä»¬ç»™å®¢æˆ·çš„å»ºè®®æ˜¯åˆ†æä¸šåŠ¡å†…å­˜éœ€æ±‚é‡æœ€å¤§å€¼ï¼Œå¦‚æœç³»ç»Ÿå·²ç»æ²¡æœ‰åŠæ³•æ»¡è¶³ç‰¹å®šæ—¶æ®µä¸šåŠ¡çš„å†…å­˜éœ€æ±‚ï¼Œ å»ºè®®ç”¨æˆ·å‡çº§å†…å­˜æ¥é¿å… oom çš„æƒ…å†µå‘ç”Ÿï¼Œ å› ä¸ºä¸¥é‡çš„ oom æƒ…å†µæ˜¯å¯èƒ½å¼•å‘ç³»ç»Ÿå´©æºƒçš„ã€‚ 2.3 æˆ‘çš„æœåŠ¡å™¨å†…å­˜å»å“ªå„¿äº† èƒŒæ™¯ æ”¶åˆ°æŠ¥è­¦ï¼Œç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨ç‡è§¦å‘é˜ˆå€¼ï¼ˆéƒ¨åˆ†å›¾æ˜¯åè¡¥çš„ï¼‰ã€‚ ç™»é™†ç³»ç»Ÿï¼Œä½¿ç”¨å‘½ä»¤(top æŒ‰M)æŸ¥çœ‹å†…å­˜åˆ†é…ã€‚ ä½¿ç”¨å‘½ä»¤free -mæŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ ä½¿ç”¨å‘½ä»¤atopçœ‹ä¸‹å†…å­˜åˆ†é…ï¼ˆcat /proc/meminfo ä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€äº›ç»†åŒ–çš„å†…å­˜ä½¿ç”¨ä¿¡æ¯ï¼‰ã€‚ å‘ç° cache æ‰ 1.7Gï¼Œslab éå¸¸é«˜ï¼Œ4.4Gï¼Œslab å†…å­˜ç®€å•ç†è§£ä¸ºæ˜¯ç³»ç»Ÿå ç”¨çš„ã€‚ ä½¿ç”¨ slabtop ç»§ç»­åˆ†æã€‚ çœ‹åˆ° proc_inode_cache ä½¿ç”¨çš„æœ€å¤šï¼Œ è¿™ä¸ªä»£è¡¨æ˜¯ proc æ–‡ä»¶ç³»ç»Ÿçš„ inode å ç”¨çš„ã€‚ ä½¿ç”¨å‘½ä»¤ps -eLfæŸ¥è¿›ç¨‹ï¼Œä½†æ˜¯è¿›ç¨‹ä¸å¤šï¼Œå†æŸ¥çº¿ç¨‹ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ã€‚å¾—åˆ°å¦‚ä¸‹çš„ç»“æœï¼š( åŸå›¾ç¼ºå¤±ï¼Œä½¿ç”¨æµ‹è¯•æœºæŸ¥çœ‹åˆ°çš„æˆªå›¾æ¥è¡¥å……è¯´æ˜ ) è®¡ç®— socket $ ll /proc/22360/task/*/fd/ |grep socket |wc -l 140 è®¡ç®—ä¸€ä¸‹æœ‰å¤šå°‘fd $ ll /proc/22360/task/*/fd/ | wc -l 335 æ¯ä¸ª socket çš„ inode ä¹Ÿä¸ä¸€æ ·ã€‚ å½“æ—¶çœ‹åˆ°çš„ç°åœºæœ‰å‡ ä¸‡ä¸ª fdï¼Œ åŸºæœ¬å…¨æ˜¯ socketï¼Œ æ¯ä¸ª inode éƒ½æ˜¯å ç”¨ç©ºé—´çš„ï¼Œ ä¸” proc æ–‡ä»¶ç³»ç»Ÿæ˜¯å…¨å†…å­˜çš„ã€‚ æ‰€ä»¥æˆ‘ä»¬æ‰ä¼šçœ‹åˆ° slab ä¸­ proc_inode_cache å†…å­˜å ç”¨é«˜ã€‚ å»ºè®® å»ºè®®ç”¨æˆ·éœ€è¦ä»ç¨‹åºä¸Šä¼˜åŒ–ç›¸å…³çš„ server ç«¯ ~ 2.4 CPU å ç”¨ä¸é«˜ä½†ç½‘ç»œæ€§èƒ½å¾ˆå·®çš„ä¸€ä¸ªåŸå›  ç®€ä»‹ æˆ‘ä»¬ç»å¸¸ç¢°åˆ°æ•´ä½“ cpu ä¸é«˜ï¼Œä½†æ˜¯æ€§èƒ½ä¸ä½³çš„æ¡ˆä¾‹ï¼Œè¿™ç§æ¡ˆä¾‹å¾€å¾€è·Ÿ CPU å¤„ç†ä¸­æ–­çš„æ ¸å¿ƒè·‘æ»¡æœ‰å…³ç³»ï¼Œè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸­æ–­ç›¸å…³çš„æ¡ˆä¾‹ã€‚ 2.4.1 ä»€ä¹ˆæ˜¯ä¸­æ–­ï¼Ÿ å½“ä¸€ä¸ªç¡¬ä»¶ ( å¦‚ç£ç›˜æ§åˆ¶å™¨æˆ–è€…ä»¥å¤ªç½‘å¡ )ï¼Œéœ€è¦æ‰“æ–­ CPU çš„å·¥ä½œæ—¶ï¼Œå®ƒå°±è§¦å‘ä¸€ä¸ªä¸­æ–­ã€‚è¯¥ä¸­æ–­é€šçŸ¥ CPU å‘ç”Ÿäº†æŸäº›äº‹æƒ…å¹¶ä¸” CPU åº”è¯¥æ”¾ä¸‹å½“å‰çš„å·¥ä½œå»å¤„ç†è¿™ä¸ªäº‹æƒ…ã€‚ä¸ºäº†é˜²æ­¢å¤šä¸ªè®¾ç½®å‘é€ç›¸åŒçš„ä¸­æ–­ï¼ŒLinux è®¾è®¡äº†ä¸€å¥—ä¸­æ–­è¯·æ±‚ç³»ç»Ÿï¼Œä½¿å¾—è®¡ç®—æœºç³»ç»Ÿä¸­çš„æ¯ä¸ªè®¾å¤‡è¢«åˆ†é…äº†å„è‡ªçš„ä¸­æ–­å·ï¼Œä»¥ç¡®ä¿å®ƒçš„ä¸­æ–­è¯·æ±‚çš„å”¯ä¸€æ€§ã€‚ ä» 2.4 å†…æ ¸å¼€å§‹ï¼ŒLinux æ”¹è¿›äº†åˆ†é…ç‰¹å®šä¸­æ–­åˆ°æŒ‡å®šçš„å¤„ç†å™¨ ( æˆ–å¤„ç†å™¨ç»„ ) çš„åŠŸèƒ½ã€‚ è¿™è¢«ç§°ä¸º SMP IRQ affinityï¼Œå®ƒå¯ä»¥æ§åˆ¶ç³»ç»Ÿå¦‚ä½•å“åº”å„ç§ç¡¬ä»¶äº‹ä»¶ã€‚å…è®¸ä½ é™åˆ¶æˆ–è€…é‡æ–°åˆ†é…æœåŠ¡å™¨çš„å·¥ä½œè´Ÿè½½ï¼Œä»è€Œè®©æœåŠ¡å™¨æ›´æœ‰æ•ˆçš„å·¥ä½œã€‚ ä»¥ç½‘å¡ä¸­æ–­ä¸ºä¾‹ï¼Œåœ¨æ²¡æœ‰è®¾ç½® SMP IRQ affinity æ—¶ï¼Œæ‰€æœ‰ç½‘å¡ä¸­æ–­éƒ½å…³è”åˆ° CPU0ï¼Œ è¿™å¯¼è‡´äº† CPU0 è´Ÿè½½è¿‡é«˜ï¼Œè€Œæ— æ³•æœ‰æ•ˆå¿«é€Ÿçš„å¤„ç†ç½‘ç»œæ•°æ®åŒ…ï¼Œå¯¼è‡´äº†ç“¶é¢ˆã€‚ é€šè¿‡ SMP IRQ affinityï¼ŒæŠŠç½‘å¡å¤šä¸ªä¸­æ–­åˆ†é…åˆ°å¤šä¸ª CPU ä¸Šï¼Œå¯ä»¥åˆ†æ•£ CPU å‹åŠ›ï¼Œ æé«˜æ•°æ®å¤„ç†é€Ÿåº¦ã€‚ ä½†æ˜¯ smp_affinity è¦æ±‚ç½‘å¡æ”¯æŒå¤šé˜Ÿåˆ—ï¼Œ å¦‚æœç½‘å¡æ”¯æŒå¤šé˜Ÿåˆ—åˆ™è®¾ç½®æ‰æœ‰ä½œç”¨ï¼Œç½‘å¡æœ‰å¤šé˜Ÿåˆ—ï¼Œæ‰ä¼šæœ‰å¤šä¸ªä¸­æ–­å·ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠä¸åŒçš„ä¸­æ–­å·åˆ†é…åˆ°ä¸åŒ CPU ä¸Šï¼Œè¿™æ ·ä¸­æ–­å·å°±èƒ½ç›¸å¯¹å‡åŒ€çš„åˆ†é…åˆ°ä¸åŒçš„ CPU ä¸Šã€‚ è€Œå•é˜Ÿåˆ—çš„ç½‘å¡å¯ä»¥é€šè¿‡ RPS/RFS æ¥æ¨¡æ‹Ÿå¤šé˜Ÿåˆ—çš„æƒ…å†µï¼Œä½†æ˜¯è¯¥æ•ˆæœå¹¶ä¸å¦‚ç½‘å¡æœ¬èº«å¤šé˜Ÿåˆ— + å¼€å¯ RPSRFS æ¥çš„æœ‰æ•ˆã€‚ 2.4.2 ä»€ä¹ˆæ˜¯ RPS/RFS RPSï¼ˆReceive Packet Steeringï¼‰ä¸»è¦æ˜¯æŠŠè½¯ä¸­æ–­çš„è´Ÿè½½å‡è¡¡åˆ°å„ä¸ª cpuï¼Œç®€å•æ¥è¯´ï¼Œæ˜¯ç½‘å¡é©±åŠ¨å¯¹æ¯ä¸ªæµç”Ÿæˆä¸€ä¸ª hash æ ‡è¯†ï¼Œ è¿™ä¸ª HASH å€¼å¾—è®¡ç®—å¯ä»¥é€šè¿‡å››å…ƒç»„æ¥è®¡ç®—ï¼ˆSIPï¼ŒSPORTï¼ŒDIPï¼ŒDPORTï¼‰ï¼Œç„¶åç”±ä¸­æ–­å¤„ç†çš„åœ°æ–¹æ ¹æ®è¿™ä¸ª hash æ ‡è¯†åˆ†é…åˆ°ç›¸åº”çš„ CPU ä¸Šå»ï¼Œè¿™æ ·å°±å¯ä»¥æ¯”è¾ƒå……åˆ†çš„å‘æŒ¥å¤šæ ¸çš„èƒ½åŠ›äº†ã€‚é€šä¿—ç‚¹è¯´å°±æ˜¯åœ¨è½¯ä»¶å±‚é¢æ¨¡æ‹Ÿå®ç°ç¡¬ä»¶çš„å¤šé˜Ÿåˆ—ç½‘å¡åŠŸèƒ½ï¼Œå¦‚æœç½‘å¡æœ¬èº«æ”¯æŒå¤šé˜Ÿåˆ—åŠŸèƒ½çš„è¯ RPS å°±ä¸ä¼šæœ‰ä»»ä½•çš„ä½œç”¨ã€‚è¯¥åŠŸèƒ½ä¸»è¦é’ˆå¯¹å•é˜Ÿåˆ—ç½‘å¡å¤š CPU ç¯å¢ƒï¼Œå¦‚ç½‘å¡æ”¯æŒå¤šé˜Ÿåˆ—åˆ™å¯ä½¿ç”¨ SMP irq affinity ç›´æ¥ç»‘å®šç¡¬ä¸­æ–­ã€‚ ç”±äº RPS åªæ˜¯å•çº¯æŠŠæ•°æ®åŒ…å‡è¡¡åˆ°ä¸åŒçš„ cpuï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœåº”ç”¨ç¨‹åºæ‰€åœ¨çš„ cpu å’Œè½¯ä¸­æ–­å¤„ç†çš„ cpu ä¸æ˜¯åŒä¸€ä¸ªï¼Œ æ­¤æ—¶å¯¹äº cpu cache çš„å½±å“ä¼šå¾ˆå¤§ï¼Œ é‚£ä¹ˆ RFS ï¼ˆReceive flow steeringï¼‰ç¡®ä¿åº”ç”¨ç¨‹åºå¤„ç†çš„ cpu è·Ÿè½¯ä¸­æ–­å¤„ç†çš„ cpu æ˜¯åŒä¸€ä¸ªï¼Œè¿™æ ·å°±å……åˆ†åˆ©ç”¨ cpu çš„ cacheï¼Œè¿™ä¸¤ä¸ªè¡¥ä¸å¾€å¾€éƒ½æ˜¯ä¸€èµ·è®¾ç½®ï¼Œæ¥è¾¾åˆ°æœ€å¥½çš„ä¼˜åŒ–æ•ˆæœï¼Œä¸»è¦æ˜¯é’ˆå¯¹å•é˜Ÿåˆ—ç½‘å¡å¤š CPU ç¯å¢ƒã€‚ rps_flow_cntï¼Œrps_sock_flow_entriesï¼Œ å‚æ•°çš„å€¼ä¼šè¢«è¿›ä½åˆ°æœ€è¿‘çš„2çš„å¹‚æ¬¡æ–¹å€¼ï¼Œå¯¹äºå•é˜Ÿåˆ—è®¾å¤‡ï¼Œ å•é˜Ÿåˆ—çš„ rps_flow_cnt å€¼è¢«é…ç½®æˆä¸rps_sock_flow_ entries ç›¸åŒã€‚ RFS ä¾é  RPS çš„æœºåˆ¶æ’å…¥æ•°æ®åŒ…åˆ°æŒ‡å®š CPU çš„ backlog é˜Ÿåˆ—ï¼Œå¹¶å”¤é†’é‚£ä¸ª CPU æ¥æ‰§è¡Œã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼€å¯ irqbalance æ˜¯è¶³å¤Ÿç”¨çš„ï¼Œä½†æ˜¯å¯¹äºä¸€äº›å¯¹ç½‘ç»œæ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ï¼Œæ‰‹åŠ¨ç»‘å®šä¸­æ–­ç£¨åˆæ˜¯æ¯”è¾ƒå¥½çš„é€‰æ‹©ã€‚ å¼€å¯ irqbalanceï¼Œä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼š a) æœ‰æ—¶å€™è®¡ç®—å‡ºæ¥çš„å€¼ä¸åˆç†ï¼Œå¯¼è‡´ CPU ä½¿ç”¨è¿˜æ˜¯ä¸å‡è¡¡ã€‚ b) åœ¨ç³»ç»Ÿæ¯”è¾ƒç©ºé—² IRQ å¤„äº Power-save mode æ—¶ï¼Œirqbalance ä¼šå°†ä¸­æ–­é›†ä¸­åˆ†é…ç»™ç¬¬ä¸€ä¸ª CPUï¼Œ ä»¥ä¿è¯å…¶å®ƒç©ºé—² CPU çš„ç¡çœ æ—¶é—´ï¼Œé™ä½èƒ½è€—ã€‚å¦‚æœå‹åŠ›çªç„¶ä¸Šå‡ï¼Œå¯èƒ½ä¼šç”±äºè°ƒæ•´çš„æ»åæ€§å¸¦æ¥æ€§èƒ½ é—®é¢˜ã€‚ c) å¤„ç†ä¸­æ–­çš„ CPU æ€»æ˜¯ä¼šå˜ï¼Œå¯¼è‡´äº†æ›´å¤šçš„ context switchã€‚ dï¼‰ä¹Ÿå­˜åœ¨ä¸€äº›æƒ…å†µï¼Œå¯åŠ¨äº† irqbalanceï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œæ²¡æœ‰çœŸæ­£å»è®¾ç½®å¤„ç†ä¸­æ–­çš„cpuã€‚ 2.4.3 å¦‚ä½•æŸ¥çœ‹ç½‘å¡çš„é˜Ÿåˆ—æ•° Combined ä»£è¡¨é˜Ÿåˆ—ä¸ªæ•°ï¼Œè¯´æ˜æˆ‘çš„æµ‹è¯•æœºæœ‰ 4 ä¸ªé˜Ÿåˆ—ã€‚ # ethtool -l eth0 Channel parameters for eth0: Pre-set maximums: RX: 0 TX: 0 Other: 0 Combined: 4 Current hardware settings: RX: 0 TX: 0 Other: 0 Combined: 4 ä»¥ CentOS7.6 ä¸ºä¾‹ï¼Œç³»ç»Ÿå¤„ç†ä¸­æ–­çš„è®°å½•åœ¨ /proc/interrupts æ–‡ä»¶é‡Œé¢ï¼Œé»˜è®¤è¿™ä¸ªæ–‡ä»¶è®°å½•æ¯”è¾ƒå¤šï¼Œå½±å“æŸ¥çœ‹ï¼ŒåŒæ—¶å¦‚æœ cpu æ ¸å¿ƒä¹Ÿéå¸¸å¤šçš„è¯ï¼Œ å¯¹äºé˜…è¯»çš„å½±å“éå¸¸å¤§ã€‚ # cat /proc/interrupts CPU0 CPU1 CPU2 CPU3 0: 141 0 0 0 IO-APIC-edge timer 1: 10 0 0 0 IO-APIC-edge i8042 4: 807 0 0 0 IO-APIC-edge serial 6: 3 0 0 0 IO-APIC-edge floppy 8: 0 0 0 0 IO-APIC-edge rtc0 9: 0 0 0 0 IO-APIC-fasteoi acpi 10: 0 0 0 0 IO-APIC-fasteoi virtio3 11: 22 0 0 0 IO-APIC-fasteoi hcd:usb1 12: 15 0 0 0 IO-APIC-edge i8042 14: 0 0 0 0 IO-APIC-edge ata_piix 15: 0 0 0 0 IO-APIC-edge ata_piix 24: 0 0 0 0 PCI-MSI-edge virtio1-config ã€‚ã€‚ã€‚ 27: 1913 0 0 0 PCI-MSI-edge virtio2-input.0 28: 3 834 0 0 PCI-MSI-edge virtio2-output.0 input0 è¯´æ˜æ˜¯ cpu0ï¼ˆç¬¬ 1 ä¸ª CPUï¼‰å¤„ç†çš„ç½‘ç»œä¸­æ–­ é˜¿é‡Œäº‘ ecs ç½‘ç»œä¸­æ–­ï¼Œå¦‚æœæ˜¯å¤šä¸ªä¸­æ–­çš„è¯ï¼Œè¿˜æœ‰ input.1 input.2 input.3 è¿™ç§å½¢å¼ å¦‚æœ ecs çš„ cpu æ ¸å¿ƒéå¸¸å¤šï¼Œé‚£è¿™ä¸ªæ–‡ä»¶çœ‹èµ·æ¥å°±ä¼šæ¯”è¾ƒè´¹åŠ²äº†ï¼Œå¯ä½¿ç”¨ä¸‹é¢ çš„å‘½ä»¤æŸ¥çœ‹å¤„ç†ä¸­æ–­çš„æ ¸å¿ƒã€‚ ä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œå³å¯å°†é˜¿é‡Œäº‘ ecs å¤„ç†ä¸­æ–­çš„ cpu æ‰¾å‡ºæ¥äº†ï¼ˆä¸‹é¢è¿™ä¸ªæ¼”ç¤ºæ˜¯ 8c4ä¸ªé˜Ÿåˆ—ï¼‰ # for i in $(egrep \"\\-input.\" /proc/interrupts |awk -F \":\" '{print $1}');do cat /proc/irq/$i/smp_affinity_list;done 5 7 1 3 å¤„ç†ä¸€ä¸‹ sar æ‹·è´ç”¨ # for i in $(egrep \"\\-input.\" /proc/interrupts |awk -F \":\" '{print $1}');do cat /proc/irq/$i/smp_affinity_list;done |tr -s '\\n' ',' 5,7,1,3, # sar -P 5,7,1,3 1 æ¯ç§’åˆ·æ–°ä¸€æ¬¡ cpu åºå·ä¸º 5,7,1,3 æ ¸å¿ƒçš„ cpu ä½¿ç”¨ç‡ # sar -P ALL 1 æ¯ç§’åˆ·æ–°æ‰€æœ‰æ ¸å¿ƒï¼Œç”¨äºå°‘é‡ CPU æ ¸å¿ƒçš„ç›‘æ§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“å¤„ç†æ…¢çš„åŸå› æ˜¯ä¸æ˜¯å› ä¸ºé˜Ÿåˆ—ä¸å¤Ÿå¯¼è‡´çš„äº† Linux 3.10.0-957.5.1.el7.x86_64 (iZwz98aynkjcxvtra0f375Z) x86_64_ (4 CPU) 05:10:06 PM CPU %user %nice %system %iowait %steal %idle 05:10:07 PM all 5.63 0.00 3.58 1.02 0.00 89.77 05:10:07 PM 0 6.12 0.00 3.06 1.02 0.00 89.90 05:10:07 PM 1 5.10 0.00 5.10 0.00 0.00 89.80 05:10:07 PM 2 5.10 0.00 3.06 2.04 0.00 89.80 05:10:07 PM 3 5.10 0.00 4.08 1.02 0.00 89.80 05:10:07 PM CPU %user %nice %system %iowait %steal %idle 05:10:08 PM all 8.78 0.00 15.01 0.69 0.00 75.52 05:10:08 PM 0 10.00 0.00 16.36 0.91 0.00 75.73 05:10:08 PM 1 4.81 0.00 13.46 1.92 0.00 79.81 05:10:08 PM 2 10.91 0.00 15.45 0.91 0.00 72.73 05:10:08 PM 3 9.09 0.00 14.55 0.00 0.00 76.36 sar å°æŠ€å·§ æ‰“å° idle å°äº 10 çš„æ ¸å¿ƒ sar -P 1,3,5,7 1 |tail -n+3|awk '$NF å…³é—­ IRQbalanceã€‚ # service irqbalance status Redirecting to /bin/systemctl status irqbalance.service â— irqbalance.service - irqbalance daemon Loaded: loaded (/usr/lib/systemd/system/irqbalance.service; enabled; vendor preset: enabled) Active: inactive (dead) since Wed 2020-05-27 14:39:28 CST; 2s ago Process: 1832 ExecStart=/usr/sbin/irqbalance --foreground $IRQBALANCE_ ARGS (code=exitedï¼Œstatus=0/SUCCESS) Main PID: 1832 (code=exitedï¼Œstatus=0/SUCCESS) May 27 14:11:40 iZbp1ee4vpiy3w4b8y2m8qZ systemd[1]: Started irqbalance daemon. May 27 14:39:28 iZbp1ee4vpiy3w4b8y2m8qZ systemd[1]: Stopping irqbalance daemon... May 27 14:39:28 iZbp1ee4vpiy3w4b8y2m8qZ systemd[1]: Stopped irqbalance daemon. æ‰‹åŠ¨è®¾ç½® RPSã€‚ æ‰‹åŠ¨è®¾ç½®ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸‹é¢çš„æ–‡ä»¶ï¼ˆIRQ_number å°±æ˜¯å‰é¢ grep input æ‹¿åˆ°çš„åºå·ï¼‰ã€‚ è¿›å…¥ /proc/irq/${IRQ_number}/ï¼Œ å…³æ³¨ä¸¤ä¸ªæ–‡ä»¶ï¼šsmp_affinity å’Œ smp_ affinity_listã€‚ smp_affinity æ˜¯ bitmask+16 è¿›åˆ¶ï¼Œ smp_affinity_listï¼šè¿™ä¸ªæ–‡ä»¶æ›´å¥½ç†è§£ï¼Œé‡‡ç”¨çš„æ˜¯ 10 è¿›åˆ¶ï¼Œå¯è¯»æ€§é«˜ã€‚ æ”¹è¿™ä¸¤ä¸ªä»»æ„ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦ä¸€ä¸ªæ–‡ä»¶ä¼šåŒæ­¥æ›´æ”¹ã€‚ ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œå’±ä»¬ç›´æ¥çœ‹åè¿›åˆ¶çš„æ–‡ä»¶ smp_affinity_list å³å¯ã€‚ å¦‚æœè¿™ä¸€æ­¥æ²¡çœ‹æ˜ç™½ï¼Œæ³¨æ„å‰é¢çš„ /proc/interrupts çš„è¾“å‡º # for i in $(egrep \"\\-input.\" /proc/interrupts |awk -F \":\" '{print $1}'); do cat /proc/irq/$i/smp_affinity_list;done 1 3 1 3 æ‰‹åŠ¨è®¾ç½®å¤„ç†ä¸­æ–­çš„ CPU å·ç å¯ä»¥ç›´æ¥ echo ä¿®æ”¹ï¼Œä¸‹é¢å°±æ˜¯å°†åºå· 27 çš„ä¸­æ–­æ”¾åˆ° cpu0 ä¸Šå¤„ç†ï¼Œä¸€èˆ¬å»ºè®®å¯ä»¥æŠŠ cpu0 ç©ºå‡ºæ¥ # echo 0 >> /proc/irq/27/smp_affinity_list # cat /proc/irq/27/smp_affinity_list 0 å…³äº bitmas \"f\" æ˜¯åå…­è¿›åˆ¶çš„å€¼å¯¹åº”çš„ äºŒè¿›åˆ¶æ˜¯ \"1111\"ï¼ˆå¯ä»¥ç†è§£ä¸º 4c çš„é…ç½®è®¾ç½®ä¸º f çš„è¯ï¼Œæ‰€æœ‰çš„ cpu å‚ä¸å¤„ç†ä¸­æ–­ï¼‰ äºŒè¿›åˆ¶ä¸­çš„æ¯ä¸ªä½ä»£è¡¨äº†æœåŠ¡å™¨ä¸Šçš„æ¯ä¸ª CPU. ä¸€ä¸ªç®€å•çš„ demo CPUåºå· äºŒè¿›åˆ¶ åå…­è¿›åˆ¶ CPU 0 0001 1 CPU 1 0010 2 CPU 2 0100 4 CPU 3 1000 8 éœ€è¦å¯¹æ¯å—ç½‘å¡æ¯ä¸ªé˜Ÿåˆ—åˆ†åˆ«è¿›è¡Œè®¾ç½®ã€‚å¦‚å¯¹ eth0 çš„ 0 å·é˜Ÿåˆ—è®¾ç½®ï¼š echo ff > /sys/class/net/eth0/queues/rx-0/rps_cpus è¿™é‡Œçš„è®¾ç½®æ–¹å¼å’Œä¸­æ–­äº²å’ŒåŠ›è®¾ç½®çš„æ–¹æ³•æ˜¯ç±»ä¼¼çš„ã€‚é‡‡ç”¨çš„æ˜¯æ©ç çš„æ–¹å¼ï¼Œä½†æ˜¯è¿™é‡Œé€šå¸¸è¦å°†æ‰€æœ‰çš„ CPU è®¾ç½®è¿›å…¥ï¼Œå¦‚ï¼š 4coreï¼Œf 8coreï¼Œff 16coreï¼Œffff 32coreï¼Œffffffff é»˜è®¤åœ¨ 0 å· cpu ä¸Š # cat /sys/class/net/eth0/queues/rx-0/rps_cpus 0 # echo f >>/sys/class/net/eth0/queues/rx-0/rps_cpus # cat /sys/class/net/eth0/queues/rx-0/rps_cpus f è®¾ç½® RFS çš„æ–¹å¼ã€‚ éœ€è¦è®¾ç½®ä¸¤ä¸ªåœ°æ–¹ï¼š å…¨å±€è¡¨rps_sock_flow_table çš„æ¡ç›®æ•°é‡ã€‚é€šè¿‡ä¸€ä¸ªå†…æ ¸å‚æ•°æ§åˆ¶ï¼š # sysctl -a |grep net.core.rps_sock_flow_entries net.core.rps_sock_flow_entries = 0 # sysctl -w net.core.rps_sock_flow_entries=1024 net.core.rps_sock_flow_entries = 1024 æ¯ä¸ªç½‘å¡é˜Ÿåˆ— hash è¡¨çš„æ¡ç›®æ•°ï¼š # cat /sys/class/net/eth0/queues/rx-0/rps_flow_cnt 0 # echo 256 >> /sys/class/net/eth0/queues/rx-0/rps_flow_cnt # cat /sys/class/net/eth0/queues/rx-0/rps_flow_cnt 256 éœ€è¦å¯åŠ¨ RFSï¼Œä¸¤è€…éƒ½éœ€è¦è®¾ç½®ã€‚ å»ºè®®æœºå™¨ä¸Šæ‰€æœ‰çš„ç½‘å¡é˜Ÿåˆ—è®¾ç½®çš„ rps_flow_cnt ç›¸åŠ åº”è¯¥å°äºæˆ–è€…ç­‰äº rps_sock_flow_entriesã€‚ å› ä¸ºæ˜¯4ä¸ªé˜Ÿåˆ—ï¼Œ å› æ­¤æ¯ä¸ªé˜Ÿåˆ—è®¾ç½® 256ï¼Œ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µå¢å¤§ã€‚ 2.5 ä¸€æ¬¡ IO å¼‚å¸¸æ•è·è¿‡ç¨‹ ç®€ä»‹ é‡åˆ°ä¸€ä¸ª IO å¼‚å¸¸é£™å‡çš„é—®é¢˜ï¼ŒIO èµ·é£åç³»ç»Ÿå“åº”å¼‚å¸¸ç¼“æ…¢ï¼Œçœ‹ä¸åˆ°ç°åœºä¸€ç›´æ— æ³•å®šä½é—®é¢˜ï¼Œ æ£€æŸ¥å¯¹åº”æ—¶é—´ç‚¹åº”ç”¨æ—¥å¿—ä¹Ÿæ²¡æœ‰å‘ç°å¼‚å¸¸çš„è®¿é—®ï¼Œ è¿™ç§é—®é¢˜æ€ä¹ˆåŠå‘¢ï¼Ÿ 2.5.1 é‡‡é›†ç³»ç»Ÿ IOï¼Œç¡®è®¤ IO å¼‚å¸¸å‘ç”Ÿåœ¨ç³»ç»Ÿç›˜ï¼Œè¿˜æ˜¯æ•°æ®ç›˜ï¼Œä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ iostat å³å¯é‡‡é›† # iostat -d 3 -k -x -t 30 Linux 3.10.0-957.21.3.el7.x86_64 (tencent) 08/05/2020 _x86_64_ (1 CPU) 06/12/2018 11:51:49 AM Device: rrqm/s wrqm/s r/s w/s rkB/s wkB/s avgrq-sz avgqu-sz await r_await w_await svctm %util vda 0.12 12.66 4.59 8.55 127.03 143.35 41.16 0.07 7.91 15.92 3.61 0.65 0.85 scd0 0.00 0.00 0.00 0.00 0.00 0.00 7.10 0.00 1.03 1.03 0.00 1.02 0.00 06/12/2018 11:51:52 AM Device: rrqm/s wrqm/s r/s w/s rkB/s wkB/s avgrq-sz avgqu-sz await r_await w_await svctm %util vda 0.00 27.61 10.44 69.70 247.81 397.31 16.10 0.99 15.57 1.71 17.65 0.16 1.28 scd0 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 æ¯éš” 3 ç§’é‡‡é›†ä¸€æ¬¡ç£ç›˜ ioï¼Œè¾“å‡ºæ—¶é—´ï¼Œä¸€å…±é‡‡é›† 30 æ¬¡ï¼Œæƒ³ä¸€ç›´æŠ“çš„è¯æŠŠ 30 å»æ‰å³å¯ï¼Œæ³¨æ„ç£ç›˜ç©ºä½™é‡ã€‚ é€šè¿‡è¿™ä¸ªå‘½ä»¤æˆ‘ä»¬å¯ä»¥ç¡®è®¤å¦‚ä¸‹ä¿¡æ¯ï¼š - é—®é¢˜å‘ç”Ÿçš„æ—¶é—´ - å“ªå—ç›˜å‘ç”Ÿçš„ io - ç£ç›˜çš„ IOPSï¼ˆ r/s w/sï¼‰ä»¥åŠååé‡ï¼ˆ rkB/s wkB/s ï¼‰ 2.5.2 ç¡®è®¤å“ªå—ç›˜å‘ç”Ÿäº† IO è¿˜ä¸å¤Ÿï¼Œå†æŠ“ä¸€ä¸‹å‘ç”Ÿ IO çš„è¿›ç¨‹ï¼Œéœ€è¦å®‰è£… iotop è¿›è¡Œæ•è· # iotop -b -o -d 3 -t -qqq -n 30 10:18:41 7024 be/4 root 0.00 B/s 2.64 M/s 0.00 % 93.18 % fio -direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_ Write_Testing æ¯éš” 3 ç§’é‡‡é›†ä¸€æ¬¡ï¼Œä¸€å…±é‡‡é›† 30 æ¬¡ï¼Œé™é»˜æ¨¡å¼ï¼Œåªæ˜¾ç¤ºæœ‰ io å‘ç”Ÿçš„è¿›ç¨‹ é€šè¿‡è¿™ä¸ªå‘½ä»¤æˆ‘ä»¬å¯ä»¥ç¡®è®¤å¦‚ä¸‹ä¿¡æ¯ï¼š - é—®é¢˜å‘ç”Ÿçš„æ—¶é—´ - äº§ç”Ÿ IO çš„è¿›ç¨‹ id ä»¥åŠè¿›ç¨‹å‚æ•°ï¼ˆcommandï¼‰ - è¿›ç¨‹äº§ç”Ÿçš„ååé‡ï¼ˆå¦‚æœæœ‰å¤šä¸ªå¯ä»¥æŠŠ qqq å»æ‰å¯æ˜¾ç¤ºæ€»é‡ï¼‰ - è¿›ç¨‹å ç”¨å½“å‰ IO çš„ç™¾åˆ†æ¯” ä¿—è¯è¯´å¾—å¥½ï¼Œå…‰è¯´ä¸ç»ƒå‡æŠŠå¼ï¼Œæˆ‘ä»¬å®æ“æ¥çœ‹ä¸€ä¸‹ ( æ¶‰åŠç”¨æˆ·è¿›ç¨‹ä¿¡æ¯ , æ²¡æœ‰å¾—åˆ°å®¢æˆ·æˆæƒå› æ­¤ä»¥ fio ä¸ºæ¼”ç¤º )ã€‚ 2.5.3 ä½¿ç”¨ fio è¿›è¡Œ IO å‹æµ‹ï¼Œå…·ä½“å‚æ•°å¯ä»¥å‚è€ƒå—å­˜å‚¨æ€§èƒ½ å‹æµ‹çª—å£ï¼š fio -direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_ Write_Testing Rand_Write_Testing: (g=0): rw=randwriteï¼Œbs=1K-1K/1K-1K/1K-1Kï¼Œ ioengine=libaioï¼Œiodepth=128 fio-2.0.13 Starting 1 process ^Cbs: 1 (f=1): [w] [8.5% done] [0K/2722K/0K /s] [0 /2722 /0 iops] [eta 05m:53s] fio: terminating on signal 2 Rand_Write_Testing: (groupid=0ï¼Œjobs=1): err= 0: pid=11974: Tue Jun 12 10:36:30 2018 write: io=88797KBï¼Œbw=2722.8KB/sï¼Œiops=2722 ï¼Œrunt= 32613msec ...... iotop çª—å£ï¼š # iotop -n 10 -b -o -d 3 -t -qqq 10:36:03 11974 be/4 root 0.00 B/s 2.63 M/s 0.00 % 93.95 % fio -direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_ Write_Testing 10:36:06 11974 be/4 root 0.00 B/s 2.64 M/s 0.00 % 92.68 % fio -direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_ Write_Testing iostat çª—å£ï¼š # iostat -d 3 -k -x -t 10 Linux 3.10.0-957.21.3.el7.x86_64 (tencent) 08/05/2020 _x86_64_ (1 CPU) 06/12/2018 12:26:41 PM Device: rrqm/s wrqm/s r/s w/s rkB/s wkB/s avgrq-sz avgqu-sz await r_await w_await svctm %util vda 0.12 12.66 4.59 8.56 127.09 143.47 41.16 0.07 7.91 15.91 3.61 0.65 0.85 scd0 0.00 0.00 0.00 0.00 0.00 0.00 7.10 0.00 1.03 1.03 0.00 1.02 0.00 06/12/2018 12:26:44 PM Device: rrqm/s wrqm/s r/s w/s rkB/s wkB/s avgrq-sz avgqu-sz await r_await w_await svctm %util vda 0.00 81.14 32.66 84.18 1202.69 2488.89 63.19 0.31 2.75 3.00 2.66 0.34 3.97 scd0 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 é€šè¿‡è¾“å‡ºç»“æœçš„æ—¶é—´ç‚¹è¿›è¡Œå¯¹æ¯”åˆ†æï¼Œ ç›¸å¯¹äº fio çš„ IOPSï¼Œ ååé‡è·Ÿ iotop ä»¥åŠ iostat ç›‘æ§åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´ã€‚å› æ­¤ï¼Œçœ‹åˆ°è¿™ï¼Œæ‚¨å·²ç»å­¦ä¼šæ€ä¹ˆæŸ¥æ¶ˆè€— IO çš„è¿›ç¨‹äº†ã€‚ âš ï¸ä¸ºäº†å‹æµ‹çš„æ…¢ä¸€äº›ç‰¹æ„æŠŠ bs è®¾ç½®ä¸º 1kï¼Œè¿™æ ·æ‰§è¡Œçš„æ—¶é—´ä¼šæ¯”è¾ƒä¹…ï¼Œfio å‹ æµ‹è¯¦è§å‰é¢çš„å—å­˜å‚¨æ€§èƒ½ã€‚ å¿ƒç»†çš„åŒå­¦å¯èƒ½å‘ç° iotop è¾“å‡ºä¸å¸¦å¹´æœˆæ—¥ï¼Œå¦‚æœæŠ“æ—¥å¿—çš„æ—¶é—´è¶…è¿‡ 24 å°æ—¶ï¼Œæ—¶é—´é‡å¤æ€ä¹ˆåŠï¼Ÿ # iotop -b -o -d 1 -qqq |awk '{ print $0\"\\t\" strftime(\"%Y-%m-%d-%H:%M:%S\", systime()) } ' 1252 be/3 root 0.00 B/s 22.83 K/s 0.00 % 1.12 % [jbd2/vda1-8] 2018-06-12:28:19 16374 be/4 root 76.12 K/s 0.00 B/s 0.00 % 0.33 % YDService 2018-06-12:28:19 21495 be/4 mysql 0.00 B/s 121.79 K/s 0.00 % 0.15 % mysqld --defaults-file=/etc/my.cnf 2018-06-12:28:19 21493 be/4 mysql 0.00 B/s 0.00 B/s 0.00 % 0.11 % mysqld --defaults-file=/etc/my.cnf 2018-06-12:28:19 21500 be/4 mysql 0.00 B/s 3.81 K/s 0.00 % 0.11 % mysqld --defaults-file=/etc/my.cnf 2018-06-12:28:19 13377 be/4 mysql 0.00 B/s 3.81 K/s 0.00 % 0.09 % mysqld --defaults-file=/etc/my.cnf 2018-06-12:28:19 18071 be/4 mysql 0.00 B/s 3.81 K/s 0.00 % 0.09 % mysqld --defaults-file=/etc/my.cnf 2018-06-12:28:19 32718 be/4 root 0.00 B/s 0.00 B/s 0.00 % 0.01 % [kworker/0:2] 2018-06-12:28:19 10641 be/4 root 0.00 B/s 11.42 K/s 0.00 % 0.00 % java -server -Xms1024m -Xmx1024m -jar ./kooteam.jar 2018-06-12:28:19 30019 be/4 polkitd 0.00 B/s 19.03 K/s 0.00 % 0.00 % postgres: stats collector process 2018-06-12:28:19 1252 be/3 root 0.00 B/s 0.00 B/s 0.00 % 0.71 % [jbd2/vda1-8] 2018-06-12:28:20 16374 be/4 root 90.77 K/s 0.00 B/s 0.00 % 0.47 % YDService 2018-06-12:28:20 21494 be/4 mysql 0.00 B/s 0.00 B/s 0.00 % 0.33 % mysqld --defaults-file=/etc/my.cnf 2018-06-12:28:20 21495 be/4 mysql 0.00 B/s 90.77 K/s 0.00 % 0.14 % mysqld --defaults-file=/etc/my.cnf 2018-06-12:28:20 3922 be/4 mysql 0.00 B/s 3.78 K/s 0.00 % 0.11 % mysqld --defaults-file=/etc/my.cnf 2018-06-12:28:20 è¯¦ç»†å‚æ•°å°±ä¸è®²äº†ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸‹è¾“å‡ºç»“æœè¡Œæœ€åä¸€åˆ—æ˜¯å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼Œé‚£ä¹ˆ IO æ¶ˆè€—çš„å§‹ä½œä¿‘è€…ä¼šæŸ¥äº†å—ï¼Ÿ ä¸‰ã€Linux ä¸»æœºç½‘ç»œé—®é¢˜ è¯´æ˜ ä»å”®åå¤„ç†è§’åº¦ï¼Œé˜¿é‡Œäº‘ç”¨æˆ·ä¸šåŠ¡ç³»ç»Ÿæ­å»ºåœ¨ ECS äº‘æœåŠ¡å™¨åé¦ˆæœ€å¤šçš„å½±å“ä¸šåŠ¡å¯ç”¨æ€§é—®é¢˜ï¼šä¸€ä¸ªæ˜¯å‰é¢å·²ç»è®¨è®ºè¿‡çš„ç³»ç»Ÿå¯åœé—®é¢˜ï¼Œå¦ä¸€ä¸ªå°±æ˜¯ç½‘ç»œè¿é€šæ€§é—®é¢˜ã€‚ç½‘ç»œä½œä¸ºä¸šåŠ¡ç³»ç»Ÿæ•°æ®äº¤äº’å’Œè½¬å‘çš„ \"é€šé“\"ï¼Œå½±å“ç€ IT ç³»ç»Ÿçš„å„ä¸ªæ–¹é¢ã€‚ç½‘ç»œé—®é¢˜æ¶µç›–çš„å› ç´ ç®€åŒ–æ¥è®²ä¸€èˆ¬æ¶‰åŠåˆ°æ”¶å‘èŠ‚ç‚¹ï¼Œè½¬å‘èŠ‚ç‚¹ï¼Œæµé‡é“¾è·¯ç­‰æ–¹é¢ï¼Œç”±äºæœ¬æ–‡ä¸»è¦åˆ†äº«ç³»ç»Ÿè¯Šæ–­ç›¸å…³çš„å¤„ç†ç»éªŒï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿæ›´å…³æ³¨ä¸ ECS ä¸»æœºå±‚é¢ç›¸å…³çš„ç½‘ç»œå½±å“ï¼Œå¸Œæœ›èƒ½å¸¦ç»™ä¸€äº›å¤„ç†ä¸»æœºå±‚é¢ç½‘ç»œé—®é¢˜çš„ç‚¹æ‹¨ã€‚ 3.1 ifdown ifup å‘½ä»¤ä¸¢å¤±å¤„ç† é—®é¢˜ç°è±¡ ä¸»æœºç½‘ç»œä¸é€šï¼Œç™»å½•ä¸»æœºçœ‹ç½‘å¡æ²¡æœ‰æ­£ç¡®é…ç½®ã€‚ è§£å†³æ–¹æ³• å°è¯•é‡å¯ç½‘å¡ï¼Œå‘ç° ifdown ifup å‘½ä»¤ä¸å­˜åœ¨ï¼š é€šè¿‡ ifconfig é…ç½® IP ä¿¡æ¯ ifconfig netmask ç„¶åæ·»åŠ è·¯ç”± route add -net 0.0.0.0/0 gw å¦‚æœæ˜¯ç»å…¸ç½‘ç»œéœ€è¦é…ç½®ä¸Šå†…å¤–ç½‘å¡ ip å’Œè·¯ç”±ï¼Œè·¯ç”±å‘½ä»¤ route add -net 10.0.0.0/8 gw route add -net 100.64.0.0/10 gw ç½‘ç»œé€šäº†åè¿è¡Œå‘½ä»¤ yum -y install initscripts å®‰è£…ä¸Š ifup ifdown ç›¸å…³çš„åŒ… 3.2 ç½‘ç»œä¸é€šï¼Ÿ strace äºŒåº¦å‡ºæ‰‹ é—®é¢˜ç°è±¡ ä¸»æœºç½‘ç»œä¸é€šï¼Œè·¯ç”±ä¸æ­£ç¡®ï¼Œ0.0.0.0 æŒ‡å‘äº† eth0ã€‚ é—®é¢˜åˆ†æ å°è¯•é‡å¯ network æœåŠ¡ï¼Œå‘ç°ä¸è¡Œã€‚ å°è¯•åœæ­¢ç½‘ç»œæœåŠ¡ï¼Œç„¶åé€šè¿‡ ifup eth1 å‘ç°è·¯ç”±æ˜¯æ­£å¸¸çš„ã€‚ ç„¶å ifup eth0 å‘ç°è·¯ç”±å°±å¼‚å¸¸äº†ï¼ŒåŸºæœ¬å®šä½åœ¨å¯åŠ¨ eth0 ç½‘å¡çš„æ—¶å€™å‡ºç°äº†å¼‚å¸¸ã€‚ ç”¨ strace -f -e open ifup eth0|more è¿½è¸ªä¸€ä¸‹ã€‚ è¿æ°”åŠ çœ¼ç¥æ¯”è¾ƒå¥½ï¼Œå‘ç°è°ƒç”¨äº† /etc/sysconfig/network æ–‡ä»¶ã€‚ æ‰“å¼€ /etc/sysconfig/network æ–‡ä»¶ï¼Œå‘ç°å¤šäº†ä¸€è¡Œ GATEWAYDEV=eth0ã€‚ è§£å†³æ–¹æ¡ˆ æ³¨é‡Š /etc/sysconfig/network æ–‡ä»¶çš„ GATEWAYDEV=eth0ï¼Œé‡å¯ç½‘ç»œæœåŠ¡ã€‚ 3.3 TIME_WAIT & CLOSE_WAIT çš„è®¨è®ºæ€»ç»“ TIME_WAIT æ˜¯ TCP è¿æ¥å…³é—­è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªçŠ¶æ€ï¼Œå…·ä½“æ˜¯è¿™ä¹ˆå½¢æˆçš„ï¼š ä¸»åŠ¨å…³é—­ç«¯ Aï¼šå‘ FINï¼Œè¿›å…¥ FIN-WAIT-1 çŠ¶æ€ï¼Œå¹¶ç­‰å¾… ...... è¢«åŠ¨å…³é—­ç«¯ Pï¼šæ”¶åˆ° FIN åå¿…é¡»ç«‹å³å‘ ACKï¼Œè¿›å…¥ CLOSE_WAIT çŠ¶æ€ï¼Œå¹¶ç­‰ å¾… ...... ä¸»åŠ¨å…³é—­ç«¯ Aï¼šæ”¶åˆ° ACK åè¿›å…¥ FIN-WAIT-2 çŠ¶æ€ï¼Œå¹¶ç­‰å¾… ...... è¢«åŠ¨å…³é—­ç«¯ Pï¼šå‘ FINï¼Œè¿›å…¥ LAST_ACK çŠ¶æ€ï¼Œå¹¶ç­‰å¾… ...... ä¸»åŠ¨å…³é—­ç«¯ Aï¼šæ”¶åˆ° FIN åå¿…é¡»ç«‹å³å‘ ACKï¼Œ è¿›å…¥ TIME_WAIT çŠ¶æ€ï¼Œ ç­‰å¾… 2MSL åç»“æŸ Socketã€‚ è¢«åŠ¨å…³é—­ç«¯ Pï¼šæ”¶åˆ° ACK åç»“æŸ Socketã€‚ 58ã€€ã€€>ã€€TIME_WAIT & CLOSE_WAIT çš„è®¨è®ºæ€»ç»“ å› æ­¤ï¼ŒTIME_WAIT çŠ¶æ€æ˜¯å‡ºç°åœ¨ä¸»åŠ¨å‘èµ·è¿æ¥å…³é—­çš„ä¸€ç‚¹ï¼Œ å’Œæ˜¯è°å‘èµ·çš„è¿æ¥æ— å…³ï¼Œå¯ä»¥æ˜¯ client ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯ server ç«¯ã€‚ è€Œä» TIME_WAIT çŠ¶æ€åˆ° CLOSED çŠ¶ æ€ï¼Œ æœ‰ä¸€ä¸ªè¶…æ—¶è®¾ç½®ï¼Œ è¿™ä¸ªè¶…æ—¶è®¾ç½®æ˜¯ 2*MSLï¼ˆRFC793 å®šä¹‰äº† MSL ä¸º 2 åˆ†é’Ÿï¼ŒLinux è®¾ç½®æˆäº† 30sï¼‰ã€‚ 3.3.1 ä¸ºä»€ä¹ˆéœ€è¦ TIME_WAIT ï¼Ÿ ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š ä¸ºäº†ç¡®ä¿ä¸¤ç«¯èƒ½å®Œå…¨å…³é—­è¿æ¥ã€‚ å‡è®¾ A æœåŠ¡å™¨æ˜¯ä¸»åŠ¨å…³é—­è¿æ¥æ–¹ï¼ŒB æœåŠ¡å™¨æ˜¯è¢«åŠ¨æ–¹ã€‚ å¦‚æœæ²¡æœ‰ TIME_WAIT çŠ¶æ€ï¼ŒA æœåŠ¡å™¨å‘å‡ºæœ€åä¸€ä¸ª ACK å°±è¿›å…¥å…³é—­çŠ¶æ€ï¼Œ å¦‚æœè¿™ä¸ª ACK å¯¹ç«¯æ²¡æœ‰æ”¶åˆ°ï¼Œå¯¹ç«¯å°±ä¸èƒ½å®Œæˆå…³é—­ã€‚å¯¹ç«¯æ²¡æœ‰æ”¶åˆ° ACKï¼Œä¼šé‡å‘ FINï¼Œæ­¤æ—¶è¿æ¥å…³é—­ï¼Œè¿™ä¸ª FIN ä¹Ÿå¾—ä¸åˆ° ACKï¼Œ è€Œæœ‰ TIME_WAITï¼Œ åˆ™ä¼šé‡å‘è¿™ä¸ª ACKï¼Œ ç¡®ä¿å¯¹ç«¯èƒ½æ­£å¸¸å…³é—­è¿æ¥ã€‚ ä¸ºäº†ç¡®ä¿åç»­çš„è¿æ¥ä¸ä¼šæ”¶åˆ°â€œè„æ•°æ®â€ã€‚ åˆšæ‰æåˆ°ä¸»åŠ¨ç«¯è¿›å…¥ TIME_WAIT åï¼Œ ç­‰å¾… 2MSL å CLOSEï¼Œ è¿™é‡Œçš„ MSL æ˜¯æŒ‡ï¼ˆmaximum segment lifetimeï¼Œ æˆ‘ä»¬å†…æ ¸ä¸€èˆ¬æ˜¯ 30sï¼Œ2MSL å°±æ˜¯1åˆ†é’Ÿï¼‰ï¼Œ ç½‘ç»œä¸Šæ•°æ®åŒ…æœ€å¤§çš„ç”Ÿå‘½å‘¨æœŸã€‚ è¿™æ˜¯ä¸ºäº†ä½¿ç½‘ç»œä¸Šç”±äºé‡ä¼ å‡ºç°çš„ old duplicate segment éƒ½æ¶ˆå¤±åï¼Œæ‰èƒ½åˆ›å»ºå‚æ•°ï¼ˆå››å…ƒç»„ï¼Œæº IP/PORTï¼Œç›®æ ‡ IP/ PORTï¼‰ç›¸åŒçš„è¿æ¥ï¼Œå¦‚æœç­‰å¾…æ—¶é—´ä¸å¤Ÿé•¿ï¼Œåˆåˆ›å»ºå¥½äº†ä¸€æ ·çš„è¿æ¥ï¼Œå†æ”¶åˆ° old duplicate segmentï¼Œæ•°æ®å°±é”™ä¹±äº†ã€‚ 3.3.2 TIME_WAIT ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ æ–°å»ºè¿æ¥å¤±è´¥ã€‚ TIME_WAIT åˆ° CLOSEDï¼Œéœ€è¦ 2MSL=60s çš„æ—¶é—´ã€‚è¿™ä¸ªæ—¶é—´éå¸¸é•¿ã€‚æ¯ä¸ªè¿æ¥åœ¨ä¸šåŠ¡ç»“æŸä¹‹åï¼Œéœ€è¦ 60s çš„æ—¶é—´æ‰èƒ½å®Œå…¨é‡Šæ”¾ã€‚ å¦‚æœä¸šåŠ¡ä¸Šé‡‡ç”¨çš„æ˜¯çŸ­è¿æ¥çš„æ–¹å¼ï¼Œä¼šå¯¼è‡´éå¸¸å¤šçš„ TIME_WAIT çŠ¶æ€çš„è¿æ¥ï¼Œä¼šå ç”¨ä¸€äº›èµ„æºï¼Œä¸»è¦æ˜¯æœ¬åœ°ç«¯å£èµ„æºã€‚ ä¸€å°æœåŠ¡å™¨çš„æœ¬åœ°å¯ç”¨ç«¯å£æ˜¯æœ‰é™çš„ï¼Œä¹Ÿå°±å‡ ä¸‡ä¸ªç«¯å£ï¼Œç”±è¿™ä¸ªå‚æ•°æ§åˆ¶ï¼š sysctl net.ipv4.ip_local_port_range net.ipv4.ip_local_port_range = 32768 61000 å½“æœåŠ¡å™¨å­˜åœ¨éå¸¸å¤šçš„ TIME_WAIT è¿æ¥ï¼Œ å°†æœ¬åœ°ç«¯å£éƒ½å ç”¨äº†ï¼Œ å°±ä¸èƒ½ä¸»åŠ¨å‘èµ·æ–°çš„è¿æ¥å»è¿å…¶ä»–æœåŠ¡å™¨äº†ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæ˜¯ä¸»åŠ¨å‘èµ·è¿æ¥ï¼Œåˆæ˜¯ä¸»åŠ¨å‘èµ·å…³é—­çš„ä¸€æ–¹æ‰ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚ å¦‚æœæ˜¯ server ç«¯ä¸»åŠ¨å…³é—­ client ç«¯å»ºç«‹çš„è¿æ¥äº§ç”Ÿäº†å¤§é‡çš„ TIME_WAIT è¿æ¥ï¼Œè¿™æ˜¯ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜çš„ã€‚é™¤éæ˜¯å…¶ä¸­æ¶‰åŠåˆ°çš„æŸä¸ªå®¢æˆ·ç«¯çš„ TIME_WAIT è¿æ¥éƒ½æœ‰å¥½å‡ ä¸‡ä¸ªäº†ã€‚ TIME_WAIT æ¡ç›®è¶…å‡ºé™åˆ¶ã€‚ è¿™ä¸ªé™åˆ¶ï¼Œæ˜¯ç”±ä¸€ä¸ªå†…æ ¸å‚æ•°æ§åˆ¶çš„ï¼š sysctl net.ipv4.tcp_max_tw_buckets net.ipv4.tcp_max_tw_buckets = 5000 è¶…å‡ºäº†è¿™ä¸ªé™åˆ¶ä¼šæŠ¥ä¸€æ¡ INFO çº§åˆ«çš„å†…æ ¸æ—¥å¿—ï¼Œç„¶åç»§ç»­å…³é—­æ‰è¿æ¥ã€‚å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«å¤§çš„å½±å“ï¼Œåªæ˜¯å¢åŠ äº†åˆšæ‰æåˆ°çš„æ”¶åˆ°è„æ•°æ®çš„é£é™©è€Œå·²ã€‚ å¦å¤–çš„é£é™©å°±æ˜¯ï¼Œå…³é—­æ‰ TIME_WAIT è¿æ¥åï¼Œåˆšåˆšå‘å‡ºçš„ ACK å¦‚æœå¯¹ç«¯æ²¡æœ‰æ”¶åˆ°ï¼Œ é‡å‘ FIN åŒ…å‡ºæ¥æ—¶ï¼Œä¸èƒ½æ­£ç¡®å›å¤ ACKï¼Œåªæ˜¯å›å¤ä¸€ä¸ª RST åŒ…ï¼Œ å¯¼è‡´å¯¹ç«¯ç¨‹åºæŠ¥é”™ï¼Œè¯´ connection resetã€‚ å› æ­¤ net.ipv4.tcp_max_tw_buckets è¿™ä¸ªå‚æ•°æ˜¯å»ºè®®ä¸è¦æ”¹å°çš„ï¼Œæ”¹å°ä¼šå¸¦æ¥é£é™©ï¼Œæ²¡æœ‰ä»€ä¹ˆæ”¶ç›Šï¼Œåªæ˜¯è¡¨é¢ä¸Šé€šè¿‡ netstat çœ‹åˆ°çš„ TIME_WAIT å°‘äº†äº›è€Œå·²ï¼Œæœ‰å•¥ç”¨å‘¢ï¼Ÿå¹¶ä¸”ï¼Œå»ºè®®æ˜¯å½“é‡åˆ°æ¡ç›®ä¸å¤Ÿï¼Œå¢åŠ è¿™ä¸ªå€¼ï¼Œä»…ä»…æ˜¯æµªè´¹ä¸€ç‚¹ç‚¹å†…å­˜è€Œå·²ã€‚ 3.3.3 å¦‚ä½•è§£å†³ time_wait? 1ï¼‰æœ€ä½³æ–¹æ¡ˆæ˜¯åº”ç”¨æ”¹é€ é•¿è¿æ¥ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸å¤ªé€‚ç”¨ã€‚ 2ï¼‰ä¿®æ”¹ç³»ç»Ÿå›æ”¶å‚æ•°ã€‚è®¾ç½®ä»¥ä¸‹å‚æ•°ã€‚ net.ipv4.tcp_timestamps = 1 net.ipv4.tcp_tw_recycle = 1 è®¾ç½®è¯¥å‚æ•°ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ å¦‚æœè¿™ä¸¤ä¸ªå‚æ•°åŒæ—¶å¼€å¯ï¼Œ ä¼šæ ¡éªŒæº ip è¿‡æ¥çš„åŒ…æºå¸¦çš„ timestamp æ˜¯å¦é€’å¢ï¼Œ å¦‚æœä¸æ˜¯é€’å¢çš„è¯ï¼Œåˆ™ä¼šå¯¼è‡´ä¸‰æ¬¡æ¡æ‰‹å»ºè”ä¸æˆåŠŸï¼Œå…·ä½“è¡¨ç°ä¸ºæŠ“åŒ…çš„æ—¶å€™çœ‹åˆ° syn å‘å‡ºï¼Œserver ç«¯ä¸å“åº” syn ackã€‚ é€šä¿—ä¸€äº›æ¥è®²å°±æ˜¯ï¼Œä¸€ä¸ªå±€åŸŸç½‘æœ‰å¤šä¸ªå®¢æˆ·ç«¯è®¿é—®æ‚¨ï¼Œå¦‚æœæœ‰å®¢æˆ·ç«¯çš„æ—¶é—´æ¯”åˆ«çš„å®¢æˆ·ç«¯æ—¶é—´æ…¢ï¼Œå°±ä¼šå»ºè”ä¸æˆåŠŸã€‚ æ²»æ ‡ä¸æ²»æœ¬çš„æ–¹å¼ï¼š æ”¾å¤§ç«¯å£èŒƒå›´ã€‚ sysctl net.ipv4.ip_local_port_range net.ipv4.ip_local_port_range = 32768 61000 æ”¾å¤§ time_wait çš„ buckets sysctl net.ipv4.tcp_max_tw_buckets net.ipv4.tcp_max_tw_buckets = 180000 å…³äº net.ipv4.tcp_max_tw_buckets åˆ°åº•è¦ä¸è¦æ”¾å¤§ï¼Œç›®å‰äº‘ä¸Š ecs å¤šæ•°æ˜¯è®¾ç½®äº† 5000ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹å¯èƒ½æ˜¯ä¸å¤Ÿçš„ã€‚ ç®€å•æ¥è¯´ net.ipv4.tcp_max_tw_buckets çš„ä½œç”¨æ˜¯ä¸ºäº† \"ä¼˜é›…\" çš„å…³é—­è¿æ¥ã€‚ å®Œæ•´çš„å…³é—­è¿æ¥ã€‚ é¿å…æœ‰æ•°æ®åŒ…é‡å¤ã€‚ 3.3.4 å¦‚æœ tw æ»¡äº†ä¼šæ€ä¹ˆæ · TCP: time wait bucket table overflowã€‚ æ–°å†…æ ¸ tw_bucket æ»¡äº†çš„è¯ï¼Œ ä¼šå½±å“ established çŠ¶æ€çš„è¿æ¥åœ¨ finack çš„æ—¶å€™ç›´æ¥è¿›å…¥ closed çŠ¶æ€ã€‚ è€å†…æ ¸ tw_bucket æ»¡äº†çš„è¯ï¼Œä¼šå°† tw_bucket é‡Œé¢çš„ time_wait æŒ‰ç…§ä¸€å®šçš„è§„åˆ™ï¼ˆå¦‚ LRUï¼‰ï¼Œå°†ä¸€æ‰¹ time_Wait ç›´æ¥è¿›å…¥ closed çŠ¶æ€ ï¼Œç„¶å established çŠ¶æ€å‘é€ finack åè¿› å…¥ time_waitã€‚ 3.3.5 tw çš„å¼€é”€æ˜¯ä»€ä¹ˆ ç‰¹åˆ«å°‘é‡çš„å†…å­˜ã€‚ å ç”¨æœ¬åœ°ç«¯å£ã€‚ 3.3.6 tw æ”¾å¤§çš„å¥½ä¸å æ”¾å¤§çš„è¯éœ€è¦æ›´å¤šçš„å†…å­˜å¼€é”€ï¼Œä½†æ˜¯å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ å ç”¨æ›´å¤šçš„æœ¬åœ°ç«¯å£ï¼Œéœ€è¦é€‚å½“çš„æ”¾å¤§æœ¬åœ°ç«¯å£èŒƒå›´ï¼Œ ç«¯å£èŒƒå›´ç»è¿‡ç®€å•çš„æµ‹è¯•ï¼Œå»ºè®®è®¾ç½®ä¸º tw çš„ 1.5 å€ã€‚net.ipv4.ip_local_port_range netstat å¤§é‡çš„æ‰«æ socket çš„æ—¶å€™ï¼ˆss ä¸ä¼šæ‰«æï¼Œ ä½†æ˜¯ ss åœ¨ slab å†…å­˜ç‰¹åˆ«é«˜ çš„æ—¶å€™ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šå¼•èµ·æŠ–åŠ¨ï¼‰ï¼Œæç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šå¼•èµ·æ€§èƒ½æŠ–åŠ¨ã€‚ tw æ”¾å¤§ï¼Œlocal_port_range æ”¾å¤§ï¼Œè¿˜å¯ä»¥é…ç½®å¤ç”¨ä»¥åŠå¿«é€Ÿå›æ”¶ç­‰å‚æ•°ã€‚ ä½¿ç”¨å¿«é€Ÿå›æ”¶å¯èƒ½ä¼šå¯¼è‡´ snat æ—¶é—´æˆ³é€’å¢æ ¡éªŒé—®é¢˜ï¼Œä¸é€’å¢çš„è¯ syn ä¸å“åº”ã€‚ ç‰¹æ®Šåœºæ™¯çš„æ—¶å€™ï¼ˆæœ¬æœºä¼šå‘èµ·å¤§é‡çŸ­é“¾æ¥çš„æ—¶å€™ï¼‰ã€‚ nginx ç»“åˆ php-fpm éœ€è¦æœ¬åœ°èµ·ç«¯å£ã€‚ nginx åä»£å¦‚ï¼ˆjavaï¼Œå®¹å™¨ç­‰ï¼‰ã€‚ tcp_tw_reuse å‚æ•°éœ€è¦ç»“åˆ net.ipv4.tcp_timestamps = 1 ä¸€èµ·æ¥ç”¨ã€‚ å³æœåŠ¡å™¨å³åšå®¢æˆ·ç«¯ï¼Œä¹Ÿåš server ç«¯çš„æ—¶å€™ã€‚ tcptw_reuse å‚æ•°ç”¨æ¥è®¾ç½®æ˜¯å¦å¯ä»¥åœ¨æ–°çš„è¿æ¥ä¸­é‡ç”¨ TIME_WAIT çŠ¶æ€çš„å¥—æ¥å­—ã€‚ æ³¨æ„ï¼Œ é‡ç”¨çš„æ˜¯ TIME_WAIT å¥—æ¥å­—å ç”¨çš„ç«¯å£å·ï¼Œ è€Œä¸æ˜¯ TIME_WAIT å¥—æ¥å­—çš„å†…å­˜ç­‰ã€‚è¿™ä¸ªå‚æ•°å¯¹å®¢æˆ·ç«¯æœ‰æ„ä¹‰ï¼Œåœ¨ä¸»åŠ¨å‘èµ·è¿æ¥çš„æ—¶å€™ä¼šåœ¨è°ƒç”¨çš„ inet hash_connect() ä¸­ä¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥é‡ç”¨ TIME_WAIT çŠ¶æ€çš„å¥—æ¥å­—ã€‚å¦‚æœä½ åœ¨æœåŠ¡å™¨æ®µè®¾ç½®è¿™ä¸ªå‚æ•°çš„è¯ï¼Œåˆ™æ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼Œå› ä¸ºæœåŠ¡å™¨ç«¯ ESTABLISHED çŠ¶æ€çš„å¥— æ¥å­—å’Œç›‘å¬å¥—æ¥å­—çš„æœ¬åœ° IPã€ç«¯å£å·æ˜¯ç›¸åŒçš„ï¼Œæ²¡æœ‰é‡ç”¨çš„æ¦‚å¿µã€‚ä½†å¹¶ä¸æ˜¯è¯´æœåŠ¡å™¨ç«¯å°±æ²¡æœ‰ TIME_WAIT çŠ¶æ€å¥—æ¥å­—ã€‚ å› æ­¤è¯¥ç±»åœºæ™¯æœ€ç»ˆå»ºè®®æ˜¯ï¼š net.ipv4.tcp_tw_recycle = 0 å…³æ‰å¿«é€Ÿå›æ”¶ net.ipv4.tcp_tw_reuse = 1 å¼€å¯ tw çŠ¶æ€çš„ç«¯å£å¤ç”¨ï¼ˆå®¢æˆ·ç«¯è§’è‰²ï¼‰ net.ipv4.tcp_timestamps = 1 å¤ç”¨éœ€è¦ timestamp æ ¡éªŒä¸º 1 net.ipv4.tcp_max_tw_buckets = 30000 æ”¾å¤§ bucket net.ipv4.ip_local_port_range = 15000 65000 æ”¾å¤§æœ¬åœ°ç«¯å£èŒƒå›´ å†…å­˜å¼€é”€æµ‹è¯•ã€‚ # ss -s Total: 15254 (kernel 15288) TCP: 15169 (estab 5ï¼Œclosed 15158ï¼Œorphaned 0ï¼Œsynrecv 0ï¼Œtimewait 3/0)ï¼Œports 0 Transport Total IP IPv6 * 15288 - - RAW 0 0 0 UDP 5 4 1 TCP 11 11 0 INET 16 15 1 FRAG 0 0 0 15000ä¸ªsocketæ¶ˆè€—30å¤šmå†…å­˜ 3.3.7 å…³äºCLOSE_WAIT å¦‚ä¸Šæ‰€ç¤ºï¼ŒCLOSE_WAIT çš„çŠ¶æ€æ˜¯ æœåŠ¡å™¨ç«¯ / å®¢æˆ·ç«¯ç¨‹åºæ”¶åˆ°å¤–éƒ¨è¿‡æ¥çš„ FIN ä¹‹ åï¼Œå“åº”äº† ACK åŒ…ï¼Œä¹‹åå°±è¿›å…¥äº† CLOSE_WAIT çŠ¶æ€ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œç¨åæœåŠ¡å™¨ç«¯ / å®¢æˆ·ç«¯ç¨‹åºéœ€è¦å‘å‡º FIN åŒ…ï¼Œè¿›è€Œè¿ç§»åˆ° LAST_ACK çŠ¶æ€ï¼Œæ”¶åˆ°å¯¹ç«¯è¿‡æ¥çš„ ACK åï¼Œå®Œæˆ TCP è¿æ¥å…³é—­çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ âš ï¸ä¸ç®¡æ˜¯æœåŠ¡å™¨è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œ åªè¦æ˜¯è¢«åŠ¨æ¥æ”¶ç¬¬ä¸€ä¸ª FIN çš„é‚£ä¸€æ–¹æ‰ä¼šè¿›å…¥ CLOSE_WAIT çŠ¶æ€ã€‚ 3.4 ä¸€æ¬¡ç½‘ç»œæŠ–åŠ¨ç»å…¸æ¡ˆä¾‹åˆ†æ ç®€ä»‹ï¼š æœ¬æ–‡è®°å½•çš„æ˜¯ä¸€æ¬¡å¤šå›¢é˜Ÿåä½œå¤„ç†çš„æŠ–åŠ¨é—®é¢˜çš„è¿‡ç¨‹ï¼Œç”±äºç”¨æˆ·çš„æ‰§ç€ï¼Œä¹Ÿå¾—æˆ‘ä»¬åœ¨è¿™ä¸ªæ¡ˆä¾‹åˆ†æå¾—è¾ƒä¸ºæ·±å…¥ï¼Œå¸Œæœ›å¯¹å¤§å®¶ä»Šåçš„æ­¤ç±»æ¡ˆä¾‹çš„å¤„ç†æœ‰æ‰€å¯å‘ã€‚ è§†é¢‘å­¦ä¹  æ€§èƒ½æŠ–åŠ¨å‰–æ(ä¸€) æ€§èƒ½æŠ–åŠ¨å‰–æ(äºŒ) æ€§èƒ½æŠ–åŠ¨å‰–æ(ä¸‰) ç½‘ç»œæŠ–åŠ¨æ¡ˆä¾‹æ˜¯ä¸€ç±»å¤„ç†éš¾åº¦è¾ƒå¤§çš„é—®é¢˜ï¼ŒåŸå› ä¸»è¦æ˜¯å¾ˆå¤šæŠ–åŠ¨å‘ç”Ÿçš„é¢‘ç‡ä¸é«˜ï¼Œä¸”æŒç»­æ—¶é—´éå¸¸çŸ­æé™æƒ…å†µå¯èƒ½ä»…æœ‰ 100ms ä»¥ä¸‹ï¼Œè€Œå¾ˆå¤šç”¨æˆ·çš„ä¸šåŠ¡åº”ç”¨å¯¹å®æ—¶æ€§è¦æ±‚éå¸¸é«˜ï¼Œå› æ­¤å¯¹æ­¤ç±»åœ¨ç™¾æ¯«ç§’çš„å»¶è¿Ÿä¹Ÿä¼šéå¸¸æ•æ„Ÿã€‚æœ¬æ–‡è®°å½•çš„æ˜¯ä¸€æ¬¡å¤šå›¢é˜Ÿåä½œå¤„ç†çš„æŠ–åŠ¨é—®é¢˜çš„è¿‡ç¨‹ï¼Œç”±äºç”¨æˆ·çš„æ‰§ç€ï¼Œä¹Ÿä½¿å¾—æˆ‘ä»¬åœ¨è¿™ä¸ªæ¡ˆä¾‹åˆ†æå¾—è¾ƒä¸ºæ·±å…¥ï¼Œå¸Œæœ›å¯¹å¤§å®¶ä»Šåçš„æ­¤ç±»æ¡ˆä¾‹çš„å¤„ç†æœ‰æ‰€å¯å‘ã€‚ é—®é¢˜ç°è±¡ è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é—®é¢˜ç°è±¡å§ï¼Œç”¨æˆ·çš„åº”ç”¨æ—¥å¿—è®°å½•äº†ç™¾æ¯«ç§’ç”šè‡³ 1-2 ç§’çº§åˆ«çš„å»¶è¿Ÿï¼Œ è€Œä¸”å‘ç”Ÿè¾ƒä¸ºé¢‘ç¹ï¼Œç”±äºä¸šåŠ¡çš„å®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼Œå› æ­¤å¯¹ä¸šåŠ¡çš„å½±å“è¾ƒå¤§ï¼Œå½“ç„¶å…¶ä¸­ä¹Ÿå½±å“åˆ°äº†ç”¨æˆ·å¯¹è¿äº‘çš„ä¿¡å¿ƒã€‚ åˆæ­¥æ’æŸ¥ åœ¨ç”¨æˆ·é€šè¿‡åº”ç”¨å±‚é¢çš„æ’æŸ¥æ€€ç–‘é—®é¢˜æ¥æºäºè™šæ‹Ÿç½‘ç»œç¯å¢ƒçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ ä»¶äº‹å°±æ˜¯é¦–å…ˆè¦å°†é—®é¢˜ç®€å•åŒ–ã€‚è¿™ä¸€æ­¥æ˜¯éå¸¸å¿…è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯¹ç”¨æˆ·çš„åº”ç”¨ä¸å¯èƒ½æœ‰éå¸¸æ·±å…¥çš„äº†è§£ï¼Œæ‰€ä»¥ç”¨æˆ·çš„åº”ç”¨æ—¥å¿—å…·ä½“å«ä¹‰å’Œè®°å½•æ–¹å¼å¯¹æˆ‘ä»¬æ¥è¯´æ›´åƒé»‘ç›’ã€‚ æˆ‘ä»¬æ‰€è¦åšçš„æ˜¯å°†é—®é¢˜ç°è±¡è½¬ç§»åˆ°æˆ‘ä»¬å¸¸è§çš„ç³»ç»Ÿç»„ä»¶ä¸Šæ¥ï¼Œæ¯”å¦‚ç®€å•åˆ° pingã€‚æ‰€ä»¥æˆ‘ä»¬ç¬¬ä¸€ä»¶æ‰€åšçš„äº‹æƒ…å°±æ˜¯ç¼–å†™è„šæœ¬è¿›è¡Œä¸¤å°æœºå™¨çš„å†…ç½‘äº’ pingï¼Œå¹¶å°†æ¯æ¬¡ ping çš„å»¶è¿Ÿè®°å½•åˆ°æ–‡ä»¶ã€‚é€‰æ‹© ping å½“ç„¶ä¹Ÿæ˜¯ç”±äº ping çš„é—´éš”æ˜¯å¯ä»¥è®¾ç½®åˆ°ç™¾æ¯«ç§’çš„ï¼Œæ¯”è¾ƒå®¹æ˜“è¯´æ˜é—®é¢˜ã€‚ åœ¨äº’ ping çš„æµ‹è¯•ä¸­æˆ‘ä»¬ç¡®å®å‘ç°æœ‰ç™¾æ¯«ç§’ä»¥ä¸Šçš„å»¶è¿Ÿï¼Œé‚£ä¹ˆéšåæˆ‘ä»¬ä¸ºäº†æ’é™¤ç‰©ç†ç½‘ç»œçš„å½±å“ï¼Œé€‰æ‹©ä¸€å°æœºå™¨è¿›è¡Œå¯¹ç½‘å…³çš„ ping æµ‹è¯•ï¼ŒåŒæ ·å‘ç°äº†ç±»ä¼¼çš„å»¶è¿Ÿï¼š æ¥çœ‹çœ‹ä¸Šé¢çš„ ping æµ‹è¯•ç»“æœå§ï¼Œåˆçœ‹ä¹Ÿä»…ä»…æ˜¯ä¸€äº›ç™¾æ¯«ç§’å»¶è¿Ÿçš„é›†ä¸­å‘ç”Ÿè€Œå·²ï¼Œä½†æ˜¯ä»”ç»†è§‚å¯Ÿå°±ä¼šå‘ç°æ¯æ¬¡å‘ç”Ÿéƒ½æœ‰è¿™æ ·çš„æƒ…å†µï¼Œå°±æ˜¯å»¶è¿Ÿåœ¨ä¸€ç»„è¿ç»­çš„ ping ä¸Šå‘ç”Ÿçš„ï¼Œå¹¶ä¸”å»¶è¿Ÿæ˜¯å€’åºæ’åˆ—çš„ã€‚é‚£ä¹ˆè¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿ åˆ†æä¸€ é€šè¿‡ä»¥ä¸Šçš„ ping æµ‹è¯•æˆ‘ä»¬æŠŠé—®é¢˜ç®€å•åŒ–åˆ°äº† ping ç½‘å…³å»¶è¿Ÿä¸Šï¼Œä½†æ˜¯ä¸Šé¢å¦‚æ­¤è§„å¾‹çš„æµ‹è¯•ç»“æœçš„å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆã€‚é¦–å…ˆä»–æ„å‘³ç€å¹¶æ²¡æœ‰ä¸¢åŒ…å‘ç”Ÿï¼Œæ‰€ä»¥çš„ ICMP è¯·æ±‚éƒ½è¢«ç³»ç»Ÿå‘å‡ºå¹¶ä¸”æ”¶åˆ°å›å¤ï¼Œä½†æ˜¯è¿™æ ·çš„å€’åºæ’åˆ—ï¼Œæ›´åƒæ˜¯åœ¨é—®é¢˜æ—¶é—´æ®µå†…æ‰€æœ‰çš„å›å¤éƒ½æ²¡æœ‰è¢«ç¬¬ä¸€æ—¶é—´å¤„ç†ï¼Œè€Œæ˜¯çªç„¶åœ¨ 800ms ä¹‹åç³»ç»Ÿå¤„ç†äº†æ‰€æœ‰ä¹‹å‰å‘ç”Ÿå›å¤ï¼Œå› æ­¤æ‰ä¼šäº§ç”Ÿè¿™æ ·çš„ç°è±¡ã€‚é‚£ä¹ˆæˆ‘ä»¬æ­¤æ—¶å¯ä»¥æœ‰ä¸€ä¸ªå‡è®¾ï¼Œåœ¨è¿™ 800ms ä¹‹å‰ç³»ç»Ÿåœæ­¢äº†å¯¹ç½‘ç»œåŒ…çš„å¤„ç†ã€‚é‚£ä¹ˆä»€ä¹ˆæ ·çš„æƒ…å†µä¼šå¯¼è‡´ç³»ç»Ÿåœæ­¢å¯¹ç½‘ç»œåŒ…çš„å¤„ç†å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯ä¸­æ–­ç¦ç”¨ï¼Œç¡¬ä»¶ä¸­æ–­æ˜¯ç³»ç»Ÿå¤„ç†ç½‘ç»œåŒ…çš„ç¬¬ä¸€ä¹Ÿæ˜¯å¿…é¡»æ­¥éª¤ï¼Œä¸­æ–­ç¦ç”¨ä¼šå¯¼è‡´ç³»ç»Ÿçš„è½¯ä¸­æ–­å’Œä¸­æ–­éƒ½ä¸èƒ½åœ¨ CPU ä¸Šå‘ç”Ÿï¼Œä»è€Œä½¿å¾—å½“å‰åœ¨ CPU ä¸Šè¿è¡Œçš„æŒ‡ä»¤æ˜¯æ— æ³•è¢«æ‰“æ–­çš„ï¼Œè¿™ç»å¸¸è¢«ç”¨äºä¸€äº›å¯èƒ½å­˜åœ¨ç«äº‰é£é™©çš„å†…æ ¸ä»£ç ç‰‡æ®µä¸Šï¼Œè¿™äº›ä»£ç ç‰‡æ®µå¯èƒ½ä¼šå› ä¸ºè¢«ä¸­æ–­æ‰“æ–­è€Œå¯¼è‡´æ•°æ®ä¸åŒæ­¥ç”šè‡³æŸåã€‚ åœ¨å½“æ—¶æˆ‘ä»¬å†…æ ¸å›¢é˜Ÿç”šè‡³é€šè¿‡ç¼–å†™ç¤ºä¾‹é©±åŠ¨ï¼Œé€šè¿‡è®°å½• timer å‡½æ•°åœ¨ä¸€æ®µæ—¶é—´å†…æœªèƒ½è§¦å‘æ¥éªŒè¯äº†ä¸­æ–­ç¦ç”¨çš„å‘ç”Ÿã€‚é‚£ä¹ˆåºå¤§çš„å†…æ ¸ä»£ç ä¸­ç©¶ç«Ÿæ˜¯å“ªä¸€éƒ¨åˆ†çš„ä»£ç å¯¼è‡´äº†è¿™æ ·çš„é—®é¢˜å‘¢ï¼Ÿ åˆ†æäºŒ åœ¨è¿™æ®µåˆ†æè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åšäº†å¤§é‡å®éªŒï¼Œæ¯”å¦‚é€šè¿‡ç¼–å†™å†…æ ¸é©±åŠ¨æ¥ç¦ç”¨ä¸­æ–­ï¼Œæµ‹è¯•å„ç±»å†…æ ¸è¿½è¸ªæ–¹æ³•æ˜¯å¦èƒ½è·å¾—æ›´è¿›ä¸€æ­¥çš„ä¿¡æ¯ï¼Œå¦‚ç¦ç”¨ä¸­æ–­çš„å †æ ˆï¼Œä½†æ˜¯å¾ˆå¯æƒœï¼Œç›®å‰å°šæ— å¾ˆå¥½çš„æ–¹æ³•åœ¨ä¸å½±å“ä¸šåŠ¡çš„æƒ…å†µä¸‹è¾ƒè½»é‡çº§åœ°è·å¾—ç¦ç”¨ä¸­æ–­æ—¶çš„å†…æ ¸å †æ ˆï¼ŒåŸç†ä¹Ÿå¾ˆç®€å•ï¼Œç¡¬ä»¶ä¸­æ–­æœ¬èº«ä¼˜å…ˆçº§è¦é«˜äºä¸€èˆ¬è¿›ç¨‹å’Œè½¯ä¸­æ–­ï¼Œåœ¨å…¶è¢«ç¦ç”¨ä¹‹åè‡ªç„¶æ™®é€š è½¯ä»¶å±‚é¢çš„è¿½è¸ªæ–¹æ³•ä¹Ÿä¸èµ·ä½œç”¨äº†ã€‚ ç„¶è€Œé—®é¢˜å°±éšè—åœ¨ä¸€ç±»ç³»ç»Ÿçš„å†…å­˜èµ„æºä¸Šï¼Œå³ç³»ç»Ÿçš„ slab å ç”¨é‡ç›¸æ¯”æ­£å¸¸ç³»ç»Ÿè¦é«˜å‡ºä¸å°‘ï¼š æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­ dentry åœ¨ slab ä¸­çš„å ç”¨é‡è¾¾åˆ°äº†éå¸¸é«˜çš„ç¨‹åº¦ï¼Œdentry æ˜¯å†…å­˜ä¸­è¡¨ç¤ºç›®å½•å’Œæ–‡ä»¶çš„å¯¹è±¡ï¼Œä½œä¸ºä¸ inode çš„é“¾æ¥å­˜åœ¨ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹å¦‚æ­¤é«˜æ•°å­—çš„ dentry é¡¹å¯èƒ½ä»£è¡¨è¿™ç³»ç»Ÿæœ‰å¤§é‡è¢«æ‰“å¼€çš„æ–‡ä»¶ã€‚ ç„¶è€Œæ­¤æ—¶æˆ‘ä»¬é¦–å…ˆéœ€è¦è§£é‡Šå¤§é‡çš„ dentry é¡¹ä¸ç¦ç”¨ä¸­æ–­çš„å…³ç³»ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ 2.6 å†…æ ¸çš„è¿™ä¸€æ®µä»£ç ï¼š è¿™æ˜¯ä¸€æ®µè®¡ç®— slab æ€»é‡çš„ä»£ç ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å®ƒæ˜¯ä»¥éå†é“¾è¡¨çš„æ–¹å¼æ¥ç»Ÿè®¡ slab æ€»é‡çš„ï¼Œè€Œåœ¨è¿›å…¥é“¾è¡¨ä¹‹å‰è°ƒç”¨äº† spin_lock_irq å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®ç°ï¼š static inline void __spin_lock_irq(spinlock_t *lock) { local_irq_disable(); äºæ˜¯æˆ‘ä»¬å¯ä»¥ç¡®è®¤åœ¨ç»Ÿè®¡ slab ä¿¡æ¯çš„æ—¶å€™ï¼Œç³»ç»Ÿçš„è¡Œä¸ºæ˜¯é¦–å…ˆç¦ç”¨ä¸­æ–­ï¼Œç„¶åéå†é“¾è¡¨ç»Ÿè®¡ slabï¼Œæœ€åå†æ¬¡å¯ç”¨ä¸­æ–­ã€‚é‚£ä¹ˆæ•´ä¸ªç¦ç”¨ä¸­æ–­çš„æ—¶é—´å°†å–å†³äºé“¾è¡¨ä¸­å¯¹è±¡çš„ ä¸ªæ•°ï¼Œå¦‚æœå…¶å¯¹è±¡æ•°é‡æƒŠäººï¼Œå¾ˆå¯èƒ½å°±ä¼šå¯¼è‡´ç¦ç”¨ä¸­æ–­æ—¶é—´è¿‡é•¿ã€‚ éªŒè¯é—®é¢˜ä¹Ÿéå¸¸ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥ä¸»åŠ¨è¿è¡Œ cat /proc/slabinfo åœ¨è·å– slab ä¿¡æ¯ï¼Œé‚£ä¹ˆ ä»¥ä¸Šå‡½æ•°ä¹Ÿå°†ä¼šè¢«è°ƒç”¨ï¼ŒåŒæ—¶è§‚å¯Ÿ ping æµ‹è¯•è¾“å‡ºç¬¦åˆä»¥ä¸Šé—®é¢˜ç‚¹çš„æƒ…å†µï¼Œå³å¯ä»¥å¤§è‡´ç¡®è®¤é—®é¢˜åŸå› äº†ã€‚ æ­¤æ—¶æˆ‘ä»¬å·²ç»æœ‰äº†å¯ä»¥æš‚æ—¶ç¼“è§£é—®é¢˜çš„æ–¹æ³•äº†ï¼Œå¯¹ dentry é¡¹æ˜¯ä½œä¸ºæ–‡ä»¶ç³»ç»Ÿç¼“å­˜çš„ ä¸€éƒ¨åˆ†å­˜åœ¨çš„ï¼Œä¹Ÿå°±æ˜¯çœŸæ­£çš„æ–‡ä»¶ä¿¡æ¯æ˜¯å­˜æ”¾äºç£ç›˜ä¸Šçš„ï¼Œdentry åªä¸è¿‡æ˜¯åœ¨ç³»ç»Ÿæ‰“å¼€æ–‡ä»¶ç³»ç»Ÿç¼“å­˜åœ¨å†…å­˜ä¸­çš„å¯¹è±¡è€Œå·²ï¼Œå³ä½¿ç¼“å­˜è¢«æ¸…ç©ºï¼Œæœªæ¥ç³»ç»Ÿä¸€æ ·å¯ä»¥é€šè¿‡è¯»å–ç£ç›˜æ–‡ä»¶æ¥é‡æ–°ç”Ÿæˆ dentry ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ç±»ä¼¼ echo 2 > /proc/sys/vm/ drop_caches && sync çš„æ–¹å¼æ¥é‡Šæ”¾ç¼“å­˜ï¼Œç¼“è§£é—®é¢˜ã€‚ ä½†æ˜¯å…¶å®äº‹æƒ…è¿œè¿œæ²¡æœ‰å°±æ­¤ç»“æŸï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸¤ä¸ªå…³é”®æ€§çš„é—®é¢˜ï¼š æ˜¯ä»€ä¹ˆç¨‹åºåœ¨åå¤åœ°è·å– slab ä¿¡æ¯ï¼Œäº§ç”Ÿç±»ä¼¼ cat /proc/slabinfo çš„æ•ˆæœã€‚ è¿™ä¹ˆå¤š dentry ç”Ÿæˆçš„åŸå› æ˜¯ä»€ä¹ˆã€‚ å¦‚æœä¸çŸ¥é“è¿™ä¸¤ç‚¹è¿™ä¸ªé—®é¢˜éšæ—¶å¯èƒ½ä¼šå¤ç°ã€‚è€Œå‘¨æœŸæ€§åœ° drop cache å¹¶ä¸æ˜¯ä¸€ä¸ªé•¿ä¹…æ ¹æ²»çš„æ–¹æ¡ˆã€‚ çœ‹åˆ°è¿™é‡Œï¼Œè¿™ä¸ªç¼“å­˜é—®é¢˜çš„å¤„ç†æ˜¯ä¸æ˜¯åœ¨å“ªå„¿è§è¿‡ï¼Ÿå¯¹çš„ï¼Œåœ¨ç³»ç»Ÿæ€§èƒ½åˆ†æé‚£ä¸€ç« èŠ‚æˆ‘ä»¬ä¹Ÿæåˆ°ç›¸ä¼¼çš„é—®é¢˜ï¼Œå»ºè®®å†å¾€å‰å›é¡¾ä¸€ä¸‹å¿ƒä¸­åº”è¯¥å°±å·®ä¸å¤šæœ‰ç­”æ¡ˆäº†ã€‚ å››ã€Linux ç³»ç»ŸæœåŠ¡ä¸å‚æ•°é—®é¢˜ è‡³æ­¤ï¼Œæˆ‘ä»¬åˆ†äº«äº†å…³äºç³»ç»Ÿå¯åŠ¨ç™»å½•ã€æ€§èƒ½ã€ç½‘ç»œç­‰ä¸‰ä¸ªæ–¹é¢é‡åˆ°çš„ä¸€äº›ç»å…¸å’Œæœ‰è¶£æ¡ˆä¾‹ï¼Œè€Œè¿™ä¸‰ä¸ªæ–¹é¢ä¹ŸåŸºæœ¬æ¶µç›–äº†ç›®å‰æˆ‘ä»¬é‡åˆ°çš„å¤§éƒ¨åˆ†çš„ç³»ç»Ÿæ•…éšœé—®é¢˜ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç±»ç³»ç»ŸæœåŠ¡å‚æ•°é—®é¢˜åœ¨æˆ‘ä»¬å¤„ç†çš„æ¡ˆä¾‹ä¸­ä¹Ÿå±¡è§ä¸é²œã€‚é˜¿é‡Œäº‘ç»“åˆå¤šå¹´äº‘ä¸Š ECS è¿ç»´ç»éªŒå’Œç”¨æˆ·ä¸šåŠ¡åé¦ˆï¼Œä¸æ–­ä¼˜åŒ– ECS ç³»ç»Ÿé•œåƒä»¥æœ€å¤§åŒ–å‘æŒ¥ç”¨æˆ·ä¸šåŠ¡æ•ˆç›Šï¼Œä½†å¾ˆå¤šæ—¶å€™ç”±äºä¸šåŠ¡å¢é•¿ç¼ºå°‘å‡†ç¡®çš„é¢„ä¼°ï¼Œåº”ç”¨ç¨‹åºä¸åˆç†è®¾è®¡ç­‰æ–¹é¢ï¼Œéœ€è¦è°ƒæ•´ç³»ç»Ÿé»˜è®¤çš„å‚æ•°é…ç½®æ¥é€‚åº”å’Œæ”¹å–„ä¸šåŠ¡è¿è¡ŒçŠ¶æ€ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†äº«å‡ ä¸ªæ¡ˆä¾‹æ¥å¸®åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£ä¸€äº›ç³»ç»Ÿå‚æ•°çš„å®é™…å‚è€ƒå’Œåº”ç”¨æ„ä¹‰ã€‚ 4.1 4 ä¸ª limits ç”Ÿæ•ˆçš„é—®é¢˜ 4.1.1 ç¬¬ä¸€ä¸ªé—®é¢˜ limits.conf çš„é™åˆ¶åœ¨ /proc/pid/limits ä¸­æœªç”Ÿæ•ˆã€‚ # cat /proc/3606/limits Limit Soft Limit Hard Limit Units Max processes 31202 31202 processes Max open files 1024 4096 files åœ¨ CentOS 7 & Ubuntu ç³»ç»Ÿä¸­ï¼Œä½¿ç”¨ Systemd æ›¿ä»£äº†ä¹‹å‰çš„ SysVã€‚/etc/security/ limits.conf æ–‡ä»¶çš„é…ç½®ä½œç”¨åŸŸç¼©å°äº†ã€‚ /etc/security/limits.conf çš„é…ç½®ï¼Œ åªé€‚ç”¨äºé€šè¿‡ PAM è®¤è¯ç™»å½•ç”¨æˆ·çš„èµ„æºé™åˆ¶ï¼Œ å®ƒå¯¹ systemd çš„ service çš„èµ„æºé™åˆ¶ä¸ç”Ÿæ•ˆã€‚ å› æ­¤ç™»å½•ç”¨æˆ·çš„é™åˆ¶ï¼Œ é€šè¿‡ /etc/ security/limits.conf ä¸ /etc/security/limits.d ä¸‹çš„æ–‡ä»¶è®¾ç½®å³å¯ã€‚ å¯¹äº systemd service çš„èµ„æºè®¾ç½®ï¼Œåˆ™éœ€ä¿®æ”¹å…¨å±€é…ç½®ï¼Œ å…¨å±€é…ç½®æ–‡ä»¶æ”¾åœ¨ /etc/systemd/system.conf å’Œ /etc/systemd/user.confï¼ŒåŒæ—¶ä¹Ÿä¼šåŠ è½½ä¸¤ä¸ªå¯¹åº”ç›®å½•ä¸­çš„æ‰€æœ‰ .conf æ–‡ä»¶ /etc/systemd/system.conf.d/.conf å’Œ /etc/systemd/user.conf.d/.confã€‚ system.conf æ˜¯ç³»ç»Ÿå®ä¾‹ä½¿ç”¨çš„ï¼Œuser.conf æ˜¯ç”¨æˆ·å®ä¾‹ä½¿ç”¨çš„ã€‚ vim /etc/systemd/system.conf DefaultLimitNOFILE=100000 DefaultLimitNPROC=65535 ä¿®æ”¹å¹¶é‡å¯å³å¯ã€‚ # cat /proc/3613/limits Limit Soft Limit Hard Limit Units Max processes 65535 65535 processes Max open files 100000 100000 files 4.1.2 ç¬¬äºŒä¸ªé—®é¢˜ åœ¨æœåŠ¡é‡Œé¢è®¾ç½® LimitNOFILE=infinity ä¸ºä»€ä¹ˆä¸æ˜¯æ— ç©·å¤§ï¼Ÿ åœ¨æœåŠ¡é‡Œé¢è®¾ç½® LimitNOFILE=infinity åï¼Œ é€šè¿‡æŸ¥çœ‹ pid çš„ limit å‘ç° openfile æ˜¯ 65536 ï¼Œè€Œä¸æ˜¯æ— ç©·å¤§ã€‚ æŸ¥çœ‹æœåŠ¡é…ç½® [root@iZwz98aynkjcxvtra0f375Z ~]# cat /etc/systemd/system/multi-user.target.wants/docker.service |grep -vi \"^#\"|grep -vi \"^$\" [Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com BindsTo=containerd.service After=network-online.target firewalld.service containerd.service Wants=network-online.target Requires=docker.socket [Service] Type=notify ExecStart=/usr/bin/dockerd -H fd:// ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT ExecReload=/bin/kill -s HUP $MAINPID TimeoutSec=0 RestartSec=2 Restart=always StartLimitBurst=3 StartLimitInterval=60s LimitNOFILE=infinity LimitNPROC=infinity LimitCORE=infinity TasksMax=infinity Delegate=yes KillMode=process [Install] WantedBy=multi-user.target æŸ¥çœ‹é…ç½®æ•ˆæœ è¿™ä¸ªæ˜¯ systemd çš„ bugï¼Œä½äº 240 çš„ç‰ˆæœ¬éœ€è¦æ‰‹åŠ¨è®¾ç½®æ‰å¯ä»¥ç”Ÿæ•ˆã€‚ LimitNOFILE=102400 githubä¸Šçš„è¯´æ˜ 4.1.3 ç¬¬ä¸‰ä¸ªé—®é¢˜ ä¸ºä»€ä¹ˆ openfile ä¸èƒ½è®¾ç½®ä¸º unlimitedã€‚ [root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n 65535 [root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n unlimited -bash: ulimit: open files: cannot modify limit: Operation not permitted åŸå› æ˜¯ CentOS7é‡Œ openfile ä¸èƒ½å¤§äº nr_openã€‚ [root@iZwz98aynkjcxvtra0f375Z ~]# cat /proc/sys/fs/nr_open 1048576 [root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n 1048577 -bash: ulimit: open files: cannot modify limit: Operation not permitted [root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n 1048576 [root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n 1048576 4.1.4 ç¬¬å››ä¸ªé—®é¢˜ ä½¿ç”¨ supervisor ç®¡ç†è¿›ç¨‹ï¼ˆæµ‹è¯•ç¯å¢ƒ Ubuntu 16.04ï¼‰å¯åŠ¨è¿›ç¨‹åï¼Œmaxfile æ˜¯1024ã€‚ éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚ # cat /etc/supervisor/supervisord.conf [supervisord] logfile=/var/log/supervisor/supervisord.log ; (main log file;default $CWD/ supervisord.log) pidfile=/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid) childlogdir=/var/log/supervisor ; ('AUTO' child log dir, default $TEMP) ä¸‹é¢è¿™ä¸¤è¡Œ minfds=655350 ; min. avail startup file descriptors;default 1024 minprocs=65535 ; min. avail process descriptors;default 200 å…³äº file-max nr_open file_nr çš„è§£é‡Šå¯å‚è€ƒæ­¤æ–‡ç«  å‚è€ƒå¤–éƒ¨æ–‡æ¡£ cnblogs csdn1 360äº‘ csdn2 4.2 å…­æ­¥æ’æŸ¥ ss & netstat ç»Ÿè®¡ç»“æœä¸ä¸€æ ·çš„åŸå›  ss çš„ç»“æœï¼Œclosed çŠ¶æ€çš„æœ‰ 3w å¤š netstat ç»Ÿè®¡åªæœ‰ä¸€ç™¾æ¥ä¸ªè¿æ¥ # netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print aï¼ŒS[a]}' ESTABLISHED 9 TIME_WAIT 79 é€šè¿‡ strace çœ‹çœ‹äºŒè€…çš„ç»Ÿè®¡æ–¹å¼å¾—ä¸åŒ ss ç›´æ¥å–è‡ª /proc/net/sockstatã€‚ netstat æ˜¯è¯»å–çš„ /proc/pid/fd ä¸‹é¢å…³è” tcp çš„ socketã€‚ netstat ä¹Ÿæœ‰æ‰«åˆ°ä¸‰ä¸‡å¤šä¸ª socketï¼Œ ä¸ºä»€ä¹ˆè¾“å‡ºçš„æ—¶å€™æ²¡æœ‰å±•ç¤ºå‘¢ï¼Ÿ By defaultï¼Œnetstat displays a list of open sockets. If you donâ€™t specify any address familiesï¼Œthen the active sockets of all configured address families will be printed. é»˜è®¤æƒ…å†µä¸‹ï¼Œnetstatæ˜¾ç¤ºæ‰“å¼€çš„å¥—æ¥å­—åˆ—è¡¨ã€‚å¦‚æœä¸æŒ‡å®šä»»ä½•åœ°å€ç³»åˆ—ï¼Œåˆ™æ‰€æœ‰å·²é…ç½®åœ°å€ç³»åˆ—çš„æ´»åŠ¨å¥—æ¥å­—å°†è¢«æ‰“å° æ‰¾å‡ºæ¥å“ªä¸ª pid çš„ socket æ¯”è¾ƒå¤šï¼Œ å¯¹ /proc/pid/fd ç›®å½•åšæ‰¹é‡æ‰«æ for d in /proc/[0-9]*;do pid=$(basename $d);s=$(ls -l $d/fd | egrep -i socket | wc -l 2>/dev/null); [ -n \"$s\" ] && echo \"$s $pid\";done | sort -n | tail -20 è¿›å…¥åˆ° /proc/7136/(ä¸Šè¿°å‘½ä»¤æ‰“å°å‡ºçš„ç›®å½•) ç›®å½•æŸ¥çœ‹ cmdline æˆ–è€…ç›´æ¥ ps -ef |grep pid æ‹¿åˆ°è¿›ç¨‹ï¼Œåé¢å°±éœ€è¦å®¢æˆ·è‡ªæŸ¥äº† 4.3 ä¸ºä»€ä¹ˆæ˜æ˜å†…å­˜å¾ˆå……è¶³ä½†æ˜¯ java ç¨‹åºä»ç”³è¯·ä¸åˆ°å†…å­˜ èƒŒæ™¯ä¿¡æ¯ ç”¨æˆ·æœ‰ä¸€å° 8G å†…å­˜çš„å®ä¾‹ï¼Œå‰©ä½™å†…å­˜è¿˜å¾ˆå¤šï¼ˆ7G å·¦å³ï¼‰ï¼Œè€Œ java ç¨‹åºä½¿ç”¨äº† 4G å†… å­˜ç”³è¯·ï¼Œç›´æ¥æŠ›å‡º OOMã€‚ æ’æŸ¥å¦‚ä¸‹ oom çš„è®°å½•æ˜¾ç¤ºä¸ºç”³è¯· 4g å†…å­˜å¤±è´¥ã€‚ 4294967296 /1024 /1024 = 4096 M 1.ç¬¬ä¸€ååº”æ˜¯æƒ³èµ·æ¥ä¹‹å‰çš„ vm.min_free_kbytes & nr_hugepage å¯¼è‡´çš„ free å¤§äº available æ¡ˆä¾‹æœ‰å…³ã€‚ centos7 memavailable å°äº memfree äºŒè€…çš„ç»Ÿè®¡æ–¹å¼ä¸ä¸€æ · MemFree: The sum of LowFree+HighFree +MemAvailable: An estimate of how much memory is available for starting new + applicationsï¼Œwithout swapping. Calculated from MemFree, + SReclaimableï¼Œthe size of the file LRU listsï¼Œand the low + watermarks in each zone. + The estimate takes into account that the system needs some + page cache to function wellï¼Œand that not all reclaimable + slab will be reclaimableï¼Œdue to items being in use. The + impact of those factors will vary from system to system. https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/ commit/?id=34e431b0ae398fc54ea69ff85ec700722c9da773 memfree ç»Ÿè®¡çš„æ˜¯æ‰€æœ‰å†…å­˜çš„ free å†…å­˜ï¼Œè€Œ memavailable ç»Ÿè®¡çš„æ˜¯å¯ä»¥æ‹¿æ¥ç»™ç¨‹åºç”¨çš„å†…å­˜ï¼Œè€Œå®¢æˆ·è®¾ç½®äº† vm.min_free_kbytesï¼ˆ2.5Gï¼‰ï¼Œè¿™ä¸ªå†…å­˜åœ¨ free ç»Ÿè®¡ï¼Œä½†æ˜¯ä¸åœ¨ memavailable ç»Ÿè®¡ nr_hugepage ä¹Ÿä¼šæœ‰è¿™ä¸ªé—®é¢˜ 2.è·Ÿå®¢æˆ·è¦ free -m && sysctl -p && /proc/meminfo ç­‰ä¿¡æ¯åˆ†æé—®é¢˜ã€‚ HugePages_Total ä¸º 0 è¯´æ˜æ²¡æœ‰è®¾ç½® nr_hugepageã€‚ MemAvailable: 7418172 kB è¯´æ˜è¿™ä¹ˆå¤šå†…å­˜å¯ç”¨ã€‚ # sysctl -p net.ipv4.ip_forward = 0 net.ipv4.conf.default.accept_source_route = 0 kernel.sysrq = 1 kernel.core_uses_pid = 1 net.ipv4.tcp_syncookies = 1 kernel.msgmnb = 65536 kernel.msgmax = 65536 kernel.shmmax = 500000000 kernel.shmmni = 4096 kernel.shmall = 4000000000 kernel.sem = 250 512000 100 2048 net.ipv4.tcp_tw_recycle=1 net.ipv4.tcp_max_syn_backlog=4096 net.core.netdev_max_backlog=10000 vm.overcommit_memory=2 net.ipv4.conf.all.arp_filter = 1 net.ipv4.ip_local_port_range=1025 65535 kernel.msgmni = 2048 net.ipv6.conf.all.disable_ipv6=1 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_max_syn_backlog = 8192 net.ipv4.tcp_keepalive_time = 600 #cat /proc/meminfo MemTotal: 8009416 kB MemFree: 7347684 kB MemAvailable: 7418172 kB Buffers: 18924 kB Cached: 262836 kB SwapCached: 0 kB Active: 315188 kB Inactive: 222364 kB Active(anon): 256120 kB Inactive(anon): 552 kB Active(file): 59068 kB Inactive(file): 221812 kB Unevictable: 0 kB Mlocked: 0 kB SwapTotal: 0 kB SwapFree: 0 kB Dirty: 176 kB Writeback: 0 kB AnonPages: 255804 kB Mapped: 85380 kB Shmem: 880 kB Slab: 40660 kB SReclaimable: 22240 kB SUnreclaim: 18420 kB KernelStack: 4464 kB PageTables: 6512 kB NFS_Unstable: 0 kB Bounce: 0 kB WritebackTmp: 0 kB CommitLimit: 4004708 kB Committed_AS: 2061568 kB VmallocTotal: 34359738367 kB VmallocUsed: 21452 kB VmallocChunk: 34359707388 kB HardwareCorrupted: 0 kB AnonHugePages: 126976 kB CmaTotal: 0 kB CmaFree: 0 kB HugePages_Total: 0 HugePages_Free: 0 HugePages_Rsvd: 0 HugePages_Surp: 0 Hugepagesize: 2048 kB DirectMap4k: 114560 kB DirectMap2M: 4079616 kB DirectMap1G: 6291456 kB 3.å®é™…ä¸Šé¢çš„ meminfo å·²ç»è¯´æ˜äº†é—®é¢˜ï¼Œä½†æ˜¯ç”±äºç»éªŒä¸è¶³ï¼Œä¸€æ—¶æ²¡æœ‰çœ‹æ˜ç™½æ€ä¹ˆå›äº‹ï¼Œå°è¯•è‡ªè¡Œæµ‹è¯•ã€‚ ä½¿ç”¨ java å‘½ä»¤ï¼Œå»ç”³è¯·è¶…å‡ºæˆ‘çš„æµ‹è¯•æœºç‰©ç†å†…å­˜å°è¯•ï¼Œæ‹¿åˆ°æŠ¥é”™ã€‚ [root@test ~]# java -Xmx8192M -version openjdk version \"1.8.0_242\" OpenJDK Runtime Environment (build 1.8.0_242-b08) OpenJDK 64-Bit Server VM (build 25.242-b08ï¼Œmixed mode) [root@test ~]# java -Xms8192M -version OpenJDK 64-Bit Server VM warning: INFO: os::commit_ memory(0x00000005c0000000ï¼Œ5726797824ï¼Œ0) failed; error='Cannot allocate memory' (errno=12) # # There is insufficient memory for the Java Runtime Environment to continue. # Native memory allocation (mmap) failed to map 5726797824 bytes for committing reserved memory. # An error report file with more information is saved as: # /root/hs_err_pid8769.log [root@test ~]# java -Xms4096M -version openjdk version \"1.8.0_242\" OpenJDK Runtime Environment (build 1.8.0_242-b08) OpenJDK 64-Bit Server VM (build 25.242-b08ï¼Œmixed mode) [root@test ~]# java -Xms5000M -version OpenJDK 64-Bit Server VM warning: INFO: os::commit_ memory(0x0000000687800000ï¼Œ3495428096ï¼Œ0) failed; error='Cannot allocate memory' (errno=12) ...... --------------- S Y S T E M --------------- OS:CentOS Linux release 7.4.1708 (Core) uname:Linux 3.10.0-693.2.2.el7.x86_64 #1 SMP Tue Sep 12 22:26:13 UTC 2017 x86_64 libc:glibc 2.17 NPTL 2.17 rlimit: STACK 8192kï¼ŒCORE 0kï¼ŒNPROC 15088ï¼ŒNOFILE 65535ï¼ŒAS infinity load average:0.05 0.05 0.05 /proc/meminfo: MemTotal: 3881692 kB MemFree: 2567724 kB MemAvailable: 2968640 kB Buffers: 69016 kB Cached: 536116 kB SwapCached: 0 kB Active: 355280 kB Inactive: 326020 kB Active(anon): 87864 kB Inactive(anon): 13296 kB Active(file): 267416 kB Inactive(file): 312724 kB Unevictable: 0 kB Mlocked: 0 kB SwapTotal: 0 kB SwapFree: 0 kB Dirty: 72 kB Writeback: 0 kB AnonPages: 72200 kB Mapped: 31232 kB Shmem: 24996 kB Slab: 63032 kB SReclaimable: 51080 kB SUnreclaim: 11952 kB KernelStack: 1664 kB PageTables: 4044 kB NFS_Unstable: 0 kB Bounce: 0 kB WritebackTmp: 0 kB CommitLimit: 1678700 kB Committed_AS: 2282236 kB VmallocTotal: 34359738367 kB VmallocUsed: 14280 kB VmallocChunk: 34359715580 kB HardwareCorrupted: 0 kB AnonHugePages: 30720 kB HugePages_Total: 256 HugePages_Free: 256 HugePages_Rsvd: 0 HugePages_Surp: 0 Hugepagesize: 2048 kB DirectMap4k: 57216 kB DirectMap2M: 3088384 kB DirectMap1G: 3145728 kB container (cgroup) information: container_type: cgroupv1 cpu_cpuset_cpus: 0-1 cpu_memory_nodes: 0 active_processor_count: 2 cpu_quota: -1 cpu_period: 100000 cpu_shares: -1 memory_limit_in_bytes: -1 memory_and_swap_limit_in_bytes: -1 memory_soft_limit_in_bytes: -1 memory_usage_in_bytes: 697741312 memory_max_usage_in_bytes: 0 CPU:total 2 (initial active 2) (1 cores per cpuï¼Œ2 threads per core) family 6 model 79 stepping 1ï¼Œcmovï¼Œcx8ï¼Œfxsrï¼Œmmxï¼Œsseï¼Œsse2ï¼Œsse3ï¼Œssse3ï¼Œsse4.1ï¼Œ sse4.2ï¼Œpopcntï¼Œavxï¼Œavx2 ï¼Œaesï¼Œclmulï¼Œermsï¼Œrtmï¼Œ3dnowprefï¼Œlzcntï¼Œhtï¼Œtscï¼Œbmi1ï¼Œbmi2ï¼Œadx /proc/cpuinfo: processor : 0 vendor_id : GenuineIntel cpu family : 6 model : 79 model name : Intel(R) Xeon(R) CPU E5-2682 v4 @ 2.50GHz stepping : 1 microcode : 0x1 cpu MHz : 2500.036 cache size : 40960 KB physical id : 0 siblings : 2 core id : 0 cpu cores : 1 apicid : 0 initial apicid : 0 fpu : yes fpu_exception : yes cpuid level : 13 wp : yes flags : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm rdseed adx smap xsaveopt bogomips : 5000.07 clflush size : 64 cache_alignment : 64 address sizes : 46 bits physicalï¼Œ48 bits virtual power management: processor : 1 vendor_id : GenuineIntel cpu family : 6 model : 79 model name : Intel(R) Xeon(R) CPU E5-2682 v4 @ 2.50GHz stepping : 1 microcode : 0x1 cpu MHz : 2500.036 cache size : 40960 KB physical id : 0 siblings : 2 core id : 0 cpu cores : 1 apicid : 1 initial apicid : 1 fpu : yes fpu_exception : yes cpuid level : 13 wp : yes flags : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm rdseed adx smap xsaveopt bogomips : 5000.07 clflush size : 64 cache_alignment : 64 address sizes : 46 bits physicalï¼Œ48 bits virtual power management: Memory: 4k pageï¼Œphysical 3881692k(2567600k free), swap 0k(0k free) vm_info: OpenJDK 64-Bit Server VM (25.242-b08) for linux-amd64 JRE (1.8.0_242-b08)ï¼Œbuilt on Jan 28 2020 14:28:22 by \"mockbuild\" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39) time: Thu Feb 20 15:13:30 2020 timezone: CST elapsed time: 0 seconds (0d 0h 0m 0s) 4.java æµ‹è¯•è¯æ˜æ­£å¸¸ç”³è¯·å†…å­˜ä¸ä¼šæœ‰é—®é¢˜ï¼Œè¶…é¢çš„å†…å­˜æ‰ä¼š oomï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¶…é¢å‘¢ï¼Œè§†çº¿å›å½’åˆ° sysctl -p æœ‰æ‰€å‘ç°ã€‚ 5.ä¸¤ç›¸å¯¹ç…§ï¼Œè¯´æ˜å®¢æˆ·è®¾ç½®çš„ vm.overcommit_memory åœ¨ç”Ÿæ•ˆï¼Œ å»ºè®®æ”¹å› 0 å†è¯•è¯•ã€‚ 4.4 è¯·ä¸è¦å¿½ç•¥ min_free_kbytes çš„è®¾ç½® é—®é¢˜èƒŒæ™¯ æœåŠ¡å™¨å†…ä¸»è¦è¿è¡Œç¨‹åºï¼šJadeosã€‚ é—®é¢˜æè¿° LINUX tmpfs ç©ºé—´ä½¿ç”¨æœªè¾¾åˆ° 100%ï¼Œå†…å­˜ä¹Ÿæœªå æ»¡ã€‚ æ‰§è¡Œä»»ä½•å‘½ä»¤æç¤º bash: fork: Cannot allocate memory è¿‡å‡ ç§’æ—¶é—´ç³»ç»Ÿä¼šè‡ªåŠ¨é‡å¯ã€‚ ä½†åœ¨å®¢æˆ·æœ¬åœ°ç¯å¢ƒæ˜¯æ²¡æœ‰è¿™ç§æƒ…å†µçš„ï¼Œå³ä½¿ tmpfs ä½¿ç”¨è¾¾åˆ° 100% ç³»ç»Ÿæœªæç¤º Cannot allocate memoryã€‚ å¤„ç†è¿‡ç¨‹ 1.é¦–å…ˆåˆ¤æ–­å®¢æˆ·æ˜¯å¦å†…å­˜ä¸è¶³å¯¼è‡´ï¼Œæ¯æ¬¡æ‰§è¡Œæµ‹è¯•æ“ä½œåï¼Œfree ç»“æœæ˜¾ç¤ºå¯ç”¨å†…å­˜æ˜¯æœ‰çš„ã€‚ 2.å½“è¿›ç¨‹ Process æ¯”è¾ƒå¤šï¼Œ å¯¼è‡´æ— æ³•åˆ†é… pidï¼Œ ä¹Ÿä¼šæç¤º Cannot allocate memoryï¼Œæ‰§è¡Œå‘½ä»¤ pstree -a | wc -l ç»Ÿè®¡ä¸‹è¿›ç¨‹æ•°ï¼Œæ’é™¤è¿›ç¨‹æ•°è¿‡å¤šå¯¼è‡´çš„å†…å­˜æ— æ³•åˆ†é…ã€‚ 3.ç™»å½•ä¸»æœºå†…éƒ¨æŸ¥çœ‹å®¢æˆ·å®¢æˆ·å†…éƒ¨è®¾ç½® min_free_kbytes å€¼ä¸º 1Gã€‚ å³å¼ºåˆ¶ Linux ç³»ç»Ÿæœ€ä½ä¿ç•™å¤šå°‘ç©ºé—²å†…å­˜ï¼ˆKbytesï¼‰ï¼Œå¦‚æœç³»ç»Ÿå¯ç”¨å†…å­˜ä½äºè¯¥å€¼ï¼Œé»˜è®¤ä¼šå¯ç”¨ oom killer æˆ–è€…å¼ºåˆ¶é‡å¯ã€‚ å½“è€—å°½å†…å­˜ç›´è‡³ç³»ç»Ÿæœ€ä½ä¿å­˜å†…å­˜æ—¶ä¼šæœ‰ä¸¤ç§ç°è±¡ï¼Œ æ ¹æ®å†…æ ¸å‚æ•° vm.panic_ on_oom è®¾ç½®å€¼çš„ä¸åŒè€Œæœ‰ä¸åŒçš„è¡Œä¸ºã€‚ vm.panic_on_oom=0 ç³»ç»Ÿä¼šæç¤º oom ï¼Œå¹¶å¯åŠ¨ oom-killer æ€æ‰å ç”¨æœ€é«˜å†…å­˜çš„è¿›ç¨‹ã€‚ vm.panic_on_oom =1. ç³»ç»Ÿå…³é—­ oom, ä¸ä¼šå¯åŠ¨ oom-killerï¼Œè€Œæ˜¯ä¼šè‡ªåŠ¨é‡å¯ã€‚ è§£å†³æ–¹æ¡ˆ å»ºè®®å®¢æˆ·é™ä½ min_free_kbytes å€¼ã€‚ æ›´æ”¹å‡å° min_free_kbytes åï¼Œå†æ‰§è¡Œæ›´å¤šæ¬¡çš„æ‹·è´ï¼Œæœ€åä¸€æ¬¡ free å¯ç”¨å†…å­˜æ˜¾ç¤ºè§£å†³åˆ°è®¾ç½®å€¼æ˜¯ï¼Œæ‰æç¤ºå†…å­˜ä¸è¶³ã€‚ è¿™ä¸ªæ˜¯ç¬¦åˆ linux ç³»ç»Ÿå¯¹å†…å­˜ç®¡ç†çš„é¢„æœŸçš„ã€‚ äº”ã€æœ€åçš„å½©è›‹ æŸåœ°åŒºå£ç½©é¡¹ç›®æ¶æ„æ¼”è¿›åŠä¼˜åŒ–ç»éªŒ ç®€ä»‹ ç–«æƒ…åˆæœŸæŸåœ°æ”¿åºœå†³å®šå‘æ”¾ä¸€æ‰¹å…è´¹å£ç½©é¢å‘è¯¥å¸‚å¸‚æ°‘ï¼Œè¯¥å¸‚å¸‚æ°‘å‡å¯å…è´¹é¢„çº¦é¢†å–ï¼Œé¢„çº¦æ—¶é—´ä¸ºæ—©ä¸Š 9ç‚¹ -12ç‚¹ï¼Œå› æ­¤è¯¥åœºæ™¯ä¸ºé™æ—¶æŠ¢è´­ç±»å‹åœºæ™¯ï¼Œ ä¼šé¢ä¸´éå¸¸å¤§çš„å®šæ—¶è¶…å¤§æµé‡è¶…å¤§å¹¶å‘é—®é¢˜ï¼Œåœ¨è¯¥é¡¹ç›®çš„è½åœ°è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠçš„æ¶æ„æ¼”å˜ï¼Œåšäº†ä¸€äº›è®°å½•å’Œæ€è€ƒã€‚ åŸå§‹æ¶æ„å›¾ç¤º & åˆ†æï¼ˆ2æœˆ2å·æ™šä¸Š 22 ç‚¹å·¦å³çš„åŸå§‹æ¶æ„ï¼‰ã€‚ å®¢æˆ·ç«¯èµ° https åè®®ç›´æ¥è®¿é—® ecsã€‚ ECS ä¸Šä½¿ç”¨ nginx è‡ªå»º https ç›‘å¬ã€‚- Nginx åä»£ tomcatï¼ŒNginx å¤„ç†é™æ€æ–‡ä»¶ï¼Œtomcat å¤„ç†åŠ¨æ€è¯·æ±‚ã€‚ ç¨‹åºå…ˆå» redis æŸ¥ç¼“å­˜ï¼Œ å¦‚æœªå‘½ä¸­åˆ™å»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œ åŒæ—¶ redis ä¸ mysql ä¹‹é—´çš„æ•°æ®åŒæ­¥é ç¨‹åºæ§åˆ¶ã€‚ ä¼˜ç‚¹ï¼šæ˜“ç®¡ç†ï¼Œæ˜“éƒ¨ç½²ã€‚ ç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œæ— æ‰©å±•æ€§ï¼Œå­˜åœ¨å•ç‚¹é£é™©ã€‚ äº‹å®è¯æ˜ï¼šè¯¥åº”ç”¨ä¸€ç»ä¸Šçº¿ç«‹åˆ»è¢«æ‰“æŒ‚äº†ï¼ˆæœªçŸ¥åŸå› é¢„çº¦é¡µé¢æ³„éœ²ï¼Œå¯¼è‡´è¿˜æœªåˆ°é¢„çº¦æ—¶é—´å³è¢«æ‰“æŒ‚ï¼‰ã€‚ æˆ‘æ–¹ä»‹å…¥åçš„äºŒä»£æ¶æ„ï¼ˆ24ç‚¹å·¦å³æ‰¾çš„æˆ‘ä»¬ï¼Œæ—©ä¸Š9ç‚¹è¦å¼€æœï¼Œæ—¶é—´å¤ªç´§ï¼Œä»»åŠ¡å¤ªé‡ï¼Œ ç¨‹åºä¸èƒ½åŠ¨çš„æƒ…å†µä¸‹ï¼Œå‡ åä¸‡çš„å¹¶å‘æ¶æ„å¦‚ä½•åšï¼Ÿ 2æœˆ3å·æ—©ä¸Š9ç‚¹å·¦å³çš„æ¶æ„ï¼Œ4å·ä¹Ÿæ¢å¤äº†è¿™ä¸ªæ¶æ„ï¼‰ã€‚ æ¥å…¥ slbï¼Œé€šè¿‡é•œåƒæ¨ªå‘æ‰©å±•è´Ÿè½½èƒ½åŠ›ã€‚ æ¥å…¥è¯»å†™åˆ†ç¦»æ•°æ®åº“æ¶æ„ï¼Œ é€šè¿‡é˜¿é‡Œäº‘æ•°æ®åº“è‡ªåŠ¨è¿›è¡Œè¯»å†™åˆ†ç¦»ï¼Œ è‡ªåŠ¨åŒæ­¥æ•°æ®ã€‚ è°ƒæ•´ nginx åè®®ã€‚ åŒæ¶æ„å¤‡é›†ç¾¤å¯ç”¨ï¼ˆåŸŸåè§£æåšäº†ä¸¤ä¸ª A è®°å½•ï¼‰ã€‚ åˆ†æè®¿é—®æ—¥å¿—å‘ç°å¤±è´¥åŸå› åœ¨è·å–çŸ­ä¿¡ & ç™»é™†åˆå§‹åŒ– cookie çš„ç‚¹ä¸Šã€‚ ä¼˜ç‚¹ï¼šå¢åŠ äº†é«˜å¯ç”¨æ€§ï¼Œæ‰©å±•äº†è´Ÿè½½èƒ½åŠ›ã€‚ ç¼ºç‚¹ï¼šå¯¹æµé‡é¢„ä¼°ä¸è¶³ï¼Œ é™æ€é¡µé¢ä¹Ÿåœ¨ ECS ä¸Šï¼Œ å› æ­¤ SLB çš„å‡ºå¸¦å®½ä¸€åº¦è¾¾åˆ°æœ€å¤§å€¼ 5.xGï¼Œå¹¶å‘é«˜è¾¾ 22w+ï¼Œç”¨æˆ·ä¸€åº¦æ‰“ä¸å¼€é¡µé¢ï¼ŒåŒæ—¶ç”±äºæ–°ç½‘çš„é™åˆ¶å®¢æˆ·æ— æ³•è‡ªåŠ©æ·»åŠ è§£æï¼Œ å½“æ™šè”ç³»ä¸åˆ°æ–°ç½‘å®¢æœå¯¼è‡´ CDN æ–¹æ¡ˆææµ…ã€‚ çŸ¥è€»è€Œåå‹‡çš„ç¬¬ä¸‰ä»£æ¶æ„ï¼ˆ2æœˆ4å· & 2æœˆ5å·çš„æ¶æ„ï¼Œ5å·åº”ç”¨ï¼‰ã€‚ æ¥å…¥ CDN åˆ†æµè¶…å¤§å¸¦å®½ã€‚ å–æ¶ˆ nginx çš„ä»£ç†ã€‚ åšäº†æ–°ç¨‹åºæ— æ³•å‡†æ—¶ä¸Šçº¿çš„ç¾å¤‡åˆ‡æ¢æ–¹æ¡ˆï¼ˆæ²¡æƒ³åˆ°è¿˜çœŸç”¨åˆ°äº†ï¼‰ã€‚ ä½¿ç”¨è™šæ‹ŸæœåŠ¡å™¨ç»„åšæ–°è€ç¨‹åºçš„åˆ‡æ¢ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯ä¸€ä¸ªä¸ƒå±‚ç›‘å¬çš„ slb åç«¯åªèƒ½æŒ‚ 200 ä¸ªæœºå™¨ï¼Œå†å¤š slb ä¹Ÿæ‰›ä¸ä½äº†ï¼Œå¯¼è‡´è€ç¨‹åºåˆšæ‰¿æ¥çš„æ—¶å€™å†åº¦æŒ‚æ‰ã€‚ 5å·ä½¿ç”¨è¿™ä¸ªæ¶æ„ä¸Šçº¿ï¼Œ7åˆ†é’Ÿåº“å­˜å”®ç½„ï¼Œä¸”ä½“éªŒæåº¦æµç¨‹ï¼Œä¸èˆ¬é¡ºæ»‘ï¼Œå¥åº·åŒå­¦å¼€å‘çš„æ–°ç¨‹åºçœŸæ˜¯å¤ªçˆ½çš„ã€‚ ä¼˜ç‚¹ï¼šCDN è´Ÿæ‹…é™æ€èµ„æºçš„æµé‡é™ä½äº† SLB çš„å‡ºå¸¦å®½ï¼Œå‹æµ‹çš„æ•ˆæœä¹Ÿéå¸¸ç†æƒ³ã€‚ ç¼ºç‚¹ï¼šéœ€è¦å¤šä¸€ä¸ªç‹¬ç«‹çš„åŸŸååœ¨é¡µé¢é‡Œé¢ï¼Œæ¶‰åŠè·¨åŸŸï¼Œ4å·ä¸´å¼€æœä¹‹é™…æµ‹è¯•å‘ç°å…¥åº“ & é¢„çº¦çŸ­ä¿¡ä¹±ç è¿”å›ï¼Œç´§æ€¥åˆ‡æ¢å›äº†è€ç¨‹åºï¼Œå³äºŒä»£æ¶æ„ã€‚ ç†æƒ³æ¶æ„ ä¸»åŸŸåæ¥å…¥ CDNï¼Œ CDN é€šè¿‡è®¾ç½®å›æº httpã€https åè®®å»è®¿é—® SLB çš„ä¸åŒç›‘å¬å®ç°æ–°è€ç¨‹åºä¹‹é—´çš„åˆ‡æ¢ï¼Œå…·ä½“å®ç°ä¸ºå›æºåè®®å¯¹åº”ã€‚ä¸åŒç›‘å¬ï¼Œç›‘å¬å¯¹åº”ä¸åŒçš„ç¨‹åºã€‚ ä¼˜ç‚¹ï¼šé™æ€åŠ é€Ÿé™ä½ SLB å¸¦å®½ï¼ŒåŠ¨æ€å›æºï¼Œæ— è·¨åŸŸé—®é¢˜ ï¼Œåˆ‡æ¢æ–¹ä¾¿ã€‚ ç¼ºç‚¹ï¼šä»éœ€æ‰‹å·¥è®¾ç½®ï¼Œé•œåƒéƒ¨ç½² ecs ä¸æ–¹ä¾¿ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œå¯ä»¥ç›´æ¥ä¸Šå®¹å™¨çš„æ¶æ„è¯¥æœ‰å¤šç¾å¥½å‘¢ï¼Œä¸€ä¸ª scale å¯ä»¥æ‰©å‡ºæ¥å‡ åä¸Šç™¾çš„ podï¼Œä¹Ÿå¯ä»¥åšèŠ‚ç‚¹è‡ªåŠ¨æ‰©å®¹ã€‚ æ€»ç»“ æ€»ç»“ï¼šæ—¶é—´ç´§ä»»åŠ¡é‡ï¼Œé‡åˆ°äº† N å¤šçš„å‘ï¼Œæƒ³èµ·æ¥ä¸€ä¸ªè¡¥ä¸€ä¸ª ~ vcpu è´­ä¹°é¢åº¦ã€‚ slb åç«¯æŒ‚è½½é¢åº¦ã€‚ å®¢æˆ·ä½™é¢ä¸è¶³æ¬ è´¹åœæœºã€‚ æ–°ç½‘è§£æéœ€è¦è”ç³»å®¢æœæ·»åŠ ã€‚ ç¬¬ä¸€æ¬¡è€ƒè™‘ CDN æ¶æ„çš„æ—¶å€™æœªè€ƒè™‘è·¨åŸŸé—®é¢˜ã€‚ æ–°ç¨‹åºå¼€å‘æœŸé—´æœªè¿æ¥ä¸»åº“æµ‹è¯•ï¼Œå¯¼è‡´ä¸Šçº¿å¤±è´¥ï¼ˆä¸»åº“ä¹±ç ï¼‰ã€‚ ç¬¬ä¸€æ¬¡ï¼ˆ3 å·ï¼‰è¢«æ‰“æŒ‚çš„æ—¶å€™åªå…³æ³¨äº† slb çš„æµé‡ï¼Œæœªè¯¦ç»†åˆ†æå¤±è´¥æœ€å¤šçš„ç¯èŠ‚ã€‚ ä¸Šçº¿å‰å‹æµ‹ç¼ºå¤±ï¼Œçº¯é äººå·¥æµ‹è¯•åŠŸèƒ½ã€‚ å‹æµ‹é äººæ‰‹ä¸€å° jmeterï¼ˆ4å·æ™šä¸Šåˆ°5å·æ—©ä¸Šå¼•å…¥äº†PTSè¿›è¡Œå‹æµ‹ï¼‰ã€‚ çªç„¶æƒ³èµ·æ¥å®¢æˆ·åŸå§‹çš„ç¨‹åºæ˜¯æ”¾åœ¨ windows ä¸Šçš„ï¼Œå¯¼è‡´æ€§èƒ½å‡ºç°äº†å¤§å¤§çš„æŠ˜æ‰£ã€‚ æœ€åçš„æˆæœç»Ÿè®¡ï¼ˆé‡‡æ ·åˆ†æï¼Œå®é™…æ•°æ®æ¯”è¿™ä¸ªè¿˜å¤§ï¼‰ï¼š æœ€åä¸Šçº¿çš„ä¸‰ä»£æ¶æ„ï¼Œä¸ºäº†ä¿é™©èµ·è§ä¸Šäº† 150 å°æœºå™¨ï¼Œä½†æ˜¯æ ¹æ®æ´»åŠ¨æœŸé—´çš„è§‚å¯Ÿï¼Œä»¥åŠå¯¹å‹æµ‹ç»“æœçš„è¯„ä¼°ï¼Œä¸Š50å°æœºå™¨åº”è¯¥å°±å¯ä»¥æŠ—ä½äº†ï¼Œä»æŒç»­5å°æ—¶ä¸€ç›´å´©æºƒè¢«ç»ˆç«¯ç”¨æˆ·éª‚è¡—ï¼Œåˆ°7åˆ†é’Ÿåº“å­˜å”®ç½„çš„é¢†å¯¼èµèµï¼Œè™½ç„¶ç»å†äº†3ä¸ªé€šå®µçš„æˆ®æˆ˜ï¼Œä¾ç„¶å¯ä»¥éšéšçº¦çº¦æ„Ÿè§‰åˆ°èº«å¿ƒéƒ½å¾—åˆ°äº†å‡å ~ ä¼˜åŒ–å‚æ•°ç¬”è®° 1.å‚æ•°ä¼˜åŒ– net.ipv4.tcp_max_tw_buckets = 5000 --> 50000 net.ipv4.tcp_max_syn_backlog = 1024 --> 4096 net.core.somaxconn = 128 --> 4096 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_timestamps = 1(5 å’Œ 6 åŒæ—¶å¼€å¯å¯èƒ½ä¼šå¯¼è‡´natä¸Šç½‘ç¯å¢ƒå»ºè”æ¦‚ç‡å¤±è´¥ ) net.ipv4.tcp_tw_recycle = 1 /etc/security/limits.conf * soft nofile 65535 * hard nofile 65535 nginx å‚æ•°ä¼˜åŒ– worker_connections 1024-->10240; worker_processes 1-->16;ï¼ˆæ ¹æ®å®é™…æƒ…å†µè®¾ç½®ï¼Œå¯ä»¥è®¾ç½®æˆ autoï¼‰ worker_rlimit_nofile 1024-->102400; listen 80 backlog 511-->65533ï¼› éƒ¨åˆ†åœºæ™¯ä¹Ÿå¯ä»¥è€ƒè™‘ nginx å¼€å¯é•¿è¿æ¥æ¥ä¼˜åŒ–çŸ­é“¾æ¥å¸¦æ¥çš„å¼€é”€ 2.æ¶æ„ä¼˜åŒ– æ‰©å®¹SLBåç«¯ECSæ•°é‡ï¼Œecsé…ç½®ç»Ÿä¸€ nginxåä»£åç«¯upstreamæ— æ•ˆç«¯å£å»é™¤ äº‘åŠ©æ‰‹æ‰¹é‡å¤„ç†æœåŠ¡ï¼Œå‚æ•°ä¼˜åŒ–ï¼Œæ·»åŠ å®ä¾‹æ ‡è¯† äº‘ç›‘æ§å¤§ç›˜ç›‘æ§ï¼ŒECS slb dcdn redis è°ƒæ•´SLBä¸º7å±‚ç›‘å¬æ¨¡å¼ï¼Œå‰7å4å…³é—­ä¼šè¯ä¿æŒå¯¼è‡´ç™»å½•çŠ¶æ€å¤±æ•ˆï¼Œ 3.ç¨‹åºä¼˜åŒ– æ·»åŠ  gc logï¼Œæ•æ‰ gc åˆ†æé—®é¢˜ï¼Œè®¾ç½®è¿›ç¨‹å†…å­˜ /usr/bin/java -server -Xmx8g -verbose:gc -XX:+PrintGCDetails -Xloggc:/var/ log/9052.gc.log -Dserver.port=9052 -jar /home/app/we.*****.com/serverboot0.0.1-SNAPSHOT.jar ä¼˜åŒ–çŸ­ä¿¡å‘é€é€»è¾‘ï¼Œç™»é™†å…ˆæŸ¥è¯¢ redis å…ç™» sessionï¼Œæ— å…ç™» session å†å…è®¸å‘é€çŸ­ä¿¡éªŒè¯ç ï¼ˆé™çŸ­ä¿¡çš„é‡ï¼Œä¼˜åŒ–ç™»é™†ä½“éªŒï¼‰ jedis è¿æ¥æ± ä¼˜åŒ– maxTotal 8-->20 acceptcount ä¼˜åŒ–ï¼ˆå¯¹æ ‡ somaxconnï¼‰ bugï¼š springboot1.5 å¸¦çš„ jedis2.9.1 çš„ redis è¿æ¥æ³„æ¼çš„é—®é¢˜ï¼Œå¯¼è‡´ tomcat 800 è¿›ç¨‹ç”¨æ»¡åéƒ½æ—  é™ç­‰å¾… redis è¿æ¥ åæ¥è¿›ä¸€æ­¥è°ƒç ”å‘ç°è¿™ä¸ªé—®é¢˜åœ¨ 2.10.2 å·²ç»ä¿®å¤ï¼Œè€Œä¸” 2.10.2 å‘åå…¼å®¹ 2.9.1 4.æ•°æ®åº“ä¼˜åŒ– redis å…¬ç½‘åœ°å€å˜æ›´ä¸ºå†…ç½‘åœ°å€ redis session è¶…æ—¶è®¾ç½®ç¼©çŸ­ï¼Œç”¨äºé‡Šæ”¾ redis è¿æ¥ server.servlet.session.timeout=300s spring.session.timeout=300s æ…¢ SQL ä¼˜åŒ–ï¼ˆRDS çš„ CloudDBA éå¸¸å¥½ç”¨å“Ÿï¼‰ æ·»åŠ åªè¯»å®ä¾‹ï¼Œè‡ªåŠ¨è¯»å†™åˆ†ç¦» ä¼˜åŒ– backlog æ·»åŠ è¯»å†™åˆ†ç¦»å®ä¾‹æ•°é‡ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"ç”Ÿäº§ç¯å¢ƒå¼€æºé¡¹ç›®/ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ/DolphinSchedulerå•æœºéƒ¨ç½².html":{"url":"ç”Ÿäº§ç¯å¢ƒå¼€æºé¡¹ç›®/ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ/DolphinSchedulerå•æœºéƒ¨ç½².html","title":"DolphinScheduler","keywords":"","body":"DolphinScheduler å•æœºéƒ¨ç½² ä¸€ã€DolphinSchedulerç®€ä»‹ DolphinSchedulerè¯´æ˜ Apache DolphinScheduler æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å»ä¸­å¿ƒåŒ–ï¼Œæ˜“æ‰©å±•çš„å¯è§†åŒ–DAGå·¥ä½œæµä»»åŠ¡è°ƒåº¦ç³»ç»Ÿã€‚è‡´åŠ›äºè§£å†³æ•°æ®å¤„ç†æµç¨‹ä¸­é”™ç»¼å¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œä½¿è°ƒåº¦ç³»ç»Ÿåœ¨æ•°æ®å¤„ç†æµç¨‹ä¸­å¼€ç®±å³ç”¨ã€‚ ä½¿ç”¨èƒŒæ™¯ å…¬å¸ä½¿ç”¨çš„æ˜¯EasySchedulerï¼Œä¸è¿‡ EasyScheduler å·²ç»æçŒ®ç»™äº† Apache è´¡çŒ®ç»™ Apache åï¼Œæ”¹åä¸º DolphinSchedulerï¼ŒEasySchedulerå·²ç»ä¸åœ¨ç»´æŠ¤ DolphinSchedulerå®˜ç½‘ DolphinScheduler githubåœ°å€ è®¾è®¡ç‰¹ç‚¹ï¼š ä¸€ä¸ªåˆ†å¸ƒå¼æ˜“æ‰©å±•çš„å¯è§†åŒ–DAGå·¥ä½œæµä»»åŠ¡è°ƒåº¦ç³»ç»Ÿã€‚è‡´åŠ›äºè§£å†³æ•°æ®å¤„ç†æµç¨‹ä¸­é”™ç»¼å¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œä½¿è°ƒåº¦ç³»ç»Ÿåœ¨æ•°æ®å¤„ç†æµç¨‹ä¸­å¼€ç®±å³ç”¨ã€‚ å…¶ä¸»è¦ç›®æ ‡å¦‚ä¸‹ï¼š ä»¥DAGå›¾çš„æ–¹å¼å°†TaskæŒ‰ç…§ä»»åŠ¡çš„ä¾èµ–å…³ç³»å…³è”èµ·æ¥ï¼Œå¯å®æ—¶å¯è§†åŒ–ç›‘æ§ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€ æ”¯æŒä¸°å¯Œçš„ä»»åŠ¡ç±»å‹ï¼šShellã€MRã€Sparkã€SQL(mysqlã€postgresqlã€hiveã€sparksql),Python,Sub_Processã€Procedureç­‰ æ”¯æŒå·¥ä½œæµå®šæ—¶è°ƒåº¦ã€ä¾èµ–è°ƒåº¦ã€æ‰‹åŠ¨è°ƒåº¦ã€æ‰‹åŠ¨æš‚åœ/åœæ­¢/æ¢å¤ï¼ŒåŒæ—¶æ”¯æŒå¤±è´¥é‡è¯•/å‘Šè­¦ã€ä»æŒ‡å®šèŠ‚ç‚¹æ¢å¤å¤±è´¥ã€Killä»»åŠ¡ç­‰æ“ä½œ æ”¯æŒå·¥ä½œæµä¼˜å…ˆçº§ã€ä»»åŠ¡ä¼˜å…ˆçº§åŠä»»åŠ¡çš„æ•…éšœè½¬ç§»åŠä»»åŠ¡è¶…æ—¶å‘Šè­¦/å¤±è´¥ æ”¯æŒå·¥ä½œæµå…¨å±€å‚æ•°åŠèŠ‚ç‚¹è‡ªå®šä¹‰å‚æ•°è®¾ç½® æ”¯æŒèµ„æºæ–‡ä»¶çš„åœ¨çº¿ä¸Šä¼ /ä¸‹è½½ï¼Œç®¡ç†ç­‰ï¼Œæ”¯æŒåœ¨çº¿æ–‡ä»¶åˆ›å»ºã€ç¼–è¾‘ æ”¯æŒä»»åŠ¡æ—¥å¿—åœ¨çº¿æŸ¥çœ‹åŠæ»šåŠ¨ã€åœ¨çº¿ä¸‹è½½æ—¥å¿—ç­‰ å®ç°é›†ç¾¤HAï¼Œé€šè¿‡Zookeeperå®ç°Masteré›†ç¾¤å’ŒWorkeré›†ç¾¤å»ä¸­å¿ƒåŒ– æ”¯æŒå¯¹Master/Worker cpu loadï¼Œmemoryï¼Œcpuåœ¨çº¿æŸ¥çœ‹ æ”¯æŒå·¥ä½œæµè¿è¡Œå†å²æ ‘å½¢/ç”˜ç‰¹å›¾å±•ç¤ºã€æ”¯æŒä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ã€æµç¨‹çŠ¶æ€ç»Ÿè®¡ æ”¯æŒè¡¥æ•° æ”¯æŒå¤šç§Ÿæˆ· æ”¯æŒå›½é™…åŒ– è¿˜æœ‰æ›´å¤šç­‰å¾…ä¼™ä¼´ä»¬æ¢ç´¢ ä¸åŒç±»è°ƒåº¦ç³»ç»Ÿçš„å¯¹æ¯” äºŒã€DolphinSchedulerå®‰è£… 2.1 å®˜æ–¹æ¨èç³»ç»Ÿé…ç½® Linux æ“ä½œç³»ç»Ÿç‰ˆæœ¬è¦æ±‚ æ“ä½œç³»ç»Ÿ ç‰ˆæœ¬ Red Hat Enterprise Linux 7.0 åŠä»¥ä¸Š CentOS 7.0 åŠä»¥ä¸Š Oracle Enterprise Linux 7.0 åŠä»¥ä¸Š Ubuntu LTS 16.04 åŠä»¥ä¸Š æ³¨æ„ï¼š ä»¥ä¸Š Linux æ“ä½œç³»ç»Ÿå¯è¿è¡Œåœ¨ç‰©ç†æœåŠ¡å™¨ä»¥åŠ VMwareã€KVMã€XEN ä¸»æµè™šæ‹ŸåŒ–ç¯å¢ƒä¸Šã€‚ æœåŠ¡å™¨å»ºè®®é…ç½® CPU å†…å­˜ ç¡¬ç›˜ç±»å‹ ç½‘ç»œ å®ä¾‹æ•°é‡ 4æ ¸+ 8 GB+ SAS åƒå…†ç½‘å¡ 1+ æ³¨æ„ï¼š ä»¥ä¸Šå»ºè®®é…ç½®ä¸ºéƒ¨ç½² DolphinScheduler çš„æœ€ä½é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒå¼ºçƒˆæ¨èä½¿ç”¨æ›´é«˜çš„é…ç½®ã€‚ ç¡¬ç›˜å¤§å°é…ç½®å»ºè®® 50GB+ ï¼Œç³»ç»Ÿç›˜å’Œæ•°æ®ç›˜åˆ†å¼€ã€‚ ç½‘ç»œè¦æ±‚ DolphinScheduleræ­£å¸¸è¿è¡Œæä¾›å¦‚ä¸‹çš„ç½‘ç»œç«¯å£é…ç½®ï¼š ç»„ä»¶ é»˜è®¤ç«¯å£ è¯´æ˜ MasterServer 5678 éé€šä¿¡ç«¯å£ï¼Œåªéœ€æœ¬æœºç«¯å£ä¸å†²çªå³å¯ WorkerServer 1234 éé€šä¿¡ç«¯å£ï¼Œåªéœ€æœ¬æœºç«¯å£ä¸å†²çªå³å¯ ApiApplicationServer 12345 æä¾›åç«¯é€šä¿¡ç«¯å£ æ³¨æ„ï¼š MasterServer å’Œ WorkerServer ä¸éœ€è¦å¼€å¯ç½‘ç»œé—´é€šä¿¡ï¼Œåªéœ€æœ¬æœºç«¯å£ä¸å†²çªå³å¯ ç®¡ç†å‘˜å¯æ ¹æ®å®é™…ç¯å¢ƒä¸­ DolphinScheduler ç»„ä»¶éƒ¨ç½²æ–¹æ¡ˆï¼Œåœ¨ç½‘ç»œä¾§å’Œä¸»æœºä¾§å¼€æ”¾ç›¸å…³ç«¯å£ 2.2 ç³»ç»Ÿç¯å¢ƒ æ“ä½œç³»ç»ŸåŠé…ç½® ç³»ç»Ÿ é…ç½® ç£ç›˜ centos7.8 4c8g 50g 2.3 å®‰è£…è¿‡ç¨‹ DolphinScheduleræœ€æ–°ç‰ˆ1.3.2å®˜æ–¹æ–‡æ¡£(æˆªæ­¢2002.9.5) 2.3.1 åŸºç¡€è½¯ä»¶å®‰è£… 2.3.1.1 æ•°æ®åº“(pgæˆ–è€…mysql) PostgreSQL (8.2.15+) or MySQL (5.7ç³»åˆ—) : å¿…è£… ä¸¤è€…ä»»é€‰å…¶ä¸€å³å¯ 2.3.1.2 JDK8 JDK (1.8+) : å¿…è£…ï¼Œè¯·å®‰è£…å¥½ååœ¨/etc/profileä¸‹é…ç½® JAVA_HOME åŠ PATH å˜é‡ è‡ªè¡Œåˆ°JDKå®˜ç½‘ä¸‹è½½å®‰è£…åŒ… è¿™é‡Œé€‰æ‹©ä¸‹è½½jdk-8u251-linux-x64.tar.gz #ä¸Šä¼ jdkå®‰è£…åŒ…è‡³/optå¹¶è§£å‹ç¼©è‡³/usr/local cd /opt && tar xf jdk-8u251-linux-x64.tar.gz -C /usr/local #å¯¼å‡ºjdkç¯å¢ƒå˜é‡ cat >/etc/profile.d/jdk8.sh 2.3.1.3 ZooKeeper ZooKeeper (3.4.6+) ï¼šå¿…è£… ZooKeeperå®˜ç½‘ ZooKeeperå®˜æ–¹ä¸‹è½½åœ°å€ ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ… é€‰æ‹©å®˜æ–¹æ¨èçš„ä¸‹è½½åœ°å€ å®‰è£…è¿‡ç¨‹ #1.ä¸‹è½½äºŒè¿›åˆ¶åŒ… wget https://apache-mirror.rbc.ru/pub/apache/zookeeper/zookeeper-3.6.1/apache-zookeeper-3.6.1-bin.tar.gz #2.è§£å‹ç¼© tar xf apache-zookeeper-3.6.1-bin.tar.gz -C /usr/local/ #3.åšè½¯è¿æ¥ ln -s /usr/local/apache-zookeeper-3.6.1-bin/ /usr/local/zookeeper-3.6.1 #4.ç¼–è¾‘æœ€ç®€zookeeperé…ç½®æ–‡ä»¶ cat > /usr/local/zookeeper-3.6.1/conf/zoo.cfg zookeeperé»˜è®¤é…ç½®æ–‡ä»¶è¯´æ˜ #é€šä¿¡å¿ƒè·³æ—¶é—´ï¼Œç³»ç»Ÿé»˜è®¤æ˜¯2000æ¯«ç§’ï¼Œä¹Ÿå°±æ˜¯é—´éš”ä¸¤ç§’å¿ƒè·³ä¸€æ¬¡ #å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æˆ–è€…æœåŠ¡å™¨ä¸æœåŠ¡å™¨ä¹‹é—´ç»´æŒå¿ƒè·³ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªtickTimeæ—¶é—´å°±ä¼šå‘é€ä¸€æ¬¡å¿ƒè·³ã€‚é€šè¿‡å¿ƒè·³ä¸ä»…èƒ½å¤Ÿç”¨æ¥ç›‘å¬æœºå™¨çš„å·¥ä½œçŠ¶æ€ï¼Œè¿˜å¯ä»¥é€šè¿‡å¿ƒè·³æ¥æ§åˆ¶Flowerè·ŸLeaderçš„é€šä¿¡æ—¶é—´ï¼Œé»˜è®¤æƒ…å†µä¸‹FLçš„ä¼šè¯æ—¶å¸¸æ˜¯å¿ƒè·³é—´éš”çš„ä¸¤å€ã€‚ tickTime=2000 #é›†ç¾¤ä¸­çš„followeræœåŠ¡å™¨(F)ä¸leaderæœåŠ¡å™¨(L)ä¹‹é—´åˆå§‹è¿æ¥æ—¶èƒ½å®¹å¿çš„æœ€å¤šå¿ƒè·³æ•°ï¼ˆtickTimeçš„æ•°é‡ï¼‰ã€‚ initLimit=10 #é›†ç¾¤ä¸­floweræœåŠ¡å™¨ï¼ˆFï¼‰è·Ÿleaderï¼ˆLï¼‰æœåŠ¡å™¨ä¹‹é—´çš„è¯·æ±‚å’Œç­”åº”æœ€å¤šèƒ½å®¹å¿çš„å¿ƒè·³æ•°ã€‚ syncLimit=5 #zookeeperæ•°æ®ç›®å½•ï¼Œé»˜è®¤æ˜¯/tmp/zookeeper dataDir=/data/zookeeper #å®¢æˆ·ç«¯è¿æ¥çš„æ¥å£ï¼Œå®¢æˆ·ç«¯è¿æ¥zookeeperæœåŠ¡å™¨çš„ç«¯å£ï¼Œzookeeperä¼šç›‘å¬è¿™ä¸ªç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚è®¿é—®ï¼ clientPort=2181 2.3.1.4 Hadoop Hadoop (2.6+) or MinIO ï¼šé€‰è£…ï¼Œ å¦‚æœéœ€è¦ç”¨åˆ°èµ„æºä¸Šä¼ åŠŸèƒ½ï¼Œé’ˆå¯¹å•æœºå¯ä»¥é€‰æ‹©æœ¬åœ°æ–‡ä»¶ç›®å½•ä½œä¸ºä¸Šä¼ æ–‡ä»¶å¤¹(æ­¤æ“ä½œä¸éœ€è¦éƒ¨ç½²Hadoop)ï¼›å½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©ä¸Šä¼ åˆ°Hadoop or MinIOé›†ç¾¤ä¸Š æ³¨æ„ï¼šDolphinScheduleræœ¬èº«ä¸ä¾èµ–Hadoopã€Hiveã€Sparkï¼Œä»…æ˜¯ä¼šè°ƒç”¨ä»–ä»¬çš„Clientï¼Œç”¨äºå¯¹åº”ä»»åŠ¡çš„è¿è¡Œã€‚ 2.3.2 ä¸‹è½½ DolphinScheduler äºŒè¿›åˆ¶tar.gzåŒ… å®˜æ–¹ä¸‹è½½åœ°å€ é€‰æ‹©ç›¸åº”ç‰ˆæœ¬çš„äºŒè¿›åˆ¶åŒ… é€‰æ‹©å®˜æ–¹æ¨èçš„ä¸‹è½½åœ°å€ ä¸‹è½½äºŒè¿›åˆ¶åŒ…å¹¶è§£å‹ç¼© #1.åˆ›å»ºéƒ¨ç½²ç›®å½•ï¼Œéƒ¨ç½²ç›®å½•è¯·ä¸è¦åˆ›å»ºåœ¨/rootã€/homeç­‰é«˜æƒé™ç›®å½• mkdir -p /opt/dolphinscheduler && cd /opt/dolphinscheduler #2.ä¸‹è½½äºŒè¿›åˆ¶åŒ… wget https://apache-mirror.rbc.ru/pub/apache/incubator/dolphinscheduler/1.3.2/apache-dolphinscheduler-incubating-1.3.2-dolphinscheduler-bin.tar.gz #3.è§£å‹ç¼©å¹¶é‡å‘½å tar xf apache-dolphinscheduler-incubating-1.3.2-dolphinscheduler-bin.tar.gz && mv apache-dolphinscheduler-incubating-1.3.2-dolphinscheduler-bin dolphinscheduler-bin 2.3.3 åˆ›å»ºéƒ¨ç½²ç”¨æˆ·å¹¶èµ‹äºˆç›®å½•æ“ä½œæƒé™ åˆ›å»ºéƒ¨ç½²ç”¨æˆ·ï¼Œå¹¶ä¸”ä¸€å®šè¦é…ç½®sudoå…å¯†ã€‚ä»¥åˆ›å»º dolphinscheduler ç”¨æˆ·ä¸ºä¾‹ #1.åˆ›å»ºç”¨æˆ· useradd dolphinscheduler #2.è®¾ç½®å¯†ç  echo \"dolphinscheduler\" | passwd --stdin dolphinscheduler #3.é…ç½®sudoå…å¯† sed -i '$adolphinscheduler ALL=(ALL) NOPASSWD: NOPASSWD: ALL' /etc/sudoers #4.ä¿®æ”¹ç›®å½•æƒé™ï¼Œä½¿å¾—éƒ¨ç½²ç”¨æˆ·å¯¹dolphinscheduler-binç›®å½•æœ‰æ“ä½œæƒé™ chown -R dolphinscheduler:dolphinscheduler dolphinscheduler-bin æ³¨æ„ï¼š å› ä¸ºä»»åŠ¡æ‰§è¡ŒæœåŠ¡æ˜¯ä»¥ sudo -u {linux-user} åˆ‡æ¢ä¸åŒlinuxç”¨æˆ·çš„æ–¹å¼æ¥å®ç°å¤šç§Ÿæˆ·è¿è¡Œä½œä¸šï¼Œæ‰€ä»¥éƒ¨ç½²ç”¨æˆ·éœ€è¦æœ‰ sudo æƒé™ï¼Œè€Œä¸”æ˜¯å…å¯†çš„ã€‚åˆå­¦ä¹ è€…ä¸ç†è§£çš„è¯ï¼Œå®Œå…¨å¯ä»¥æš‚æ—¶å¿½ç•¥è¿™ä¸€ç‚¹ å¦‚æœå‘ç° /etc/sudoers æ–‡ä»¶ä¸­æœ‰\"Default requiretty\"è¿™è¡Œï¼Œä¹Ÿè¯·æ³¨é‡Šæ‰ å¦‚æœç”¨åˆ°èµ„æºä¸Šä¼ çš„è¯ï¼Œè¿˜éœ€è¦ç»™è¯¥éƒ¨ç½²ç”¨æˆ·åˆ†é…æ“ä½œæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæˆ–è€…HDFSæˆ–è€…MinIOçš„æƒé™ 2.3.4 sshå…å¯†é…ç½® åˆ‡æ¢åˆ°éƒ¨ç½²ç”¨æˆ·å¹¶é…ç½®sshæœ¬æœºå…å¯†ç™»å½• su - dolphinscheduler ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys chmod 600 ~/.ssh/authorized_keys æ³¨æ„ï¼šæ­£å¸¸è®¾ç½®åï¼Œdolphinschedulerç”¨æˆ·åœ¨æ‰§è¡Œå‘½ä»¤ssh localhost æ˜¯ä¸éœ€è¦å†è¾“å…¥å¯†ç çš„ 2.3.5 æ•°æ®åº“åˆå§‹åŒ– ä»¥ä¸‹æ“ä½œä¸ºåˆ›å»ºæ•°æ®åº“ dolphinschedulerï¼Œæˆæƒç”¨æˆ· dol å¯¹æ•°æ®åº“ dolphinscheduleræœ‰æ‰€æœ‰æƒé™ï¼Œå¯†ç æ˜¯ dol #åˆ›å»ºæ•°æ®åº“ mysql -uroot -e \"CREATE DATABASE dolphinscheduler DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci\" #æˆæƒ mysql -uroot -e \"GRANT ALL PRIVILEGES ON dolphinscheduler.* TO 'dol'@'%' IDENTIFIED BY 'dol'\" mysql -uroot -e \"GRANT ALL PRIVILEGES ON dolphinscheduler.* TO 'dol'@'localhost' IDENTIFIED BY 'dol'\" #åˆ·æ–°æƒé™è¡¨ mysql -uroot -e \"flush privileges\" æœ¬æ–‡é€‰æ‹©çš„æ˜¯mysqlï¼Œå› æ­¤éœ€è¦ä¸‹è½½mysqlé©±åŠ¨ï¼Œå¹¶æ”¾äº dolphinscheduler-bin/lib ä¸‹ mysqlé©±åŠ¨å®˜æ–¹ä¸‹è½½åœ°å€ #1.ä¸‹è½½mysqlé©±åŠ¨åŒ… wget https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-5.1.47.tar.gz #2.è§£å‹ç¼© tar xf mysql-connector-java-5.1.47.tar.gz #3.æ‹·è´é©±åŠ¨åŒ… cp mysql-connector-java-5.1.47/mysql-connector-java-5.1.47.jar dolphinscheduler-bin/lib/ ä¿®æ”¹ conf/datasource.properties ä¸­çš„é…ç½® æ³¨é‡Šå¦‚ä¸‹å†…å®¹ # postgresql spring.datasource.driver-class-name=org.postgresql.Driver spring.datasource.url=jdbc:postgresql://localhost:5432/dolphinscheduler spring.datasource.username=test spring.datasource.password=test ä¿®æ”¹ä¸ºå¦‚ä¸‹ spring.datasource.driver-class-name=com.mysql.jdbc.Driver spring.datasource.url=jdbc:mysql://localhost:3306/dolphinscheduler?useUnicode=true&characterEncoding=UTF-8&allowMultiQueries=true spring.datasource.username=dol spring.datasource.password=dol #ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¿®æ”¹ åˆ›å»ºè¡¨åŠå¯¼å…¥åŸºç¡€æ•°æ® #ç¼–è¾‘hostsæ–‡ä»¶ï¼Œå¦åˆ™æ‰§è¡Œè„šæœ¬ä¼šæŠ¥é”™ï¼Œè¿™é‡Œæœ€å°‘ä¿è¯èƒ½è§£æds1 cat >> /etc/hosts 2.3.6 ä¿®æ”¹è¿è¡Œå‚æ•° ä¿®æ”¹ conf/env/dolphinscheduler_env.sh ç¯å¢ƒå˜é‡(ä»¥ç›¸å…³ç”¨åˆ°çš„è½¯ä»¶éƒ½å®‰è£…åœ¨/opt/softä¸‹ä¸ºä¾‹)ï¼Œè¯·æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹ export HADOOP_HOME=/opt/soft/hadoop export HADOOP_CONF_DIR=/opt/soft/hadoop/etc/hadoop #export SPARK_HOME1=/opt/soft/spark1 export SPARK_HOME2=/opt/soft/spark2 export PYTHON_HOME=/opt/soft/python export JAVA_HOME=/opt/soft/java export HIVE_HOME=/opt/soft/hive export FLINK_HOME=/opt/soft/flink export DATAX_HOME=/opt/soft/datax/bin/datax.py export PATH=$HADOOP_HOME/bin:$SPARK_HOME2/bin:$PYTHON_HOME:$JAVA_HOME/bin:$HIVE_HOME/bin:$PATH:$FLINK_HOME/bin:$DATAX_HOME:$PATH æ³¨: è¿™ä¸€æ­¥éå¸¸é‡è¦,ä¾‹å¦‚ JAVA_HOME å’Œ PATH æ˜¯å¿…é¡»è¦é…ç½®çš„ï¼Œæ²¡æœ‰ç”¨åˆ°çš„å¯ä»¥å¿½ç•¥æˆ–è€…æ³¨é‡Šæ‰ ä¿®æ”¹ä¸€é”®éƒ¨ç½²é…ç½®æ–‡ä»¶ conf/config/install_config.confä¸­çš„å„å‚æ•°ï¼Œç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å‚æ•°çš„é…ç½®ï¼Œæ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹ # è¿™é‡Œå¡« mysql or postgresql dbtype=\"mysql\" # æ•°æ®åº“è¿æ¥åœ°å€ dbhost=\"localhost:3306\" # æ•°æ®åº“å dbname=\"dolphinscheduler\" # æ•°æ®åº“ç”¨æˆ·åï¼Œæ­¤å¤„éœ€è¦ä¿®æ”¹ä¸ºä¸Šé¢è®¾ç½®çš„{user}å…·ä½“å€¼ username=\"xxx\" # æ•°æ®åº“å¯†ç , å¦‚æœæœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œè¯·ä½¿ç”¨\\è½¬ä¹‰ï¼Œéœ€è¦ä¿®æ”¹ä¸ºä¸Šé¢è®¾ç½®çš„{password}å…·ä½“å€¼ password=\"xxx\" #Zookeeperåœ°å€ï¼Œå•æœºæœ¬æœºæ˜¯localhost:2181ï¼Œè®°å¾—æŠŠ2181ç«¯å£å¸¦ä¸Š zkQuorum=\"localhost:2181\" #å°†DSå®‰è£…åˆ°å“ªä¸ªç›®å½•ï¼Œå¦‚: /opt/soft/dolphinschedulerï¼Œä¸åŒäºç°åœ¨çš„ç›®å½• installPath=\"/opt/soft/dolphinscheduler\" #ä½¿ç”¨å“ªä¸ªç”¨æˆ·éƒ¨ç½²ï¼Œä½¿ç”¨ç¬¬3èŠ‚åˆ›å»ºçš„ç”¨æˆ· deployUser=\"dolphinscheduler\" # é‚®ä»¶é…ç½®ï¼Œä»¥qqé‚®ç®±ä¸ºä¾‹ # é‚®ä»¶åè®® mailProtocol=\"SMTP\" # é‚®ä»¶æœåŠ¡åœ°å€ mailServerHost=\"smtp.qq.com\" # é‚®ä»¶æœåŠ¡ç«¯å£ mailServerPort=\"25\" # mailSenderå’ŒmailUseré…ç½®æˆä¸€æ ·å³å¯ # å‘é€è€… mailSender=\"xxx@qq.com\" # å‘é€ç”¨æˆ· mailUser=\"xxx@qq.com\" # é‚®ç®±å¯†ç  mailPassword=\"xxx\" # TLSåè®®çš„é‚®ç®±è®¾ç½®ä¸ºtrueï¼Œå¦åˆ™è®¾ç½®ä¸ºfalse starttlsEnable=\"true\" # å¼€å¯SSLåè®®çš„é‚®ç®±é…ç½®ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseã€‚æ³¨æ„: starttlsEnableå’ŒsslEnableä¸èƒ½åŒæ—¶ä¸ºtrue sslEnable=\"false\" # é‚®ä»¶æœåŠ¡åœ°å€å€¼ï¼Œå‚è€ƒä¸Šé¢ mailServerHost sslTrust=\"smtp.qq.com\" # ä¸šåŠ¡ç”¨åˆ°çš„æ¯”å¦‚sqlç­‰èµ„æºæ–‡ä»¶ä¸Šä¼ åˆ°å“ªé‡Œï¼Œå¯ä»¥è®¾ç½®ï¼šHDFS,S3,NONEï¼Œå•æœºå¦‚æœæƒ³ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œè¯·é…ç½®ä¸ºHDFSï¼Œå› ä¸ºHDFSæ”¯æŒæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼›å¦‚æœä¸éœ€è¦èµ„æºä¸Šä¼ åŠŸèƒ½è¯·é€‰æ‹©NONEã€‚å¼ºè°ƒä¸€ç‚¹ï¼šä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸éœ€è¦éƒ¨ç½²hadoop resourceStorageType=\"HDFS\" # è¿™é‡Œä»¥ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ #æ³¨ï¼šä½†æ˜¯å¦‚æœä½ æƒ³ä¸Šä¼ åˆ°HDFSçš„è¯ï¼ŒNameNodeå¯ç”¨äº†HAï¼Œåˆ™éœ€è¦å°†hadoopçš„é…ç½®æ–‡ä»¶core-site.xmlå’Œhdfs-site.xmlæ”¾åˆ°confç›®å½•ä¸‹ï¼Œæœ¬ä¾‹å³æ˜¯æ”¾åˆ°/opt/dolphinscheduler/confä¸‹é¢ï¼Œå¹¶é…ç½®namenode clusteråç§°ï¼›å¦‚æœNameNodeä¸æ˜¯HA,åˆ™ä¿®æ”¹ä¸ºå…·ä½“çš„ipæˆ–è€…ä¸»æœºåå³å¯ defaultFS=\"file:///data/dolphinscheduler\" #hdfs://{å…·ä½“çš„ip/ä¸»æœºå}:8020 # å¦‚æœæ²¡æœ‰ä½¿ç”¨åˆ°Yarn,ä¿æŒä»¥ä¸‹é»˜è®¤å€¼å³å¯ï¼›å¦‚æœResourceManageræ˜¯HAï¼Œåˆ™é…ç½®ä¸ºResourceManagerèŠ‚ç‚¹çš„ä¸»å¤‡ipæˆ–è€…hostname,æ¯”å¦‚\"192.168.xx.xx,192.168.xx.xx\";å¦‚æœæ˜¯å•ResourceManagerè¯·é…ç½®yarnHaIps=\"\"å³å¯ yarnHaIps=\"192.168.xx.xx,192.168.xx.xx\" # å¦‚æœResourceManageræ˜¯HAæˆ–è€…æ²¡æœ‰ä½¿ç”¨åˆ°Yarnä¿æŒé»˜è®¤å€¼å³å¯ï¼›å¦‚æœæ˜¯å•ResourceManagerï¼Œè¯·é…ç½®çœŸå®çš„ResourceManagerä¸»æœºåæˆ–è€…ip singleYarnIp=\"yarnIp1\" # èµ„æºä¸Šä¼ æ ¹è·¯å¾„,æ”¯æŒHDFSå’ŒS3,ç”±äºhdfsæ”¯æŒæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œéœ€è¦ç¡®ä¿æœ¬åœ°æ–‡ä»¶å¤¹å­˜åœ¨ä¸”æœ‰è¯»å†™æƒé™ resourceUploadPath=\"/data/dolphinscheduler\" # å…·å¤‡æƒé™åˆ›å»ºresourceUploadPathçš„ç”¨æˆ· hdfsRootUser=\"hdfs\" #åœ¨å“ªäº›æœºå™¨ä¸Šéƒ¨ç½²DSæœåŠ¡ï¼Œæœ¬æœºé€‰localhost ips=\"localhost\" #sshç«¯å£,é»˜è®¤22 sshPort=\"22\" #masteræœåŠ¡éƒ¨ç½²åœ¨å“ªå°æœºå™¨ä¸Š masters=\"localhost\" #workeræœåŠ¡éƒ¨ç½²åœ¨å“ªå°æœºå™¨ä¸Š,å¹¶æŒ‡å®šæ­¤workerå±äºå“ªä¸€ä¸ªworkerç»„,ä¸‹é¢ç¤ºä¾‹çš„defaultå³ä¸ºç»„å workers=\"localhost:default\" #æŠ¥è­¦æœåŠ¡éƒ¨ç½²åœ¨å“ªå°æœºå™¨ä¸Š alertServer=\"localhost\" #åç«¯apiæœåŠ¡éƒ¨ç½²åœ¨åœ¨å“ªå°æœºå™¨ä¸Š apiServers=\"localhost\" æ³¨ï¼šå¦‚æœæ‰“ç®—ç”¨åˆ°èµ„æºä¸­å¿ƒåŠŸèƒ½ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š sudo mkdir /data/dolphinscheduler sudo chown -R dolphinscheduler:dolphinscheduler /data/dolphinscheduler 2.3.7 ä¸€é”®éƒ¨ç½² åˆ‡æ¢åˆ°éƒ¨ç½²ç”¨æˆ· dolphinschedulerï¼Œæ‰§è¡Œä¸€é”®éƒ¨ç½²è„šæœ¬ su - dolphinscheduler && cd /opt/dolphinscheduler-bin/ && sh install.sh éªŒè¯å®‰è£…ï¼Œä½¿ç”¨å‘½ä»¤ jps æŸ¥çœ‹ï¼Œå¦‚æ˜¾ç¤ºå¦‚ä¸‹æ—¢æˆåŠŸ $ jps 20260 Jps 20037 AlertServer ----- alertæœåŠ¡ 20085 ApiApplicationServer ----- apiæœåŠ¡ 19580 MasterServer ----- masteræœåŠ¡ 19662 WorkerServer ----- workeræœåŠ¡ 19710 LoggerServer ----- loggeræœåŠ¡ éƒ¨ç½²æˆåŠŸåï¼Œå¯ä»¥è¿›è¡Œæ—¥å¿—æŸ¥çœ‹ï¼Œæ—¥å¿—ç»Ÿä¸€å­˜æ”¾äº logs æ–‡ä»¶å¤¹å†… #logsç›®å½•æ˜¯åœ¨dolphinschedulerå®‰è£…ç›®å½•ä¸‹ç”Ÿæˆçš„ï¼Œæˆ‘è¿™é‡Œè®¾ç½®çš„å®‰è£…ç›®å½•æ˜¯/usr/local/dolphinscheduler $ tree logs/ logs/ â”œâ”€â”€ dolphinscheduler-alert.log â”œâ”€â”€ dolphinscheduler-alert-server-test1.out â”œâ”€â”€ dolphinscheduler-api-server.log â”œâ”€â”€ dolphinscheduler-api-server-test1.out â”œâ”€â”€ dolphinscheduler-logger-server-test1.out â”œâ”€â”€ dolphinscheduler-master.log â”œâ”€â”€ dolphinscheduler-master-server-test1.out â”œâ”€â”€ dolphinscheduler-worker.log â””â”€â”€ dolphinscheduler-worker-server-test1.out 2.3.8 è®¿é—® æµè§ˆå™¨è®¿é—® IP:12345/dolphinscheduler ç”¨æˆ·åï¼šadmin å¯†ç ï¼šdolphinscheduler123 ç™»é™†åé¦–ç•Œé¢ åˆ°æ­¤ï¼Œdolphinschedulerå•æœºç‰ˆéƒ¨ç½²å®Œæˆï¼ 2.3.9 å¯åœæœåŠ¡ ä¸€é”®åœæ­¢é›†ç¾¤æ‰€æœ‰æœåŠ¡ sh bin/stop-all.sh ä¸€é”®å¼€å¯é›†ç¾¤æ‰€æœ‰æœåŠ¡ sh bin/start-all.sh å¯åœMaster sh bin/dolphinscheduler-daemon.sh start master-server sh bin/dolphinscheduler-daemon.sh stop master-server å¯åœWorker sh bin/dolphinscheduler-daemon.sh start worker-server sh bin/dolphinscheduler-daemon.sh stop worker-server å¯åœApi sh bin/dolphinscheduler-daemon.sh start api-server sh bin/dolphinscheduler-daemon.sh stop api-server å¯åœLogger sh bin/dolphinscheduler-daemon.sh start logger-server sh bin/dolphinscheduler-daemon.sh stop logger-server å¯åœAlert sh bin/dolphinscheduler-daemon.sh start alert-server sh bin/dolphinscheduler-daemon.sh stop alert-server dolphinschedulerä½¿ç”¨æ–‡æ¡£ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/big-data/Ambari/CentOS7ä¸­ç”¨Ambariå¿«é€Ÿæ­å»ºå¤§æ•°æ®å¹³å°.html":{"url":"linux/big-data/Ambari/CentOS7ä¸­ç”¨Ambariå¿«é€Ÿæ­å»ºå¤§æ•°æ®å¹³å°.html","title":"Ambariå¹³å°æ­å»º","keywords":"","body":"CentOS7ä¸­ç”¨Ambariå¿«é€Ÿæ­å»ºå¤§æ•°æ®å¹³å° å…¬å¸çš„äº§å“æ˜¯åŸºäºå¤§æ•°æ®å¹³å°çš„ï¼Œè¿‘æœŸè¦åšå…¬å¸äº§å“ç§æœ‰åŒ–éƒ¨ç½²ï¼Œå› æ­¤å­¦ä¹ ä¸€ä¸‹ Ambari æœ¬æ–‡å‚è€ƒåœ°å€ åŸæ–‡é“¾æ¥ ä¸€ã€Ambariç®€ä»‹ Ambariå®˜ç½‘ Ambari githubåœ°å€ Ambariæ˜¯ä»€ä¹ˆ Ambari æ˜¯åˆ›å»ºã€ç®¡ç†ã€ç›‘è§† Hadoop çš„é›†ç¾¤çš„è½¯ä»¶ã€‚è¿™é‡Œçš„ Hadoop æ˜¯å¹¿ä¹‰ï¼ŒæŒ‡çš„æ˜¯ Hadoop æ•´ä¸ªç”Ÿæ€åœˆï¼ˆä¾‹å¦‚ Hiveï¼ŒHbaseï¼ŒSqoopï¼ŒZookeeper ï¼ŒSpark ï¼ŒFlink ï¼ŒFlume ï¼ŒOozie ç­‰ï¼‰ï¼Œè€Œå¹¶ä¸ä»…æ˜¯ç‰¹æŒ‡ Hadoopã€‚ç”¨ä¸€å¥è¯æ¥è¯´ï¼ŒAmbari å°±æ˜¯ä¸ºäº†è®© Hadoop ä»¥åŠç›¸å…³çš„å¤§æ•°æ®è½¯ä»¶æ›´å®¹æ˜“ä½¿ç”¨çš„ä¸€ä¸ªå·¥å…·ã€‚ Ambari ç°åœ¨æ‰€æ”¯æŒçš„å¹³å°ç»„ä»¶ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œä¾‹å¦‚æµè¡Œçš„ Sparkï¼ŒStorm ç­‰è®¡ç®—æ¡†æ¶ï¼Œä»¥åŠèµ„æºè°ƒåº¦å¹³å° YARN ç­‰ï¼Œæˆ‘ä»¬éƒ½èƒ½è½»æ¾åœ°é€šè¿‡ Ambari æ¥è¿›è¡Œéƒ¨ç½²ï¼Œä¸ºæƒ³æ„å»ºå¤§æ•°æ®å¹³å°çš„åˆå­¦è€…æä¾›äº†å¾ˆå¤§çš„ä¾¿æ·ã€‚ Ambari è‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ¶æ„çš„è½¯ä»¶ï¼Œä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šAmbari Server å’Œ Ambari Agentã€‚ç®€å•æ¥è¯´ï¼Œç”¨æˆ·é€šè¿‡ Ambari Server é€šçŸ¥ Ambari Agent å®‰è£…å¯¹åº”çš„è½¯ä»¶ï¼›Agent ä¼šå®šæ—¶åœ°å‘é€å„ä¸ªæœºå™¨æ¯ä¸ªè½¯ä»¶æ¨¡å—çš„çŠ¶æ€ç»™ Ambari Serverï¼Œæœ€ç»ˆè¿™äº›çŠ¶æ€ä¿¡æ¯ä¼šå‘ˆç°åœ¨ Ambari çš„ GUIï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£åˆ°é›†ç¾¤çš„å„ç§çŠ¶æ€ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„ç»´æŠ¤ã€‚ Ambariå®‰è£…è¯´æ˜ Ambariç±»ä¼¼äºAnsibleï¼Œå¹¶æ²¡æœ‰æ˜ç¡®çš„ master/slave ä¹‹åˆ† äºŒã€ç¯å¢ƒå‡†å¤‡ 2.0 å®‰è£…çº¯å‡€ç³»ç»Ÿåæ‰§è¡Œçš„è„šæœ¬ #!/usr/bin/env bash # #ä¿®æ”¹ç³»ç»Ÿyumæºä¸ºaliyunå¹¶æ·»åŠ epelæº mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak [ ! -e /etc/yum.repos.d/CentOS-Base.repo ] && curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo && sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo [ ! -e /etc/yum.repos.d/epel.repo ] && curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo yum makecache yum -y install tar wget net-tools git vim tree lrzsz htop iftop iotop psmisc python36 python3-devel zlib zlib-devel gcc gcc-c++ conntrack-tools jq socat bash-completion telnet nload strace tcpdump lsof sysstat #å…³é—­é˜²ç«å¢™ã€selinuxã€NetworkManager systemctl disable firewalld NetworkManager sed -i '7s/enforcing/disabled/' /etc/selinux/config #åŒæ­¥æ—¶é—´è®¡åˆ’ä»»åŠ¡ ç”±äºåç»­è¦ç”¨åˆ°ntpserverï¼Œå› æ­¤ntpdateé€‰æ‹©ä¸æ‰§è¡Œ #sed -i '/*\\/10 \\* \\* \\* \\* \\/usr\\/sbin\\/ntpdate ntp2\\.aliyun\\.com &>\\/dev\\/null/d' /var/spool/cron/root #echo \"*/10 * * * * /usr/sbin/ntpdate ntp2.aliyun.com &>/dev/null\" >>/var/spool/cron/root #å†å²å‘½ä»¤æ˜¾ç¤ºæ—¶é—´ sed -i '/HISTFILESIZE=2000/d' /etc/bashrc sed -i '/HISTSIZE=2000/d' /etc/bashrc sed -i '/HISTTIMEFORMAT=\"%Y-%m-%d %H:%M:%S \"/d' /etc/bashrc sed -i '/export HISTTIMEFORMAT/d' /etc/bashrc cat >>/etc/bashrc>/etc/security/limits.conf~/.pip/pip.conf 2.1 å®éªŒç¯å¢ƒ è§’è‰² IPåœ°å€ ä¸»æœºå ambariç‰ˆæœ¬ ç¡¬ä»¶é…ç½® ç³»ç»Ÿ å†…æ ¸ master 10.0.0.136 ambari-server01.test.com 2.6.2.2 2c8g CentOS7.8 3.10.0-1127.el7.x86_64 slave 10.0.0.137 ambari-agent01.test.com 2.6.2.2 2c8g CentOS7.8 3.10.0-1127.el7.x86_64 slave 10.0.0.138 ambari-agent02.test.com 2.6.2.2 2c8g CentOS7.8 3.10.0-1127.el7.x86_64 2.2 é…ç½®sshå…å¯† âš ï¸å¦‚æ— ç‰¹æ®Šè¯´æ˜ï¼Œä»¥ä¸‹æ“ä½œå‡åœ¨ ambari-server01 èŠ‚ç‚¹ 2.2.1 ç¼–è¾‘ç¯å¢ƒå˜é‡æ–‡ä»¶ ç¯å¢ƒå˜é‡æ–‡ä»¶ä¸­IPã€ä¸»æœºåã€å­ç½‘ç½‘æ®µå¯è‡ªè¡Œä¿®æ”¹ [ -d /opt/ambari/script ] || mkdir -p /opt/ambari/script && cd /opt/ambari/script cat > env.sh 2.2.2 ç”Ÿæˆå¯†é’¥å¯¹ ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa &>/dev/null 2.2.3 ç¼–è¾‘expectè‡ªåŠ¨åŒ–äº¤äº’è„šæœ¬ è¿™é‡Œæœºå™¨ç”¨æˆ·åæ˜¯rootï¼Œå¯†ç æ˜¯å›½é™…æ ‡å‡†é€šç”¨å¯†ç 1ï¼Œsshç«¯å£22 âš ï¸æ‰§è¡Œè·¯å¾„åœ¨ /opt/ambari/script cat > ssh.exp 2.2.4 ç¼–è¾‘shellè„šæœ¬å¾ªç¯æ‰§è¡Œexpectè„šæœ¬ #ç¼–è¾‘è„šæœ¬ source env.sh cat > ssh.sh 2.3 æ¯ä¸ªèŠ‚ç‚¹é…ç½®hostsä¿¡æ¯ source /opt/ambari/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} \"cat >> /etc/hosts 2.4 ç¦ç”¨é˜²ç«å¢™å’Œselinux è¿™ä¸€æ­¥å·²åœ¨2.0å®‰è£…çº¯å‡€ç³»ç»Ÿåæ‰§è¡Œçš„è„šæœ¬ä¸­æ‰§è¡Œè¿‡äº† #ç¦ç”¨é˜²ç«å¢™ systemctl stop firewalld && systemctl disable firewalld #ç¦ç”¨selinux ä¸´æ—¶ä¿®æ”¹ setenforce 0 #ç¦ç”¨selinux æ°¸ä¹…ä¿®æ”¹ï¼Œé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆ sed -i '7s/enforcing/disabled/' /etc/selinux/config 2.5 å®‰è£…JDK8 2.5.1 å®‰è£…è¯´æ˜ âš ï¸âš ï¸âš ï¸é›†ç¾¤ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦å®‰è£…jdk âš ï¸jdkéœ€è¦ç™»é™†åˆ° oracle å®˜ç½‘æ‰å¯ä»¥ä¸‹è½½ï¼Œè¿™é‡Œä¸‹è½½çš„æ˜¯ç‰ˆæœ¬æ˜¯ jdk-8u251 jdkå®‰è£…åŒ…ä¸‹è½½è‡³ /opt/ambari/pkg jdkå®˜æ–¹ä¸‹è½½åœ°å€ mkdir -p /opt/ambari/pkg 2.5.2 ç¼–å†™jdkå®‰è£…è„šæœ¬ cat >/opt/ambari/script/jdk8_install.sh /etc/profile.d/jdk8.sh 2.5.3 æ‹·è´jdkå®‰è£…åŒ…å’Œjdkå®‰è£…è„šæœ¬åˆ°å…¶ä½™èŠ‚ç‚¹ source /opt/ambari/script/env.sh export NODE_IPS=(${NODE_IPS[1]} ${NODE_IPS[2]}) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp ${NODE_NAMES}:/opt/ambari/script/jdk8_install.sh /opt/ambari/pkg/jdk-8u251-linux-x64.tar.gz ${node_ip}:/tmp done 2.5.4 æ‰§è¡Œjdkå®‰è£…è„šæœ¬ âš ï¸è¿™ä¸ªæœ‰é—®é¢˜ï¼ï¼ï¼ source /opt/ambari/script/env.sh export NODE_IPS=(${NODE_IPS[1]} ${NODE_IPS[2]}) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'source /tmp/jdk8_install.sh' done 2.6 é…ç½®æ—¶é—´åŒæ­¥ æ—¶é—´åŒæ­¥å¯é€‰ ntp å’Œ chronyï¼Œè¿™é‡Œé€‰æ‹© chrony ntpå®˜ç½‘ chronyå®˜ç½‘ âš ï¸sedä¸­æœ‰å˜é‡æ›¿æ¢ï¼Œéœ€è¦ä½¿ç”¨åŒå¼•å· è¿™é‡Œæœ‰é—®æœªè§£å†³ï¼ï¼ï¼ #å„èŠ‚ç‚¹å®‰è£…chrony source /opt/ambari/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} yum -y install chrony done #ä¿®æ”¹æœåŠ¡å™¨åœ°å€ä¸ºé˜¿é‡Œäº‘ source /opt/ambari/script/env.sh sed -i.bak '3,6d' /etc/chrony.conf && sed -i -e '3cserver ntp1.aliyun.com iburst' -e \"/^#allow/callow ${NODE_SUBNET}\" /etc/chrony.conf #nodeèŠ‚ç‚¹ä¿®æ”¹åŒæ­¥æœåŠ¡å™¨ä¸ºmasterèŠ‚ç‚¹ #è¿™é‡Œé€‰æ‹©å¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹æ‰§è¡Œ source /opt/ambari/script/env.sh export NODE_IPS=(${NODE_IPS[1]} ${NODE_IPS[2]}) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} sed -i.bak '3,6d' /etc/chrony.conf && sed -i \"3cserver ${NODE_NAMES[0]} iburst\" /etc/chrony.conf done #å¯åŠ¨chronydæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ source /opt/ambari/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'systemctl enable chronyd && systemctl start chronyd' done #æ£€æŸ¥ç«¯å£ï¼Œchronydç›‘å¬udp323ç«¯å£ source /opt/ambari/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} netstat -nupl|grep chronyd done #æ£€æŸ¥åŒæ­¥ source /opt/ambari/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} chronyc sources done 2.7 å®‰è£…HTTPæœåŠ¡å™¨ httpdå®˜ç½‘ è¯´æ˜ è¿™é‡Œå®‰è£… HTTP ä¸»è¦ä½œç”¨åœ¨ä¸ºåæœŸå®‰è£… ambari åˆ¶ä½œæœ¬åœ°æºæ—¶å€™ç”¨çš„ CentOS7.8é»˜è®¤çš„httpdç‰ˆæœ¬æ˜¯2.4.6 yum -y install httpd systemctl enable httpd && systemctl start httpd 2.8 å®‰è£…mysql âš ï¸âš ï¸âš ï¸ äºŒè¿›åˆ¶å®‰è£…çš„mysqlå¯åŠ¨è„šæœ¬ /etc/init.d/mysql å’Œ å®‰è£…ç›®å½•/mysql/bin/mysqld_safe è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­éƒ½æ˜¯é»˜è®¤åœ¨ /usr/local/mysqlï¼Œå¦‚æœå®‰è£…ç›®å½•ä¸åœ¨ /usr/local/ ä¸‹ï¼Œéœ€è¦ä¿®æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„è·¯å¾„ï¼Œå³æŠŠ /usr/local æ›¿æ¢ä¸ºmysqlå®‰è£…ç›®å½• sed -i 's#/usr/local#ä½ çš„mysqlå®‰è£…ç›®å½•#g' /etc/init.d/mysql /ä½ çš„mysqlå®‰è£…ç›®å½•/mysql/bin/mysqld_safe 2.8.1 ä¸‹è½½äºŒè¿›åˆ¶åŒ… mysqlå®˜æ–¹ä¸‹è½½åœ°å€ mysql5.7.30 md5å€¼ 611be3b18a30498b705db773293ad341 wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.30-linux-glibc2.12-x86_64.tar.gz 2.8.2 è§£å‹ç¼©mysqläºŒè¿›åˆ¶åŒ…åˆ°/usr/local tar xf mysql-5.7.30-linux-glibc2.12-x86_64.tar.gz -C /usr/local 2.8.3 ä¿®æ”¹åç§°ã€åšè½¯è¿æ¥ mv /usr/local/mysql-5.7.30-linux-glibc2.12-x86_64 /usr/local/mysql-5.7.30 && ln -s /usr/local/mysql-5.7.30 /usr/local/mysql 2.8.4 åˆ›å»ºmysqlç”¨æˆ· useradd -M -s /bin/nologin mysql 2.8.5 ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶ï¼Œmyql-5.7.30äºŒè¿›åˆ¶åŒ…é»˜è®¤æ²¡æœ‰mysqlé…ç½®æ–‡ä»¶ âš ï¸å¦‚æœæŒ‡å®šäº†mysqlçš„socketæ–‡ä»¶ä½ç½®ï¼Œåˆ™å¿…é¡»æ·»åŠ [client]æ ‡ç­¾å¹¶åŒæ—¶æŒ‡å®šsocketæ–‡ä»¶ä½ç½®ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šé»˜è®¤ä» /tmpä¸‹æ‰¾socketæ–‡ä»¶ #å¤‡ä»½/etc/my.cnf mv /etc/my.cnf /etc/my.cnf.old #ä»¥ä¸‹é…ç½®ä¸ºæœ€ç²¾ç®€ç‰ˆï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œç›¸åº”è®¾ç½® cat >> /etc/my.cnf 2.8.6 åˆ›å»ºsockeræ–‡ä»¶ç›®å½•ã€ç›®å½•æ–‡ä»¶æˆæƒ âš ï¸âš ï¸âš ï¸å¦‚æœmysqlé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†socketæ–‡ä»¶ç›®å½•ï¼Œåˆ™è¿™ä¸ªç›®å½•çš„æƒé™å¿…é¡»æ˜¯mysqlï¼Œå¦åˆ™mysqlä¼šå¯åŠ¨å¤±è´¥ mkdir -p /var/lib/mysql chown -R mysql.mysql /usr/local/mysql* /var/lib/mysql chown mysql.mysql /etc/my.cnf 2.8.7 æ‹·è´å¯åŠ¨è„šæœ¬ cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld 2.8.8 åˆå§‹åŒ–mysql âš ï¸âš ï¸âš ï¸mysql-5.7.22åˆå§‹åŒ–æ²¡æœ‰æç¤ºï¼ï¼ï¼ /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data å‚æ•°è¯´æ˜ å‚æ•° è¯´æ˜ --user æŒ‡å®šmysqlç”¨æˆ· --basedir æŒ‡å®šmysqlå®‰è£…ç›®å½• --datadir æŒ‡å®šmysqlæ•°æ®ç›®å½• --initialize-insecure ä¸ç”Ÿæˆéšæœºå¯†ç  2.8.9 æ·»åŠ mysqlå‘½ä»¤ç¯å¢ƒå˜é‡ #å¯¼å‡ºmysqlå‘½ä»¤ç¯å¢ƒå˜é‡ echo \"export PATH=/usr/local/mysql/bin:$PATH\" > /etc/profile.d/mysql.sh #ä½¿é…ç½®ç”Ÿæ•ˆ source /etc/profile 2.8.10 é…ç½®systemdç®¡ç†mysql cat >> /etc/systemd/system/mysqld.service 2.8.11 å¯åŠ¨mysqlã€æ£€æŸ¥å¯åŠ¨ #é‡æ–°åŠ è½½systemdç³»ç»ŸæœåŠ¡ systemctl daemon-reload #å¯åŠ¨mysqlå¹¶åŠ å…¥å¼€æœºè‡ªå¯ systemctl start mysqld && systemctl enable mysqld #æŸ¥çœ‹mysqlç«¯å£ $ netstat -ntpl | grep 3306 tcp6 0 0 :::3306 :::* LISTEN 31349/mysqld 2.8.12 åˆ›å»ºambariæ•°æ®åº“åŠæˆæƒ mysql -uroot -e \"create database ambari character set utf8mb4\" mysql -uroot -e \"grant all on ambari.* to ambari@'localhost' identified by 'ambari'\" mysql -uroot -e \"grant all on ambari.* to ambari@'%' identified by 'ambari'\" mysql -uroot -e \"flush privileges\" ä¸‰ã€å®‰è£…ambari 3.1 åˆ¶ä½œambariæœ¬åœ°æº å„åŒ…å¤§å° HDP-2.6.5.0-centos7-rpm.tar.gz 6.8G ambari-2.6.2.2-centos7.tar.gz 1.7G HDP-UTILS-1.1.0.22-centos7.tar.gz 87M ä¸‹è½½ ambari ã€HDP-UTILSã€ HDP åŒ… å®˜æ–¹ä¸‹è½½åœ°å€ï¼Œå¯ä»¥ä»è¿™é‡Œä¸‹è½½ä¸åŒç‰ˆæœ¬çš„åŒ… mkdir /opt/ambari/yum && cd /opt/ambari/yum wget http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.6.2.2/ambari-2.6.2.2-centos7.tar.gz wget http://public-repo-1.hortonworks.com/HDP/centos7/2.x/updates/2.6.5.0/HDP-2.6.5.0-centos7-rpm.tar.gz wget http://public-repo-1.hortonworks.com/HDP-UTILS-1.1.0.22/repos/centos7/HDP-UTILS-1.1.0.22-centos7.tar.gz å°†3ä¸ªå‹ç¼©åŒ…è§£å‹è‡³ /var/www/html/ambari mkdir /var/www/html/ambari tar xf ambari-2.6.2.2-centos7.tar.gz -C /var/www/html/ambari tar xf HDP-UTILS-1.1.0.22-centos7.tar.gz -C /var/www/html/ambari tar xf HDP-2.6.5.0-centos7-rpm.tar.gz -C /var/www/html/ambari 3.2 å®‰è£…åˆ¶ä½œæœ¬åœ°yumæºå·¥å…· yum -y install yum-utils createrepo 3.3 åˆ›å»ºambariã€HDPã€HDP-UTILSçš„repoä»“åº“ âš ï¸å¦‚æœä¸‹è½½çš„ç‰ˆæœ¬ä¸åŒï¼Œåˆ™éœ€è¦ä¿®æ”¹ baseurlå’Œgpgcheckä¸­çš„urlè·¯å¾„ 3.3.1 åˆ›å»ºambariçš„repoä»“åº“ source /opt/ambari/script/env.sh cat > /etc/yum.repos.d/ambari.repo 3.3.2 åˆ›å»ºHDPã€HDP-UTILSçš„repoä»“åº“ cat > /etc/yum.repos.d/hdp.repo 3.3.3 ç”Ÿæˆæœ¬åœ°ç¼“å­˜ yum clean all && yum makecache 3.3.4 é€šè¿‡æœ¬åœ°æºå®‰è£…ambari âš ï¸æ‰§è¡Œæ­¤å‘½ä»¤ä¼šå®‰è£… ambari2.6.2.2 å’Œ pg9.2.24 yum -y install ambari-server å››ã€é…ç½®ambari 4.1 ä¸‹è½½mysqlé©±åŠ¨ mysqlé©±åŠ¨å®˜æ–¹ä¸‹è½½åœ°å€ ç”±äºä½¿ç”¨çš„æ˜¯mysql5.7ï¼Œå› æ­¤å¿…é¡»ä¸‹è½½mysql5.7é©±åŠ¨ï¼Œä¸”å¿…é¡»æ”¾äº /usr/share/java ä¸‹ å¦åˆ™åç»­ä¼šæœ‰å¦‚ä¸‹æŠ¥é”™ï¼ŒåŸå› æ˜¯ ambari é»˜è®¤çš„ mysql jdbc é©±åŠ¨ä¸æ”¯æŒ 5.6 ä»¥ä¸Šç‰ˆæœ¬ Configuring ambari database... WARNING: Before starting Ambari Server, you must copy the MySQL JDBC driver JAR file to /usr/share/java and set property \"server.jdbc.driver.path=[path/to/custom_jdbc_driver]\" in ambari.properties. Press to continue. ERROR: Before starting Ambari Server, you must copy the MySQL JDBC driver JAR file to /usr/share/java and set property \"server.jdbc.driver.path=[path/to/custom_jdbc_driver]\" in ambari.properties. ERROR: Exiting with exit code -1. REASON: Before starting Ambari Server, you must copy the MySQL JDBC driver JAR file to /usr/share/java and set property \"server.jdbc.driver.path=[path/to/custom_jdbc_driver]\" in ambari.properties. #åˆ›å»º/usr/share/javaç›®å½• [ -d /usr/share/java ] || mkdir /usr/share/java && cd /usr/share/java #ä¸‹è½½mysqlé©±åŠ¨ wget https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-5.1.46.tar.gz #è§£å‹ç¼©åŒ… tar xf mysql-connector-java-5.1.46.tar.gz #ç§»åŠ¨mysqlé©±åŠ¨åˆ°/usr/share/javaï¼Œä¸”åç§°å¿…é¡»ä¸º mysql-connector-java.jar mv mysql-connector-java-5.1.46/mysql-connector-java-5.1.46.jar /usr/share/java/mysql-connector-java.jar 4.2 å¯åŠ¨é…ç½®ç¨‹åº ambari-server setup 4.2.1 æç¤ºæ˜¯å¦è‡ªå®šä¹‰è®¾ç½® è¾“å…¥ï¼šy Customize user account for ambari-server daemon [y/n] (n)? 4.2.2 è®¾ç½®ambari-server è´¦å· è¾“å…¥ï¼šambari Enter user account for ambari-server daemon (root): 4.2.3 è®¾ç½®JDK è¾“å…¥ï¼š3 Checking JDK... [1] Oracle JDK 1.8 + Java Cryptography Extension (JCE) Policy Files 8 [2] Oracle JDK 1.7 + Java Cryptography Extension (JCE) Policy Files 7 [3] Custom JDK ============================================================================== Enter choice (1): 4.2.4 è®¾ç½®JDKå®¶ç›®å½• è¾“å…¥ï¼š/usr/local/jdk1.8.0_251 jdkçš„å®¶ç›®å½•è·¯å¾„æ˜¯ /usr/local/jdk1.8.0_251 WARNING: JDK must be installed on all hosts and JAVA_HOME must be valid on all hosts. WARNING: JCE Policy files are required for configuring Kerberos security. If you plan to use Kerberos,please make sure JCE Unlimited Strength Jurisdiction Policy Files are valid on all hosts. Path to JAVA_HOME: 4.2.5 æ˜¯å¦å…è®¸AmbariæœåŠ¡å™¨ä¸‹è½½å’Œå®‰è£…GPLè®¸å¯çš„LZOåŒ… è¾“å…¥ï¼šy Enable Ambari Server to download and install GPL Licensed LZO packages [y/n] (n)? 4.2.6 æ•°æ®åº“é…ç½® è¾“å…¥ï¼šy Enter advanced database configuration [y/n] (n)? 4.2.7 é€‰æ‹©æ•°æ®åº“ç±»å‹ è¾“å…¥ï¼š3 è¾“å…¥3é€‰æ‹©mysql Configuring database... ============================================================================== Choose one of the following options: [1] - PostgreSQL (Embedded) [2] - Oracle [3] - MySQL / MariaDB [4] - PostgreSQL [5] - Microsoft SQL Server (Tech Preview) [6] - SQL Anywhere [7] - BDB ============================================================================== Enter choice (1): 4.2.8 æ•°æ®åº“ä¿¡æ¯å¡«å†™ Enter choice (1): 3 Hostname (localhost): #é»˜è®¤å³å¯ Port (3306): #é»˜è®¤3306 Database name (ambari): #è¿™é‡Œæ•°æ®åº“åç§°ä¸ºambari Username (ambari): #æ•°æ®åº“ç”¨æˆ·åæ˜¯ambari Enter Database Password (bigdata): #ç”¨æˆ·ambariçš„å¯†ç æ˜¯ambari Re-enter password: #ç¡®è®¤å¯†ç  Configuring ambari database... 4.2.9 ç»§ç»­é…ç½®è¿œç¨‹æ•°æ®åº“è¿æ¥å±æ€§ è¾“å…¥ï¼šy âš ï¸éœ€è¦å¯¼å…¥ /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sqlåˆ°ambariæ•°æ®åº“ä¸­ WARNING: Before starting Ambari Server, you must run the following DDL against the database to create the schema: /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql Proceed with configuring remote database connection properties [y/n] (y)? æç¤ºå¦‚ä¸‹å³ä¸ºæˆåŠŸ Extracting system views... ambari-admin-2.6.2.2.1.jar ........... Adjusting ambari-server permissions and ownership... Ambari Server 'setup' completed successfully. 4.2.10 å¯¼å…¥æ•°æ®åº“ mysql -uroot -D ambari -e \"source /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql\" 4.3 å¯åŠ¨ambari ambari-server start æç¤ºå¦‚ä¸‹å³ä¸ºæˆåŠŸ Using python /usr/bin/python Starting ambari-server Ambari Server running with administrator privileges. Organizing resource files at /var/lib/ambari-server/resources... Ambari database consistency check started... Server PID at: /var/run/ambari-server/ambari-server.pid Server out at: /var/log/ambari-server/ambari-server.out Server log at: /var/log/ambari-server/ambari-server.log Waiting for server start........................ Server started listening on 8080 DB configs consistency check: no errors and warnings were found. Ambari Server 'start' completed successfully. 4.4 ç™»é™†ambari æµè§ˆå™¨è®¿é—® http://IP:8080 ç™»é™†åé¦–ç•Œé¢ åˆ°æ­¤ï¼Œambariå®‰è£…æˆåŠŸï¼ï¼ï¼ äº”ã€ä½¿ç”¨Ambariç•Œé¢å®‰è£…å¤§æ•°æ®ç»„ä»¶ 5.1 å¯åŠ¨å®‰è£…å‘å¯¼ é€‰æ‹© Launch Install Wizard è¾“å…¥é›†ç¾¤åç§° 5.2 é€‰æ‹©é›†ç¾¤ç‰ˆæœ¬ã€é…ç½®é›†ç¾¤æœ¬åœ°æº è¿™é‡Œé€‰æ‹© HDP-2.6.5.0 ç‰ˆæœ¬ ä¿ç•™ redhat7 ä¸€å¤„ï¼Œåˆ é™¤å…¶ä»– è®¾ç½®HDPå®‰è£…æºï¼Œä¿®æ”¹ä¸ºæœ¬åœ°æº åŸå…ˆé»˜è®¤æº HDP-2.6 http://public-repo-1.hortonworks.com/HDP/centos7/2.x/updates/2.6.5.0 HDP-2.6-GPL http://public-repo-1.hortonworks.com/HDP-GPL/centos7/2.x/updates/2.6.5.0 HDP-UTILS-1.1.0.22 http://public-repo-1.hortonworks.com/HDP-UTILS-1.1.0.22/repos/centos7 HDP-2.6ã€HDP-2.6-GPLã€HDP-UTILS-1.1.0.22 ä¾æ¬¡ä¿®æ”¹ä¸ºå¦‚ä¸‹ http://10.0.0.136/ambari/ambari/centos7/2.6.2.2-1 http://10.0.0.136/ambari/HDP/centos7/2.6.5.0-292 http://10.0.0.136/ambari/HDP-UTILS/centos7/1.1.0.22 ä¿®æ”¹å®Œæˆåç‚¹å‡»ä¸‹ä¸€æ­¥ 5.3 é…ç½®å®‰è£…é€‰é¡¹ 5.3.1 ä¿®æ”¹é…ç½®æ–‡ä»¶ éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­httpsä¸ºhttpï¼Œå¦åˆ™åç»­ä¼šæœ‰ç±»ä¼¼å¦‚ä¸‹æŠ¥é”™ ERROR 2020-09-15 01:34:45,716 NetUtil.py:96-EOF occurred in vic lation of protocol (_ssl.c:618) ERROR 2020-09-15 01:34:45,716 NetUtil.py:97-SSLError:Failed to connect. Please check openssl Library versions. Refer to:https://bugzilla.redhat.com/show_bug.cgi?id=1022468 for more details. 1.ä¿®æ”¹ /etc/python/cert-verification.cfg ä¸­ verify=platform_default ä¸º verify=disable sed -i.bak '/^verify/cverify=disable' /etc/python/cert-verification.cfg 2.ä¿®æ”¹ /etc/ambari-agent/conf/ambari-agent.ini ä¸­ [security] æ ‡ç­¾ååŠ å…¥ä»¥ä¸‹ä¸¤è¡Œå†…å®¹ âš ï¸è¿™ä¸€æ­¥å¿…é¡»åœ¨ Confirm Hosts è¿›è¡Œå®‰è£…åæ‰ä¼šæœ‰ç›¸åº”çš„æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¿›å…¥åˆ° Confirm Hosts è¿™ä¸€æ­¥ä¸­æ³¨å†Œä¸»æœºç¨ç­‰ä¸€ä¼šæ‰å¯ä»¥è¿›è¡Œä¿®æ”¹æ–‡ä»¶æ“ä½œ(ç›®å‰äº†è§£æ˜¯è¿™æ ·ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•) ä¸Šå›¾ç•Œé¢ç¨ç­‰å‡ åç§’ç„¶åå†è¿›è¡Œä»¥ä¸‹æ“ä½œ ssl_verify_cert=0 force_https_protocol=PROTOCOL_TLSv1_2 sed -i.bak -e '/^credential_shell_cmd/assl_verify_cert=0\\nforce_https_protocol=PROTOCOL_TLSv1_2' /etc/ambari-agent/conf/ambari-agent.ini ä»¥ä¸Šä¸¤æ­¥ä¿®æ”¹å®Œæˆåéœ€è¦é‡å¯ ambari-agent ambari-agent restart 5.3.2 é…ç½®é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ è¾“å…¥é›†ç¾¤èŠ‚ç‚¹FQDNå¼ä¸»æœºåã€ambari-serverçš„ç§é’¥ã€ambari-serverçš„ç”¨æˆ·åå’Œsshç«¯å£ å„èŠ‚ç‚¹ hosts ä¿¡æ¯ 10.0.0.136 ambari-server01.test.com 10.0.0.137 ambari-agent01.test.com 10.0.0.138 ambari-agent02.test.com âš ï¸âš ï¸âš ï¸Target Hosts å¤„ä¸€å®šä¸è¦å†™IPåœ°å€ï¼Œä¸€å®šè¦å†™æˆFQDNå¼çš„ä¸»æœºå é›†ç¾¤èŠ‚ç‚¹ Target Hosts å¤„è¦å†™æˆå¦‚ä¸‹ ambari-server01.test.com ambari-agent01.test.com ambari-agent02.test.com å¦åˆ™å°±ä¼šæŠ¥é”™å¦‚ä¸‹ï¼Œéå¸¸å‘ ERROR 2020-09-14 17:07:52,075 main.py:246 - Ambari agent machine hostname (ambari01.hadoop) does not match expected ambari server hostname (10.0.0.136). Aborting registration. Please check hostname, hostname -f and /etc/hosts file to confirm your hostname is setup correctly æ³¨å†ŒæˆåŠŸåæ˜¾ç¤ºå¦‚ä¸‹ âš ï¸5.3.3ä¸ºé‡åˆ°çš„é—®åŠè®°å½• 5.3.3 ambariå®‰è£…åˆ° Confirm Hostsé‡åˆ°çš„æŠ¥é”™ 5.3.3.1 æŠ¥é”™1 æ‰¾ä¸åˆ° ambari server é‡è¦æ—¥å¿— è§£å†³æ–¹æ³• é›†ç¾¤èŠ‚ç‚¹ Target Hosts å¤„ä¸»æœºä¿¡æ¯è¦å†™æˆå¦‚ä¸‹FQDNå¼ ambari-server01.test.com ambari-agent01.test.com ambari-agent02.test.com 5.3.3.2 æŠ¥é”™2 SSLError 5.2æ­¥éª¤ä¸­ä¿®æ”¹äº†HDPæºä¸ºæœ¬åœ° HDP-2.6ã€HDP-2.6-GPLã€HDP-UTILS-1.1.0.22 ä¾æ¬¡ä¿®æ”¹ä¸ºå¦‚ä¸‹ http://10.0.0.136/ambari/ambari/centos7/2.6.2.2-1 http://10.0.0.136/ambari/HDP/centos7/2.6.5.0-292 http://10.0.0.136/ambari/HDP-UTILS/centos7/1.1.0.22 è§£å†³æ–¹æ³• âš ï¸ä»¥ä¸‹æ“ä½œéœ€è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¿®æ”¹ 1.ä¿®æ”¹ /etc/python/cert-verification.cfg ä¸­ verify=platform_default ä¸º verify=disable sed -i.bak '/^verify/cverify=disable' /etc/python/cert-verification.cfg 2.ä¿®æ”¹ /etc/ambari-agent/conf/ambari-agent.ini ä¸­ [security] æ ‡ç­¾ååŠ å…¥ä»¥ä¸‹ä¸¤è¡Œå†…å®¹ ssl_verify_cert=0 force_https_protocol=PROTOCOL_TLSv1_2 sed -i.bak -e '/^credential_shell_cmd/assl_verify_cert=0\\nforce_https_protocol=PROTOCOL_TLSv1_2' /etc/ambari-agent/conf/ambari-agent.ini é‡å¯ ambari-agent ambari-agent restart 5.4 é€‰æ‹©éœ€è¦å®‰è£…çš„ç»„ä»¶ æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©è¦å®‰è£…çš„ç»„ä»¶ 5.5 åˆ†é…ç®¡ç†ç«¯æœåŠ¡ æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©å„ç»„ä»¶å®‰è£…çš„èŠ‚ç‚¹ 5.6 å®šåˆ¶æœåŠ¡ 5.6.1 HDFS åªä¿ç•™ä¸€ä¸ªè·¯å¾„ 5.6.2 YARN åªä¿ç•™ä¸€ä¸ªè·¯å¾„ 5.6.3 HIVE æŒ‡å®šmysqlé©±åŠ¨ä½ç½®ï¼Œå¦åˆ™hiveè¿æ¥æ•°æ®åº“ä¼šå¤±è´¥ ambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java.jar è¾“å‡ºå¦‚ä¸‹å³ä¸ºæˆåŠŸ Using python /usr/bin/python Setup ambari-server Copying /usr/share/java/mysql-connector-java.jar to /var/lib/ambari-server/resources If you are updating existing jdbc driver jar for mysql with mysql-connector-java.jar. Please remove the old driver jar, from all hosts. Restarting services that need the driver, will automatically copy the new jar to the hosts. JDBC driver was successfully initialized. Ambari Server 'setup' completed successfully. åˆ›å»ºhiveæ•°æ®åº“åŠæˆæƒ mysql -uroot -e \"create database hive character set utf8mb4\" mysql -uroot -e \"grant all on hive.* to hivei@'localhost' identified by 'hive'\" mysql -uroot -e \"grant all on hive.* to hive@'%' identified by 'hive'\" mysql -uroot -e \"flush privileges\" é€‰æ‹© Existing MySQL / MariaDB Database ï¼Œè¾“å…¥hiveæ•°æ®åº“å¯†ç ï¼Œä¿®æ”¹ Database URL è¿æ¥åœ°å€ï¼Œæµ‹è¯•è¿æ¥æˆåŠŸå³å¯ 5.6.4 Ambari Metrics éœ€è¦è®¾ç½®grafanaç®¡ç†å‘˜ç”¨æˆ·çš„å¯†ç  5.6.5 Atlas âš ï¸âš ï¸âš ï¸æœ€å¥½ä¸è¦é€‰æ‹©è¿™ä¸ªAtlasï¼Œç½‘ä¸ŠæŸ¥äº†åŠå¤©ä¹Ÿä¸çŸ¥é“æ ‡çº¢çš„è¿™ä¸¤å¤„è¯¥æ€ä¹ˆå†™ä»¥åŠæ€ä¹ˆæŸ¥æ‰¾ 5.6.6 SmartSense éœ€è¦è¾“å…¥å¯†ç ï¼Œé»˜è®¤adminå³å¯ 5.7 ç¡®è®¤é›†ç¾¤ä¿¡æ¯å¹¶éƒ¨ç½² 5.8 å®Œæˆå®‰è£… å®Œæˆå®‰è£… æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/vimå‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/vimå‘½ä»¤.html","title":"vimå‘½ä»¤","keywords":"","body":"vimå‘½ä»¤ 1.vimç¼–è¾‘å™¨ vi Visual Interface å¯è§†åŒ–ç•Œé¢ vim viå¢å¼ºç‰ˆ 2.vimæ¨¡å¼åŠæ¨¡å¼è½¬æ¢ vimæ¨¡å¼ å‘½ä»¤æ¨¡å¼ï¼Œåˆšæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å°±æ˜¯å‘½ä»¤æ¨¡å¼ ç¼–è¾‘æ¨¡å¼ï¼Œå¯ä»¥ç¼–è¾‘å†…å®¹ æœ«è¡Œæ¨¡å¼ï¼Œå¯è¿›è¡Œæœç´¢ã€æ›¿æ¢ã€åˆ‡æ¢æ–‡ä»¶ç­‰æ“ä½œ vimæ¨¡å¼è½¬æ¢ å‘½ä»¤æ¨¡å¼-->ç¼–è¾‘æ¨¡å¼ i: åœ¨å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„å­—ç¬¦å‰é¢ï¼Œè½¬æ¢ä¸ºç¼–è¾‘æ¨¡å¼ I: åœ¨å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„è¡Œé¦–ï¼Œè½¬æ¢ä¸ºç¼–è¾‘æ¨¡å¼ a: åœ¨å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„å­—ç¬¦åé¢ï¼Œè½¬æ¢ä¸ºç¼–è¾‘æ¨¡å¼ A: åœ¨å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„è¡Œå°¾ï¼Œè½¬æ¢ä¸ºç¼–è¾‘æ¨¡å¼ o: åœ¨å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„ä¸‹æ–¹ï¼Œæ–°å»ºä¸€è¡Œ O: åœ¨å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„ä¸Šæ–¹ï¼Œæ–°å»ºä¸€è¡Œ ç¼–è¾‘æ¨¡å¼-->å‘½ä»¤æ¨¡å¼ ESCé”® ç¼–è¾‘æ¨¡å¼-->æœ«è¡Œæ¨¡å¼ å…ˆesc ç„¶åï¼š ï¼š ï¼Ÿ / 3.vimæ‰“å¼€æ–‡ä»¶æ–¹å¼ vim +# æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶å®šä½äºç¬¬#è¡Œ vim + æ‰“å¼€æ–‡ä»¶ï¼Œå®šä½è‡³æœ€åä¸€è¡Œ vim + /æ­£åˆ™è¡¨è¾¾å¼ æ‰“å¼€æ–‡ä»¶ï¼Œå®šä½è‡³ç¬¬ä¸€æ¬¡è¢«æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ°çš„è¡Œçš„è¡Œé¦– 4.vimå…³é—­æ–‡ä»¶æ–¹å¼ 4.1 æœ«è¡Œæ¨¡å¼å…³é—­æ–‡ä»¶ :q é€€å‡º :wq é€€å‡ºå¹¶ä¿å­˜ :q! ä¸ä¿å­˜é€€å‡º :w ä¿å­˜ :wq! å¼ºè¡Œä¿å­˜é€€å‡º 4.2 ç¼–è¾‘æ¨¡å¼ä¸‹é€€å‡º ZZ ä¿å­˜å¹¶é€€å‡º ZQ ä¸ä¿å­˜é€€å‡º 5.ç§»åŠ¨å…‰æ ‡ 5.1 é€å­—ç¬¦ç§»åŠ¨(ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šä¸‹å·¦å³ç®­å¤´) h å‘å·¦ j å‘ä¸‹ k å‘ä¸Š l å‘å³ ä¾‹ï¼š5l å‘å³ç§»åŠ¨5ä¸ªå­—ç¬¦ 5.2 ä»¥å•è¯ä¸ºå•ä½ç§»åŠ¨ w ç§»è‡³ä¸‹ä¸€ä¸ªè¯çš„è¯é¦– e è·³è‡³å½“å‰æˆ–ä¸‹ä¸€ä¸ªå•è¯çš„è¯å°¾ end b è·³è‡³å½“å‰æˆ–å‰ä¸€ä¸ªå•è¯çš„è¯é¦– back 5.3 è¡Œå†…è·³è½¬ 0 ç»å¯¹è¡Œé¦– ^ è¡Œé¦–çš„ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦ $ ç»å¯¹è¡Œå°¾ 5.4 è¡Œé—´è·³è½¬ 5.4.1 ç¼–è¾‘æ¨¡å¼è·³è½¬ nGã€ngg è·³è½¬è‡³nè¡Œ G æœ€åä¸€è¡Œ gg ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªå­—ç¬¦ 5.4.2 æœ«è¡Œæ¨¡å¼è·³è½¬ :n è·³è½¬è‡³nè¡Œ :$ è·³è½¬è‡³æœ€åä¸€è¡Œ 6.ç¿»å± Ctrl+f å‘ä¸‹ç¿»ä¸€å± Ctrl+b å‘ä¸Šç¿»ä¸€å± Ctrl+d å‘ä¸‹ç¿»åŠå± Ctrl+u å‘ä¸Šç¿»åŠå± 7.åˆ é™¤ d x åˆ é™¤å½“å‰å…‰æ ‡æ‰€åœ¨å¤„çš„å•ä¸ªå­—ç¬¦ X åˆ é™¤å½“å‰å…‰æ ‡æ‰€åœ¨å¤„å‰é¢çš„å•ä¸ªå­—ç¬¦ nx åˆ é™¤å…‰æ ‡æ‰€åœ¨å¤„åŠå‘åçš„nä¸ªå­—ç¬¦ dd åˆ é™¤å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œ ndd åˆ é™¤åŒ…æ‹¬å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„nè¡Œ dw åˆ é™¤å…‰æ ‡æ‰€åœ¨å¤„åˆ°ä¸‹ä¸€ä¸ªè¯çš„è¯é¦– de åˆ é™¤å…‰æ ‡æ‰€åœ¨å¤„åˆ°å½“å‰è¯çš„è¯å°¾ db åˆ é™¤å…‰æ ‡æ‰€åœ¨å¤„åˆ°ä¸Šä¸€ä¸ªå•è¯çš„è¯é¦– 8.å¤åˆ¶ yy yy å¤åˆ¶å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œ nyy å¤åˆ¶å½“å‰å…‰æ ‡æ‰€åœ¨è¡ŒåŠånè¡Œ 9.ç²˜è´´ p p ç²˜è´´è‡³å…‰æ ‡æ‰€åœ¨è¡Œçš„ä¸‹ä¸€è¡Œ P ç²˜è´´è‡³å…‰æ ‡æ‰€åœ¨è¡Œçš„ä¸Šä¸€è¡Œ 10.ä¿®æ”¹ c cc åˆ é™¤å…‰æ ‡æ‰€åœ¨è¡Œå¹¶è¿›å…¥ç¼–è¾‘æ¨¡å¼ C åˆ é™¤å…‰æ ‡æ‰€åœ¨å¤„åˆ°æœ¬è¡Œç»“å°¾å¹¶è¿›å…¥ç¼–è¾‘æ¨¡å¼ 11.æ›¿æ¢ r r ç¼–è¾‘æ¨¡å¼ç›´æ¥æŒ‰ræ›¿æ¢ï¼Œä¸€æ¬¡åªèƒ½æ›¿æ¢ä¸€ä¸ª R æ›¿æ¢æ¨¡å¼ï¼Œå¯ä»¥æ›¿æ¢å¤šä¸ª 12.æ’¤é”€ u u æ’¤é”€å‰ä¸€æ¬¡çš„ç¼–è¾‘æ“ä½œï¼Œè¿ç»­uå‘½ä»¤å¯ä»¥æ’¤é”€æ­¤å‰çš„næ¬¡ç¼–è¾‘æ“ä½œ nu ç›´æ¥æ’¤é”€æœ€è¿‘næ¬¡ç¼–è¾‘æ“ä½œ Ctrl+r æ’¤é”€æ’¤é”€æ“ä½œ 13.é‡å¤å‰ä¸€æ¬¡æ“ä½œ ç¼–è¾‘æ¨¡å¼æŒ‰â€œ.â€é”®ï¼Œä¼šé‡å¤å‰ä¸€æ¬¡çš„æ“ä½œï¼Œæ¯”æ›¿æ¢ã€ç¼–è¾‘ã€åˆ é™¤ç­‰ 14.å¯è§†åŒ–æ“ä½œ v æŒ‰å­—ç¬¦é€‰å– V æŒ‰çŸ©å½¢é€‰å– ctrl+v æ‰¹é‡æ“ä½œï¼Œå…ˆé€‰ä¸­è¦æ“ä½œçš„åŒºåŸŸï¼Œç„¶åå¤§å†™Iç¼–è¾‘ï¼Œescï¼Œå›è½¦å³å¯å®Œæˆç¼–è¾‘ 15.æŸ¥æ‰¾(æœ«è¡Œæ¨¡å¼) / ä»ä¸Šè€Œä¸‹ ï¼Ÿ ä»ä¸‹è€Œä¸Š 16.æŸ¥æ‰¾å¹¶æ›¿æ¢(æœ«è¡Œæ¨¡å¼) s %è¡¨ç¤ºå…¨æ–‡ gè¡¨ç¤ºå…¨éƒ¨æ›¿æ¢ ç¤ºä¾‹ 1,3s/A/B 1,$s/A/B %s/A/B %s/A/B/g 17.vimç¼–è¾‘å¤šä¸ªæ–‡ä»¶ vim file1 file2 file3 ... :next åˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªæ–‡ä»¶ :prev åˆ‡æ¢è‡³ä¸Šä¸€ä¸ªæ–‡ä»¶ :last åˆ‡æ¢è‡³æœ€åä¸€ä¸ªæ–‡ä»¶ :first åˆ‡æ¢è‡³ç¬¬ä¸€ä¸ªæ–‡ä»¶ 18.é«˜çº§è¯é¢˜ 18.1æ˜¾ç¤ºæˆ–å–æ¶ˆè¡Œå· :set nu :set nonu 18.2æŸ¥æ‰¾åˆ°çš„æ–‡æœ¬é«˜äº®æ˜¾ç¤ºæˆ–å–æ¶ˆé«˜äº®æ˜¾ç¤º :set hls :set nohls 19.vimé…ç½®æ–‡ä»¶ /etc/vimrc ~/.vimrc æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/vimè¿›é˜¶.html":{"url":"linux/linuxå‘½ä»¤/vimè¿›é˜¶.html","title":"vimè¿›é˜¶ç”¨æ³•","keywords":"","body":"vimè¿›é˜¶ vimè¿›é˜¶ä¸€ ä½¿ç”¨F1é”®æ‰§è¡Œæ–‡ä»¶ vimæ˜¯ä¸€ä¸ªç±»ä¼¼äºViçš„è‘—åçš„åŠŸèƒ½å¼ºå¤§ã€é«˜åº¦å¯å®šåˆ¶çš„æ–‡æœ¬ç¼–è¾‘å™¨ æˆ‘ä»¬Linuxè¿ç»´ç»å¸¸åœ¨Linuxä¸­ä½¿ç”¨åˆ°Vimç¼–è¾‘å™¨ï¼Œå½“ä½¿ç”¨Vimå†™shellè„šæœ¬æˆ–è€…pythonè„šæœ¬çš„æ—¶å€™ï¼Œæƒ³è¦è¿è¡Œæµ‹è¯•æ—¶å€™æ€ä¹ˆåŠï¼ŸEscâ¡ï¼šâ¡wqï¼Œåˆ°shellç»ˆç«¯æ‰§è¡Œè„šæœ¬ ä¸Šè¿°æƒ…å†µå¾ˆå¤æ‚ï¼ï¼ ä¸‹é¢è®¾ç½®vimé…ç½®æ–‡ä»¶ï¼Œè®©vimç¼–è¾‘å™¨åœ¨ä¸é€€å‡ºå°±èƒ½æ‰§è¡Œè„šæœ¬ 1.åˆ›å»ºå¹¶ç¼–è¾‘å½“å‰ç”¨æˆ·çš„vimé…ç½®æ–‡ä»¶ vim ~/.vimrc æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š \"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\" \"Programming makes the world better \"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\" map :call CompileRunGcc() func! CompileRunGcc() exec \"w\" if &filetype == 'c' exec '!g++ % -o % 2.ç¼–è¾‘è„šæœ¬ï¼Œå¹¶è¿›è¡Œæµ‹è¯• //ç¼–è¾‘æµ‹è¯•è„šæœ¬ [root@web01 ~]# cat test.sh # !/usr/bin/env bash echo \"test\" //æµ‹è¯•ï¼Œvimç¼–è¾‘è„šæœ¬ï¼Œæœ«è¡Œæ¨¡å¼æŒ‰F1 //å†æ¬¡æŒ‰å›è½¦ï¼Œä¼šå›åˆ°è„šæœ¬å½“ä¸­,è¿™æ ·å°±å¯ä»¥ä¸é€€å‡ºè„šæœ¬ï¼Œç›´æ¥æ‰§è¡Œè„šæœ¬è¿›è¡Œæµ‹è¯•äº†ï¼ï¼ï¼ vimè¿›é˜¶äºŒ linuxè„šæœ¬è‡ªåŠ¨æ·»åŠ è„šæœ¬å¤´ ç¼–è¾‘å½“å‰ç”¨æˆ·vimé…ç½®æ–‡ä»¶ #vim ~/.vimrc æˆ–è€…å®šä¹‰å…¨å±€ä¹Ÿè¡Œ #vim /etc/vimrc åœ¨æœ€ä¸‹æ–¹æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š CentOS7 function HappyPython() call setline(1, \"#!/usr/bin/env python\") call append(1, \"#-*- coding:utf8 -*-\") normal G normal o endf autocmd bufnewfile *.py call HappyPython() function HappyShell() call setline(1, \"#!/usr/bin/env bash\") call append(1, \"export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\") normal G normal o endf autocmd bufnewfile *.sh call HappyShell() CentOS6 function HappyPython() call setline(1, \"#!/usr/bin/env python\") call append(1, \"#-*- coding:utf8 -*-\") normal G normal o endf autocmd bufnewfile *.py call HappyPython() function HappyShell() call setline(1, \"#!/usr/bin/env bash\") call append(1, \"export PATH=/usr/lib64/qt-3.3/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin\") normal G normal o endf autocmd bufnewfile *.sh call HappyShell() ä¿å­˜é€€å‡ºåï¼Œæˆ‘ä»¬è¯•è¯•å¼€å§‹ä½¿ç”¨vimç¼–è¾‘.pyæ–‡ä»¶å’Œ.shæ–‡ä»¶ å°±ä¼šå‘ç°pyæ–‡ä»¶ä¼šè‡ªåŠ¨æ·»åŠ äº†pythonè„šæœ¬å¤´ï¼ shæ–‡ä»¶è‡ªåŠ¨æ·»åŠ äº†shellè„šæœ¬å¤´ï¼ vimè¿›é˜¶ä¸‰ vimç¼–è¾‘pythonè„šæœ¬æ—¶Tabè¡¥å…¨ ä½¿ç”¨Linuxå†™pythonè„šæœ¬çš„æ—¶å€™ï¼ŒåˆæœŸæœ€ç—›è‹¦çš„æ˜¯ä»€ä¹ˆï¼Ÿå½“ç„¶æ˜¯å„ç§åº“çš„ä¸ç†Ÿæ‚‰ï¼ŒçŸ¥é“äº†åº“ï¼Œé‡Œé¢çš„æ–¹æ³•è¿˜è¦æŒ¨ä¸ªçœ‹ï¼ŒæŒ¨ä¸ªè®°ã€‚ æ‰€ä»¥è¿™æ—¶å€™ï¼Œå¾ˆå¤šå°ä¼™ä¼´ä½¿ç”¨äº†ipythonï¼Œæœ€å¼ºå¤§çš„åŠŸèƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°ä¼™ä¼´ä»¬éƒ½çŸ¥é“ï¼Œå¯ä»¥è‡ªåŠ¨å¡«å……ç¼©è¿›ï¼Œæœ€é‡è¦çš„ä¸€ç‚¹å½“ç„¶æ˜¯å¯ä»¥è¡¥å…¨å•¦ï¼ åœ¨è¿™é‡Œä¸å¾—ä¸æï¼Œvimçš„å¼ºå¤§ï¼Œå¯ä»¥å®šåˆ¶åŒ–ï¼Œæ”¯æŒpythonè¡¥å…¨ã€‚ ä¸‹é¢è¿›è¡Œè®¾ç½®ï¼Œå¦‚ä½•èƒ½å¤Ÿè®©vimç¼–å†™pythonè„šæœ¬å¯ä»¥tabè¡¥å…¨ï¼š ç¬¬ä¸€æ­¥ã€å®‰è£…git [root@web01 ~]# yum -y install git ç¬¬äºŒæ­¥ã€åˆ›å»ºå½“å‰ç”¨æˆ·éšè—vimç›®å½•ï¼Œå¹¶è¿›å…¥åˆ°è¿™ä¸ªç›®å½• [root@web01 ~]# mkdir ~/.vim ; cd ~/.vim ç¬¬ä¸‰æ­¥ã€ä½¿ç”¨gitå…‹éš†ä¸‹æ’ä»¶åŒ…ï¼ˆä¹Ÿå¯æå‰ä¸‹è½½å¥½ï¼Œcopyè¿›æ¥ï¼‰ [root@web01 .vim]# git clone https://github.com/rkulla/pydiction.git [root@web01 .vim]# cp -r ~/.vim/pydiction/after/ ~/.vim ç¬¬å››æ­¥ã€ç¼–è¾‘vimé…ç½®æ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ [root@web01 .vim]# vim ~/.vimrc filetype plugin on let g:pydiction_location = '/root/.vim/pydiction/complete-dict' let g:pydiction_menu_height = 10 âš ï¸âš ï¸âš ï¸æ­¤å¤„æœ‰å‘è¯·æ³¨æ„ï¼ï¼ ä»£ç ç¬¬äºŒè¡Œï¼Œä½¿ç”¨findå‘½ä»¤æŸ¥æ‰¾ä¸€ä¸‹è‡ªå·±çš„complete-dictæ–‡ä»¶è·¯å¾„ï¼Œä¸€å®šè¦å†™å¯¹ï¼ï¼ ç¬¬äº”æ­¥ã€ç¼–è¾‘pythonè„šæœ¬ï¼Œè¿›è¡Œæµ‹è¯• ç¼–è¾‘pythonè„šæœ¬ï¼Œç„¶åè¾“å…¥åº“åï¼Œç„¶åtabè¡¥é½å³å¯ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/dateå‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/dateå‘½ä»¤.html","title":"dateå‘½ä»¤","keywords":"","body":"dateå‘½ä»¤ 1.å‘½ä»¤è¯´æ˜ dateå‘½ä»¤æ ¹æ®ç»™å®šæ ¼å¼æ˜¾ç¤ºæ—¥æœŸæˆ–è®¾ç½®ç³»ç»Ÿæ—¥æœŸæ—¶é—´ï¼Œprint or set the system date and time centos7ä¸­dateå‘½ä»¤æ‰€åœ¨è·¯å¾„ [root@aliyun ~]# which date /usr/bin/date 2.å‘½ä»¤æ ¼å¼ date [OPTION]â€¦[+FORMAT] date [é€‰é¡¹] [æ ¼å¼] 3.å¸¸ç”¨é€‰é¡¹ 3.1 -d æ ¹æ®æè¿°æ˜¾ç¤ºæŒ‡å®šæ—¥æœŸ //æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ—¥æœŸ [root@test1 ~]# date Mon Aug 20 21:15:32 CST 2018 //è®¾ç½®æ—¶é—´ä¸ºä¸€å¤©å‰ [root@test1 ~]# date -d \"-1 day\" Sun Aug 19 21:15:34 CST 2018 3.2 -s æ‰‹åŠ¨è®¾ç½®æ—¶é—´ //æ‰‹åŠ¨è®¾ç½®æ—¶é—´ [root@test1 ~]# date -s '2022-2-22 22:22:22' Tue Feb 22 22:22:22 CST 2022 //æŸ¥çœ‹å½“å‰æ—¶é—´ [root@test1 ~]# date Tue Feb 22 22:22:22 CST 2022 4.å¸¸ç”¨è¾“å‡º 4.1 +%F è¾“å‡ºæ—¥æœŸ [root@test ~]# date +%F 2018-08-29 4.2 +%T è¾“å‡ºæ—¶é—´ [root@test1 ~]# date +%T 10:08:38 4.3 +%j è¾“å‡ºå½“å‰å¤©æ˜¯ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤© [root@test1 ~]# date +%j 251 4.4 +%w è¾“å‡ºæ˜ŸæœŸ âš ï¸0è¡¨ç¤ºå‘¨æ—¥ [root@test1 ~]# date +%w 1 4.5 +%s 1970-01-01 00:00:00 å¼€å§‹åˆ°ç°åœ¨ç»è¿‡çš„ç§’æ•° [root@test1 ~]# date +%s 1535508552 5.å…¶ä»–è¾“å‡º 5.1å¹´ä»½ç›¸å…³ 5.1.1 +%Y è¾“å‡ºå¹´ä»½(4ä½æ•°) [root@test1 ~]# date +%Y 2018 5.1.2 +%y è¾“å‡ºå¹´ä»½(00-99è¡¨ç¤º) [root@test1 ~]# date +%y 18 5.2æœˆä»½ç›¸å…³ 5.2.1 +%m è¾“å‡ºæœˆä»½(0-12è¡¨ç¤º) [root@test1 ~]# date +%m 08 5.2.2 +%b æœˆä»½è‹±æ–‡ç¼©å†™ [root@test1 ~]# date +%b Aug 5.2.3 +%B æœˆä»½è‹±æ–‡å…¨å†™ [root@test1 ~]# date +%B August 5.3æ—¥æœŸç›¸å…³ 5.3.1 +%w è¾“å‡ºæ˜ŸæœŸ(0ä»£è¡¨å‘¨æ—¥) [root@test1 ~]# date +%w 3 5.3.2 +%c è¾“å‡ºæ—¥æœŸ(ä¸dateå‘½ä»¤è¾“å‡ºç¨å¾®æœ‰å·®åˆ«) [root@test1 ~]# date +%c Wed 29 Aug 2018 10:11:12 AM CST [root@test1 ~]# date Wed Aug 29 10:11:12 CST 2018 5.3.3 +%d è¾“å‡ºæ—¥æœŸ(1-31è¡¨ç¤º) [root@test1 ~]# date +%d 29 5.3.4 +%D è¾“å‡ºæ—¥æœŸ(æœˆ/æ—¥/å¹´) [root@test1 ~]# date +%D 08/29/18 5.4æ˜ŸæœŸç›¸å…³ 5.4.1 +%a è¾“å‡ºæ˜ŸæœŸ(è‹±æ–‡ç¼©å†™) [root@test1 ~]# date +%a Wed 5.4.2 +%A è¾“å‡ºæ˜ŸæœŸ(è‹±æ–‡å…¨ç§°) [root@test1 ~]# date +%A Wednesday 5.4.3 +%W è¾“å‡ºæ˜ŸæœŸ(æ•°å­—è¡¨ç¤º) [root@test1 ~]# date +%w 3 5.5å°æ—¶ç›¸å…³ 5.5.1 +%Hã€+%k è¾“å‡ºå°æ—¶(00-23è¡¨ç¤º) [root@test1 ~]# date +%H 10 [root@test1 ~]# date +%k 10 5.5.2 +%l è¾“å‡ºå°æ—¶(01-12è¡¨ç¤º) [root@test1 ~]# date +%l 10 5.6åˆ†é’Ÿç›¸å…³ 5.6.1 +%M è¾“å‡ºåˆ†é’Ÿ(00-59è¡¨ç¤º) [root@test1 ~]# date +%M 30 5.7ç§’æ•°ç›¸å…³ 5.7.1 +%S è¾“å‡ºç§’æ•° [root@test1 ~]# date +%S 28 5.7.2 +%N è¾“å‡ºçº³ç§’ çº³ç§’nanoseconds (000000000..999999999) [root@test1 ~]# date +%N 121213066 5.8æ—¶åŒºç›¸å…³ 5.8.1 +%Z è¾“å‡ºæ—¶åŒº CSTè¡¨ç¤ºä¸­éƒ¨æ ‡å‡†æ—¶é—´ [root@test1 ~]# date +%Z CST 5.9å…¶ä»–ç›¸å…³ 5.9.1 +%Pã€+%p è¾“å‡ºAMæˆ–è€…PM [root@test1 ~]# date +%p PM [root@test1 ~]# date +%P pm 5.9.2 +%rã€+%X è¾“å‡ºæ—¶é—´(å«æ—¶åˆ†ç§’ï¼Œå°æ—¶ä»¥12å°æ—¶AM/PMæ¥è¡¨ç¤º) [root@test1 ~]# date +%r 10:40:15 AM [root@test1 ~]# date +%X 10:40:25 AM 5.9.3 +%x ä»¥æœˆ/æ—¥/å¹´è¾“å‡ºæ—¥æœŸ [root@test1 ~]# date +%x 08/29/2018 5.9.4 +%n è¾“å‡ºæ—¶æ˜¾ç¤ºæ–°çš„ä¸€è¡Œ //æ³¨æ„æœ‰ä¸¤è¡Œ [root@test1 ~]# date +%n [root@test1 ~]# 5.9.5 +%t è¾“å‡ºæ—¶æ’å…¥tab //æœ‰ä¸€ä¸ªç©ºè¡Œ [root@test1 ~]# date +%t [root@test1 ~]# æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/xargså‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/xargså‘½ä»¤.html","title":"xargså‘½ä»¤","keywords":"","body":"xargså‘½ä»¤ 1.å‘½ä»¤è¯´æ˜ xargså‘½ä»¤æ˜¯ç»™å…¶ä»–å‘½ä»¤ä¼ é€’å‚æ•°çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä¹Ÿæ˜¯ç»„åˆå¤šä¸ªå‘½ä»¤çš„ä¸€ä¸ªå·¥å…·ã€‚å®ƒæ“…é•¿å°†æ ‡å‡†è¾“å…¥æ•°æ®è½¬æ¢æˆå‘½ä»¤è¡Œå‚æ•°ï¼Œxargsèƒ½å¤Ÿå¤„ç†ç®¡é“æˆ–è€…stdinå¹¶å°†å…¶è½¬æ¢æˆç‰¹å®šå‘½ä»¤çš„å‘½ä»¤å‚æ•°ã€‚xargsä¹Ÿå¯ä»¥å°†å•è¡Œæˆ–å¤šè¡Œæ–‡æœ¬è¾“å…¥è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼ï¼Œä¾‹å¦‚å¤šè¡Œå˜å•è¡Œï¼Œå•è¡Œå˜å¤šè¡Œã€‚xargsçš„é»˜è®¤å‘½ä»¤æ˜¯echoï¼Œç©ºæ ¼æ˜¯é»˜è®¤å®šç•Œç¬¦ã€‚è¿™æ„å‘³ç€é€šè¿‡ç®¡é“ä¼ é€’ç»™xargsçš„è¾“å…¥å°†ä¼šåŒ…å«æ¢è¡Œå’Œç©ºç™½ï¼Œä¸è¿‡é€šè¿‡xargsçš„å¤„ç†ï¼Œæ¢è¡Œå’Œç©ºç™½å°†è¢«ç©ºæ ¼å–ä»£ã€‚xargsæ˜¯æ„å»ºå•è¡Œå‘½ä»¤çš„é‡è¦ç»„ä»¶ä¹‹ä¸€ 2.å‘½ä»¤é€‰é¡¹ 2.1 -d æŒ‡å®šåˆ†éš”ç¬¦ [root@test1 test]# echo 123@123@123|xargs 123@123@123 [root@test1 test]# echo 123@123@123|xargs -d@ 123 123 123 2.2 -n æŒ‡å®šå‚æ•°è¾“å‡ºåˆ—æ•° [root@test1 test]# echo 123 123 123 |xargs -n1 123 123 123 [root@test1 test]# echo 123 123 123 |xargs -n2 123 123 123 [root@test1 test]# echo 123 123 123 |xargs -n3 123 123 123 2.3 -p è¯¢é—®æ˜¯å¦æ‰§è¡Œå‘½ä»¤ ä½¿ç”¨è¯¥é€‰é¡¹ä¹‹åxargså¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡Œå…¶åé¢çš„å‘½ä»¤ï¼Œè€Œæ˜¯è¾“å‡ºå³å°†è¦æ‰§è¡Œçš„å®Œæ•´çš„å‘½ä»¤(åŒ…æ‹¬å‘½ä»¤ä»¥åŠä¼ é€’ç»™å‘½ä»¤çš„å‘½ä»¤è¡Œå‚æ•°)ï¼Œè¯¢é—®æ˜¯å¦æ‰§è¡Œï¼Œè¾“å…¥ y æ‰ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ä¸æ‰§è¡Œ [root@test1 test]# echo 123 | xargs -p sed 's#1#9#' sed s#1#9# 123 ?... 2.4 -E æŒ‡å®šä¸€ä¸ªå­—ç¬¦ä¸² å½“xargsè§£æå‡ºå¤šä¸ªå‘½ä»¤è¡Œå‚æ•°çš„æ—¶å€™ï¼Œå¦‚æœæœç´¢åˆ°-EæŒ‡å®šçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œåˆ™åªä¼šå°†-EæŒ‡å®šçš„å‘½ä»¤è¡Œå‚æ•°ä¹‹å‰çš„å‚æ•°(ä¸åŒ…æ‹¬-EæŒ‡å®šçš„è¿™ä¸ªå‚æ•°)ä¼ é€’ç»™xargsåé¢çš„å‘½ä»¤ âš ï¸æ³¨æ„ï¼š-Eåªæœ‰åœ¨xargsä¸æŒ‡å®š-dçš„æ—¶å€™æœ‰æ•ˆï¼Œå¦‚æœæŒ‡å®šäº†-dåˆ™ä¸èµ·ä½œç”¨ï¼Œè€Œä¸ç®¡-dæŒ‡å®šçš„æ˜¯ä»€ä¹ˆå­—ç¬¦ï¼Œç©ºæ ¼ä¹Ÿä¸è¡Œ [root@test1 test]# echo '11 22 33' | xargs -E '33' echo 11 22 æŒ‡å®š-dé€‰é¡¹ï¼Œ-Eé€‰é¡¹å°±å¤±æ•ˆäº† [root@test1 test]# echo '11 22 33' | xargs -d ' ' -E '33' echo 11 22 33 2.5 -i ä½¿ç®¡é“å‰å‘½ä»¤ç»“æœæˆä¸ºåç»­æ“ä½œå‘½ä»¤çš„å‚æ•° 2.6 -0(æ•°å­—0) è¯†åˆ«findç»“æŸæ ‡è®° 1.å½“å‰è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸­åŒ…å«ç©ºæ ¼ [root@test1 test]# ll total 0 -rw-r--r-- 1 root root 0 Aug 21 05:16 abc 01.jpg -rw-r--r-- 1 root root 0 Aug 21 05:16 abc 02.jpg -rw-r--r-- 1 root root 0 Aug 21 05:16 abc 03.jpg 2.findå‘½ä»¤æŸ¥æ‰¾å½“å‰è·¯å¾„ä¸‹è¿™ä¸‰ä¸ªæ–‡ä»¶ï¼Œä¼šæŠ¥é”™ï¼Œå› ä¸ºfindä¼šè®¤ä¸ºå«æœ‰ç©ºæ ¼çš„æ–‡ä»¶ä¸ºä¸¤ä¸ªæ–‡ä»¶ 3.è§£å†³æ–¹æ³• æ–¹å¼ä¸€ è®©findå‘½ä»¤ç»™æ¯ä¸ªæ–‡ä»¶åçš„ç»“æŸå¤„åŠ ä¸Šä¸€ä¸ªç»“æŸæ ‡è®° find . -type f -name \"*.jpg\" -print0|xargs -0 ls -l -print0 åŠ ä¸Šç»“æŸæ ‡è®° xargs0 è¯†åˆ«ç»“æŸæ ‡è®° æ–¹å¼äºŒ find . -type f -name \"*.jpg\" |xargs -i ls -l {} æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/rpmå‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/rpmå‘½ä»¤.html","title":"rpmå‘½ä»¤","keywords":"","body":"rpmå‘½ä»¤ 1.å‘½ä»¤è¯´æ˜ rpmå‘½ä»¤æ˜¯RPMè½¯ä»¶åŒ…çš„ç®¡ç†å·¥å…·ã€‚ rpmåŸæœ¬æ˜¯Red Hat Linuxå‘è¡Œç‰ˆä¸“é—¨ç”¨æ¥ç®¡ç†Linuxå„é¡¹å¥—ä»¶çš„ç¨‹åºï¼Œç”±äºå®ƒéµå¾ªGPLè§„åˆ™ä¸”åŠŸèƒ½å¼ºå¤§æ–¹ä¾¿ï¼Œå› è€Œå¹¿å—æ¬¢è¿ã€‚é€æ¸å—åˆ°å…¶ä»–å‘è¡Œç‰ˆçš„é‡‡ç”¨ã€‚ RPMå¥—ä»¶ç®¡ç†æ–¹å¼çš„å‡ºç°ï¼Œè®©Linuxæ˜“äºå®‰è£…ï¼Œå‡çº§ï¼Œé—´æ¥æå‡äº†Linuxçš„é€‚ç”¨åº¦ã€‚ 2.å‘½ä»¤æ ¼å¼ rpm é€‰é¡¹ å‚æ•° 3.é€‰é¡¹ 3.1å®‰è£…å‚æ•° -i å®‰è£…è½¯ä»¶åŒ… -v æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ -h æ˜¾ç¤ºå®‰è£…è¿›åº¦ --nodeps ä¸éªŒè¯è½¯ä»¶åŒ…çš„ä¾èµ–æ€§ --force å¼ºåˆ¶å®‰è£…ï¼Œå³ä½¿è¦†ç›–å…¶ä»–åŒ…çš„æ–‡ä»¶ä¹Ÿå®‰è£… 3.2å¸è½½å‚æ•° -e å¸è½½è½¯ä»¶åŒ… 3.3å‡çº§å‚æ•° -U å‡çº§è½¯ä»¶åŒ… 3.4æŸ¥è¯¢å‚æ•° -a æŸ¥è¯¢æ‰€æœ‰ -q æŸ¥è¯¢å·²å®‰è£…è½¯ä»¶åŒ… -c ä»…åˆ—å‡ºé…ç½®æ–‡ä»¶ -l åˆ—å‡ºåŒ…ä¸­æ–‡ä»¶ä¿¡æ¯ï¼Œéœ€é…åˆ-qå‚æ•° -f æŸ¥è¯¢æŒ‡å®šæ–‡ä»¶å±äºå“ªä¸ªè½¯ä»¶åŒ…ï¼Œéœ€é…åˆ-qå‚æ•° -p æŸ¥è¯¢æœªå®‰è£…è½¯ä»¶åŒ…ä¿¡æ¯ -i æŸ¥è¯¢è½¯ä»¶åŒ…è¯¦ç»†ä¿¡æ¯ -R æŸ¥è¯¢è½¯ä»¶åŒ…ä¾èµ–æ€§ 4.rpmè½¯ä»¶åŒ…ä¿¡æ¯ rpm åŒ…åå­—ç»“æ„ï¼š glibc-2.17-196.el7_4.2.x86_64 glibc -2 .17 -196 -el7 x86 64 è½¯ä»¶å ä¸»ç‰ˆæœ¬å· æ¬¡ç‰ˆæœ¬å· ä¿®è®¢å· RHEL7 CPUæ¶æ„å¹³å° æ”¯æŒç³»ç»Ÿä½æ•° 5.rpmåŒ…ä¸­æ–‡ä»¶çš„æå– æ¨¡æ‹Ÿcatå‘½ä»¤è¢«åˆ é™¤å†åˆ°æ¢å¤ 1.æŸ¥æ‰¾catå‘½ä»¤å±äºå“ªä¸ªæ–‡ä»¶ [root@test1 ~]# which cat /bin/cat 2.åˆ é™¤catå‘½ä»¤æ–‡ä»¶ [root@test1 ~]# rm -rf /bin/cat 3.rpm -qf /bin/cat [root@test1 ~]# rpm -qf /bin/cat coreutils-8.4-46.el6.x86_64 4.æŒ‚è½½å…‰ç›˜ [root@test1 ~]# mount /dev/sr0 /mnt mount: block device /dev/sr0 is write-protected, mounting read-only 5.æ¢å¤æ–‡ä»¶ [root@test1 ~]# rpm2cpio /mnt/Packages/coreutils-8.4-46.el6.x86_64.rpm |cpio -idv ./bin/cat ./bin/cat 25240 blocks rpm2cpio å°†rpmåŒ…è½¬æ¢ä¸ºcpioæ ¼å¼ cpio æ˜¯ä¸€ç§æ ‡å‡†å·¥å…·ï¼Œå®ƒç”¨äºåˆ›å»ºè½¯ä»¶æ¡£æ¡ˆæ–‡ä»¶å’Œä»æ–‡ä»¶æ¡£æ¡ˆä¸­æå–æ–‡ä»¶ -iï¼šcopy-inæ¨¡å¼ è¿˜åŸ -dï¼šè¿˜åŸæ—¶è‡ªåŠ¨æ–°å»ºç›®å½• -vï¼šæ˜¾ç¤ºè¿˜åŸè¿‡ç¨‹ 6.å°†å½“å‰ç›®å½•æ¢å¤çš„catæ–‡ä»¶ç§»åŠ¨åˆ°/bin/å³å¯ [root@test1 ~]# cp bin/cat /bin æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/echoå‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/echoå‘½ä»¤.html","title":"echoå‘½ä»¤","keywords":"","body":"echoå‘½ä»¤ 1.å‘½ä»¤è¯´æ˜ echoå‘½ä»¤ç”¨äºåœ¨shellä¸­æ‰“å°shellå˜é‡çš„å€¼ï¼Œæˆ–è€…ç›´æ¥è¾“å‡ºæŒ‡å®šçš„å­—ç¬¦ä¸² 2.å‘½ä»¤æ ¼å¼ echo [é€‰é¡¹] [å‚æ•°] 3.å¸¸ç”¨é€‰é¡¹ 3.1 -n ä¸è¾“å‡ºæ¢è¡Œ [root@aliyun ~]# echo -n hehe hehe[root@aliyun ~]# 3.2 -e ä½¿è½¬ç§»å­—ç¬¦ç”Ÿæ•ˆ \\n æ¢è¡Œä¸”å…‰æ ‡ç§»è‡³è¡Œé¦– \\c æœ€åä¸åŠ ä¸Šæ¢è¡Œç¬¦å· \\t æ’å…¥tab \\e è½¬ä¹‰ \\b åˆ é™¤å‰ä¸€ä¸ªå­—ç¬¦ \\v è¾“å‡ºå‚ç›´åˆ¶è¡¨ç¬¦ï¼Œä¸\\fè¾“å‡ºç»“æœç›¸åŒ \\a å‘å‡ºè­¦å‘Šå£° \\r å…‰æ ‡ç§»è‡³è¡Œé¦–ï¼Œä½†ä¸æ¢è¡Œ 3.2.1 \\n æ¢è¡Œ [root@exercise1 ~]# echo -e 'hehe\\nhehe' hehe hehe 3.2.2 \\t è¾“å‡ºåˆ¶è¡¨ç¬¦ [root@exercise1 ~]# echo -e 'hehe\\thehe' hehe hehe 3.2.3 \\c ä¸æ¢è¡Œ [root@exercise1 ~]# echo -e 'hehehehe\\c' hehehehe[root@exercise1 ~]# 3.2.4 \\v å‚ç›´åˆ¶è¡¨ç¬¦ [root@exercise1 ~]# echo -e 'hehe\\vhehe' hehe hehe 3.2.5 \\e è½¬ä¹‰ ç­‰åŒäº\\033 \\eå†™æ³• \\033å†™æ³• 4.bashé‡Œé¢çš„é¢œè‰² 4.1è®¾ç½®å‰æ™¯é¢œè‰² å†™æ³• å«ä¹‰ [30m å°†å­—ç¬¦çš„æ˜¾ç¤ºé¢œè‰²æ”¹ä¸ºé»‘è‰² [31m å°†å­—ç¬¦çš„æ˜¾ç¤ºé¢œè‰²æ”¹ä¸ºçº¢è‰² [32m å°†å­—ç¬¦çš„æ˜¾ç¤ºé¢œè‰²æ”¹ä¸ºç»¿è‰² [33m å°†å­—ç¬¦çš„æ˜¾ç¤ºé¢œè‰²æ”¹ä¸ºæ·¡é»„è‰² [34m å°†å­—ç¬¦çš„æ˜¾ç¤ºé¢œè‰²æ”¹ä¸ºè“è‰² [35m å°†å­—ç¬¦çš„æ˜¾ç¤ºé¢œè‰²æ”¹ä¸ºç´«è‰² [36m å°†å­—ç¬¦çš„æ˜¾ç¤ºé¢œè‰²æ”¹ä¸ºå¤©è“è‰² [37m å°†å­—ç¬¦çš„æ˜¾ç¤ºé¢œè‰²æ”¹ä¸ºç°è‰² 4.2è®¾ç½®èƒŒæ™¯é¢œè‰² å†™æ³• å«ä¹‰ [40m å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºé»‘è‰² [41m å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºçº¢è‰² [42m å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºç»¿è‰² [43m å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºæ·¡é»„è‰² [44m å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºè“è‰² [45m å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºç´«è‰² [46m å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºæ·¡è“è‰² [47m å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºç°è‰² windowsç»ˆç«¯ä¸‹çš„æ•ˆæœ macç»ˆç«¯ä¸‹çš„æ•ˆæœ 4.3å…¶ä»–è®¾ç½® ç¼–ç  é¢œè‰²/åŠ¨ä½œ 0 é‡æ–°è®¾ç½®å±æ€§åˆ°ç¼ºçœè®¾ç½® 1 è®¾ç½®ç²—ä½“ 2 è®¾ç½®ä¸€åŠäº®åº¦ï¼ˆæ¨¡æ‹Ÿå½©è‰²æ˜¾ç¤ºå™¨çš„é¢œè‰²ï¼‰ 4 è®¾ç½®ä¸‹åˆ’çº¿ï¼ˆæ¨¡æ‹Ÿå½©è‰²æ˜¾ç¤ºå™¨çš„é¢œè‰²ï¼‰ 5 è®¾ç½®é—ªçƒ 7 è®¾ç½®åå‘å›¾è±¡ 22 è®¾ç½®ä¸€èˆ¬å¯†åº¦ 24 å…³é—­ä¸‹åˆ’çº¿ 25 å…³é—­é—ªçƒ 27 å…³é—­åå‘å›¾è±¡ å†™æ³•ç¤ºä¾‹ 5;31m 5è¡¨ç¤ºè®¾ç½®é—ªçƒ 31mè¡¨ç¤ºè®¾ç½®å­—ä½“é¢œè‰²ä¸ºçº¢è‰² [root@exercise1 ~]# echo -e \"\\033[5;31må‘µå‘µ\\033[0m\" ä½¿ç”¨å¤šä¸ªé¢œè‰²è®¾ç½®çš„æ—¶å€™ï¼Œä½¿ç”¨åˆ†å·åˆ†éš”å³å¯ \\033[31;47;1mhello world\\033[0m æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/findå‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/findå‘½ä»¤.html","title":"findå‘½ä»¤","keywords":"","body":"findå‘½ä»¤ 1.å‘½ä»¤è¯´æ˜ findå‘½ä»¤ç”¨æ¥åœ¨æŒ‡å®šç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶ã€‚ ä»»ä½•ä½äºå‚æ•°ä¹‹å‰çš„å­—ç¬¦ä¸²éƒ½å°†è¢«è§†ä¸ºæ¬²æŸ¥æ‰¾çš„ç›®å½•åã€‚å¦‚æœä½¿ç”¨è¯¥å‘½ä»¤æ—¶ï¼Œä¸è®¾ç½®ä»»ä½•å‚æ•°ï¼Œåˆ™findå‘½ä»¤å°†åœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾å­ç›®å½•ä¸æ–‡ä»¶ã€‚å¹¶ä¸”å°†æŸ¥æ‰¾åˆ°çš„å­ç›®å½•å’Œæ–‡ä»¶å…¨éƒ¨è¿›è¡Œæ˜¾ç¤º 2.å‘½ä»¤æ ¼å¼ find æŸ¥æ‰¾èŒƒå›´ é€‰é¡¹ æ“ä½œ æŸ¥æ‰¾èŒƒå›´ï¼šé»˜è®¤å½“å‰ç›®å½• æ“ä½œï¼šé»˜è®¤è¾“å‡ºåˆ°ç»ˆç«¯ 3.å‘½ä»¤é€‰é¡¹ 3.1 -name æŒ‰ç…§æ–‡ä»¶åæŸ¥æ‰¾ [root@exercise1 ~]# pwd /root [root@exercise1 ~]# find -name *.log ./install.log 3.2 -size æŒ‰ç…§æ–‡ä»¶å¤§å°æŸ¥æ‰¾ ç¬¦å· + å¤§äº - å°äº ä¸åŠ ç¬¦å·æ˜¯ç­‰äº æ–‡ä»¶å¤§å°å•å…ƒ b â€”â€”>å—ï¼ˆ512å­—èŠ‚ï¼‰ c â€”â€”>å­—èŠ‚ w â€”â€”>å­—ï¼ˆ2å­—èŠ‚ï¼‰ k â€”â€”> åƒå­—èŠ‚ M â€”â€”>å…†å­—èŠ‚ G â€”â€”> Gå­—èŠ‚ //æŸ¥æ‰¾å½“å‰ç›®å½•å¤§å°ä¸º110Kçš„æ–‡ä»¶ [root@exercise1 tmp]# ll -h total 144K -rw-r--r-- 1 root root 11K Aug 9 13:35 1.1 -rw-r--r-- 1 root root 15K Aug 9 13:35 2.2 -rw-r--r-- 1 root root 110K Aug 9 13:35 3.3 -rw-r--r-- 1 root root 580 Aug 9 13:39 ip_date.txt [root@exercise1 tmp]# find . -size 110k ./3.3 //æŸ¥æ‰¾å½“å‰ç›®å½•å°äº100Kçš„æ–‡ä»¶ [root@exercise1 tmp]# ll -h total 144K -rw-r--r-- 1 root root 11K Aug 9 13:35 1.1 -rw-r--r-- 1 root root 15K Aug 9 13:35 2.2 -rw-r--r-- 1 root root 110K Aug 9 13:35 3.3 -rw-r--r-- 1 root root 812 Aug 9 13:41 ip_date.txt [root@exercise1 tmp]# find . -size -100k . ./1.1 ./ip_date.txt ./2.2 //æŸ¥æ‰¾å½“å‰ç›®å½•å¤§äº100Kçš„æ–‡ä»¶ [root@exercise1 tmp]# ll -h total 144K -rw-r--r-- 1 root root 11K Aug 9 13:35 1.1 -rw-r--r-- 1 root root 15K Aug 9 13:35 2.2 -rw-r--r-- 1 root root 110K Aug 9 13:35 3.3 -rw-r--r-- 1 root root 928 Aug 9 13:42 ip_date.txt [root@exercise1 tmp]# find . -size +100k ./3.3 //æŸ¥æ‰¾å½“å‰ç›®å½•å¤§äº10kå°äº100kçš„æ–‡ä»¶ [root@exercise1 tmp]# ll -h total 144K -rw-r--r-- 1 root root 11K Aug 9 13:35 1.1 -rw-r--r-- 1 root root 15K Aug 9 13:35 2.2 -rw-r--r-- 1 root root 110K Aug 9 13:35 3.3 -rw-r--r-- 1 root root 1.1K Aug 9 13:43 ip_date.txt [root@exercise1 tmp]# find . -size +10k -size -100k ./1.1 ./2.2 3.3 -user æŒ‰ç…§æ–‡ä»¶æ‰€æœ‰è€…æŸ¥æ‰¾ //æŸ¥æ‰¾æ–‡ä»¶æ‰€æœ‰è€…ä¸ºgunçš„æ–‡ä»¶ [root@exercise1 ~]# find / -user gun find: `/proc/5507/task/5507/fd/5': No such file or directory find: `/proc/5507/task/5507/fdinfo/5': No such file or directory find: `/proc/5507/fd/5': No such file or directory find: `/proc/5507/fdinfo/5': No such file or directory /var/spool/mail/gun /home/gun /home/gun/.bash_logout /home/gun/.bash_profile /home/gun/.bashrc //æŸ¥æ‰¾æ–‡ä»¶çš„æ—¶å€™ä¼šæœ‰æŠ¥é”™ ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ5507å°±æ˜¯è¿è¡Œfindå‘½ä»¤æ—¶ï¼Œfindå‘½ä»¤çš„PIDï¼Œåªåœ¨è¿è¡ŒæœŸé—´å‡ºç°ï¼Œç­‰findå‘½ä»¤è¿è¡Œå®Œæˆä¹‹åï¼Œå°±ä¼šæ¶ˆå¤±ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå®é™…é”™è¯¯ //è§£å†³æ–¹æ³•ï¼Œå°†é”™è¯¯è¾“å‡ºé‡å®šå‘ [root@exercise1 ~]# find / -user gun 2>/dev/null /var/spool/mail/gun /home/gun /home/gun/.bash_logout /home/gun/.bash_profile /home/gun/.bashrc 3.4 -perm æŒ‰ç…§æ–‡ä»¶æƒé™æŸ¥æ‰¾ 3.4.1 mode è¡¨ç¤ºç²¾ç¡®åŒ¹é… //æŸ¥æ‰¾æƒé™ä¸º755çš„æ–‡ä»¶æˆ–ç›®å½• [root@exercise1 test]# ll total 12 drwxr-xr-x 2 root root 4096 Aug 9 15:22 dir1 drwxrwxrwx 2 root root 4096 Aug 9 15:22 dir2 drwxr-xrw- 2 root root 4096 Aug 9 15:23 dir3 -rw-r--r-- 1 root root 0 Aug 9 15:38 file [root@exercise1 test]# find . -perm 755 . ./dir1 3.4.2 -mode è¡¨ç¤ºæƒé™æ¯ä¸€ä½è‡³å°‘åŒ¹é… //ç¤ºä¾‹ï¼šfind . -perm -111 è¡¨ç¤ºæ‰€æœ‰è€…ï¼Œæ‰€å±ç»„ï¼Œå…¶ä»–äººéƒ½è‡³å°‘æœ‰æ‰§è¡Œæƒé™ [root@exercise1 test]# ll total 12 drwxr-xr-x 2 root root 4096 Aug 9 2018 dir1 drwxrwxrwx 2 root root 4096 Aug 9 2018 dir2 drwxr-xrw- 2 root root 4096 Aug 9 2018 dir3 -rwxr--r-- 1 root root 0 Aug 9 2018 file [root@exercise1 test]# find . -perm -111 . ./dir1 ./dir2 3.4.3 +mode è¡¨ç¤ºæƒé™åªè¦æœ‰ä¸€ä½åŒ¹é…å³å¯ //ç¤ºä¾‹ï¼šfind . -perm +111 è¡¨ç¤ºæ‰€æœ‰è€…ï¼Œæ‰€å±ç»„ï¼Œå…¶ä»–äººä»»æ„ä¸€ä¸ªæœ‰æ‰§è¡Œæƒé™å°±å¯ä»¥ [root@exercise1 test]# ll total 12 drwxr-xr-x 2 root root 4096 Aug 9 2018 dir1 drwxrwxrwx 2 root root 4096 Aug 9 2018 dir2 drwxr-xrw- 2 root root 4096 Aug 9 2018 dir3 -rwxr--r-- 1 root root 0 Aug 9 2018 file [root@exercise1 test]# find . -perm +111 . ./dir3 ./dir1 ./file ./dir2 3.5 -type æŒ‰ç…§æ–‡ä»¶ç±»å‹æŸ¥æ‰¾ æ–‡ä»¶ç±»å‹ f æ™®é€šæ–‡ä»¶ d ç›®å½• l é“¾æ¥æ–‡ä»¶ c å­—ç¬¦è®¾å¤‡ b å—è®¾å¤‡ s å¥—æ¥å­—æ–‡ä»¶ p ç®¡é“ //ç¤ºä¾‹ï¼ŒæŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ [root@exercise1 test]# ll total 16 drwxr-xr-x 2 root root 4096 Aug 9 2018 dir1 drwxrwxrwx 2 root root 4096 Aug 9 2018 dir2 drwxr-xrw- 2 root root 4096 Aug 9 2018 dir3 -rwxr--r-- 1 root root 0 Aug 9 2018 file -rw-r--r-- 1 root root 178 Aug 7 14:19 hehe [root@exercise1 test]# find . -type f ./hehe ./file 3.6 æŒ‰ç…§æ—¶é—´æˆ³æŸ¥æ‰¾ +n è¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹æ˜¯åœ¨nå¤©ä¹‹å‰(å¸¸ç”¨ï¼Œç”¨äºåˆ é™¤nå¤©å‰çš„æ—¥å¿—) -n è¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹æ˜¯åœ¨nå¤©ä¹‹å†… -atime access è®¿é—®æ—¶é—´ï¼ŒæŒ‡æ–‡ä»¶è¢«è®¿é—®çš„æ—¶é—´ -ctime change æ”¹å˜æ—¶é—´ï¼ŒæŒ‡æ–‡ä»¶å±æ€§è¢«æ”¹å˜ -mtime modify ä¿®æ”¹æ—¶é—´ï¼ŒæŒ‡æ–‡ä»¶å†…å®¹è¢«ä¿®æ”¹ //ç¤ºä¾‹ï¼ŒæŸ¥æ‰¾/tmpä¸‹æ–‡ä»¶ä¿®æ”¹æ—¶é—´æ˜¯åœ¨3å¤©ä¹‹å‰çš„ [root@exercise1 ~]# find /tmp/ -mtime +3 /tmp/systemd-private-81d53e50debf4c9db3563ac49d9d3d6a-php-fpm.service-8iRh7w /tmp/systemd-private-81d53e50debf4c9db3563ac49d9d3d6a-php-fpm.service-8iRh7w/tmp /tmp/hsperfdata_root /tmp/.XIM-unix /tmp/.font-unix /tmp/supervisord.pid /tmp/mysql.sock /tmp/.X11-unix /tmp/.ICE-unix /tmp/supervisor.sock /tmp/systemd-private-81d53e50debf4c9db3563ac49d9d3d6a-ntpd.service-lCUH17 /tmp/systemd-private-81d53e50debf4c9db3563ac49d9d3d6a-ntpd.service-lCUH17/tmp /tmp/.Test-unix 3.7 -name æŒ‰ç…§æ–‡ä»¶åæŸ¥æ‰¾ //æŸ¥æ‰¾/tmpä¸­ä»¥.txtç»“å°¾çš„æ–‡ä»¶ [root@exercise1 test]# find /tmp -type f -name *.txt /tmp/test/3.txt /tmp/test/1.txt /tmp/test/2.txt /tmp/test/6/3.txt /tmp/test/6/1.txt /tmp/test/6/5.txt /tmp/test/6/2.txt /tmp/test/6/4.txt /tmp/test/6/6.txt /tmp/ip_date.txt 3.8 -regex åŸºäºæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ–‡ä»¶ [root@exercise1 test]# ls 1.pdf 1.py 1.txt [root@exercise1 test]# find . -regex \".*\\(\\.txt\\|\\.pdf\\)$\" ./1.pdf ./1.txt 3.9 -maxdepth å‘ä¸‹æœ€å¤§æ·±åº¦é™åˆ¶ä¸ºn(nä»£ç¬”æ•°å­—) //å½“å‰ç›®å½• [root@exercise1 test]# tree . . â”œâ”€â”€ a â”‚ â””â”€â”€ aa â”‚ â””â”€â”€ aaa â”œâ”€â”€ b â”‚ â””â”€â”€ bb â”‚ â””â”€â”€ bbb â””â”€â”€ c â””â”€â”€ cc 8 directories, 0 files //æŒ‡å®šæœ€å¤§æŸ¥æ‰¾æ·±åº¦ä¸º2 [root@exercise1 test]# find . -maxdepth 2 . ./b ./b/bb ./c ./c/cc ./a ./a/aa 3.10 -mindepth æœç´¢å‡ºæ·±åº¦è·ç¦»å½“å‰ç›®å½•è‡³å°‘nä¸ªå­ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ [root@exercise1 test]# tree . . â”œâ”€â”€ a â”‚ â””â”€â”€ aa â”‚ â””â”€â”€ aaa â”œâ”€â”€ b â”‚ â””â”€â”€ bb â”‚ â””â”€â”€ bbb â””â”€â”€ c â””â”€â”€ cc 8 directories, 0 files [root@exercise1 test]# find . -mindepth 2 ./b/bb ./b/bb/bbb ./b/bb/bbb/b.txt ./c/cc ./c/cc/c.txt ./a/aa ./a/aa/aaa ./a/aa/aaa/a.txt [root@exercise1 test]# find . -mindepth 1 ./b ./b/bb ./b/bb/bbb ./b/bb/bbb/b.txt ./c ./c/cc ./c/cc/c.txt ./a ./a/aa ./a/aa/aaa ./a/aa/aaa/a.txt [root@tencent test]# 3.11 findé€»è¾‘è¿ç®—ç¬¦ ç¬¦å· ä½œç”¨ -a ä¸ -o æˆ– -notæˆ–è€…! é 4.æ“ä½œ 4.1 -exec æ‰§è¡Œå‘½ä»¤ {}è¡¨ç¤ºå‰è¾¹åŒ¹é…çš„å†…å®¹ \\;æ˜¯å›ºå®šæ ¼å¼ æŸ¥æ‰¾/tmpä»¥.txtç»“å°¾çš„æ–‡ä»¶å¹¶åˆ é™¤ [root@exercise1 ~]# ls /opt 1.txt 2.txt 3.txt [root@exercise1 ~]# find /opt -type f -name *.txt -exec rm -rf {} \\; [root@exercise1 ~]# ls /opt 4.2 -ok åŠŸèƒ½ä¸-execç›¸åŒï¼Œæ‰§è¡Œå‘½ä»¤å‰ä¼šæç¤ºæ˜¯å¦æ‰§è¡Œ æŸ¥æ‰¾/tmpä»¥.txtç»“å°¾çš„æ–‡ä»¶å¹¶åˆ é™¤ [root@exercise1 ~]# find /opt -type f -name *.txt -ok rm -rf {} \\; ? findåŠ¨ä½œå¤„ç† åŠ¨ä½œ å«ä¹‰ -print æ‰“å°æŸ¥æ‰¾åˆ°çš„å†…å®¹(é»˜è®¤) -ls ä»¥é•¿æ ¼å¼æ˜¾ç¤ºçš„æ–¹å¼æ‰“å°æŸ¥æ‰¾åˆ°çš„å†…å®¹ -delete åˆ é™¤æŸ¥æ‰¾åˆ°çš„æ–‡ä»¶(ä»…èƒ½åˆ é™¤ç©ºç›®å½•) -ok åé¢è·Ÿè‡ªå®šä¹‰ shell å‘½ä»¤(ä¼šæç¤ºæ˜¯å¦æ“ä½œ) -exec åé¢è·Ÿè‡ªå®šä¹‰ shell å‘½ä»¤(æ ‡å‡†å†™æ³• -exec \\;) æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/è®¡åˆ’ä»»åŠ¡æ€»ç»“.html":{"url":"linux/linuxå‘½ä»¤/è®¡åˆ’ä»»åŠ¡æ€»ç»“.html","title":"è®¡åˆ’ä»»åŠ¡å‘½ä»¤","keywords":"","body":"è®¡åˆ’ä»»åŠ¡æ€»ç»“ 1.crontabå‘½ä»¤ 1.1å‘½ä»¤è¯´æ˜ crontabå‘½ä»¤çš„åŠŸèƒ½æ˜¯åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”æ‰§è¡Œå®šä¹‰å¥½çš„å‘½ä»¤æˆ–è„šæœ¬ 1.2å‘½ä»¤æ ¼å¼ crontab é€‰é¡¹ å‚æ•° 1.3é€‰é¡¹ -e ç¼–è¾‘è®¡åˆ’ä»»åŠ¡ ç›¸å½“äº vim /var/spool/cron/root -l æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡ -r æ¸…é™¤è®¡åˆ’ä»»åŠ¡ æ…ç”¨ï¼ï¼ï¼ -u user æŒ‡å®šè¦è®¾å®šè®¡åˆ’ä»»åŠ¡çš„ç”¨æˆ· 1.4æ ¼å¼ å­—æ®µå«ä¹‰ minute hour day month week command é¡ºåºï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨ å­—æ®µè¯´æ˜ å­—æ®µ å«ä¹‰ minute è¡¨ç¤ºåˆ†é’Ÿï¼Œå¯ä»¥æ˜¯ä»0åˆ°59ä¹‹é—´çš„ä»»ä½•æ•´æ•° hour è¡¨ç¤ºå°æ—¶ï¼Œå¯ä»¥æ˜¯ä»0åˆ°23ä¹‹é—´çš„ä»»ä½•æ•´æ•° day è¡¨ç¤ºæ—¥æœŸï¼Œå¯ä»¥æ˜¯ä»1åˆ°31ä¹‹é—´çš„ä»»ä½•æ•´æ•° month è¡¨ç¤ºæœˆä»½ï¼Œå¯ä»¥æ˜¯ä»1åˆ°12ä¹‹é—´çš„ä»»ä½•æ•´æ•° week è¡¨ç¤ºæ˜ŸæœŸå‡ ï¼Œå¯ä»¥æ˜¯ä»0åˆ°7ä¹‹é—´çš„ä»»ä½•æ•´æ•°ï¼Œè¿™é‡Œçš„0æˆ–7ä»£è¡¨æ˜ŸæœŸæ—¥ command è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¯ä»¥æ˜¯ç³»ç»Ÿå‘½ä»¤ï¼Œä¹Ÿå¯ä»¥æ˜¯è‡ªå·±ç¼–å†™çš„è„šæœ¬æ–‡ä»¶ åœ¨ä»¥ä¸Šå„ä¸ªå­—æ®µä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç‰¹æ®Šå­—ç¬¦ ç¬¦å· å«ä¹‰ æ˜Ÿå·ï¼ˆ*ï¼‰ ä»£è¡¨æ‰€æœ‰å¯èƒ½çš„å€¼ï¼Œä¾‹å¦‚monthå­—æ®µå¦‚æœæ˜¯æ˜Ÿå·ï¼Œåˆ™è¡¨ç¤ºåœ¨æ»¡è¶³å…¶å®ƒå­—æ®µçš„åˆ¶çº¦æ¡ä»¶åæ¯æœˆéƒ½æ‰§è¡Œè¯¥å‘½ä»¤æ“ä½œ é€—å·ï¼ˆ,ï¼‰ å¯ä»¥ç”¨é€—å·éš”å¼€çš„å€¼æŒ‡å®šä¸€ä¸ªåˆ—è¡¨èŒƒå›´ï¼Œä¾‹å¦‚ï¼Œâ€œ1,2,5,7,8,9â€ ä¸­æ ï¼ˆ-ï¼‰ å¯ä»¥ç”¨æ•´æ•°ä¹‹é—´çš„ä¸­æ è¡¨ç¤ºä¸€ä¸ªæ•´æ•°èŒƒå›´ï¼Œä¾‹å¦‚â€œ2-6â€è¡¨ç¤ºâ€œ2,3,4,5,6â€ æ­£æ–œçº¿ï¼ˆ/ï¼‰ å¯ä»¥ç”¨æ­£æ–œçº¿æŒ‡å®šæ—¶é—´çš„é—´éš”é¢‘ç‡ï¼Œä¾‹å¦‚â€œ0-23/2â€è¡¨ç¤ºæ¯ä¸¤å°æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚åŒæ—¶æ­£æ–œçº¿å¯ä»¥å’Œæ˜Ÿå·ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚*/10ï¼Œå¦‚æœç”¨åœ¨minuteå­—æ®µï¼Œè¡¨ç¤ºæ¯ååˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ 1.4.1ä½¿ç”¨ç¤ºä¾‹ æ¯åˆ†é’Ÿæ‰§è¡Œntpdateå‘½ä»¤åŒæ­¥æ—¶é—´ * * * * * /usr/sbin/ntpdate ntp2.aliyun.com >/dev/null 2>&1 æ¯å°æ—¶çš„ç¬¬3,5åˆ†é’Ÿæ‰§è¡Œ 3,5 * * * * command ä¸Šåˆçš„8ç‚¹åˆ°11ç‚¹çš„ç¬¬3å’Œç¬¬15åˆ†æ‰§è¡Œ 3ï¼Œ15 8-11 * * * command æ¯éš”ä¸¤å¤©çš„ä¸Šåˆ8ç‚¹åˆ°11ç‚¹çš„ç¬¬3å’Œç¬¬15åˆ†é’Ÿæ‰§è¡Œ 3,15 8-11 */2 * * command æ¯å¤©21ç‚¹30åˆ†æ‰§è¡Œ 30 21 * * * command æ¯å‘¨å…­ã€æ—¥ä¸Šåˆ10ç‚¹10åˆ†æ‰§è¡Œ 10 10 * * 6,7 command æ¯å¤©12ç‚¹æ‰§è¡Œ 00 12 * * * command 1.5é…ç½®æ–‡ä»¶ 1.5.1 /etc/crontab ä¸»é…ç½®æ–‡ä»¶ SHELL=/bin/bash PATH=/sbin:/bin:/usr/sbin:/usr/bin MAILTO=root HOME=/ # For details see man 4 crontabs # Example of job definition: # .---------------- minute (0 - 59) # | .------------- hour (0 - 23) # | | .---------- day of month (1 - 31) # | | | .------- month (1 - 12) OR jan,feb,mar,apr ... # | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat # | | | | | # * * * * * user-name command to be executed //é…ç½®æ–‡ä»¶è¯´æ˜ SHELL=/bin/bash #SHELLå˜é‡æŒ‡å®šäº†ç³»ç»Ÿè¦ä½¿ç”¨å“ªä¸ªshellï¼Œè¿™é‡Œæ˜¯bash PATH=/sbin:/bin:/usr/sbin:/usr/bin #PATHå˜é‡æŒ‡å®šäº†ç³»ç»Ÿæ‰§è¡Œå‘½ä»¤çš„è·¯å¾„ MAILTO=root #MAILTOå˜é‡æŒ‡å®šäº†crondçš„ä»»åŠ¡æ‰§è¡Œä¿¡æ¯å°†é€šè¿‡ç”µå­é‚®ä»¶å‘é€ç»™rootç”¨æˆ·ï¼Œå¦‚æœMAILTOå˜é‡çš„å€¼ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºä¸å‘é€ä»»åŠ¡æ‰§è¡Œä¿¡æ¯ç»™ç”¨æˆ· HOME=/ #HOMEå˜é‡æŒ‡å®šäº†åœ¨æ‰§è¡Œå‘½ä»¤æˆ–è€…è„šæœ¬æ—¶ä½¿ç”¨çš„ä¸»ç›®å½• 1.5.2 /etc/cron.deny é»˜è®¤æƒ…å†µä¸‹æ™®é€šç”¨æˆ·å¯ä»¥ä½¿ç”¨crontabå‘½ä»¤ï¼Œæ­¤æ–‡ä»¶ä¸­çš„ç”¨æˆ·ä¸èƒ½ä½¿ç”¨crontabå‘½ä»¤ç¼–è¾‘è®¡åˆ’ä»»åŠ¡ [root@localhost ~]# cat /etc/cron.deny u1 å†™å…¥åˆ°/etc/cron.denyæ–‡ä»¶ä¸­çš„ç”¨æˆ·å°†ä¸èƒ½ä½¿ç”¨crontabå‘½ä»¤ç¼–è¾‘è®¡åˆ’ä»»åŠ¡ [u1@localhost ~]$ crontab -e You (u1) are not allowed to use this program (crontab) See crontab(1) for more information 1.5.3 /etc/cron.allow æ­¤æ–‡ä»¶ä¸­çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨crontabå‘½ä»¤ç¼–è¾‘è®¡åˆ’ä»»åŠ¡ï¼Œæ­¤æ–‡ä»¶ä¼˜å…ˆçº§æ¯”/etc/cron.denyé«˜ï¼Œä¸¤ä¸ªæ–‡ä»¶åŒæ—¶å­˜åœ¨ï¼Œä»¥allowæ–‡ä»¶ä¸ºä¸» [root@localhost ~]# cat /etc/cron.allow u1 1.5.4 /var/spool/cron ç”¨æˆ·çš„è®¡åˆ’ä»»åŠ¡æ–‡ä»¶ç›®å½• [root@localhost cron]# pwd /var/spool/cron [root@localhost cron]# ls root u1 2.atå‘½ä»¤ 2.1å‘½ä»¤è¯´æ˜ atå‘½ä»¤åªæ˜¯æƒ³è¦è®©ç‰¹å®šä»»åŠ¡è¿è¡Œä¸€æ¬¡ ctrl+dé€€å‡ºatå‘½ä»¤ç¼–è¾‘ 2.2å‘½ä»¤æ ¼å¼ at é€‰é¡¹ æ—¶é—´ 2.3é€‰é¡¹ -V æ˜¾ç¤ºç‰ˆæœ¬å· [root@localhost tmp]# at -V at version 3.1.10 -f file è¯»å–æ–‡ä»¶ï¼Œatä¸ä¸€å®šéè¦é€šè¿‡äº¤äº’å¼è¾“å…¥æ¥æŒ‡å®šæ“ä½œï¼Œä¹Ÿå¯ä»¥è¯»å–è„šæœ¬æ–‡ä»¶ [root@localhost ~]# cat a.sh #!/bin/bash # touch /tmp/a.txt [root@localhost ~]# at -f /root/a.sh 15:30 #15ç‚¹30åˆ†æ‰§è¡Œ/root/a.sh job 8 at 2018-08-11 15:30 -l åˆ—å‡ºæ‰€æœ‰çš„æŒ‡å®šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨atqå‘½ä»¤ [root@localhost ~]# at -l 8 2018-08-11 15:30 a root [root@localhost ~]# atq 9 2018-08-12 15:31 a root -d åˆ é™¤ä»»åŠ¡ 2.4ä½¿ç”¨ç¤ºä¾‹ æ—¶é—´ å†™æ³•ç¤ºä¾‹ è¯´æ˜ Minute å‘½ä»¤ at now + 5 minutes ä»»åŠ¡åœ¨5åˆ†é’Ÿåè¿è¡Œ Hour å‘½ä»¤ at now + 1 hour ä»»åŠ¡åœ¨1å°æ—¶åè¿è¡Œ Days å‘½ä»¤ at now + 3 days ä»»åŠ¡åœ¨3å¤©åè¿è¡Œ Weeks å‘½ä»¤ at now + 2 weeks ä»»åŠ¡åœ¨ä¸¤å‘¨åè¿è¡Œ Fixed å‘½ä»¤ at midnigt ä»»åŠ¡åœ¨åˆå¤œè¿è¡Œ Fixed å‘½ä»¤ at 10:30 pm ä»»åŠ¡åœ¨æ™šä¸Š10ç‚¹30åˆ†è¿è¡Œ Fixed å‘½ä»¤ at 23:59 12/31/2018 ä»»åŠ¡åœ¨2018å¹´12æœˆ31å·23ç‚¹59åˆ†è¿è¡Œ 2.5atä¸€æ¬¡æ€§è®¡åˆ’ä»»åŠ¡æ–‡ä»¶ 2.5.1 /var/spool/at atä¸€æ¬¡æ€§è®¡åˆ’ä»»åŠ¡æ–‡ä»¶ [root@localhost at]# pwd /var/spool/at [root@localhost at]# ls a00009018621a3 a0000b01861c98 a0000c01861f2c spool a00009018621a3 a0000b01861c98 a0000c01861f2cå°±æ˜¯atä¸€æ¬¡æ€§è®¡åˆ’ä»»åŠ¡æ–‡ä»¶ åªèƒ½çœ‹åˆ°å…·ä½“å‘½ä»¤ï¼Œæ— æ³•æŸ¥çœ‹å…·ä½“æ‰§è¡Œæ—¶é—´ 2.5.2 deny,allowæ–‡ä»¶ï¼Œä½œç”¨ä¸crondä¸€æ ·ï¼Œallowæ–‡ä»¶ä¼˜å…ˆäºdenyæ–‡ä»¶ /etc/at.deny /etc/at.allow æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/å½’æ¡£å‹ç¼©å‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/å½’æ¡£å‹ç¼©å‘½ä»¤.html","title":"å½’æ¡£å‹ç¼©å‘½ä»¤","keywords":"","body":"å½’æ¡£å‹ç¼©å‘½ä»¤ 1.å½’æ¡£å‘½ä»¤tar 1.1å‘½ä»¤è¯´æ˜ ç”¨æ¥å‹ç¼©å’Œè§£å‹æ–‡ä»¶ï¼Œtaræœ¬èº«ä¸å…·æœ‰å‹ç¼©åŠŸèƒ½ï¼Œä»–æ˜¯è°ƒç”¨å‹ç¼©åŠŸèƒ½å®ç°çš„ 1.2å‘½ä»¤æ ¼å¼ tar [option] å½’æ¡£åçš„æ–‡ä»¶å è¦å½’æ¡£çš„æ–‡ä»¶ 1.3é€‰é¡¹ 1.3.1å‹ç¼©é€‰é¡¹(éƒ½å¿…é¡»é…åˆ-fé€‰é¡¹) âš ï¸å‹ç¼©é€‰é¡¹å‰è¾¹çš„-å¯ä»¥ä¸åŠ  -f ä½¿ç”¨å½’æ¡£æ–‡ä»¶ -c å»ºç«‹ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ -h ä¸å‹ç¼©é“¾æ¥æ–‡ä»¶ï¼Œå‹ç¼©é“¾æ¥æ–‡ä»¶æºæ–‡ä»¶ ä¸åŠ -hé€‰é¡¹ï¼Œæ‰“åŒ…é“¾æ¥æ–‡ä»¶è§£å‹åä¼šé€ æˆæ–­é“¾ åŠ -hé€‰é¡¹åï¼Œæ‰“åŒ…é“¾æ¥æ–‡ä»¶å¹¶è§£å‹å°±æ²¡æœ‰é—®é¢˜äº† -z æ‰“åŒ…åè°ƒç”¨gzipå‹ç¼© -j æ‰“åŒ…åè°ƒç”¨bzip2å‹ç¼© -r/-u å‘å‹ç¼©æ–‡ä»¶æœ«å°¾è¿½åŠ æ–‡ä»¶ï¼Œæ›´æ–°å‹ç¼©æ–‡ä»¶ --exclude æŒ‡å®šä¸æ‰“åŒ…æ–‡ä»¶ -P ä¸æ˜¾ç¤ºä»æˆå‘˜åä¸­åˆ é™¤ ä¸åŠ -Pçš„æ•ˆæœ å¯ä»¥çœ‹åˆ°ï¼ŒåŠ ä¸Š-Pé€‰é¡¹ä¹‹åä¸æç¤ºtar: Removing leading `/' from member names -p ä¿æŒæºæ–‡ä»¶å±æ€§ä¸å˜ 1.3.2è§£å‹ç¼©é€‰é¡¹ -x è§£å‹ç¼©æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨xfç›´æ¥è§£å‹ç¼©ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£å‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨-zã€-jé€‰é¡¹è§£å‹ç¼©æ–‡ä»¶ -C å°†å‹ç¼©å½’æ¡£æ–‡ä»¶è§£å‹åˆ°å“ªä¸ªä½ç½® 1.3.3æŸ¥çœ‹å‹ç¼©é€‰é¡¹ -t æŸ¥çœ‹å‹ç¼©æ–‡ä»¶ä¸­çš„æ–‡ä»¶ 2.å‹ç¼©å‘½ä»¤gzip 2.1å‘½ä»¤è¯´æ˜ ç”¨æ¥å‹ç¼©æ–‡ä»¶ 2.2å‘½ä»¤æ ¼å¼ gzip [option] file 2.3é€‰é¡¹ 2.3.1å‹ç¼©é€‰é¡¹ -c ä¿ç•™æºæ–‡ä»¶ï¼Œéœ€è¦ç»“åˆé‡å®šå‘ç¬¦å· ä¸åŠ -cé€‰é¡¹ï¼Œå‹ç¼©æ–‡ä»¶åæºæ–‡ä»¶æ²¡æœ‰è¢«ä¿ç•™ gzip -c æºæ–‡ä»¶ > /xx/xx.gz -n nè¡¨ç¤ºæ•°å­—ï¼Œç”¨äºæŒ‡å®šå‹ç¼©æ¯”ï¼ŒèŒƒå›´æ˜¯1-9ï¼Œå‹ç¼©æ¯”è¶Šå¤§å‹ç¼©æ—¶é—´è¶Šé•¿ï¼Œé»˜è®¤æ˜¯6 2.3.2è§£å‹ç¼©é€‰é¡¹ -d è§£å‹ç¼© 2.3.3æŸ¥çœ‹å‹ç¼©é€‰é¡¹ ä½¿ç”¨zcatå‘½ä»¤æŸ¥çœ‹.gzå‹ç¼©æ–‡ä»¶çš„å†…å®¹ 2.3.4å…¶ä»–é€‰é¡¹ -v æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ -t æ£€æµ‹å‹ç¼©æ–‡ä»¶æ­£ç¡®æ€§ -V æ˜¾ç¤ºgzipç‰ˆæœ¬ä¿¡æ¯ 3.å‹ç¼©å‘½ä»¤bzip2 3.1å‘½ä»¤è¯´æ˜ bzip2å‘½ä»¤ç”¨æ¥è§£å‹ç¼©æ–‡ä»¶ï¼Œå‹ç¼©æ¯”æ¯”bzipå¤§ 3.2å‘½ä»¤æ ¼å¼ gzip [option] file 3.3é€‰é¡¹ 3.3.1å‹ç¼©é€‰é¡¹ -k ä¿ç•™æºæ–‡ä»¶ ä¸åŠ -ké€‰é¡¹ï¼Œå‹ç¼©æ–‡ä»¶åæºæ–‡ä»¶æ²¡æœ‰è¢«ä¿ç•™ bzip2 -k æºæ–‡ä»¶ï¼Œå‹ç¼©åä¿ç•™æºæ–‡ä»¶ -n nè¡¨ç¤ºæ•°å­—ï¼Œç”¨äºæŒ‡å®šå‹ç¼©æ¯”ï¼ŒèŒƒå›´æ˜¯1-9ï¼Œå‹ç¼©æ¯”è¶Šå¤§å‹ç¼©æ—¶é—´è¶Šé•¿ï¼Œé»˜è®¤6 3.3.2è§£å‹ç¼©é€‰é¡¹ -d è§£å‹ç¼© 3.3.3æŸ¥çœ‹å‹ç¼©é€‰é¡¹ ä½¿ç”¨bzcatæŸ¥çœ‹.bz2å‹ç¼©æ–‡ä»¶ 3.3.4å…¶ä»–é€‰é¡¹ -v æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ -t æ£€æµ‹å‹ç¼©æ–‡ä»¶æ­£ç¡®æ€§ -V æ˜¾ç¤ºbzip2ç‰ˆæœ¬ä¿¡æ¯ æ€»ç»“ ç±»å‹ è§£å‹æ–¹æ³• *.tar ç”¨tar -xvfè§£å‹ *.gz ç”¨gzip -dæˆ–gunzipè§£å‹ *.tar.gz å’Œ *.tgz ç”¨tar -xzfè§£å‹ *.xz ç”¨tar -jxvfè§£å‹ *.bz2 ç”¨bzip2 -dæˆ–bunzip2è§£å‹ *.tar.bz2 ç”¨tar -xjfè§£å‹ *.Z ç”¨uncompressè§£å‹ *.tar.Z ç”¨tar -xZfè§£å‹ *.rar ç”¨unrar -eè§£å‹ *.zip ç”¨unzipè§£å‹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/ç£ç›˜ç›¸å…³å‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/ç£ç›˜ç›¸å…³å‘½ä»¤.html","title":"ç£ç›˜ç›¸å…³å‘½ä»¤","keywords":"","body":"ç£ç›˜ç›¸å…³å‘½ä»¤ 1.fdisk 1.1å‘½ä»¤è¯´æ˜ fdiskæ˜¯ä¸€ä¸ªç£ç›˜æ“ä½œå·¥å…·ï¼Œä¸»è¦æ“ä½œ2Tä»¥ä¸‹çš„ç£ç›˜ 1.2å‘½ä»¤æ ¼å¼ fdisk é€‰é¡¹ è®¾å¤‡å 1.3é€‰é¡¹ -u ç£ç›˜åˆ†åŒºçš„æ—¶å€™ä»¥æ‰‡åŒºä¸ºå•ä½ï¼Œé»˜è®¤æ˜¯æŸ±é¢ -l æŸ¥çœ‹ç£ç›˜ä¿¡æ¯ -c å…³é—­doså…¼å®¹æ¨¡å¼ âš ï¸ä¸åŠ -cé€‰é¡¹å°±ä¼šæç¤ºä¸æ”¯æŒdoså…¼å®¹æ¨¡å¼ 1.4åˆ†åŒºè¯´æ˜ 1.4.1 frisk è®¾å¤‡å åˆ†åŒºç•Œé¢åçš„é€‰é¡¹ è¿›å…¥åˆ†åŒºç•Œé¢åæŒ‰mé”®ä¼šæç¤ºå¸®åŠ©ä¿¡æ¯ï¼Œçº¢è‰²å­—ä½“ä¸ºå¸¸ç”¨é€‰é¡¹ Command (m for help): m Command action a toggle a bootable flag #åˆ‡æ¢ä¸€ä¸ªå¯å¯åŠ¨çš„æ ‡å¿— b edit bsd disklabel #ç¼–è¾‘bsdç£ç›˜æ ‡ç­¾ c toggle the dos compatibility flag #åˆ‡æ¢doså…¼å®¹æ ‡å¿— d delete a partition #åˆ é™¤åˆ†åŒº l list known partition types #å·²çŸ¥çš„åˆ†åŒºè¡¨ç±»å‹ m print this menu #æ˜¾ç¤ºå¸®åŠ©èœå• n add a new partition #åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†åŒº o create a new empty DOS partition table #åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºDOSåˆ†åŒºè¡¨ p print the partition table #æ‰“å°åˆ†åŒºè¡¨ q quit without saving changes #ä¸ä¿å­˜é€€å‡º s create a new empty Sun disklabel #åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºsunç£ç›˜æ ‡ç­¾ t change a partition's system id #æ”¹å˜åˆ†åŒºçš„ç³»ç»Ÿid u change display/entry units #æ”¹å˜æ˜¾ç¤ºè¾“å…¥å•å…ƒ v verify the partition table #éªŒè¯åˆ†åŒºè¡¨ w write table to disk and exit #ä¿å­˜é€€å‡º x extra functionality (experts only) #é¢å¤–çš„åŠŸèƒ½ 1.4.2åˆ›å»ºä¸€ä¸ªä¸»åˆ†åŒº ç¬¬ä¸€æ­¥ã€fdisl+è®¾å¤‡åè¿›å…¥åˆ†åŒºç•Œé¢ï¼ŒæŒ‰nä¼šæç¤ºåˆ›å»ºä¸»åˆ†åŒºè¿˜æ˜¯æ‰©å±•åˆ†åŒº ç¬¬äºŒæ­¥ã€æŒ‰pï¼Œç„¶åæŒ‡å®šä¸»åˆ†åŒºå·ä¸º1 ç¬¬ä¸‰æ­¥ã€èµ·å§‹æ‰‡åŒºé»˜è®¤å³å¯ï¼Œç„¶åå¤§å°æŒ‡å®š10M ç¬¬å››æ­¥ã€æŸ¥çœ‹åˆ›å»ºçš„ä¸»åˆ†åŒº 1.4.3åˆ›å»ºæ‰©å±•åˆ†åŒºå’Œé€»è¾‘åˆ†åŒº é€»è¾‘åˆ†åŒºä¾èµ–äºæ‰©å±•åˆ†åŒºï¼Œé€»è¾‘åˆ†åŒºç¼–å·ä»5å¼€å§‹ï¼Œæ‰©å±•åˆ†åŒºåªèƒ½æœ‰ä¸€ä¸ª ç¬¬ä¸€æ­¥ã€æŒ‰nåˆ›å»ºåˆ†åŒºåæŒ‰eé€‰æ‹©æ‰©å±•åˆ†åŒºï¼Œå¹¶æŒ‡å®šåˆ†åŒºç¼–å·ä¸º2 ç¬¬äºŒæ­¥ã€èµ·å§‹æ‰‡åŒºå¤§å°é»˜è®¤å³å¯ï¼Œå°†ç£ç›˜å‰©ä½™çš„ç©ºé—´å…¨éƒ¨ç»™æ‰©å±•åˆ†åŒº ç¬¬ä¸‰æ­¥ã€æŒ‰nï¼Œç„¶åæŒ‰låˆ›å»ºé€»è¾‘åˆ†åŒºï¼Œå¹¶æŒ‡å®šå¤§å°ä¸º50M ç¬¬å››æ­¥ã€æŸ¥çœ‹åˆšåˆ›å»ºçš„æ‰©å±•åˆ†åŒºå’Œé€»è¾‘åˆ†åŒº 2.partedå‘½ä»¤ 2.1å‘½ä»¤è¯´æ˜ partedå‘½ä»¤ä¸»è¦ç”¨äºå¯¹2Tä»¥ä¸Šçš„ç£ç›˜è¿›è¡Œåˆ†åŒºæ“ä½œï¼Œæ”¯æŒMBRåˆ†åŒºè¡¨ï¼ˆåªèƒ½æœ‰4ä¸ªä¸»åˆ†åŒºï¼‰ï¼Œæ”¯æŒGPTåˆ†åŒºè¡¨ï¼ˆä¸»åˆ†åŒºå¯ä»¥æœ‰å¤šä¸ªï¼‰ï¼Œpartedå¯¹ç£ç›˜çš„ä¿®æ”¹æ˜¯å®æ—¶ç”Ÿæ•ˆçš„ï¼ 2.2å‘½ä»¤æ ¼å¼ parted è®¾å¤‡å 2.3å¸¸ç”¨å‘½ä»¤ print æ˜¾ç¤ºåˆ†åŒºä¿¡æ¯ mktable/mklabel åˆ›å»ºç£ç›˜åˆ†åŒºè¡¨ mkpart åˆ›å»ºåˆ†åŒº rm åˆ é™¤åˆ†åŒº q é€€å‡ºä¸ä¿å­˜ 2.4partedäº¤äº’å¼åˆ›å»ºåˆ†åŒº ç¬¬ä¸€æ­¥ã€æŒ‡å®šåˆ†åŒºè¡¨ç±»å‹ mklable gpt ç¬¬äºŒæ­¥ã€åˆ›å»ºåˆ†åŒº mkpart primary 0 10 åˆ›å»ºä¸€ä¸ª10Mçš„ä¸»åˆ†åŒºï¼Œåˆ†åŒºåç§°ä»»æ„ ç¬¬ä¸‰æ­¥ã€æŸ¥çœ‹åˆ›å»ºçš„åˆ†åŒº 2.5partedéäº¤äº’å¼åˆ›å»ºåˆ†åŒº ç¬¬ä¸€æ­¥ã€æŒ‡å®šåˆ†åŒºè¡¨ç±»å‹ parted /dev/sdc mklabel gpt ç¬¬äºŒæ­¥ã€åˆ›å»ºä¸»åˆ†åŒº parted /dev/sdc mkpart 1 100% ç¬¬ä¸‰æ­¥ã€æŸ¥çœ‹åˆ†åŒº parted /dev/sdc p 3.å¢åŠ äº¤æ¢åˆ†åŒº 3.1å¢åŠ swap ä½¿ç”¨ddå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ dd if=/dev/zero of=/tmp/file bs=1M count=10 3.2æŠŠåˆ›å»ºçš„æ–‡ä»¶å˜ä¸ºswap mkswap æ–‡ä»¶å 3.3æ¿€æ´»swap swapon æ–‡ä»¶å 3.4æŒ‚è½½swap âš ï¸âš ï¸âš ï¸ä¸€å®šè¦ç”¨è¿½åŠ >> echo \"/tmp/swap1 swap swap defaults 0 0\" >>/etc/fstab /tmp/swap1 swap swap defaults 0 0 è®¾å¤‡å æŒ‚è½½ç‚¹ æ–‡ä»¶ç³»ç»Ÿ å‚æ•°é€‰é¡¹ æ˜¯å¦å¤‡ä»½ æ˜¯å¦å¼€æœºæ£€æµ‹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/Linuxæƒé™æ€»ç»“.html":{"url":"linux/linuxå‘½ä»¤/Linuxæƒé™æ€»ç»“.html","title":"Linuxæƒé™æ€»ç»“","keywords":"","body":"linuxæƒé™æ€»ç»“ 1.linuxæ™®é€šæƒé™ 1.1æ–‡ä»¶æƒé™æŸ¥çœ‹ [root@exercise1 ~]# ll -rw-r--r--. 1 root root 7570 Aug 4 13:15 install.log.syslog drwxr-xr-x 9 root root 4096 Aug 8 12:07 test 1.2ç”¨æˆ·åˆ†ç»„æƒé™æ¦‚å¿µ -rw-r--r-- æƒé™ å«ä¹‰ ç¬¬1ä½ - è¡¨ç¤ºæ–‡ä»¶ç±»å‹ï¼Œ-è¡¨ç¤ºæ™®é€šæ–‡ä»¶ï¼Œdè¡¨ç¤ºç›®å½• ç¬¬2-4ä½ rw- è¡¨ç¤ºæ–‡ä»¶æ‰€æœ‰è€…æƒé™ ç¬¬5-7ä½ r-- è¡¨ç¤ºæ–‡ä»¶æ‰€å±ç»„æƒé™ ç¬¬8-10ä½ r-- è¡¨ç¤ºæ–‡ä»¶å…¶ä»–äººæƒé™ 1.3æƒé™ä½å«ä¹‰ æƒé™ä½ å«ä¹‰ r è¯» w å†™ x æ‰§è¡Œ 1.4æƒé™ä½æ•°å­—è¡¨ç¤ºæ³• è¯»+å†™+æ‰§è¡Œ=4+2+1=7 æƒé™ä½ æ•°å­— å«ä¹‰ r 4 è¯» w 2 å†™ x 1 æ‰§è¡Œ 1.5æƒé™å¯¹æ–‡ä»¶åŠç›®å½•å«ä¹‰ 1.5.1æ–‡ä»¶rwxæƒé™ æƒé™ä½ å«ä¹‰ r è¯»å–æ–‡ä»¶å†…å®¹ w ä¿®æ”¹æ–‡ä»¶å†…å®¹ éœ€è¦ræƒé™é…åˆåªæœ‰wæƒé™çš„æ—¶å€™ å¼ºåˆ¶ä¿å­˜é€€å‡ºä¼šå¯¼è‡´æºæ–‡ä»¶å†…å®¹ä¸¢å¤± x è¡¨ç¤ºæ˜¯å¦æ‰§è¡Œ éœ€è¦ræƒé™é…åˆ 1.5.2ç›®å½•rwxæƒé™ æƒé™ä½ å«ä¹‰ r æŸ¥çœ‹ç›®å½•å†…å®¹ ç›¸å½“äºls éœ€è¦xæƒé™é…åˆ w æ˜¯å¦èƒ½åˆ é™¤ç›®å½•å†…å®¹ æ˜¯å¦èƒ½åœ¨ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶ é‡å‘½å ç›®å½•ä¸­çš„æ–‡ä»¶ x æ˜¯å¦èƒ½è¿›å…¥åˆ°ç›®å½• æ˜¯å¦èƒ½æŸ¥çœ‹ç›®å½•ä¸­æ–‡ä»¶çš„å±æ€§ 2.linuxç‰¹æ®Šæƒé™ 2.1suid ç”¨æˆ·åœ¨è¿è¡Œå‘½ä»¤çš„æ—¶å€™ç›¸å½“äºrootç”¨æˆ· è®¾ç½®æ–¹æ³• u+s ç¤ºä¾‹è¯´æ˜ 1.æ™®é€šç”¨æˆ·wwwæ— æ³•ä½¿ç”¨lesså‘½ä»¤æŸ¥çœ‹/ç³»ç»Ÿæ—¥å¿—/var/log/messages 2.ç»™/usr/bin/lessè®¾ç½®suid è®¾ç½®suidåæ–‡ä»¶æƒé™æ‰€æœ‰è€…å¤„å°±å˜ä¸ºrwsï¼Œå¤šäº†ä¸€ä¸ªsæƒé™ï¼Œå¹¶ä¸”æ–‡ä»¶åº•è‰²å˜æˆäº†çº¢è‰² statæŸ¥çœ‹æ–‡ä»¶å±æ€§ï¼Œæ­¤æ—¶æ–‡ä»¶æƒé™ä½4755 3.ä¸º/usr/bin/lessè®¾ç½®suidåwwwç”¨æˆ·å°±å¯ä»¥æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—äº† 2.2sgid ç”¨æˆ·è‹¥å¯¹æ­¤ç›®å½•å…·æœ‰rä¸xçš„æƒé™æ—¶ï¼Œè¯¥ç”¨æˆ·èƒ½å¤Ÿè¿›å…¥æ­¤ç›®å½•ï¼› ç”¨æˆ·åœ¨æ­¤ç›®å½•ä¸‹çš„æœ‰æ•ˆç”¨æˆ·ç»„å°†ä¼šå˜æˆè¯¥ç›®å½•çš„ç”¨æˆ·ç»„ï¼› è‹¥ç”¨æˆ·åœ¨æ­¤ç›®å½•ä¸‹å…·æœ‰wçš„æƒé™ï¼Œåˆ™ç”¨æˆ·åˆ›å»ºæ–°æ–‡ä»¶çš„ç”¨æˆ·ç»„ä¸æ­¤ç›®å½•çš„ç”¨æˆ·ç»„ç›¸åŒ è®¾ç½®æ–¹æ³• g+s ç¤ºä¾‹è¯´æ˜ 1.æ™®é€šç”¨æˆ·wwwå¯¹/tmpç›®å½•æœ‰777æƒé™ï¼Œåœ¨æ²¡æœ‰è®¾ç½®/tmpçš„sgidæ—¶ï¼Œwwwç”¨æˆ·åœ¨æ­¤åˆ›å»ºçš„æ–‡ä»¶å’Œç›®å½•å±ç»„æ˜¯æœ¬èº«,å³www 2.ä¸º/tmpç›®å½•è®¾ç½®sgidåï¼Œwwwç”¨æˆ·åœ¨/tmpä¸‹åˆ›å»ºçš„æ–‡ä»¶å’Œç›®å½•å±ç»„å°±æ˜¯root 2.3sbit stickyç²˜æ»ä½ å½“ä¸€ä¸ªç”¨æˆ·å¯¹æŸç›®å½•æ˜¯å…·æœ‰ç”¨æˆ·ç»„æˆ–å…¶ä»–äººçš„èº«ä»½ï¼Œå¹¶å…·æœ‰wæƒé™(å³å…·æœ‰å†™å…¥çš„æƒé™æ—¶)ï¼Œè¿™è¡¨æ˜è¯¥ç”¨æˆ·å¯ä»¥å¯¹è¯¥ç›®å½•ä¸‹ä»»ä½•äººæ–°å»ºçš„ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œåˆ é™¤ã€ç§»åŠ¨ã€é‡å‘½åç­‰æ“ä½œã€‚ä¸è¿‡ï¼Œå¦‚æœè¯¥ç›®å½•å…·æœ‰SBITæƒé™æ—¶ï¼Œåˆ™ä»…æœ‰æ–‡ä»¶å±ä¸»å’Œrootæ‰èƒ½åˆ é™¤ã€ç§»åŠ¨ã€é‡å‘½åæ­¤æ–‡ä»¶ï¼Œæ™®é€šç”¨æˆ·æ— æ³•åˆ é™¤è¯¥ç›®å½•ä¸‹ä¸å±äºè‡ªå·±çš„æ–‡ä»¶ è®¾ç½®æ–¹æ³• o+t ç¤ºä¾‹è¯´æ˜ 1.åœ¨æ²¡æœ‰è®¾ç½®sbitæ—¶ï¼Œæ™®é€šç”¨æˆ·wwwå¯ä»¥åˆ é™¤/tmpä¸‹å±ä¸»å±ç»„ä¸æ˜¯è‡ªå·±çš„æ–‡ä»¶å’Œç›®å½• 2.è®¾ç½®sbitåï¼Œwwwç”¨æˆ·åªèƒ½åˆ é™¤æ–‡ä»¶æ‰€æœ‰è€…æ˜¯è‡ªå·±çš„æ–‡ä»¶ è®¾ç½®sbitåï¼Œæ–‡ä»¶æƒé™å…¶ä»–äººå¤„å˜ä¸ºäº†rwt statæŸ¥çœ‹/tmpæƒé™ï¼Œæ­¤æ—¶ä¸º1777 æ­¤æ—¶ï¼Œwwwç”¨æˆ·æ— æ³•åˆ é™¤æ–‡ä»¶æ‰€æœ‰è€…ä¸æ˜¯è‡ªå·±çš„æ–‡ä»¶ 3.linuxéšè—æƒé™ 3.1æƒé™ä½ a (append) åªèƒ½è¿½åŠ å’ŒæŸ¥çœ‹ï¼Œå…¶ä»–æ“ä½œéƒ½æ— æ³•æ‰§è¡Œ i (immutable) ä¸å¯å˜ï¼Œåªèƒ½æŸ¥çœ‹ï¼Œå…¶ä»–æ“ä½œéƒ½æ— æ³•æ‰§è¡Œ 3.2è®¾ç½®éšè—æƒé™å‘½ä»¤ chattr +å¢åŠ  -å–æ¶ˆ ä¸ºæ–‡ä»¶æ·»åŠ éšè—æƒé™aå,å¯ä»¥çœ‹åˆ°ï¼Œæ–‡ä»¶åªèƒ½è¢«è¿½åŠ å’ŒæŸ¥çœ‹ï¼Œå…¶ä»–æ“ä½œæ— æ³•æ‰§è¡Œ ä¸ºæ–‡ä»¶æ·»åŠ éšè—æƒé™iåï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ–‡ä»¶åªèƒ½è¢«æŸ¥çœ‹ï¼Œå…¶ä»–æ“ä½œæ— æ³•æ‰§è¡Œ 3.3æŸ¥çœ‹éšè—æƒé™ lsattr 4.FACL Filesystem Acess FACLæ˜¯ä¸€ç§æƒé™åˆ†é…ä¹‹å¤–çš„æ™®éæ–¹å¼ï¼Œä¾‹å¦‚ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½ éœ€è¦ç¡®è®¤3ä¸ªæƒé™ç»„ï¼Œownerã€groupã€otherï¼Œè€Œä½¿ç”¨FACLï¼Œåˆ©ç”¨æ–‡ä»¶æ‰©å±•å±æ€§ä¿å­˜é¢å¤–çš„è®¿é—®æ§åˆ¶æƒé™ï¼Œä½ å¯ä»¥å¢åŠ æƒé™ç»™å…¶ä»–ç”¨æˆ·æˆ–ç»„ï¼Œè€Œä¸å•åªæ˜¯ç®€å•çš„otheræˆ–è€…æ˜¯æ‹¥æœ‰è€…ä¸å­˜åœ¨çš„ç»„åˆ«ï¼Œå¯ä»¥å…è®¸æŒ‡å®šçš„ç”¨æˆ·æ‹¥æœ‰å†™æƒé™è€Œä¸å†æ˜¯è®©ä»–ä»¬æ•´ä¸ªç»„æ‹¥æœ‰å†™æƒé™ 4.1FACLæ ¼å¼ [u|g]ï¼š[ç”¨æˆ·å|ç»„å]ï¼šæƒé™ æ–‡ä»¶ ä¾‹å¦‚ u:hehe:rwx file å¯¹äºæ–‡ä»¶fileï¼Œç”¨æˆ·heheæœ‰rwxæƒé™ 4.2è®¾ç½®FACL setfacl é€‰é¡¹ å«ä¹‰ -m è®¾ç½®FACLæƒé™ -x å–æ¶ˆFACLæƒé™ -R é€’å½’è®¾ç½®ï¼Œ-Réœ€è¦å†™åœ¨-mé€‰é¡¹å‰è¾¹ -b åˆ é™¤å…¨éƒ¨FACLæƒé™ è®¾ç½®FACLç¤ºä¾‹ /testç›®å½•æƒé™ä¸º750ï¼Œå…¶ä»–äººæ²¡æœ‰ä»»ä½•æƒé™ï¼Œä½†æ˜¯ç°åœ¨æƒ³è®©ç”¨æˆ·wwwæ‹¥æœ‰rwæƒé™ 1.æ²¡æœ‰è®¾ç½®FACLä¹‹å‰ï¼Œwwwç”¨æˆ·æ— æ³•è¿›å…¥/testç›®å½•ï¼Œæ— æ³•æŸ¥çœ‹/testç›®å½•å†…å®¹ 2.setfacl -m u:www:r-x /test ä¸ºwwwç”¨æˆ·è®¾ç½®/testçš„FACL 3.éªŒè¯ï¼Œè®¾ç½®FACLä¹‹åï¼Œåªæœ‰wwwè¿™ä¸€ä¸ªç”¨æˆ·å¯¹/testç›®å½•æ‹¥æœ‰rxæƒé™ï¼Œå…¶ä»–æ™®é€šç”¨æˆ·æ²¡æœ‰æƒé™ å–æ¶ˆFACLç¤ºä¾‹ å–æ¶ˆFACLï¼Œ-xé€‰é¡¹ï¼Œä¸è®¾ç½®FACLä¸åŒï¼Œå–æ¶ˆçš„æ—¶å€™æ ¼å¼ä¸­ä¸ç”¨å†åŠ æƒé™ 4.3æŸ¥çœ‹FACL getfacl æ²¡æœ‰è®¾ç½®FACLå‰ è®¾ç½®FACLå æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/Linuxç”¨æˆ·ç™»å½•è®°å½•æ—¥å¿—å’Œç›¸å…³æŸ¥çœ‹å‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/Linuxç”¨æˆ·ç™»å½•è®°å½•æ—¥å¿—å’Œç›¸å…³æŸ¥çœ‹å‘½ä»¤.html","title":"Linuxç”¨æˆ·ç™»å½•è®°å½•æ—¥å¿—å’Œç›¸å…³æŸ¥çœ‹å‘½ä»¤","keywords":"","body":"Linuxç”¨æˆ·ç™»å½•è®°å½•æ—¥å¿—å’Œç›¸å…³æŸ¥çœ‹å‘½ä»¤æ€»ç»“ 1.Linuxç”¨æˆ·ç™»å½•ä¿¡æ¯æ”¾åœ¨ä¸‰ä¸ªæ–‡ä»¶ä¸­ utmpã€wtmpã€btmpæ–‡ä»¶ 1.1/var/run/utmp è®°å½•å½“å‰æ­£åœ¨ç™»å½•ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯ï¼Œé»˜è®¤ç”±whoå’Œwè®°å½•å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œuptimeè®°å½•ç³»ç»Ÿå¯åŠ¨æ—¶é—´ï¼› whoå‘½ä»¤å’Œwå‘½ä»¤åŠuptimeå‘½ä»¤è¾“å‡º //whoå‘½ä»¤ [root@tencent ~]# who root pts/0 2018-11-08 17:17 (12.66.1.11) //wå‘½ä»¤ [root@tencent ~]# w 21:02:03 up 18 days, 23:04, 1 user, load average: 0.00, 0.02, 0.07 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT root pts/0 12.66.1.11 17:17 3.00s 0.32s 0.32s -bash //uptimeå‘½ä»¤ [root@tencent ~]# uptime 21:02:46 up 18 days, 23:04, 1 user, load average: 0.00, 0.01, 0.06 1.2/var/log/wtmp è®°å½•å½“å‰æ­£åœ¨ç™»å½•å’Œå†å²ç™»å½•ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯ï¼Œé»˜è®¤ç”±lastå‘½ä»¤æŸ¥çœ‹ï¼› lastå‘½ä»¤è¾“å‡º [root@tencent ~]# last|head root pts/0 123.66.144.124 Fri Nov 8 17:17 still logged in root pts/0 122.1.22.20 Thu Nov 7 20:17 - 22:55 (02:37) root pts/0 122.1.22.16 Tue Nov 5 16:31 - 22:02 (05:31) root pts/0 122.1.22.16 Tue Nov 5 11:05 - 11:18 (00:12) root pts/0 122.1.67.92 Mon Nov 4 17:10 - 22:57 (05:47) root pts/0 123.66.18.69 Wed Oct 30 08:04 - 11:58 (03:53) root pts/1 12.66.17.23 Tue Oct 29 20:33 - 22:56 (02:22) root pts/0 12.66.17.23 Tue Oct 29 19:41 - 22:56 (03:14) root pts/1 12.66.16.12 Mon Oct 28 20:19 - 00:54 (04:35) root pts/0 12.66.16.12 Mon Oct 28 15:22 - 20:20 (04:57) 1.3/var/log/btmp è®°å½•å¤±è´¥çš„ç™»å½•å°è¯•ä¿¡æ¯ï¼Œé»˜è®¤ç”±lastbå‘½ä»¤æŸ¥çœ‹ lastbå‘½ä»¤è¾“å‡º [root@tencent ~]# lastb btmp begins Fri Nov 1 03:49:01 2019 è¿™ä¸‰ä¸ªæ–‡ä»¶éƒ½æ˜¯äºŒè¿›åˆ¶æ•°æ®æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸‰ä¸ªæ–‡ä»¶ç»“æ„å®Œå…¨ç›¸åŒï¼Œæ˜¯ç”±/usr/include/bits/utmp.hæ–‡ä»¶å®šä¹‰äº†è¿™ä¸‰ä¸ªæ–‡ä»¶çš„ç»“æ„ä½“ã€‚ é»˜è®¤æƒ…å†µä¸‹æ–‡ä»¶çš„æ—¥å¿—ä¿¡æ¯ä¼šé€šè¿‡logrotateæ—¥å¿—ç®¡ç†å·¥å…·å®šæœŸæ¸…ç†ã€‚logrotateçš„é…ç½®æ–‡ä»¶æ˜¯/etc/logrotate.confï¼Œæ­¤å¤„æ˜¯logrotateçš„ç¼ºçœè®¾ç½®ï¼Œé€šå¸¸ä¸éœ€è¦å¯¹å®ƒè¿›è¡Œä¿®æ”¹ã€‚æ—¥å¿—æ–‡ä»¶çš„è½®å¾ªå‹ç¼©ç­‰è®¾ç½®å­˜æ”¾åœ¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå®ƒï¼ˆä»¬ï¼‰æ”¾åœ¨/etc/logrotate.d/ç›®å½•ä¸‹ï¼Œå®ƒä¼šè¦†ç›–ç¼ºçœè®¾ç½®ã€‚ å¦‚æœä¸æƒ³è®°å½•ç›¸å…³ä¿¡æ¯ï¼Œåˆ™å¯ä»¥ç›´æ¥å°†ç›¸å…³æ–‡ä»¶åˆ é™¤å³å¯ã€‚å¦‚æœç³»ç»Ÿä¸å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œåˆ™éœ€è¦åœ¨æ­¤è·¯å¾„touchä¸€ä¸ªæ–‡ä»¶å°±å¯ä»¥ç»§ç»­è®°å½•ç›¸å…³ä¿¡æ¯äº†ã€‚ æ­¤å¤–ï¼š å¦‚æœæƒ³ç¦ç”¨whoå‘½ä»¤ï¼Œåˆ™åªéœ€è¦å°†utmpçš„å¯è¯»æƒé™å»æ‰å°±è¡Œï¼Œè¿™æ ·érootç”¨æˆ·å°±ä¸èƒ½ç”¨æ­¤å‘½ä»¤äº†ï¼›å¦‚æœæ˜¯btmpæ–‡ä»¶ï¼Œæ‰‹å·¥åˆ›å»ºçš„è¯æ³¨æ„æƒé™å¿…é¡»ä¸º600ï¼Œå¦åˆ™ä¸èƒ½æ­£ç¡®å†™å…¥ä¿¡æ¯ã€‚ 2.ç›¸å…³å‘½ä»¤ ä¸‹é¢ä»‹ç»æŸ¥çœ‹è¿™ä¸‰ä¸ªæ—¥å¿—æ–‡ä»¶çš„å‘½ä»¤ï¼Œåˆ†åˆ«æ˜¯lastlogã€lastã€lastbã€acã€whoã€wã€usersã€utmpdump å…¶ä¸­lastã€lastbã€whoã€utmpdumpå¯ä»¥é€šè¿‡æŒ‡å®šå‚æ•°è€ŒæŸ¥çœ‹ä¸‰ä¸ªä¸­çš„ä»»æ„ä¸€ä¸ªæ–‡ä»¶ 2.1 lastlog åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·æœ€è¿‘ç™»å½•çš„ä¿¡æ¯ï¼Œæˆ–è€…æŒ‡å®šç”¨æˆ·çš„æœ€è¿‘ç™»å½•ä¿¡æ¯ã€‚lastlogå¼•ç”¨çš„æ˜¯/var/log/lastlogæ–‡ä»¶ä¸­çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬login-nameã€portã€last login time [root@tencent ~]# lastlog Username Port From Latest root pts/1 111.55.66.123 Fri Nov 8 21:17:12 +0800 2018 bin **Never logged in** daemon **Never logged in** adm **Never logged in** lp **Never logged in** sync **Never logged in** shutdown **Never logged in** halt **Never logged in** mail **Never logged in** operator **Never logged in** games **Never logged in** ftp **Never logged in** nobody **Never logged in** 2.2 last åˆ—å‡ºå½“å‰å’Œæ›¾ç»ç™»å…¥ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯ï¼Œå®ƒé»˜è®¤è¯»å–çš„æ˜¯/var/log/wtmpæ–‡ä»¶çš„ä¿¡æ¯ã€‚ è¾“å‡ºçš„å†…å®¹åŒ…æ‹¬ï¼šç”¨æˆ·åã€ç»ˆç«¯ä½ç½®ã€ç™»å½•æºä¿¡æ¯ã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æŒç»­æ—¶é—´ã€‚æ³¨æ„æœ€åä¸€è¡Œè¾“å‡ºçš„æ˜¯wtmpæ–‡ä»¶èµ·å§‹è®°å½•çš„æ—¶é—´ã€‚ å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡last -få‚æ•°æŒ‡å®šè¯»å–æ–‡ä»¶ï¼Œå¯ä»¥æ˜¯/var/log/btmpã€/var/run/utmp [root@tencent ~]# last|head root pts/1 12.66.1.12 Fri Nov 8 21:17 still logged in root pts/0 23.6.55.12 Fri Nov 8 17:17 still logged in root pts/0 23.6.55.12 Thu Nov 7 20:17 - 22:55 (02:37) root pts/0 23.6.55.12 Tue Nov 5 16:31 - 22:02 (05:31) root pts/0 23.6.55.12 Tue Nov 5 11:05 - 11:18 (00:12) root pts/0 23.6.55.12 Mon Nov 4 17:10 - 22:57 (05:47) root pts/0 23.6.55.12 Wed Oct 30 08:04 - 11:58 (03:53) root pts/1 23.6.55.124 Tue Oct 29 20:33 - 22:56 (02:22) root pts/0 23.6.55.12 Tue Oct 29 19:41 - 22:56 (03:14) root pts/1 23.6.55.122 Mon Oct 28 20:19 - 00:54 (04:35) 2.3 lastb åˆ—å‡ºå¤±è´¥å°è¯•çš„ç™»å½•ä¿¡æ¯ï¼Œå’Œlastå‘½ä»¤åŠŸèƒ½å®Œå…¨ç›¸åŒï¼Œåªä¸è¿‡å®ƒé»˜è®¤è¯»å–çš„æ˜¯/var/log/btmpæ–‡ä»¶çš„ä¿¡æ¯ å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡last -få‚æ•°æŒ‡å®šè¯»å–æ–‡ä»¶ï¼Œå¯ä»¥æ˜¯/var/log/btmpã€/var/run/utmp [root@tencent ~]# lastb btmp begins Fri Nov 1 03:49:01 2019 2.4 ac è¾“å‡ºæ‰€æœ‰ç”¨æˆ·æ€»çš„è¿æ¥æ—¶é—´ï¼Œé»˜è®¤å•ä½æ˜¯å°æ—¶ã€‚ç”±äºacæ˜¯åŸºäºwtmpç»Ÿè®¡çš„ï¼Œæ‰€ä»¥ä¿®æ”¹æˆ–è€…åˆ é™¤wtmpæ–‡ä»¶éƒ½ä¼šä½¿acçš„ç»“æœå—å½±å“ã€‚(Suseé»˜è®¤æ²¡æœ‰è¯¥å‘½ä»¤) å®‰è£…acå‘½ä»¤ yum -y install psacct [root@tencent ~]# ac total 559.07 2.5 who æŸ¥çœ‹å½“å‰ç™»å…¥ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯ è¯­æ³•who [OPTION]... [ FILE | ARG1 ARG2 ]ã€‚ whoå‘½ä»¤å¼ºå¤§çš„ä¸€ç‚¹æ˜¯ï¼Œå®ƒæ—¢å¯ä»¥è¯»å–utmpæ–‡ä»¶ä¹Ÿå¯ä»¥è¯»å–wtmpæ–‡ä»¶ï¼Œé»˜è®¤æ²¡æœ‰æŒ‡å®šFILEå‚æ•°æ—¶ï¼ŒwhoæŸ¥è¯¢çš„æ˜¯utmpçš„å†…å®¹ã€‚å½“ç„¶å¯ä»¥æŒ‡å®šFILEå‚æ•°ï¼Œæ¯”å¦‚who -aH /var/log/wtmp,åˆ™æ­¤æ—¶æŸ¥çœ‹çš„æ˜¯wtmpæ–‡ä»¶ [root@tencent ~]# who root pts/0 2018-11-08 17:17 (23.66.1.2) root pts/1 2018-11-08 21:17 (23.66.1.2) [root@tencent ~]# who -rH NAME LINE TIME IDLE PID COMMENT run-level 3 2018-10-20 21:58 2.6 w æŸ¥çœ‹å½“å‰ç™»å…¥ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯åŠç”¨æˆ·å½“å‰çš„è¿›ç¨‹ï¼ˆè€Œwhoå‘½ä»¤åªèƒ½çœ‹ç”¨æˆ·ä¸èƒ½çœ‹è¿›ç¨‹ï¼‰ è¯¥å‘½ä»¤èƒ½æŸ¥çœ‹çš„ä¿¡æ¯åŒ…æ‹¬å­—ç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œç³»ç»Ÿè¿è¡Œæ—¶é—´ï¼Œç™»é™†ç³»ç»Ÿç”¨æˆ·æ€»æ•°åŠç³»ç»Ÿ1ã€5ã€10åˆ†é’Ÿå†…çš„å¹³å‡è´Ÿè½½ä¿¡æ¯ã€‚åé¢çš„ä¿¡æ¯æ˜¯ç”¨æˆ·ï¼Œç»ˆç«¯ï¼Œç™»å½•æºï¼Œlogin timeï¼Œidle timeï¼ŒJCPUï¼ŒPCPUï¼Œå½“å‰æ‰§è¡Œçš„è¿›ç¨‹ç­‰ wçš„ä¿¡æ¯æ¥è‡ªä¸¤ä¸ªæ–‡ä»¶ï¼šç”¨æˆ·ç™»å½•ä¿¡æ¯æ¥è‡ª/var/run/utmpï¼Œè¿›ç¨‹ä¿¡æ¯æ¥è‡ª/proc [root@tencent ~]# w 21:35:24 up 18 days, 23:37, 2 users, load average: 0.02, 0.08, 0.07 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT root pts/0 23.66.1.2 17:17 3:48 0.33s 0.33s -bash root pts/1 23.66.1.2 21:17 4.00s 0.04s 0.00s w 2.7 users æ˜¾ç¤ºå½“å‰æ­£åœ¨ç™»å…¥ç³»ç»Ÿçš„ç”¨æˆ·å è¯­æ³•æ˜¯users [OPTION]... [FILE] å¦‚æœæœªæŒ‡å®šFILEå‚æ•°åˆ™é»˜è®¤è¯»å–çš„æ˜¯/var/run/utmpï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šé€šç”¨ç›¸å…³æ–‡ä»¶/var/log/wtmpï¼Œæ­¤æ—¶è¾“å‡ºçš„å°±ä¸æ˜¯å½“å‰ç”¨æˆ·äº† [root@tencent ~]# users root root 2.8 utmpdump utmpdumpç”¨äºè½¬å‚¨äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶åˆ°æ–‡æœ¬æ ¼å¼çš„æ–‡ä»¶ä»¥ä¾¿æŸ¥çœ‹ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶ï¼ï¼ åŒ…æ‹¬/var/run/utmpã€/var/log/wtmpã€/var/log/btmp è¯­æ³•ä¸ºï¼šutmpdump [options] [filename] ä¿®æ”¹æ–‡ä»¶å®é™…å°±å¯ä»¥æŠ¹é™¤ç³»ç»Ÿè®°å½•ï¼Œæ‰€ä»¥ä¸€å®šè¦è®¾ç½®å¥½æƒé™ï¼Œé˜²æ­¢éæ³•å…¥ä¾µ ä¾‹å­ï¼šä¿®æ”¹utmpæˆ–wtmpã€‚ç”±äºè¿™äº›éƒ½æ˜¯äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼Œä½ ä¸èƒ½åƒç¼–è¾‘æ–‡ä»¶ä¸€æ ·æ¥ç¼–è¾‘å®ƒä»¬ã€‚å–è€Œä»£ä¹‹æ˜¯ï¼Œä½ å¯ä»¥å°†å…¶å†…å®¹è¾“å‡ºæˆä¸ºæ–‡æœ¬æ ¼å¼ï¼Œå¹¶ä¿®æ”¹æ–‡æœ¬è¾“å‡ºå†…å®¹ï¼Œç„¶åå°†ä¿®æ”¹åçš„å†…å®¹å¯¼å…¥å›äºŒè¿›åˆ¶æ—¥å¿—ä¸­ã€‚å¦‚ä¸‹ï¼š //æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸èƒ½ç›´æ¥æŸ¥çœ‹ï¼Œå› æ­¤éœ€è¦å¯¼å‡ºæ–‡ä»¶ä¿¡æ¯åˆ°ä¸€ä¸ªæ™®é€šæ–‡ä»¶ä¸­ [root@tencent ~]# file /var/log/wtmp /var/log/wtmp: Hitachi SH big-endian COFF object, not stripped //å¯¼å‡ºæ–‡ä»¶ä¿¡æ¯åˆ°heheæ–‡ä»¶ä¸­ï¼Œè¿™æ ·å°±èƒ½æŸ¥çœ‹æ–‡ä»¶å†…å®¹äº† [root@tencent ~]# utmpdump /var/log/wtmp > hehe Utmp dump of /var/log/wtmp æŸ¥çœ‹æ–‡ä»¶å†…å®¹ [root@tencent ~]# tail -5 hehe [8] [31245] [ ] [ ] [pts/0 ] [ ] [0.0.0.0 ] [äºŒ 11æœˆ 05 22:02:12 2018 ] [7] [16733] [ts/0] [root ] [pts/0 ] [23.66.1.2 ] [23.66.1.20 ] [å›› 11æœˆ 07 20:17:25 2018 ] [8] [16727] [ ] [ ] [pts/0 ] [ ] [0.0.0.0 ] [å›› 11æœˆ 07 22:55:15 2018 ] [7] [32715] [ts/0] [root ] [pts/0 ] [23.66.1.2 ] [23.66.1.2 ] [äº” 11æœˆ 08 17:17:09 2018 ] [7] [02148] [ts/1] [root ] [pts/1 ] [23.66.1.2 ] [23.66.1.24 ] [äº” 11æœˆ 08 21:17:12 2018 ] //è¿˜å¯ä»¥å°†å¯¼å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯å¯¼å›æºæ–‡ä»¶ 1.å¯¼å‡ºäºŒè¿›åˆ¶æ–‡ä»¶/var/log/wtmpæ–‡ä»¶å†…å®¹åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ [root@tencent ~]# utmpdump /var/log/wtmp > hehe 2.å¤‡ä»½/var/log/wtmp [root@tencent ~]# cp /var/log/wtmp{,.bak} 3.æŸ¥çœ‹ä¸¤ä¸ªæ–‡ä»¶çš„è¡Œæ•° [root@tencent ~]# wc -l /var/log/wtmp.bak ./hehe 35 /var/log/wtmp 384 ./hehe 4.æ¸…ç©ºå¤‡ä»½çš„/var/log/wtmp [root@tencent ~]# > /var/log/wtmp.bak [root@tencent ~]# wc -l /var/log/wtmp.bak 0 /var/log/wtmp.bak 5.å°†å¯¼å‡ºçš„æ–‡ä»¶å†å¯¼å›åˆ°/var/log/wtmp.bak [root@tencent ~]# utmpdump -r hehe > /var/log/wtmp.bak Utmp undump of hehe [root@tencent ~]# wc -l /var/log/wtmp.bak 5 /var/log/wtmp.bak æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/Linuxç”¨æˆ·ç»„ç®¡ç†.html":{"url":"linux/linuxå‘½ä»¤/Linuxç”¨æˆ·ç»„ç®¡ç†.html","title":"Linuxç”¨æˆ·ç»„ç®¡ç†","keywords":"","body":"Linuxç”¨æˆ·ç»„ç®¡ç† 1.Linuxç”¨æˆ·ç®¡ç† 1.1useraddå‘½ä»¤åˆ›å»ºç”¨æˆ·è¿‡ç¨‹ 1ã€ä¸å¸¦ä»»ä½•å‚æ•°ä½¿ç”¨æ·»åŠ ç”¨æˆ·æ—¶ï¼Œé¦–å…ˆè¯»å–/etc/login.defs /etc/default/useradd é¢„å…ˆå®šä¹‰çš„è§„åˆ™ 2ã€æ ¹æ®è®¾ç½®çš„è§„åˆ™æ·»åŠ ç”¨æˆ·ï¼ŒåŒæ—¶ä¼šå‘/etc/passwd /etc/groupæ–‡ä»¶æ·»åŠ æ–°å»ºçš„ç”¨æˆ·å’Œç»„ï¼Œä½†/etc/shadow /etc/gshadowä¹Ÿä¼šåŒæ­¥ç”Ÿæˆè®°å½• 3ã€åŒæ—¶ç³»ç»Ÿä¼šæ ¹æ®/etc/login.defs /etc/default/useraddæ–‡ä»¶ä¸­é…ç½®çš„ä¿¡æ¯å»ºç«‹ç”¨æˆ·çš„å®¶ç›®å½•ï¼Œå¹¶å¤åˆ¶/etc/skelä¸­æ‰€æœ‰éšè—çš„ç¯å¢ƒé…ç½®æ–‡ä»¶åˆ°æ–°ç”¨æˆ·çš„å®¶ç›®å½•ä¸­ï¼Œä»¥å®Œæˆå¯¹ç”¨æˆ·ç¯å¢ƒçš„åˆå§‹åŒ–è®¾ç½® 1.2ç”¨æˆ·é…ç½®æ–‡ä»¶ 1.2.1 /etc/passwd ä½œç”¨ å­˜å‚¨ç”¨æˆ·ä¿¡æ¯æ–‡ä»¶ï¼Œæ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªç”¨æˆ·ä¿¡æ¯ï¼Œæœ‰å¤šå°‘è¡Œå°±è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªç”¨æˆ· æ ¼å¼ root : x : 0 : 0 : root : /root : /bin/bash æ ¼å¼å«ä¹‰(æ­¤æ–‡ä»¶ç”±7ä¸ªå­—æ®µçš„æ•°æ®ç»„æˆï¼Œå­—æ®µä¹‹é—´ç”¨â€œï¼šâ€åˆ†éš”) 1ç”¨æˆ·åï¼š2å¯†ç ï¼š3ç”¨æˆ·æ ‡è¯†å·UIDï¼š4ç»„æ ‡è¯†å·GIDï¼š5ä¸ªäººèµ„æ–™ï¼š6ä¸»ç›®å½•ï¼š7å‘½ä»¤è§£é‡Šå™¨ 1.2.2 /etc/shadow ä½œç”¨ å­˜å‚¨ç”¨æˆ·å¯†ç ä¿¡æ¯æ–‡ä»¶ æ ¼å¼ u1 : !! : 17749 : 0 : 99999 : 7 : : : æ ¼å¼å«ä¹‰(æ­¤æ–‡ä»¶ç”±9ä¸ªå­—æ®µçš„æ•°æ®ç»„æˆï¼Œå­—æ®µä¹‹é—´ç”¨â€œï¼šâ€åˆ†éš”) 1ç”¨æˆ·å 2 å¯†ç  ï¼ï¼è¡¨ç¤ºæ²¡æœ‰å¯†ç  3 æœ€è¿‘æ”¹åŠ¨å¯†ç çš„æ—¥æœŸ 4 å¯†ç ä¸å¯è¢«æ›´åŠ¨çš„å¤©æ•° 5 å¯†ç éœ€è¦é‡æ–°å˜æ›´çš„å¤©æ•° 6 å¯†ç éœ€è¦å˜æ›´æœŸé™å‰çš„è­¦å‘ŠæœŸé™ 7 å¯†ç è¿‡æœŸçš„å®½é™æ—¶é—´ 8å¸å·å¤±æ•ˆæ—¥æœŸ 9 ä¿ç•™ 1.2.3 /etc/skel(ç›®å½•) ä½œç”¨ åˆ›å»ºç”¨æˆ·ç›¸å…³çš„ç›®å½•ï¼Œæ­¤ç›®å½•ç”¨æ¥å­˜æ”¾æ–°ç”¨æˆ·éœ€è¦çš„æ‰€æœ‰åŸºç¡€ç¯å¢ƒå˜é‡æ–‡ä»¶ [root@exercise1 skel]# pwd /etc/skel [root@exercise1 skel]# ls -a . .. .bash_logout .bash_profile .bashrc [root@exercise1 skel]# ll -a total 28 drwxr-xr-x. 2 root root 4096 Aug 4 13:09 . drwxr-xr-x. 103 root root 12288 Aug 8 06:29 .. -rw-r--r--. 1 root root 18 Mar 23 2017 .bash_logout -rw-r--r--. 1 root root 176 Mar 23 2017 .bash_profile -rw-r--r--. 1 root root 124 Mar 23 2017 .bashrc ä¸/etc/skelæœ‰å…³çš„é—®é¢˜ 1.ç”¨æˆ·u1ç™»é™†ç³»ç»Ÿåæç¤ºç¬¦å¦‚ä¸‹ -bash-4.1$ 2. åŸå›  ç”¨æˆ·å®¶ç›®å½•ä¸‹çš„ç›¸å…³ç¯å¢ƒé…ç½®æ–‡ä»¶è¢«åˆ é™¤ 3.è§£å†³æ–¹æ³• å¤åˆ¶/etc/skelä¸‹çš„.bash*åˆ°ç”¨æˆ·å®¶ç›®å½• cp /etc/skel/.bash* ~ 1.3ç»„é…ç½®æ–‡ä»¶ 1.3.1 /etc/group ä½œç”¨ å­˜å‚¨ç»„ç›¸å…³ä¿¡æ¯ æ ¼å¼ g1: x : 500 : æ ¼å¼å«ä¹‰(æ­¤æ–‡ä»¶ç”±4ä¸ªå­—æ®µçš„æ•°æ®ç»„æˆï¼Œå­—æ®µä¹‹é—´ç”¨â€œï¼šâ€åˆ†éš”) 1ç»„å 2ç»„å¯†ç  3ç»„ç®¡ç†å‘˜ 4ç”¨æˆ·ç»„æˆå‘˜ 1.3.2 /etc/gshadow ä½œç”¨ å­˜å‚¨ç»„å¯†ç ä¿¡æ¯ æ ¼å¼ hehe : ! : : æ ¼å¼å«ä¹‰(æ­¤æ–‡ä»¶ç”±4ä¸ªå­—æ®µçš„æ•°æ®ç»„æˆï¼Œå­—æ®µä¹‹é—´ç”¨â€œï¼šâ€åˆ†éš”) 1ç»„å 2ç»„å¯†ç  3ç»„ç®¡ç†å‘˜ 4ç”¨æˆ·ç»„æˆå‘˜ 1.4Linuxç”¨æˆ·åˆ†ç±» 1.4.1ç®¡ç†å‘˜ç”¨æˆ· é»˜è®¤æ˜¯rootç”¨æˆ·ï¼Œå®ƒçš„UID å’ŒGIDå‡ä¸º0ï¼Œç³»ç»Ÿå®‰è£…å®Œæˆåè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œé»˜è®¤é€šè¿‡å®ƒå°±å¯ä»¥ç™»å½•ç³»ç»Ÿï¼Œæ‹¥æœ‰æœ€é«˜çš„ç®¡ç†æƒé™ 1.4.2æ™®é€šç”¨æˆ· ç”±ç³»ç»Ÿç®¡ç†å‘˜rootåˆ›å»ºçš„ï¼Œåˆ›å»ºå®Œæˆåå¯ä»¥ç™»å½•ç³»ç»Ÿï¼Œä½†é»˜è®¤æ— æ³•åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤ä»»ä½•ç®¡ç†å‘˜ä¸‹çš„æ–‡ä»¶ï¼›UIDä»500-65535 1.4.3ç³»ç»Ÿç”¨æˆ·(æˆ–è™šæ‹Ÿç”¨æˆ·) å®‰è£…ç³»ç»Ÿåé»˜è®¤ç”Ÿæˆçš„ç”¨æˆ·ï¼Œå¤§å¤šæ•°ä¸èƒ½ç™»å½•ç³»ç»Ÿï¼Œä½†å®ƒä»¬æ˜¯ç³»ç»Ÿæ­£å¸¸è¿è¡Œä¸å¯ç¼ºå°‘çš„ï¼Œå®ƒä»¬çš„å­˜åœ¨ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿ç³»ç»Ÿç®¡ç†ï¼Œæ»¡è¶³ç›¸åº”çš„ç³»ç»Ÿè¿›ç¨‹å¯¹æ–‡ä»¶æ‰€å±ç”¨æˆ·çš„è¦æ±‚ï¼›UIDä» 1-499 1.5ç”¨æˆ·ç›¸å…³å‘½ä»¤ 1.5.1 useradd åˆ›å»ºç”¨æˆ· è¯­æ³•æ ¼å¼ useradd é€‰é¡¹ ç”¨æˆ·å é€‰é¡¹ -n ä¸åˆ›å»ºä»¥ç”¨æˆ·åä¸ºåçš„ç»„ -c åˆ›å»ºç”¨æˆ·æ—¶ï¼Œæ·»åŠ ä¸ªäººä¿¡æ¯ -u ç”¨æˆ·IDå€¼ï¼Œè¿™ä¸ªå€¼å¿…é¡»æ˜¯å”¯ä¸€çš„ -s ç”¨æˆ·ç™»å½•åä½¿ç”¨çš„shell -g æŒ‡å®šç”¨æˆ·å¯¹åº”çš„ç»„ï¼Œå¯¹åº”çš„ç»„å¿…é¡»åœ¨ç³»ç»Ÿä¸­å­˜åœ¨ -M ä¸åˆ›å»ºç”¨æˆ·å®¶ç›®å½• 1.5.2 usermod ä¿®æ”¹ç”¨æˆ· è¯­æ³•æ ¼å¼ usermod é€‰é¡¹ ç”¨æˆ·å é€‰é¡¹(usermodåªæœ‰-lé€‰é¡¹ä¸useraddä¸åŒ) -c ä¿®æ”¹ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ï¼ŒåŒuseradd çš„-cåŠŸèƒ½ -g ä¿®æ”¹ç”¨æˆ·å¯¹åº”çš„ç”¨æˆ·ç»„ï¼ŒåŒ useraddçš„-dåŠŸèƒ½ -s ä¿®æ”¹ç”¨æˆ·ç™»å½•åä½¿ç”¨çš„shellåç§°ï¼ŒåŒuseraddçš„-såŠŸèƒ½ -u ä¿®æ”¹ç”¨æˆ·çš„uid ï¼ŒåŒuseradd çš„-uåŠŸèƒ½ -l ä¿®æ”¹ç”¨æˆ·çš„åç§° -usermod -l æ–°ç”¨æˆ·åç§° æ—§ç”¨æˆ·åç§° 1.5.3 userdel åˆ é™¤ç”¨æˆ· è¯­æ³•æ ¼å¼ userdel é€‰é¡¹ ç”¨æˆ·å é€‰é¡¹ -f å¼ºåˆ¶åˆ é™¤ç”¨æˆ· -r åˆ é™¤ç”¨æˆ·çš„åŒæ—¶ï¼Œåˆ é™¤ä¸ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰æ–‡ä»¶(åŒ…å«é‚®ç®±ä¿¡æ¯/var/spool/mail/) âš ï¸ å½“ä½¿ç”¨-r ä¹Ÿæ— æ³•å½»åº•æ¸…ç©ºç”¨æˆ·å†…å®¹æ—¶ï¼ŒæŠŠè¿™ä¸¤ä¸ªé…ç½®æ–‡ä»¶ä¸­ä¸è¦åˆ é™¤çš„ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯ï¼Œæ³¨é‡Šæˆ–åˆ é™¤æ‰ã€‚ /etc/passwd /etc/group 1.5.4 passwd ä¿®æ”¹ç”¨æˆ·å¯†ç  å‘½ä»¤æ ¼å¼ passwd é€‰é¡¹ ç”¨æˆ·å é€‰é¡¹ --stdin éäº¤äº’å¼è®¾ç½®å¯†ç  [root@exercise2 local]# echo 123abc|passwd --stdin caonima Changing password for user caonima. passwd: all authentication tokens updated successfully. -d åˆ é™¤å¯†ç  [root@exercise2 ~]# passwd -d hehe Removing password for user hehe. passwd: Success -l é”å®šå¯†ç  [root@exercise2 ~]# passwd -l hehe Locking password for user hehe. passwd: Success é”å®šç”¨æˆ·heheçš„å¯†ç åï¼Œå…¶ä»–ç”¨æˆ·å°±æ— æ³•ç™»é™†heheç”¨æˆ·ï¼Œä¼šæç¤ºé”™è¯¯çš„å¯†ç  [haha@exercise2 ~]$ su - hehe Password: su: incorrect password -u è§£é”å¯†ç  [root@exercise2 ~]# passwd -u hehe Unlocking password for user hehe. passwd: Success -S æ˜¾ç¤ºè´¦æˆ·çŠ¶æ€ä¿¡æ¯ è´¦æˆ·ä¿¡æ¯åŒ…å«7ä¸ªå­—æ®µ ç¬¬1ä¸ªå­—æ®µæ˜¯ç”¨æˆ·çš„ç™»å½•å ç¬¬2ä¸ªå­—æ®µæŒ‡ç¤ºç”¨æˆ·è´¦å·å£ä»¤æ˜¯é”å®š(L)ã€æ— å£ä»¤(NP)è¿˜æ˜¯æœ‰å¯ç”¨å£ä»¤(P) ç¬¬3ä¸ªå­—æ®µç»™å‡ºæœ€åä¸€æ¬¡å£ä»¤ä¿®æ”¹çš„ æ—¥æœŸ æ¥ä¸‹æ¥4ä¸ªå­—æ®µæ˜¯æœ€å°æœ‰æ•ˆæœŸï¼Œæœ€å¤§æœ‰æ•ˆæœŸï¼Œè­¦å‘Šå­—æ®µå’Œå£ä»¤çš„ä¼‘æ­¢æœŸï¼Œè¿™äº›æ—¶æœŸç”¨å¤©æ ‡å¿— [root@exercise2 ~]# passwd -S hehe hehe PS 2018-08-06 0 1 1 -1 (Password set, SHA512 crypt.) -w,--warndays WARN_DAYS(é•¿æ ¼å¼) è®¾ç½®å£ä»¤éœ€è¦ä¿®æ”¹å‰å‘å‡ºè­¦å‘Šçš„å¤©æ•° WARN_DAYSé€‰é¡¹æ˜¯å£ä»¤è¿‡æœŸå‰çš„å¤©æ•°ã€‚æ®åˆ°æœŸæ—¥è¿™äº›å¤©æ•°æ—¶ï¼Œ ç”¨æˆ·å°†è¢«è­¦å‘Šå…¶å£ä»¤å³å°†è¿‡æœŸ -x, --maxdays MAX_DAYS è®¾ç½®å£ä»¤æœ‰æ•ˆçš„æœ€å¤§å¤©æ•° MAX_DAYSå¤©æ•°åï¼Œå£ä»¤éœ€è¦ä¿®æ”¹ -i, --inactive INACTIVE æ­¤é€‰é¡¹ç”¨äºåœ¨å£ä»¤è¿‡æœŸå‡ å¤©åç¦ç”¨è¯¥è´¦æˆ· ç”¨æˆ·è´¦å·çš„å£ä»¤è¿‡æœŸINACTIVEæŒ‡å®šçš„å¤©æ•°åï¼Œè¯¥ç”¨æˆ·å°†æ— æ³•å†ç™»å½•æ­¤è´¦å· -n, --mindays MIN_DAYS è®¾ç½®å£ä»¤ä¿®æ”¹çš„æœ€å°å¤©æ•°é—´éš”ä¸ºMIN_DAYS æ­¤å­—æ®µè®¾ä¸º0è¡¨ç¤ºç”¨äºå¯ä»¥éšæ—¶ä¿®æ”¹å…¶å£ä»¤ -e, --expire ä½¿ä¸€ä¸ªè´¦æˆ·çš„å£ä»¤ç«‹å³è¿‡æœŸã€‚è¿™å®é™…ä¸Šå¼ºè¿«ç”¨æˆ·åœ¨ä¸‹æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç  WARNING: Your password has expired. You must change your password now and login again! Changing password for user hehe. Changing password for hehe. (current) UNIX password: 1.5.5 su åˆ‡æ¢ç”¨æˆ· âš ï¸ä¸åŠ - ç›´æ¥åˆ‡æ¢åˆ°rootå®¶ç›®å½•ï¼Œç¯å¢ƒå˜é‡æ²¡æœ‰æ”¹å˜,æ­¤æ–¹å¼ä¸å®‰å…¨ [root@exercise1 ~]# su hehe [hehe@exercise1 root]$ pwd /root [hehe@exercise1 root]$ ls ls: cannot open directory .: Permission denied [hehe@exercise1 root]$ cd / [hehe@exercise1 /]$ ls app bin caonima dev hehe lib lost+found misc net opt proc sbin server sys tmp var backup boot cgroup etc home lib64 media mnt oldboy package root selinux srv test usr [hehe@exercise1 /]$ âš ï¸åŠ - åˆ‡æ¢åˆ°è‡ªå·±çš„å®¶ç›®å½•ï¼Œç¯å¢ƒå˜é‡æ”¹å˜ [root@exercise1 ~]# su - hehe [hehe@exercise1 ~]$ pwd /home/hehe 1.5.6 sudo ç”¨æˆ·æˆæƒ ä½œç”¨ é€šè¿‡é…ç½®æ–‡ä»¶æ¥é™åˆ¶ç”¨æˆ·çš„æƒé™ ï¼Œå¯ä»¥è®©æ™®é€šç”¨æˆ·åœ¨æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤æˆ–ç¨‹åºæ—¶ï¼Œæ‹¥æœ‰è¶…çº§ç”¨æˆ·çš„æƒé™ sudoå·¥ä½œè¿‡ç¨‹ 1.å½“ç”¨æˆ·æ‰§è¡Œsudoæ—¶ï¼Œç³»ç»Ÿä¼šä¸»åŠ¨å¯»æ‰¾/etc/sudoersæ–‡ä»¶ï¼Œåˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡Œsudoçš„æƒé™ 2.ç¡®è®¤ç”¨æˆ·å…·æœ‰å¯æ‰§è¡Œsudoçš„æƒé™åï¼Œè®©ç”¨æˆ·è¾“å…¥ç”¨æˆ·è‡ªå·±çš„å¯†ç ç¡®è®¤ 3.è‹¥å¯†ç è¾“å…¥æˆåŠŸï¼Œåˆ™å¼€å§‹æ‰§è¡Œsudoåç»­çš„å‘½ä»¤ 4.rootæ‰§è¡Œsudoæ—¶ä¸éœ€è¦è¾“å…¥å¯†ç (å› ä¸ºsudoersæ–‡ä»¶ä¸­æœ‰é…ç½®root ALL=(ALL) ALLè¿™æ ·ä¸€æ¡è§„åˆ™) é€‰é¡¹ -l æ˜¾ç¤ºç”¨æˆ·æ‹¥æœ‰çš„sudoæƒé™ -k æ¸…ç©ºå¯†ç ï¼Œå¯†ç æœ‰æ•ˆæ—¶é—´é»˜è®¤5åˆ†é’Ÿ æˆæƒç¤ºä¾‹ ç¤ºä¾‹1ï¼šç»™æ™®é€šç”¨æˆ·u1ææƒ,è®©æ™®é€šç”¨æˆ·å¯ä»¥æŸ¥çœ‹rootç”¨æˆ·çš„å®¶ç›®å½•ï¼›æ™®é€šç”¨æˆ·å¯ä»¥ä½¿ç”¨useraddå‘½ä»¤ï¼Œåˆ›å»ºæ–°ç”¨æˆ· èŒƒä¾‹åˆ†ææ­¥éª¤ï¼š 1ï¼‰ useradd u1 2ï¼‰ visudo=viæ‰“å¼€/etc/sudoersæ–‡ä»¶ æˆ– vim /etc/sudoers æ³¨ï¼švisudoä¼šæ£€æŸ¥å†…éƒ¨è¯­æ³•ï¼Œé¿å…ç”¨æˆ·è¾“å…¥é”™è¯¯ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨visudoï¼Œç¼–è¾‘æ­¤æ–‡ä»¶è¦ç”¨rootæƒé™ 3) ç¼–è¾‘æ–‡ä»¶çš„ç¬¬98è¡Œï¼Œç¼–è¾‘å®Œæˆåï¼Œwq! å¼ºåˆ¶ä¿å­˜é€€å‡º(vim ç¼–è¾‘/etc/sudoers æ–‡ä»¶æƒé™é»˜è®¤440) root ALL=(ALL) ALL u1 ALL=(ALL) /bin/ls,/usr/sbin/useradd u1 ALL=(ALL) /bin/*,!/bin/ls,!/usr/sbin/useradd æ’é™¤/bin/ls u1 ALL=(ALL) NOPASSWD:/bin/ls æ‰§è¡Œsudoå‘½ä»¤ä¸éœ€è¦è¾“å…¥å¯†ç  4ï¼‰ä½¿ç”¨u1 ç”¨æˆ·ç™»å½•æµ‹è¯• sudo useradd u11 //å¯æˆåŠŸåˆ›å»ºç”¨æˆ·ï¼Œè¯æ˜ææƒæˆåŠŸ sudo ls /root //å¯æŸ¥çœ‹rootçš„å®¶ï¼Œè¯æ˜ææƒæˆåŠŸ 5ï¼‰ sudo -l //-l å‚æ•°æ˜¯åˆ—å‡ºå½“å‰ç”¨æˆ·å¯æ‰§è¡Œçš„å‘½ä»¤ï¼Œä½†åªæœ‰åœ¨sudoersæ–‡ä»¶é‡Œçš„ç”¨æˆ·æ‰èƒ½ä½¿ç”¨è¯¥é€‰é¡¹ 1.5.7 ç”¨æˆ·æŸ¥è¯¢å‘½ä»¤ 1.5.7.1 w æ˜¾ç¤ºç›®å‰ç™»å…¥ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯ æ‰§è¡Œè¿™é¡¹æŒ‡ä»¤å¯å¾—çŸ¥ç›®å‰ç™»å…¥ç³»ç»Ÿçš„ç”¨æˆ·æœ‰å“ªäº›äººï¼Œä»¥åŠä»–ä»¬æ­£åœ¨æ‰§è¡Œçš„ç¨‹åº [root@exercise1 ~]# w 09:09:47 up 6:31, 7 users, load average: 0.07, 0.06, 0.01 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT root pts/0 192.168.1.6 05:33 2:35m 0.37s 0.37s -bash root pts/1 192.168.1.6 05:43 3:07m 0.04s 0.02s bash root pts/2 192.168.1.6 05:53 3:07m 0.06s 0.05s bash root pts/3 192.168.1.6 05:55 3:13m 0.02s 0.01s bash root pts/4 192.168.1.6 06:01 3:07m 0.01s 0.01s -bash root pts/5 192.168.1.6 07:46 0.00s 0.14s 0.01s w root pts/6 192.168.1.6 08:04 1:04m 0.04s 0.03s -bash 1.5.7.2 id æŸ¥çœ‹ç”¨æˆ·UIDã€GID [root@exercise1 ~]# id root uid=0(root) gid=0(root) groups=0(root) 1.5.7.3 last æ˜¾ç¤ºç”¨æˆ·ç™»å½•æƒ…å†µ [root@exercise1 ~]# last u1 pts/7 192.168.1.6 Wed Aug 8 08:05 - 08:35 (00:29) root pts/7 192.168.1.6 Wed Aug 8 08:05 - 08:05 (00:00) root pts/6 192.168.1.6 Wed Aug 8 08:04 still logged in root pts/5 192.168.1.6 Wed Aug 8 07:46 still logged in root pts/4 192.168.1.6 Wed Aug 8 06:01 still logged in root pts/3 192.168.1.6 Wed Aug 8 05:55 still logged in root pts/2 192.168.1.6 Wed Aug 8 05:53 still logged in root pts/1 192.168.1.6 Wed Aug 8 05:43 still logged in root pts/0 192.168.1.6 Wed Aug 8 05:33 still logged in user pts/3 192.168.1.6 Wed Aug 8 03:34 - 05:00 (01:26) user pts/2 192.168.1.6 Wed Aug 8 03:33 - 05:00 (01:27) u1 pts/6 192.168.1.6 Wed Aug 8 03:25 - 03:25 (00:00) 1.5.7.4 lastlog æ˜¾ç¤ºlinuxä¸­æ‰€æœ‰ç”¨æˆ·æœ€è¿‘ä¸€æ¬¡è¿œç¨‹ç™»å½•çš„ä¿¡æ¯ [root@exercise1 ~]# lastlog Username Port From Latest root pts/7 192.168.1.6 Wed Aug 8 08:05:24 +0800 2018 bin **Never logged in** daemon **Never logged in** adm **Never logged in** lp **Never logged in** sync **Never logged in** 1.6ç»„ç›¸å…³å‘½ä»¤ 1.6.1 groupadd åˆ›å»ºç»„ è¯­æ³•æ ¼å¼ groupadd é€‰é¡¹ ç”¨æˆ·ç»„ é€‰é¡¹ -g gid æŒ‡å®šç”¨æˆ·ç»„çš„GIDï¼ŒGIDå”¯ä¸€ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œå¦‚æœä¸æŒ‡å®šGIDä»500å¼€å§‹ -f æ–°å¢ä¸€ä¸ªç»„ï¼Œå¼ºåˆ¶è¦†ç›–ä¸€ä¸ªå·²å­˜åœ¨çš„ç»„ï¼ŒGIDã€ç»„æˆå‘˜ä¸ä¼šæ”¹å˜ 1.6.2 gpasswd å°†å·²å­˜åœ¨çš„ç”¨æˆ·åŠ å…¥åˆ°ç»„ä¸­ è¯­æ³•æ ¼å¼ gpasswd é€‰é¡¹ ç”¨æˆ·å ç»„å é€‰é¡¹ -aï¼šæ·»åŠ ä¸€ä¸ªç”¨æˆ·åˆ°ç»„,å¯ä»¥è¿½åŠ åˆ°ç»„ -Mï¼šæ·»åŠ å¤šä¸ªç”¨æˆ·åˆ°ç»„ï¼Œè¦†ç›–ä¹‹å‰çš„ç»„æˆå‘˜ -dï¼šä»ç»„åˆ é™¤ç”¨æˆ· âš ï¸ 1. -aåªèƒ½æ·»åŠ ä¸€ä¸ªç”¨æˆ·åˆ°ç»„ä¸­ï¼Œæ‰¹é‡æ·»åŠ ç”¨æˆ·åˆ°ç»„ç”¨-Mé€‰é¡¹ 2. -Mé€‰é¡¹å†æ¬¡æ‰§è¡Œæ·»åŠ ç”¨æˆ·åˆ°ç»„ä¼šè¦†ç›–ä¹‹å‰çš„ç”¨æˆ· 1.6.3 groupmod ä¿®æ”¹ç»„ä¿¡æ¯ è¯­æ³•æ ¼å¼ groupmod é€‰é¡¹ ç»„å é€‰é¡¹ -n ä¿®æ”¹ç»„å -g ä¿®æ”¹GID 1.6.4 groupdel åˆ é™¤ç»„ è¯­æ³•æ ¼å¼ groupdel ç»„å 1.6.5 groups æŸ¥çœ‹ç”¨æˆ·å±äºå“ªäº›ç»„ è¯­æ³•æ ¼å¼ groups ç”¨æˆ·å [root@exercise1 ~]# groups root root : root æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/awk/1.awkæ–‡æœ¬å¤„ç†ã€è¯­æ³•ã€å·¥ä½œåŸç†.html":{"url":"linux/linuxå‘½ä»¤/awk/1.awkæ–‡æœ¬å¤„ç†ã€è¯­æ³•ã€å·¥ä½œåŸç†.html","title":"1.awkæ–‡æœ¬å¤„ç†ã€è¯­æ³•ã€å·¥ä½œåŸç†","keywords":"","body":"awkæ–‡æœ¬å¤„ç†ã€è¯­æ³•ã€å·¥ä½œåŸç† ä¸€ã€awkæ–‡æœ¬å¤„ç† 1.é€è¡Œæ‰«ææ–‡ä»¶(æˆ–æµ), ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œ 2.å¯»æ‰¾åŒ¹é…çš„ç‰¹å®šæ¨¡å¼çš„è¡Œ,åœ¨è¡Œä¸Šè¿›è¡Œæ“ä½œ 3.å¦‚æœæ²¡æœ‰æŒ‡å®šå¤„ç†åŠ¨ä½œ,åˆ™æŠŠåŒ¹é…çš„è¡Œæ˜¾ç¤ºåˆ°æ ‡å‡†è¾“å‡º 4.å¦‚æœæ²¡æœ‰æŒ‡å®šæ¨¡å¼ï¼Œåˆ™æ‰€æœ‰è¢«æ“ä½œçš„è¡Œéƒ½è¢«å¤„ç† äºŒã€awkè¯­æ³•æ ¼å¼åŠé‡è¦é€‰é¡¹ 2.1è¯­æ³•æ ¼å¼ awk option 'pattern {action}' file awk é€‰é¡¹ â€˜åŒ¹é…æ¨¡å¼ {åŠ¨ä½œ}â€™ æ–‡ä»¶ pattern åŒ¹é…æ¨¡å¼ action å¤„ç†åŠ¨ä½œï¼Œé’ˆå¯¹ç¬¦åˆåŒ¹é…æ¨¡å¼çš„æ•°æ®è¿›è¡Œçš„å¤„ç†åŠ¨ä½œï¼Œå¦‚æœæ²¡æœ‰patternï¼Œåªæœ‰actionï¼Œä¼šå¯¹æ‰€æœ‰æ–‡æœ¬æ‰§è¡Œactionçš„å¤„ç†åŠ¨ä½œï¼Œå¦‚æœæ²¡æœ‰actionï¼Œåªæœ‰patternï¼Œä¼šæ‰“å°å‡ºç¬¦åˆåŒ¹é…æ¨¡å¼çš„è¡Œ 2.2ä¸¤ä¸ªé‡è¦é€‰é¡¹ 2.2.1 -F æŒ‡å®šå­—æ®µåˆ†éš”ç¬¦ ç¤ºä¾‹ï¼šå–å‡ºIPåœ°å€ -FæŒ‡å®šåˆ†éš”ç¬¦æ˜¯è¿ç»­çš„ç©ºæ ¼å†’å·(centos6.9) #centos6.9 ifconfig eth0 |awk -F'[ :]+' 'NR==2{print $4}' #centos7.5 ifconfig eth0|awk -F'[ ]+' 'NR==2{print $3}' 2.2.2 -v åˆ›å»ºæˆ–ä¿®æ”¹awkä¸­çš„å˜é‡ #åˆ›å»ºä¸€ä¸ªå˜é‡å¹¶è¾“å‡ºï¼Œåªåœ¨awkä¸­ç”Ÿæ•ˆï¼Œä¸”awkä¸­è¾“å‡ºå˜é‡ä¸éœ€è¦åŠ $ç¬¦å· [root@test1 ~]# awk -v n1=10 -v n2=20 'BEGIN{print n1,n2}' 10 20 ä¸€ä¸ª-vé€‰é¡¹è¾“å‡ºå¤šä¸ªå˜é‡ï¼Œæ³¨æ„-våè¾¹å¿…é¡»ä¸å¤§æ‹¬å·ç´§æŒ¨ awk -v{a=10,b=20} 'BEGIN{print a,b}' 10 20 ä¸‰ ã€awkå·¥ä½œåŸç† ç‰ˆæœ¬ä¸€ 1.awkå°†æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œä½œä¸ºè¾“å…¥, å¹¶å°†æ¯ä¸€è¡Œèµ‹ç»™å†…éƒ¨å˜é‡$0, ä»¥æ¢è¡Œç¬¦ç»“æŸ 2.awkå¼€å§‹è¿›è¡Œå­—æ®µåˆ†è§£ï¼Œæ¯ä¸ªå­—æ®µå­˜å‚¨åœ¨å·²ç¼–å·çš„å˜é‡ä¸­ï¼Œä»$1å¼€å§‹[é»˜è®¤ç©ºæ ¼åˆ†å‰²] 3.awké»˜è®¤å­—æ®µåˆ†éš”ç¬¦æ˜¯ç”±å†…éƒ¨FSå˜é‡æ¥ç¡®å®š, å¯ä»¥ä½¿ç”¨-Fä¿®è®¢ 4.awkè¡Œå¤„ç†æ—¶ä½¿ç”¨äº†printå‡½æ•°æ‰“å°åˆ†å‰²åçš„å­—æ®µ 5.awkåœ¨æ‰“å°åçš„å­—æ®µåŠ ä¸Šç©ºæ ¼ï¼Œå› ä¸º$1,$3 ä¹‹é—´æœ‰ä¸€ä¸ªé€—å·ã€‚é€—å·è¢«æ˜ å°„è‡³OFSå†…éƒ¨å˜é‡ä¸­ï¼Œç§°ä¸ºè¾“å‡ºå­—æ®µåˆ†éš”ç¬¦ï¼Œ OFSé»˜è®¤ä¸ºç©ºæ ¼. 6.awkè¾“å‡ºä¹‹åï¼Œå°†ä»æ–‡ä»¶ä¸­è·å–å¦ä¸€è¡Œï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨$0ä¸­ï¼Œè¦†ç›–åŸæ¥çš„å†…å®¹ï¼Œç„¶åå°†æ–°çš„å­—ç¬¦ä¸²åˆ†éš”æˆå­—æ®µå¹¶è¿›è¡Œå¤„ç†ã€‚è¯¥è¿‡ç¨‹å°†æŒç»­åˆ°æ‰€æœ‰è¡Œå¤„ç†å®Œæ¯•. ç‰ˆæœ¬äºŒ 1.å…ˆæ‰§è¡Œå‘½ä»¤è¡Œçš„å‚æ•° 2.å¦‚æœæœ‰BEGIN{}ï¼Œå°±æ‰§è¡Œå…¶ä¸­çš„å†…å®¹ æ­¤æ—¶awkè¿˜æ²¡æœ‰å¼€å§‹è¯»å–æ–‡ä»¶å†…å®¹ 3.BEGIN{}æ‰§è¡Œå®Œåè¯»å–æ–‡ä»¶å†…å®¹ â‘ .åˆ¤æ–­æ˜¯å¦æ»¡è¶³æ¡ä»¶ â‘¡.ç¬¦åˆï¼Œæ‰§è¡Œå‘½ä»¤ â‘¢.ä¸ç¬¦åˆï¼Œè¯»å–ä¸‹ä¸€è¡Œ 4.æ–‡ä»¶å†…å®¹è¯»å–å®Œæˆåï¼Œæœ€åæ‰§è¡ŒEND{}ä¸­çš„å†…å®¹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/awk/2.awk BEGINæ¨¡å¼ã€ENDæ¨¡å¼.html":{"url":"linux/linuxå‘½ä»¤/awk/2.awk BEGINæ¨¡å¼ã€ENDæ¨¡å¼.html","title":"2.awk BEGINæ¨¡å¼ã€ENDæ¨¡å¼","keywords":"","body":"awk BEGINæ¨¡å¼ã€ENDæ¨¡å¼ ä¸€ã€BEGINæ¨¡å¼ BEGINæ¨¡å¼åœ¨awkç¨‹åºæ‰§è¡Œåï¼Œä½†å°šæœªæ‰§è¡Œå¤„ç†åŠ¨ä½œä¹‹å‰éœ€è¦åšçš„å·¥ä½œï¼ˆå®šä¹‰å˜é‡ï¼‰ ä½œç”¨ä¸€ ä¿®æ”¹æ ‡é¢˜ //æ–‡ä»¶a.txtå†…å®¹å¦‚ä¸‹ 101,abc,CEO 102,def,CTO 103,qaz,COO //é»˜è®¤æ‰“å° [root@7-test1 ~]# awk '{print}' a.txt 101,abc,CEO 102,def,CTO 103,qaz,COO //æ‰“å°æ ‡é¢˜ï¼Œæ³¨æ„IDã€nameå¿…é¡»ç”¨åŒå¼•å· [root@7-test1 ~]# awk 'BEGIN{print \"ID\",\"name\",\"position\"}{print}' a.txt ID name position 101,abc,CEO 102,def,CTO 103,qaz,COO ä½œç”¨äºŒ åšè¿ç®— ç¤ºä¾‹1:è®¡ç®—1åˆ°100çš„å’Œ [root@7-test1 ~]# awk 'BEGIN{for(i=1;i ç¤ºä¾‹2:æ™®é€šè®¡ç®— [root@7-test1 ~]# awk 'BEGIN{print 3+3}' 6 [root@7-test1 ~]# awk 'BEGIN{print 3*3}' 9 [root@7-test1 ~]# awk 'BEGIN{print 3-3}' 0 [root@7-test1 ~]# awk 'BEGIN{print 3**3}' 27 [root@7-test1 ~]# awk 'BEGIN{print 3%3}' 0 [root@7-test1 ~]# awk 'BEGIN{print 3/3}' 1 ä½œç”¨ä¸‰ ä¿®æ”¹awkå†…ç½®å˜é‡ record å­—æ®µ separator åˆ†éš”ç¬¦ å˜é‡å å¯¹åº”å•è¯ å«ä¹‰ FS field separator å­—æ®µåˆ†éš”ç¬¦,é»˜è®¤ç©ºæ ¼æˆ–tab OFS output field separator è¾“å‡ºåˆ†éš”ç¬¦,é»˜è®¤ç©ºæ ¼ RS record separator è®°å½•åˆ†éš”ç¬¦,é»˜è®¤æ¢è¡Œç¬¦\\n ORS output record separator è¾“å‡ºè®°å½•åˆ†éš”ç¬¦ FS æŒ‡å®šå­—æ®µåˆ†éš”ç¬¦ //passwd.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹ [root@7-test1 ~]# cat passwd.txt root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin ç¤ºä¾‹1ï¼šä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ï¼Œæ‰“å°æ–‡ä»¶ç¬¬ä¸€åˆ— //-Få†™æ³• [root@7-test1 ~]# awk -F: '{print $1}' passwd.txt root bin daemon //BEGIN {FS}å†™æ³• [root@7-test1 ~]# awk 'BEGIN{FS=\":\"}{print $1}' passwd.txt root bin daemon OFS æŒ‡å®šè¾“å‡ºåˆ†éš”ç¬¦ //æ–‡ä»¶å†…å®¹å¦‚ä¸‹ [root@7-test1 ~]# cat a.txt 1 2 3 ç¤ºä¾‹1ï¼šæ‰“å°æ–‡ä»¶ç¬¬ä¸€åˆ—å’Œç¬¬ä¸‰åˆ—ï¼Œä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ //-v OFSå†™æ³• [root@7-test1 ~]# awk -v OFS=: '{print $1,$3}' a.txt 1:3 //BEGIN {OFS}å†™æ³• [root@7-test1 ~]# awk 'BEGIN{OFS=\":\"}{print $1,$3}' a.txt 1:3 âš ï¸âš ï¸âš ï¸æ³¨æ„ï¼šï¼ï¼ï¼ -v OFSå†™æ³•çš„ä¸€ä¸ªå‘ï¼šå½“print $0çš„æ—¶å€™ï¼Œ-v OFSä¼šä¸ç”Ÿæ•ˆ //æ­£ç¡®è¾“å‡ºåº”è¯¥ä¸º1:2:3 [root@7-test1 ~]# awk -v OFS=: '{print $0}' a.txt 1 2 3 è§£å†³æ–¹æ³• åœ¨print$0å‰åŠ ä¸€ä¸ª$1=$1 [root@7-test1 ~]# awk -v OFS=: '{$1=$1;print $0}' a.txt 1:2:3 RS æŒ‡å®šè®°å½•åˆ†éš”ç¬¦ï¼Œå³æŒ‡å®šä»¥ä»€ä¹ˆä¸ºåˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸º\\n //æ–‡ä»¶å†…å®¹ æ–‡ä»¶é»˜è®¤ä»¥æ¢è¡Œä¸ºè®°å½•åˆ†éš”ç¬¦ [root@7-test1 ~]# cat passwd.txt root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin ç¤ºä¾‹1ï¼šå°†æ–‡ä»¶çš„è®°å½•åˆ†éš”ç¬¦æŒ‡å®šä¸º/ï¼Œå³æŒ‡å®šæ–‡ä»¶ä»¥/ä¸ºæ¢è¡Œç¬¦ //-v RSå†™æ³• [root@7-test1 ~]# awk -v RS=/ '{print $0}' passwd.txt root:x:0:0:root: root: bin bash bin:x:1:1:bin: bin: sbin nologin //BEGIN {RS}å†™æ³• [root@7-test1 ~]# awk 'BEGIN{RS=\"/\"}{print $0}' passwd.txt root:x:0:0:root: root: bin bash bin:x:1:1:bin: bin: sbin nologin ORS æŒ‡å®šè¾“å‡ºè®°å½•åˆ†éš”ç¬¦ //æ–‡ä»¶å†…å®¹ [root@7-test1 ~]# cat a.txt 1 2 3 ç¤ºä¾‹1ï¼šå°†æ–‡ä»¶çš„è¾“å‡ºè®°å½•åˆ†éš”ç¬¦æŒ‡å®šä¸º/ //-v ORSå†™æ³• [root@7-test1 ~]# awk -v ORS=\"A\" '{print $0}' a.txt 1A2A3A //BEGIN {ORS}å†™æ³• [root@7-test1 ~]# awk 'BEGIN{ORS=\"A\"}{print $0}' a.txt 1A2A3A æ‰©å±•-awkå‘½ä»¤è¡Œå‚æ•° ARGCæ˜¯å‘½ä»¤è¡Œå‚æ•°æ•°é‡ ARGVæ˜¯å°†å‘½ä»¤è¡Œå‚æ•°å­˜åˆ°æ•°ç»„ï¼Œå…ƒç´ ç”±ARGCæŒ‡å®šï¼Œæ•°ç»„ä¸‹æ ‡ä»0å¼€å§‹ ARGC [root@test1 ~]# awk 'BEGIN{print ARGC}' 1 [root@test1 ~]# awk 'BEGIN{print ARGC}' 1 2 3 ARGV [root@test1 ~]# awk 'BEGIN{print ARGV[0]}' 1 2 awk [root@test1 ~]# awk 'BEGIN{print ARGV[1]}' 1 2 1 [root@test1 ~]# awk 'BEGIN{print ARGV[2]}' 1 2 2 äºŒã€ENDæ¨¡å¼ ENDæ¨¡å¼åœ¨awkè¯»å–å®Œæ–‡ä»¶ä¹‹åæ‰§è¡Œï¼Œä¸»è¦ä½œç”¨ä¸ºæ˜¾ç¤ºè®¡ç®—ç»“æœ ä½œç”¨ æ˜¾ç¤ºè®¡ç®—ç»“æœ ç¤ºä¾‹1:ç»Ÿè®¡/etc/passwdæ–‡ä»¶ä¸­å‰10è¡Œéç™»é™†shellçš„ä¸ªæ•° //æ–‡ä»¶å†…å®¹ [root@7-test1 awk]# head -10 /etc/passwd root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin adm:x:3:4:adm:/var/adm:/sbin/nologin lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin sync:x:5:0:sync:/sbin:/bin/sync shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown halt:x:7:0:halt:/sbin:/sbin/halt mail:x:8:12:mail:/var/spool/mail:/sbin/nologin operator:x:11:0:operator:/root:/sbin/nologin //ç»Ÿè®¡æ–‡ä»¶ä¸­éç™»é™†shellçš„ä¸ªæ•°ï¼Œå³ç»Ÿè®¡/sbin/nologinçš„ä¸ªæ•° [root@7-test1 awk]# head -10 /etc/passwd|awk '/nologin/{i++}END{print i}' 6 ç¤ºä¾‹2:ç»Ÿè®¡/etc/servicesä¸­ç©ºè¡Œæ•°é‡ [root@7-test1 awk]# awk '/^$/{i++}END{print i}' /etc/services 17 ç¤ºä¾‹3:ç»Ÿè®¡nginxè®¿é—®æ—¥å¿—ä¸­è®¿é—®é‡å‰10çš„IP [root@7-test1 ~]# awk '{a[$1]++}END{for(i in a) print a[i],i}' /var/log/nginx/access.log|sort -nr|head 275 109.98.109.101 262 146.196.97.242 210 47.52.155.218 152 142.234.200.81 75 72.211.58.142 10 120.25.208.128 7 42.236.10.84 6 42.236.10.92 3 5.188.210.12 3 42.236.10.75 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/awk/3.awkå†…ç½®å˜é‡.html":{"url":"linux/linuxå‘½ä»¤/awk/3.awkå†…ç½®å˜é‡.html","title":"3.awkå†…ç½®å˜é‡","keywords":"","body":"awkå†…ç½®å˜é‡ $0 è¡¨ç¤ºåŒ¹é…çš„æ•´è¡Œ //æ–‡ä»¶å†…å®¹ [root@7-test1 ~]# cat passwd.txt root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin ç¤ºä¾‹ï¼š [root@7-test1 ~]# awk '{print $0}' passwd.txt root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin NR æ€»çš„è¡Œå· //æ–‡ä»¶a.txtå’Œb.txtçš„å†…å®¹å¦‚ä¸‹ æ–‡ä»¶a.txt 101,abc,CEO 102,def,CTO 103,qaz,COO æ–‡ä»¶b.txt 666,ABC,CEO 777,DEF,CTO 888,QAZ,COO //æ‰“å°ä¸¤ä¸ªæ–‡ä»¶ï¼ŒNRç»Ÿè®¡æ€»çš„è¡Œå· [root@7-test1 ~]# awk '{print NR,$0}' a.txt b.txt 1 101,abc,CEO 2 102,def,CTO 3 103,qaz,COO 4 666,ABC,CEO 5 777,DEF,CTO 6 888,QAZ,COO FNR å½“å‰æ–‡ä»¶çš„è¡Œå· æ–‡ä»¶a.txt 101,abc,CEO 102,def,CTO 103,qaz,COO æ–‡ä»¶b.txt 666,ABC,CEO 777,DEF,CTO 888,QAZ,COO //æ‰“å°ä¸¤ä¸ªæ–‡ä»¶ï¼ŒFNRåªç»Ÿè®¡æ¯ä¸ªæ–‡ä»¶çš„è¡Œå· [root@7-test1 ~]# awk '{print FNR,$0}' a.txt b.txt 1 101,abc,CEO 2 102,def,CTO 3 103,qaz,COO 1 666,ABC,CEO 2 777,DEF,CTO 3 888,QAZ,COO NF æ–‡ä»¶æœ€åä¸€åˆ— //æ‰“å°/etc/passwdæ–‡ä»¶æœ€åä¸€åˆ— [root@7-test1 ~]# awk -F: '{print $NF}' /etc/passwd|head /bin/bash /sbin/nologin /sbin/nologin /sbin/nologin /sbin/nologin /bin/sync /sbin/shutdown /sbin/halt /sbin/nologin /sbin/nologin åˆ†éš”ç¬¦ record å­—æ®µ separator åˆ†éš”ç¬¦ å˜é‡å å¯¹åº”å•è¯ å«ä¹‰ FS field separator å­—æ®µåˆ†éš”ç¬¦,é»˜è®¤ç©ºæ ¼æˆ–tab OFS output field separator è¾“å‡ºåˆ†éš”ç¬¦,é»˜è®¤ç©ºæ ¼ RS record separator è®°å½•åˆ†éš”ç¬¦,é»˜è®¤æ¢è¡Œç¬¦\\n ORS output record separator è¾“å‡ºè®°å½•åˆ†éš”ç¬¦ FS æŒ‡å®šå­—æ®µåˆ†éš”ç¬¦ //passwd.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹ [root@7-test1 ~]# cat passwd.txt root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin ç¤ºä¾‹1ï¼šä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ï¼Œæ‰“å°æ–‡ä»¶ç¬¬ä¸€åˆ— //-Få†™æ³• [root@7-test1 ~]# awk -F: '{print $1}' passwd.txt root bin daemon //BEGIN {FS}å†™æ³• [root@7-test1 ~]# awk 'BEGIN{FS=\":\"}{print $1}' passwd.txt root bin daemon OFS æŒ‡å®šè¾“å‡ºåˆ†éš”ç¬¦ //æ–‡ä»¶å†…å®¹å¦‚ä¸‹ [root@7-test1 ~]# cat a.txt 1 2 3 ç¤ºä¾‹1ï¼šæ‰“å°æ–‡ä»¶ç¬¬ä¸€åˆ—å’Œç¬¬ä¸‰åˆ—ï¼Œä»¥å†’å·ä¸ºåˆ†éš”ç¬¦ //-v OFSå†™æ³• [root@7-test1 ~]# awk -v OFS=: '{print $1,$3}' a.txt 1:3 //BEGIN {OFS}å†™æ³• [root@7-test1 ~]# awk 'BEGIN{OFS=\":\"}{print $1,$3}' a.txt 1:3 âš ï¸âš ï¸âš ï¸æ³¨æ„ï¼šï¼ï¼ï¼ -v OFSå†™æ³•çš„ä¸€ä¸ªå‘ï¼šå½“print $0çš„æ—¶å€™ï¼Œ-v OFSä¼šä¸ç”Ÿæ•ˆ //æ­£ç¡®è¾“å‡ºåº”è¯¥ä¸º1:2:3 [root@7-test1 ~]# awk -v OFS=: '{print $0}' a.txt 1 2 3 è§£å†³æ–¹æ³• åœ¨print$0å‰åŠ ä¸€ä¸ª$1=$1 [root@7-test1 ~]# awk -v OFS=: '{$1=$1;print $0}' a.txt 1:2:3 RS æŒ‡å®šè®°å½•åˆ†éš”ç¬¦ï¼Œå³æŒ‡å®šä»¥ä»€ä¹ˆä¸ºåˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸º\\n //æ–‡ä»¶å†…å®¹ æ–‡ä»¶é»˜è®¤ä»¥æ¢è¡Œä¸ºè®°å½•åˆ†éš”ç¬¦ [root@7-test1 ~]# cat passwd.txt root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin ç¤ºä¾‹1ï¼šå°†æ–‡ä»¶çš„è®°å½•åˆ†éš”ç¬¦æŒ‡å®šä¸º/ï¼Œå³æŒ‡å®šæ–‡ä»¶ä»¥/ä¸ºæ¢è¡Œç¬¦ //-v RSå†™æ³• [root@7-test1 ~]# awk -v RS=/ '{print $0}' passwd.txt root:x:0:0:root: root: bin bash bin:x:1:1:bin: bin: sbin nologin //BEGIN {RS}å†™æ³• [root@7-test1 ~]# awk 'BEGIN{RS=\"/\"}{print $0}' passwd.txt root:x:0:0:root: root: bin bash bin:x:1:1:bin: bin: sbin nologin ORS æŒ‡å®šè¾“å‡ºè®°å½•åˆ†éš”ç¬¦ //æ–‡ä»¶å†…å®¹ [root@7-test1 ~]# cat a.txt 1 2 3 ç¤ºä¾‹1ï¼šå°†æ–‡ä»¶çš„è¾“å‡ºè®°å½•åˆ†éš”ç¬¦æŒ‡å®šä¸º/ //-v ORSå†™æ³• [root@7-test1 ~]# awk -v ORS=\"A\" '{print $0}' a.txt 1A2A3A //BEGIN {ORS}å†™æ³• [root@7-test1 ~]# awk 'BEGIN{ORS=\"A\"}{print $0}' a.txt 1A2A3A æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/awk/4.awkåŒ¹é…æ¨¡å¼.html":{"url":"linux/linuxå‘½ä»¤/awk/4.awkåŒ¹é…æ¨¡å¼.html","title":"4.awkåŒ¹é…æ¨¡å¼","keywords":"","body":"awkåŒ¹é…æ¨¡å¼ ä¸€ã€æ­£åˆ™è¡¨è¾¾å¼ 1.1åŒ¹é…è®°å½•(æ•´è¡Œ) //åŒ¹é…/etc/passwdæ–‡ä»¶ä¸­ä»¥rootå¼€å¤´çš„ [root@7-test1 ~]# awk '/^root/' /etc/passwd root:x:0:0:root:/root:/bin/bash [root@7-test1 ~]# awk '$0 ~/^root/' /etc/passwd root:x:0:0:root:/root:/bin/bash 1.2åŒ¹é…å­—æ®µ åŒ¹é…æ“ä½œç¬¦(~|!~) //åŒ¹é…/etc/passwdæ–‡ä»¶ä¸­ç¬¬ä¸€åˆ—ä»¥rootå¼€å¤´çš„ [root@7-test1 ~]# awk '$1~/^root/' /etc/passwd root:x:0:0:root:/root:/bin/bash //åŒ¹é…/etc/passwdæ–‡ä»¶ä¸­æœ€åä¸€åˆ—ä¸æ˜¯ä»¥bashç»“å°¾çš„ [root@7-test1 ~]# awk '$NF !~ /bash$/' /etc/passwd|head -5 bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin adm:x:3:4:adm:/var/adm:/sbin/nologin lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin sync:x:5:0:sync:/sbin:/bin/sync ^å’Œ~ç”¨æ³•ç¤ºä¾‹ ^ åœ¨awkä¸­è¡¨ç¤ºä»¥...å¼€å¤´çš„åˆ—ï¼Œåœ¨sedã€grepä¸­è¡¨ç¤ºä»¥...å¼€å¤´çš„è¡Œ ^ç”¨æ³•ç¤ºä¾‹ ç¤ºä¾‹ï¼šæ‰“å°æ–‡ä»¶ä¸­ä»¥1å¼€å¤´çš„è¡Œ //æ–‡ä»¶å†…å®¹ [root@7-test1 awk]# cat t.txt 1 101,hehe,CEO 2 102,haha,CTO 3 103,xixi,COO 4 105,yy,CFO 5 106,xx,CIO 6 110,jjxx,COCO [root@7-test1 awk]# awk '/^1/{print}' t.txt 1 101,hehe,CEO ï½ç”¨æ³•ç¤ºä¾‹ //æ–‡ä»¶å†…å®¹ [root@7-test1 awk]# cat t1.txt zhang san 1234567 :550:100:175 li si 88883336 :155:90:201 wang wu 66666666 :250:60:50 zhao liu 67676798 :150:80:75 hao qi 11112222 :250:100:175 zhu ba 000098763 :50:95:135 //æ˜¾ç¤ºæ‰€æœ‰IDå·ç æœ€åä¸€ä½æ˜¯2æˆ–7çš„äººçš„å…¨å [root@7-test1 awk]# awk '$3~/[27]$/{print $1,$2}' t1.txt zhang san hao qi //æ˜¾ç¤ºæ–‡ä»¶ä¸­ç¬¬ä¸‰åˆ—ä»¥1å¼€å¤´çš„è¡Œ [root@7-test1 awk]# awk '$3~/^1/{print}' t1.txt zhang san hao qi //æ˜¾ç¤ºzhangçš„å§“æ°å’ŒIDå·ç  [root@7-test1 awk]# awk '$1~/zhang/{print $1,$3}' t1.txt zhang 1234567 //æ˜¾ç¤ºzhangçš„ææ¬¾ï¼Œæ¯ä¸ªå€¼éƒ½ä»¥$å¼€å¤´ï¼Œå¦‚$250$100$175 æ–¹æ³•ä¸€ï¼š [root@7-test1 awk]# awk -vFS='[ :]+' -vOFS=$ '$1~/zhang/{print \"$\"$4,$5,$NF}' t1.txt $550$100$175 æ–¹æ³•äºŒï¼š awkæ›¿æ¢å‡½æ•°gsub gsub å…¨å±€æ›¿æ¢ awkå†…ç½®å‘½ä»¤(å‡½æ•°) ä½¿ç”¨æ–¹æ³• gsub(//,\"\",$n) nè¡¨ç¤ºæ•°å­— gsub(/æ‰¾è°/,\"æ›¿æ¢ä¸ºä»€ä¹ˆ\",æ›¿æ¢å“ªä¸€åˆ—) [root@7-test1 awk]# awk '$1~/zhang/{gsub(/:/,\"$\",$NF);print $1,$NF}' t1.txt zhang $550$100$175 äºŒã€æ¡ä»¶è¡¨è¾¾å¼ 2.1å…³ç³»è¿ç®—ç¬¦ è¿ç®—ç¬¦ å«ä¹‰ å°äº å°äºç­‰äº == ç­‰äº != ä¸ç­‰äº > å¤§äº >= å¤§äºç­‰äº ~ æ¨¡ç³ŠåŒ¹é… !~ æ¨¡ç³ŠåŒ¹é…å–å 2.2ç¤ºä¾‹ ç¤ºä¾‹1:æ‰“å°ç¬¬ä¸€åˆ—å¤§äº3çš„è¡Œ //æ–‡ä»¶å†…å®¹ [root@7-test1 awk]# cat t.txt 1 101,hehe,CEO 2 102,haha,CTO 3 103,xixi,COO 4 105,yy,CFO 5 106,xx,CIO 6 110,jjxx,COCO [root@7-test1 awk]# awk '{if($1>3)print}' t.txt 4 105,yy,CFO 5 106,xx,CIO 6 110,jjxx,COCO ç¤ºä¾‹2:æ˜¾ç¤ºç£ç›˜ä½¿ç”¨ç‡å¤§äº10%çš„ç£ç›˜åˆ†åŒºå’ŒæŒ‚è½½ç‚¹ [root@7-test1 awk]# df -h Filesystem Size Used Avail Use% Mounted on /dev/mapper/centos-root 17G 2.4G 15G 14% / devtmpfs 224M 0 224M 0% /dev tmpfs 236M 0 236M 0% /dev/shm tmpfs 236M 9.6M 226M 5% /run tmpfs 236M 0 236M 0% /sys/fs/cgroup /dev/sda1 1014M 132M 883M 14% /boot tmpfs 48M 0 48M 0% /run/user/0 [root@7-test1 awk]# df -h|awk -F'[% ]+' 'NR>1 && $5>10{print $1,$5\"%\",$NF}' /dev/mapper/centos-root 14% / /dev/sda1 14% /boot ç¤ºä¾‹3:è®¡ç®—å†…å­˜ä½¿ç”¨ç‡ centOS6 //centOS6æŸ¥çœ‹å†…å­˜ä½¿ç”¨ç‡ [root@test1 ~]# free -m total used free shared buffers cached Mem: 474 171 303 0 30 44 -/+ buffers/cache: 95 378 Swap: 1023 0 1023 //centOS6è®¡ç®—å†…å­˜ä½¿ç”¨ç‡ [root@test1 ~]# free -m|awk 'NR==3{print $3/($3+$4)*100\"%\"}' 20.296% centOS7 //centOS7æŸ¥çœ‹å†…å­˜ä½¿ç”¨ç‡ [root@7-test1 awk]# free -m total used free shared buff/cache available Mem: 470 90 243 5 136 330 Swap: 2047 0 2047 //centOS7è®¡ç®—å†…å­˜ä½¿ç”¨ç‡ [root@7-test1 awk]# free -m|awk 'NR==2{print ($2-$NF)/$2*100\"%\"}' 30% ç¤ºä¾‹4:åŒæ—¶è®¡ç®—å†…å­˜ä½¿ç”¨ç‡å’Œç©ºé—²ç‡ centOS6 //centOS6è®¡ç®—å†…å­˜ä½¿ç”¨ç‡å’Œç©ºé—²ç‡ [root@test1 ~]# free -m|awk 'NR==3{print $3/($3+$4)*100\"%\",$NF/($3+$NF)*100\"%\"}' 20.4641% 79.5359% centOS7 //centOS7è®¡ç®—å†…å­˜ä½¿ç”¨ç‡å’Œç©ºé—²ç‡ [root@7-test1 ~]# free -m|awk 'NR==2{print ($2-$NF)/$2*100\"%\",$NF/$2*100\"%\"}' 30% 70% 2.3awkçš„ä¸€ä¸ªå‘ âš ï¸âš ï¸âš ï¸awkä¼šæŠŠæ•°å­—å½“æˆå­—ç¬¦å¤„ç† //æŸ¥çœ‹ç£ç›˜ä½¿ç”¨ç‡ [root@test1 ~]# df -h Filesystem Size Used Avail Use% Mounted on /dev/sda3 19G 2.4G 16G 14% / tmpfs 238M 0 238M 0% /dev/shm /dev/sda1 190M 35M 146M 19% /boot //æ‰“å°ç¬¬äºŒè¡Œç¬¬5åˆ—å°äº9çš„åˆ—ï¼Œç»“æœä¸æ­£ç¡® [root@test1 ~]# df -h|awk 'NR>1 && $51 && $5+01 && $5 ä¸‰ã€è¿ç®—è¡¨è¾¾å¼ ç¤ºä¾‹1:æ‰“å°/etc/passwdç¬¬ä¸‰åˆ—ä¸10ç›¸ä¹˜å¤§äº5000çš„å†…å®¹ [root@test1 ~]# awk -F: '$3 * 10 > 5000' /etc/passwd polkitd:x:999:998:User for polkitd:/:/sbin/nologin chrony:x:998:996::/var/lib/chrony:/sbin/nologin mysql:x:1000:1000::/home/mysql:/sbin/nologin ç¤ºä¾‹2ï¼šæ‰“å°/etc/passwdç¬¬ä¸‰åˆ—ä¸10ç›¸ä¹˜å¤§äº500çš„å†…å®¹ï¼Œå¹¶æ‰“å°ç¬¬ä¸€åˆ—å’Œç¬¬ä¸‰åˆ— [root@test1 ~]# awk -F: 'BEGIN{OFS=\"--\"} { if($3*10>5000) {print $1,$3} } END {print \"æ‰“å°ok\"}' /etc/passwd polkitd--999 chrony--998 mysql--1000 æ‰“å°ok ç¤ºä¾‹3:åŠ ã€å‡ã€ä¹˜ã€é™¤ã€å–æ¨¡ã€å¹‚è¿ç®— //æ–‡ä»¶test.txtå†…å®¹å¦‚ä¸‹ [root@test1 ~]# cat test.txt a 1 2 3 4 5 b 1 2 3 4 5 a 5 6 7 8 9 [root@test1 ~]# awk '/a/{print $2+10}' test.txt 11 15 [root@test1 ~]# awk '/a/{print $2-10}' test.txt -9 -5 [root@test1 ~]# awk '/a/{print $2*10}' test.txt 10 50 [root@test1 ~]# awk '/a/{print $2/10}' test.txt 0.1 0.5 [root@test1 ~]# awk '/a/{print $2%10}' test.txt 1 5 [root@test1 ~]# awk '/a/{print $2**10}' test.txt 1 9765625 å››ã€é€»è¾‘æ“ä½œç¬¦å’Œå¤åˆæ¨¡å¼ 4.1é€»è¾‘æ“ä½œç¬¦ ç¬¦å· å«ä¹‰ && é€»è¾‘ä¸ **\\ \\ ** é€»è¾‘æˆ– ï¼ é€»è¾‘é ç¤ºä¾‹1:æ‰“å°/etc/passwdæ–‡ä»¶ä¸­ç”¨æˆ·åä¸ºrootå¹¶ä¸”æ‰“å°uidå°äº15çš„è¡Œ //æ–‡ä»¶ä¸­ç¬¬ä¸‰åˆ—æ˜¯UID [root@test1 ~]# awk -F: '$1~/root/ && $3 ç¤ºä¾‹2:æ‰“å°ç”¨æˆ·åä¸ºrootæˆ–ç¬¬ä¸‰åˆ—å¤§äº500çš„è¡Œ [root@test1 ~]# awk -F: '$1~/root/ || $3>=500' /etc/passwd root:x:0:0:root:/root:/bin/bash polkitd:x:999:998:User for polkitd:/:/sbin/nologin chrony:x:998:996::/var/lib/chrony:/sbin/nologin mysql:x:1000:1000::/home/mysql:/bin/false 4.2ä¸‰å…ƒè¿ç®—ç¬¦ ä¸‰å…ƒè¿ç®—ç¬¦è¡¨è¾¾å¼ ä¸‰å…ƒè¿ç®—ç¬¦çš„å½¢å¼1ï¼š[ ç»“æœ = æ¡ä»¶ ? ç»“æœ1ï¼šç»“æœ2 ] ä¸‰å…ƒè¿ç®—ç¬¦çš„å½¢å¼2ï¼š[ æ¡ä»¶ ï¼Ÿ è¡¨è¾¾å¼1 ï¼š è¡¨è¾¾å¼2 ] ç¤ºä¾‹ï¼š //æ–‡ä»¶t.txtå†…å®¹å¦‚ä¸‹ [root@test1 ~]# cat t.txt student1 98 student2 99 student3 93 student4 78 student5 85 æ ¹æ®å­¦ç”Ÿæˆç»©åˆ¤æ–­å­¦ç”Ÿæˆç»©æ˜¯å¦ä¸ºä¼˜ç§€ï¼Œè¿™é‡Œè§„å®šåˆ†æ•°å¤§äº90æ˜¯ä¼˜ç§€ï¼Œä½äº90éä¼˜ç§€ //éä¸‰å…ƒè¿ç®—å†™æ³• [root@test1 ~]# awk '{if($2>90){print $1,\"ä¼˜ç§€\"}else{print $1,\"ä¸ä¼˜ç§€\"}}' t.txt student1 ä¼˜ç§€ student2 ä¼˜ç§€ student3 ä¼˜ç§€ student4 ä¸ä¼˜ç§€ student5 ä¸ä¼˜ç§€ //ä¸‰å…ƒè¿ç®—å†™æ³•ä¸€ ç»“æœ = æ¡ä»¶ ? ç»“æœ1ï¼šç»“æœ2 [root@test1 ~]# awk '{res=$2>90?\"ä¼˜ç§€\":\"ä¸ä¼˜ç§€\";print $1,res}' t.txt student1 ä¼˜ç§€ student2 ä¼˜ç§€ student3 ä¼˜ç§€ student4 ä¸ä¼˜ç§€ student5 ä¸ä¼˜ç§€ #ä¸Šè¿°awkå†™æ³•ä¸­çš„printä¹Ÿå¯ä»¥å•ç‹¬å†™åœ¨ä¸€ä¸ªå¤§æ‹¬å·ä¸­ awk '{res=$2>90?\"ä¼˜ç§€\":\"ä¸ä¼˜ç§€\"}{print $1,res}' t.txt #å¯ä»¥ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦ç»Ÿè®¡ä¸ªæ•° //ä¸‰å…ƒè¿ç®—å†™æ³•äºŒ æ¡ä»¶ ï¼Ÿ è¡¨è¾¾å¼1 ï¼š è¡¨è¾¾å¼2 [root@test1 ~]# awk '{$2>90?a++:b++}END{print a,b}' t.txt 3 2 aè¡¨ç¤ºç¬¦åˆæ¡ä»¶çš„ï¼Œbè¡¨ç¤ºä¸ç¬¦åˆæ¡ä»¶çš„ï¼Œå¤§äº90åˆ†çš„æœ‰3ä¸ªï¼Œä½äº90åˆ†çš„æœ‰2ä¸ª è‡³ä»Šæ²¡æ‡‚çš„ä¸€é“é¢˜ğŸ¦™ğŸ¦™ğŸ¦™ æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat lessons.txt 634751 é¢„æ’ 568688 é¢„æ’ 386760 åˆ é™¤ 619373 é¢„æ’ 428491 é¢„æ’ 487563 å®Œæˆ 603342 å®Œæˆ 436339 å®Œæˆ ç»“æœï¼š åˆ é™¤ 386760 å®Œæˆ 487563,603342,436339 é¢„æ’ 634751,568688,619373,428491 [root@test1 ~]# awk '{a[$2]=a[$2]\" \"$1}END{for(i in a) print i,a[i]}' lessons.txt åˆ é™¤ 386760 å®Œæˆ 487563 603342 436339 é¢„æ’ 634751 568688 619373 428491 [root@test1 ~]# awk '{a[$2]=a[$2]\",\"$1}END{for(i in a) print i,a[i]}' lessons.txt åˆ é™¤ ,386760 å®Œæˆ ,487563,603342,436339 é¢„æ’ ,634751,568688,619373,428491 æ–¹æ³•ä¸€ [root@test1 ~]# awk '{a[$2]=a[$2]?a[$2]\",\"$1:a[$2]$1}END{for(i in a) print i,a[i]}' lessons.txt åˆ é™¤ 386760 å®Œæˆ 487563,603342,436339 é¢„æ’ 634751,568688,619373,428491 æ–¹æ³•äºŒ [root@test1 ~]# awk '{if(a[$2]){a[$2]=a[$2]\",\"$1}else{a[$2]=a[$2]$1}}END{for(i in a) print i,a[i]}' lessons.txt åˆ é™¤ 386760 å®Œæˆ 487563,603342,436339 é¢„æ’ 634751,568688,619373,428491 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/awk/5.awkæ¡ä»¶.html":{"url":"linux/linuxå‘½ä»¤/awk/5.awkæ¡ä»¶.html","title":"5.awkæ¡ä»¶","keywords":"","body":"awkæ¡ä»¶ ä¸€ã€if 1.1è¯­æ³•æ ¼å¼ {if(è¡¨è¾¾å¼) {è¯­å¥1;è¯­å¥2;...}} 1.2ç¤ºä¾‹ ç¤ºä¾‹1:æ‰“å°/etc/passwdæ–‡ä»¶ä¸­çš„rootç”¨æˆ· [root@test1 ~]# awk -F: '{if ($3==0) {print $1 \" is adminisitrator\"}}' /etc/passwd root is adminisitrator ç¤ºä¾‹2:ç»Ÿè®¡/etc/passwdä¸­ç³»ç»Ÿç”¨æˆ·æ•° [root@test1 ~]# awk -F: '{ if($3>0 && $3 ç¤ºä¾‹3:ç»Ÿè®¡/etc/passwdä¸­æ™®é€šç”¨æˆ·æ•°é‡ [root@test1 ~]# awk -F: '{if ($3>1000) {i++}} END{print i}' /etc/passwd 2 ç¤ºä¾‹4:å†™å‡ºä¸€ä¸ªshellè„šæœ¬ï¼ŒæŠŠå½“å‰ç›®å½•ä¸‹çš„æ–‡æœ¬æ–‡ä»¶number.txté‡Œé¢æ•°å­—å¤§äº100çš„æ±‚å’Œå¹¶è¾“å‡ºï¼Œå¹¶æ‰“å°æ‰€åœ¨è¡Œè¡Œå·åŠå†…å®¹ï¼Œæœ€åè¿˜è¦è¾“å‡ºæ¯ä¸€è¡Œçš„æ€»å’Œ //æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat number.txt 100 98 205 303 1 99 66 33 [root@test1 ~]# awk '{if($1>100){sum+=$1;print NR,$0}}{i+=$1}END{print sum,i}' number.txt 3 205 4 303 508 905 äºŒã€if...else 2.1è¯­æ³•æ ¼å¼ {if(è¡¨è¾¾å¼)ï½›è¯­å¥;è¯­å¥;... ï½else{è¯­å¥;è¯­å¥;...}} 2.2ç¤ºä¾‹ ç¤ºä¾‹1:if elseè¯­å¥ç®€å•ä½¿ç”¨ //æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat test.txt 1 2 3 4 5 6 [root@test1 ~]# awk '{if ($3==3) {print $1} else {print $NF}}' test.txt 1 [root@test1 ~]# awk '{if ($3==6) {print $1} else {print $NF}}' test.txt 6 ç¤ºä¾‹2:æ‰“å°/etc/passwdä¸­éç®¡ç†å‘˜ä¸ªæ•°å’Œç®¡ç†å‘˜ä¸ªæ•° [root@test1 ~]# awk -F: '{if ($3==0) {a++} else {b++}} END{print \"ç®¡ç†å‘˜ç”¨æˆ·ä¸ªæ•°ï¼š\"a;print \"å…¶ä»–ç”¨æˆ·ä¸ªæ•°ï¼š\"b}' /etc/passwd ç®¡ç†å‘˜ç”¨æˆ·ä¸ªæ•°ï¼š1 å…¶ä»–ç”¨æˆ·ä¸ªæ•°ï¼š24 ä¸‰ã€if...else if...else 3.1è¯­æ³•æ ¼å¼ {if(è¡¨è¾¾å¼ 1)ï½›è¯­å¥;è¯­å¥ï¼›... ï½else if(è¡¨è¾¾å¼ 2)ï½›è¯­å¥;è¯­å¥ï¼›... ï½elseï½›è¯­å¥;è¯­å¥ï¼›... }} 3.2ç¤ºä¾‹ ç»Ÿè®¡/etc/passwdæ–‡ä»¶ä¸­ç”¨æˆ·çš„ç§ç±» #/etc/passwdæ–‡ä»¶ä¸­ç¬¬ä¸‰åˆ—æ˜¯ç”¨æˆ·UIDï¼Œcentos7ä¸­æ™®é€šç”¨æˆ·UIDå¤§äº1000 awk -F: '{if($3==0){i++} else if($3>0 && $30 && $3=1000){k++}} END{print \"ç®¡ç†å‘˜ä¸ªæ•°ä¸º:\"i;print \"ç³»ç»Ÿç”¨æˆ·ä¸ªæ•°ä¸º:\"j;print \"æ™®é€šç”¨æˆ·ä¸ªæ•°ä¸º:\"k}' /etc/passwd ç®¡ç†å‘˜ä¸ªæ•°ä¸º:1 ç³»ç»Ÿç”¨æˆ·ä¸ªæ•°ä¸º:25 æ™®é€šç”¨æˆ·ä¸ªæ•°ä¸º:1 å››ã€switch-case #ç¤ºä¾‹ [root@test1 ~]# awk 'BEGIN{a=1;b=2;c=3; switch(a){case 1:print a;break;case 2:print b;break; case 3:print c;break;}}' 1 #æ ¼å¼åŒ–åçš„æ•´ä½“ç»“æ„å¦‚ä¸‹ BEGIN{ a=1; b=2; c=3; switch(a){ case 1: print a;break; case 2: print b;break; case 3: print c;break; } } æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/awk/6.awkå¾ªç¯.html":{"url":"linux/linuxå‘½ä»¤/awk/6.awkå¾ªç¯.html","title":"6.awkå¾ªç¯","keywords":"","body":"awkå¾ªç¯ 1.forå¾ªç¯ 1.1 cæ ¼å¼ 1.1.1 cæ ¼å¼è¯­æ³• for(åˆå§‹å€¼;ç»ˆæ­¢å€¼;æ­¥é•¿å€¼){è¯­å¥} 1.1.2ç¤ºä¾‹ //ç¤ºä¾‹1 [root@test1 ~]# awk 'BEGIN{for(i=1;i 1.2 åˆ—è¡¨æ ¼å¼ 1.2.1 åˆ—è¡¨æ ¼å¼è¯­æ³• for(å˜é‡ in æ•°ç»„){è¯­å¥} 1.2.2ç¤ºä¾‹ [root@test1 ~]# awk 'BEGIN{a[0]=10;a[1]=11;for(i in a) print i,a[i]}' 0 10 1 11 2.whileå¾ªç¯ 2.1è¯­æ³•æ ¼å¼ while(æ¡ä»¶){è¯­å¥} 2.2ç¤ºä¾‹ è¯­å¥ç¤ºä¾‹ //æ‰“å°1-5 [root@test1 ~]# awk 'BEGIN{i=1;while(i awkæ–‡ä»¶ç¤ºä¾‹ //ç”¨awkè·å–æ–‡ä»¶ä¸­ç¬¬ä¸‰åˆ—åˆ°å€’æ•°ç¬¬äºŒåˆ—å­—æ®µ [root@test1 ~]# cat > awk.awk 3.do whileå¾ªç¯ 3.1è¯­æ³• do {è¯­å¥} while(æ¡ä»¶) 3.2ç¤ºä¾‹ ç¤ºä¾‹ï¼šè®¡ç®—1-100çš„å’Œ [root@test1 ~]# awk 'BEGIN{do{sum+=i;i++}while(i å¾ªç¯ä¸­çš„å…³é”®å­— breakï¼šå½“ break è¯­å¥ç”¨äº while æˆ– for è¯­å¥æ—¶ï¼Œå¯¼è‡´é€€å‡ºç¨‹åºå¾ªç¯ continueï¼šå½“ continue è¯­å¥ç”¨äº while æˆ– for è¯­å¥æ—¶ï¼Œä½¿ç¨‹åºå¾ªç¯ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¿­ä»£ nextï¼šèƒ½èƒ½å¤Ÿå¯¼è‡´è¯»å…¥ä¸‹ä¸€ä¸ªè¾“å…¥è¡Œï¼Œå¹¶è¿”å›åˆ°è„šæœ¬çš„é¡¶éƒ¨ã€‚è¿™å¯ä»¥é¿å…å¯¹å½“å‰è¾“å…¥è¡Œæ‰§è¡Œå…¶ä»–çš„æ“ä½œè¿‡ç¨‹ exitï¼šè¯­å¥ä½¿ä¸»è¾“å…¥å¾ªç¯é€€å‡ºå¹¶å°†æ§åˆ¶è½¬ç§»åˆ°END,å¦‚æœENDå­˜åœ¨çš„è¯ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰ENDè§„åˆ™ï¼Œæˆ–åœ¨ENDä¸­åº”ç”¨exitè¯­å¥ï¼Œåˆ™ç»ˆæ­¢è„šæœ¬çš„æ‰§è¡Œ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/awk/7.awkæ•°ç»„.html":{"url":"linux/linuxå‘½ä»¤/awk/7.awkæ•°ç»„.html","title":"7.awkæ•°ç»„","keywords":"","body":"awkæ•°ç»„ 1.awkæ•°ç»„æ ¼å¼ æ•°ç»„å[ç´¢å¼•]=å€¼ 2.åˆ›å»ºawkæ•°ç»„ //åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„åæ˜¯aï¼Œæ•°ç»„çš„ç´¢å¼•æ˜¯\"aaa\"å’Œ\"bbb\" [root@test1 ~]# awk 'BEGIN{a[\"aaa\"]=\"www.aaa.com\";a[\"bbb\"]=\"www.bbb.com\"; print a[\"aaa\"] \"\\n\" a[\"bbb\"]}' www.aaa.com www.bbb.com 3.åˆ é™¤æ•°ç»„å…ƒç´  //ä½¿ç”¨delete æ•°ç»„å[ç´¢å¼•] åˆ é™¤æ•°ç»„å…ƒç´  [root@test1 ~]# awk 'BEGIN{a[\"aaa\"]=\"www.aaa.com\";a[\"bbb\"]=\"www.bbb.com\";delete a[\"aaa\"]; print a[\"aaa\"] \"\\n\" a[\"bbb\"]}' www.bbb.com 4.æŒ‰ç…§ç´¢å¼•éå† //ä»¥ä¸‹ç¤ºä¾‹äº†ä»¥ç»Ÿè®¡çš„å­—æ®µä¸ºæ•°ç»„çš„ç´¢å¼• [root@test1 ~]# awk -F: '{a[++i]=$1} END{print a[1]}' /etc/passwd root [root@test1 ~]# awk -F: '{a[i++]=$1} END{print a[1]}' /etc/passwd bin [root@test1 ~]# head -2 /etc/passwd root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin 5.awkæ•°ç»„ç¤ºä¾‹ 5.1ç®€å•ç¤ºä¾‹ 5.1.1ç»Ÿè®¡/etc/passwdä¸­å„ç§ç±»å‹shellçš„æ•°é‡ [root@test1 ~]# awk -F: '{a[$NF]++} END{for(i in a){print i,a[i]}}' /etc/passwd /bin/sync 1 /bin/bash 2 /sbin/nologin 22 /sbin/halt 1 /sbin/shutdown 1 5.1.2 80ç«¯å£è®¿é—®çŠ¶æ€ç»Ÿè®¡ [root@test1 ~]# ss -an|awk '/:80/{a[$2]++} END{for(i in a){print i,a[i]}}' LISTEN 3 5.2ç»“åˆæ—¥å¿—æ–‡ä»¶çš„ç¤ºä¾‹ nginxè®¿é—®æ—¥å¿—æ ¼å¼å¦‚ä¸‹ 82.113.63.230 - - [25/Jan/2019:15:15:56 +0800] \"GET / HTTP/1.1\" 301 169 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36\" \"-\" 5.2.1ç»Ÿè®¡2019å¹´1æœˆ25æ—¥å½“å¤©çš„PVé‡ [root@test1 ~]# awk '/25\\/Jan\\/2019/{i++}END{print i}' /var/log/nginx/access.log 90 5.2.2ç»Ÿè®¡15-19ç‚¹çš„PVé‡ [root@test1 ~]# awk '$4>=\"[25/Jan/2019:15:00:00\" && $4 5.2.3ç»Ÿè®¡2019å¹´1æœˆ25æ—¥å½“å¤©å†…è®¿é—®æœ€å¤šçš„10ä¸ªIP [root@test1 ~]# awk '/25\\/Jan\\/2019/ {a[$1]++} END {for(i in a){print i,a[i]}}' /var/log/nginx/access.log |sort -rn|head 5.2.4ç»Ÿè®¡2019å¹´1æœˆ25æ—¥15-19ç‚¹è®¿é—®æ¬¡æ•°æœ€å¤šçš„10ä¸ªIP [root@test1 ~]# awk '$4>=\"[25/Jan/2019:15:00:00\" && $4 5.2.5ç»Ÿè®¡2019å¹´1æœˆ25æ—¥è®¿é—®æ¬¡æ•°å¤§äº100çš„IP [root@test1 ~]# awk '/25\\/Jan\\/2019/ {a[$1]++} END {for(i in a){if(a[i]>10){print i,a[i]}}}' /var/log/nginx/access.log 5.2.6ç»Ÿè®¡2019å¹´1æœˆ25æ—¥è®¿é—®æœ€å¤šçš„10ä¸ªé¡µé¢($requests top 10) //nginxè®¿é—®æ—¥å¿—ä¸­ç¬¬7åˆ—æ˜¯è®¿é—®url [root@test1 ~]# awk '/25\\/Jan\\/2019/ {a[$7]++} END {for(i in a){print a[i],i}}' /var/log/nginx/access.log |sort -rn|head 5.2.7ç»Ÿè®¡æ¯ä¸ªIPè®¿é—®çŠ¶æ€ç çš„æ•°é‡ [root@test1 ~]# awk '{a[$1 \" \" $9]++} END {for(i in a){print a[i],i}}' /var/log/nginx/access.log|sort -rn|head 10 101.227.27.188 301 9 113.193.226.3 301 3 59.36.132.240 301 3 182.254.52.17 301 2 80.82.70.187 301 2 64.246.161.190 302 2 14.18.182.223 302 2 14.18.182.223 301 2 124.161.103.251 301 1 83.97.20.33 301 5.2.8ç»Ÿè®¡è®¿é—®çŠ¶æ€ç ä¸º404åŠå‡ºç°çš„æ¬¡æ•°($status) //ç»Ÿè®¡æŸä¸€å¤©çš„ [root@test1 ~]# awk '{if($9==\"404\") a[$9]++} END {for(i in a){print i,a[i]}}' /var/log/nginx/access.log //ç»Ÿè®¡æŸä¸€å¤©æŸä¸€æ—¶åˆ»çš„ [root@test1 ~]# awk '$4>=\"[25/Jan/2019:15:00:00\" && $4 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/awk/8.awkå‡½æ•°.html":{"url":"linux/linuxå‘½ä»¤/awk/8.awkå‡½æ•°.html","title":"8.awkå‡½æ•°","keywords":"","body":"awkå‡½æ•° 1.awkå†…ç½®å‡½æ•° 1.1 gsub 1.1.1è¯­æ³• gsub(/è¦æ›¿æ¢çš„å†…å®¹/,'æ›¿æ¢åçš„å†…å®¹',æ›¿æ¢å“ªä¸€åˆ—) 1.1.2ç¤ºä¾‹ //å°†/etc/passwdæ–‡ä»¶ä¸­rootä¸€è¡Œä¸­çš„å†’å·æ›¿æ¢ä¸ºåŠ å· [root@test1 ~]# awk '$1~/^root/{gsub(/:/,\"+\",$NF);print $0}' /etc/passwd root+x+0+0+root+/root+/bin/bash 1.2 substr 1.2.1è¯­æ³• substr(æŸä¸€åˆ—,ä»ç¬¬å‡ ä¸ªå­—ç¬¦å¼€å§‹,æˆªå–å‡ ä¸ªå­—ç¬¦ç»“æŸ) 1.2.2ç¤ºä¾‹ //ç®€å•ä½¿ç”¨ç¤ºä¾‹ [root@test1 ~]# echo 'abcdefg'|awk '{print substr($1,3,3)}' cde 1.3 split 1.3.1è¯­æ³• split(æŸä¸€åˆ—,æ•°ç»„å,/è¦æ›¿æ¢çš„å†…å®¹/) æŠŠæŸä¸€åˆ—é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åˆ‡å‰²ç„¶åæ”¾åˆ°æ•°ç»„ä¸­ 1.3.2ç¤ºä¾‹ [root@test1 ~]# echo GET /a/b/c/d/e.jpg|awk '{split($2,a,/\\./);print a[1]}' /a/b/c/d/e [root@test1 ~]# echo GET /a/b/c/d/e.jpg|awk '{split($2,a,/\\./);print a[2]}' jpg 1.4 system 1.3.1å«ä¹‰ awkè°ƒç”¨shellå‘½ä»¤ 1.3.2ç¤ºä¾‹ //âš ï¸å‘½ä»¤å¤–å¿…é¡»ç”¨åŒå¼•å·åŒ…è£¹ awk 'BEGIN{system(\"ls\")}' 2.awkè‡ªå®šä¹‰å‡½æ•° //ç¼–è¾‘awkæ–‡ä»¶function.awk cat >function.awk æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/grepå‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/grepå‘½ä»¤.html","title":"grepå‘½ä»¤","keywords":"","body":"grepå‘½ä»¤ 1.æ­£åˆ™è¡¨è¾¾å¼ 1.1åŸºæœ¬æ­£åˆ™è¡¨è¾¾å¼ 1.2æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ 1.3ç‰¹æ®Šå­—å­—ç¬¦ç±» [:alnum:] [a-zA-Z0-9]åŒ¹é…äººä¸€ä¸ªå­—æ¯æˆ–æ•°å­—å­—ç¬¦ [:alpha:] åŒ¹é…ä»»æ„ä¸€ä¸ªå­—æ¯ï¼ˆåŒ…æ‹¬å¤§å°å†™ï¼‰ [:digit:] åŒ¹é…ä»»æ„ä¸€ä¸ªæ•°å­— [:lower:] åŒ¹é…å°å†™å­—æ¯ [:upper:] åŒ¹é…å¤§å†™å­—æ¯ [:punct:] åŒ¹é…æ ‡ç‚¹ç¬¦å· [:blank:] åŒ¹é…ç©ºæ ¼ä¸åˆ¶è¡¨ç¬¦ [:space:] åŒ¹é…ä¸€ä¸ªåŒ…æ‹¬æ¢è¡Œç¬¦ã€å›è½¦ç­‰åœ¨å†…çš„æ‰€æœ‰ç©ºç™½å­—ç¬¦ [:graph:] åŒ¹é…ä»»æ„å¯çœ‹çš„è§çš„ä¸”å¯æ‰“å°çš„å­—ç¬¦ [:print:] åŒ¹é…ä»»ä½•ä¸€ä¸ªå¯ä»¥æ‰“å°çš„å­—ç¬¦ [:xdigit:] åŒ¹é…ä»»æ„ä¸€ä¸ª16è¿›åˆ¶æ•°ï¼ˆ0-9ï¼Œa-fï¼ŒA-Fï¼‰ 2.grepå‘½ä»¤ 2.1å‘½ä»¤è¯´æ˜ Linuxç³»ç»Ÿä¸­grepå‘½ä»¤æ˜¯ä¸€ç§å¼ºå¤§çš„æ–‡æœ¬æœç´¢å·¥å…·ï¼Œå®ƒèƒ½ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æœç´¢æ–‡æœ¬ï¼Œå¹¶æŠŠåŒ¹é…çš„è¡Œæ‰“å°å‡ºæ¥ã€‚grepå…¨ç§°æ˜¯Global Regular Expression Printï¼Œè¡¨ç¤ºå…¨å±€æ­£åˆ™è¡¨è¾¾å¼ç‰ˆæœ¬ï¼Œå®ƒçš„ä½¿ç”¨æƒé™æ˜¯æ‰€æœ‰ç”¨æˆ· 2.2å‘½ä»¤æ ¼å¼ grep [options] file 2.3é€‰é¡¹ -E å¦‚æœåŠ è¿™ä¸ªé€‰é¡¹ï¼Œé‚£ä¹ˆåé¢çš„åŒ¹é…æ¨¡å¼å°±æ˜¯æ‰©å±•çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯ grep -E = egrep -i æ¯”è¾ƒå­—ç¬¦æ—¶å¿½ç•¥å¤§å°å†™åŒºåˆ« -l è¿‡æ»¤çš„æ—¶å€™åªæ˜¾ç¤ºæ–‡ä»¶å æ‰¾å‡ºåŒ…å«sshdçš„æ–‡ä»¶ -w æŠŠè¡¨è¾¾å¼ä½œä¸ºè¯æ¥æŸ¥æ‰¾ï¼Œç›¸å½“äºæ­£åˆ™ä¸­çš„\"\\\"(...è¡¨ç¤ºä½ è‡ªå®šä¹‰çš„è§„åˆ™) -x è¢«åŒ¹é…åˆ°çš„å†…å®¹ï¼Œæ­£å¥½æ˜¯æ•´ä¸ªè¡Œï¼Œç›¸å½“äºæ­£åˆ™\"^...$\" -v å–å -c countï¼Œç»Ÿè®¡ï¼Œç»Ÿè®¡åŒ¹é…ç»“æœçš„è¡Œæ•°ï¼Œä¸æ˜¯åŒ¹é…ç»“æœçš„æ¬¡æ•°ï¼Œæ˜¯è¡Œæ•° -m åªåŒ¹é…è§„å®šçš„è¡Œæ•°ï¼Œä¹‹åçš„å†…å®¹å°±ä¸å†åŒ¹é…äº† -n åœ¨è¾“å‡ºçš„ç»“æœé‡Œæ˜¾ç¤ºè¡Œå·ï¼Œè¿™é‡Œçš„è¡Œå·æ˜¯è¯¥è¡Œå†…å®¹åœ¨åŸæ–‡ä»¶ä¸­çš„è¡Œå·ï¼Œè€Œä¸æ˜¯åœ¨è¾“å‡ºç»“æœä¸­è¡Œå· -o åªæ˜¾ç¤ºåŒ¹é…å†…å®¹ï¼Œgrep é»˜è®¤æ˜¯æ˜¾ç¤ºæ»¡è¶³åŒ¹é…æ¡ä»¶çš„ä¸€è¡Œï¼ŒåŠ ä¸Šè¿™ä¸ªå‚æ•°å°±åªæ˜¾ç¤ºåŒ¹é…ç»“æœï¼Œæ¯”å¦‚æˆ‘ä»¬è¦åŒ¹é…ä¸€ä¸ª ip åœ°å€ï¼Œå°±åªéœ€è¦ç»“æœï¼Œè€Œä¸éœ€è¦è¯¥è¡Œçš„å†…å®¹ -R é€’å½’åŒ¹é…ã€‚å¦‚æœè¦åœ¨ä¸€ä¸ªç›®å½•ä¸­å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½•åŒ¹é…å†…å®¹ï¼Œåˆ™éœ€è¦è¿™ä¸ªå‚æ•° -B è¾“å‡ºæ»¡è¶³æ¡ä»¶è¡Œçš„å‰å‡ è¡Œï¼Œæ¯”å¦‚ grep -B 3 \"aa\" file è¡¨ç¤ºåœ¨ file ä¸­è¾“å‡ºæœ‰ aa çš„è¡Œï¼ŒåŒæ—¶è¿˜è¦è¾“å‡º aa çš„å‰ 3 è¡Œ -A è¿™ä¸ªä¸-B ç±»ä¼¼ï¼Œè¾“å‡ºæ»¡è¶³æ¡ä»¶è¡Œçš„åå‡ è¡Œ -C è¿™ä¸ªç›¸å½“äºåŒæ—¶ç”¨-B -Aï¼Œä¹Ÿå°±æ˜¯å‰åéƒ½è¾“å‡º -P æ”¯æŒperlæ­£åˆ™ 2.4grepæ‰©å±•ç”¨æ³• 2.4.1æ‰©å±•ç”¨æ³•1 grepåå‘å¼•ç”¨ ç¤ºä¾‹ï¼šå°†æ–‡æœ¬ä¸­è¿ç»­ç›¸åŒçš„æ•°å­—æ‰“å°å‡ºæ¥ ()è¡¨ç¤ºåŒ¹é…çš„å†…å®¹,å½“å‰ä¸ºåŒ¹é…æ•°å­—,\\1ä¸ºåå‘å¼•ç”¨, echo '1222233333222444455556666669999'|egrep -o '([0-9])\\1+' å‘½ä»¤åè¾¹å¦‚æœå†™+å°±ä¼šæ— æ³•æˆªå–1,å› ä¸º1åªæœ‰ä¸€ä¸ª æ­¤æ—¶å°±éœ€è¦åœ¨åè¾¹å†å•ç‹¬åŒ¹é…æ•°å­—1 echo '1222233333222444455556666669999'|egrep -o '([0-9])\\1+|[0-9]' å¦å¤–ä¸¤ç§å†™æ³• echo '1222233333222444455556666669999'|egrep -o '([0-9])\\1*' echo '1222233333222444455556666669999'|egrep -o '(.)\\1*' 2.4.2æ‰©å±•ç”¨æ³•2 grep -Pä¸é›¶å®½æ–­è¨€åŒ¹é… é›¶å®½æ–­è¨€:perlè¯­è¨€æ­£åˆ™åŒ¹é… æ ¸å¿ƒ:æˆªå–ç‰¹å®šå­—ç¬¦ä¸²å·¦è¾¹æˆ–å³è¾¹çš„å†…å®¹ æˆªå–stringå³è¾¹çš„å†…å®¹ lookahead (?=string) æˆªå–stringå·¦è¾¹çš„å†…å®¹ lookbehind (? é›¶å®½æ–­è¨€æˆªå–å­—ç¬¦ä¸² ç¤ºä¾‹1:å–å‡ºæ–‡ä»¶ä¸­:å³è¾¹çš„å†…å®¹ //æ–‡ä»¶å†…å®¹å¦‚ä¸‹,ç°åœ¨è¦æˆªå–å‡º:å³è¾¹çš„æ•°å­— [root@exercise2 ~]# cat a.txt id:01 id:02 id:03 id:04 id:05 id:06 id:07 id:08 id:09 id:10 666 test666 æ–¹æ³•: grep -Po \"(? ç¤ºä¾‹2:æˆªå–IPåœ°å€ [root@7-test1 ~]# ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:0c:29:93:32:b9 brd ff:ff:ff:ff:ff:ff inet 10.0.0.200/24 brd 10.0.0.255 scope global noprefixroute eth0 valid_lft forever preferred_lft forever inet6 fe80::19ee:50ab:53fc:55f9/64 scope link noprefixroute valid_lft forever preferred_lft forever ()ä¸­æœ‰å°äºå·,è¡¨æ˜è¦æˆªå–å­—ç¬¦ä¸²å³è¾¹çš„å†…å®¹ [root@7-test1 ~]# ip a s eth0 | grep -Po '(? æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå‘½ä»¤/sedå‘½ä»¤.html":{"url":"linux/linuxå‘½ä»¤/sedå‘½ä»¤.html","title":"sedå‘½ä»¤","keywords":"","body":"sedå‘½ä»¤ 1.sedå‘½ä»¤å·¥ä½œæµç¨‹ 1ã€å°†æ–‡ä»¶çš„ç¬¬ä¸€è¡Œè¯»å…¥åˆ°è‡ªå·±çš„ç¼“å­˜ç©ºé—´ï¼Œåˆ é™¤æ¢è¡Œç¬¦ 2ã€åŒ¹é…ï¼Œçœ‹ä¸€ä¸‹è¯¥è¡Œæ˜¯å¦ä¸ºè¦ç¼–è¾‘çš„è¡Œï¼Œå¦‚æœæ˜¯ï¼Œæ‰§è¡Œç¼–è¾‘å‘½ä»¤ï¼Œä¸æ˜¯ï¼Œæ‰§è¡Œ1 3ã€æ‰§è¡Œç¼–è¾‘å‘½ä»¤ 4ã€åŠ ä¸Šæ¢è¡Œç¬¦è¾“å‡ºåˆ°å±å¹• 5ã€åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶å°¾ï¼Œå¦‚æœæ˜¯ï¼Œé€€å‡ºï¼Œä¸æ˜¯ï¼Œå†é‡å¤1-4 é»˜è®¤æƒ…å†µä¸‹ï¼Œsedç¼“å­˜ç©ºé—´å†…çš„è¡Œéƒ½ä¼šè¾“å‡ºåˆ°å±å¹•ï¼Œé™¤éä½¿ç”¨-né€‰é¡¹ é»˜è®¤æƒ…å†µä¸‹ï¼Œsedå°†ä¿®æ”¹çš„è¡Œè¾“å‡ºåˆ°å±å¹•ï¼Œå¹¶æ²¡æœ‰ä¿®æ”¹æºæ–‡ä»¶ï¼Œä½¿ç”¨-ié€‰é¡¹ä¿®æ”¹æºæ–‡ä»¶ 2.å‘½ä»¤æ ¼å¼ sed é€‰é¡¹ åœ°å€1,åœ°å€2 å‘½ä»¤ æ ‡è®° æ–‡ä»¶å 3.é€‰é¡¹ é€‰é¡¹ å«ä¹‰ -n æ‹Ÿåˆ¶è¾“å‡ºï¼Œä¸è¾“å‡ºæœªä¿®æ”¹çš„è¡Œï¼Œå¼ºåˆ¶è¾“å‡ºç”¨å‘½ä»¤p -i ä¿®æ”¹æºæ–‡ä»¶ï¼Œéœ€è¦å¼ºåˆ¶å¤‡ä»½æºæ–‡ä»¶ -i.bakå³å¯ -r è®©sedæ”¯æŒæ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ï¼Œé»˜è®¤æ”¯æŒæ ‡å‡†æ­£åˆ™è¡¨è¾¾å¼ -f æŒ‡å®šæ–‡ä»¶ï¼Œå°†sedå‘½ä»¤å†™åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶åæ‰§è¡Œsed -f æ–‡ä»¶å è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼Œä½†æ˜¯ä»æœªæˆåŠŸæ‰§è¡Œè¿‡ï¼ï¼ï¼ -e å…è®¸ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤šä¸ªsedå­å‘½ä»¤ sed -e â€˜s#a#b#gâ€™ -e â€˜s#A#B#gâ€™ 3.1å®šä½ã€åŒ¹é… 3.1.1ä½¿ç”¨è¡Œå· å®šä½1-5è¡Œ 1,5 å®šä½åˆ°æœ€åä¸€è¡Œ $ æŒ‡å®šèµ·å§‹åŒ¹é…è¡Œå’Œæ­¥é•¿ 1~5(ä»ç¬¬ä¸€è¡Œå¼€å§‹ï¼Œæ¯éš”5è¡ŒåŒ¹é…) å®šä½å¥‡æ•°è¡Œ 1ï½2 å®šä½å¶æ•°è¡Œ 0ï½2 å®šä½æŸè¡Œä¹‹åçš„nè¡Œ 1,+3 3.1.2ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ /æ­£åˆ™è¡¨è¾¾å¼/ 4.å‘½ä»¤ å‘½ä»¤ å«ä¹‰ a\\ åœ¨å½“å‰è¡Œåæ·»åŠ ä¸€è¡Œæˆ–å¤šè¡Œ c\\ ç”¨æ–°æ–‡æœ¬ä¿®æ”¹ï¼ˆæ›¿æ¢ï¼‰å½“å‰è¡Œä¸­çš„æ–‡æœ¬ d åˆ é™¤è¡Œ i\\ åœ¨å½“å‰è¡Œä¹‹å‰æ’å…¥æ–‡æœ¬ h æŠŠæ¨¡å¼ç©ºé—´é‡Œçš„å†…å®¹å¤åˆ¶åˆ°æš‚å­˜ç¼“å­˜åŒº H æŠŠæ¨¡å¼ç©ºé—´é‡Œçš„å†…å®¹è¿½åŠ åˆ°æš‚å­˜ç¼“å­˜åŒº g å–å‡ºæš‚å­˜ç¼“å†²åŒºé‡Œçš„å†…å®¹ï¼Œå°†å…¶å¤åˆ¶åˆ°æ¨¡å¼ç©ºé—´ï¼Œè¦†ç›–è¯¥å¤„åŸæœ‰å†…å®¹ G å–å‡ºæš‚å­˜ç¼“å†²åŒºé‡Œçš„å†…å®¹ï¼Œå°†å…¶å¤åˆ¶åˆ°æ¨¡å¼ç©ºé—´ï¼Œè¿½åŠ åœ¨åŸæœ‰å†…å®¹åé¢ l åˆ—å‡ºéæ‰“å°å­—ç¬¦ p æ‰“å°è¡Œ n è¯»å…¥ä¸‹ä¸€è¾“å…¥è¡Œï¼Œå¹¶ä»ä¸‹ä¸€æ¡å‘½ä»¤è€Œä¸æ˜¯ç¬¬ä¸€æ¡å‘½ä»¤å¼€å§‹å¤„ç† q ç»“æŸæˆ–é€€å‡ºsed r ä»æ–‡ä»¶ä¸­è¯»å–è¾“å…¥è¡Œ ! å¯¹æ‰€é€‰è¡Œä¹‹å¤–çš„æ‰€æœ‰è¡Œåº”ç”¨å‘½ä»¤ s ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²æ›¿æ¢å¦ä¸€ä¸ª 4.1 p æ‰“å° æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 ä¾‹ï¼šæ‰“å°ç¬¬1è¡Œ [root@test1 ~]# sed -n '1p' hehe 123456 æ–‡ä»¶å†…å®¹ [root@test1 test]# cat hehe.txt 1 101,hehe,CEO 2 102,haha,CTO 3 103,xixi,COO 4 104,yy,CFO 5 105,xx,CIO 6 110,jjxx,COCO ä¾‹ï¼šæ‰“å°ä»101å¼€å§‹åˆ°105ç»“æŸçš„è¡Œ [root@test1 test]# sed -n '/101/,/105/p' hehe.txt 1 101,hehe,CEO 2 102,haha,CTO 3 103,xixi,COO 4 104,yy,CFO 5 105,xx,CIO ä¾‹ï¼šæ‰“å°ä»101å¼€å§‹åˆ°ç¬¬3è¡Œ [root@test1 test]# sed -n '/101/,3p' hehe.txt 1 101,hehe,CEO 2 102,haha,CTO 3 103,xixi,COO 4.2 d åˆ é™¤ å‘½ä»¤dç”¨äºåˆ é™¤è¾“å…¥è¡Œ sed å…ˆå°†è¾“å…¥è¡Œä»æ–‡ä»¶å¤åˆ¶åˆ°æ¨¡å¼ç¼“å­˜åŒºï¼Œç„¶åå¯¹è¯¥è¡Œæ‰§è¡Œsedå‘½ä»¤ï¼Œæœ€åå°†æ¨¡å¼ç¼“å­˜åŒºçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Š å¦‚æœå‘å‡ºçš„æ˜¯å‘½ä»¤dï¼Œå½“å‰æ¨¡å¼ç¼“å­˜åŒºçš„è¾“å…¥è¡Œä¼šè¢«åˆ é™¤ï¼Œä¸è¢«æ˜¾ç¤º æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 ä¾‹ï¼šå°†æœ‰1çš„è¡Œåˆ é™¤ [root@test1 ~]# sed '/1/d' hehe abcdef (abc)def 2 222222 ä¾‹ï¼šå°†æ–‡ä»¶çš„1åˆ°3è¡Œåˆ é™¤ [root@test1 ~]# sed '1,3d' hehe (abc)def 2 222222 æ–‡ä»¶å†…å®¹ [root@test1 test]# cat 111.txt 101,aaa,CEO 102,bbb,CTO 103,ccc,COO 104,ddd,CFO 105,eee,CIO 110,fff,COCO ä¾‹ï¼šå°†æ–‡ä»¶çš„ç¬¬1è¡Œåˆ°ç¬¬5è¡Œåˆ é™¤ [root@test1 test]# sed '1,5d' 111.txt 110,fff,COCO ä¾‹ï¼šå°†æ–‡ä»¶ä»dddåˆ°æ–‡ä»¶ç»“å°¾åˆ é™¤ [root@test1 test]# sed '/ddd/,$d' 111.txt 101,aaa,CEO 102,bbb,CTO 103,ccc,COO ä¾‹ï¼šåˆ é™¤ä¸åŒ…å«fffçš„è¡Œ [root@test1 test]# sed '/fff/!d' 111.txt 110,fff,COCO 4.3 s æ›¿æ¢ æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 ä¾‹ï¼šå°†æ–‡ä»¶ä¸­çš„1å…¨éƒ¨æ›¿æ¢ä¸º? [root@test1 ~]# sed 's/1/?/g' hehe ?23456 ?????? abcdef (abc)def 2 222222 ä¾‹ï¼šå°†abcdefæ›¿æ¢ä¸ºabchehe, \\1è¡¨ç¤ºåŒ¹é…çš„abc [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 [root@test1 ~]# sed -r 's/(abc)def/\\1hehe/' hehe \\1è¡¨ç¤ºå‰è¾¹åŒ¹é…çš„abc 123456 111111 abchehe (abc)def 2 222222 4.4 é€—å· æŒ‡å®šè¡Œçš„èŒƒå›´ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 111 ä¾‹ï¼šåŒ¹é…111111åˆ°222222ä¹‹é—´çš„è¡Œ [root@test1 ~]# sed -n '/111111/,/222222/p' hehe 111111 abcdef (abc)def 222222 ä¾‹ï¼šåŒ¹é…ä»ç¬¬5è¡Œå¼€å§‹ï¼Œåˆ°ç¬¬ä¸€ä¸ªä»¥2å¼€å¤´ä¹‹é—´çš„è¡Œ [root@test1 ~]# sed -n '5,/2/p' hehe 111111 abcdef (abc)def 2 ä¾‹ï¼šåŒ¹é…111111æ‰€åœ¨è¡Œåˆ°ä»¥2å¼€å¤´çš„è¡Œ [root@test1 ~]# sed -n '/111111/,/2/p' hehe 111111 abcdef (abc)def 2 ä¾‹ï¼šåŒ¹é…ä»111111å¼€å§‹åˆ°ç¬¬ä¸€ä¸ªä»¥2å¼€å¤´çš„è¡Œï¼Œç„¶åå°†ä»¥1å¼€å¤´çš„è¡Œæ›¿æ¢ä¸ºhehe [root@test1 ~]# sed -n '/111111/,/2/s/^1/hehe/p' hehe hehe11111 4.5 e å¤šé‡ç¼–è¾‘ -eå‘½ä»¤æ˜¯ç¼–è¾‘å‘½ä»¤ï¼Œç”¨äºsedæ‰§è¡Œå¤šä¸ªç¼–è¾‘ä»»åŠ¡çš„æƒ…å†µä¸‹ åœ¨ä¸‹ä¸€è¡Œå¼€å§‹ç¼–è¾‘å‰ï¼Œæ‰€æœ‰çš„ç¼–è¾‘åŠ¨ä½œå°†åº”ç”¨åˆ°æ¨¡å¼ç¼“å­˜åŒºçš„è¡Œä¸Š [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 ä¾‹ï¼šå°†ç¬¬ä¸€è¡Œåˆ é™¤ï¼Œå¹¶ä¸”æ›¿æ¢abcä¸ºABC [root@test1 ~]# sed -e '1d' -e 's#abc#ABC#g' hehe 111111 ABCdef (ABC)def 2 222222 4.6 a è¿½åŠ  æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 111 ä¾‹ï¼šåœ¨ä»¥2å¼€å¤´çš„è¡Œåè¿½åŠ HEHE [root@test1 ~]# sed '/^2/aHEHE' hehe 123456 111111 abcdef (abc)def 2 HEHE 222222 HEHE 111 4.7 i æ’å…¥ iå‘½ä»¤æ˜¯æ’å…¥å‘½ä»¤ï¼Œç±»ä¼¼äºaå‘½ä»¤ï¼Œä½†ä¸æ˜¯åœ¨å½“å‰è¡Œåå¢åŠ æ–‡æœ¬ï¼Œè€Œæ˜¯åœ¨å½“å‰è¡Œå‰é¢æ’å…¥æ–°çš„æ–‡æœ¬ï¼Œå³åˆšè¯»å…¥ç¼“å­˜åŒºæ¨¡å¼çš„è¡Œ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 111 ä¾‹ï¼šåœ¨ä»¥2å¼€å¤´çš„è¡Œå‰è¾¹æ’å…¥HEHE [root@test1 ~]# sed '/^2/iHEHE' hehe 123456 111111 abcdef (abc)def HEHE 2 HEHE 222222 111 4.8 c ä¿®æ”¹ cå‘½ä»¤æ˜¯ä¿®æ”¹å‘½ä»¤,sed ä½¿ç”¨è¯¥å‘½ä»¤å°†å·²æœ‰çš„æ–‡æœ¬ä¿®æ”¹æˆæ–°çš„æ–‡æœ¬,æ—§æ–‡æœ¬è¢«è¦†ç›– æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 111 ä¾‹ï¼šå°†æ–‡ä»¶ä¸­abcdefæ›¿æ¢ä¸ºABCDEF [root@test1 ~]# sed '/abcdef/cABCDEF' hehe 123456 111111 ABCDEF (abc)def 2 222222 111 4.9 n è·å–ä¸‹ä¸€è¡Œ nå‘½ä»¤è¡¨ç¤ºä¸‹ä¸€æ¡å‘½ä»¤ï¼Œsed ä½¿ç”¨è¯¥å‘½ä»¤è·å–è¾“å…¥æ–‡ä»¶çš„ä¸‹ä¸€è¡Œï¼Œå¹¶å°†å…¶è¯»å…¥åˆ°æ¨¡å¼ç¼“å†²åŒºä¸­ï¼Œä»»ä½• sed å‘½ä»¤éƒ½å°†åº”ç”¨åˆ°åŒ¹é…è¡Œï¼Œå³ç´§æ¥ç€çš„ä¸‹ä¸€è¡Œä¸Š æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 111 ä¾‹ï¼šåŒ¹é…111111ä¸€è¡Œï¼Œnè¡¨ç¤ºè·å–ä¸‹ä¸€è¡Œï¼Œå³abcdef,å¹¶ä¸”æ›¿æ¢eä¸ºE [root@test1 ~]# sed '/111111/{n;s/e/E/;}' hehe 123456 111111 abcdEf (abc)def 2 222222 111 4.10 y è½¬æ¢ yå‘½ä»¤è¡¨ç¤ºè½¬æ¢ï¼Œè¯¥å‘½ä»¤ä¸ tr å‘½ä»¤ç›¸ä¼¼ï¼Œå­—ç¬¦æŒ‰ç…§ä¸€å¯¹ä¸€çš„æ–¹å¼ä»å·¦åˆ°å³è¿›è¡Œè½¬æ¢ ä¾‹å¦‚ y/abc/ABC/ï¼Œä¼šæŠŠå°å†™å­—æ¯è½¬æ¢æˆå¤§å†™å­—æ¯ï¼Œa-->A,b-->B,c-->Cï¼Œä¸sä¸åŒçš„æ˜¯ï¼Œyä¼šå…¨éƒ¨æ›¿æ¢ï¼Œè€Œséœ€è¦åœ¨æœ€ååŠ g æ–‡ä»¶å†…å®¹ [root@test1 ~]# cat hehe 123456 111111 abcdef (abc)def 2 222222 111 ä¾‹ï¼šå°†1-3è¡Œçš„1è½¬æ¢ä¸ºQ [root@test1 ~]# sed '1,3y/1/Q/' hehe Q23456 QQQQQQ abcdef (abc)def 2 222222 111 5.å®é™…ä½¿ç”¨ç¤ºä¾‹ 5.1ç¤ºä¾‹1 ä½¿ç”¨sedå‘½ä»¤å°†/etc/passwdæ–‡ä»¶ä¸­çº¢ç”¨æˆ·åå’Œç™»é™†shellè°ƒæ¢ä½ç½® æ€è·¯ï¼šå°†é…ç½®æ–‡ä»¶åˆ†ç»„ï¼Œç”¨æˆ·åä¸ºç¬¬ä¸€ç»„ï¼Œæœ€åçš„ç™»é™†shellåˆ†ä¸ºä¸€ç»„ï¼Œç„¶åä¸­é—´çš„å†…å®¹åˆ†ä¸ºä¸€ç»„ï¼Œå› æ­¤ hehe æ˜¯ç¬¬ä¸€ç»„ 501:501::/home/hehe: æ˜¯ç¬¬äºŒç»„ /bin/bash æ˜¯ç¬¬ä¸‰ç»„ [root@test1 ~]# tail -1 /etc/passwd hehe:x:500:500::/home/hehe:/bin/bash [root@test1 ~]# tail -1 /etc/passwd |sed -r 's#(.*)(:x.*:)(/.*)#\\3\\2\\1#g' /bin/bash:x:500:500::/home/hehe:hehe 5.2ç¤ºä¾‹2 ç”¨sedå‘½ä»¤å–å‡ºipåœ°å€ [root@test1 ~]# ifconfig eth0|sed -nr '2s#(.*:)(.*)(B.*)#\\2#gp' 192.168.1.8 5.3ç¤ºä¾‹3 å°†ä»¥ä¸‹æ–‡ä»¶è¿›è¡Œæ‰¹é‡éœ€æ”¹ï¼ˆç”¨ä¸€æ¡å‘½ä»¤å®Œæˆï¼‰ ä¿®æ”¹å‰1.sh 2.sh 3.sh ä¿®æ”¹å1_test.sh 2_test.sh 3_test.sh ls *.sh|sed -nr 's#((.*)\\.sh)#mv \\1 \\2_test.sh#gp' |bash æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/1.dockerç®€ä»‹.html":{"url":"linux/docker/1.dockerç®€ä»‹.html","title":"1.dockerç®€ä»‹","keywords":"","body":"dockerç®€ä»‹ ä¸€ã€ä»€ä¹ˆæ˜¯Docker Dockeræ˜¯åŸºäºgoè¯­è¨€å®ç°çš„å¼€æºå®¹å™¨é¡¹ç›®ï¼Œè¯ç”Ÿäº2013å¹´å¹´åˆï¼Œæœ€åˆå‘èµ·è€…æ˜¯dotCloudå…¬å¸ï¼Œ2013å¹´å¹´åº•æ”¹ä¸ºDocker Inc dockerå®˜ç½‘ 1.1ä»€ä¹ˆæ˜¯å®¹å™¨ å®¹å™¨å°±æ˜¯åœ¨éš”ç¦»çš„ç¯å¢ƒè¿è¡Œçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œå¦‚æœè¿›ç¨‹åœæ­¢ï¼Œå®¹å™¨å°±ä¼šé”€æ¯ï¼Œéš”ç¦»ç¯å¢ƒæ‹¥æœ‰è‡ªå·±çš„ç³»ç»Ÿæ–‡ä»¶ã€ipåœ°å€ã€ä¸»æœºå 1.2dockerå®¹å™¨ dockeræ˜¯é€šè¿‡å†…æ ¸è™šæ‹ŸåŒ–æŠ€æœ¯ namespaces:æä¾›å®¹å™¨èµ„æºéš”ç¦» cgroups:èµ„æºé™åˆ¶ dockeré€šè¿‡æ“ä½œç³»ç»Ÿå±‚çš„è™šæ‹ŸåŒ–å®ç°éš”ç¦»ï¼Œä¸éœ€è¦ç±»ä¼¼è™šæ‹Ÿæœºé¢å¤–çš„æ“ä½œç³»ç»Ÿå¼€é”€ï¼Œæé«˜äº†èµ„æºåˆ©ç”¨ç‡ ä¼˜ç‚¹ï¼š 1.åˆ›å»ºåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºï¼Œå¿«é€Ÿåˆ†å‘å’Œéƒ¨ç½² 2.è¿ç§»æ€§å¥½ï¼Œé€šè¿‡å®¹å™¨æ¥æ‰“åŒ…åº”ç”¨ã€è§£è€¦åº”ç”¨å’Œè¿è¡Œå¹³å° 3.é€Ÿåº¦å¿«ï¼Œå®ç°æœåŠ¡ç§’å¯åŠ¨ï¼Œå ç”¨ç³»ç»Ÿèµ„æºå°‘ ç¼ºç‚¹ï¼š 1.dockeræœ¬è´¨æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå¦‚æœå ç”¨èµ„æºè¿‡å¤šï¼Œä¼šè§¦å‘ oomæœºåˆ¶ oom==out of memory å®¹å™¨çš„å¯åŠ¨ ç¯å¢ƒéš”ç¦» å…±ç”¨å®¿ä¸»æœºçš„å†…æ ¸ï¼šå¯åŠ¨è¿›ç¨‹ äºŒã€Dockeræ ¸å¿ƒæ¦‚å¿µ 2.1ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ 2.1.1 é•œåƒ Dockeré•œåƒæ˜¯åˆ›å»ºDockerå®¹å™¨çš„åŸºç¡€ï¼Œé•œåƒæœ¬èº«åªè¯»ï¼Œä¸€ä¸ªé•œåƒåŒ…å«ä¸€ä¸ªåŸºæœ¬çš„æ“ä½œç³»ç»Ÿç¯å¢ƒï¼Œé‡Œé¢ä»…å®‰è£…äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚å®‰è£…äº†apacheåº”ç”¨ç¨‹åºï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸ºapacheé•œåƒ 2.1.2 å®¹å™¨ Dockerå®¹å™¨æ˜¯ä»é•œåƒåˆ›å»ºçš„åº”ç”¨è¿è¡Œå®ä¾‹ï¼Œå®ƒå¯ä»¥å¯åŠ¨ã€å¼€å§‹ã€åœæ­¢ã€åˆ é™¤ï¼Œè¿™äº›å®¹å™¨å½¼æ­¤ç›¸äº’éš”ç¦»ã€äº’ä¸å¯è§ å¯ä»¥æŠŠå®¹å™¨çœ‹ä½œæ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆlinuxç³»ç»Ÿç¯å¢ƒ(åŒ…æ‹¬rootç”¨æˆ·æƒé™ã€è¿›ç¨‹ç©ºé—´ã€ç”¨æˆ·ç©ºé—´ã€ç½‘ç»œç©ºé—´)ä»¥åŠè¿è¡Œåœ¨å…¶ä¸­çš„åº”ç”¨ç¨‹åºæ‰“åŒ…è€Œæˆçš„ç›’å­ 2.1.3 ä»“åº“ Dockerä»“åº“æ˜¯é›†ä¸­å­˜æ”¾é•œåƒæ–‡ä»¶çš„åœºæ‰€ ä»“åº“æ³¨å†ŒæœåŠ¡å™¨å­˜æ”¾å¤šä¸ªä»“åº“ï¼Œæ¯ä¸ªä»“åº“é›†ä¸­å­˜æ”¾æŸä¸€ç±»é•œåƒï¼ŒåŒ…æ‹¬å¤šä¸ªé•œåƒæ–‡ä»¶ï¼Œé€šè¿‡ä¸åŒæ ‡ç­¾æ¥è¿›è¡ŒåŒºåˆ† Dockerä»“åº“åˆ†ä¸ºå…¬å¼€ä»“åº“å’Œç§æœ‰ä»“åº“ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/2.CentOS7.5å®‰è£…docker.html":{"url":"linux/docker/2.CentOS7.5å®‰è£…docker.html","title":"2.dockerå®‰è£…","keywords":"","body":"CentOS7.5å®‰è£…docker ä¸€ã€å®‰è£…dockeræœ€æ–°ç‰ˆ 1.1 ä¸‹è½½yumæº #å®˜æ–¹yumæº yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo #é˜¿é‡Œäº‘yumæº yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo #æ¸…åyumæº yum-config-manager --add-repo https://mirrors4.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo 1.2 å®‰è£…dockeræœ€æ–°ç‰ˆ yum -y install docker-ce 1.3 å¯åŠ¨docker systemctl start docker && systemctl enable docker 1.4 æŸ¥çœ‹dockerç‰ˆæœ¬ [root@docker01 ~]# docker version Client: Version: 18.09.1 API version: 1.39 Go version: go1.10.6 Git commit: 4c52b90 Built: Wed Jan 9 19:35:01 2019 OS/Arch: linux/amd64 Experimental: false Server: Docker Engine - Community Engine: Version: 18.09.1 API version: 1.39 (minimum version 1.12) Go version: go1.10.6 Git commit: 4c52b90 Built: Wed Jan 9 19:06:30 2019 OS/Arch: linux/amd64 Experimental: false 1.5 é…ç½®dockeré•œåƒåŠ é€Ÿ #é…ç½®dockerå®˜æ–¹é•œåƒåŠ é€Ÿåœ°å€ æ–¹å¼ä¸€ [root@docker01 ~]# cat > /etc/docker/daemon.json /etc/docker/daemon.json 1.6 åˆ›å»ºå¹¶è¿è¡Œç¬¬ä¸€ä¸ªå®¹å™¨ [root@docker01 ~]# docker run -d -p 80:80 nginx Unable to find image 'nginx:latest' locally latest: Pulling from library/nginx 6ae821421a7d: Pull complete da4474e5966c: Pull complete eb2aec2b9c9f: Pull complete Digest: sha256:dd2d0ac3fff2f007d99e033b64854be0941e19a2ad51f174d9240dda20d9f534 Status: Downloaded newer image for nginx:latest 6cd3a11bda37336b8d6f0ba3e266e697945f72d520bbd0225a6e93818c8d581d äºŒã€å®‰è£…dockeræŒ‡å®šç‰ˆæœ¬ 2.1 ä¸‹è½½yumæº #å®˜æ–¹yumæº yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo #é˜¿é‡Œäº‘yumæº yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo #æ¸…åyumæº yum-config-manager --add-repo https://mirrors4.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo 2.2 æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ [root@docker01 ~]# yum list docker-ce --showduplicates | sort -r å·²åŠ è½½æ’ä»¶ï¼šfastestmirror, langpacks å¯å®‰è£…çš„è½¯ä»¶åŒ… * webtatic: uk.repo.webtatic.com * updates: mirrors.aliyun.com Loading mirror speeds from cached hostfile * extras: mirrors.aliyun.com docker-ce.x86_64 3:19.03.3-3.el7 docker-ce-stable docker-ce.x86_64 3:19.03.2-3.el7 docker-ce-stable docker-ce.x86_64 3:19.03.1-3.el7 docker-ce-stable docker-ce.x86_64 3:19.03.0-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.9-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.8-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.7-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.6-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.5-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.4-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.3-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.2-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.1-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.0-3.el7 docker-ce-stable docker-ce.x86_64 18.06.3.ce-3.el7 docker-ce-stable docker-ce.x86_64 18.06.2.ce-3.el7 docker-ce-stable docker-ce.x86_64 18.06.1.ce-3.el7 docker-ce-stable docker-ce.x86_64 18.06.0.ce-3.el7 docker-ce-stable docker-ce.x86_64 18.03.1.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 18.03.0.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.12.1.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.12.0.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.09.1.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.09.0.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.06.2.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.06.1.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.06.0.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.03.3.ce-1.el7 docker-ce-stable docker-ce.x86_64 17.03.2.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.03.1.ce-1.el7.centos docker-ce-stable docker-ce.x86_64 17.03.0.ce-1.el7.centos docker-ce-stable 2.3 å®‰è£…dockeræŒ‡å®šç‰ˆæœ¬ #å®‰è£…æŒ‡å®šç‰ˆæœ¬ [root@docker01 ~]# yum -y install docker-ce-18.03.1.ce docker-ce-cli-18.01.1.ce 2.4 æŸ¥çœ‹ç‰ˆæœ¬ #æŸ¥çœ‹dockerç‰ˆæœ¬ [root@docker01 ~]# docker -v Docker version 18.03.1-ce, build 9ee9f40 2.5 é…ç½®dockeré•œåƒåŠ é€Ÿ #é…ç½®dockerå®˜æ–¹é•œåƒåŠ é€Ÿåœ°å€ æ–¹å¼ä¸€ [root@docker01 ~]# cat > /etc/docker/daemon.json /etc/docker/daemon.json ä¸‰ã€äºŒè¿›åˆ¶å®‰è£…docker ç³»ç»Ÿç¯å¢ƒ å†…æ ¸ç‰ˆæœ¬ å†…å­˜ dockerç‰ˆæœ¬ 3.10.0-1062.el7.x86_64 1c2G 18.09.9 dockeräºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ 3.1 ä¸‹è½½dockeräºŒè¿›åˆ¶åŒ… wget https://download.docker.com/linux/static/stable/x86_64/docker-18.09.9.tgz 3.2 è§£å‹ç¼©åŒ… tar xf docker-18.09.9.tgz -C /usr/local/ 3.3 å¯¼å‡ºç¯å¢ƒå˜é‡ âš ï¸å¦‚æœåç»­æƒ³è¦ä½¿ç”¨systemdç®¡ç†dockerï¼Œæœ€å¥½æŠŠdockeräºŒè¿›åˆ¶åŒ…ä¸­çš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°/usr/binï¼Œå¦åˆ™ä¼šç®¡ç†å¤±è´¥ cp /usr/local/docker/* /usr/bin 3.4 ä½¿ç”¨systemdç®¡ç†docker Control Docker with systemd å®˜æ–¹æ–‡æ¡£å…³äºä½¿ç”¨systemdç®¡ç†dockerçš„è¯´æ˜ å¦‚æœä½ æ˜¯ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼å®‰è£…çš„ dockerï¼Œé‚£ä¹ˆä½ ä¹Ÿè®¸éœ€è¦æ•´åˆ docker åˆ° systemd ä¸­å»ã€‚ä¸ºäº†å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œä½ éœ€è¦å®‰è£…ä¸¤ä¸ªå•å…ƒæ–‡ä»¶ï¼ˆservice å’Œ socketï¼‰åˆ° /etc/systemd/system ä¸­å» Manually create the systemd unit files When installing the binary without a package, you may want to integrate Docker with systemd. For this, install the two unit files (service and socket) from the github repository to /etc/systemd/system. âš ï¸éœ€è¦ä¸‹è½½çš„æ˜¯docker.service.rpmå’Œdocker.socketè¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œéœ€è¦æŠŠdocker.service.rpmé‡å‘½åä¸ºdocker.serviceï¼Œç„¶åå†ç§»åŠ¨åˆ°/etc/systemd/systemä¸‹ wget https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.service.rpm wget https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.socket è¿™é‡Œæˆ‘ä»¬ç›´æ¥å‘æ–‡ä»¶å†™å…¥å†…å®¹ docker.service cat > /etc/systemd/system/docker.service docker.socket cat >/etc/systemd/system/docker.socket 3.5 é‡æ–°åŠ è½½æœåŠ¡å¹¶å¯åŠ¨docker systemctl daemon-reload systemctl start docker && systemctl enable docker 3.6 éªŒè¯dockerç‰ˆæœ¬ $ docker version Client: Docker Engine - Community Version: 18.09.9 API version: 1.39 Go version: go1.11.13 Git commit: 039a7df9ba Built: Wed Sep 4 16:50:02 2019 OS/Arch: linux/amd64 Experimental: false Server: Docker Engine - Community Engine: Version: 18.09.9 API version: 1.39 (minimum version 1.12) Go version: go1.11.13 Git commit: 039a7df9ba Built: Wed Sep 4 16:55:50 2019 OS/Arch: linux/amd64 Experimental: false æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/3.dockerå®¹å™¨æ“ä½œ.html":{"url":"linux/docker/3.dockerå®¹å™¨æ“ä½œ.html","title":"3.dockerå®¹å™¨æ“ä½œ","keywords":"","body":"dockerå®¹å™¨æ“ä½œ 1.dockerè¿è¡Œå®¹å™¨ 1.1dockeråå°è¿è¡Œå®¹å™¨ //dockerè¿è¡Œä¸€ä¸ªå®¹å™¨ [root@docker01 ~]# docker run -d -p 80:80 nginx Unable to find image 'nginx:latest' locally latest: Pulling from library/nginx 6ae821421a7d: Pull complete da4474e5966c: Pull complete eb2aec2b9c9f: Pull complete Digest: sha256:dd2d0ac3fff2f007d99e033b64854be0941e19a2ad51f174d9240dda20d9f534 #å‚æ•°è¯´æ˜ run åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå®¹å™¨ -d åå°è¿è¡Œ -p ç«¯å£æ˜ å°„ å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ nginx dockeré•œåƒåç§° //è®¿é—®å®¹å™¨ è®¿é—®å®¿ä¸»æœºIP:80ç«¯å£ 1.2dockeräº¤äº’å¼è¿è¡Œå®¹å™¨ //dockeräº¤äº’å¼è¿è¡Œå®¹å™¨ [root@docker1 ~]# docker run -it --name nginx nginx /bin/bash root@07c25f8aa98b:/# #å‚æ•°shuoming -it åˆ†é…äº¤äº’å¼ç»ˆç«¯ --name æŒ‡å®šå®¹å™¨çš„åå­— /bin/bash è¦†ç›–å®¹å™¨çš„åˆå§‹å‘½ä»¤ ç¬¬ä¸€ä¸ªnginx å®¹å™¨åç§° ç¬¬äºŒä¸ªnginx é•œåƒåç§° 2.dockeråœæ­¢å®¹å™¨ å‘½ä»¤ï¼šdocker stop å®¹å™¨IDæˆ–å®¹å™¨åç§° //æŸ¥çœ‹å®¹å™¨ï¼Œæ­¤æ—¶nginxå®¹å™¨æ­£åœ¨è¿è¡Œ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e5008e3abc3c nginx \"nginx -g 'daemon ofâ€¦\" 8 seconds ago Up 7 seconds 0.0.0.0:80->80/tcp elated_hermann //åœæ­¢å®¹å™¨ï¼Œåœæ­¢å®¹å™¨å¯ä»¥åŠ å®¹å™¨çš„IDæˆ–è€…å®¹å™¨åå­— [root@docker1 ~]# docker stop e5008e3abc3c e5008e3abc3c //å†æ¬¡æŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ°å®¹å™¨å·²ç»åœæ­¢ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e5008e3abc3c nginx \"nginx -g 'daemon ofâ€¦\" About a minute ago Exited (0) 2 seconds ago elated_hermann 3.dockerè¿›å…¥å®¹å™¨ 3.1dockerè¿›å…¥å®¹å™¨æ–¹æ³• ç›®çš„ dockerè¿›å…¥å®¹å™¨ï¼ˆä¸ºäº†è°ƒè¯•ã€æ’é”™ï¼‰ æ–¹æ³• docker exec -it å®¹å™¨IDæˆ–å®¹å™¨åç§° /bin/bash #ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„ç»ˆç«¯tty docker attach #ä½¿ç”¨åŒä¸€ä¸ªç»ˆç«¯ nsenter ç”¨çš„å°‘ #éœ€è¦å®‰è£…util-linux 3.2ç¤ºä¾‹ execè¿›å…¥å®¹å™¨ //è¿è¡Œä¸€ä¸ªå®¹å™¨ [root@docker1 ~]# docker run -d nginx 47a36ef42fb743a4c28ac8d3c82cfa1947698c7c0a74a5ccb59815b959cb7a48 //æŸ¥çœ‹å®¹å™¨ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 47a36ef42fb7 nginx \"nginx -g 'daemon ofâ€¦\" 8 seconds ago Up 7 seconds 80/tcp zen_spence //æ ¹æ®å®¹å™¨IDè¿›å…¥å®¹å™¨ [root@docker1 ~]# docker exec -it 47a36ef42fb7 /bin/bash root@47a36ef42fb7:/# cat /etc/issue Debian GNU/Linux 9 \\n \\l //æ˜¾ç¤ºå®¹å™¨è¯¦ç»†ä¿¡æ¯ [root@docker1 ~]# docker ps --no-trunc CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 47a36ef42fb743a4c28ac8d3c82cfa1947698c7c0a74a5ccb59815b959cb7a48 nginx \"nginx -g 'daemon off;'\" 5 minutes ago Up 5 minutes 80/tcp zen_spence 4.dockeré€€å‡ºå®¹å™¨ 4.1dockeré€€å‡ºå®¹å™¨ï¼Œå®¹å™¨ä¸è¿è¡Œ æ–¹æ³• exit ctrl+d //å¯åŠ¨ä¸€ä¸ªå®¹å™¨ [root@docker1 ~]# docker run -it --name centos6.9 centos:6.9 /bin/bash //exité€€å‡ºå®¹å™¨ [root@7076abed1c74 /]# exit exit //æŸ¥çœ‹å®¹å™¨ï¼Œå®¹å™¨æ­¤æ—¶å·²ç»åœæ­¢ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 7076abed1c74 centos:6.9 \"/bin/bash\" 11 seconds ago Exited (0) 1 second ago centos6.9 4.2ä¸´æ—¶é€€å‡ºå®¹å™¨,å®¹å™¨ä¾ç„¶è¿è¡Œ æ–¹æ³• ctrl+p ç„¶å ctrl+q âš ï¸âš ï¸âš ï¸docker attachè¿›å…¥å®¹å™¨ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªç»ˆç«¯ï¼Œå†æ¬¡æ‰“å¼€ä¸€ä¸ªç»ˆç«¯,ä¸¤ä¸ªç»ˆç«¯çš„æ“ä½œæ˜¯åŒæ—¶è¿›è¡Œçš„ æœ€å¥½ä½¿ç”¨execè¿›å…¥å®¹å™¨ //å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œç„¶åä¸´æ—¶é€€å‡º [root@docker1 ~]# docker run -it --name centos6.9 centos:6.9 /bin/bash [root@50492b58763a /]# [root@docker1 ~]# //æŸ¥çœ‹å®¹å™¨ï¼Œå®¹å™¨æ­¤æ—¶æ²¡æœ‰é€€å‡º [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 50492b58763a centos:6.9 \"/bin/bash\" 3 minutes ago Up 3 minutes centos6.9 //å†æ¬¡è¿›å…¥åˆšæ‰ä¸´æ—¶é€€å‡ºçš„å®¹å™¨ï¼Œå¯ä»¥ç”¨attachæˆ–è€…exec [root@docker1 ~]# docker attach 50492b58763a [root@50492b58763a /]# [root@docker1 ~]# docker exec -it 50492b58763a /bin/bash [root@50492b58763a /]# 5.dockerå¤¯ä½å®¹å™¨ dockerå®¹å™¨å†…çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹å¿…é¡»ä¸€ç›´å¤„äºå‰å°è¿è¡Œçš„çŠ¶æ€ï¼Œå¿…é¡»å¤¯ä½ï¼Œå¦åˆ™è¿™ä¸ªå®¹å™¨å°±å¤„äºé€€å‡ºçŠ¶æ€ dockerå®¹å™¨åªèƒ½æ‰§è¡Œä¸€æ¡åˆå§‹å‘½ä»¤ ç¤ºä¾‹1 //å¯åŠ¨ä¸€ä¸ªnginxå®¹å™¨ [root@docker01 ~]# docker run -d -p 80:80 nginx //æŸ¥çœ‹nginxå®¹å™¨è¯¦ç»†ä¿¡æ¯ [root@docker1 ~]# docker ps --no-trunc CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 47a36ef42fb743a4c28ac8d3c82cfa1947698c7c0a74a5ccb59815b959cb7a48 nginx \"nginx -g 'daemon off;'\" 5 minutes ago Up 5 minutes 80/tcp zen_spence å¯ä»¥çœ‹åˆ°nginxå®¹å™¨å¯åŠ¨çš„å‘½ä»¤\"nginx -g 'daemon off;'\" è¡¨ç¤ºnginxåœ¨å‰å°è¿è¡Œ ç¤ºä¾‹2 //åå°å¯åŠ¨centoså®¹å™¨ [root@docker1 ~]# docker run -d centos:6.9 e1fab2c0c3a5df84fa812d475b5f9ed27b31f928aad8874319671cd9ad792e20 //æŸ¥çœ‹å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨ç¬¬ä¸€ä¸ªè¿›ç¨‹æ²¡æœ‰å¤¯ä½ï¼Œå·²ç»é€€å‡º [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e1fab2c0c3a5 centos:6.9 \"/bin/bash\" 4 seconds ago Exited (0) 4 seconds ago upbeat_dirac //è¦æƒ³å¤¯ä½å®¹å™¨ï¼Œå¿…é¡»åŠ ä¸€ä¸ªèƒ½å¤¯ä½çš„å‘½ä»¤ï¼Œä¾‹å¦‚viä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œtail -F ä¸€ä¸ªæ–‡ä»¶ #æ–¹å¼ä¸€ [root@docker1 ~]# docker run -d centos:6.9 vi 123.txt dcc90f30af539cf2c14748c22cd4815a26283d2cdd5bd8d4a0aece8d9c1a8e84 [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES dcc90f30af53 centos:6.9 \"vi 123.txt\" 2 seconds ago Up 2 seconds frosty_mirzakhani #æ–¹å¼äºŒ [root@docker1 ~]# docker run -d centos:6.9 tail -F /var/log/messages ddc401b2bba8347b8b257f224e4c6a35798d9b6e08986f71201d3473d82a0ff0 [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ddc401b2bba8 centos:6.9 \"tail -F /var/log/meâ€¦\" 3 seconds ago Up 2 seconds heuristic_gauss tail -F å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿèƒ½å¤¯ä½ -f å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šé€€å‡º 6.dockeråˆ é™¤å®¹å™¨ 6.1dockeræ¸©æŸ”åˆ é™¤å®¹å™¨ å‘½ä»¤ docker rm å®¹å™¨IDæˆ–è€…å®¹å™¨åç§° //æŸ¥çœ‹dockerå®¹å™¨ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 9fcda2502aa5 centos:6.9 \"/bin/bash\" 13 seconds ago Exited (0) 8 seconds ago centos6.9 e5008e3abc3c nginx \"nginx -g 'daemon ofâ€¦\" 6 minutes ago Exited (0) 4 minutes ago elated_hermann //åˆ é™¤å®¹å™¨ï¼Œå¯ä»¥åŠ å®¹å™¨çš„IDæˆ–è€…åç§° [root@docker1 ~]# docker rm centos6.9 centos6.9 //å†æ¬¡æŸ¥çœ‹å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°åç§°ä¸ºcentos6.9çš„å®¹å™¨å·²ç»åˆ é™¤ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e5008e3abc3c nginx \"nginx -g 'daemon ofâ€¦\" 10 minutes ago Exited (0) 8 minutes ago elated_hermann 6.2dockerå¼ºåˆ¶åˆ é™¤å®¹å™¨ æœ€å¥½ä¸è¦å¼ºåˆ¶åˆ é™¤å®¹å™¨ï¼ï¼ï¼ å‘½ä»¤ docker rm -f å®¹å™¨IDæˆ–å®¹å™¨åç§° //è¿è¡Œä¸€ä¸ªå®¹å™¨ [root@docker1 ~]# docker run -d nginx:latest e57f21e6917bc109fb13afbe7e9237b13a3741f0fd1b4971afaa31fdfdcaec6a //æŸ¥çœ‹å®¹å™¨ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e57f21e6917b nginx:latest \"nginx -g 'daemon ofâ€¦\" 9 seconds ago Up 7 seconds 80/tcp stoic_leakey e5008e3abc3c nginx \"nginx -g 'daemon ofâ€¦\" 16 minutes ago Exited (0) 15 minutes ago elated_hermann //å°è¯•åˆ é™¤æ­£åœ¨è¿è¡Œçš„å®¹å™¨,ä¼šæŠ¥é”™ [root@docker1 ~]# docker rm e57f21e6917b Error response from daemon: You cannot remove a running container e57f21e6917bc109fb13afbe7e9237b13a3741f0fd1b4971afaa31fdfdcaec6a. Stop the container before attempting removal or force remove //åŠ -få‚æ•°å¼ºåˆ¶åˆ é™¤ [root@docker1 ~]# docker rm -f e57f21e6917b e57f21e6917b //å†æ¬¡æŸ¥çœ‹å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°å®¹å™¨å·²ç»è¢«åˆ é™¤ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e5008e3abc3c nginx \"nginx -g 'daemon ofâ€¦\" 19 minutes ago Exited (0) 17 minutes ago elated_hermann æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/4.1registryç§æœ‰ä»“åº“.html":{"url":"linux/docker/4.1registryç§æœ‰ä»“åº“.html","title":"registry","keywords":"","body":"registryç§æœ‰ä»“åº“ dockerç§æœ‰ä»“åº“registryåªéœ€è¦å¯åŠ¨ä¸€ä¸ªå®¹å™¨å³å¯ è¯•éªŒç¯å¢ƒ docker01 10.0.0.10 docker02 10.0.0.11 ä¸€ã€æ™®é€šregistry 1.1docker01å¯åŠ¨ç§æœ‰ä»“åº“å®¹å™¨ [root@docker01 ~]# docker run -d -p 5000:5000 --restart=always --name registry -v \\ /opt/myregistry:/var/lib/registry registry å‚æ•°è§£é‡Š -d åå°è¿è¡Œ -p æ˜ å°„ç«¯å£ --restart=always é‡å¯dockeræœåŠ¡æ—¶æ‹‰èµ·å®¹å™¨ --name åå­— -v æŒ‚è½½å·ï¼Œ /opt/myregistry:/var/lib/registryè¡¨ç¤ºå°†å®¿ä¸»æœºçš„/opt/myregistryæŒ‚è½½åˆ°å®¹å™¨çš„/var/lib/registry 1.2docker02ç»™é•œåƒæ‰“æ ‡ç­¾ 1.åˆå§‹é•œåƒ [root@docker02 ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE centos 6.9 adf829198a7f 4 months ago 195MB 2.ç»™é•œåƒæ‰“æ ‡ç­¾ è¯­æ³• docker tag é•œåƒåç§° æ ‡ç­¾åç§° [root@docker02 ~]# docker tag centos:6.9 10.0.0.10:5000/centos:6.9 3.æ‰“å®Œæ ‡ç­¾åçš„é•œåƒï¼Œidç›¸åŒï¼Œç›¸å½“äºç¡¬é“¾æ¥ [root@docker02 ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE 10.0.0.10:5000/centos 6.9 adf829198a7f 4 months ago 195MB centos 6.9 adf829198a7f 4 months ago 195MB 1.3docker02æ¨é€é•œåƒåˆ°ç§æœ‰ä»“åº“docker01 1.é»˜è®¤æ¨é€æ˜¯é‡‡ç”¨httpsåè®®ï¼Œå› æ­¤ç¬¬ä¸€æ¬¡æ¨é€ä¼šæŠ¥é”™ [root@docker02 ~]# docker push 10.0.0.10:5000/centos:6.9 The push refers to repository [10.0.0.10:5000/centos] Get https://10.0.0.10:5000/v2/: http: server gave HTTP response to HTTPS client 2.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä½¿æ¨é€ä½¿ç”¨httpåè®® [root@docker02 ~]# vim /etc/docker/daemon.json { \"insecure-registries\": [\"10.0.0.10:5000\"] } 3.é‡å¯docker [root@docker02 ~]# systemctl restart docker 4.å†æ¬¡æ¨é€å³å¯æˆåŠŸ [root@docker02 ~]# docker push 10.0.0.10:5000/centos:6.9 The push refers to repository [10.0.0.20:5000/centos] aaa5621d7c01: Pushed 6.9: digest: sha256:7e172600dff1903f186061ce5f5295664ec9942ca120e4e5b427ddf01bb2b35b size: 529 1.4docker æ™®é€šregistryç¼ºç‚¹ æ²¡æœ‰è®¤è¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥æ¨é€é•œåƒåˆ°ç§æœ‰ä»“åº“ï¼Œä¸å®‰å…¨ï¼ï¼ï¼ 1.docker02å¯¼å…¥é•œåƒæˆ–è€…ä¸‹è½½é•œåƒ [root@docker02 ~]# docker load -i nginx.tar.gz 2.ç»™é•œåƒæ‰“æ ‡ç­¾ [root@docker02 ~]# docker tag nginx:latest 10.0.0.10:5000/nginx:latest 3.æ¨é€ä»»æ„ä¸€ä¸ªé•œåƒåˆ°ç§æœ‰ä»“åº“ [root@docker02 ~]# docker push 10.0.0.10:5000/nginx:latest 4.æ¨é€é•œåƒå­˜æ”¾è·¯å¾„ åˆ›å»ºç§æœ‰é•œåƒä»“åº“æ—¶æŒ‡å®šçš„å®¿ä¸»æœºç›®å½•/opt/myregistry -v /opt/myregistry:/var/lib/registry registry [root@docker01 ~]# ls /opt/myregistry/docker/registry/v2/repositories/ centos/ centos6.9_ssh/ nginx/ äºŒã€å¸¦basicè®¤è¯çš„registry 2.1docker01åˆå§‹ç¯å¢ƒå‡†å¤‡ 1.å®‰è£…httpd-tools [root@docker01 ~]# yum -y install httpd-tools 2.åˆ›å»ºå­˜æ”¾å¯†ç çš„ç›®å½•å¹¶è®¾ç½®å¯†ç  [root@docker01 ~]# mkdir -p /opt/registry-var/auth [root@docker01 ~]# htpasswd -Bbn test 123456 >> /opt/registry-var/auth/htpasswd 2.2docker01å¯åŠ¨å®¹å™¨ [root@docker01 ~]# docker run -d -p 5000:5000 --name registry --restart=always -v /opt/registry-var/auth/:/auth/ -v \\ /opt/myregistry:/var/lib/registry -e \"REGISTRY_AUTH=htpasswd\" -e \\ \"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm\" -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd\\ registry 2.3docker02ç›´æ¥æ‹‰å–é•œåƒ 1.ç›´æ¥æ‹‰å–é•œåƒä¼šæŠ¥é”™ï¼Œå› ä¸ºæ²¡æœ‰è®¤è¯ [root@docker02 ~]# docker pull 10.0.0.10:5000/nginx Using default tag: latest Error response from daemon: Get http://10.0.0.10:5000/v2/nginx/manifests/latest: no basic auth credentials 2.4ç™»é™†ç§æœ‰ä»“åº“ï¼Œç„¶åæ‹‰å–é•œåƒ 1.ç™»é™†ç§æœ‰ä»“åº“ [root@docker02 ~]# docker login 10.0.0.10:5000 Username: test Password: WARNING! Your password will be stored unencrypted in /root/.docker/config.json. Configure a credential helper to remove this warning. See https://docs.docker.com/engine/reference/commandline/login/#credentials-store Login Succeeded 2.æ‹‰å–é•œåƒ [root@docker02 ~]# docker pull 10.0.0.10:5000/nginx Using default tag: latest latest: Pulling from nginx Digest: sha256:278fefc722ffe1c36f6dd64052758258d441dcdb5e1bbbed0670485af2413c9f Status: Image is up to date for 10.0.0.10:5000/nginx:latest 3.ä¸Šä¼ é•œåƒï¼Œå…ˆæ‰“æ ‡ç­¾ï¼Œå†ä¸Šä¼  [root@docker02 ~]# docker tag centos:6.9 10.0.0.10:5000/my-centos [root@docker02 ~]# docker push 10.0.0.10:5000/my-centos registryé•œåƒå­˜å‚¨ä½ç½® registryé•œåƒå­˜å‚¨ä½ç½®ä¸º æŒ‚è½½ç›®å½•/docker/registry/v2/repositories/é•œåƒåç§° ç›®å½•æŒ‚è½½ /opt/myregistry:/var/lib/registry é•œåƒå­˜å‚¨ä½ç½® /opt/myregistry/docker/registry/v2/repositories æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/4.2dockerä¼ä¸šçº§ç§æœ‰ä»“åº“harbor.html":{"url":"linux/docker/4.2dockerä¼ä¸šçº§ç§æœ‰ä»“åº“harbor.html","title":"harbor","keywords":"","body":"dockerä¼ä¸šçº§ç§æœ‰ä»“åº“harbor 1.harborä»‹ç» Haboræ˜¯ç”±VMWareå…¬å¸å¼€æºçš„å®¹å™¨é•œåƒä»“åº“ã€‚äº‹å®ä¸Šï¼ŒHaboræ˜¯åœ¨Docker Registryä¸Šè¿›è¡Œäº†ç›¸åº”çš„ä¼ä¸šçº§æ‰©å±•ï¼Œä»è€Œè·å¾—äº†æ›´åŠ å¹¿æ³›çš„åº”ç”¨ï¼Œè¿™äº›æ–°çš„ä¼ä¸šçº§ç‰¹æ€§åŒ…æ‹¬ï¼šç®¡ç†ç”¨æˆ·ç•Œé¢ï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ ï¼ŒAD/LDAPé›†æˆä»¥åŠå®¡è®¡æ—¥å¿—ç­‰ï¼Œè¶³ä»¥æ»¡è¶³åŸºæœ¬ä¼ä¸šéœ€æ±‚ã€‚ å®˜æ–¹åœ°å€ githubåœ°å€ 2.harborä¸»è¦åŠŸèƒ½ åŸºäºè§’è‰²è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ åœ¨ä¼ä¸šä¸­ï¼Œé€šå¸¸æœ‰ä¸åŒçš„å¼€å‘å›¢é˜Ÿè´Ÿè´£ä¸åŒçš„é¡¹ç›®ï¼Œé•œåƒåƒä»£ç ä¸€æ ·ï¼Œæ¯ä¸ªäººè§’è‰²ä¸åŒéœ€æ±‚ä¹Ÿä¸åŒï¼Œå› æ­¤å°±éœ€è¦è®¿é—®æƒé™æ§åˆ¶ï¼Œæ ¹æ®è§’è‰²åˆ†é…ç›¸åº”çš„æƒé™ã€‚ ä¾‹å¦‚ï¼Œå¼€å‘äººå‘˜éœ€è¦å¯¹é¡¹ç›®æ„å»ºè¿™å°±ç”¨åˆ°è¯»å†™æƒé™ï¼ˆpush/pullï¼‰ï¼Œæµ‹è¯•äººå‘˜åªéœ€è¦è¯»æƒé™ï¼ˆpullï¼‰ï¼Œè¿ç»´ä¸€èˆ¬ç®¡ç†é•œåƒä»“åº“ï¼Œå…·å¤‡æƒé™åˆ†é…èƒ½åŠ›ï¼Œé¡¹ç›®ç»ç†å…·æœ‰æ‰€æœ‰æƒé™ã€‚ é•œåƒå¤åˆ¶ å¯ä»¥å°†ä»“åº“ä¸­çš„é•œåƒåŒæ­¥åˆ°è¿œç¨‹çš„Harborï¼Œç±»ä¼¼äºMySQLä¸»ä»åŒæ­¥åŠŸèƒ½ã€‚ LDAP Harboræ”¯æŒLDAPè®¤è¯ï¼Œå¯ä»¥å¾ˆè½»æ˜“æ¥å…¥å·²æœ‰çš„LDAPã€‚ é•œåƒåˆ é™¤å’Œç©ºé—´å›æ”¶ Harboræ”¯æŒåœ¨Webåˆ é™¤é•œåƒï¼Œå›æ”¶æ— ç”¨çš„é•œåƒï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚ å›¾å½¢é¡µé¢ç®¡ç† ç”¨æˆ·å¾ˆæ–¹é¢æœç´¢é•œåƒåŠé¡¹ç›®ç®¡ç†ã€‚ å®¡è®¡ å¯¹ä»“åº“çš„æ‰€æœ‰æ“ä½œéƒ½æœ‰è®°å½•ã€‚ REST API å®Œæ•´çš„APIï¼Œæ–¹ä¾¿ä¸å¤–éƒ¨é›†æˆã€‚ 3.harborç»„ä»¶ ç»„ä»¶ åŠŸèƒ½ harbor-adminserver é…ç½®ç®¡ç†ä¸­å¿ƒ harbor-db Mysqlæ•°æ®åº“ harbor-jobservice è´Ÿè´£é•œåƒå¤åˆ¶ harbor-log è®°å½•æ“ä½œæ—¥å¿— harbor-ui Webç®¡ç†é¡µé¢å’ŒAPI nginx å‰ç«¯ä»£ç†ï¼Œè´Ÿè´£å‰ç«¯é¡µé¢å’Œé•œåƒä¸Šä¼ /ä¸‹è½½è½¬å‘ redis ä¼šè¯ registry é•œåƒå­˜å‚¨ 4.harboréƒ¨ç½²ç¯å¢ƒè¦æ±‚ 2æ ¸4G+40Gç¡¬ç›˜ docker 17.06+ docker compose 1.18+ openssl æœ€æ–°ç‰ˆ Hardware Resource Capacity Description CPU minimal 2CPU 4 CPU is preferred Mem minimal 4GB 8GB is preferred Disk minimal 40GB 160GB is preferred Software Software Version Description Docker engine version 17.06.0-ce+ or higher For installation instructions, please refer to: docker engine doc Docker Compose version 1.18.0 or higher For installation instructions, please refer to: docker compose doc Openssl latest is preferred Generate certificate and keys for Harbor Network ports Port Protocol Description 443 HTTPS Harbor portal and core API will accept requests on this port for https protocol, this port can change in config file(harborå…¥å£å’Œæ ¸å¿ƒAPIå°†æ¥å—è¯·æ±‚åœ¨æ­¤ç«¯å£ä¸Šçš„httpsåè®®ï¼Œè¯¥ç«¯å£å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æ›´æ”¹) 4443 HTTPS Connections to the Docker Content Trust service for Harbor, only needed when Notary is enabled, This port can change in config file(è¿æ¥åˆ°Dockerå†…å®¹ä¿¡ä»»æœåŠ¡çš„ç«¯å£ï¼Œåªæœ‰åœ¨å¯ç”¨å…¬è¯å‘˜æ—¶æ‰éœ€è¦ï¼Œè¯¥ç«¯å£å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æ›´æ”¹) 80 HTTP Harbor portal and core API will accept requests on this port for http protocol(Harbor portalå’Œcore APIå°†åœ¨è¿™ä¸ªç«¯å£ä¸Šæ¥å—httpåè®®è¯·æ±‚) 5.å®‰è£…docker compose harboréœ€è¦docker compose1.18+ç‰ˆæœ¬ docker composeå®‰è£…åœ°å€ 1.ä¸‹è½½docker composeå®‰è£…åŒ… [root@docker02 ~]# curl -L \"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose 2.ç»™docker composeèµ‹äºˆæ‰§è¡Œå‘½ä»¤ [root@docker02 ~]# chmod +x /usr/local/bin/docker-compose 3.éªŒè¯å®‰è£… [root@docker02 ~]# docker-compose -v docker-compose version 1.24.1, build 4667896b 6.å®‰è£…harbor Harborå®‰è£…æœ‰3ç§æ–¹å¼ï¼š åœ¨çº¿å®‰è£…ï¼šä»Docker Hubä¸‹è½½Harborç›¸å…³é•œåƒï¼Œå› æ­¤å®‰è£…è½¯ä»¶åŒ…éå¸¸å° ç¦»çº¿å®‰è£…ï¼šå®‰è£…åŒ…åŒ…å«éƒ¨ç½²çš„ç›¸å…³é•œåƒï¼Œå› æ­¤å®‰è£…åŒ…æ¯”è¾ƒå¤§ OVAå®‰è£…ç¨‹åºï¼šå½“ç”¨æˆ·å…·æœ‰vCenterç¯å¢ƒæ—¶ï¼Œä½¿ç”¨æ­¤å®‰è£…ç¨‹åºï¼Œåœ¨éƒ¨ç½²OVAåå¯åŠ¨Harbor 1.ä¸‹è½½å®‰è£…åŒ… [root@docker02 ~]# wget https://storage.googleapis.com/harbor-releases/release-1.8.0/harbor-offline-installer-v1.8.1.tgz 2.è§£å‹ç¼©åŒ…åˆ°/usr/local [root@docker02 ~]# tar xf harbor-offline-installer-v1.8.1.tgz -C /usr/local/ 3.è¿›å…¥harborç›®å½•ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶harbor.yml [root@docker02 harbor]# ls harbor.v1.8.1.tar.gz harbor.yml install.sh LICENSE prepare [root@docker02 harbor]# pwd /usr/local/harbor [root@docker02 harbor]# vim harbor.yml 5è¡Œ hostname: reg.mydomain.com //ä¿®æ”¹ä¸ºIPåœ°å€æˆ–è€…åŸŸå 27è¡Œ harbor_admin_password: Harbor12345 //ä¿®æ”¹å¯†ç  4.å‡†å¤‡é…ç½®æ–‡ä»¶ï¼Œæ‰§è¡Œå®Œæˆåä¼šå¤šå‡ºç›®å½•common æ–‡ä»¶docker-compose.yml [root@docker02 harbor]# ./prepare [root@docker02 harbor]# ls common docker-compose.yml harbor.v1.8.1.tar.gz harbor.yml install.sh LICENSE prepare 5.å®‰è£…å¹¶å¯åŠ¨harbor [root@docker02 harbor]# ./install.sh 6.æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ [root@docker02 harbor]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES d0d76fee6c95 goharbor/nginx-photon:v1.8.1 \"nginx -g 'daemon ofâ€¦\" 4 minutes ago Up 4 minutes (healthy) 0.0.0.0:80->80/tcp nginx 6b40878a29a0 goharbor/harbor-jobservice:v1.8.1 \"/harbor/start.sh\" 4 minutes ago Up 4 minutes harbor-jobservice ad03c4b60343 goharbor/harbor-portal:v1.8.1 \"nginx -g 'daemon ofâ€¦\" 4 minutes ago Up 4 minutes (healthy) 80/tcp harbor-portal 2fa3bbc7c1fb goharbor/harbor-core:v1.8.1 \"/harbor/start.sh\" 4 minutes ago Up 4 minutes (healthy) harbor-core cd9e038ab419 goharbor/harbor-registryctl:v1.8.1 \"/harbor/start.sh\" 4 minutes ago Up 4 minutes (healthy) registryctl 2738dc4ca7ab goharbor/redis-photon:v1.8.1 \"docker-entrypoint.sâ€¦\" 4 minutes ago Up 4 minutes 6379/tcp redis 457e7efc19c9 goharbor/registry-photon:v2.7.1-patch-2819-v1.8.1 \"/entrypoint.sh /etcâ€¦\" 4 minutes ago Up 4 minutes (healthy) 5000/tcp registry 37403c4806b4 goharbor/harbor-db:v1.8.1 \"/entrypoint.sh postâ€¦\" 4 minutes ago Up 4 minutes (healthy) 5432/tcp harbor-db 90ca1cc8b794 goharbor/harbor-log:v1.8.1 7.è®¿é—®harbor ç”¨æˆ·å admin å¯†ç  123456 å®¿ä¸»æœº80ç«¯å£ ç™»é™†åé¦–ç•Œé¢ åˆ°æ­¤ï¼Œharbor httpæ–¹å¼å®‰è£…å®Œæˆï¼ï¼ï¼ 8.httpsè®¿é—®harbor å¦‚æœéœ€è¦httpsè®¿é—®harborï¼Œéœ€è¦åšä»¥ä¸‹æ“ä½œ harbor httpså®˜æ–¹æ–‡æ¡£ ç¼–è¾‘harbor.ymlï¼Œæ‰“å¼€httpsé¡¹çš„æ³¨é‡Šï¼Œå¹¶ä¸”å†™ä¸Šhttpsè¯ä¹¦çš„ä½ç½® https: # # https port for harbor, default is 443 port: 443 # # The path of cert and key files for nginx certificate: /etc/nginx/ssl_key/harbor/xxx.pem private_key: /etc/nginx/ssl_key/harbor/xxx.key 9.harborä½¿ç”¨ å°†é•œåƒæ¨é€åˆ°harborï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¨é€çš„æ ¼å¼å¦‚ä¸‹ å› æ­¤ï¼Œéœ€è¦å…ˆç»™é•œåƒæ‰“æ ‡ç­¾ //æŸ¥çœ‹centosé•œåƒ docker images|grep centos centos latest 67fa590cfc1c 4 months ago 202MB centos 6.9 2199b8eb8390 9 months ago 195MB //ç»™é•œåƒæŒ‰ç…§æ ¼å¼æ‰“æ ‡ç­¾ docker image tag centos:latest harbor.pptfz.top/pptfz/pptfz-centos:latest é•œåƒåç§° harboråœ°å€ é¡¹ç›®å é•œåƒæ ‡ç­¾å æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/5.1dockerå®¹å™¨ç½‘ç»œ.html":{"url":"linux/docker/5.1dockerå®¹å™¨ç½‘ç»œ.html","title":"dockerç½‘ç»œ","keywords":"","body":"dockerå®¹å™¨ç½‘ç»œ dockerå®¹å™¨ç½‘ç»œç¤ºæ„å›¾ ä¸€ã€dockerç½‘ç»œç›¸å…³ä¿¡æ¯ 1.1dockerç½‘å¡ã€ç½‘å…³ä¿¡æ¯ //å®¿ä¸»æœºæŸ¥çœ‹dockeré»˜è®¤ç½‘å¡ä¿¡æ¯ï¼Œå®‰è£…å®Œdockerå¹¶å¯åŠ¨åï¼Œä¼šæœ‰docker0ç½‘å¡ï¼Œé»˜è®¤IPåœ°å€172.17.0.1 [root@docker1 ~]# ifconfig docker0: flags=4163 mtu 1500 inet 172.17.0.1 netmask 255.255.0.0 broadcast 172.17.255.255 inet6 fe80::42:61ff:fef9:e707 prefixlen 64 scopeid 0x20 ether 02:42:61:f9:e7:07 txqueuelen 0 (Ethernet) RX packets 50722 bytes 2466382 (2.3 MiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 82049 bytes 119024354 (113.5 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 //æŸ¥çœ‹å®¹å™¨ç½‘å…³ï¼Œç½‘å…³é»˜è®¤ä¸º172.17.0.1 [root@ddc401b2bba8 /]# route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 172.17.0.1 0.0.0.0 UG 0 0 0 eth0 172.17.0.0 0.0.0.0 255.255.0.0 U 0 0 0 eth0 1.2å¯åŠ¨ä¸€ä¸ªbusyboxå®¹å™¨ 1.å®¿ä¸»æœºdocker1è¿è¡Œbusyboxå®¹å™¨ [root@docker1 ~]# docker run -it busybox Unable to find image 'busybox:latest' locally latest: Pulling from library/busybox 8e674ad76dce: Pull complete Digest: sha256:c94cf1b87ccb80f2e6414ef913c748b105060debda482058d2b8d0fce39f11b9 Status: Downloaded newer image for busybox:latest #æŸ¥çœ‹ç½‘å¡ / # ip a 1: lo: mtu 65536 qdisc noqueue qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 32: eth0@if33: mtu 1500 qdisc noqueue link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0 valid_lft forever preferred_lft forever #æŸ¥çœ‹ç½‘å…³ / # route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 172.17.0.1 0.0.0.0 UG 0 0 0 eth0 172.17.0.0 0.0.0.0 255.255.0.0 U 0 0 0 eth0 / # 2.busyboxå®¹å™¨pingå®¿ä¸»æœºdocker2 / # ping 10.0.0.61 3.å®¿ä¸»æœºdocker2æŠ“åŒ…æŸ¥çœ‹ å¯ä»¥çœ‹åˆ°ï¼Œæ¶æºçš„IPæ˜¯å®¿ä¸»æœºdocker1çš„eth0ç½‘å¡ï¼Œè¯´æ˜å®¿ä¸»æœºè¿›è¡Œäº†natåœ°å€è½¬æ¢ï¼Œå°†dockerIP 172.17.0.2è½¬æ¢ä¸ºå®¿ä¸»æœºeth0IP [root@docker2 ~]# tcpdump -i eth0 icmp -nn tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes 23:04:03.121544 IP 10.0.0.60 > 10.0.0.61: ICMP echo request, id 2816, seq 52, length 64 23:04:03.121576 IP 10.0.0.61 > 10.0.0.60: ICMP echo reply, id 2816, seq 52, length 64 1.3dockerå®¹å™¨ç”¨åˆ°çš„å†…æ ¸è½¬å‘å’Œiptablesè§„åˆ™ 1.å†…æ ¸è½¬å‘ #å®¿ä¸»æœºdocker1æŸ¥çœ‹å†…æ ¸è½¬å‘ï¼Œå†…æ ¸è½¬å‘æ˜¯dockerå¼€å¯çš„ [root@docker1 ~]# sysctl -a|grep -w net.ipv4.ip_forward net.ipv4.ip_forward = 1 2.iptablesè§„åˆ™ #å®¿ä¸»æœºdocker1æŸ¥çœ‹iptablesè§„åˆ™ [root@docker1 ~]# iptables -t nat -L -n Chain POSTROUTING (policy ACCEPT) target prot opt source destination MASQUERADE all -- 172.17.0.0/16 0.0.0.0/0 äºŒã€dockerç«¯å£æ˜ å°„ï¼ˆå…è®¸å¤–ç½‘è®¿é—®å®¹å™¨ï¼‰ dockeræŒ‡å®šç«¯å£æ˜ å°„ï¼Œdockerä¼šè‡ªåŠ¨æ·»åŠ ä¸€æ¡iptablesè§„åˆ™æ¥å®ç°ç«¯å£æ˜ å°„ -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ -p å®¿ä¸»æœºIP:å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ -p å®¿ä¸»æœºIP::å®¹å™¨ç«¯å£(éšæœºç«¯å£) -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£:udp -p 81:80 -p 443:443 å¯ä»¥æŒ‡å®šå¤šä¸ª-p 2.1æ–¹å¼ä¸€ -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ 1.å¯åŠ¨ä¸€ä¸ªnginxå®¹å™¨å¹¶ä½œç«¯å£æ˜ å°„ 1.å¯åŠ¨ä¸€ä¸ªnginxå®¹å™¨ï¼Œå¹¶å°†å®¿ä¸»æœº8080ç«¯å£æ˜ å°„åˆ°å®¹å™¨80ç«¯å£ [root@docker1 ~]# docker run -d -p 8080:80 nginx:latest ccef9a059f90886370577063f68bc4cab495f6497d394d16941f936b9fb8468a 2.å®¿ä¸»æœºæŸ¥çœ‹iptablesè§„åˆ™ï¼Œå¯ä»¥çœ‹åˆ°iptableså°†å®¿ä¸»æœº8080ç«¯å£æ˜ å°„åˆ°äº†å®¹å™¨çš„80ç«¯å£ [root@docker1 ~]# iptables -t nat -L -n Chain DOCKER (2 references) target prot opt source destination RETURN all -- 0.0.0.0/0 0.0.0.0/0 DNAT tcp -- 0.0.0.0/0 0.0.0.0/0 tcp dpt:8080 to:172.17.0.4:80 2.å®¿ä¸»æœº80ç«¯å£è®¿é—® 3.å®¿ä¸»æœº8080ç«¯å£è®¿é—® 2.2æ–¹å¼äºŒ -p å®¿ä¸»æœºIP:å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ 1.å®¿ä¸»æœºeth0ç½‘å¡æ·»åŠ ä¸€ä¸ªè¾…åŠ©IP 1.æ·»åŠ ä¸€ä¸ªè¾…åŠ©IP [root@docker1 ~]# ifconfig eth0:1 10.0.0.66/24 up 2.æŸ¥çœ‹ç½‘å¡eth0 [root@docker1 ~]# ifconfig |grep -A 2 eth0 eth0: flags=4163 mtu 1500 inet 10.0.0.60 netmask 255.255.255.0 broadcast 10.0.0.255 inet6 fe80::20c:29ff:fe65:ee41 prefixlen 64 scopeid 0x20 -- eth0:1: flags=4163 mtu 1500 inet 10.0.0.66 netmask 255.255.255.0 broadcast 10.0.0.255 ether 00:0c:29:65:ee:41 txqueuelen 1000 (Ethernet) 2.å¯åŠ¨å®¹å™¨ //æ·»åŠ è¾…åŠ©IPåï¼Œå®¿ä¸»æœºçš„80ç«¯å£å°±å¯ä»¥å†æ¬¡ä½¿ç”¨ [root@docker1 ~]# docker run -d -p 10.0.0.60:80:80 nginx:latest 80257a4c036183df9106d38992bf2762007bc5bc1550bed408cf4232eb1ae160 [root@docker1 ~]# docker run -d -p 10.0.0.66:80:80 nginx:latest ccabd14eea387c05ce7af46c002c8f9621aa1907642551aff79f7ca7e4bd25aa 3.æŸ¥çœ‹ç«¯å£ç›‘å¬ [root@docker1 ~]# netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 10.0.0.66:80 0.0.0.0:* LISTEN 18647/docker-proxy tcp 0 0 10.0.0.60:80 0.0.0.0:* LISTEN 2942/docker-proxy 4.æŸ¥çœ‹iptablesè½¬å‘è§„åˆ™ //è®¿é—®å®¿ä¸»æœº80ç«¯å£ï¼Œå°†è¯·æ±‚è½¬å‘è‡³ç¬¬ä¸€ä¸ªå®¹å™¨80ç«¯å£ï¼›è®¿é—®å®¿ä¸»æœºè¾…åŠ©IP80ç«¯å£ï¼Œå°†è¯·æ±‚è½¬å‘è‡³ç¬¬äºŒä¸ªå®¹å™¨80ç«¯å£ [root@docker1 ~]# iptables -t nat -L -n Chain DOCKER (2 references) target prot opt source destination RETURN all -- 0.0.0.0/0 0.0.0.0/0 DNAT tcp -- 0.0.0.0/0 10.0.0.60 tcp dpt:80 to:172.17.0.4:80 DNAT tcp -- 0.0.0.0/0 10.0.0.66 tcp dpt:80 to:172.17.0.5:80 2.3æ–¹å¼ä¸‰ -p å®¿ä¸»æœºIP::å®¹å™¨ç«¯å£(å®¿ä¸»æœºç«¯å£éšæœº) å®¿ä¸»æœºç«¯å£ä¸å†™ï¼Œé»˜è®¤éšæœºå¯åŠ¨ä¸€ä¸ªç«¯å£ 1.å¯åŠ¨ä¸€ä¸ªå®¹å™¨ 1.å¯åŠ¨ä¸€ä¸ªå®¹å™¨ [root@docker1 ~]# docker run -d -p 10.0.0.60::80 nginx:latest fbf5d8973f9094bf18c0e0b9ad63fa3b350e1bd2afc94083824e081c20fdb0c8 2.æŸ¥çœ‹å¯åŠ¨çš„å®¹å™¨ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œéšæœºå¯åŠ¨äº†ä¸€ä¸ª32768ç«¯å£ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES fbf5d8973f90 nginx:latest \"nginx -g 'daemon ofâ€¦\" 11 seconds ago Up 10 seconds 10.0.0.60:32768->80/tcp elastic_ritchie 2.æµè§ˆå™¨è®¿é—®32768ç«¯å£ 2.4æ–¹å¼å›› -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£:udp æ˜ å°„é»˜è®¤é‡‡ç”¨tcpæ–¹å¼ï¼Œæ­¤æ–¹å¼ä¸ºæŒ‡å®šudpæ–¹å¼ ä¾‹å¦‚ï¼Œå®¹å™¨ä¸­è¿è¡Œäº†dnsæœåŠ¡ï¼Œéœ€è¦æŒ‡å®šä¸ºudpæ–¹å¼ 2.5æ–¹å¼äº” -p 81:80 -p 443:443 å¯ä»¥æŒ‡å®šå¤šä¸ª-p å®¹å™¨ä¸­è¿è¡Œäº†å¤šä¸ªæœåŠ¡ï¼Œæ­¤æ—¶éœ€è¦æ˜ å°„å¤šä¸ªç«¯å£ ä¸‰ã€dockerç«¯å£éšæœºæ˜ å°„ -P ä¸-p å®¿ä¸»æœºIP::å®¹å™¨ç«¯å£(å®¿ä¸»æœºç«¯å£éšæœº)æ–¹å¼ç›¸åŒ 1.å¯åŠ¨ä¸€ä¸ªå®¹å™¨ 1.å¯åŠ¨ä¸€ä¸ªå®¹å™¨ [root@docker1 ~]# docker run -d -P nginx:latest c1ffac8baf576208bbf107a24fd83e832b4811ad270bf8006d636e92b6438c39 2.æŸ¥çœ‹å®¹å™¨ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å°†å®¿ä¸»æœº32769æ˜ å°„åˆ°docker80ç«¯å£ [root@docker1 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES c1ffac8baf57 nginx:latest \"nginx -g 'daemon ofâ€¦\" 33 seconds ago Up 32 seconds 0.0.0.0:32769->80/tcp clever_lichterman dockerç«¯å£æ˜ å°„æ ¸å¿ƒ é€šè¿‡iptableså®ç°ç«¯å£æ˜ å°„ï¼ï¼ï¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/5.2dockerç½‘ç»œæ¨¡å¼.html":{"url":"linux/docker/5.2dockerç½‘ç»œæ¨¡å¼.html","title":"dockerç½‘ç»œæ¨¡å¼","keywords":"","body":"dockerç½‘ç»œæ¨¡å¼ æŒ‡å®šå®¹å™¨ç½‘ç»œç±»å‹ --netæˆ–è€…--network 1.dockerç½‘ç»œæ¨¡å¼ dockerç½‘ç»œæ¨¡å¼ï¼Œå…±4ç§ æ¨¡å¼ å«ä¹‰ bridge æ¡¥æ¥æ¨¡å¼ï¼Œé»˜è®¤ host ä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œ none æ— ç½‘ç»œ container ä¸å®¹å™¨å…±äº«ç½‘ç»œ 2.æŸ¥çœ‹dockerç½‘ç»œæ¨¡å¼ 2.1æŸ¥çœ‹dockerç½‘ç»œ æŸ¥çœ‹dockerç½‘ç»œï¼Œé»˜è®¤æœ‰3ç§ [root@docker01 ~]# docker network ls NETWORK ID NAME DRIVER SCOPE 752c74d78d18 bridge bridge local 970755d8e30b host host local f144b44069ab none null local 2.2ç¬¬ä¸€ç§ bridgeï¼Œæ¡¥æ¥ï¼Œé»˜è®¤æ¨¡å¼ //å¯åŠ¨ä¸€ä¸ªå®¹å™¨test1 [root@docker01 ~]# docker run -d --name test1 busybox:latest vi 1 698a85c6cf33bc6a02903f0e6ac7f96e429247a17bef705467a9879c1d2de8b2 //æŸ¥çœ‹å®¹å™¨ç½‘ç»œä¿¡æ¯ [root@docker01 ~]# docker inspect test1 \"Networks\": { \"bridge\": { //å®¹å™¨ç½‘ç»œæ¨¡å¼ä¸ºbridge \"IPAMConfig\": null, \"Links\": null, \"Aliases\": null, \"NetworkID\": \"752c74d78d186a14b2c6e1659c54b50d3396a89fec4b34664c7991ddc50fac55\", \"EndpointID\": \"\", \"Gateway\": \"\", \"IPAddress\": \"\", \"IPPrefixLen\": 0, \"IPv6Gateway\": \"\", \"GlobalIPv6Address\": \"\", \"GlobalIPv6PrefixLen\": 0, \"MacAddress\": \"\", \"DriverOpts\": null } 2.3ç¬¬äºŒç§ hostï¼Œä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œ 1.æŸ¥çœ‹å®¿ä¸»æœºç½‘ç»œï¼Œeth0 IPä¸º10.0.0.20 [root@docker01 ~]# ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:0c:29:49:fe:8f brd ff:ff:ff:ff:ff:ff inet 10.0.0.20/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::20c:29ff:fe49:fe8f/64 scope link valid_lft forever preferred_lft forever 2.å¯åŠ¨ä¸€ä¸ªå®¹å™¨test2ï¼Œè®¾ç½®ç½‘ç»œæ¨¡å¼ä¸ºhost [root@docker01 ~]# docker run -it --name test2 --net host busybox:latest / # 3.æŸ¥çœ‹å®¹å™¨ç½‘ç»œï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¯åŠ¨çš„å®¹å™¨ç½‘å¡ä¸å®¿ä¸»æœºä¸€è‡´ / # ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast qlen 1000 link/ether 00:0c:29:49:fe:8f brd ff:ff:ff:ff:ff:ff inet 10.0.0.20/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::20c:29ff:fe49:fe8f/64 scope link valid_lft forever preferred_lft forever 2.4ç¬¬ä¸‰ç§ noneï¼Œæ— ç½‘ç»œæ¨¡å¼ 1.å¯åŠ¨ä¸€ä¸ªå®¹å™¨test3ï¼Œç½‘ç»œæ¨¡å¼æŒ‡å®šä¸ºnone [root@docker01 ~]# docker run -it --name test3 --net none busybox:latest 2.æŸ¥çœ‹IPï¼Œåªæœ‰loç½‘å¡ / # ip a 1: lo: mtu 65536 qdisc noqueue qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 3.æ— æ³•ä¸Šç½‘ / # ping baidu.com ping: bad address 'baidu.com' 4.æ²¡æœ‰è·¯ç”±ä¿¡æ¯ / # route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 2.5ç¬¬å››ç§ containerï¼Œå…±äº«å®¹å™¨ç½‘ç»œ container:è¦å…±äº«çš„å®¹å™¨IDæˆ–åç§° 1.å…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨test5ï¼Œå®¹å™¨IPä¸º172.17.0.4ï¼Œå¯ä»¥ä¸Šç½‘ [root@docker01 ~]# docker run -it --name test5 busybox:latest / # ip a 1: lo: mtu 65536 qdisc noqueue qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 42: eth0@if43: mtu 1500 qdisc noqueue link/ether 02:42:ac:11:00:04 brd ff:ff:ff:ff:ff:ff inet 172.17.0.4/16 brd 172.17.255.255 scope global eth0 valid_lft forever preferred_lft forever / # ping baidu.com PING baidu.com (220.181.38.148): 56 data bytes 64 bytes from 220.181.38.148: seq=0 ttl=127 time=9.747 ms ^C --- baidu.com ping statistics --- 1 packets transmitted, 1 packets received, 0% packet loss round-trip min/avg/max = 9.747/9.747/9.747 ms 2.å†æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨test6ï¼ŒæŒ‡å®šç½‘ç»œå…±äº«å®¹å™¨test5 [root@docker01 ~]# docker run -it --name test6 --net container:test5 busybox:latest 3.æŸ¥çœ‹IPï¼Œå¯ä»¥çœ‹åˆ°IPåœ°å€ä¸å…±äº«çš„å®¹å™¨test5ä¸€æ · / # ip a 1: lo: mtu 65536 qdisc noqueue qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 46: eth0@if47: mtu 1500 qdisc noqueue link/ether 02:42:ac:11:00:04 brd ff:ff:ff:ff:ff:ff inet 172.17.0.4/16 brd 172.17.255.255 scope global eth0 valid_lft forever preferred_lft forever æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/6.dockeræ•°æ®å·.html":{"url":"linux/docker/6.dockeræ•°æ®å·.html","title":"6.dockeræ•°æ®å·","keywords":"","body":"dockeræ•°æ®å· 1.dockeræŒ‚è½½å·çš„æ–¹å¼ æ–¹å¼ä¸€ï¼šå®¿ä¸»æœºåˆ›å»ºä¸€ä¸ªå·ï¼Œç„¶åæŒ‚è½½åˆ°å®¹å™¨æŸä¸€ä¸ªè·¯å¾„ä¸‹ï¼Œé€‚åˆåšæŒä¹…åŒ– æ­¤æ–¹å¼å°†å®¹å™¨ä¸­çš„æ•°æ®æ‹·è´åˆ°å®¿ä¸»æœºçš„å·ä¸­ï¼Œæ­¤æ—¶å®¹å™¨ä¸­çš„ç›®å½•å†…å®¹æ˜¯ä»€ä¹ˆå†³å®šäº†å®¿ä¸»æœºä¸­çš„ç›®å½•å†…å®¹ æ–¹å¼äºŒï¼šç›´æ¥å°†å®¿ä¸»æœºçš„æŸä¸€ä¸ªç›®å½•æŒ‚è½½åˆ°å®¹å™¨æŸä¸€ä¸ªè·¯å¾„ä¸‹ æ­¤æ–¹å¼å°†å®¿ä¸»æœºçš„ç›®å½•æ‹·è´åˆ°å®¹å™¨çš„ç›®å½•ä¸­ï¼Œæ­¤æ—¶å®¿ä¸»æœºä¸­çš„ç›®å½•å†…å®¹æ˜¯ä»€ä¹ˆå†³å®šäº†å®¹å™¨ä¸­çš„ç›®å½•å†…å®¹ 2.dockeråˆ›å»ºæ•°æ®å·ç¤ºä¾‹ 2.1åˆ›å»ºä¸€ä¸ªåä¸ºdocker-volumeæ•°æ®å· [root@docker1 ~]# docker volume create docker-volume docker-volume 2.2æŸ¥çœ‹åˆ›å»ºçš„æ•°æ®å· [root@docker1 ~]# docker volume ls DRIVER VOLUME NAME local docker-volume 2.3æŸ¥çœ‹æ•°æ®å·å…·ä½“ä¿¡æ¯ï¼Œå­˜æ”¾çš„ä½ç½®ç­‰ é»˜è®¤å­˜æ”¾äº/var/lib/docker/volumes/docker-volume/_data [root@docker1 ~]# docker volume inspect docker-volume [ { \"CreatedAt\": \"2019-06-24T22:39:03+08:00\", \"Driver\": \"local\", \"Labels\": {}, \"Mountpoint\": \"/var/lib/docker/volumes/docker-volume/_data\", \"Name\": \"docker-volume\", \"Options\": {}, \"Scope\": \"local\" } ] 2.4å¯åŠ¨ä¸€ä¸ªnginxå®¹å™¨ï¼Œå¹¶å°†åˆšæ‰åˆ›å»ºçš„æ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨çš„/usr/share/nginx/html [root@docker1 ~]# docker run -d -p 80:80 -v docker-volume:/usr/share/nginx/html nginx:latest 36d6db627b83638ac9a03025c3f7b7b7fd0688ae4a8d3bf75b422ade4016c0a2 #å‚æ•°è¯´æ˜ -d åå°è¿è¡Œ -p ç«¯å£æ˜ å°„ -v å·åç§°:è¦æŒ‚è½½åˆ°å®¹å™¨çš„è·¯å¾„ 2.5æµè§ˆå™¨è®¿é—®åˆšå¯åŠ¨çš„å®¹å™¨ 2.6å°†nginxå®¹å™¨çš„é»˜è®¤æ˜¾ç¤ºç•Œé¢é‡å†™ [root@docker1 ~]# echo hehe > /var/lib/docker/volumes/docker-volume/_data/index.html 2.7å†æ¬¡è®¿é—®å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå†…å®¹å·²ç»å˜åŒ– æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/7.dockeræ‰‹åŠ¨æ„å»ºé•œåƒ.html":{"url":"linux/docker/7.dockeræ‰‹åŠ¨æ„å»ºé•œåƒ.html","title":"7.dockeræ‰‹åŠ¨æ„å»ºé•œåƒ","keywords":"","body":"dockeræ‰‹åŠ¨æ„å»ºé•œåƒ 1.æ‰‹åŠ¨åˆ›å»ºdockeré•œåƒæ­¥éª¤ ç¬¬ä¸€æ­¥ã€æ‰‹åŠ¨å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œåœ¨å®¹å™¨ä¸­å®‰è£…è‡ªå®šä¹‰æœåŠ¡ ç¬¬äºŒæ­¥ã€docker commit æŠŠå®¹å™¨æäº¤ä¸ºé•œåƒ ç¬¬ä¸‰æ­¥ã€æµ‹è¯•é•œåƒåŠŸèƒ½ 2.sshæœåŠ¡é•œåƒåˆ¶ä½œç¤ºä¾‹ 2.1å¯åŠ¨ä¸€ä¸ªé•œåƒ 1.å¯åŠ¨ä¸€ä¸ªcentos6.9 [root@docker1 ~]# docker run -it -p 222:22 centos:6.9 /bin/bash [root@ab815c87fb9c /]# 2.ä¿®æ”¹é•œåƒyumæº [root@ab815c87fb9c /]# curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo [root@ab815c87fb9c /]# curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo [root@ab815c87fb9c /]# yum clean all && yum makecache 2.2é•œåƒä¸­å®‰è£…sshæœåŠ¡å¹¶å¯åŠ¨ 1.å®‰è£…sshæœåŠ¡ [root@ab815c87fb9c /]# yum -y install openssh-server 2.å¯åŠ¨ssh ç¬¬ä¸€æ¬¡å¯åŠ¨æœåŠ¡ï¼Œç›®çš„æ˜¯ç”Ÿæˆå¯†é’¥å¯¹ [root@ab815c87fb9c ~]# service sshd start Generating SSH2 RSA host key: [ OK ] Generating SSH1 RSA host key: [ OK ] Generating SSH2 DSA host key: [ OK ] Starting sshd: [ OK ] 3.éªŒè¯æœåŠ¡å¯åŠ¨çŠ¶å†µ [root@ab815c87fb9c ~]# service sshd status openssh-daemon (pid 163) is running... [root@ab815c87fb9c ~]# netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 163/sshd tcp 0 0 :::22 :::* LISTEN 163/sshd 2.3è®¾ç½®å®¹å™¨rootå¯†ç  [root@ab815c87fb9c /]# echo 1|passwd --stdin root Changing password for user root. passwd: all authentication tokens updated successfully. 2.4ç»ˆç«¯è®¿é—®åˆšåˆ›å»ºçš„é•œåƒ 222ç«¯å£ 2.5æäº¤é•œåƒ 1.ä¸´æ—¶é€€å‡ºé•œåƒ ctrl+p ç„¶å ctrl+q 2.æŸ¥çœ‹å®¹å™¨ä¿¡æ¯ [root@docker1 ~]# docker ps -al CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ab815c87fb9c centos:6.9 \"/bin/bash\" 24 minutes ago Up 24 minutes 0.0.0.0:222->22/tcp priceless_yonath 3.æäº¤é•œåƒ commitåå¯ä»¥åŠ å®¹å™¨åç§°æˆ–å®¹å™¨ID [root@docker1 ~]# docker commit ab815c87fb9c centos6.9_ssh:v1.1 sha256:0fcaf66caf5a6bd48c18e0172827aa04a2bf9fcb5a8f849b20f58a116deac5b7 4.æŸ¥çœ‹é•œåƒ [root@docker1 ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE centos6.9_ssh v1.1 0fcaf66caf5a About a minute ago 504MB 2.6æµ‹è¯•é•œåƒ æ³¨æ„ï¼šå¯åŠ¨çš„å®¹å™¨æä¾›æœåŠ¡çš„åŒæ—¶å¿…é¡»å¤¯ä½ 1.å¯åŠ¨å®¹å™¨ï¼Œä½¿ç”¨åˆšæ‰æäº¤çš„çš„é•œåƒ,è¿™é‡Œä½¿ç”¨ sshd -D ä½¿å®¹å™¨èƒ½å¤¯ä½ [root@docker1 ~]# docker run -d -p 223:22 centos6.9_ssh:v1.1 /usr/sbin/sshd -D ead64de773abd3c1d08647575d096789a5a28d64960f225f7a42ec9cf01211ee 2.æŸ¥çœ‹å®¹å™¨ [root@docker1 ~]# docker ps -al CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ead64de773ab centos6.9_ssh:v1.1 \"/usr/sbin/sshd -D\" 51 seconds ago Up 50 seconds 0.0.0.0:223->22/tcp stupefied_liskov æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/8.dockerfileè‡ªåŠ¨æ„å»ºdockeré•œåƒ.html":{"url":"linux/docker/8.dockerfileè‡ªåŠ¨æ„å»ºdockeré•œåƒ.html","title":"8.dockerè‡ªåŠ¨æ„å»ºé•œåƒ","keywords":"","body":"dockerfileè‡ªåŠ¨æ„å»ºdockeré•œåƒ 1.dockerfileè¯´æ˜ dockerfileå®šä¹‰ dockerfileç±»ä¼¼ansibleçš„å‰§æœ¬ dockerfileç‰¹ç‚¹ 1.æ›´é€‚åˆä¼ è¾“ï¼Œæ–‡ä»¶ä½“ç§¯å° 2.å®ç°æ›´åŠ å®šåˆ¶åŒ– dockerfileä¸»è¦ç»„æˆéƒ¨åˆ† åŸºç¡€é•œåƒä¿¡æ¯ FROM centos:6.9 åˆ¶ä½œé•œåƒæ“ä½œæŒ‡ä»¤ RUN yum -y install httpd å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡ŒæŒ‡ä»¤ CMD [\"/bin/bash\"] dockerfileå¸¸ç”¨æŒ‡ä»¤ æŒ‡ä»¤ å«ä¹‰ FROM æŒ‡å®šåŸºç¡€é•œåƒï¼ŒåŸºäºå“ªä¸ªé•œåƒ MAINTAINER æ„å»ºè€…ä¿¡æ¯ RUN æŒ‡å®šè¿è¡Œå‘½ä»¤ ADD å°†å®¿ä¸»æœºæ–‡ä»¶æ‹·è´åˆ°å®¹å™¨ä¸­ï¼Œä¼šè‡ªåŠ¨è§£å‹ WORKDIR æŒ‡å®šå·¥ä½œç›®å½• VOLUME è®¾å·ï¼ŒæŒ‚è½½å®¿ä¸»æœºç›®å½• EXPOSE æŒ‡å®šå¯¹å¤–çš„ç«¯å£ CMD å®¹å™¨å¯åŠ¨åè¦è¿è¡Œçš„å‘½ä»¤ï¼Œå®¹æ˜“è¢«æ›¿æ¢ COPY å¤åˆ¶æ–‡ä»¶ ENV ç¯å¢ƒå˜é‡ ENTRYPOINT å®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤ï¼ˆæ— æ³•è¢«æ›¿æ¢ï¼Œå¯åŠ¨å®¹å™¨çš„æ—¶å€™æŒ‡å®šçš„å‘½ä»¤ï¼Œä¼šè¢«å½“æˆå‚æ•°ï¼‰ 2.dockerfileæ„å»ºé•œåƒæ­¥éª¤ ç¬¬ä¸€æ­¥ã€ç¼–å†™dockerfile ç¬¬äºŒæ­¥ã€docker buildæ„å»ºé•œåƒ(æ„å»ºé•œåƒçš„æ—¶å€™ï¼Œdockerfileä¸­æœ‰å¤šå°‘ä¸ªå‘½ä»¤å°±æäº¤å¤šå°‘ä¸ªä¸´æ—¶å®¹å™¨ï¼Œæœ€åå†æ€»æäº¤ä¸€æ¬¡å¹¶ä¸”æ¯æ¬¡æäº¤çš„ä¸´æ—¶å®¹å™¨ä¼šè¢«åˆ é™¤) ç¬¬ä¸‰æ­¥ã€å¯åŠ¨å®¹å™¨æµ‹è¯• 3.dockerfileç¤ºä¾‹ 3.1ç¤ºä¾‹ä¸€ï¼šåŸºç¡€dockerfile---sshæœåŠ¡é•œåƒ 3.1.1æ–°å»ºç›®å½•ï¼Œä¸“é—¨å­˜æ”¾dockerfile [root@docker1 ~]# mkdir /dockerfile/centos6.9_ssh 3.1.2ç¼–è¾‘dockerfileï¼Œ æ–‡ä»¶åç§°å¿…é¡»ä¸ºdockerfile [root@docker1 centos6.9_ssh]# cat > dockerfile 3.1.3æ„å»ºé•œåƒ //åŸºäºdockerfileå¼€å§‹æ„å»ºé•œåƒ [root@docker1 centos6.9_ssh]# docker build -t centos6.9_ssh:v2.1 . ã€‚ã€‚ã€‚ Successfully built 6a6d13135aaa Successfully tagged centos6.9_ssh:v2.1 #è¯´æ˜ build æ„å»ºé•œåƒ -t æŒ‡å®šé•œåƒåç§° . ä»å½“å‰ç›®å½•ä¸‹è¯»å–dockerfile 3.1.4æµ‹è¯•é•œåƒ //å¯åŠ¨ä¸€ä¸ªå®¹å™¨æµ‹è¯•é•œåƒ [root@docker1 centos6.9_ssh]# docker run -d -p 3222:22 centos6.9_ssh:v2.1 a57c6406e001f4a295ec8c847627326403f83a44d72adf719d44f8f3f4463ebc //æŸ¥çœ‹é•œåƒ,å¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨å¯åŠ¨æ—¶æ²¡æœ‰æŒ‡å®šé»˜è®¤å‘½ä»¤ï¼Œå·²ä»dockerfileä¸­CMDè¯»å–åˆå§‹è¿è¡Œåä»¤ [root@docker1 centos6.9_ssh]# docker ps -al CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES a57c6406e001 centos6.9_ssh:v2.1 \"/usr/sbin/sshd -D\" 29 seconds ago Up 28 seconds 0.0.0.0:3222->22/tcp elated_kirch 3.1.5sshè¿æ¥æµ‹è¯• 3.2ç¤ºä¾‹äºŒï¼šåŸºç¡€dockerfile--å¤šæœåŠ¡ 3.2.1æ–°å»ºç›®å½•ï¼Œä¸“é—¨å­˜æ”¾dockerfile [root@docker1 ~]# mkdir -p /dockerfile/centos6.9_ssh_http 3.2.2ç¼–è¾‘dockerfileï¼Œ æ–‡ä»¶åç§°å¿…é¡»ä¸ºdockerfile [root@docker1 ~]# cd /dockerfile/centos6.9_ssh_http [root@docker1 centos6.9_ssh_http]# cat > dockerfile 3.2.3ç¼–è¾‘è„šæœ¬ [root@docker1 centos6.9_ssh_http]# cat >init.sh 3.2.4æ„å»ºé•œåƒ //åŸºäºdockerfileæ„å»ºé•œåƒ [root@docker1 centos6.9_ssh_http]# docker build -t centos6.9_ssh_http:v2.1 . ã€‚ã€‚ã€‚ Successfully built 1f4662cc114d Successfully tagged centos6.9_ssh_http:v2.1 //æŸ¥çœ‹é•œåƒ [root@docker1 centos6.9_ssh_http]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE centos6.9_ssh_http v2.1 1f4662cc114d 7 minutes ago 310MB 3.2.5å¯åŠ¨å®¹å™¨ //å¯åŠ¨å®¹å™¨ [root@docker1 centos6.9_ssh_http]# docker run -d -p 5222:22 -p 88:80 centos6.9_ssh_http:v2.1 9880dd05d4cdc3849c4e62888d16592e6551ee3fb3fbae314ffd33c2744874c9 //æŸ¥çœ‹å®¹å™¨ [root@docker1 centos6.9_ssh_http]# docker ps -al CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES fa48d4052ff8 centos6.9_ssh_http:v2.1 \"/bin/bash /init.sh\" 4 seconds ago Up 3 seconds 0.0.0.0:5222->22/tcp, 0.0.0.0:88->80/tcp zen_payne 3.2.6æµ‹è¯•é•œåƒ sshé•œåƒæµ‹è¯• apacheé•œåƒæµ‹è¯• [root@docker1 centos6.9_ssh_http]# curl -I 10.0.0.60:88 HTTP/1.1 403 Forbidden Date: Sun, 30 Jun 2019 15:37:34 GMT Server: Apache/2.2.15 (CentOS) Accept-Ranges: bytes Content-Length: 4961 Connection: close Content-Type: text/html; charset=UTF-8 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/9.ä¿®æ”¹dockeré•œåƒã€å®¹å™¨é»˜è®¤å­˜æ”¾ä½ç½®.html":{"url":"linux/docker/9.ä¿®æ”¹dockeré•œåƒã€å®¹å™¨é»˜è®¤å­˜æ”¾ä½ç½®.html","title":"9.ä¿®æ”¹dockeré•œåƒã€å®¹å™¨é»˜è®¤å­˜æ”¾ä½ç½®","keywords":"","body":"ä¿®æ”¹dockeré•œåƒã€å®¹å™¨é»˜è®¤å­˜æ”¾ä½ç½® 1.ä¿®æ”¹éœ€æ±‚ å› ä¸ºDockeré»˜è®¤æ˜¯å­˜æ”¾åœ¨ç³»ç»Ÿç›˜ä¸­/var/lib/dockerçš„ï¼Œå½“ç”¨çš„æ—¶é—´æ¯”è¾ƒä¹…åï¼Œäº§ç”Ÿçš„é•œåƒåŠå®¹å™¨è¶Šæ¥è¶Šå¤šä¹‹åï¼Œå¯èƒ½ä¼šå¯¼è‡´ä½ çš„ç³»ç»Ÿç›˜æ»¡äº†ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦å°†Dockerçš„é•œåƒåŠå®¹å™¨æŒ‡å‘å¦å¤–ä¸€ä¸ªè·¯å¾„ 2.ä¿®æ”¹æ­¥éª¤ 2.1dockeré•œåƒã€å®¹å™¨é»˜è®¤å­˜æ”¾äº/var/lib/docker [root@docker02 ~]# cd /var/lib/docker [root@docker02 docker]# ls builder buildkit containers image network overlay2 plugins runtimes swarm tmp trust volumes 2.2ä¿®æ”¹dockeré•œåƒã€å®¹å™¨å­˜æ”¾ä½ç½® 1.ç¼–è¾‘é…ç½®æ–‡ä»¶ /etc/docker/daemon.json åŠ å…¥ä»¥ä¸‹ä¸€è¡Œ \"graph\":\"/data/docker\" #ç›®å½•å¯è‡ªè¡Œä¿®æ”¹ 2.æ–°å»ºç›®å½• [root@docker02 ~]# mkdir -p /data/docker 3.ä¿®æ”¹åçš„é…ç½®æ–‡ä»¶ [root@docker02 ~]# cat /etc/docker/daemon.json { \"registry-mirrors\": [\"https://gqk8w9va.mirror.aliyuncs.com\"], \"graph\":\"/data/docker\" } 2.3é‡å¯docker [root@docker02 ~]# systemctl restart docker 2.4æ‹·è´åŸé•œåƒå’Œå®¹å™¨åˆ°æ–°ç›®å½• 1.ä¿®æ”¹å®Œdockeré•œåƒã€å®¹å™¨å­˜æ”¾ä½ç½®åï¼ŒåŸå…ˆçš„é•œåƒå’Œå®¹å™¨æŸ¥çœ‹ä¸å­˜åœ¨ [root@docker02 ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE [root@docker02 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 2.æ‹·è´åŸé•œåƒå’Œå®¹å™¨åˆ°æ–°ç›®å½• [root@docker02 ~]# \\cp -rp /var/lib/docker/* /data/docker/ 3é‡å¯docker [root@docker02 ~]# systemctl restart docker 4.æŸ¥çœ‹ä¿®æ”¹ [root@docker02 ~]# docker info|grep Docker Docker Root Dir: /data/docker 5.æŸ¥çœ‹é•œåƒå’Œå®¹å™¨ï¼Œå·²æ¢å¤ [root@docker02 ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE jumpserver/jms_all 1.4.8 e9274ba449e8 3 months ago 1.31GB [root@docker02 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 2789b0d4a200 jumpserver/jms_all:1.4.8 \"entrypoint.sh\" About an hour ago Up 49 seconds 0.0.0.0:80->80/tcp, 0.0.0.0:2222->2222/tcp jms_all 6.æµ‹è¯•é•œåƒå’Œå®¹å™¨éƒ½æ— é—®é¢˜åå¯ä»¥åˆ é™¤/var/lib/docker [root@docker02 ~]# rm -rf /var/lib/docker æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/10.dockerå®¹å™¨é—´äº’è” --link.html":{"url":"linux/docker/10.dockerå®¹å™¨é—´äº’è” --link.html","title":"10.dockerå®¹å™¨é—´äº’è” --link","keywords":"","body":"dockerå®¹å™¨é—´äº’è” --link(å•æ–¹å‘) 1.å…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨ 1.å¯åŠ¨ä¸€ä¸ªnginxå®¹å™¨ [root@docker01 ~]# docker run -d --name nginx nginx 656aa889b827eaef68d99538c691a4872139f0c82ae72a7810fed64dbe2d6bac 2.æŸ¥çœ‹å¯åŠ¨çš„å®¹å™¨ [root@docker01 ~]# docker ps -al CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 656aa889b827 nginx \"nginx -g 'daemon ofâ€¦\" 3 seconds ago Up 2 seconds 80/tcp nginx 2.å†æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œæ·»åŠ --linkå‚æ•° 1.å†æ¬¡å¯åŠ¨ä¸€ä¸ªbusyboxå®¹å™¨ï¼Œ--linkåé¢ä¸º è¦è¿æ¥çš„å®¹å™¨åç§°:è¿æ¥çš„å®¹å™¨çš„åˆ«å [root@docker01 ~]# docker run -it --link nginx:nginx busybox:latest 2.å› ä¸ºè¦è¿æ¥çš„å®¹å™¨çš„åç§°ä¸ºnginxï¼Œå› æ­¤ping nginxï¼Œå¯ä»¥pingé€š / # ping nginx PING nginx (172.17.0.5): 56 data bytes 64 bytes from 172.17.0.5: seq=0 ttl=64 time=0.814 ms 64 bytes from 172.17.0.5: seq=1 ttl=64 time=0.212 ms ^C --- nginx ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.212/0.513/0.814 ms 3.æŸ¥çœ‹hostsæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æœ‰nginxçš„hostsè§£æ / # cat /etc/hosts 127.0.0.1 localhost ::1 localhost ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters 172.17.0.5 nginx 656aa889b827 172.17.0.6 4d6a7fb490e8 3.å†æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨ 1.å†æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œ--linkåè¾¹ä¸º è¦è¿æ¥çš„å®¹å™¨:å®¹å™¨åˆ«å [root@docker01 ~]# docker run -it --link nginx:web01 busybox:latest 2.pingå®¹å™¨åç§°æˆ–è€…å®¹å™¨åˆ«åéƒ½å¯ä»¥pingé€š / # ping nginx PING nginx (172.17.0.5): 56 data bytes 64 bytes from 172.17.0.5: seq=0 ttl=64 time=0.474 ms ^C --- nginx ping statistics --- 1 packets transmitted, 1 packets received, 0% packet loss round-trip min/avg/max = 0.474/0.474/0.474 ms / # ping web01 PING web01 (172.17.0.5): 56 data bytes 64 bytes from 172.17.0.5: seq=0 ttl=64 time=0.137 ms ^C --- web01 ping statistics --- 1 packets transmitted, 1 packets received, 0% packet loss round-trip min/avg/max = 0.137/0.137/0.137 ms 3.æŸ¥çœ‹hostsæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä¼šæŠŠè¦è¿æ¥çš„å®¹å™¨çš„åˆ«åã€å®¹å™¨IDã€å®¹å™¨åç§°éƒ½æ·»åŠ  / # cat /etc/hosts 127.0.0.1 localhost ::1 localhost ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters 172.17.0.5 web01 656aa889b827 nginx 172.17.0.6 c94f83726145 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/12.1dockerè·¨ä¸»æœºé€šä¿¡ä¹‹macvlan.html":{"url":"linux/docker/12.1dockerè·¨ä¸»æœºé€šä¿¡ä¹‹macvlan.html","title":"macvlan","keywords":"","body":"dockerè·¨ä¸»æœºé€šä¿¡ä¹‹macvlan 1.macvlanè¯´æ˜ macvlanå¯ä»¥è™šæ‹Ÿå¤šä¸ªmacåœ°å€ï¼Œç›¸å½“äºè™šæ‹Ÿå¤šä¸ªç½‘å¡ macvlanä¼˜ç‚¹ ä¸å±€åŸŸç½‘å…¶ä»–ä¸»æœºå¤„äºåŒä¸€ä¸ªç½‘æ®µ macvlanç¼ºç‚¹ æ¯æ¬¡å¯åŠ¨å®¹å™¨éƒ½éœ€è¦æ‰‹åŠ¨æŒ‡å®šIPåœ°å€ 2.macvlanè·¨ä¸»æœºé€šä¿¡ç¤ºä¾‹ 2.1å®éªŒç¯å¢ƒ ä¸»æœºå IP docker01 10.0.0.60 docker02 10.0.0.61 2.2docker01å’Œdocker02éƒ½åˆ›å»ºmacvlanç½‘ç»œ //åœ¨docker01å’Œdocker02ä¸Šç›¸åŒæ“ä½œ [root@docker01 ~]# docker network create --driver macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.254 -o parent=eth0 macvlan_1 #å‚æ•°è¯´æ˜ --driver //æŒ‡å®šç½‘ç»œç±»å‹ --subnet //æŒ‡å®šç½‘æ®µ ---gateway //æŒ‡å®šç½‘å…³ -o parent=eth0 //æŒ‡å®šåŸºäºå“ªå—ç‰©ç†ç½‘å¡ macvlan_1 //ç½‘ç»œåç§°ï¼Œå¯ä»»æ„ 2.3æŸ¥çœ‹åˆ›å»ºçš„ç½‘ç»œ //å¯ä»¥çœ‹åˆ°åˆ›å»ºçš„åç§°ä¸ºmacvlan_1çš„ç½‘ç»œ [root@docker01 ~]# docker network ls NETWORK ID NAME DRIVER SCOPE f2228fe9ebe8 bridge bridge local 1c11b715a65c host host local b0ddd6fd07ed macvlan_1 macvlan local 74d6b08c35c5 none null 2.4åˆ›å»ºä½¿ç”¨macvlanç½‘ç»œçš„å®¹å™¨ 1.docker01å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼ŒIPæŒ‡å®šä¸º10.0.0.3 [root@docker01 ~]# docker run -it --network macvlan_1 --ip=10.0.0.3 centos:latest /bin/bash 2.docker01å¯åŠ¨çš„å®¹å™¨ping docker02å®¿ä¸»æœº10.0.0.61å’Œdocker02å¯åŠ¨çš„å®¹å™¨10.0.0.4 [root@33da263729a4 /]# ping -c 3 10.0.0.61 PING 10.0.0.61 (10.0.0.61) 56(84) bytes of data. 64 bytes from 10.0.0.61: icmp_seq=1 ttl=64 time=0.960 ms 64 bytes from 10.0.0.61: icmp_seq=2 ttl=64 time=0.358 ms 64 bytes from 10.0.0.61: icmp_seq=3 ttl=64 time=0.242 ms --- 10.0.0.61 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2001ms rtt min/avg/max/mdev = 0.242/0.520/0.960/0.314 ms [root@33da263729a4 /]# ping -c 3 10.0.0.4 PING 10.0.0.4 (10.0.0.4) 56(84) bytes of data. 64 bytes from 10.0.0.4: icmp_seq=1 ttl=64 time=0.714 ms 64 bytes from 10.0.0.4: icmp_seq=2 ttl=64 time=0.457 ms 64 bytes from 10.0.0.4: icmp_seq=3 ttl=64 time=0.275 ms --- 10.0.0.4 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2002ms rtt min/avg/max/mdev = 0.275/0.482/0.714/0.180 ms 3.docker02å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼ŒIPæŒ‡å®šä¸º10.0.0.4 [root@docker02 ~]# docker run -it --network macvlan_1 --ip=10.0.0.4 centos:latest /bin/bash 4.docker02å¯åŠ¨çš„å®¹å™¨ping docker01å®¿ä¸»æœº10.0.0.60å’Œdocker02å¯åŠ¨çš„å®¹å™¨10.0.0.3 [root@93ecb0bf3aa9 /]# ping -c 3 10.0.0.60 PING 10.0.0.60 (10.0.0.60) 56(84) bytes of data. 64 bytes from 10.0.0.60: icmp_seq=1 ttl=64 time=0.687 ms 64 bytes from 10.0.0.60: icmp_seq=2 ttl=64 time=0.390 ms 64 bytes from 10.0.0.60: icmp_seq=3 ttl=64 time=0.242 ms --- 10.0.0.60 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2000ms rtt min/avg/max/mdev = 0.242/0.439/0.687/0.186 ms [root@93ecb0bf3aa9 /]# ping -c 3 10.0.0.3 PING 10.0.0.3 (10.0.0.3) 56(84) bytes of data. 64 bytes from 10.0.0.3: icmp_seq=1 ttl=64 time=0.542 ms 64 bytes from 10.0.0.3: icmp_seq=2 ttl=64 time=0.486 ms 64 bytes from 10.0.0.3: icmp_seq=3 ttl=64 time=0.345 ms --- 10.0.0.3 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2002ms rtt min/avg/max/mdev = 0.345/0.457/0.542/0.086 ms âš ï¸âš ï¸âš ï¸å¦‚æœpingä¸é€šï¼Œéœ€è¦å°†ç½‘å¡è®¾ç½®ä¸ºæ··æ‚æ¨¡å¼ ip link set eth0 promisc on æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/12.2dockerè·¨ä¸»æœºé€šä¿¡ä¹‹overlay.html":{"url":"linux/docker/12.2dockerè·¨ä¸»æœºé€šä¿¡ä¹‹overlay.html","title":"overlay","keywords":"","body":"dockerè·¨ä¸»æœºé€šä¿¡ä¹‹overlay 1.overlayè¯´æ˜ overlayä¼˜ç‚¹ ä¼šè‡ªåŠ¨åˆ†é…IPåœ°å€ï¼Œéœ€è¦consulæ•°æ®åº“ ç½‘ç»œç±»å‹ä¸ºoverlayçš„å®¹å™¨é»˜è®¤æœ‰ä¸¤å—ç½‘å¡ eth0 ç”¨äºè·¨ä¸»æœºé—´å®¹å™¨é€šä¿¡ eth1 ç”¨äºè¿æ¥å¤–ç½‘ ç½‘å…³é»˜è®¤ä¸º172.18.0.1ï¼Œæ˜¯å®¿ä¸»æœºdocker_gwbridgeç½‘å¡çš„IPåœ°å€ overlayç½‘ç»œè·¨ä¸»æœºé€šä¿¡ç¤ºæ„å›¾ 2.overlayè·¨ä¸»æœºé€šä¿¡ç¤ºä¾‹ 2.1å®éªŒç¯å¢ƒ ä¸»æœºå IP docker01 10.0.0.60 docker02 10.0.0.61 2.2docker01æ“ä½œ 2.2.1å¯åŠ¨consulå®¹å™¨ [root@docker01 ~]# docker run -d -p 8500:8500 -h consul --name consul --restart=always progrium/consul -server -bootstrap 2.2.2æŸ¥çœ‹å®¹å™¨ï¼Œå®¹å™¨æ˜ å°„äº†å¥½å¤šç«¯å£ [root@docker01 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 84c733c42a91 progrium/consul \"/bin/start -server â€¦\" 24 seconds ago Up 23 seconds 53/tcp, 53/udp, 8300-8302/tcp, 8400/tcp, 8301-8302/udp, 0.0.0.0:8500->8500/tcp consul 2.2.3å®¹å™¨å¯åŠ¨åå¯ä»¥è®¿é—®ä¸€ä¸ªwebç•Œé¢ 10.0.0.60:8500 2.2.4ä¿®æ”¹dockeré…ç½®æ–‡ä»¶/etc/docker/daemon.json 1.ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/docker/daemon.jsonï¼ŒåŠ å…¥ä»¥ä¸‹ä¸‰è¡Œ \"hosts\":[\"tcp://0.0.0.0:2376\",\"unix:///var/run/docker.sock\"], \"cluster-store\": \"consul://10.0.0.60:8500\", \"cluster-advertise\": \"10.0.0.60:2376\" #å‚æ•°è¯´æ˜ \"hosts\":[\"tcp://0.0.0.0:2376\",\"unix:///var/run/docker.sock\"], //æœ¬åœ°ç›‘å¬tcp2376ç«¯å£ï¼ŒåŒæ—¶æŒ‡å®šsockæ–‡ä»¶ \"cluster-store\": \"consul://10.0.0.60:8500\", //é›†ç¾¤ä¿¡æ¯å­˜æ”¾ä½ç½®,è¿™é‡Œä¸ºdocker01 10.0.0.60 \"cluster-advertise\": \"10.0.0.60:2376\" //å®¢æˆ·æœºè‡ªèº«IPåœ°å€,è¿™é‡Œä¸ºdocker01 10.0.0.60 2.ä¿®æ”¹dockeræœåŠ¡å¯åŠ¨æ–‡ä»¶ï¼Œå¦åˆ™åç»­é‡å¯dockerä¼šæŠ¥é”™ [root@docker01 ~]# vim /usr/lib/systemd/system/docker.service ä¿®æ”¹ ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ä¿®æ”¹ä¸º ExecStart=/usr/bin/dockerd 3.é‡å¯docker [root@docker01 ~]# systemctl daemon-reload && systemctl restart docker 2.3docker02æ“ä½œ 2.3.1å¯åŠ¨consulå®¹å™¨ [root@docker02 ~]# docker run -d -p 8500:8500 -h consul --name consul --restart=always progrium/consul -server -bootstrap 2.3.2æŸ¥çœ‹å®¹å™¨ï¼Œå®¹å™¨æ˜ å°„äº†å¥½å¤šç«¯å£ [root@docker02 ~]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES a793cf0b4aed progrium/consul \"/bin/start -server â€¦\" 37 seconds ago Up 35 seconds 53/tcp, 53/udp, 8300-8302/tcp, 8400/tcp, 8301-8302/udp, 0.0.0.0:8500->8500/tcp consul 2.3.3å®¹å™¨å¯åŠ¨åå¯ä»¥è®¿é—®ä¸€ä¸ªwebç•Œé¢ 10.0.0.61:8500 2.3.4ä¿®æ”¹dockeré…ç½®æ–‡ä»¶/etc/docker/daemon.json 1.ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/docker/daemon.jsonï¼ŒåŠ å…¥ä»¥ä¸‹ä¸‰è¡Œ \"hosts\":[\"tcp://0.0.0.0:2376\",\"unix:///var/run/docker.sock\"], \"cluster-store\": \"consul://10.0.0.60:8500\", \"cluster-advertise\": \"10.0.0.60:2376\" #å‚æ•°è¯´æ˜ \"hosts\":[\"tcp://0.0.0.0:2376\",\"unix:///var/run/docker.sock\"], //æœ¬åœ°ç›‘å¬tcp2376ç«¯å£ï¼ŒåŒæ—¶æŒ‡å®šsockæ–‡ä»¶ \"cluster-store\": \"consul://10.0.0.60:8500\", //é›†ç¾¤ä¿¡æ¯å­˜æ”¾ä½ç½®ï¼Œè¿™é‡Œä¸ºdocker01 10.0.0.60 \"cluster-advertise\": \"10.0.0.61:2376\" //å®¢æˆ·æœºè‡ªèº«IPåœ°å€ï¼Œè¿™é‡Œä¸ºdocker02 10.0.0.61 2.ä¿®æ”¹dockeræœåŠ¡å¯åŠ¨æ–‡ä»¶ï¼Œå¦åˆ™åç»­é‡å¯dockerä¼šæŠ¥é”™ [root@docker02 ~]# vim /usr/lib/systemd/system/docker.service ä¿®æ”¹ ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ä¿®æ”¹ä¸º ExecStart=/usr/bin/dockerd 3.é‡å¯docker [root@docker02 ~]# systemctl daemon-reload && systemctl restart docker 2.3.5æœ€ç»ˆæ•ˆæœ è®¿é—®docker1 consulçš„webç•Œé¢ KEY/VALUE-->docker-->nodes æ­£ç¡®æƒ…å†µä¸ºå‡ºç°ä¸¤ä¸ªdockerèŠ‚ç‚¹ åˆ°æ­¤ï¼ŒåŸºç¡€ç¯å¢ƒé…ç½®å®Œæˆï¼ï¼ï¼ 2.4é€šä¿¡æµ‹è¯• 2.4.1docker01åˆ›å»ºoverlayç½‘ç»œï¼Œä¼šè‡ªåŠ¨åŒæ­¥åˆ°docker02ï¼Œå› ä¸ºdocker01å’Œdocker02éƒ½åœ¨consulé›†ç¾¤ä¸­ 1.docker01åˆ›å»ºoverlayç½‘ç»œ [root@docker01 ~]# docker network create -d overlay --subnet 172.16.1.0/24 --gateway 172.16.1.254 overlay1 7a836393a60d6f87bd0053b2d75198a60960db8a98a34488d145eef1fef35711 2.æŸ¥çœ‹åˆ›å»ºçš„ç½‘ç»œï¼Œåç§°ä¸ºoverlayï¼Œç±»å‹ä¸ºglobalï¼Œä¸å…¶ä½™ç½‘ç»œç±»å‹ä¸ä¸€æ · [root@docker01 ~]# docker network ls NETWORK ID NAME DRIVER SCOPE d25efee562f5 bridge bridge local 1c11b715a65c host host local b0ddd6fd07ed macvlan_1 macvlan local 74d6b08c35c5 none null local 7a836393a60d overlay1 overlay global 3.docker02æŸ¥çœ‹ç½‘ç»œï¼Œå¯ä»¥çœ‹åˆ°docker01åˆ›å»ºçš„overlayç½‘ç»œè‡ªåŠ¨åŒæ­¥åˆ°äº†docker02 [root@docker02 ~]# docker network ls NETWORK ID NAME DRIVER SCOPE 59e0e535367b bridge bridge local c464712c8392 host host local 7d9727dd0d2d macvlan_1 macvlan local be782cbc19a4 none null local 7a836393a60d overlay1 overlay global 2.4.2docker01å¯åŠ¨å®¹å™¨overlay1 1.å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼ŒæŒ‡å®šç½‘ç»œä¸ºä¹‹å‰åˆ›å»ºçš„overlay1 [root@docker01 ~]# docker run -it --net overlay1 --name overlay1 busybox:latest /bin/sh 2.æŸ¥çœ‹IPåœ°å€ï¼ŒIPåœ°å€ä¸º172.16.1.1ï¼Œå› ä¸ºä¹‹å‰åˆ›å»ºoverlayç½‘ç»œçš„æ—¶å€™æŒ‡å®šäº†ç½‘æ®µä¸º172.16.1.0/24 / # ip a 1: lo: mtu 65536 qdisc noqueue qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 46: eth0@if47: mtu 1450 qdisc noqueue link/ether 02:42:ac:10:01:01 brd ff:ff:ff:ff:ff:ff inet 172.16.1.1/24 brd 172.16.1.255 scope global eth0 valid_lft forever preferred_lft forever 49: eth1@if50: mtu 1500 qdisc noqueue link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1 valid_lft forever preferred_lft forever 2.4.3docker02å¯åŠ¨å®¹å™¨overlay2 1.å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼ŒæŒ‡å®šç½‘ç»œä¸ºä¹‹å‰åˆ›å»ºçš„overlay1 [root@docker02 ~]# docker run -it --net overlay1 --name overlay2 busybox:latest /bin/sh 2.æŸ¥çœ‹IPåœ°å€ï¼ŒIPåœ°å€ä¸º172.16.1.2ï¼Œå› ä¸ºä¹‹å‰åˆ›å»ºoverlayç½‘ç»œçš„æ—¶å€™æŒ‡å®šäº†ç½‘æ®µä¸º172.16.1.0/24 / # ip a 1: lo: mtu 65536 qdisc noqueue qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 12: eth0@if13: mtu 1450 qdisc noqueue link/ether 02:42:ac:10:01:02 brd ff:ff:ff:ff:ff:ff inet 172.16.1.2/24 brd 172.16.1.255 scope global eth0 valid_lft forever preferred_lft forever 15: eth1@if16: mtu 1500 qdisc noqueue link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1 valid_lft forever preferred_lft forever 2.4.4æµ‹è¯•å®¹å™¨äº’é€šåŠè¿æ¥å¤–ç½‘ docker01æµ‹è¯• 1.ping docker02å¯åŠ¨çš„å®¹å™¨overlay2 / # ping -c 2 172.16.1.2 PING 172.16.1.2 (172.16.1.2): 56 data bytes 64 bytes from 172.16.1.2: seq=0 ttl=64 time=0.831 ms 64 bytes from 172.16.1.2: seq=1 ttl=64 time=0.437 ms --- 172.16.1.2 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.437/0.634/0.831 ms 2.ä¹Ÿå¯ä»¥pingå®¹å™¨åç§°ï¼Œå®¹å™¨åç§°å­˜æ”¾äºconsulé›†ç¾¤ä¸­ / # ping -c 2 overlay2 PING overlay2 (172.16.1.2): 56 data bytes 64 bytes from 172.16.1.2: seq=0 ttl=64 time=0.704 ms 64 bytes from 172.16.1.2: seq=1 ttl=64 time=0.453 ms --- overlay2 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.453/0.578/0.704 ms 3.è¿æ¥å¤–ç½‘ / # ping -c 2 www.baidu.com PING www.baidu.com (61.135.169.121): 56 data bytes 64 bytes from 61.135.169.121: seq=0 ttl=127 time=4.863 ms 64 bytes from 61.135.169.121: seq=1 ttl=127 time=5.121 ms --- www.baidu.com ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 4.863/4.992/5.121 ms docker02æµ‹è¯• 1.ping docker01å¯åŠ¨çš„å®¹å™¨overlay1 / # ping -c 2 172.16.1.1 PING 172.16.1.1 (172.16.1.1): 56 data bytes 64 bytes from 172.16.1.1: seq=0 ttl=64 time=0.755 ms 64 bytes from 172.16.1.1: seq=1 ttl=64 time=0.660 ms --- 172.16.1.1 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.660/0.707/0.755 ms 2.ä¹Ÿå¯ä»¥pingå®¹å™¨åç§°ï¼Œå®¹å™¨åç§°å­˜æ”¾äºconsulé›†ç¾¤ä¸­ / # ping -c 2 overlay1 PING overlay1 (172.16.1.1): 56 data bytes 64 bytes from 172.16.1.1: seq=0 ttl=64 time=0.900 ms 64 bytes from 172.16.1.1: seq=1 ttl=64 time=0.561 ms --- overlay1 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.561/0.730/0.900 ms 3.è¿æ¥å¤–ç½‘ / # ping -c 2 www.baidu.com PING www.baidu.com (61.135.169.125): 56 data bytes 64 bytes from 61.135.169.125: seq=0 ttl=127 time=5.063 ms 64 bytes from 61.135.169.125: seq=1 ttl=127 time=4.792 ms --- www.baidu.com ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 4.792/4.927/5.063 ms åˆ°æ­¤ï¼Œè·¨ä¸»æœºé—´å®¹å™¨é€šä¿¡å®Œæˆï¼ï¼ï¼ 3.overlayç½‘ç»œç±»å‹çš„å®¹å™¨ç½‘å¡é—®é¢˜ 3.1å¯åŠ¨ä¸€ä¸ªå®¹å™¨åï¼Œå¯ä»¥çœ‹åˆ°ç½‘ç»œç±»å‹ä¸ºoverlayçš„å®¹å™¨æœ‰ä¸¤å—ç½‘å¡eth0ã€eth1 1.æŸ¥çœ‹å®¹å™¨IPï¼Œå‘ç°æœ‰ä¸¤å—ç½‘å¡ eth0ä¸º172.16.1.1ï¼Œç”¨äºè·¨ä¸»æœºå®¹å™¨é—´é€šä¿¡ eth1ä¸º172.18.0.2ï¼Œç”¨äºè¿æ¥å¤–ç½‘ / # ip a 1: lo: mtu 65536 qdisc noqueue qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 46: eth0@if47: mtu 1450 qdisc noqueue link/ether 02:42:ac:10:01:01 brd ff:ff:ff:ff:ff:ff inet 172.16.1.1/24 brd 172.16.1.255 scope global eth0 valid_lft forever preferred_lft forever 49: eth1@if50: mtu 1500 qdisc noqueue link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1 valid_lft forever preferred_lft forever 2.æŸ¥çœ‹å®¹å™¨ç½‘å…³ï¼Œå¯ä»¥çœ‹åˆ°å®¹å™¨ç½‘å…³ä¸º172.18.0ã€‚1 / # route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 172.18.0.1 0.0.0.0 UG 0 0 0 eth1 172.16.1.0 0.0.0.0 255.255.255.0 U 0 0 0 eth0 172.18.0.0 0.0.0.0 255.255.0.0 U 0 0 0 eth1 3.æŸ¥çœ‹å®¿ä¸»æœºç½‘å¡docker_gwbridgeï¼Œå¯ä»¥çœ‹åˆ°docker_gwbridgeçš„IPåœ°å€ä¸º172.18.0.1ï¼Œæ˜¯ç½‘ç»œç±»å‹ä¸ºoverlayå®¹å™¨çš„ç½‘å…³åœ°å€ [root@docker01 ~]# ifconfig docker_gwbridge docker_gwbridge: flags=4163 mtu 1500 inet 172.18.0.1 netmask 255.255.0.0 broadcast 172.18.255.255 inet6 fe80::42:38ff:fea8:17e prefixlen 64 scopeid 0x20 ether 02:42:38:a8:01:7e txqueuelen 0 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 (0.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 4.overlayç½‘ç»œç±»å‹ç½‘ç»œå‘½åç©ºé—´ namespaceå®ç°ç½‘ç»œç¯å¢ƒéš”ç¦»ï¼Œç½‘ç»œå‘½ä»¤ç©ºé—´æœ‰è‡ªå·±çš„IPåœ°å€ 1.æŸ¥çœ‹ç½‘ç»œå‘½åç©ºé—´é»˜è®¤ä¸ºç©º [root@docker01 ~]# ip netns [root@docker01 ~]# 2.åˆ›å»ºç›®å½•è½¯è¿æ¥ï¼Œdocker01å’Œdocker02ç›¸åŒæ“ä½œ å› ä¸ºip netnsåªèƒ½æŸ¥çœ‹åˆ°/var/run/netnsä¸‹é¢çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œè€Œdockeré»˜è®¤æ˜¯æ”¾åœ¨/var/run/docker/netnsï¼Œå› æ­¤éœ€è¦åšç›®å½•è½¯è¿æ¥ [root@docker01 ~]# ln -s /var/run/docker/netns/ /var/run/netns 3.æŸ¥çœ‹ç½‘ç»œå‘½åç©ºé—´ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå®¹å™¨é—´æœ‰ä¸€ä¸ªç›¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ 1-7a836393a6 (id: 1) #docker01 [root@docker01 ~]# ip netns 7ab4caaffca3 (id: 2) 1-7a836393a6 (id: 1) 7c88a1ff4a27 (id: 0) #docker02 [root@docker02 ~]# ip netns b7bfd18ee204 (id: 2) 1-7a836393a6 (id: 1) 5eb2da02b6de (id: 0) 4.è¿›å…¥åˆ°è¿™ä¸ªç›¸åŒçš„ç½‘ç»œå‘½åç©ºé—´(å¦‚æœä¸è¿›å…¥ç½‘ç»œå‘½åç©ºé—´åˆ™æ— æ³•æŸ¥çœ‹vxlanç½‘å¡) [root@docker02 ~]# ip netns exec 1-7a836393a6 /bin/bash #æŸ¥çœ‹vxlanç½‘å¡ï¼Œå¯ä»¥çœ‹åˆ°æœ‰br0ã€loã€veth0ã€vxlan0 å¦‚æœå¯åŠ¨å¤šä¸ªç½‘ç»œç±»å‹ä¸ºoverlayçš„å®¹å™¨ï¼Œåˆ™ä¼šæœ‰å¤šä¸ªvethN,Nä»£è¡¨æ•°å­— ä¸”br0çš„IPåœ°å€ä¸º172.16.1.254ï¼Œå³ä¸ºåˆ›å»ºoverlayç½‘ç»œæŒ‡å®šçš„ç½‘æ®µçš„ç½‘å…³åœ°å€ [root@docker02 ~]# ifconfig br0: flags=4163 mtu 1450 inet 172.16.1.254 netmask 255.255.255.0 broadcast 172.16.1.255 ether 76:aa:f3:f4:77:17 txqueuelen 0 (Ethernet) RX packets 1 bytes 28 (28.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 (0.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 lo: flags=73 mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 loop txqueuelen 1000 (Local Loopback) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 (0.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 veth0: flags=4163 mtu 1450 ether 76:aa:f3:f4:77:17 txqueuelen 0 (Ethernet) RX packets 7 bytes 574 (574.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 7 bytes 574 (574.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 vxlan0: flags=4163 mtu 1450 ether be:5c:12:ff:1d:38 txqueuelen 0 (Ethernet) RX packets 5 bytes 420 (420.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 5 bytes 420 (420.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 #æŸ¥çœ‹br0 [root@docker02 ~]# brctl show bridge name bridge id STP enabled interfaces br0 8000.76aaf3f47717 no veth0 vxlan0 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/docker/dockerå‘½ä»¤å¤§å…¨.html":{"url":"linux/docker/dockerå‘½ä»¤å¤§å…¨.html","title":"dockerå‘½ä»¤å¤§å…¨","keywords":"","body":"dockerå‘½ä»¤å¤§å…¨ ä¸€ã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç† 1.1 run docker run ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨å¹¶è¿è¡Œä¸€ä¸ªå‘½ä»¤ è¯­æ³• docker run [OPTIONS] IMAGE [COMMAND] [ARG...] OPTIONSè¯´æ˜ï¼š -a stdin: æŒ‡å®šæ ‡å‡†è¾“å…¥è¾“å‡ºå†…å®¹ç±»å‹ï¼Œå¯é€‰ STDIN/STDOUT/STDERR ä¸‰é¡¹ï¼› -d: åå°è¿è¡Œå®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨IDï¼› -i: ä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸ä¸ -t åŒæ—¶ä½¿ç”¨ï¼› -P: éšæœºç«¯å£æ˜ å°„ï¼Œå®¹å™¨å†…éƒ¨ç«¯å£éšæœºæ˜ å°„åˆ°ä¸»æœºçš„é«˜ç«¯å£ -p: æŒ‡å®šç«¯å£æ˜ å°„ï¼Œæ ¼å¼ä¸ºï¼šä¸»æœº(å®¿ä¸»)ç«¯å£:å®¹å™¨ç«¯å£ -t: ä¸ºå®¹å™¨é‡æ–°åˆ†é…ä¸€ä¸ªä¼ªè¾“å…¥ç»ˆç«¯ï¼Œé€šå¸¸ä¸ -i åŒæ—¶ä½¿ç”¨ï¼› --name=\"nginx-lb\": ä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼› --dns 8.8.8.8: æŒ‡å®šå®¹å™¨ä½¿ç”¨çš„DNSæœåŠ¡å™¨ï¼Œé»˜è®¤å’Œå®¿ä¸»ä¸€è‡´ï¼› --dns-search example.com: æŒ‡å®šå®¹å™¨DNSæœç´¢åŸŸåï¼Œé»˜è®¤å’Œå®¿ä¸»ä¸€è‡´ï¼› -h \"mars\": æŒ‡å®šå®¹å™¨çš„hostnameï¼› -e username=\"ritchie\": è®¾ç½®ç¯å¢ƒå˜é‡ï¼› --env-file=[]: ä»æŒ‡å®šæ–‡ä»¶è¯»å…¥ç¯å¢ƒå˜é‡ï¼› --cpuset=\"0-2\" or --cpuset=\"0,1,2\": ç»‘å®šå®¹å™¨åˆ°æŒ‡å®šCPUè¿è¡Œï¼› -m :è®¾ç½®å®¹å™¨ä½¿ç”¨å†…å­˜æœ€å¤§å€¼ï¼› --net=\"bridge\": æŒ‡å®šå®¹å™¨çš„ç½‘ç»œè¿æ¥ç±»å‹ï¼Œæ”¯æŒ bridge/host/none/container: å››ç§ç±»å‹ï¼› --link=[]: æ·»åŠ é“¾æ¥åˆ°å¦ä¸€ä¸ªå®¹å™¨ï¼› --expose=[]: å¼€æ”¾ä¸€ä¸ªç«¯å£æˆ–ä¸€ç»„ç«¯å£ï¼› --volume , -v: ç»‘å®šä¸€ä¸ªå· å®ä¾‹ ä½¿ç”¨dockeré•œåƒnginx:latestä»¥åå°æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,å¹¶å°†å®¹å™¨å‘½åä¸ºmynginxã€‚ $ docker run --name mynginx -d nginx:latest ä½¿ç”¨é•œåƒnginx:latestä»¥åå°æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,å¹¶å°†å®¹å™¨çš„80ç«¯å£æ˜ å°„åˆ°ä¸»æœºéšæœºç«¯å£ã€‚ $ docker run -P -d nginx:latest ä½¿ç”¨é•œåƒ nginx:latestï¼Œä»¥åå°æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,å°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ 80 ç«¯å£,ä¸»æœºçš„ç›®å½• /data æ˜ å°„åˆ°å®¹å™¨çš„ /dataã€‚ $ docker run -p 80:80 -v /data:/data -d nginx:latest ç»‘å®šå®¹å™¨çš„ 8080 ç«¯å£ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°æœ¬åœ°ä¸»æœº 127.0.0.1 çš„ 80 ç«¯å£ä¸Šã€‚ $ docker run -p 127.0.0.1:80:8080/tcp ubuntu bash ä½¿ç”¨é•œåƒnginx:latestä»¥äº¤äº’æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,åœ¨å®¹å™¨å†…æ‰§è¡Œ/bin/bashå‘½ä»¤ã€‚ $ docker run -it nginx:latest /bin/bash root@b8573233d675:/# 1.2 start/stop/restart docker start :å¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªå·²ç»è¢«åœæ­¢çš„å®¹å™¨ docker stop :åœæ­¢ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ docker restart :é‡å¯å®¹å™¨ è¯­æ³• docker start [OPTIONS] CONTAINER [CONTAINER...] docker stop [OPTIONS] CONTAINER [CONTAINER...] docker restart [OPTIONS] CONTAINER [CONTAINER...] å®ä¾‹ å¯åŠ¨å·²è¢«åœæ­¢çš„å®¹å™¨myrunoob $ docker start myrunoob åœæ­¢è¿è¡Œä¸­çš„å®¹å™¨myrunoob $ docker stop myrunoob é‡å¯å®¹å™¨myrunoob $ docker restart myrunoob 1.3 kill docker kill :æ€æ‰ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ã€‚ è¯­æ³• docker kill [OPTIONS] CONTAINER [CONTAINER...] OPTIONSè¯´æ˜ï¼š -s :å‘å®¹å™¨å‘é€ä¸€ä¸ªä¿¡å· å®ä¾‹ æ€æ‰è¿è¡Œä¸­çš„å®¹å™¨mynginx $ docker kill -s KILL mynginx mynginx 1.4 rm docker rm ï¼šåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚ è¯­æ³• docker rm [OPTIONS] CONTAINER [CONTAINER...] OPTIONSè¯´æ˜ï¼š -f :é€šè¿‡ SIGKILL ä¿¡å·å¼ºåˆ¶åˆ é™¤ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ã€‚ -l :ç§»é™¤å®¹å™¨é—´çš„ç½‘ç»œè¿æ¥ï¼Œè€Œéå®¹å™¨æœ¬èº«ã€‚ -v :åˆ é™¤ä¸å®¹å™¨å…³è”çš„å·ã€‚ å®ä¾‹ å¼ºåˆ¶åˆ é™¤å®¹å™¨ db01ã€db02ï¼š $ docker rm -f db01 db02 ç§»é™¤å®¹å™¨ nginx01 å¯¹å®¹å™¨ db01 çš„è¿æ¥ï¼Œè¿æ¥å dbï¼š $ docker rm -l db åˆ é™¤å®¹å™¨ nginx01, å¹¶åˆ é™¤å®¹å™¨æŒ‚è½½çš„æ•°æ®å·ï¼š $ docker rm -v nginx01 åˆ é™¤æ‰€æœ‰å·²ç»åœæ­¢çš„å®¹å™¨ï¼š $ docker rm `docker ps -a -q` 1.5 pause/unpause docker pause :æš‚åœå®¹å™¨ä¸­æ‰€æœ‰çš„è¿›ç¨‹ã€‚ docker unpause :æ¢å¤å®¹å™¨ä¸­æ‰€æœ‰çš„è¿›ç¨‹ã€‚ è¯­æ³• docker pause [OPTIONS] CONTAINER [CONTAINER...] docker unpause [OPTIONS] CONTAINER [CONTAINER...] å®ä¾‹ æš‚åœæ•°æ®åº“å®¹å™¨db01æä¾›æœåŠ¡ã€‚ $ docker pause db01 æ¢å¤æ•°æ®åº“å®¹å™¨db01æä¾›æœåŠ¡ã€‚ $ docker unpause db01 1.6 create docker create ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ä½†ä¸å¯åŠ¨å®ƒ ç”¨æ³•åŒ1.1run è¯­æ³• docker create [OPTIONS] IMAGE [COMMAND] [ARG...] è¯­æ³•åŒ1.1run å®ä¾‹ ä½¿ç”¨dockeré•œåƒnginx:lateståˆ›å»ºä¸€ä¸ªå®¹å™¨,å¹¶å°†å®¹å™¨å‘½åä¸ºmynginx $ docker create --name mynginx nginx:latest 09b93464c2f75b7b69f83d56a9cfc23ceb50a48a9db7652ee4c27e3e2cb1961f 1.7 exec docker exec ï¼šåœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ è¯­æ³• docker exec [OPTIONS] CONTAINER COMMAND [ARG...] OPTIONSè¯´æ˜ï¼š -d :åˆ†ç¦»æ¨¡å¼: åœ¨åå°è¿è¡Œ -i :å³ä½¿æ²¡æœ‰é™„åŠ ä¹Ÿä¿æŒSTDIN æ‰“å¼€ -t :åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ å®ä¾‹ åœ¨å®¹å™¨ mynginx ä¸­ä»¥äº¤äº’æ¨¡å¼æ‰§è¡Œå®¹å™¨å†… /root/runoob.sh è„šæœ¬: $ docker exec -it mynginx /bin/sh /root/runoob.sh http://www.runoob.com/ åœ¨å®¹å™¨ mynginx ä¸­å¼€å¯ä¸€ä¸ªäº¤äº’æ¨¡å¼çš„ç»ˆç«¯: docker exec -i -t mynginx /bin/bash root@b1a0703e41e7:/# ä¹Ÿå¯ä»¥é€šè¿‡ docker ps -a å‘½ä»¤æŸ¥çœ‹å·²ç»åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œç„¶åä½¿ç”¨å®¹å™¨ ID è¿›å…¥å®¹å™¨ã€‚ æŸ¥çœ‹å·²ç»åœ¨è¿è¡Œçš„å®¹å™¨ IDï¼š $ docker ps -a ... 9df70f9a0714 openjdk \"/usercode/script.shâ€¦\" ... ç¬¬ä¸€åˆ—çš„ 9df70f9a0714 å°±æ˜¯å®¹å™¨ IDã€‚ é€šè¿‡ exec å‘½ä»¤å¯¹æŒ‡å®šçš„å®¹å™¨æ‰§è¡Œ bash: $ docker exec -it 9df70f9a0714 /bin/bash äºŒã€å®¹å™¨æ“ä½œ 2.1 ps docker ps :åˆ—å‡ºå®¹å™¨ è¯­æ³• docker ps [OPTIONS] OPTIONSè¯´æ˜ï¼š -a :æ˜¾ç¤ºæ‰€æœ‰çš„å®¹å™¨ï¼ŒåŒ…æ‹¬æœªè¿è¡Œçš„ã€‚ -f :æ ¹æ®æ¡ä»¶è¿‡æ»¤æ˜¾ç¤ºçš„å†…å®¹ã€‚ --format :æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ã€‚ -l :æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„å®¹å™¨ã€‚ -n :åˆ—å‡ºæœ€è¿‘åˆ›å»ºçš„nä¸ªå®¹å™¨ã€‚ --no-trunc :ä¸æˆªæ–­è¾“å‡ºã€‚ -q :é™é»˜æ¨¡å¼ï¼Œåªæ˜¾ç¤ºå®¹å™¨ç¼–å·ã€‚ -s :æ˜¾ç¤ºæ€»çš„æ–‡ä»¶å¤§å°ã€‚ å®ä¾‹ åˆ—å‡ºæ‰€æœ‰åœ¨è¿è¡Œçš„å®¹å™¨ä¿¡æ¯ã€‚ $ docker ps CONTAINER ID IMAGE COMMAND ... PORTS NAMES 09b93464c2f7 nginx:latest \"nginx -g 'daemon off\" ... 80/tcp, 443/tcp myrunoob 96f7f14e99ab mysql:5.6 \"docker-entrypoint.sh\" ... 0.0.0.0:3306->3306/tcp mymysql è¾“å‡ºè¯¦æƒ…ä»‹ç»ï¼š CONTAINER ID: å®¹å™¨ IDã€‚ IMAGE: ä½¿ç”¨çš„é•œåƒã€‚ COMMAND: å¯åŠ¨å®¹å™¨æ—¶è¿è¡Œçš„å‘½ä»¤ã€‚ CREATED: å®¹å™¨çš„åˆ›å»ºæ—¶é—´ã€‚ STATUS: å®¹å™¨çŠ¶æ€ã€‚ çŠ¶æ€æœ‰7ç§ï¼š createdï¼ˆå·²åˆ›å»ºï¼‰ restartingï¼ˆé‡å¯ä¸­ï¼‰ runningï¼ˆè¿è¡Œä¸­ï¼‰ removingï¼ˆè¿ç§»ä¸­ï¼‰ pausedï¼ˆæš‚åœï¼‰ exitedï¼ˆåœæ­¢ï¼‰ deadï¼ˆæ­»äº¡ï¼‰ PORTS: å®¹å™¨çš„ç«¯å£ä¿¡æ¯å’Œä½¿ç”¨çš„è¿æ¥ç±»å‹ï¼ˆtcp\\udpï¼‰ã€‚ NAMES: è‡ªåŠ¨åˆ†é…çš„å®¹å™¨åç§°ã€‚ åˆ—å‡ºæœ€è¿‘åˆ›å»ºçš„3ä¸ªå®¹å™¨ä¿¡æ¯ã€‚ docker ps -n 3 CONTAINER ID IMAGE COMMAND CREATED 09b93464c2f7 nginx:latest \"nginx -g 'daemon off\" 2 days ago ... b8573233d675 nginx:latest \"/bin/bash\" 2 days ago ... b1a0703e41e7 nginx:latest \"nginx -g 'daemon off\" 2 days ago ... åˆ—å‡ºæ‰€æœ‰åˆ›å»ºçš„å®¹å™¨IDã€‚ docker ps -a -q 09b93464c2f7 b8573233d675 ... 2.2 inspect docker inspect : è·å–å®¹å™¨/é•œåƒçš„å…ƒæ•°æ®ã€‚ è¯­æ³• docker inspect [OPTIONS] NAME|ID [NAME|ID...] OPTIONSè¯´æ˜ï¼š -f :æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ã€‚ -s :æ˜¾ç¤ºæ€»çš„æ–‡ä»¶å¤§å°ã€‚ --type :ä¸ºæŒ‡å®šç±»å‹è¿”å›JSONã€‚ å®ä¾‹ è·å–é•œåƒmysql:5.6çš„å…ƒä¿¡æ¯ã€‚ $ docker inspect mysql:5.6 [ { \"Id\": \"sha256:2c0964ec182ae9a045f866bbc2553087f6e42bfc16074a74fb820af235f070ec\", \"RepoTags\": [ \"mysql:5.6\" ], \"RepoDigests\": [], \"Parent\": \"\", \"Comment\": \"\", \"Created\": \"2016-05-24T04:01:41.168371815Z\", \"Container\": \"e0924bc460ff97787f34610115e9363e6363b30b8efa406e28eb495ab199ca54\", \"ContainerConfig\": { \"Hostname\": \"b0cf605c7757\", \"Domainname\": \"\", \"User\": \"\", \"AttachStdin\": false, \"AttachStdout\": false, \"AttachStderr\": false, \"ExposedPorts\": { \"3306/tcp\": {} }, ... è·å–æ­£åœ¨è¿è¡Œçš„å®¹å™¨mymysqlçš„ IPã€‚ $ docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mymysql 172.17.0.3 2.3 top docker top :æŸ¥çœ‹å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ä¿¡æ¯ï¼Œæ”¯æŒ ps å‘½ä»¤å‚æ•°ã€‚ è¯­æ³• docker top [OPTIONS] CONTAINER [ps OPTIONS] å®¹å™¨è¿è¡Œæ—¶ä¸ä¸€å®šæœ‰/bin/bashç»ˆç«¯æ¥äº¤äº’æ‰§è¡Œtopå‘½ä»¤ï¼Œè€Œä¸”å®¹å™¨è¿˜ä¸ä¸€å®šæœ‰topå‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨docker topæ¥å®ç°æŸ¥çœ‹containerä¸­æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚ å®ä¾‹ æŸ¥çœ‹å®¹å™¨mymysqlçš„è¿›ç¨‹ä¿¡æ¯ã€‚ $ docker top mymysql UID PID PPID C STIME TTY TIME CMD 999 40347 40331 18 00:58 ? 00:00:02 mysqld æŸ¥çœ‹æ‰€æœ‰è¿è¡Œå®¹å™¨çš„è¿›ç¨‹ä¿¡æ¯ã€‚ $ for i in `docker ps |grep Up|awk '{print $1}'`;do echo \\ && docker top $i; done 2.4 attach docker attach :è¿æ¥åˆ°æ­£åœ¨è¿è¡Œä¸­çš„å®¹å™¨ã€‚ è¯­æ³• docker attach [OPTIONS] CONTAINER è¦attachä¸Šå»çš„å®¹å™¨å¿…é¡»æ­£åœ¨è¿è¡Œï¼Œå¯ä»¥åŒæ—¶è¿æ¥ä¸ŠåŒä¸€ä¸ªcontaineræ¥å…±äº«å±å¹•ï¼ˆä¸screenå‘½ä»¤çš„attachç±»ä¼¼ï¼‰ã€‚ å®˜æ–¹æ–‡æ¡£ä¸­è¯´attachåå¯ä»¥é€šè¿‡CTRL-Cæ¥detachï¼Œä½†å®é™…ä¸Šç»è¿‡æˆ‘çš„æµ‹è¯•ï¼Œå¦‚æœcontainerå½“å‰åœ¨è¿è¡Œbashï¼ŒCTRL-Cè‡ªç„¶æ˜¯å½“å‰è¡Œçš„è¾“å…¥ï¼Œæ²¡æœ‰é€€å‡ºï¼›å¦‚æœcontainerå½“å‰æ­£åœ¨å‰å°è¿è¡Œè¿›ç¨‹ï¼Œå¦‚è¾“å‡ºnginxçš„access.logæ—¥å¿—ï¼ŒCTRL-Cä¸ä»…ä¼šå¯¼è‡´é€€å‡ºå®¹å™¨ï¼Œè€Œä¸”è¿˜stopäº†ã€‚è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œdetachçš„æ„æ€æŒ‰ç†åº”è¯¥æ˜¯è„±ç¦»å®¹å™¨ç»ˆç«¯ï¼Œä½†å®¹å™¨ä¾ç„¶è¿è¡Œã€‚å¥½åœ¨attachæ˜¯å¯ä»¥å¸¦ä¸Š--sig-proxy=falseæ¥ç¡®ä¿CTRL-Dæˆ–CTRL-Cä¸ä¼šå…³é—­å®¹å™¨ã€‚ å®ä¾‹ å®¹å™¨mynginxå°†è®¿é—®æ—¥å¿—æŒ‡åˆ°æ ‡å‡†è¾“å‡ºï¼Œè¿æ¥åˆ°å®¹å™¨æŸ¥çœ‹è®¿é—®ä¿¡æ¯ã€‚ $ docker attach --sig-proxy=false mynginx 192.168.239.1 - - [10/Jul/2016:16:54:26 +0000] \"GET / HTTP/1.1\" 304 0 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\" \"-\" --sig-proxy=false ä¿è¯ctrl+cæˆ–è€…ctrl+dä¸ä¼šå…³é—­å®¹å™¨ 2.5 events docker events : ä»æœåŠ¡å™¨è·å–å®æ—¶äº‹ä»¶ è¯­æ³• docker events [OPTIONS] OPTIONSè¯´æ˜ï¼š -f ï¼šæ ¹æ®æ¡ä»¶è¿‡æ»¤äº‹ä»¶ï¼› --since ï¼šä»æŒ‡å®šçš„æ—¶é—´æˆ³åæ˜¾ç¤ºæ‰€æœ‰äº‹ä»¶; --until ï¼šæµæ°´æ—¶é—´æ˜¾ç¤ºåˆ°æŒ‡å®šçš„æ—¶é—´ä¸ºæ­¢ï¼› å®ä¾‹ æ˜¾ç¤ºdocker 2016å¹´7æœˆ1æ—¥åçš„æ‰€æœ‰äº‹ä»¶ã€‚ $ docker events --since=\"1467302400\" 2016-07-08T19:44:54.501277677+08:00 network connect 66f958fd13dc4314ad20034e576d5c5eba72e0849dcc38ad9e8436314a4149d4 (container=b8573233d675705df8c89796a2c2687cd8e36e03646457a15fb51022db440e64, name=bridge, type=bridge) 2016-07-08T19:44:54.723876221+08:00 container start b8573233d675705df8c89796a2c2687cd8e36e03646457a15fb51022db440e64 (image=nginx:latest, name=elegant_albattani) 2016-07-08T19:44:54.726110498+08:00 container resize b8573233d675705df8c89796a2c2687cd8e36e03646457a15fb51022db440e64 (height=39, image=nginx:latest, name=elegant_albattani, width=167) 2016-07-08T19:46:22.137250899+08:00 container die b8573233d675705df8c89796a2c2687cd8e36e03646457a15fb51022db440e64 (exitCode=0, image=nginx:latest, name=elegant_albattani) ... æ˜¾ç¤ºdocker é•œåƒä¸ºmysql:5.6 2016å¹´7æœˆ1æ—¥åçš„ç›¸å…³äº‹ä»¶ã€‚ $ docker events -f \"image\"=\"mysql:5.6\" --since=\"1467302400\" 2016-07-11T00:38:53.975174837+08:00 container start 96f7f14e99ab9d2f60943a50be23035eda1623782cc5f930411bbea407a2bb10 (image=mysql:5.6, name=mymysql) 2016-07-11T00:51:17.022572452+08:00 container kill 96f7f14e99ab9d2f60943a50be23035eda1623782cc5f930411bbea407a2bb10 (image=mysql:5.6, name=mymysql, signal=9) ... å¦‚æœæŒ‡å®šçš„æ—¶é—´æ˜¯åˆ°ç§’çº§çš„ï¼Œéœ€è¦å°†æ—¶é—´è½¬æˆæ—¶é—´æˆ³ã€‚å¦‚æœæ—¶é—´ä¸ºæ—¥æœŸçš„è¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¦‚--since=\"2016-07-01\"ã€‚ 2.6 logs docker logs : è·å–å®¹å™¨çš„æ—¥å¿— è¯­æ³• docker logs [OPTIONS] CONTAINER OPTIONSè¯´æ˜ï¼š -f : è·Ÿè¸ªæ—¥å¿—è¾“å‡º --since :æ˜¾ç¤ºæŸä¸ªå¼€å§‹æ—¶é—´çš„æ‰€æœ‰æ—¥å¿— -t : æ˜¾ç¤ºæ—¶é—´æˆ³ --tail :ä»…åˆ—å‡ºæœ€æ–°Næ¡å®¹å™¨æ—¥å¿— å®ä¾‹ è·Ÿè¸ªæŸ¥çœ‹å®¹å™¨mynginxçš„æ—¥å¿—è¾“å‡ºã€‚ $ docker logs -f mynginx 192.168.239.1 - - [10/Jul/2016:16:53:33 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\" \"-\" 2016/07/10 16:53:33 [error] 5#5: *1 open() \"/usr/share/nginx/html/favicon.ico\" failed (2: No such file or directory), client: 192.168.239.1, server: localhost, request: \"GET /favicon.ico HTTP/1.1\", host: \"192.168.239.130\", referrer: \"http://192.168.239.130/\" 192.168.239.1 - - [10/Jul/2016:16:53:33 +0000] \"GET /favicon.ico HTTP/1.1\" 404 571 \"http://192.168.239.130/\" \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\" \"-\" 192.168.239.1 - - [10/Jul/2016:16:53:59 +0000] \"GET / HTTP/1.1\" 304 0 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\" \"-\" ... æŸ¥çœ‹å®¹å™¨mynginxä»2016å¹´7æœˆ1æ—¥åçš„æœ€æ–°10æ¡æ—¥å¿—ã€‚ $ docker logs --since=\"2016-07-01\" --tail=10 mynginx 2.7 wait docker wait : é˜»å¡è¿è¡Œç›´åˆ°å®¹å™¨åœæ­¢ï¼Œç„¶åæ‰“å°å‡ºå®ƒçš„é€€å‡ºä»£ç ã€‚ è¯­æ³• docker wait [OPTIONS] CONTAINER [CONTAINER...] å®ä¾‹ $ docker wait CONTAINER 2.8 export docker export :å°†æ–‡ä»¶ç³»ç»Ÿä½œä¸ºä¸€ä¸ªtarå½’æ¡£æ–‡ä»¶å¯¼å‡ºåˆ°STDOUTã€‚ è¯­æ³• docker export [OPTIONS] CONTAINER OPTIONSè¯´æ˜ï¼š -o :å°†è¾“å…¥å†…å®¹å†™åˆ°æ–‡ä»¶ã€‚ å®ä¾‹ å°†idä¸ºa404c6c174a2çš„å®¹å™¨æŒ‰æ—¥æœŸä¿å­˜ä¸ºtaræ–‡ä»¶ã€‚ $ docker export -o mysql-`date +%Y%m%d`.tar a404c6c174a2 $ ls mysql-`date +%Y%m%d`.tar mysql-20160711.tar è§£å‹åæ˜¯æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿç›®å½• bin dev home lib64 mnt proc run srv tmp var boot etc lib media opt root sbin sys usr 2.9 port docker port :åˆ—å‡ºæŒ‡å®šçš„å®¹å™¨çš„ç«¯å£æ˜ å°„ï¼Œæˆ–è€…æŸ¥æ‰¾å°†PRIVATE_PORT NATåˆ°é¢å‘å…¬ä¼—çš„ç«¯å£ã€‚ è¯­æ³• docker port [OPTIONS] CONTAINER [PRIVATE_PORT[/PROTO]] å®ä¾‹ æŸ¥çœ‹å®¹å™¨mynginxçš„ç«¯å£æ˜ å°„æƒ…å†µã€‚ $ docker port mymysql 3306/tcp -> 0.0.0.0:3306 ä¸‰ã€å®¹å™¨rootfså‘½ä»¤ 3.1 commit docker commit :ä»å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚ è¯­æ³• docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]] OPTIONSè¯´æ˜ï¼š -a :æäº¤çš„é•œåƒä½œè€…ï¼› -c :ä½¿ç”¨DockerfileæŒ‡ä»¤æ¥åˆ›å»ºé•œåƒï¼› -m :æäº¤æ—¶çš„è¯´æ˜æ–‡å­—ï¼› -p :åœ¨commitæ—¶ï¼Œå°†å®¹å™¨æš‚åœã€‚ å®ä¾‹ å°†å®¹å™¨a404c6c174a2 ä¿å­˜ä¸ºæ–°çš„é•œåƒ,å¹¶æ·»åŠ æäº¤äººä¿¡æ¯å’Œè¯´æ˜ä¿¡æ¯ã€‚ $ docker commit -a \"runoob.com\" -m \"my apache\" a404c6c174a2 mymysql:v1 sha256:37af1236adef1544e8886be23010b66577647a40bc02c0885a6600b33ee28057 $ docker images mymysql:v1 REPOSITORY TAG IMAGE ID CREATED SIZE mymysql v1 37af1236adef 15 seconds ago 329 MB 3.2 cp docker cp :ç”¨äºå®¹å™¨ä¸ä¸»æœºä¹‹é—´çš„æ•°æ®æ‹·è´ã€‚ è¯­æ³• docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|- docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH OPTIONSè¯´æ˜ï¼š -L :ä¿æŒæºç›®æ ‡ä¸­çš„é“¾æ¥ å®ä¾‹ å°†ä¸»æœº/www/runoobç›®å½•æ‹·è´åˆ°å®¹å™¨96f7f14e99abçš„/wwwç›®å½•ä¸‹ã€‚ $ docker cp /www/runoob 96f7f14e99ab:/www/ å°†ä¸»æœº/www/runoobç›®å½•æ‹·è´åˆ°å®¹å™¨96f7f14e99abä¸­ï¼Œç›®å½•é‡å‘½åä¸ºwwwã€‚ $ docker cp /www/runoob 96f7f14e99ab:/www å°†å®¹å™¨96f7f14e99abçš„/wwwç›®å½•æ‹·è´åˆ°ä¸»æœºçš„/tmpç›®å½•ä¸­ã€‚ $ docker cp 96f7f14e99ab:/www /tmp/ 3.3 diff docker diff : æ£€æŸ¥å®¹å™¨é‡Œæ–‡ä»¶ç»“æ„çš„æ›´æ”¹ã€‚ è¯­æ³• docker diff [OPTIONS] CONTAINER å®ä¾‹ æŸ¥çœ‹å®¹å™¨mymysqlçš„æ–‡ä»¶ç»“æ„æ›´æ”¹ã€‚ $ docker diff mymysql A /logs A /mysql_data C /run C /run/mysqld A /run/mysqld/mysqld.pid A /run/mysqld/mysqld.sock C /tmp å››ã€é•œåƒä»“åº“ 4.1 login docker login : ç™»é™†åˆ°ä¸€ä¸ªDockeré•œåƒä»“åº“ï¼Œå¦‚æœæœªæŒ‡å®šé•œåƒä»“åº“åœ°å€ï¼Œé»˜è®¤ä¸ºå®˜æ–¹ä»“åº“ Docker Hub docker logout : ç™»å‡ºä¸€ä¸ªDockeré•œåƒä»“åº“ï¼Œå¦‚æœæœªæŒ‡å®šé•œåƒä»“åº“åœ°å€ï¼Œé»˜è®¤ä¸ºå®˜æ–¹ä»“åº“ Docker Hub è¯­æ³• docker login [OPTIONS] [SERVER] docker logout [OPTIONS] [SERVER] OPTIONSè¯´æ˜ï¼š -u :ç™»é™†çš„ç”¨æˆ·å -p :ç™»é™†çš„å¯†ç  å®ä¾‹ ç™»é™†åˆ°Docker Hub $ docker login -u ç”¨æˆ·å -p å¯†ç  ç™»å‡ºDocker Hub $ docker logout 4.2 pull docker pull : ä»é•œåƒä»“åº“ä¸­æ‹‰å–æˆ–è€…æ›´æ–°æŒ‡å®šé•œåƒ è¯­æ³• docker pull [OPTIONS] NAME[:TAG|@DIGEST] OPTIONSè¯´æ˜ï¼š -a :æ‹‰å–æ‰€æœ‰ tagged é•œåƒ --disable-content-trust :å¿½ç•¥é•œåƒçš„æ ¡éªŒ,é»˜è®¤å¼€å¯ å®ä¾‹ ä»Docker Hubä¸‹è½½javaæœ€æ–°ç‰ˆé•œåƒã€‚ $ docker pull java ä»Docker Hubä¸‹è½½REPOSITORYä¸ºjavaçš„æ‰€æœ‰é•œåƒã€‚ $ docker pull -a java 4.3 push docker push : å°†æœ¬åœ°çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“,è¦å…ˆç™»é™†åˆ°é•œåƒä»“åº“ è¯­æ³• docker push [OPTIONS] NAME[:TAG] OPTIONSè¯´æ˜ï¼š --disable-content-trust :å¿½ç•¥é•œåƒçš„æ ¡éªŒ,é»˜è®¤å¼€å¯ å®ä¾‹ ä¸Šä¼ æœ¬åœ°é•œåƒmyapache:v1åˆ°é•œåƒä»“åº“ä¸­ã€‚ $ docker push myapache:v1 4.4 search docker searchï¼šä»Docker HubæŸ¥æ‰¾æ›´å¤š è¯­æ³• docker search [OPTIONS] TERM é€‰é¡¹è¯´æ˜ï¼š --automatedï¼šåªåˆ—å‡ºè‡ªåŠ¨æ„å»ºç±»å‹çš„é™„åŠ ï¼› --no-truncï¼šæ˜¾ç¤ºå®Œæ•´çš„åŒ…å«æè¿°ï¼› -sï¼šåˆ—å‡ºæ”¶è—è€…æ•°ä¸å°äºæŒ‡å®šå€¼çš„é™„åŠ ã€‚ å®ä¾‹ ä»Docker HubæŸ¥æ‰¾æ‰€æœ‰é¢„æœŸååŒ…å«javaï¼Œå¹¶ä¸”æ”¶è—æ•°å¤§äº10çš„æ›¿ä»£ $ docker search -s 10 java NAME DESCRIPTION STARS OFFICIAL AUTOMATED java Java is a concurrent, class-based... 1037 [OK] anapsix/alpine-java Oracle Java 8 (and 7) with GLIBC ... 115 [OK] develar/java 46 [OK] isuper/java-oracle This repository contains all java... 38 [OK] lwieske/java-8 Oracle Java 8 Container - Full + ... 27 [OK] nimmis/java-centos This is docker images of CentOS 7... 13 [OK] å‚æ•°è¯´æ˜ï¼š NAME: é•œåƒä»“åº“æºçš„åç§° DESCRIPTION: é•œåƒçš„æè¿° OFFICIAL: æ˜¯å¦ docker å®˜æ–¹å‘å¸ƒ stars: ç±»ä¼¼ Github é‡Œé¢çš„ starï¼Œè¡¨ç¤ºç‚¹èµã€å–œæ¬¢çš„æ„æ€ã€‚ AUTOMATED: è‡ªåŠ¨æ„å»ºã€‚ äº”ã€æœ¬åœ°é•œåƒç®¡ç† 5.1 images docker images : åˆ—å‡ºæœ¬åœ°é•œåƒã€‚ è¯­æ³• docker images [OPTIONS] [REPOSITORY[:TAG]] OPTIONSè¯´æ˜ï¼š -a :åˆ—å‡ºæœ¬åœ°æ‰€æœ‰çš„é•œåƒï¼ˆå«ä¸­é—´æ˜ åƒå±‚ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿‡æ»¤æ‰ä¸­é—´æ˜ åƒå±‚ï¼‰ï¼› --digests :æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯ï¼› -f :æ˜¾ç¤ºæ»¡è¶³æ¡ä»¶çš„é•œåƒï¼› --format :æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ï¼› --no-trunc :æ˜¾ç¤ºå®Œæ•´çš„é•œåƒä¿¡æ¯ï¼› -q :åªæ˜¾ç¤ºé•œåƒIDã€‚ å®ä¾‹ æŸ¥çœ‹æœ¬åœ°é•œåƒåˆ—è¡¨ã€‚ $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE mymysql v1 37af1236adef 5 minutes ago 329 MB ... åˆ—å‡ºæœ¬åœ°é•œåƒä¸­REPOSITORYä¸ºubuntuçš„é•œåƒåˆ—è¡¨ã€‚ $ docker images ubuntu REPOSITORY TAG IMAGE ID CREATED SIZE ubuntu 14.04 90d5884b1ee0 9 weeks ago 188 MB ubuntu 15.10 4e3b13c8a266 3 months ago 136.3 MB 5.2 rmi docker rmi : åˆ é™¤æœ¬åœ°ä¸€ä¸ªæˆ–å¤šå°‘é•œåƒã€‚ è¯­æ³• docker rmi [OPTIONS] IMAGE [IMAGE...] OPTIONSè¯´æ˜ï¼š -f :å¼ºåˆ¶åˆ é™¤ï¼› --no-prune :ä¸ç§»é™¤è¯¥é•œåƒçš„è¿‡ç¨‹é•œåƒï¼Œé»˜è®¤ç§»é™¤ï¼› å®ä¾‹ å¼ºåˆ¶åˆ é™¤æœ¬åœ°é•œåƒ runoob/ubuntu:v4ã€‚ $ docker rmi -f runoob/ubuntu:v4 Untagged: runoob/ubuntu:v4 Deleted: sha256:1c06aa18edee44230f93a90a7d88139235de12cd4c089d41eed8419b503072be Deleted: sha256:85feb446e89a28d58ee7d80ea5ce367eebb7cec70f0ec18aa4faa874cbd97c73 5.3 tag docker tag : æ ‡è®°æœ¬åœ°é•œåƒï¼Œå°†å…¶å½’å…¥æŸä¸€ä»“åº“ã€‚ è¯­æ³• docker tag [OPTIONS] IMAGE[:TAG] [REGISTRYHOST/][USERNAME/]NAME[:TAG] å®ä¾‹ å°†é•œåƒubuntu:15.10æ ‡è®°ä¸º runoob/ubuntu:v3 é•œåƒã€‚ $ docker tag ubuntu:15.10 runoob/ubuntu:v3 $ docker images runoob/ubuntu:v3 REPOSITORY TAG IMAGE ID CREATED SIZE runoob/ubuntu v3 4e3b13c8a266 3 months ago 136.3 MB 5.4 build docker build å‘½ä»¤ç”¨äºä½¿ç”¨ Dockerfile åˆ›å»ºé•œåƒã€‚ è¯­æ³• docker build [OPTIONS] PATH | URL | - OPTIONSè¯´æ˜ï¼š --build-arg=[] :è®¾ç½®é•œåƒåˆ›å»ºæ—¶çš„å˜é‡ï¼› --cpu-shares :è®¾ç½® cpu ä½¿ç”¨æƒé‡ï¼› --cpu-period :é™åˆ¶ CPU CFSå‘¨æœŸï¼› --cpu-quota :é™åˆ¶ CPU CFSé…é¢ï¼› --cpuset-cpus :æŒ‡å®šä½¿ç”¨çš„CPU idï¼› --cpuset-mems :æŒ‡å®šä½¿ç”¨çš„å†…å­˜ idï¼› --disable-content-trust :å¿½ç•¥æ ¡éªŒï¼Œé»˜è®¤å¼€å¯ï¼› -f :æŒ‡å®šè¦ä½¿ç”¨çš„Dockerfileè·¯å¾„ï¼› --force-rm :è®¾ç½®é•œåƒè¿‡ç¨‹ä¸­åˆ é™¤ä¸­é—´å®¹å™¨ï¼› --isolation :ä½¿ç”¨å®¹å™¨éš”ç¦»æŠ€æœ¯ï¼› --label=[] :è®¾ç½®é•œåƒä½¿ç”¨çš„å…ƒæ•°æ®ï¼› -m :è®¾ç½®å†…å­˜æœ€å¤§å€¼ï¼› --memory-swap :è®¾ç½®Swapçš„æœ€å¤§å€¼ä¸ºå†…å­˜+swapï¼Œ\"-1\"è¡¨ç¤ºä¸é™swapï¼› --no-cache :åˆ›å»ºé•œåƒçš„è¿‡ç¨‹ä¸ä½¿ç”¨ç¼“å­˜ï¼› --pull :å°è¯•å»æ›´æ–°é•œåƒçš„æ–°ç‰ˆæœ¬ï¼› --quiet, -q :å®‰é™æ¨¡å¼ï¼ŒæˆåŠŸååªè¾“å‡ºé•œåƒ IDï¼› --rm :è®¾ç½®é•œåƒæˆåŠŸååˆ é™¤ä¸­é—´å®¹å™¨ï¼› --shm-size :è®¾ç½®/dev/shmçš„å¤§å°ï¼Œé»˜è®¤å€¼æ˜¯64Mï¼› --ulimit :Ulimité…ç½®ã€‚ --tag, -t: é•œåƒçš„åå­—åŠæ ‡ç­¾ï¼Œé€šå¸¸ name:tag æˆ–è€… name æ ¼å¼ï¼›å¯ä»¥åœ¨ä¸€æ¬¡æ„å»ºä¸­ä¸ºä¸€ä¸ªé•œåƒè®¾ç½®å¤šä¸ªæ ‡ç­¾ã€‚ --network: é»˜è®¤ defaultã€‚åœ¨æ„å»ºæœŸé—´è®¾ç½®RUNæŒ‡ä»¤çš„ç½‘ç»œæ¨¡å¼ å®ä¾‹ ä½¿ç”¨å½“å‰ç›®å½•çš„ Dockerfile åˆ›å»ºé•œåƒï¼Œæ ‡ç­¾ä¸º runoob/ubuntu:v1ã€‚ $ docker build -t runoob/ubuntu:v1 . ä½¿ç”¨URL github.com/creack/docker-firefox çš„ Dockerfile åˆ›å»ºé•œåƒã€‚ $ docker build github.com/creack/docker-firefox ä¹Ÿå¯ä»¥é€šè¿‡ -f Dockerfile æ–‡ä»¶çš„ä½ç½®ï¼š $ docker build -f /path/to/a/Dockerfile . åœ¨ Docker å®ˆæŠ¤è¿›ç¨‹æ‰§è¡Œ Dockerfile ä¸­çš„æŒ‡ä»¤å‰ï¼Œé¦–å…ˆä¼šå¯¹ Dockerfile è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼Œæœ‰è¯­æ³•é”™è¯¯æ—¶ä¼šè¿”å›ï¼š $ docker build -t test/myapp . Sending build context to Docker daemon 2.048 kB Error response from daemon: Unknown instruction: RUNCMD 5.5 history docker history : æŸ¥çœ‹æŒ‡å®šé•œåƒçš„åˆ›å»ºå†å²ã€‚ è¯­æ³• docker history [OPTIONS] IMAGE OPTIONSè¯´æ˜ï¼š -H :ä»¥å¯è¯»çš„æ ¼å¼æ‰“å°é•œåƒå¤§å°å’Œæ—¥æœŸï¼Œé»˜è®¤ä¸ºtrue --no-trunc :æ˜¾ç¤ºå®Œæ•´çš„æäº¤è®°å½•ï¼› -q :ä»…åˆ—å‡ºæäº¤è®°å½•IDã€‚ å®ä¾‹ æŸ¥çœ‹æœ¬åœ°é•œåƒrunoob/ubuntu:v3çš„åˆ›å»ºå†å²ã€‚ $ docker history runoob/ubuntu:v3 IMAGE CREATED CREATED BY SIZE COMMENT 4e3b13c8a266 3 months ago /bin/sh -c #(nop) CMD [\"/bin/bash\"] 0 B 3 months ago /bin/sh -c sed -i 's/^#\\s*\\(deb.*universe\\)$/ 1.863 kB 3 months ago /bin/sh -c set -xe && echo '#!/bin/sh' > /u 701 B 3 months ago /bin/sh -c #(nop) ADD file:43cb048516c6b80f22 136.3 MB 5.6 save docker save : å°†æŒ‡å®šé•œåƒä¿å­˜æˆ tar å½’æ¡£æ–‡ä»¶ã€‚ è¯­æ³• docker save [OPTIONS] IMAGE [IMAGE...] OPTIONS è¯´æ˜ï¼š -o :è¾“å‡ºåˆ°çš„æ–‡ä»¶ã€‚ å®ä¾‹ å°†é•œåƒ runoob/ubuntu:v3 ç”Ÿæˆ my_ubuntu_v3.tar æ–‡æ¡£ $ docker save -o my_ubuntu_v3.tar runoob/ubuntu:v3 runoob@runoob:~$ ll my_ubuntu_v3.tar -rw------- 1 runoob runoob 142102016 Jul 11 01:37 my_ubuntu_v3.ta 5.7 load docker load : å¯¼å…¥ä½¿ç”¨ docker save å‘½ä»¤å¯¼å‡ºçš„é•œåƒã€‚ è¯­æ³• docker load [OPTIONS] OPTIONS è¯´æ˜ï¼š --input , -i : æŒ‡å®šå¯¼å…¥çš„æ–‡ä»¶ï¼Œä»£æ›¿ STDINã€‚ --quiet , -q : ç²¾ç®€è¾“å‡ºä¿¡æ¯ã€‚ å®ä¾‹ å¯¼å…¥é•œåƒï¼š #æŸ¥çœ‹é•œåƒ $ docker image ls REPOSITORY TAG IMAGE ID CREATED SIZE #å¯¼å…¥é•œåƒ $ docker load 5.8 import docker import : ä»å½’æ¡£æ–‡ä»¶ä¸­åˆ›å»ºé•œåƒã€‚ è¯­æ³• docker import [OPTIONS] file|URL|- [REPOSITORY[:TAG]] OPTIONSè¯´æ˜ï¼š -c :åº”ç”¨docker æŒ‡ä»¤åˆ›å»ºé•œåƒï¼› -m :æäº¤æ—¶çš„è¯´æ˜æ–‡å­—ï¼› å®ä¾‹ ä»é•œåƒå½’æ¡£æ–‡ä»¶my_ubuntu_v3.taråˆ›å»ºé•œåƒï¼Œå‘½åä¸ºrunoob/ubuntu:v4 $ docker import my_ubuntu_v3.tar runoob/ubuntu:v4 sha256:63ce4a6d6bc3fabb95dbd6c561404a309b7bdfc4e21c1d59fe9fe4299cbfea39 runoob@runoob:~$ docker images runoob/ubuntu:v4 REPOSITORY TAG IMAGE ID CREATED SIZE runoob/ubuntu v4 63ce4a6d6bc3 20 seconds ago 142.1 MB å…­ã€info|version 6.1 info docker info : æ˜¾ç¤º Docker ç³»ç»Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬é•œåƒå’Œå®¹å™¨æ•°ã€‚ã€‚ è¯­æ³• docker info [OPTIONS] å®ä¾‹ æŸ¥çœ‹dockerç³»ç»Ÿä¿¡æ¯ã€‚ $ docker info Containers: 12 Images: 41 Storage Driver: aufs Root Dir: /var/lib/docker/aufs Backing Filesystem: extfs Dirs: 66 Dirperm1 Supported: false Execution Driver: native-0.2 Logging Driver: json-file Kernel Version: 3.13.0-32-generic Operating System: Ubuntu 14.04.1 LTS CPUs: 1 Total Memory: 1.954 GiB Name: iZ23mtq8bs1Z ID: M5N4:K6WN:PUNC:73ZN:AONJ:AUHL:KSYH:2JPI:CH3K:O4MK:6OCX:5OYW 6.2 version ocker version :æ˜¾ç¤º Docker ç‰ˆæœ¬ä¿¡æ¯ã€‚ è¯­æ³• docker version [OPTIONS] OPTIONSè¯´æ˜ï¼š -f :æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ã€‚ å®ä¾‹ æ˜¾ç¤º Docker ç‰ˆæœ¬ä¿¡æ¯ã€‚ $ docker version Client: Docker Engine - Community Version: 19.03.3 API version: 1.40 Go version: go1.12.10 Git commit: a872fc2f86 Built: Tue Oct 8 00:58:10 2019 OS/Arch: linux/amd64 Experimental: false Server: Docker Engine - Community Engine: Version: 19.03.3 API version: 1.40 (minimum version 1.12) Go version: go1.12.10 Git commit: a872fc2f86 Built: Tue Oct 8 00:56:46 2019 OS/Arch: linux/amd64 Experimental: false containerd: Version: 1.2.6 GitCommit: 894b81a4b802e4eb2a91d1ce216b8817763c29fb runc: Version: 1.0.0-rc8 GitCommit: 425e105d5a03fabd737a126ad93d62a9eeede87f docker-init: Version: 0.18.0 GitCommit: fec3683 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sä»‹ç»åŠç»„ä»¶/Kubernetesä»‹ç».html":{"url":"linux/k8s/k8sä»‹ç»åŠç»„ä»¶/Kubernetesä»‹ç».html","title":"k8sä»‹ç»","keywords":"","body":"ä¸€ã€Kubernetesä»‹ç» å‚è€ƒæ–‡æ¡£ï¼š What is Kubernetes Kubernetesæ˜¯ä¸€ä¸ªå¯ä»¥ç§»æ¤ã€å¯æ‰©å±•çš„å¼€æºå¹³å°ï¼Œä½¿ç”¨ å£°æ˜å¼çš„é…ç½® å¹¶ä¾æ®é…ç½®ä¿¡æ¯è‡ªåŠ¨åœ°æ‰§è¡Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†ã€‚åœ¨æ‰€æœ‰çš„å®¹å™¨ç¼–æ’å·¥å…·ä¸­ï¼ˆç±»ä¼¼çš„è¿˜æœ‰ docker swarm / mesosç­‰ï¼‰ï¼ŒKubernetesçš„ç”Ÿæ€ç³»ç»Ÿæ›´å¤§ã€å¢é•¿æ›´å¿«ï¼Œæœ‰æ›´å¤šçš„æ”¯æŒã€æœåŠ¡å’Œå·¥å…·å¯ä¾›ç”¨æˆ·é€‰æ‹©ã€‚ Kubernetesçš„åå­—èµ·æºäºå¸Œè…Šè¯­ï¼Œå«ä¹‰æ˜¯ èˆµæ‰‹ã€é¢†èˆªå‘˜ã€å‘å¯¼ã€‚Googleäº2014å¹´å°†Brogç³»ç»Ÿå¼€æºä¸ºKubernetesã€‚Kubernetesæ„å»ºåœ¨Google Brog åäº”å¹´è¿è¡Œå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç»éªŒ åŸºç¡€ä¹‹ä¸Šï¼Œå¹¶ç»“åˆäº†å¼€æºç¤¾åŒºæœ€å¥½çš„æƒ³æ³•å’Œå®è·µã€‚ ä»¥ä¸‹æ˜¯ä½¿ç”¨ google trends å¯¹æ¯” kubernetes ã€ docker swarmã€ mesos ä¸‰ä¸ªå…³é”®è¯çš„æˆªå›¾ã€‚ å›é¡¾ ä¸ºäº†ç†è§£Kubernetesçš„ç”¨å¤„ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹å†å²ã€‚ å¤§è‡´æ¥è¯´ï¼Œåœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ–¹å¼ä¸Šï¼Œæˆ‘ä»¬ä¸»è¦ç»å†äº†ä¸‰ä¸ªæ—¶ä»£ï¼š ä¼ ç»Ÿéƒ¨ç½²æ—¶ä»£ï¼šæ—©æœŸï¼Œä¼ä¸šç›´æ¥å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ç‰©ç†æœºä¸Šã€‚ç”±äºç‰©ç†æœºä¸Šä¸èƒ½ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰èµ„æºä½¿ç”¨è¾¹ç•Œï¼Œæˆ‘ä»¬ä¹Ÿå°±å¾ˆéš¾åˆç†åœ°åˆ†é…è®¡ç®—èµ„æºã€‚ä¾‹å¦‚ï¼šå¦‚æœå¤šä¸ªåº”ç”¨ç¨‹åºè¿è¡Œåœ¨åŒä¸€å°ç‰©ç†æœºä¸Šï¼Œå¯èƒ½å‘ç”Ÿè¿™æ ·çš„æƒ…å†µï¼šå…¶ä¸­çš„ä¸€ä¸ªåº”ç”¨ç¨‹åºæ¶ˆè€—äº†å¤§å¤šæ•°çš„è®¡ç®—èµ„æºï¼Œå¯¼è‡´å…¶ä»–åº”ç”¨ç¨‹åºä¸èƒ½æ­£å¸¸è¿è¡Œã€‚åº”å¯¹æ­¤é—®é¢˜çš„ä¸€ç§è§£å†³åŠæ³•æ˜¯ï¼Œå°†æ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿è¡Œåœ¨ä¸åŒçš„ç‰©ç†æœºä¸Šã€‚ç„¶è€Œï¼Œè¿™ç§åšæ³•æ— æ³•å¤§è§„æ¨¡å®æ–½ï¼Œå› ä¸ºèµ„æºåˆ©ç”¨ç‡å¾ˆä½ï¼Œä¸”ä¼ä¸šç»´æŠ¤æ›´å¤šç‰©ç†æœºçš„æˆæœ¬æ˜‚è´µã€‚ è™šæ‹ŸåŒ–éƒ¨ç½²æ—¶ä»£ï¼šé’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œè™šæ‹ŸåŒ–æŠ€æœ¯åº”è¿è€Œç”Ÿã€‚ç”¨æˆ·å¯ä»¥åœ¨å•å°ç‰©ç†æœºçš„CPUä¸Šè¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºï¼ˆVirtual Machineï¼‰ã€‚ è™šæ‹ŸåŒ–æŠ€æœ¯ä½¿å¾—åº”ç”¨ç¨‹åºè¢«è™šæ‹Ÿæœºç›¸äº’åˆ†éš”å¼€ï¼Œé™åˆ¶äº†åº”ç”¨ç¨‹åºä¹‹é—´çš„éæ³•è®¿é—®ï¼Œè¿›è€Œæä¾›äº†ä¸€å®šç¨‹åº¦çš„å®‰å…¨æ€§ã€‚ è™šæ‹ŸåŒ–æŠ€æœ¯æé«˜äº†ç‰©ç†æœºçš„èµ„æºåˆ©ç”¨ç‡ï¼Œå¯ä»¥æ›´å®¹æ˜“åœ°å®‰è£…æˆ–æ›´æ–°åº”ç”¨ç¨‹åºï¼Œé™ä½äº†ç¡¬ä»¶æˆæœ¬ï¼Œå› æ­¤å¯ä»¥æ›´å¥½åœ°è§„æ¨¡åŒ–å®æ–½ã€‚ æ¯ä¸€ä¸ªè™šæ‹Ÿæœºå¯ä»¥è®¤ä¸ºæ˜¯è¢«è™šæ‹ŸåŒ–çš„ç‰©ç†æœºä¹‹ä¸Šçš„ä¸€å°å®Œæ•´çš„æœºå™¨ï¼Œå…¶ä¸­è¿è¡Œäº†ä¸€å°æœºå™¨çš„æ‰€æœ‰ç»„ä»¶ï¼ŒåŒ…æ‹¬è™šæ‹Ÿæœºè‡ªèº«çš„æ“ä½œç³»ç»Ÿã€‚ å®¹å™¨åŒ–éƒ¨ç½²æ—¶ä»£ï¼šå®¹å™¨ä¸è™šæ‹Ÿæœºç±»ä¼¼ï¼Œä½†æ˜¯é™ä½äº†éš”ç¦»å±‚çº§ï¼Œå…±äº«äº†æ“ä½œç³»ç»Ÿã€‚å› æ­¤ï¼Œå®¹å™¨å¯ä»¥è®¤ä¸ºæ˜¯è½»é‡çº§çš„ã€‚ ä¸è™šæ‹Ÿæœºç›¸ä¼¼ï¼Œæ¯ä¸ªå®¹å™¨æ‹¥æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜ã€è¿›ç¨‹ç©ºé—´ç­‰ è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„èµ„æºéƒ½è¢«å®¹å™¨åŒ…è£…ï¼Œå¹¶å’Œåº•å±‚åŸºç¡€æ¶æ„è§£è€¦ å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºå¯ä»¥è·¨äº‘æœåŠ¡å•†ã€è·¨Linuxæ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆè¿›è¡Œéƒ¨ç½² å®¹å™¨åŒ–è¶Šæ¥è¶Šæµè¡Œï¼Œä¸»è¦åŸå› æ˜¯å®ƒå¸¦æ¥çš„è¯¸å¤šå¥½å¤„ï¼š æ•æ·åœ°åˆ›å»ºå’Œéƒ¨ç½²åº”ç”¨ç¨‹åºï¼šç›¸è¾ƒäºåˆ›å»ºè™šæ‹Ÿæœºé•œåƒï¼Œåˆ›å»ºå®¹å™¨é•œåƒæ›´åŠ å®¹æ˜“å’Œå¿«é€Ÿ æŒç»­æ„å»ºé›†æˆï¼šå¯ä»¥æ›´å¿«æ›´é¢‘ç¹åœ°æ„å»ºå®¹å™¨é•œåƒã€éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºã€å¹¶ä¸”è½»æ¾åœ°å›æ»šåº”ç”¨ç¨‹åº åˆ†ç¦»å¼€å‘å’Œè¿ç»´çš„å…³æ³¨ç‚¹ï¼šåœ¨å¼€å‘æ„å»ºé˜¶æ®µå°±å®Œæˆå®¹å™¨é•œåƒçš„æ„å»ºï¼Œæ„å»ºå¥½çš„é•œåƒå¯ä»¥éƒ¨ç½²åˆ°å¤šç§åŸºç¡€è®¾æ–½ä¸Šã€‚è¿™ç§åšæ³•å°†å¼€å‘é˜¶æ®µéœ€è¦å…³æ³¨çš„å†…å®¹åŒ…å«åœ¨å¦‚ä½•æ„å»ºå®¹å™¨é•œåƒçš„è¿‡ç¨‹ä¸­ï¼Œå°†éƒ¨ç½²é˜¶æ®µéœ€è¦å…³æ³¨çš„å†…å®¹èšç„¦åœ¨å¦‚ä½•æä¾›åŸºç¡€è®¾æ–½ä»¥åŠå¦‚ä½•ä½¿ç”¨å®¹å™¨é•œåƒçš„è¿‡ç¨‹ä¸­ã€‚é™ä½äº†å¼€å‘å’Œè¿ç»´çš„è€¦åˆåº¦ å¯ç›‘æ§æ€§ï¼šä¸ä»…å¯ä»¥æŸ¥çœ‹æ“ä½œç³»ç»Ÿçº§åˆ«çš„èµ„æºç›‘æ§ä¿¡æ¯ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹åº”ç”¨ç¨‹åºå¥åº·çŠ¶æ€ä»¥åŠå…¶ä»–ä¿¡å·çš„ç›‘æ§ä¿¡æ¯ å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ä¸åŒé˜¶æ®µçš„ç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘é˜¶æ®µåœ¨ç¬”è®°æœ¬ä¸Šè¿è¡Œçš„å®¹å™¨ä¸æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œçš„å®¹å™¨ä¸€è‡´ è·¨äº‘æœåŠ¡å•†ã€è·¨æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆçš„å¯ç§»æ¤æ€§ï¼šå®¹å™¨å¯è¿è¡Œåœ¨ Ubuntuã€RHELã€CoreOSã€CentOSç­‰ä¸åŒçš„æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆä¸Šï¼Œå¯ä»¥è¿è¡Œåœ¨ç§æœ‰åŒ–éƒ¨ç½²ã€Google Kubernetes Engineã€AWSã€é˜¿é‡Œäº‘ç­‰ä¸åŒçš„äº‘ä¾›åº”å•†çš„ç¯å¢ƒä¸­ ä»¥åº”ç”¨ç¨‹åºä¸ºä¸­å¿ƒçš„ç®¡ç†ï¼šè™šæ‹Ÿæœºæ—¶ä»£çš„è€ƒè™‘çš„é—®é¢˜æ˜¯åœ¨è™šæ‹Ÿç¡¬ä»¶ä¸Šè¿è¡Œä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œè€Œå®¹å™¨åŒ–æ—¶ä»£ï¼Œé—®é¢˜çš„ç„¦ç‚¹åˆ™æ˜¯åœ¨æ“ä½œç³»ç»Ÿçš„é€»è¾‘èµ„æºä¸Šè¿è¡Œä¸€ä¸ªåº”ç”¨ç¨‹åº æ¾è€¦åˆã€åˆ†å¸ƒå¼ã€å¼¹æ€§ã€æ— çº¦æŸçš„å¾®æœåŠ¡ï¼šåº”ç”¨ç¨‹åºè¢«åˆ‡åˆ†æˆæ›´å°çš„ã€ç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œå¹¶å¯ä»¥åŠ¨æ€éƒ¨ç½²å’Œç®¡ç†ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªéƒ¨ç½²åœ¨ä¸“å±æœºå™¨ä¸Šçš„åºå¤§çš„å•ç‰‡åº”ç”¨ç¨‹åº èµ„æºéš”ç¦»ï¼šç¡®ä¿åº”ç”¨ç¨‹åºæ€§èƒ½ä¸å—å¹²æ‰° èµ„æºåˆ©ç”¨ï¼šèµ„æºé«˜æ•ˆã€é«˜å¯†åº¦åˆ©ç”¨ äºŒã€Kubernetesçš„åŠŸèƒ½ å®¹å™¨æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ‰“åŒ…å¹¶è¿è¡Œåº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ‚¨éœ€è¦ç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”ç¡®ä¿å…¶ä¸åœæœºåœ°è¿ç»­è¿è¡Œã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªå®¹å™¨æ•…éšœåœæœºï¼Œå¦å¤–ä¸€ä¸ªå®¹å™¨éœ€è¦ç«‹åˆ»å¯åŠ¨ä»¥æ›¿è¡¥åœæœºçš„å®¹å™¨ã€‚ç±»ä¼¼çš„è¿™ç§å¯¹å®¹å™¨çš„ç®¡ç†åŠ¨ä½œç”±ç³»ç»Ÿæ¥æ‰§è¡Œä¼šæ›´å¥½æ›´å¿«é€Ÿã€‚ Kubernetesé’ˆå¯¹æ­¤ç±»é—®é¢˜ï¼Œæä¾›äº†å®¹å™¨åŒ–ç¼–æ’è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿ä½ éå¸¸å¥å£®åœ°è¿è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿã€‚Kuberneteså¯ä»¥å¤„ç†åº”ç”¨ç¨‹åºçš„ä¼¸ç¼©ã€failoverã€éƒ¨ç½²æ¨¡å¼ç­‰å¤šç§éœ€æ±‚ã€‚ä¾‹å¦‚ï¼ŒKuberneteså¯ä»¥è½»æ˜“åœ°ç®¡ç†ç³»ç»Ÿçš„é‡‘ä¸é›€å‘å¸ƒï¼ˆç°åº¦å‘å¸ƒï¼‰ã€‚ Kubernetesæä¾›çš„ç‰¹æ€§æœ‰ï¼š æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ Kubernetes å¯ä»¥é€šè¿‡ DNS åç§°æˆ– IP åœ°å€æš´éœ²å®¹å™¨çš„è®¿é—®æ–¹å¼ã€‚å¹¶ä¸”å¯ä»¥åœ¨åŒç»„å®¹å™¨å†…åˆ†å‘è´Ÿè½½ä»¥å®ç°è´Ÿè½½å‡è¡¡ å­˜å‚¨ç¼–æ’ Kuberneteså¯ä»¥è‡ªåŠ¨æŒ‚è½½æŒ‡å®šçš„å­˜å‚¨ç³»ç»Ÿï¼Œä¾‹å¦‚ local stroage/nfs/äº‘å­˜å‚¨ç­‰ è‡ªåŠ¨å‘å¸ƒå’Œå›æ»š æ‚¨å¯ä»¥åœ¨ Kubernetes ä¸­å£°æ˜æ‚¨æœŸæœ›åº”ç”¨ç¨‹åºå®¹å™¨åº”è¯¥è¾¾åˆ°çš„çŠ¶æ€ï¼ŒKuberneteså°†ä»¥åˆé€‚çš„é€Ÿç‡è°ƒæ•´å®¹å™¨çš„å®é™…çŠ¶æ€ï¼Œå¹¶é€æ­¥è¾¾åˆ°æœ€ç»ˆæœŸæœ›çš„ç»“æœã€‚è¯·å‚è€ƒ å£°æ˜å¼çš„é…ç½® è‡ªæ„ˆ Kubernetesæä¾›å¦‚ä¸‹è‡ªæ„ˆèƒ½åŠ›ï¼š é‡å¯å·²ç»åœæœºçš„å®¹å™¨ æ›¿æ¢ã€kill é‚£äº›ä¸æ»¡è¶³è‡ªå®šä¹‰å¥åº·æ£€æŸ¥æ¡ä»¶çš„å®¹å™¨ åœ¨å®¹å™¨å°±ç»ªä¹‹å‰ï¼Œé¿å…è°ƒç”¨è€…å‘ç°è¯¥å®¹å™¨ å¯†é’¥åŠé…ç½®ç®¡ç† Kuberneteså¯ä»¥å­˜å‚¨å’Œç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œå¯†ç ã€OAuth tokenã€sshå¯†é’¥ç­‰ï¼‰ã€‚æ‚¨å¯ä»¥æ›´æ–°å®¹å™¨åº”ç”¨ç¨‹åºçš„å¯†é’¥ã€é…ç½®ç­‰ä¿¡æ¯ï¼Œè€Œæ— éœ€ï¼š é‡æ–°æ„å»ºå®¹å™¨çš„é•œåƒ åœ¨ä¸åˆé€‚çš„åœ°æ–¹æš´éœ²å¯†ç ä¿¡æ¯ ä¸‰ã€Kubernetesçš„è¾¹ç•Œ Kubernetesä¸æ˜¯ä¸€ä¸ªä¼ ç»Ÿæ„ä¹‰çš„ã€ä¿ç½—ä¸‡è±¡çš„ PaaSï¼ˆPlatform as a Serviceï¼‰ç³»ç»Ÿã€‚Kubernetesåœ¨å®¹å™¨å±‚é¢å·¥ä½œï¼Œè€Œä¸æ˜¯ç¡¬ä»¶å±‚é¢ï¼Œå®ƒæä¾›äº†ä¸ PaaS å¹³å°ç›¸ä¼¼çš„é€šç”¨ç‰¹æ€§ï¼Œä¾‹å¦‚ï¼šéƒ¨ç½²ã€ä¼¸ç¼©ã€è´Ÿè½½å‡è¡¡ã€æ—¥å¿—ã€ç›‘æ§ç­‰ã€‚ç„¶è€Œï¼ŒKuberneteså¹¶ä¸æ˜¯ä¸€ä¸ªå•ä¸€æ•´ä½“ï¼Œè¿™äº›ç‰¹æ€§éƒ½æ˜¯å¯é€‰ã€å¯æ’æ‹”çš„ã€‚Kubernetesæä¾›ç”¨äºæ­å»ºå¼€å‘å¹³å°çš„åŸºç¡€æ¨¡å—ï¼ŒåŒæ—¶ä¸ºç”¨æˆ·æä¾›äº†ä¸åŒæ¨¡å—çš„é€‰æ‹©æ€§å’Œå¤šæ ·æ€§ã€‚ Kubernetesï¼š ä¸é™åˆ¶åº”ç”¨ç¨‹åºçš„ç±»å‹ã€‚Kubernetesçš„ç›®æ ‡æ˜¯å¹¿æ³›æ”¯æŒä¸åŒç±»å‹çš„å·¥ä½œè´Ÿè½½ï¼ŒåŒ…æ‹¬ï¼šæœ‰çŠ¶æ€ã€æ— çŠ¶æ€ã€æ•°æ®å¤„ç†ç­‰ç±»å‹çš„åº”ç”¨ã€‚åªè¦åº”ç”¨å¯ä»¥åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œå°±èƒ½å¤Ÿéå¸¸å¥½åœ°åœ¨ Kubernetes ä¸Šè¿è¡Œ ä¸éƒ¨ç½²æºç ã€ä¸ç¼–è¯‘æˆ–æ„å»ºåº”ç”¨ç¨‹åºã€‚æŒç»­é›†æˆã€åˆ†å‘ã€éƒ¨ç½²ï¼ˆCI/CDï¼‰çš„å·¥ä½œæµæå¤§ç¨‹åº¦ä¸Šå–å†³äºç»„ç»‡çš„æ–‡åŒ–ã€åå¥½ä»¥åŠæŠ€æœ¯è¦æ±‚ã€‚Kuberneteså¯ä»¥ä½œä¸ºéƒ¨ç½²å¹³å°å‚ä¸åˆ° CI/CD æµç¨‹ï¼Œä½†æ˜¯ä¸æ¶‰åŠé•œåƒæ„å»ºå’Œåˆ†å‘çš„è¿‡ç¨‹ è¯‘è€…æ³¨ï¼šå¯é€‰çš„æœ‰ Jenkins / Gitlab Runner / docker registry / harbour ç­‰ ä¸æä¾›åº”ç”¨ç¨‹åºçº§åˆ«çš„æœåŠ¡ï¼ŒåŒ…æ‹¬ï¼šä¸­é—´ä»¶ï¼ˆä¾‹å¦‚ï¼Œæ¶ˆæ¯æ€»çº¿ï¼‰ã€æ•°æ®å¤„ç†æ¡†æ¶ï¼ˆä¾‹å¦‚ï¼ŒSparkï¼‰ã€æ•°æ®åº“ï¼ˆä¾‹å¦‚ï¼Œmysqlï¼‰ã€ç¼“å­˜ï¼ˆä¾‹å¦‚ï¼ŒRedisï¼‰ï¼Œæˆ–è€…åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆä¾‹å¦‚ï¼ŒCephï¼‰ã€‚æ­¤ç±»ç»„ä»¶å¯ä»¥åœ¨ Kubernetes ä¸Šè¿è¡Œï¼Œæˆ–è€…å¯ä»¥è¢«è¿è¡Œåœ¨ Kubernetes ä¸Šçš„åº”ç”¨ç¨‹åºè®¿é—® ä¸é™å®šæ—¥å¿—ã€ç›‘æ§ã€æŠ¥è­¦çš„è§£å†³æ–¹æ¡ˆã€‚Kubernetes æä¾›ä¸€äº›æ ·ä¾‹å±•ç¤ºå¦‚ä½•ä¸æ—¥å¿—ã€ç›‘æ§ã€æŠ¥è­¦ç­‰ç»„ä»¶é›†æˆï¼ŒåŒæ—¶æä¾›æ”¶é›†ã€å¯¼å‡ºç›‘æ§åº¦é‡ï¼ˆmetricsï¼‰çš„ä¸€å¥—æœºåˆ¶ã€‚æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©æ—¥å¿—ã€ç›‘æ§ã€æŠ¥è­¦ç»„ä»¶ è¯‘è€…æ³¨ï¼šå¯é€‰çš„æœ‰ ELK / Prometheus / Graphana / Pinpoint / Skywalking / Metrics Server ç­‰ ä¸æä¾›æˆ–è€…é™å®šé…ç½®è¯­è¨€ï¼ˆä¾‹å¦‚ï¼Œjsonnetï¼‰ã€‚Kubernetesæä¾›ä¸€ç»„å£°æ˜å¼çš„ APIï¼Œæ‚¨å¯ä»¥æŒ‰ç…§è‡ªå·±çš„æ–¹å¼å®šä¹‰éƒ¨ç½²ä¿¡æ¯ã€‚ è¯‘è€…æ³¨ï¼šå¯é€‰çš„æœ‰ helm/kustomize/kubectl/kubernetes dashboard/kuboard/octant/k9s ç­‰ ä¸æä¾›æˆ–é™å®šä»»ä½•æœºå™¨çš„é…ç½®ã€ç»´æŠ¤ã€ç®¡ç†æˆ–è‡ªæ„ˆçš„ç³»ç»Ÿã€‚ è¯‘è€…æ³¨ï¼šåœ¨è¿™ä¸ªçº§åˆ«ä¸Šï¼Œå¯é€‰çš„ç»„ä»¶æœ‰ puppetã€ansibleã€open stack ç­‰ æ­¤å¤–ï¼ŒKubernetesä¸æ˜¯ä¸€ä¸ªçº¯ç²¹æ„ä¹‰ä¸Šçš„å®¹å™¨ç¼–æ’ç³»ç»Ÿã€‚äº‹å®ä¸Šï¼ŒKubernetes æ¶ˆé™¤äº†å®¹å™¨ç¼–æ’çš„éœ€æ±‚ã€‚å®¹å™¨ç¼–æ’çš„æŠ€æœ¯å®šä¹‰æ˜¯é¢„å®šä¹‰æµç¨‹çš„æ‰§è¡Œï¼ˆå…ˆåšAã€å†åšBã€ç„¶ååšCï¼‰ã€‚ä¸æ­¤ç›¸å¯¹åº”ï¼ŒKubernetesæ„å»ºäº†ä¸€ç³»åˆ—ç›¸äº’ç‹¬ç«‹ã€å¯é¢„æ’çš„æ§åˆ¶è¿‡ç¨‹ï¼Œä»¥æŒç»­ä¸æ–­åœ°å°†ç³»ç»Ÿä»å½“å‰çŠ¶æ€è°ƒæ•´åˆ°å£°æ˜çš„ç›®æ ‡çŠ¶æ€ã€‚å¦‚ä½•ä» A è¾¾åˆ° Cï¼Œå¹¶ä¸é‡è¦ã€‚é›†ä¸­åŒ–çš„æ§åˆ¶ä¹Ÿå°±ä¸éœ€è¦äº†ã€‚è¿™ä¸ªè®¾è®¡æ€æƒ³ä½¿å¾—Kubernetesä½¿ç”¨æ›´ç®€å•ã€æ›´å¼ºå¤§ã€ç¨³å¥ã€åè„†å¼±å’Œå¯æ‰©å±•ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sä»‹ç»åŠç»„ä»¶/Kubernetesç»„ä»¶.html":{"url":"linux/k8s/k8sä»‹ç»åŠç»„ä»¶/Kubernetesç»„ä»¶.html","title":"k8sç»„ä»¶","keywords":"","body":"Kubernetesç»„ä»¶ æœ¬æ–‡ä¸¥é‡æŠ„è¢­äºkuboard.cn) å‚è€ƒæ–‡æ¡£ï¼š Kubernetes Components æœ¬æ–‡æ¡£æè¿°äº† Kubernetes çš„ä¸»è¦ç»„ä»¶ã€‚ Masterç»„ä»¶ Masterç»„ä»¶æ˜¯é›†ç¾¤çš„æ§åˆ¶å¹³å°ï¼ˆcontrol planeï¼‰ï¼š master ç»„ä»¶è´Ÿè´£é›†ç¾¤ä¸­çš„å…¨å±€å†³ç­–ï¼ˆä¾‹å¦‚ï¼Œè°ƒåº¦ï¼‰ master ç»„ä»¶æ¢æµ‹å¹¶å“åº”é›†ç¾¤äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼Œå½“ Deployment çš„å®é™… Pod å‰¯æœ¬æ•°æœªè¾¾åˆ° replicas å­—æ®µçš„è§„å®šæ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªæ–°çš„ Podï¼‰ Masterç»„ä»¶å¯ä»¥è¿è¡Œäºé›†ç¾¤ä¸­çš„ä»»ä½•æœºå™¨ä¸Šã€‚ä½†æ˜¯ï¼Œä¸ºäº†ç®€æ´æ€§ï¼Œé€šå¸¸åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œæ‰€æœ‰çš„ master ç»„ä»¶ï¼Œä¸”ä¸åœ¨æ­¤æœºå™¨ä¸Šè¿è¡Œç”¨æˆ·çš„å®¹å™¨ã€‚å‚è€ƒ å®‰è£…Kubernetesé«˜å¯ç”¨ã€‚ kube-apiserver æ­¤ master ç»„ä»¶æä¾› Kubernetes APIã€‚è¿™æ˜¯Kubernetesæ§åˆ¶å¹³å°çš„å‰ç«¯ï¼ˆfront-endï¼‰ï¼Œå¯ä»¥æ°´å¹³æ‰©å±•ï¼ˆé€šè¿‡éƒ¨ç½²æ›´å¤šçš„å®ä¾‹ä»¥è¾¾åˆ°æ€§èƒ½è¦æ±‚ï¼‰ã€‚kubectl / kubernetes dashboard / kuboard ç­‰Kubernetesç®¡ç†å·¥å…·å°±æ˜¯é€šè¿‡ kubernetes API å®ç°å¯¹ Kubernetes é›†ç¾¤çš„ç®¡ç†ã€‚ etcd æ”¯æŒä¸€è‡´æ€§å’Œé«˜å¯ç”¨çš„åå€¼å¯¹å­˜å‚¨ç»„ä»¶ï¼ŒKubernetesé›†ç¾¤çš„æ‰€æœ‰é…ç½®ä¿¡æ¯éƒ½å­˜å‚¨åœ¨ etcd ä¸­ã€‚è¯·ç¡®ä¿æ‚¨ å¤‡ä»½ äº† etcd çš„æ•°æ®ã€‚å…³äº etcd çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚è€ƒ etcd å®˜æ–¹æ–‡æ¡£ kube-scheduler æ­¤ master ç»„ä»¶ç›‘æ§æ‰€æœ‰æ–°åˆ›å»ºå°šæœªåˆ†é…åˆ°èŠ‚ç‚¹ä¸Šçš„ Podï¼Œå¹¶ä¸”è‡ªåŠ¨é€‰æ‹©ä¸º Pod é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹å»è¿è¡Œã€‚ å½±å“è°ƒåº¦çš„å› ç´ æœ‰ï¼š å•ä¸ªæˆ–å¤šä¸ª Pod çš„èµ„æºéœ€æ±‚ ç¡¬ä»¶ã€è½¯ä»¶ã€ç­–ç•¥çš„é™åˆ¶ äº²å’Œä¸åäº²å’Œï¼ˆaffinity and anti-affinityï¼‰çš„çº¦å®š æ•°æ®æœ¬åœ°åŒ–è¦æ±‚ å·¥ä½œè´Ÿè½½é—´çš„ç›¸äº’ä½œç”¨ kube-controller-manager æ­¤ master ç»„ä»¶è¿è¡Œäº†æ‰€æœ‰çš„æ§åˆ¶å™¨ é€»è¾‘ä¸Šæ¥è¯´ï¼Œæ¯ä¸€ä¸ªæ§åˆ¶å™¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä½†æ˜¯ä¸ºäº†é™ä½å¤æ‚åº¦ï¼Œè¿™äº›æ§åˆ¶å™¨éƒ½è¢«åˆå¹¶è¿è¡Œåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œã€‚ kube-controller-manager ä¸­åŒ…å«çš„æ§åˆ¶å™¨æœ‰ï¼š èŠ‚ç‚¹æ§åˆ¶å™¨ï¼š è´Ÿè´£ç›‘å¬èŠ‚ç‚¹åœæœºçš„äº‹ä»¶å¹¶ä½œå‡ºå¯¹åº”å“åº” å‰¯æœ¬æ§åˆ¶å™¨ï¼š è´Ÿè´£ä¸ºé›†ç¾¤ä¸­æ¯ä¸€ä¸ª å‰¯æœ¬æ§åˆ¶å™¨å¯¹è±¡ï¼ˆReplication Controller Objectï¼‰ç»´æŠ¤æœŸæœ›çš„ Pod å‰¯æœ¬æ•° ç«¯ç‚¹ï¼ˆEndpointsï¼‰æ§åˆ¶å™¨ï¼šè´Ÿè´£ä¸ºç«¯ç‚¹å¯¹è±¡ï¼ˆEndpoints Objectï¼Œè¿æ¥ Service å’Œ Podï¼‰èµ‹å€¼ Service Account & Tokenæ§åˆ¶å™¨ï¼š è´Ÿè´£ä¸ºæ–°çš„åç§°ç©ºé—´åˆ›å»º default Service Account ä»¥åŠ API Access Token cloud-controller-manager cloud-controller-manager ä¸­è¿è¡Œäº†ä¸å…·ä½“äº‘åŸºç¡€è®¾æ–½ä¾›åº”å•†äº’åŠ¨çš„æ§åˆ¶å™¨ã€‚è¿™æ˜¯ Kubernetes 1.6 ç‰ˆæœ¬ä¸­å¼•å…¥çš„ç‰¹æ€§ï¼Œå°šå¤„åœ¨ alpha é˜¶æ®µã€‚ cloud-controller-manager åªè¿è¡Œç‰¹å®šäºäº‘åŸºç¡€è®¾æ–½ä¾›åº”å•†çš„æ§åˆ¶å™¨ã€‚å¦‚æœæ‚¨å‚è€ƒ www.kuboard.cn ä¸Šæä¾›çš„æ–‡æ¡£å®‰è£… Kubernetes é›†ç¾¤ï¼Œé»˜è®¤ä¸å®‰è£… cloud-controller-managerã€‚ cloud-controller-manager ä½¿å¾—äº‘ä¾›åº”å•†çš„ä»£ç å’Œ Kubernetes çš„ä»£ç å¯ä»¥å„è‡ªç‹¬ç«‹çš„æ¼”åŒ–ã€‚åœ¨æ­¤ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒKubernetesçš„æ ¸å¿ƒä»£ç æ˜¯ä¾èµ–äºäº‘ä¾›åº”å•†çš„ä»£ç çš„ã€‚åœ¨åç»­çš„ç‰ˆæœ¬ä¸­ï¼Œç‰¹å®šäºäº‘ä¾›åº”å•†çš„ä»£ç å°†ç”±äº‘ä¾›åº”å•†è‡ªè¡Œç»´æŠ¤ï¼Œå¹¶åœ¨è¿è¡ŒKubernetesæ—¶é“¾æ¥åˆ° cloud-controller-managerã€‚ ä»¥ä¸‹æ§åˆ¶å™¨ä¸­åŒ…å«ä¸äº‘ä¾›åº”å•†ç›¸å…³çš„ä¾èµ–ï¼š èŠ‚ç‚¹æ§åˆ¶å™¨ï¼šå½“æŸä¸€ä¸ªèŠ‚ç‚¹åœæ­¢å“åº”æ—¶ï¼Œè°ƒç”¨äº‘ä¾›åº”å•†çš„æ¥å£ï¼Œä»¥æ£€æŸ¥è¯¥èŠ‚ç‚¹çš„è™šæ‹Ÿæœºæ˜¯å¦å·²ç»è¢«äº‘ä¾›åº”å•†åˆ é™¤ è¯‘è€…æ³¨ï¼šç§æœ‰åŒ–éƒ¨ç½²Kubernetesæ—¶ï¼Œæˆ‘ä»¬ä¸çŸ¥é“èŠ‚ç‚¹çš„æ“ä½œç³»ç»Ÿæ˜¯å¦åˆ é™¤ï¼Œæ‰€ä»¥åœ¨ç§»é™¤èŠ‚ç‚¹åï¼Œè¦è‡ªè¡Œé€šè¿‡ kubectl delete node å°†èŠ‚ç‚¹å¯¹è±¡ä» Kubernetes ä¸­åˆ é™¤ è·¯ç”±æ§åˆ¶å™¨ï¼šåœ¨äº‘ä¾›åº”å•†çš„åŸºç¡€è®¾æ–½ä¸­è®¾å®šç½‘ç»œè·¯ç”± è¯‘è€…æ³¨ï¼šç§æœ‰åŒ–éƒ¨ç½²Kubernetesæ—¶ï¼Œéœ€è¦è‡ªè¡Œè§„åˆ’Kubernetesçš„æ‹“æ‰‘ç»“æ„ï¼Œå¹¶åšå¥½è·¯ç”±é…ç½®ï¼Œä¾‹å¦‚ å®‰è£…Kuberneteså•MasterèŠ‚ç‚¹ ä¸­æ‰€ä½œçš„ æœåŠ¡ï¼ˆServiceï¼‰æ§åˆ¶å™¨ï¼šåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤äº‘ä¾›åº”å•†æä¾›çš„è´Ÿè½½å‡è¡¡å™¨ è¯‘è€…æ³¨ï¼šç§æœ‰åŒ–éƒ¨ç½²Kubernetesæ—¶ï¼Œä¸æ”¯æŒ LoadBalancer ç±»å‹çš„ Serviceï¼Œå¦‚éœ€è¦æ­¤ç‰¹æ€§ï¼Œéœ€è¦åˆ›å»º NodePort ç±»å‹çš„ Serviceï¼Œå¹¶è‡ªè¡Œé…ç½®è´Ÿè½½å‡è¡¡å™¨ æ•°æ®å·ï¼ˆVolumeï¼‰æ§åˆ¶å™¨ï¼šåˆ›å»ºã€ç»‘å®šã€æŒ‚è½½æ•°æ®å·ï¼Œå¹¶åè°ƒäº‘ä¾›åº”å•†ç¼–æ’æ•°æ®å· è¯‘è€…æ³¨ï¼šç§æœ‰åŒ–éƒ¨ç½²Kubernetesæ—¶ï¼Œéœ€è¦è‡ªè¡Œåˆ›å»ºå’Œç®¡ç†å­˜å‚¨èµ„æºï¼Œå¹¶é€šè¿‡Kubernetesçš„å­˜å‚¨ç±»ã€å­˜å‚¨å·ã€æ•°æ®å·ç­‰ä¸ä¹‹å…³è” è¯‘è€…æ³¨ï¼šé€šè¿‡ cloud-controller-managerï¼ŒKuberneteså¯ä»¥æ›´å¥½åœ°ä¸äº‘ä¾›åº”å•†ç»“åˆï¼Œä¾‹å¦‚ï¼Œåœ¨é˜¿é‡Œäº‘çš„ Kubernetes æœåŠ¡é‡Œï¼Œæ‚¨å¯ä»¥åœ¨äº‘æ§åˆ¶å°ç•Œé¢ä¸Šè½»æ¾ç‚¹å‡»é¼ æ ‡ï¼Œå³å¯å®Œæˆ Kubernetes é›†ç¾¤çš„åˆ›å»ºå’Œç®¡ç†ã€‚åœ¨ç§æœ‰åŒ–éƒ¨ç½²ç¯å¢ƒæ—¶ï¼Œæ‚¨å¿…é¡»è‡ªè¡Œå¤„ç†æ›´å¤šçš„å†…å®¹ã€‚å¹¸è¿çš„æ˜¯ï¼Œé€šè¿‡åˆé€‚çš„æ•™ç¨‹æŒ‡å¼•ï¼Œè¿™äº›ä»»åŠ¡çš„è¾¾æˆå¹¶ä¸å›°éš¾ã€‚ Node ç»„ä»¶ Node ç»„ä»¶è¿è¡Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ˆåŒ…æ‹¬ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹ï¼‰ï¼Œè´Ÿè´£ç»´æŠ¤è¿è¡Œä¸­çš„ Pod å¹¶æä¾› Kubernetes è¿è¡Œæ—¶ç¯å¢ƒã€‚ kubelet æ­¤ç»„ä»¶æ˜¯è¿è¡Œåœ¨æ¯ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šçš„ä»£ç†ç¨‹åºã€‚å®ƒç¡®ä¿ Pod ä¸­çš„å®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ã€‚Kubelet é€šè¿‡å¤šç§é€”å¾„è·å¾— PodSpec å®šä¹‰ï¼Œå¹¶ç¡®ä¿ PodSpec å®šä¹‰ä¸­æ‰€æè¿°çš„å®¹å™¨å¤„äºè¿è¡Œå’Œå¥åº·çš„çŠ¶æ€ã€‚Kubeletä¸ç®¡ç†ä¸æ˜¯é€šè¿‡ Kubernetes åˆ›å»ºçš„å®¹å™¨ã€‚ kube-proxy kube-proxy æ˜¯ä¸€ä¸ªç½‘ç»œä»£ç†ç¨‹åºï¼Œè¿è¡Œåœ¨é›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ˜¯å®ç° Kubernetes Service æ¦‚å¿µçš„é‡è¦éƒ¨åˆ†ã€‚ kube-proxy åœ¨èŠ‚ç‚¹ä¸Šç»´æŠ¤ç½‘ç»œè§„åˆ™ã€‚è¿™äº›ç½‘ç»œè§„åˆ™ä½¿å¾—æ‚¨å¯ä»¥åœ¨é›†ç¾¤å†…ã€é›†ç¾¤å¤–æ­£ç¡®åœ°ä¸ Pod è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚å¦‚æœæ“ä½œç³»ç»Ÿä¸­å­˜åœ¨ packet filtering layerï¼Œkube-proxy å°†ä½¿ç”¨è¿™ä¸€ç‰¹æ€§ï¼ˆiptablesä»£ç†æ¨¡å¼ï¼‰ï¼Œå¦åˆ™ï¼Œkube-proxyå°†è‡ªè¡Œè½¬å‘ç½‘ç»œè¯·æ±‚ï¼ˆUser spaceä»£ç†æ¨¡å¼ï¼‰ å®¹å™¨å¼•æ“ å®¹å™¨å¼•æ“è´Ÿè´£è¿è¡Œå®¹å™¨ã€‚Kubernetesæ”¯æŒå¤šç§å®¹å™¨å¼•æ“ï¼šDockerã€containerdã€cri-oã€rktlet ä»¥åŠä»»ä½•å®ç°äº† Kuberneteså®¹å™¨å¼•æ“æ¥å£ çš„å®¹å™¨å¼•æ“ Addons Addons ä½¿ç”¨ Kubernetes èµ„æºï¼ˆDaemonSetã€Deploymentç­‰ï¼‰å®ç°é›†ç¾¤çš„åŠŸèƒ½ç‰¹æ€§ã€‚ç”±äºä»–ä»¬æä¾›é›†ç¾¤çº§åˆ«çš„åŠŸèƒ½ç‰¹æ€§ï¼Œaddonsä½¿ç”¨åˆ°çš„Kubernetesèµ„æºéƒ½æ”¾ç½®åœ¨ kube-system åç§°ç©ºé—´ä¸‹ã€‚ ä¸‹é¢æè¿°äº†ä¸€äº›ç»å¸¸ç”¨åˆ°çš„ addonsï¼Œå‚è€ƒ Addons æŸ¥çœ‹æ›´å¤šåˆ—è¡¨ã€‚ DNS é™¤äº† DNS Addon ä»¥å¤–ï¼Œå…¶ä»–çš„ addon éƒ½ä¸æ˜¯å¿…é¡»çš„ï¼Œæ‰€æœ‰ Kubernetes é›†ç¾¤éƒ½åº”è¯¥æœ‰ Cluster DNS Cluster DNS æ˜¯ä¸€ä¸ª DNS æœåŠ¡å™¨ï¼Œæ˜¯å¯¹æ‚¨å·²æœ‰ç¯å¢ƒä¸­å…¶ä»– DNS æœåŠ¡å™¨çš„ä¸€ä¸ªè¡¥å……ï¼Œå­˜æ”¾äº† Kubernetes Service çš„ DNS è®°å½•ã€‚ Kubernetes å¯åŠ¨å®¹å™¨æ—¶ï¼Œè‡ªåŠ¨å°†è¯¥ DNS æœåŠ¡å™¨åŠ å…¥åˆ°å®¹å™¨çš„ DNS æœç´¢åˆ—è¡¨ä¸­ã€‚ å¦‚æœæ‚¨å‚è€ƒ www.kuboard.cn ä¸Šæä¾›çš„æ–‡æ¡£å®‰è£… Kubernetesï¼Œé»˜è®¤å·²ç»å®‰è£…äº† Core DNS Web UIï¼ˆDashboardï¼‰ Dashboard æ˜¯ä¸€ä¸ªKubernetesé›†ç¾¤çš„ Web ç®¡ç†ç•Œé¢ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡è¯¥ç•Œé¢ç®¡ç†é›†ç¾¤ã€‚ Kuboard Kuboard æ˜¯ä¸€æ¬¾åŸºäºKubernetesçš„å¾®æœåŠ¡ç®¡ç†ç•Œé¢ï¼Œç›¸è¾ƒäº Dashboardï¼ŒKuboard å¼ºè°ƒï¼š æ— éœ€æ‰‹å·¥ç¼–å†™ YAML æ–‡ä»¶ å¾®æœåŠ¡å‚è€ƒæ¶æ„ ä¸Šä¸‹æ–‡ç›¸å…³çš„ç›‘æ§ åœºæ™¯åŒ–çš„è®¾è®¡ å¯¼å‡ºé…ç½® å¯¼å…¥é…ç½® ContainerResource Monitoring Container Resource Monitoring å°†å®¹å™¨çš„åº¦é‡æŒ‡æ ‡ï¼ˆmetricsï¼‰è®°å½•åœ¨æ—¶é—´åºåˆ—æ•°æ®åº“ä¸­ï¼Œå¹¶æä¾›äº† UI ç•Œé¢æŸ¥çœ‹è¿™äº›æ•°æ® Cluster-level Logging Cluster-level logging æœºåˆ¶è´Ÿè´£å°†å®¹å™¨çš„æ—¥å¿—å­˜å‚¨åˆ°ä¸€ä¸ªç»Ÿä¸€å­˜å‚¨ä¸­ï¼Œå¹¶æä¾›æœç´¢æµè§ˆçš„ç•Œé¢ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sçŸ¥è¯†ç‚¹/k8sçŸ¥è¯†å›¾è°±.html":{"url":"linux/k8s/k8sçŸ¥è¯†ç‚¹/k8sçŸ¥è¯†å›¾è°±.html","title":"k8sçŸ¥è¯†å›¾è°±","keywords":"","body":"k8sçŸ¥è¯†å›¾è°± 1.éƒ¨ç½²k8sé›†ç¾¤ Ansible kubeadm äºŒè¿›åˆ¶ ç¬¬ä¸‰æ–¹å·¥å…·(sealos) 2.æ•°æ®åº“ etcdï¼šå­˜å‚¨k8så¯¹è±¡ä¿¡æ¯ 3.é…ç½®ç®¡ç† configmap secret 4.åŒ…ç®¡ç†å™¨ helm 5.å¾®æœåŠ¡ istio 6.å­˜å‚¨ volumes PVã€PVC storage classse rookåŸºäºceph åˆ†å¸ƒå¼å­˜å‚¨ glusterFS ceph nfs 7.ç½‘ç»œ flannel calico cannel 8.æœºå™¨å­¦ä¹  kubeflow 9.æ—¥å¿—æ”¶é›† elasticsearch+fluentd+kibana elasticearch+logstash+filebeat+kibana 10.å¼€æ”¾æ¥å£ CRIï¼ˆContainer Runtime Interfaceï¼‰ï¼šå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼Œæä¾›è®¡ç®—èµ„æº CNIï¼ˆContainer Network Interfaceï¼‰ï¼šå®¹å™¨ç½‘ç»œæ¥å£ï¼Œæä¾›ç½‘ç»œèµ„æº CSIï¼ˆContainer Storage Interfaceï¼‰ï¼šå®¹å™¨å­˜å‚¨æ¥å£ï¼Œæä¾›å­˜å‚¨èµ„æº 11.å®¹å™¨å¼•æ“ï¼ˆdockerï¼‰ é•œåƒã€å®¹å™¨ã€ç½‘ç»œã€æ•°æ®æŒä¹…åŒ– Dockerfile Supervisorå¤šè¿›ç¨‹ç®¡ç† GPU nvidia-docker device-plugin 12.é•œåƒä»“åº“ harbor nexus 13.å¸¸ç”¨èµ„æºå¯¹è±¡ Pod namespaces Labels and Selectors Annotations 14.æ§åˆ¶å™¨ ReplicaSet Deployment SatefulSet DaemonSet job CronJob HPA Operater 15.DNS CoreDNS KubeDNS 16.æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ Ingress nginx Traefik Service 17.å®‰å…¨ Namespace ServiceAccout RBAC 18.ç›‘æ§ cAdvisor+Prometheus+Grafana Metrice-server kube-state-metrics Heapster 19.CI/CD jenkins gitlab git å‘å¸ƒç­–ç•¥ æ»šåŠ¨æ›´æ–° è“ç»¿å‘å¸ƒ ç°åº¦å‘å¸ƒ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sçŸ¥è¯†ç‚¹/k8så¿…ä¼šçŸ¥è¯†ç‚¹æ¢³ç†.html":{"url":"linux/k8s/k8sçŸ¥è¯†ç‚¹/k8så¿…ä¼šçŸ¥è¯†ç‚¹æ¢³ç†.html","title":"k8så¿…ä¼šçŸ¥è¯†ç‚¹æ¢³ç†","keywords":"","body":"k8så¿…ä¼šçŸ¥è¯†ç‚¹æ¢³ç† æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ kube-apiserver å¯¹å¤–æš´éœ²äº†Kubernetes APIã€‚å®ƒæ˜¯çš„ Kubernetes æ ¸å¿ƒæ§åˆ¶å±‚ã€‚å®ƒè¢«è®¾è®¡ä¸ºæ°´å¹³æ‰©å±•ï¼Œå³é€šè¿‡éƒ¨ç½²æ›´å¤šå®ä¾‹æ¥æ¨ªå‘æ‰©å±•ã€‚API Server è´Ÿè´£å’Œ etcd äº¤äº’ï¼ˆå…¶ä»–ç»„ä»¶ä¸ä¼šç›´æ¥æ“ä½œ etcdï¼Œåªæœ‰ API Server è¿™ä¹ˆåšï¼‰ï¼Œæ˜¯æ•´ä¸ª kubernetes é›†ç¾¤çš„æ•°æ®ä¸­å¿ƒï¼Œæ‰€æœ‰çš„äº¤äº’éƒ½æ˜¯ä»¥ API Server ä¸ºæ ¸å¿ƒçš„ã€‚API Server æä¾›äº†ä»¥ä¸‹çš„åŠŸèƒ½ï¼š æ•´ä¸ªé›†ç¾¤ç®¡ç†çš„ API æ¥å£ï¼šæ‰€æœ‰å¯¹é›†ç¾¤è¿›è¡Œçš„æŸ¥è¯¢å’Œç®¡ç†éƒ½è¦é€šè¿‡ API æ¥è¿›è¡Œã€‚ é›†ç¾¤å†…éƒ¨å„ä¸ªæ¨¡å—ä¹‹é—´é€šä¿¡çš„æ¢çº½ï¼šæ‰€æœ‰æ¨¡å—ä¹‹é—´å¹¶ä¸ä¼šäº’ç›¸è°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡å’Œ API Server æ‰“äº¤é“æ¥å®Œæˆå„è‡ªçš„å·¥ä½œã€‚ é›†ç¾¤å®‰å…¨æ§åˆ¶ï¼šAPI Server æä¾›çš„éªŒè¯å’Œæˆæƒä¿è¯äº†æ•´ä¸ªé›†ç¾¤çš„å®‰å…¨ã€‚ kube-controller-managerå’Œkube-schedulerçš„é«˜å¯ç”¨é€‰ä¸»æœºåˆ¶ çœ‹è¿™é‡Œ csdnåšå®¢ åœ¨k8sçš„ç»„ä»¶ä¸­ï¼Œå…¶ä¸­æœ‰kube-schedulerå’Œkube-controller-managerä¸¤ä¸ªç»„ä»¶æ˜¯æœ‰leaderé€‰ä¸¾çš„ï¼Œè¿™ä¸ªé€‰ä¸¾æœºåˆ¶æ˜¯k8så¯¹äºè¿™ä¸¤ä¸ªç»„ä»¶çš„é«˜å¯ç”¨ä¿éšœã€‚éœ€è¦--leader-elect=trueå¯åŠ¨å‚æ•°ã€‚å³æ­£å¸¸æƒ…å†µä¸‹kube-scheduleræˆ–kube-manager-controllerç»„ä»¶çš„å¤šä¸ªå‰¯æœ¬åªæœ‰ä¸€ä¸ªæ˜¯å¤„äºä¸šåŠ¡é€»è¾‘è¿è¡ŒçŠ¶æ€ï¼Œå…¶å®ƒå‰¯æœ¬åˆ™ä¸æ–­çš„å°è¯•å»è·å–é”ï¼Œå»ç«äº‰leaderï¼Œç›´åˆ°è‡ªå·±æˆä¸ºleaderã€‚å¦‚æœæ­£åœ¨è¿è¡Œçš„leaderå› æŸç§åŸå› å¯¼è‡´å½“å‰è¿›ç¨‹é€€å‡ºï¼Œæˆ–è€…é”ä¸¢å¤±ï¼Œåˆ™ç”±å…¶å®ƒå‰¯æœ¬å»ç«äº‰æ–°çš„leaderï¼Œè·å–leaderç»§è€Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚ åœ¨K8sä¸­ï¼Œ é€šè¿‡åˆ›å»ºèµ„æºå¯¹è±¡ï¼ˆå½“å‰çš„å®ç°ä¸­å®ç°äº† ConfigMap å’Œ Endpoint ä¸¤ç§ç±»å‹çš„èµ„æºï¼‰æ¥ç»´æŠ¤é”çš„çŠ¶æ€ã€‚è¿™ä¸¤ç§èµ„æºå¯¹è±¡å­˜åœ¨etcdé‡Œï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ç”¨etcdæ¥å®ç°çš„ã€‚ åˆ†å¸ƒå¼é”ä¸€èˆ¬å®ç°åŸç†å°±æ˜¯å¤§å®¶å…ˆå»æŠ¢é”ï¼ŒæŠ¢åˆ°çš„æˆä¸º leader ï¼Œç„¶å leader ä¼šå®šæœŸæ›´æ–°é”çš„çŠ¶æ€ï¼Œå£°æ˜è‡ªå·±çš„æ´»åŠ¨çŠ¶æ€ï¼Œä¸è®©å…¶ä»–äººæŠŠé”æŠ¢èµ°ã€‚K8s çš„èµ„æºé”ä¹Ÿç±»ä¼¼ï¼ŒæŠ¢åˆ°é”çš„èŠ‚ç‚¹ä¼šå°†è‡ªå·±çš„æ ‡è®°ã€‚è®¾ä¸ºé”çš„æŒæœ‰è€…ï¼Œå…¶ä»–äººåˆ™éœ€è¦é€šè¿‡å¯¹æ¯”é”çš„æ›´æ–°æ—¶é—´å’ŒæŒæœ‰è€…æ¥åˆ¤æ–­è‡ªå·±æ˜¯å¦èƒ½æˆä¸ºæ–°çš„ leader ï¼Œè€Œ leader åˆ™å¯ä»¥é€šè¿‡æ›´æ–°RenewTimeæ¥ç¡®ä¿æŒç»­ä¿æœ‰è¯¥é”ã€‚ ä¸»è¦è°ƒç”¨client-goåŒ…ä¸­çš„ï¼š k8s.io/client-go/tools/leaderelection æ€»å…±æœ‰7ä¸ªleaderé€‰ä¸¾å‚æ•°ï¼š lock-object-namespaceå’Œlock-object-nameæ˜¯é”å¯¹è±¡çš„å‘½åç©ºé—´å’Œåç§°ã€‚ leader-electè¡¨ç¤ºè¯¥ç»„ä»¶è¿è¡Œæ—¶æ˜¯å¦éœ€è¦leaderé€‰ä¸¾(å¦‚æœé›†ç¾¤ä¸­è¿è¡Œå¤šå‰¯æœ¬ï¼Œéœ€è¦è®¾ç½®è¯¥é€‰é¡¹ä¸ºtrueï¼Œå¦åˆ™æ¯ä¸ªå‰¯æœ¬éƒ½å°†å‚ä¸å®é™…å·¥ä½œ)ã€‚ leader-elect-lease-durationä¸ºèµ„æºé”ç§Ÿçº¦è§‚å¯Ÿæ—¶é—´ï¼Œå¦‚æœå…¶å®ƒç«äº‰è€…åœ¨è¯¥æ—¶é—´é—´éš”è¿‡åå‘ç°leaderæ²¡æ›´æ–°è·å–é”æ—¶é—´ï¼Œåˆ™å…¶å®ƒå‰¯æœ¬å¯ä»¥è®¤ä¸ºleaderå·²ç»æŒ‚æ‰ä¸å‚ä¸å·¥ä½œäº†ï¼Œå°†é‡æ–°é€‰ä¸¾leaderã€‚ leader-elect-renew-deadline leaderåœ¨è¯¥æ—¶é—´å†…æ²¡æœ‰æ›´æ–°åˆ™å¤±å»leaderèº«ä»½ã€‚ leader-elect-retry-periodä¸ºå…¶å®ƒå‰¯æœ¬è·å–é”çš„æ—¶é—´é—´éš”(ç«äº‰leader)å’Œleaderæ›´æ–°é—´éš”ã€‚ leader-elect-resource-lockæ˜¯k8såˆ†å¸ƒå¼èµ„æºé”çš„èµ„æºå¯¹è±¡ï¼Œç›®å‰åªæ”¯æŒendpointså’Œconfigmapsã€‚ etcd Etcdä½¿ç”¨çš„æ˜¯raftä¸€è‡´æ€§ç®—æ³•æ¥å®ç°çš„ï¼Œæ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼çš„ä¸€è‡´æ€§KVå­˜å‚¨ï¼Œä¸»è¦ç”¨äºå…±äº«é…ç½®å’ŒæœåŠ¡å‘ç°ã€‚ç”¨äº Kubernetes çš„åç«¯å­˜å‚¨ã€‚æ‰€æœ‰é›†ç¾¤æ•°æ®éƒ½å­˜å‚¨åœ¨æ­¤å¤„ï¼ŒETCDåœ¨k8sæŠ€æœ¯æ ˆçš„åœ°ä½ï¼Œå°±ä»¿ä½›æ•°æ®åº“ï¼ˆMysqlã€Postgresqlæˆ–oracleç­‰ï¼‰åœ¨Webåº”ç”¨ä¸­çš„åœ°ä½ï¼Œå®ƒå­˜å‚¨äº†k8sé›†ç¾¤ä¸­æ‰€æœ‰çš„å…ƒæ•°æ®ï¼ˆä»¥key-valueçš„æ–¹å¼ï¼‰ã€‚æ•´ä¸ªkubernetesç³»ç»Ÿéœ€è¦ç”¨åˆ°etcdç”¨æ¥ååŒå’Œå­˜å‚¨é…ç½®çš„æœ‰ï¼š ç½‘ç»œæ’ä»¶flannelã€calicoç­‰ç½‘ç»œæ’ä»¶ä¹Ÿéœ€è¦ç”¨åˆ°etcdå­˜å‚¨ç½‘ç»œçš„é…ç½®ä¿¡æ¯ kubernetesæœ¬èº«ï¼ŒåŒ…æ‹¬å„ç§å¯¹è±¡çš„çŠ¶æ€å’Œå…ƒä¿¡æ¯é…ç½® æ³¨æ„ï¼šflannelæ“ä½œetcdä½¿ç”¨çš„æ˜¯v2çš„APIï¼Œè€Œkubernetesæ“ä½œetcdä½¿ç”¨çš„v3çš„APIï¼Œæ‰€ä»¥åœ¨ä¸‹é¢æˆ‘ä»¬æ‰§è¡Œetcdctlçš„æ—¶å€™éœ€è¦è®¾ç½®ETCDCTL_APIç¯å¢ƒå˜é‡ï¼Œè¯¥å˜é‡é»˜è®¤å€¼ä¸º2ã€‚ K8sä¸­æ‰€æœ‰å…ƒæ•°æ®çš„å¢åˆ æ”¹æŸ¥éƒ½æ˜¯ç”±kube-apiserveræ¥æ‰§è¡Œçš„ã€‚ETCDä¸­keyå€¼é€šè¿‡è§‚å¯Ÿå¯ä»¥ç®€å•å¾—å‡ºä¸‹é¢å‡ ä¸ªè§„å¾‹ï¼š k8sä¸»è¦æŠŠè‡ªå·±çš„æ•°æ®æ³¨å†Œåœ¨/registry/å‰ç¼€ä¸‹é¢ï¼ˆåœ¨ETCD-v3ç‰ˆæœ¬åæ²¡æœ‰äº†ç›®å½•çš„æ¦‚å¿µï¼Œåªèƒ½ä¸€åˆ‡çš†å‰ç¼€äº†ï¼‰ã€‚é€šè¿‡è§‚å¯Ÿk8sä¸­deploymentã€namespaceã€podç­‰åœ¨ETCDä¸­çš„è¡¨ç¤ºï¼Œå¯ä»¥çŸ¥é“è¿™éƒ¨åˆ†èµ„æºçš„keyçš„æ ¼å¼ä¸º/registry/{k8så¯¹è±¡}/{å‘½åç©ºé—´}/{å…·ä½“å®ä¾‹å}ã€‚ kube-controller-manager kube-controller-managerè¿è¡Œæ§åˆ¶å™¨ï¼Œå®ƒä»¬æ˜¯å¤„ç†é›†ç¾¤ä¸­å¸¸è§„ä»»åŠ¡çš„åå°çº¿ç¨‹ã€‚é€»è¾‘ä¸Šï¼Œæ¯ä¸ªæ§åˆ¶å™¨æ˜¯ä¸€ä¸ªå•ç‹¬çš„åç¨‹ã€‚ç”¨äºç›‘è§† apiserver æš´éœ²çš„é›†ç¾¤çŠ¶æ€ï¼Œå¹¶ä¸”ä¸æ–­åœ°å°è¯•æŠŠå½“å‰çŠ¶æ€å‘é›†ç¾¤çš„ç›®æ ‡çŠ¶æ€è¿ç§»ã€‚ä¸ºäº†é¿å…é¢‘ç¹æŸ¥è¯¢ apiserverï¼Œapiserver æä¾›äº† watch æ¥å£ç”¨äºç›‘è§†èµ„æºçš„å¢åŠ åˆ é™¤å’Œæ›´æ–°ï¼Œclient-go å¯¹æ­¤ä½œäº†æŠ½è±¡ï¼Œå°è£…ä¸€å±‚ informer æ¥è¡¨ç¤ºæœ¬åœ° apiserver çŠ¶æ€çš„ cache ã€‚ å‚è€ƒ: çœ‹è¿™é‡Œ è¿™äº›æ§åˆ¶å™¨åŒ…æ‹¬: èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆnode-controllerï¼‰: kubeletåœ¨å¯åŠ¨æ—¶ä¼šé€šè¿‡API Serveræ³¨å†Œè‡ªèº«çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶å®šæ—¶å‘API Serveræ±‡æŠ¥çŠ¶æ€ä¿¡æ¯ï¼ŒAPI Serveræ¥æ”¶åˆ°ä¿¡æ¯åå°†ä¿¡æ¯æ›´æ–°åˆ°etcdä¸­ã€‚Node Controlleré€šè¿‡API Serverå®æ—¶è·å–Nodeçš„ç›¸å…³ä¿¡æ¯ï¼Œå®ç°ç®¡ç†å’Œç›‘æ§é›†ç¾¤ä¸­çš„å„ä¸ªNodeèŠ‚ç‚¹çš„ç›¸å…³æ§åˆ¶åŠŸèƒ½ã€‚ å‰¯æœ¬æ§åˆ¶å™¨ï¼ˆReplication Controllerï¼‰: è´Ÿè´£ç»´æŠ¤ç³»ç»Ÿä¸­æ¯ä¸ªå‰¯æœ¬æ§åˆ¶å™¨å¯¹è±¡æ­£ç¡®æ•°é‡çš„ Podã€‚å‰¯æœ¬æ§åˆ¶å™¨çš„ä½œç”¨å³ä¿è¯é›†ç¾¤ä¸­ä¸€ä¸ªRCæ‰€å…³è”çš„Podå‰¯æœ¬æ•°å§‹ç»ˆä¿æŒé¢„è®¾å€¼ã€‚åªæœ‰å½“Podçš„é‡å¯ç­–ç•¥æ˜¯Alwaysçš„æ—¶å€™ï¼ˆRestartPolicy=Alwaysï¼‰ï¼Œå‰¯æœ¬æ§åˆ¶å™¨æ‰ä¼šç®¡ç†è¯¥Podçš„æ“ä½œï¼ˆåˆ›å»ºã€é”€æ¯ã€é‡å¯ç­‰ï¼‰ã€‚ æœåŠ¡å¸æˆ·å’Œä»¤ç‰Œæ§åˆ¶å™¨ï¼ˆServiceAccount Controller ï¼‰: ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œã€‚ èµ„æºé…é¢ç®¡ç†æ§åˆ¶å™¨ResourceQuota Controllerï¼šèµ„æºé…é¢ç®¡ç†ç¡®ä¿æŒ‡å®šçš„èµ„æºå¯¹è±¡åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸ä¼šè¶…é‡å ç”¨ç³»ç»Ÿç‰©ç†èµ„æºã€‚æ”¯æŒä¸‰ä¸ªå±‚æ¬¡çš„èµ„æºé…ç½®ç®¡ç†ï¼š å®¹å™¨çº§åˆ«ï¼šå¯¹CPUå’ŒMemoryè¿›è¡Œé™åˆ¶; Podçº§åˆ«ï¼šå¯¹ä¸€ä¸ªPodå†…æ‰€æœ‰å®¹å™¨çš„å¯ç”¨èµ„æºè¿›è¡Œé™åˆ¶; Namespaceçº§åˆ«ï¼šåŒ…æ‹¬Podæ•°é‡ã€Replication Controlleræ•°é‡ã€Serviceæ•°é‡ã€ResourceQuotaæ•°é‡ã€Secretæ•°é‡ã€å¯æŒæœ‰çš„PVï¼ˆPersistent Volumeï¼‰æ•°é‡ Namespace Controllerï¼šç”¨æˆ·é€šè¿‡API Serverå¯ä»¥åˆ›å»ºæ–°çš„Namespaceå¹¶ä¿å­˜åœ¨etcdä¸­ï¼ŒNamespaceControllerå®šæ—¶é€šè¿‡API Serverè¯»å–è¿™äº›Namespaceä¿¡æ¯ã€‚å¦‚æœNamespaceè¢«APIæ ‡è®°ä¸ºä¼˜é›…åˆ é™¤ï¼ˆå³è®¾ç½®åˆ é™¤æœŸé™ï¼ŒDeletionTimestampï¼‰,åˆ™å°†è¯¥NamespaceçŠ¶æ€è®¾ç½®ä¸ºâ€œTerminatingâ€,å¹¶ä¿å­˜åˆ°etcdä¸­ã€‚åŒæ—¶Namespace Controlleråˆ é™¤è¯¥Namespaceä¸‹çš„ServiceAccountã€RCã€Podç­‰èµ„æºå¯¹è±¡ã€‚ Service Controllerï¼šå±äºkubernetesé›†ç¾¤ä¸å¤–éƒ¨çš„äº‘å¹³å°ä¹‹é—´çš„ä¸€ä¸ªæ¥å£æ§åˆ¶å™¨ã€‚Service Controllerç›‘å¬Serviceå˜åŒ–ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªLoadBalancerç±»å‹çš„Serviceï¼Œåˆ™ç¡®ä¿å¤–éƒ¨çš„äº‘å¹³å°ä¸Šå¯¹è¯¥Serviceå¯¹åº”çš„LoadBalancerå®ä¾‹è¢«ç›¸åº”åœ°åˆ›å»ºã€åˆ é™¤åŠæ›´æ–°è·¯ç”±è½¬å‘è¡¨ã€‚ deployment controllerï¼šç”¨æ¥æ›¿ä»£ä»¥å‰çš„ReplicationControlleræ¥æ–¹ä¾¿çš„ç®¡ç†åº”ç”¨ã€‚åªéœ€è¦åœ¨ Deployment ä¸­æè¿°æ‚¨æƒ³è¦çš„ç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆï¼ŒDeployment controller å°±ä¼šå¸®æ‚¨å°† Pod å’ŒReplicaSet çš„å®é™…çŠ¶æ€æ”¹å˜åˆ°æ‚¨çš„ç›®æ ‡çŠ¶æ€ã€‚æ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªå…¨æ–°çš„ Deployment æ¥åˆ›å»º ReplicaSet æˆ–è€…åˆ é™¤å·²æœ‰çš„ Deployment å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„æ¥æ›¿æ¢ã€‚ å®šä¹‰Deploymentæ¥åˆ›å»ºPodå’ŒReplicaSet æ»šåŠ¨å‡çº§å’Œå›æ»šåº”ç”¨ æ‰©å®¹å’Œç¼©å®¹ æš‚åœå’Œè¿è¡ŒDeployment statefulset controllerï¼šStatefulSetæ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº”Deploymentså’ŒReplicaSetsæ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³Podé‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäºPVCæ¥å®ç°; ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³Podé‡æ–°è°ƒåº¦åå…¶PodNameå’ŒHostNameä¸å˜ï¼ŒåŸºäºHeadless Serviceï¼ˆå³æ²¡æœ‰Cluster IPçš„Serviceï¼‰æ¥å®ç°ã€‚StatefulSetä¸­æ¯ä¸ªPodçš„DNSæ ¼å¼ä¸ºï¼š statefulSetPodName-{0..N-1}.serviceName.namespace.svc.cluster.local æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³Podæ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾æ¬¡è¿›è¡Œï¼ˆå³ä»0åˆ°N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ªPodè¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„Podå¿…é¡»éƒ½æ˜¯Runningå’ŒReadyçŠ¶æ€ï¼‰ï¼ŒåŸºäºinit containersæ¥å®ç°ï¼› æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä»N-1åˆ°0ï¼‰ daemonset controllerï¼šDaemonSetç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…ä¸€äº›ï¼‰Node ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ã€‚å½“æœ‰ Node åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ª Pod ã€‚å½“æœ‰ Node ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤ DaemonSet å°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ Podã€‚ Horizontal Pod Autoscalingï¼šä»…é€‚ç”¨äºDeploymentå’ŒReplicaSetï¼Œåœ¨V1ç‰ˆæœ¬ä¸­ä»…æ”¯æŒæ ¹æ®Podçš„CPUåˆ©ç”¨ç‡æ‰©æ‰€å®¹ï¼Œåœ¨v1alphaç‰ˆæœ¬ä¸­ï¼Œæ”¯æŒæ ¹æ®å†…å­˜å’Œç”¨æˆ·è‡ªå®šä¹‰çš„metricæ‰©ç¼©å®¹ã€‚ persistentvolume-binder: å®šæœŸåŒæ­¥ç£ç›˜å·æŒ‚è½½ä¿¡æ¯ï¼Œè´Ÿè´£pvå’Œpvcçš„ç»‘å®šã€‚ Endpoints controllerï¼šè¡¨ç¤ºäº†ä¸€ä¸ªServiceå¯¹åº”çš„æ‰€æœ‰Podå‰¯æœ¬çš„è®¿é—®åœ°å€ï¼Œè€ŒEndpointsControllerè´Ÿè´£ç”Ÿæˆå’Œç»´æŠ¤æ‰€æœ‰Endpointså¯¹è±¡çš„æ§åˆ¶å™¨ã€‚å®ƒè´Ÿè´£ç›‘å¬Serviceå’Œå¯¹åº”çš„Podå‰¯æœ¬çš„å˜åŒ–ã€‚ å¦‚æœç›‘æµ‹åˆ°Serviceè¢«åˆ é™¤ï¼Œåˆ™åˆ é™¤å’Œè¯¥ServiceåŒåçš„Endpointså¯¹è±¡ï¼› å¦‚æœç›‘æµ‹åˆ°æ–°çš„Serviceè¢«åˆ›å»ºæˆ–ä¿®æ”¹ï¼Œåˆ™æ ¹æ®è¯¥Serviceä¿¡æ¯è·å¾—ç›¸å…³çš„Podåˆ—è¡¨ï¼Œç„¶ååˆ›å»ºæˆ–æ›´æ–°Serviceå¯¹åº”çš„Endpointså¯¹è±¡; å¦‚æœç›‘æµ‹åˆ°Podçš„äº‹ä»¶ï¼Œåˆ™æ›´æ–°å®ƒå¯¹åº”çš„Serviceçš„Endpointså¯¹è±¡ã€‚ kube-proxyè¿›ç¨‹è·å–æ¯ä¸ªServiceçš„Endpointsï¼Œå®ç°Serviceçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚ ä»¥ä¸Šåªæ˜¯éƒ¨åˆ†æ§åˆ¶å™¨ï¼Œéƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åç¨‹ï¼Œè¢«controller-managerè¿™ä¸ªè¿›ç¨‹æ‰€ç®¡ç†ã€‚ Statefulsetå’ŒDeploymentçš„åŒºåˆ« Deploymentç”¨äºéƒ¨ç½²æ— çŠ¶æ€æœåŠ¡ï¼ŒStatefulSetç”¨æ¥éƒ¨ç½²æœ‰çŠ¶æ€æœåŠ¡ã€‚ å¦‚æœéƒ¨ç½²çš„åº”ç”¨æ»¡è¶³ä»¥ä¸‹ä¸€ä¸ªæˆ–å¤šä¸ªéƒ¨ç½²éœ€æ±‚ï¼Œåˆ™å»ºè®®ä½¿ç”¨StatefulSetã€‚ ç¨³å®šçš„ã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†; ç¨³å®šçš„ã€æŒä¹…çš„å­˜å‚¨; æœ‰åºçš„ã€ä¼˜é›…çš„éƒ¨ç½²å’Œä¼¸ç¼©; æœ‰åºçš„ã€ä¼˜é›…çš„åˆ é™¤å’Œåœæ­¢; æœ‰åºçš„ã€è‡ªåŠ¨çš„æ»šåŠ¨æ›´æ–°; å®ç°å›ºå®šçš„Pod IPæ–¹æ¡ˆ, å¯ä»¥ä¼˜å…ˆè€ƒè™‘åŸºäºStatefulSet ç¨³å®šçš„ï¼šä¸»è¦æ˜¯é’ˆå¯¹Podå‘ç”Ÿre-scheduleåä»ç„¶è¦ä¿æŒä¹‹å‰çš„ç½‘ç»œæ ‡è¯†å’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚è¿™é‡Œæ‰€è¯´çš„ç½‘ç»œæ ‡è¯†åŒ…æ‹¬hostnameã€é›†ç¾¤å†…DNSä¸­è¯¥Podå¯¹åº”çš„A Recordï¼Œå¹¶ä¸èƒ½ä¿è¯Pod re-scheduleä¹‹åIPä¸å˜ã€‚è¦æƒ³ä¿æŒPod IPä¸å˜ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ç¨³å®šçš„Pod hostnameå®šåˆ¶IPAMè·å–å›ºå®šçš„Pod IPã€‚å€ŸåŠ©StatefulSetçš„ç¨³å®šçš„å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç‰¹æ€§ï¼Œæˆ‘ä»¬èƒ½æ¯”è¾ƒè½»æ¾çš„å®ç°Podçš„å›ºå®šIPéœ€æ±‚ï¼Œç„¶åå¦‚æœä½¿ç”¨Deploymentï¼Œé‚£ä¹ˆå°†ä¼šå¤æ‚çš„å¤šï¼Œä½ éœ€è¦è€ƒè™‘æ»šåŠ¨æ›´æ–°çš„è¿‡ç¨‹ä¸­çš„å‚æ•°æ§åˆ¶(maxSurgeã€maxUnavailable)ã€æ¯ä¸ªåº”ç”¨çš„IPæ± é¢„ç•™é€ æˆçš„IPæµªè´¹ç­‰ç­‰é—®é¢˜ã€‚ å­˜å‚¨ï¼šStatefulSetå¯¹åº”Podçš„å­˜å‚¨æœ€å¥½é€šè¿‡StorageClassæ¥åŠ¨æ€åˆ›å»ºï¼šæ¯ä¸ªPodéƒ½ä¼šæ ¹æ®StatefulSetä¸­å®šä¹‰çš„VolumeClaimTemplateæ¥åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„PVCï¼Œç„¶åPVSé€šè¿‡StorageClassè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„PVï¼Œå¹¶æŒ‚è½½ç»™Podã€‚æ‰€ä»¥è¿™ç§æ–¹å¼ï¼Œéœ€è¦äº‹å…ˆåˆ›å»ºå¥½å¯¹åº”çš„StorageClassã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡é¢„å…ˆç”±ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¥½å¯¹åº”çš„PVï¼Œåªè¦èƒ½ä¿è¯è‡ªåŠ¨åˆ›å»ºçš„PVCèƒ½å’Œè¿™äº›PVåŒ¹é…ä¸Šã€‚ ä¸ºäº†æ•°æ®å®‰å…¨ï¼Œå½“åˆ é™¤StatefulSetä¸­Podsæˆ–è€…å¯¹StatefulSetè¿›è¡Œç¼©å®¹æ—¶ï¼ŒKuberneteså¹¶ä¸ä¼šè‡ªåŠ¨åˆ é™¤StatefulSetå¯¹åº”çš„PVï¼Œè€Œä¸”è¿™äº›PVé»˜è®¤ä¹Ÿä¸èƒ½è¢«å…¶ä»–PVC Boundã€‚å½“ä½ ç¡®è®¤æ•°æ®æ— ç”¨ä¹‹åå†æ‰‹åŠ¨å»åˆ é™¤PVçš„æ—¶å€™ï¼Œæ•°æ®æ˜¯å¦åˆ é™¤å–å†³äºPVçš„ReclaimPolicyé…ç½®ã€‚Reclaim Policyæ”¯æŒä»¥ä¸‹ä¸‰ç§ï¼š Retainï¼Œæ„å‘³ç€éœ€è¦ä½ æ‰‹åŠ¨æ¸…ç†ï¼› Recycleï¼Œç­‰åŒäºrm -rf /thevolume/* Deleteï¼Œé»˜è®¤å€¼ï¼Œä¾èµ–äºåç«¯çš„å­˜å‚¨ç³»ç»Ÿè‡ªå·±å®ç°ã€‚ éƒ¨ç½²å’Œä¼¸ç¼©æ—¶ä¸Deploymentçš„åŒºåˆ« å½“éƒ¨ç½²æœ‰Nä¸ªå‰¯æœ¬çš„StatefulSetåº”ç”¨æ—¶ï¼Œä¸¥æ ¼æŒ‰ç…§indexä»0åˆ°N-1çš„é€’å¢é¡ºåºåˆ›å»ºï¼Œä¸‹ä¸€ä¸ªPodåˆ›å»ºå¿…é¡»æ˜¯å‰ä¸€ä¸ªPod Readyä¸ºå‰æã€‚ å½“åˆ é™¤æœ‰Nä¸ªå‰¯æœ¬çš„StatefulSetåº”ç”¨æ—¶ï¼Œä¸¥æ ¼æŒ‰ç…§indexä»N-1åˆ°0çš„é€’å‡é¡ºåºåˆ é™¤ï¼Œä¸‹ä¸€ä¸ªPodåˆ é™¤å¿…é¡»æ˜¯å‰ä¸€ä¸ªPod shutdownå¹¶å®Œå…¨åˆ é™¤ä¸ºå‰æã€‚ å½“æ‰©å®¹StatefulSetåº”ç”¨æ—¶ï¼Œæ¯æ–°å¢ä¸€ä¸ªPodå¿…é¡»æ˜¯å‰ä¸€ä¸ªPod Readyä¸ºå‰æã€‚ å½“ç¼©å®¹StatefulSetåº”ç”¨æ—¶ï¼Œæ²¡åˆ é™¤ä¸€ä¸ªPodå¿…é¡»æ˜¯å‰ä¸€ä¸ªPod shutdownå¹¶æˆåŠŸåˆ é™¤ä¸ºå‰æã€‚ kube-scheduler kube-schedulerç›‘è§†æ²¡æœ‰åˆ†é…èŠ‚ç‚¹çš„æ–°åˆ›å»ºçš„ Podï¼Œé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ä¾›ä»–ä»¬è¿è¡Œã€‚è°ƒåº¦èŠ‚ç‚¹åˆ†é…ä¸»è¦å¯ä»¥åˆ†ä¸ºé¢„é€‰ï¼ˆPredicatesï¼‰ä¸ä¼˜é€‰ï¼ˆPrioritiesï¼‰ä¸¤ä¸ªç¯èŠ‚ï¼š é¢„é€‰ æ ¹æ®é…ç½®çš„PredicatesPoliciesï¼ˆé»˜è®¤ä¸ºDefaultProviderä¸­å®šä¹‰çš„default predicates policiesé›†åˆï¼‰è¿‡æ»¤æ‰é‚£äº›ä¸æ»¡è¶³è¿™äº›Policies çš„ Nodeï¼Œé¢„é€‰çš„è¾“å‡ºä½œä¸ºä¼˜é€‰çš„è¾“å…¥ï¼› ä¼˜é€‰ æ ¹æ®é…ç½®çš„PrioritiesPoliciesï¼ˆé»˜è®¤ä¸ºDefaultProviderä¸­å®šä¹‰çš„default priorities policiesé›†åˆï¼‰ç»™é¢„é€‰åçš„ Node è¿›è¡Œæ‰“åˆ†æ’åï¼Œå¾—åˆ†æœ€é«˜çš„ Node å³ä½œä¸ºæœ€é€‚åˆçš„ Node ï¼Œè¯¥ Pod å°±ç»‘å®šï¼ˆBindï¼‰åˆ°è¿™ä¸ª Node ã€‚ æ³¨ï¼šå¦‚æœç»è¿‡ä¼˜é€‰å°† Node æ‰“åˆ†æ’ååï¼Œæœ‰å¤šä¸ª Node å¹¶åˆ—å¾—åˆ†æœ€é«˜ï¼Œé‚£ä¹ˆkube-schedulerå°†éšæœºä»ä¸­é€‰æ‹©ä¸€ä¸ª Node ä½œä¸ºç›®æ ‡ Node ã€‚ é¢„é€‰é˜¶æ®µç®—æ³• NoDiskConflict: è¯„ä¼°æ˜¯å¦å­˜åœ¨volumeå†²çªã€‚å¦‚æœè¯¥ volume å·²ç» mount è¿‡äº†ï¼Œk8så¯èƒ½ä¼šä¸å…è®¸é‡å¤mount(å–å†³äºvolumeç±»å‹)ï¼› NoVolumeZoneConflict: è¯„ä¼°è¯¥èŠ‚ç‚¹ä¸Šæ˜¯å¦å­˜åœ¨ Pod è¯·æ±‚çš„ volumeï¼› PodFitsResources: æ£€æŸ¥èŠ‚ç‚¹å‰©ä½™èµ„æº(CPUã€å†…å­˜)æ˜¯å¦èƒ½æ»¡è¶³ Pod çš„éœ€æ±‚ã€‚å‰©ä½™èµ„æº=æ€»å®¹é‡-æ‰€æœ‰ Pod è¯·æ±‚çš„èµ„æºï¼› MatchNodeSelector: åˆ¤æ–­æ˜¯å¦æ»¡è¶³ Pod è®¾ç½®çš„ NodeSelectorï¼› CheckNodeMemoryPressure: æ£€æŸ¥ Pod æ˜¯å¦å¯ä»¥è°ƒåº¦åˆ°å­˜åœ¨å†…å­˜å‹åŠ›çš„èŠ‚ç‚¹ï¼› CheckNodeDiskPressure: æ£€æŸ¥ Pod æ˜¯å¦å¯ä»¥è°ƒåº¦åˆ°å­˜åœ¨ç¡¬ç›˜å‹åŠ›çš„èŠ‚ç‚¹ï¼› ä¼˜é€‰é˜¶æ®µç®—æ³• ä¾æ¬¡è®¡ç®—è¯¥ Pod è¿è¡Œåœ¨æ¯ä¸€ä¸ª Node ä¸Šçš„å¾—åˆ†ã€‚ä¸»è¦ç®—æ³•æœ‰ï¼š LeastRequestedPriorityï¼šæœ€ä½è¯·æ±‚ä¼˜å…ˆçº§ï¼Œå³ Node ä½¿ç”¨ç‡è¶Šä½ï¼Œå¾—åˆ†è¶Šé«˜ï¼› BalancedResourceAllocationï¼šèµ„æºå¹³è¡¡åˆ†é…ï¼Œå³CPU/å†…å­˜é…æ¯”åˆé€‚çš„ Node å¾—åˆ†æ›´é«˜ï¼› SelectorSpreadPriority: å°½é‡å°†åŒä¸€ RC/Replica çš„å¤šä¸ª Pod åˆ†é…åˆ°ä¸åŒçš„ Node ä¸Šï¼› CalculateAntiAffinityPriority: å°½é‡å°†åŒä¸€ Service ä¸‹çš„å¤šä¸ªç›¸åŒ Label çš„ Pod åˆ†é…åˆ°ä¸åŒçš„ Nodeï¼› ImageLocalityPriority: Imageæœ¬åœ°ä¼˜å…ˆï¼ŒNode ä¸Šå¦‚æœå·²ç»å­˜åœ¨ Pod éœ€è¦çš„é•œåƒï¼Œå¹¶ä¸”é•œåƒè¶Šå¤§ï¼Œå¾—åˆ†è¶Šé«˜ï¼Œä»è€Œå‡å°‘ Pod æ‹‰å–é•œåƒçš„å¼€é”€(æ—¶é—´)ï¼› NodeAffinityPriority: æ ¹æ®äº²å’Œæ€§æ ‡ç­¾è¿›è¡Œé€‰æ‹©ï¼› é»˜è®¤çš„é¢„é€‰ã€ä¼˜é€‰è°ƒåº¦ç®—æ³•è¿œä¸æ­¢ä»¥ä¸Šè¿™äº›ã€‚å¯ä»¥é€šè¿‡kube-schedulerçš„å¯åŠ¨å‚æ•°ä¸­åŠ policy-config-fileæ–‡ä»¶ã€configmapsï¼ˆè¿‡æ—¶ï¼‰ã€æˆ–è€…--configæŒ‡å®šè°ƒåº¦å™¨ç”¨å“ªäº›é¢„é€‰ã€ä¼˜é€‰ç®—æ³•ã€‚ è°ƒåº¦ç®—æ³•çš„æ‰©å±• å¦‚æœkube-scheduleræä¾›çš„è°ƒåº¦ç®—æ³•ä¸æ»¡è¶³è°ƒåº¦è¦æ±‚ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å¼€å‘æ‰©å±•è°ƒåº¦å™¨ï¼Œåœ¨kube-schedulerå¯åŠ¨å‚æ•°çš„policy-configä¸­æŒ‡å®šæ‰©å±•è°ƒåº¦å™¨çš„åœ°å€ï¼ŒåŒ…æ‹¬ï¼ˆé¢„é€‰æ¥å£ã€ä¼˜é€‰æ¥å£ã€ä¼˜å…ˆçº§æŠ¢å ï¼Œpodå’Œnodeç»‘å®šçš„Bindæ¥å£ï¼‰ã€‚ æ‰©å±•è°ƒåº¦å™¨ç¤ºä¾‹ä»£ç ï¼š çœ‹è¿™é‡Œ ç”±äºé»˜è®¤è°ƒåº¦å™¨kube-scheduleréœ€è¦è°ƒç”¨æ‰©å±•è°ƒåº¦ç¨‹åºkube-scheduler-extenderï¼Œæ•…éœ€è¦åœ¨kube-schedulerçš„å¯åŠ¨å‚æ•°é‡Œé…ç½®æ‰©å±•è°ƒåº¦å™¨çš„åœ°å€ã€‚éœ€è¦åœ¨masterèŠ‚ç‚¹ä¸»æœºçš„/etc/kubernetesç›®å½•ä¸‹çš„scheduler.yamlä¸­é…ç½®å¦‚ä¸‹å†…å®¹ï¼šï¼ˆstatic podæ–¹å¼éƒ¨ç½²çš„kube-schedulerä¸èƒ½ç”¨configmapsçš„æ–¹å¼æŒ‚è½½é…ç½®æ–‡ä»¶ï¼‰ apiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration algorithmSource: policy: file: path: /etc/kubernetes/scheduler-policy.json clientConnection: kubeconfig: /etc/kubernetes/scheduler.conf leaderElection: leaderElect: true ä¸»è¦é…ç½®æ˜¯å¦å¯ç”¨é€‰ä¸¾æœºåˆ¶ï¼Œä»¥åŠä¸API Serveräº¤äº’æ—¶è®¤è¯ç”¨çš„scheduler.confæ–‡ä»¶åœ°å€ï¼Œè°ƒåº¦ç­–ç•¥é€‰æ‹©ç”¨çš„scheduler-policy.jsonï¼š { \"kind\":\"Policy\", \"apiVersion\":\"v1\", \"predicates\":[ { \"name\":\"NoVolumeZoneConflict\" }, { \"name\":\"MatchInterPodAffinity\" }, { \"name\":\"NoDiskConflict\" }, { \"name\":\"GeneralPredicates\" }, { \"name\":\"PodToleratesNodeTaints\" }, { \"name\":\"CheckVolumeBinding\" } ], \"priorities\":[ { \"name\":\"SelectorSpreadPriority\", \"weight\":1 }, { \"name\":\"InterPodAffinityPriority\", \"weight\":1 }, { \"name\":\"LeastRequestedPriority\", \"weight\":1 }, { \"name\":\"NodeAffinityPriority\", \"weight\":1 }, { \"name\":\"BalancedResourceAllocation\", \"weight\":1 }, { \"name\":\"NodePreferAvoidPodsPriority\", \"weight\":10000 }, { \"name\":\"TaintTolerationPriority\", \"weight\":1 } ], \"extenders\":[ { \"urlPrefix\":\"http://kube-scheduler-extender:80/scheduler\", \"filterVerb\":\"predicates/middleware_predicate\", \"prioritizeVerb\":\"\", \"preemptVerb\":\"\", \"bindVerb\":\"bind\", \"weight\":1, \"enableHttps\":false, \"nodeCacheCapable\":false } ], \"hardPodAffinitySymmetricWeight\":10, \"alwaysCheckAllPredicates\":false } é‡Œé¢æŒ‡å®šäº†é»˜è®¤è°ƒåº¦å™¨ç”¨åˆ°çš„é¢„é€‰ã€ä¼˜é€‰ç®—æ³•ï¼Œä»¥åŠè°ƒç”¨æ‰©å±•è°ƒåº¦å™¨çš„serviceåœ°å€ï¼Œé¢„é€‰å’ŒBindæ¥å£URIã€‚ åœ¨/etc/kubernetes/manifestsç›®å½•ä¸‹çš„kube-scheduler.yamlä¸­å¯åŠ¨å‚æ•°ä¸­åŠ --config=/etc/kubernetes/scheduler.yamlï¼Œè¯¥æ–‡ä»¶é€šè¿‡hostPathçš„æ–¹å¼æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚ DNS kube-dnsè¿™ä¸ªæ’ä»¶æ˜¯å®˜æ–¹æ¨èå®‰è£…çš„ã€‚é€šè¿‡å°† Service æ³¨å†Œåˆ° DNS ä¸­ï¼Œk8s å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›ä¸€ç§ç®€å•çš„æœåŠ¡æ³¨å†Œå‘ç°ä¸è´Ÿè½½å‡è¡¡æ–¹å¼ã€‚ kube-dnså†…éƒ¨é€šè¿‡ç›‘å¬serviceså’Œendpointsçš„å˜æ›´äº‹ä»¶å°†åŸŸåå’ŒIPå¯¹åº”ä¿¡æ¯åŒæ­¥åˆ°æœ¬åœ°ç¼“å­˜ã€‚æ¯”å¦‚æœåŠ¡ a è®¿é—®æœåŠ¡ bï¼Œdnsè§£æä¾èµ–aå®¹å™¨å†… /etc/resolv.conf æ–‡ä»¶çš„é…ç½® cat/etc/resolv.conf nameserver 10.233.0.3search default.svc.cluster.local svc.cluster.localcluster.local è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œé…ç½®çš„ DNS Serverï¼Œä¸€èˆ¬å°±æ˜¯ K8S ä¸­ï¼Œkubedns çš„ Service çš„ ClusterIPï¼Œè¿™ä¸ªIPæ˜¯è™šæ‹ŸIPï¼Œæ— æ³•pingã€‚ [root@node4 user1]#kubectl get svc -n kube-systemNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEkube-dns ClusterIP 10.233.0.3 53/UDP,53/TCP 270dkubernetes-dashboard ClusterIP 10.233.22.223 443/TCP 124d æ‰€æœ‰åŸŸåçš„è§£æï¼Œå…¶å®éƒ½è¦ç»è¿‡ kubedns çš„è™šæ‹ŸIP 10.233.0.3 ï¼Œè´Ÿè½½åˆ°æŸä¸€ä¸ªkube-dns podä¸Šå»è§£æã€‚å¦‚æœä¸èƒ½è§£æï¼Œåˆ™ä¼šå»kube-dns podæ‰€åœ¨çš„ä¸»æœºä¸Šçš„dnsæœåŠ¡ï¼ˆ/etc/resolv.confï¼‰åšè§£æã€‚Kubernetes å¯åŠ¨çš„å®¹å™¨è‡ªåŠ¨å°† DNS æœåŠ¡å™¨åŒ…å«åœ¨å®¹å™¨å†…çš„/etc/resolv.conf ä¸­ã€‚ åŸŸåæ ¼å¼å¦‚ä¸‹ï¼š statefulsetä¸€èˆ¬ä½¿ç”¨Headless Serviceï¼Œå¦‚statefulsetåä¸ºtestï¼Œåˆ›å»º2ä¸ªpodï¼Œåˆ™åŸŸåä¸ºtest-0.test.kube-system.svc.cluster.localå’Œtest-1.test.kube-system.svc.cluster.local èŠ‚ç‚¹ç»„ä»¶ èŠ‚ç‚¹ç»„ä»¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç»´æŠ¤è¿è¡Œçš„ Pod å¹¶æä¾›Kubernetes è¿è¡Œæ—¶ç¯å¢ƒã€‚kubeletä¸€èˆ¬ä½œä¸ºäºŒè¿›åˆ¶è¿è¡Œåˆ°æ¯ä¸ªk8sèŠ‚ç‚¹ï¼›kube-proxyä½œä¸ºdaemonset podè¿è¡Œåˆ°æ¯ä¸ªk8sèŠ‚ç‚¹ã€‚ kubelet åœ¨kubernetesé›†ç¾¤ä¸­ï¼Œæ¯ä¸ªNodeèŠ‚ç‚¹éƒ½ä¼šå¯åŠ¨kubeletè¿›ç¨‹ï¼Œç”¨æ¥å¤„ç†MasterèŠ‚ç‚¹ä¸‹å‘åˆ°æœ¬èŠ‚ç‚¹çš„ä»»åŠ¡ï¼Œç®¡ç†Podå’Œå…¶ä¸­çš„å®¹å™¨ã€‚kubeletä¼šåœ¨API Serverä¸Šæ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå®šæœŸå‘Masteræ±‡æŠ¥èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶é€šè¿‡cAdvisorç›‘æ§å®¹å™¨å’ŒèŠ‚ç‚¹èµ„æºã€‚ èŠ‚ç‚¹ç®¡ç† èŠ‚ç‚¹é€šè¿‡è®¾ç½®kubeletçš„å¯åŠ¨å‚æ•°--register-nodeæ¥å†³å®šæ˜¯å¦å‘API Serveræ³¨å†Œè‡ªå·±ï¼Œé»˜è®¤ä¸ºtrueï¼Œå¯ä»¥é€šè¿‡kubelet --helpæˆ–è€…æŸ¥çœ‹k8sæºç (ç›´æ¥æ”¾å¼ƒ) kubeletçš„é…ç½®æ–‡ä»¶ é»˜è®¤é…ç½®æ–‡ä»¶åœ¨/etc/kubernetes/kubeletä¸­ï¼Œå…¶ä¸­ --api-servers: ç”¨æ¥é…ç½®masterèŠ‚ç‚¹çš„IPå’Œç«¯å£ --kukeconfig:ç”¨æ¥é…ç½®kubeconfigçš„è·¯å¾„ï¼Œkubeconfigæ–‡ä»¶å¸¸ç”¨æ¥æŒ‡å®šè¯ä¹¦ --hostname-overrideï¼šç”¨æ¥é…ç½®è¯¥èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­æ˜¾ç¤ºçš„ä¸»æœºå --node-status-update-frequencyï¼šé…ç½®kubelerå‘masterå¿ƒè·³ä¸ŠæŠ¥çš„é¢‘ç‡ï¼Œé»˜è®¤ä¸º10s podç®¡ç† kubeletæœ‰å‡ ç§æ–¹å¼è·å–è‡ªèº«nodeä¸Šæ‰€éœ€è¿è¡Œçš„podæ¸…å•ï¼Œä½†æœ¬æ–‡åªè®¨è®ºé€šè¿‡API Serverç›‘å¬etcdç›®å½•ï¼ŒåŒæ­¥podåˆ—è¡¨çš„æ–¹å¼ kubeleté€šè¿‡API Server Clientä½¿ç”¨WatchAndListæ–¹å¼ç›‘å¬etcdä¸­/registry/nodes/$(å½“å‰èŠ‚ç‚¹åç§°)å’Œ/registry/podsçš„ç›®å½•ï¼Œå°†è·å–çš„ä¿¡æ¯åŒæ­¥åˆ°æœ¬åœ°ç¼“å­˜ä¸­ kubeletç›‘å¬etcdï¼Œæ‰§è¡Œå¯¹podçš„æ“ä½œï¼Œå¯¹å®¹å™¨çš„æ“ä½œåˆ™æ˜¯é€šè¿‡docker clientæ‰§è¡Œï¼Œä¾‹å¦‚è‡ªåŠ¨åˆ é™¤å®¹å™¨ç­‰ kubeletåˆ›å»ºå’Œä¿®æ”¹podæµç¨‹ 1.ä¸ºè¯¥podåˆ›å»ºä¸€ä¸ªæ•°æ®ç›®å½• 2.ä»API Serverè¯»å–è¯¥podæ¸…å• 3.ä¸ºè¯¥podæŒ‚è½½å¤–éƒ¨å· 4.ä¸‹è½½podåˆ°ç”¨åˆ°çš„secret 5.æ£€æŸ¥è¿è¡Œçš„podï¼Œæ‰§è¡Œpodä¸­æœªå®Œæˆçš„ä»»åŠ¡ 6.å…ˆåˆ›å»ºä¸€ä¸ªpauseå®¹å™¨ï¼Œè¯¥å®¹å™¨æ¥ç®¡podçš„ç½‘ç»œï¼Œå†åˆ›å»ºå…¶ä»–å®¹å™¨ 7.podä¸­å®¹å™¨çš„å¤„ç†æµç¨‹ â€‹ 7.1æ¯”è¾ƒå®¹å™¨hashå€¼å¹¶åšç›¸åº”å¤„ç† â€‹ 7.2å¦‚æœå®¹å™¨è¢«ç»ˆæ­¢äº†ä¸”æ²¡æœ‰æŒ‡å®šé‡å¯ç­–ç•¥ï¼Œåˆ™ä¸åšä»»ä½•å¤„ç† â€‹ 7.3è°ƒç”¨docker clientä¸‹è½½å®¹å™¨é•œåƒï¼Œè°ƒç”¨docker clienrè¿è¡Œå®¹å™¨ podè¢«è°ƒåº¦åˆ°kubeletæ‰€åœ¨èŠ‚ç‚¹æ—¶ï¼Œè°ƒç”¨CNIï¼ˆDocker è¿è¡Œæˆ–é€šè¿‡ rkt)è¿è¡Œ Pod çš„å®¹å™¨; å‘¨æœŸæ€§çš„å¯¹å®¹å™¨ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ¢æµ‹ã€‚ï¼ˆå¥åº·æ£€æŸ¥readness-éš”ç¦»ã€liveness-é‡å¯ï¼‰; æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ï¼Œå°†èŠ‚ç‚¹çš„çŠ¶æ€æŠ¥å‘Šç»™kube-apiserver; å®¹å™¨ç›‘æ§æ‰€åœ¨èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶å®šæ—¶å‘ kube-apiserveræŠ¥å‘Šã€‚çŸ¥é“æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„èµ„æºæƒ…å†µï¼Œå¯¹äº pod çš„è°ƒåº¦å’Œæ­£å¸¸è¿è¡Œè‡³å…³é‡è¦ã€‚kubelet ä½¿ç”¨cAdvisorè¿›è¡Œèµ„æºä½¿ç”¨ç‡çš„ç›‘æ§ã€‚ kube-proxy çœ‹è¿™é‡Œ serviceæ˜¯ä¸€ç»„podçš„æœåŠ¡æŠ½è±¡ï¼Œç›¸å½“äºä¸€ç»„podçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™å¯¹åº”çš„podã€‚serviceä¼šæä¾›ä¸€ä¸ªclusterIPã€‚kube-proxyçš„ä½œç”¨ä¸»è¦æ˜¯è´Ÿè´£serviceçš„å®ç°ï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å®ç°äº†å†…éƒ¨è¯·æ±‚åˆ°serviceå’Œå¤–éƒ¨çš„ä»node portå‘serviceçš„è®¿é—®ï¼Œè½¬å‘åˆ°åç«¯æŸä¸ªpodã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨æœ‰podAï¼ŒpodBï¼ŒpodCå’ŒserviceABã€‚serviceABæ˜¯podAï¼ŒpodBçš„æœåŠ¡æŠ½è±¡(service)ã€‚é‚£ä¹ˆkube-proxyçš„ä½œç”¨å°±æ˜¯å¯ä»¥å°†æŸä¸€ä¸ªå‘å¾€ï¼ˆå¦‚podCå‘èµ·çš„è¯·æ±‚ï¼‰å‘serviceABçš„è¯·æ±‚ï¼Œè¿›è¡Œè½¬å‘åˆ°serviceæ‰€ä»£è¡¨çš„ä¸€ä¸ªå…·ä½“pod(podAæˆ–è€…podB)ä¸Šã€‚è¯·æ±‚çš„åˆ†é…æ–¹æ³•ä¸€èˆ¬åˆ†é…æ˜¯é‡‡ç”¨è½®è¯¢æ–¹æ³•è¿›è¡Œåˆ†é…ã€‚ kube-proxyæä¾›äº†ä¸‰ç§è´Ÿè½½å‡è¡¡å™¨ï¼ˆLBï¼‰æ¨¡å¼: ä¸€ç§æ˜¯åŸºäºç”¨æˆ·æ€çš„æ¨¡å¼userspace, ä¸€ç§æ˜¯iptablesæ¨¡å¼ï¼Œä¸€ç§æ˜¯ipvsæ¨¡å¼ã€‚ userspaceï¼šæ˜¯ä»¥socketçš„æ–¹å¼å®ç°ä»£ç†çš„ï¼Œuserspaceè¿™ç§æ¨¡å¼æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œserviceçš„è¯·æ±‚ä¼šå…ˆä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸iptablesï¼Œç„¶åå†å›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç”±kube-proxyå®Œæˆåç«¯Endpointsçš„é€‰æ‹©å’Œä»£ç†å·¥ä½œï¼Œè¿™æ ·æµé‡ä»ç”¨æˆ·ç©ºé—´è¿›å‡ºå†…æ ¸å¸¦æ¥çš„æ€§èƒ½æŸè€—æ˜¯ä¸å¯æ¥å—çš„ï¼› iptables modeï¼šå› ä¸ºä½¿ç”¨iptable NATæ¥å®Œæˆè½¬å‘ï¼Œä¹Ÿå­˜åœ¨ä¸å¯å¿½è§†çš„æ€§èƒ½æŸè€—ã€‚å¦å¤–ï¼Œå¦‚æœé›†ç¾¤ä¸­å­˜åœ¨ä¸Šä¸‡çš„Service/Endpointï¼Œé‚£ä¹ˆNodeä¸Šçš„iptables ruleså°†ä¼šéå¸¸åºå¤§ï¼Œæ€§èƒ½è¿˜ä¼šå†æ‰“æŠ˜æ‰£ï¼› IPVS æ¨¡å¼ï¼šå·¥ä½œåŸç†å…¶å®è·Ÿ iptables æ¨¡å¼ç±»ä¼¼ï¼Œå½“æˆ‘ä»¬åˆ›å»ºäº†å‰é¢çš„Service ä¹‹åï¼Œkube-proxyé¦–å…ˆä¼šåœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼ˆkube-ipvs0ï¼‰å¹¶ä¸ºä»–åˆ†é…service VIPä½œä¸ºIPåœ°å€ï¼Œkube-proxyä¼šé€šè¿‡linuxçš„IPVSæ¨¡å—ä¸ºè¿™ä¸ªIPè®¾ç½®ä¸‰ä¸ªè™šæ‹Ÿä¸»æœºï¼ˆåç«¯çš„ä¸‰ä¸ªPOD IPï¼‰ï¼Œä½¿ç”¨è½®è¯¢ä½œä¸ºLBç­–ç•¥ï¼ˆipvsadmå‘½ä»¤æŸ¥çœ‹ï¼‰ï¼ŒIPVSæ¨¡å—ä¼šè´Ÿè´£è¯·æ±‚çš„è½¬å‘ã€‚ ä»¥ä¸‹æˆªå›¾æ¥è‡ªäºæå®¢æ—¶é—´å¼ ç£Šçš„è¯¾ç¨‹æè¿°ï¼š iptablesæ¨¡å¼å’Œipvsæ¨¡å¼çš„å¯¹æ¯” æœåŠ¡æš´éœ²æ–¹å¼ çœ‹è¿™é‡Œ NodePort NodePortæœåŠ¡æ˜¯å¼•å¯¼å¤–éƒ¨æµé‡åˆ°ä½ çš„æœåŠ¡çš„æœ€åŸå§‹æ–¹å¼ã€‚å¯ä»¥é€šè¿‡è®¿é—®é›†ç¾¤å†…çš„æ¯ä¸ªNodeIP:NodePortçš„æ–¹å¼ï¼Œè®¿é—®åˆ°å¯¹åº”Serviceåç«¯çš„Endpointã€‚åœ¨æ‰€æœ‰èŠ‚ç‚¹ï¼ˆè™šæ‹Ÿæœºï¼‰ä¸Šå¼€æ”¾ä¸€ä¸ªç‰¹å®šç«¯å£ï¼Œä»»ä½•å‘é€åˆ°è¯¥ç«¯å£çš„æµé‡éƒ½è¢«è½¬å‘åˆ°å¯¹åº”æœåŠ¡ã€‚ NodePort æœåŠ¡çš„ YAML æ–‡ä»¶ç±»ä¼¼å¦‚ä¸‹ï¼š apiVersion: v1 kind: Service metadata: name: my-nodeport-service selector: app: my-app spec: type: NodePort ports: - name: http port: 80 targetPort: 80 nodePort: 30036 protocol: TCP NodePort æœåŠ¡ä¸»è¦æœ‰ä¸¤ç‚¹åŒºåˆ«äºæ™®é€šçš„â€œClusterIPâ€æœåŠ¡ã€‚ç¬¬ä¸€ï¼Œå®ƒçš„ç±»å‹æ˜¯â€œNodePortâ€ã€‚æœ‰ä¸€ä¸ªé¢å¤–çš„ç«¯å£ï¼Œç§°ä¸º nodePortï¼Œå®ƒæŒ‡å®šèŠ‚ç‚¹ä¸Šå¼€æ”¾çš„ç«¯å£å€¼ã€‚å¦‚æœä½ ä¸æŒ‡å®šè¿™ä¸ªç«¯å£ï¼Œç³»ç»Ÿå°†é€‰æ‹©ä¸€ä¸ªéšæœºç«¯å£ã€‚ ä½•æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Ÿ è¿™ç§æ–¹æ³•æœ‰è®¸å¤šç¼ºç‚¹ï¼š æ¯ä¸ªç«¯å£åªèƒ½æ˜¯ä¸€ç§æœåŠ¡ ç«¯å£èŒƒå›´åªèƒ½æ˜¯ 30000-32767 å¦‚æœèŠ‚ç‚¹/VM çš„ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œä½ éœ€è¦èƒ½å¤„ç†è¿™ç§æƒ…å†µã€‚ åŸºäºä»¥ä¸ŠåŸå› ï¼Œæˆ‘ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šç”¨è¿™ç§æ–¹å¼æš´éœ²æœåŠ¡ã€‚å¦‚æœä½ è¿è¡Œçš„æœåŠ¡ä¸è¦æ±‚ä¸€ç›´å¯ç”¨ï¼Œæˆ–è€…å¯¹æˆæœ¬æ¯”è¾ƒæ•æ„Ÿï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚è¿™æ ·çš„åº”ç”¨çš„æœ€ä½³ä¾‹å­æ˜¯ demo åº”ç”¨ï¼Œæˆ–è€…æŸäº›ä¸´æ—¶åº”ç”¨ã€‚ hostNetwork è¿™ç§æ–¹å¼åœ¨åˆ›å»ºpodæ—¶çš„yamlä¸­spec.hostNetwork: trueæŒ‡å®šèµ°ä¸»æœºç½‘ç»œï¼Œè¿™ç§æ–¹å¼podä½¿ç”¨çš„ç«¯å£å¿…é¡»æ˜¯å®¿ä¸»æœºä¸Šæ²¡æœ‰è¢«å ç”¨çš„ç«¯å£ã€‚å¤–éƒ¨å¯ä»¥ç›´æ¥é€šè¿‡podæ‰€åœ¨å®¿ä¸»æœºIP:Podç«¯å£è®¿é—®ã€‚ LoadBalancer è¿™ä¹Ÿæ˜¯ç”¨æ¥å¯¹é›†ç¾¤å¤–æš´éœ²æœåŠ¡çš„ï¼Œä¸åŒçš„æ˜¯è¿™éœ€è¦äº‘æœåŠ¡å•†çš„æ”¯æŒï¼Œæ¯”å¦‚äºšé©¬é€Šç­‰ã€‚è¿™ä¸ªæ–¹å¼çš„æœ€å¤§ç¼ºç‚¹æ˜¯æ¯ä¸€ä¸ªç”¨ LoadBalancer æš´éœ²çš„æœåŠ¡éƒ½ä¼šæœ‰å®ƒè‡ªå·±çš„ IP åœ°å€ï¼Œæ¯ä¸ªç”¨åˆ°çš„ LoadBalancer éƒ½éœ€è¦ä»˜è´¹ï¼Œè¿™æ˜¯éå¸¸æ˜‚è´µçš„ã€‚ Ingress ingressé…ç½®ä¸€ç§è·¯ç”±è½¬å‘è§„åˆ™ï¼Œingress controllerä¼šæ ¹æ®ingressä¸­çš„è§„åˆ™ï¼Œç”Ÿæˆè·¯ç”±è½¬å‘é…ç½®ã€‚å¦‚nginx-ingress-controllerï¼Œæ§åˆ¶å¾ªç¯ä¼šæ£€æµ‹ingresså¯¹è±¡çš„æ·»åŠ ï¼Œé€šè¿‡å…¶è§„åˆ™å’Œserviceã€podä¿¡æ¯ç”Ÿæˆnginxçš„é…ç½®ï¼Œé€šè¿‡nginxå®ç°å¯¹å¤–æœåŠ¡å’Œè´Ÿè½½å‡è¡¡ã€‚ podåˆ›å»ºæµç¨‹ 1ã€å®¢æˆ·ç«¯æäº¤åˆ›å»ºè¯·æ±‚ï¼Œé€šè¿‡API Serverçš„Restful APIï¼Œæˆ–è€…ç”¨kubectlå‘½ä»¤è¡Œå·¥å…·ã€‚æ”¯æŒçš„æ•°æ®ç±»å‹åŒ…æ‹¬JSONå’ŒYAMLã€‚ 2ã€API Serverå¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå­˜å‚¨Podæ•°æ®åˆ°etcdã€‚ 3ã€kube-scheduleré€šè¿‡API ServeræŸ¥çœ‹æœªç»‘å®šçš„Podã€‚å°è¯•ä¸ºPodåˆ†é…ä¸»æœºã€‚ 4ã€kube-scheduleré€šè¿‡é¢„é€‰ç®—æ³•è¿‡æ»¤æ‰ä¸ç¬¦åˆè¦æ±‚çš„ä¸»æœºã€‚æ¯”å¦‚PodæŒ‡å®šäº†æ‰€éœ€è¦çš„èµ„æºé‡ï¼Œé‚£ä¹ˆå¯ç”¨èµ„æºæ¯”Podéœ€è¦çš„èµ„æºé‡å°‘çš„ä¸»æœºä¼šè¢«è¿‡æ»¤æ‰ï¼Œç«¯å£è¢«å ç”¨çš„ä¹Ÿè¢«è¿‡æ»¤æ‰ï¼› 5ã€kube-scheduleré€šè¿‡ä¼˜é€‰ç®—æ³•ç»™ä¸»æœºæ‰“åˆ†ï¼Œå¯¹é¢„é€‰ç­›é€‰å‡ºçš„ç¬¦åˆè¦æ±‚çš„ä¸»æœºè¿›è¡Œæ‰“åˆ†ï¼Œåœ¨ä¸»æœºæ‰“åˆ†é˜¶æ®µï¼Œè°ƒåº¦å™¨ä¼šè€ƒè™‘ä¸€äº›æ•´ä½“ä¼˜åŒ–ç­–ç•¥ï¼Œæ¯”å¦‚æŠŠä¸€ä¸ªdeploymentç±»å‹çš„podåˆ†å¸ƒåˆ°ä¸åŒçš„ä¸»æœºä¸Šï¼Œä½¿å¾—èµ„æºå‡è¡¡ï¼›æˆ–è€…å°†ä¸¤ä¸ªäº²å’Œçš„æœåŠ¡åˆ†é…åˆ°åŒä¸€ä¸ªä¸»æœºä¸Šã€‚ 6ã€é€‰æ‹©ä¸»æœºï¼šé€‰æ‹©æ‰“åˆ†æœ€é«˜çš„ä¸»æœºï¼Œè¿›è¡Œbindingï¼ˆè°ƒç”¨apiserverå°†podå’Œnodeç»‘å®šï¼‰æ“ä½œï¼Œç»“æœå­˜å‚¨åˆ°etcdä¸­ã€‚ 7ã€kubeletç›‘å¬Api Serverï¼Œæ ¹æ®è°ƒåº¦ç»“æœæ‰§è¡ŒPodåˆ›å»ºæ“ä½œï¼šç»‘å®šæˆåŠŸåï¼Œschedulerä¼šè°ƒç”¨API Serverçš„APIåœ¨etcdä¸­åˆ›å»ºä¸€ä¸ªbound podå¯¹è±¡ï¼Œæè¿°åœ¨ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šç»‘å®šè¿è¡Œçš„æ‰€æœ‰podä¿¡æ¯ã€‚è¿è¡Œåœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šçš„kubeletä¹Ÿä¼šå®šæœŸä¸etcdåŒæ­¥bound podä¿¡æ¯ï¼Œä¸€æ—¦å‘ç°åº”è¯¥åœ¨è¯¥å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œçš„bound podå¯¹è±¡æ²¡æœ‰æ›´æ–°ï¼Œåˆ™è°ƒç”¨Docker APIåˆ›å»ºå¹¶å¯åŠ¨podå†…çš„å®¹å™¨ã€‚ 8ã€kubeletè°ƒç”¨CNIï¼ˆDocker è¿è¡Œæˆ–é€šè¿‡ rkt)è¿è¡Œ Pod çš„å®¹å™¨ã€‚å¹¶å‘¨æœŸæ€§çš„å¯¹å®¹å™¨ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ¢æµ‹ã€‚ï¼ˆå¥åº·æ£€æŸ¥readness-éš”ç¦»ã€liveness-é‡å¯ï¼‰ å„ç»„ä»¶åŸºæœ¬éƒ½æ˜¯é€šè¿‡API Serveræä¾›çš„list-watch APIè¿›è¡Œç›‘å¬èµ„æºå¯¹è±¡å˜åŒ–ï¼Œè¿›è¡Œè‡ªå·±çš„æ§åˆ¶å¾ªç¯ï¼Œè¿™äº›æ ¸å¿ƒåŠŸèƒ½éƒ½è¢«å°è£…åˆ°äº†client-goåŒ…ä¸­ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œé€šè¿‡CRDç¼–å†™controllerã€operatorè¿›è¡Œè‡ªå·±çš„æ§åˆ¶å¾ªç¯é€»è¾‘ã€è¿ç»´è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå¾ˆè½»æ¾çš„æ‰©å±•k8sèƒ½åŠ›ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sçŸ¥è¯†ç‚¹/k8sçŸ¥è¯†ç‚¹.html":{"url":"linux/k8s/k8sçŸ¥è¯†ç‚¹/k8sçŸ¥è¯†ç‚¹.html","title":"k8sçŸ¥è¯†ç‚¹","keywords":"","body":"k8sçŸ¥è¯†ç‚¹ k8så‘½ä»¤è‡ªåŠ¨è¡¥å…¨ yum install -y bash-completion source /usr/share/bash-completion/bash_completion source > ~/.bashrc ä¸€ã€k8sç‰¹æ€§ æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ Kubernetes å¯ä»¥ä½¿ç”¨ DNS åç§°æˆ–è‡ªå·±çš„ IP åœ°å€å…¬å¼€å®¹å™¨ï¼Œå¦‚æœåˆ°å®¹å™¨çš„æµé‡å¾ˆå¤§ï¼ŒKubernetes å¯ä»¥è´Ÿè½½å‡è¡¡å¹¶åˆ†é…ç½‘ç»œæµé‡ï¼Œä»è€Œä½¿éƒ¨ç½²ç¨³å®šã€‚ å­˜å‚¨ç¼–æ’ Kubernetes å…è®¸æ‚¨è‡ªåŠ¨æŒ‚è½½æ‚¨é€‰æ‹©çš„å­˜å‚¨ç³»ç»Ÿï¼Œä¾‹å¦‚æœ¬åœ°å­˜å‚¨ã€å…¬å…±äº‘æä¾›å•†ç­‰ã€‚ è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š æ‚¨å¯ä»¥ä½¿ç”¨ Kubernetes æè¿°å·²éƒ¨ç½²å®¹å™¨çš„æ‰€éœ€çŠ¶æ€ï¼Œå®ƒå¯ä»¥ä»¥å—æ§çš„é€Ÿç‡å°†å®é™…çŠ¶æ€æ›´æ”¹ä¸ºæ‰€éœ€çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è‡ªåŠ¨åŒ– Kubernetes æ¥ä¸ºæ‚¨çš„éƒ¨ç½²åˆ›å»ºæ–°å®¹å™¨ï¼Œåˆ é™¤ç°æœ‰å®¹å™¨å¹¶å°†å®ƒä»¬çš„æ‰€æœ‰èµ„æºç”¨äºæ–°å®¹å™¨ã€‚ è‡ªåŠ¨äºŒè¿›åˆ¶æ‰“åŒ… Kubernetes å…è®¸æ‚¨æŒ‡å®šæ¯ä¸ªå®¹å™¨æ‰€éœ€ CPU å’Œå†…å­˜ï¼ˆRAMï¼‰ã€‚å½“å®¹å™¨æŒ‡å®šäº†èµ„æºè¯·æ±‚æ—¶ï¼ŒKubernetes å¯ä»¥åšå‡ºæ›´å¥½çš„å†³ç­–æ¥ç®¡ç†å®¹å™¨çš„èµ„æºã€‚ è‡ªæˆ‘ä¿®å¤ Kubernetes é‡æ–°å¯åŠ¨å¤±è´¥çš„å®¹å™¨ã€æ›¿æ¢å®¹å™¨ã€æ€æ­»ä¸å“åº”ç”¨æˆ·å®šä¹‰çš„è¿è¡ŒçŠ¶å†µæ£€æŸ¥çš„å®¹å™¨ï¼Œå¹¶ä¸”åœ¨å‡†å¤‡å¥½æœåŠ¡ä¹‹å‰ä¸å°†å…¶é€šå‘Šç»™å®¢æˆ·ç«¯ã€‚ å¯†é’¥ä¸é…ç½®ç®¡ç† Kubernetes å…è®¸æ‚¨å­˜å‚¨å’Œç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€OAuth ä»¤ç‰Œå’Œ ssh å¯†é’¥ã€‚æ‚¨å¯ä»¥åœ¨ä¸é‡å»ºå®¹å™¨é•œåƒçš„æƒ…å†µä¸‹éƒ¨ç½²å’Œæ›´æ–°å¯†é’¥å’Œåº”ç”¨ç¨‹åºé…ç½®ï¼Œä¹Ÿæ— éœ€åœ¨å †æ ˆé…ç½®ä¸­æš´éœ²å¯†é’¥ã€‚ äºŒã€k8sæ¦‚å¿µå’Œæœ¯è¯­ 2.1 k8sè§’è‰² 2.1.1 master k8sä½¿ç”¨å…±äº«ç½‘è·¯å°†å¤šä¸ªç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºæ±‡é›†åˆ°ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œåœ¨å„æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œè¯¥é›†ç¾¤æ˜¯æ˜¯é…ç½®k8sçš„æ‰€æœ‰ç»„ä»¶ã€åŠŸèƒ½å’Œå·¥ä½œè´Ÿè½½çš„ç‰©ç†å¹³å° é›†ç¾¤ä¸­çš„ä¸€å°æœºå™¨(æˆ–è€…é«˜å¯ç”¨éƒ¨ç½²ä¸­çš„ä¸€ç»„æœåŠ¡å™¨)ç”¨ä½œmasterï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ªé›†ç¾¤ 2.1.2 node é›†ç¾¤ä¸­é™¤masterèŠ‚ç‚¹å¤–çš„å…¶ä½™æœºå™¨ç”¨ä½œnodeï¼Œä»–ä»¬æ˜¯ä½¿ç”¨æœ¬åœ°å’Œå¤–éƒ¨èµ„æºæ¥æ”¶å’Œè¿è¡Œå·¥ä½œè´Ÿè½½çš„æœåŠ¡å™¨ é›†ç¾¤ä¸­çš„è¿™äº›æœºå™¨å¯ä»¥æ˜¯ç‰©ç†æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯è™šæ‹Ÿæœº 2.2 k8sèµ„æº 2.2.1 pod k8så¹¶ä¸ç›´æ¥è¿è¡Œå®¹å™¨ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªæŠ½è±¡çš„èµ„æºå¯¹è±¡æ¥å°è£…ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼Œè¿™ä¸ªæŠ½è±¡å³ä¸ºpodï¼Œpodæ˜¯k8sçš„æœ€å°è°ƒåº¦å•å…ƒ åŒä¸€podä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œåç§°ç©ºé—´å’Œå­˜å‚¨èµ„æºï¼Œè¿™äº›å®¹å™¨å¯ç»ç”±æœ¬åœ°å›ç¯æ¥å£loç›´æ¥é€šä¿¡ï¼Œä½†å½¼æ­¤ä¹‹é—´åˆåœ¨mountã€useråŠPIDç­‰åç§°ç©ºé—´ä¸Šä¿æŒéš”ç¦» podç¤ºæ„å›¾ 2.2.2 label èµ„æºæ ‡ç­¾ æ ‡ç­¾æ˜¯å°†èµ„æºè¿›è¡Œåˆ†ç±»çš„æ ‡è¯†ç¬¦ï¼Œèµ„æºæ ‡ç­¾å…¶å®å°±æ˜¯ä¸€ä¸ªå¥å€¼å‹æ•°æ® æ ‡ç­¾æ˜¯ç”¨äºæŒ‡å®šå¯¹è±¡(å¦‚pod)è¾¨è¯†æ€§çš„å±æ€§ï¼Œè¿™äº›å±æ€§ä»…å¯¹ç”¨æˆ·å­˜åœ¨ç‰¹å®šçš„æ„ä¹‰ï¼Œå¯¹k8sé›†ç¾¤æ¥è¯´å¹¶ä¸ç›´æ¥è¡¨è¾¾æ ¸å¿ƒç³»ç»Ÿè¯­ä¹‰ æ ‡ç­¾å¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºæ—¶é™„åŠ å…¶ä¸Šï¼Œå¹¶èƒ½å¤Ÿåœ¨åˆ›å»ºåçš„ä»»æ„æ—¶é—´è¿›è¡Œæ·»åŠ å’Œä¿®æ”¹ ä¸€ä¸ªå¯¹è±¡å¯ä»¥æ‹¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œä¸€ä¸ªæ ‡ç­¾ä¹Ÿå¯ä»¥é™„åŠ äºå¤šä¸ªå¯¹è±¡ä¹‹ä¸Š 2.2.3 selector æ ‡ç­¾é€‰æ‹©å™¨ æ ‡ç­¾é€‰æ‹©å™¨å…¨ç§°ä¸ºlabel selectorï¼Œæ˜¯ä¸€ç§æ ¹æ®lableæ¥è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„èµ„æºå¯¹è±¡çš„æœºåˆ¶ï¼Œä¾‹å¦‚å°†é™„æœ‰æ ‡ç­¾role:backendçš„æ‰€æœ‰podå¯¹è±¡æŒ‘é€‰å‡ºæ¥å½’ä¸ºä¸€ç»„å°±æ˜¯æ ‡ç­¾é€‰æ‹©å™¨çš„ä¸€ç§åº”ç”¨ 2.2.4 controller podæ§åˆ¶å™¨ å°½ç®¡podæ˜¯k8sä¸­çš„æœ€å°è°ƒåº¦å•å…ƒï¼Œä½†ç”¨æˆ·é€šå¸¸å¹¶ä¸ä¼šç›´æ¥éƒ¨ç½²åŠç®¡ç†podå¯¹è±¡ï¼Œè€Œæ˜¯è¦å€ŸåŠ©äºæ§åˆ¶å™¨å¯¹å…¶è¿›è¡Œç®¡ç† ç”¨äºå·¥ä½œè´Ÿè½½çš„æ§åˆ¶å™¨æ˜¯ä¸€ç§ç®¡ç†podç”Ÿå‘½å‘¨æœŸçš„èµ„æºæŠ½è±¡ï¼Œæ˜¯k8sä¸Šçš„ä¸€ç±»å¯¹è±¡è€Œéå•ä¸ªèµ„æºå¯¹è±¡ ä½¿ç”¨æ§åˆ¶å™¨ä¹‹åå°±ä¸å†éœ€è¦æ‰‹åŠ¨ç®¡ç†podå¯¹è±¡äº†ï¼Œç”¨æˆ·åªéœ€è¦å£°æ˜åº”ç”¨çš„æœŸæœ›çŠ¶æ€ï¼Œæ§åˆ¶å™¨å°±ä¼šè‡ªåŠ¨å¯¹å…¶è¿›è¡Œè¿›ç¨‹ç®¡ç† podæ§åˆ¶å™¨åŒ…æ‹¬ReplicationControllerã€ReplicaSetã€Deploymentã€Statefulsetã€Jobç­‰ 2.2.5 service æœåŠ¡èµ„æº serviceæ˜¯å»ºç«‹åœ¨ä¸€ç»„podå¯¹è±¡ä¹‹ä¸Šçš„èµ„æºæŠ½è±¡ï¼Œå®ƒé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨é€‰æ‹©ä¸€ç»„podå¯¹è±¡ï¼Œå¹¶ä¸ºè¿™ç»„podå¯¹è±¡å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„å›ºå®šè®¿é—®å…¥å£(é€šå¸¸æ˜¯ä¸€ä¸ªIPåœ°å€)ï¼Œè‹¥k8sé›†ç¾¤å­˜åœ¨DNSé™„ä»¶ï¼Œå®ƒå°±ä¼šåœ¨serviceåˆ›å»ºæ—¶ä¸ºå…¶è‡ªåŠ¨é…ç½®ä¸€ä¸ªDNSåç§°ä»¥ä¾¿å®¢æˆ·ç«¯è¿›è¡ŒæœåŠ¡å‘ç° åˆ°è¾¾service IPçš„è¯·æ±‚å°†è´Ÿè½½å‡è¡¡è‡³å…¶åçš„ç«¯ç‚¹-->å„ä¸ªpodå¯¹è±¡ä¹‹ä¸Šï¼Œå› æ­¤serviceä»æœ¬è´¨ä¸Šæ¥è®²æ˜¯ä¸€ä¸ªå››å±‚ä»£ç†æœåŠ¡ serviceè¿˜å¯ä»¥å°†é›†ç¾¤å¤–éƒ¨æµé‡å¼•å…¥åˆ°é›†ç¾¤ä¸­æ¥ 2.2.6 volume å­˜å‚¨å· å­˜å‚¨å·æ˜¯ç‹¬ç«‹äºå®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¹‹å¤–çš„å­˜å‚¨ç©ºé—´ï¼Œå¸¸ç”¨äºæ‰©å±•å®¹å™¨çš„å­˜å‚¨ç©ºé—´å¹¶ä¸ºå®ƒæä¾›æŒä¹…å­˜å‚¨èƒ½åŠ› k8sé›†ç¾¤ä¸Šçš„å­˜å‚¨å·å¤§ä½“å¯åˆ†ä¸ºä¸´æ—¶å·ã€æœ¬åœ°å·å’Œç½‘è·¯å· ä¸´æ—¶å·å’Œæœ¬åœ°å·éƒ½ä½äºnodeæœ¬åœ°ï¼Œä¸€æ—¦podè¢«è°ƒåº¦è‡³å…¶ä»–nodeï¼Œæ­¤ç§ç±»å‹çš„å­˜å‚¨å·å°†æ— æ³•è®¿é—®ï¼Œå› æ­¤ä¸´æ—¶å·å’Œæœ¬åœ°å·é€šå¸¸ç”¨äºæ•°æ®ç¼“å­˜ï¼ŒæŒä¹…åŒ–çš„æ•°æ®åˆ™éœ€è¦æ”¾ç½®äºæŒä¹…å·(persistent volume)ä¹‹ä¸Š 2.2.7 name(åç§°)å’Œnamespace(åç§°ç©ºé—´) åç§°æ˜¯k8sé›†ç¾¤ä¸­èµ„æºå¯¹è±¡çš„æ ‡è¯†ç¬¦ï¼Œå®ƒä»¬çš„ä½œç”¨åŸŸé€šå¸¸æ˜¯åç§°ç©ºé—´(namespace)ï¼Œå› æ­¤åç§°ç©ºé—´æ˜¯åç§°çš„é¢å¤–é™å®šæœºåˆ¶ åœ¨åŒä¸€ä¸ªåç§°ç©ºé—´ä¸­ï¼ŒåŒä¸€ç±»å‹èµ„æºå¯¹è±¡çš„åç§°å¿…é¡»å…·æœ‰å”¯ä¸€æ€§ï¼Œåç§°ç©ºé—´é€šå¸¸ç”¨äºå®ç°é¡¹ç›®çš„èµ„æºéš”ç¦»ï¼Œä»è€Œå½¢æˆé€»è¾‘åˆ†ç»„ åˆ›å»ºçš„podå’Œserviceç­‰èµ„æºå¯¹è±¡éƒ½å±äºåç§°ç©ºé—´çº§åˆ«ï¼ŒæœªæŒ‡å®šæ—¶ï¼Œå®ƒä»¬éƒ½å±äºé»˜è®¤çš„åç§°ç©ºé—´default 2.2.8 annotaion æ³¨è§£ æ³¨è§£æ—¶å¦ä¸€ç§é™„åŠ åœ¨å¯¹è±¡ä¹‹ä¸Šçš„é”®å€¼å‹çš„æ•°æ®ï¼Œä½†å®ƒæ‹¥æœ‰æ›´å¤§çš„æ•°æ®å®¹é‡ æ³¨è§£å¸¸ç”¨äºå°†å„ç§éæ ‡è¯†å‹å…ƒæ•°æ®(metadata)é™„åŠ åˆ°å¯¹è±¡ä¸Šï¼Œä½†å®ƒä¸èƒ½ç”¨äºæ ‡è¯†å’Œé€‰æ‹©å¯¹è±¡ï¼Œé€šå¸¸ä¹Ÿä¸ä¼šè¢«k8sç›´æ¥ä½¿ç”¨ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯æ–¹ä¾¿å·¥å…·æˆ–ç”¨æˆ·çš„é˜…è¯»åŠæŸ¥æ‰¾ 2.2.9 ingress k8så°†podå¯¹è±¡å’Œå¤–éƒ¨ç½‘è·¯ç¯å¢ƒè¿›è¡Œäº†éš”ç¦»ï¼Œpodå’Œserviceç­‰å¯¹è±¡é—´çš„é€šä¿¡éƒ½ä½¿ç”¨å…¶å†…éƒ¨ä¸“ç”¨åœ°å€è¿›è¡Œï¼Œå¦‚è‹¥éœ€è¦å¼€æ”¾æŸäº›podå¯¹è±¡æä¾›ç»™å¤–éƒ¨ç”¨æˆ·è®¿é—®ï¼Œåˆ™éœ€è¦ä¸ºå…¶è¯·æ±‚æµé‡æ‰“å¼€ä¸€ä¸ªé€šå¾€k8sé›†ç¾¤å†…éƒ¨çš„é€šé“ï¼Œé™¤äº†serviceä¹‹å¤–ï¼Œingressä¹Ÿæ˜¯è¿™ç±»é€šé“çš„å®ç°æ–¹å¼ä¹‹ä¸€ ä¸‰ã€k8sæ¶æ„ 3.1k8sæ¶æ„å›¾ 3.2 masterã€nodeç»„ä»¶ masterèŠ‚ç‚¹ è´Ÿè´£é›†ç¾¤ç®¡ç†ï¼Œæ¥å—ç”¨æˆ·è¯·æ±‚ï¼Œå°†è¯·æ±‚åˆ†æ•£åˆ°nodeèŠ‚ç‚¹ scheduler è°ƒåº¦å™¨ï¼Œè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†podè°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Š apiserver æ•´ä¸ªæ¶æ„çš„æ ¸å¿ƒï¼Œåè°ƒè€…çš„è§’è‰²ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½è¦ä¸apiserveré€šä¿¡ï¼Œæä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ controller manager æ§åˆ¶å™¨ï¼Œè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ï¼Œè‡ªåŠ¨æ‰©å±•ï¼Œæ»šåŠ¨æ›´æ–°ç­‰ etcd(ç‹¬ç«‹ç»„ä»¶ï¼Œä¸å±äºk8sé›†ç¾¤) key valueåˆ†å¸ƒå¼å­˜å‚¨ï¼Œå­˜å‚¨k8sçš„æ•°æ®ï¼Œä¸»è¦æ˜¯masterèŠ‚ç‚¹çš„apiserverè¿æ¥etcd nodeèŠ‚ç‚¹ è®¡ç®—èŠ‚ç‚¹ï¼Œæ¥å—masteræŒ‡ä»¤ï¼Œè¿è¡Œä»»åŠ¡ kubelet masterçš„agentï¼Œè´Ÿè´£æ¥æ”¶masterçš„ä»»åŠ¡å¹¶å®Œæˆä»»åŠ¡ï¼Œè´Ÿè´£ç»´æŠ¤å®¹å™¨ç­‰ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£volumeå’Œç½‘ç»œçš„ç®¡ç† kube-proxy è´Ÿè´£ä¸ºserviceæä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ å®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒ k8sä¸å…·å¤‡å®¹å™¨å¼•æ“ï¼Œä¸èƒ½ç›´æ¥è¿è¡Œå®¹å™¨ï¼Œéœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹å®¹å™¨å¼•æ“æ¥è¿è¡Œå’Œç®¡ç†å®¹å™¨ï¼Œä¾‹å¦‚docker 3.3 æ ¸å¿ƒé™„ä»¶ 3.3.1 coreDNS åœ¨k8sé›†ç¾¤ä¸­è°ƒåº¦è¿è¡Œæä¾›DNSæœåŠ¡çš„podï¼ŒåŒä¸€é›†ç¾¤ä¸­çš„å…¶ä»–podå¯ä½¿ç”¨æ­¤DNSæœåŠ¡è§£å†³ä¸»æœºåï¼Œk8s1.11ç‰ˆæœ¬å¼€å§‹é»˜è®¤ä½¿ç”¨coreDNSé¡¹ç›®ä¸ºé›†ç¾¤æä¾›æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡å‘ç°çš„åŠ¨æ€åç§°è§£ææœåŠ¡ï¼Œä¹‹å‰çš„ç‰ˆæœ¬ä¸­ç”¨åˆ°çš„æ˜¯kubeDNSï¼Œè€ŒskyDNSåˆ™æ˜¯æ›´æ—©ç‰ˆæœ¬ä½¿ç”¨çš„ 3.3.2 dashboard k8sé›†ç¾¤çš„å…¨éƒ¨åŠŸèƒ½éƒ½è¦åŸºäºwebçš„UIï¼Œæ¥ç®¡ç†é›†ç¾¤ä¸­çš„åº”ç”¨å’Œé›†ç¾¤è‡ªèº« 3.3.3 heapster å®¹å™¨å’ŒèŠ‚ç‚¹çš„æ€§èƒ½ç›‘æ§ä¸åˆ†æç³»ç»Ÿï¼Œå®ƒæ”¶é›†å¹¶è§£æå¤šç§æŒ‡æ ‡æ•°æ®ï¼Œå¦‚èµ„æºåˆ©ç”¨ç‡ã€ç”Ÿå‘½å‘¨æœŸç­‰ ç”±äºç›‘æ§é¡¹æ¯”è¾ƒå°‘ï¼Œå·²ç”±prometheusä»£æ›¿ 3.3.4 ingress controller ä¸ºæœåŠ¡æä¾›å¤–ç½‘å…¥å£ï¼Œ7å±‚è´Ÿè½½å‡è¡¡ï¼Œé»˜è®¤kube-processåªèƒ½æä¾›4å±‚è´Ÿè½½å‡è¡¡ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sçŸ¥è¯†ç‚¹/kubeadm ä¸“é¢˜ ä¸€ init ç©¶ç«Ÿå¹²äº†äº›ä»€ä¹ˆ.html":{"url":"linux/k8s/k8sçŸ¥è¯†ç‚¹/kubeadm ä¸“é¢˜ ä¸€ init ç©¶ç«Ÿå¹²äº†äº›ä»€ä¹ˆ.html","title":"kubeadm initæµç¨‹","keywords":"","body":"kubeadm ä¸“é¢˜ ä¸€ init ç©¶ç«Ÿå¹²äº†äº›ä»€ä¹ˆ æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ kubeadm æ‰€åœ¨å±‚æ¬¡ kubeadm å±äºç¬¬äºŒå±‚ï¼Œç”¨äºç®¡ç†é›†ç¾¤ã€‚ kubeadm init çš„æµç¨‹ï¼ˆphaseï¼‰ä»‹ç» phase é˜¶æ®µ preflight é¢„ç½®æ£€æŸ¥ kubelet-start ç”Ÿæˆ kubelet é…ç½®ï¼Œå¹¶é‡å¯kubelet certs ç”Ÿæˆè®¤è¯ /etcd-ca ç”Ÿæˆè‡ªç­¾åCAä»¥ä¸ºetcdé…ç½®æ ‡è¯† /apiserver-etcd-client ç”Ÿæˆapiserverç”¨äºè®¿é—®etcdçš„è¯ä¹¦ /etcd-healthcheck-client ç”Ÿæˆlivenessæ¢é’ˆä½¿ç”¨çš„è¯ä¹¦ï¼Œç”¨äºæ£€æŸ¥etcd çš„ healtcheck çŠ¶æ€ /etcd-server ç”Ÿæˆ etcd æœåŠ¡ä½¿ç”¨çš„çš„è¯ä¹¦ /etcd-peer ä¸ºetcdèŠ‚ç‚¹ç”Ÿæˆè¯ä¹¦ä»¥ç›¸äº’é€šä¿¡ /ca ç”Ÿæˆè‡ªç­¾åçš„ Kubernetes CAï¼Œä¸ºå…¶ä»– Kubernetes ç»„ä»¶é¢„é…æ ‡è¯† /apiserver ç”Ÿæˆç”¨äºæä¾› Kubernetes API çš„è¯ä¹¦ api serverç«¯è¯ä¹¦ /apiserver-kubelet-client ä¸º API æœåŠ¡å™¨ç”Ÿæˆè¯ä¹¦ä»¥è¿æ¥åˆ° kubelet /front-proxy-ca ç”Ÿæˆè‡ªç­¾å CA ä»¥é¢„é…front proxy æ ‡è¯† /front-proxy-client ä¸ºå‰ç«¯ä»£ç†å®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦ /sa ç”Ÿæˆç”¨äºå¯¹æœåŠ¡å¸æˆ·ä»¤ç‰ŒåŠå…¶å…¬é’¥è¿›è¡Œç­¾åçš„ç§é’¥ kubeconfig ç”Ÿæˆ control plane å’Œ admin ç®¡ç†å‘˜ç›¸å…³çš„kubeconfig æ–‡ä»¶ /admin ç”Ÿæˆadmin ç®¡ç†å‘˜å’Œkubeadm è‡ªèº«ä½¿ç”¨çš„kubeconfigæ–‡ä»¶ /kubelet ç”Ÿæˆkebeletä½¿ç”¨çš„ï¼Œä»…ç”¨äºå¼•å¯¼é›†ç¾¤ï¼ˆbootstrapï¼‰çš„kubeconfig æ–‡ä»¶ /controller-manager ç”Ÿæˆ controller manager ä½¿ç”¨çš„kubeconfigæ–‡ä»¶ /scheduler ç”Ÿæˆ scheduler ä½¿ç”¨çš„kubeconfigæ–‡ä»¶ kubelet-start ç”Ÿæˆkubeletçš„ç¯å¢ƒå˜é‡æ–‡ä»¶/var/lib/kubelet/kubeadm-flags.env å’Œ é…ç½®ä¿¡æ¯æ–‡ä»¶ /var/lib/kubelet/config.yamlï¼Œç„¶å å¯åŠ¨/é‡å¯ kubeletï¼ˆsystemd æ¨¡å¼ï¼‰ control-plane ç”Ÿæˆæ‹‰èµ· control planeï¼ˆmasterï¼‰static Pod çš„ manifest æ–‡ä»¶ /apiserver ç”Ÿæˆæ‹‰èµ· kube-apiserver çš„ static Pod manifest /controller-manager ç”Ÿæˆæ‹‰èµ· kube-controller-manager çš„static Pod manifest /scheduler ç”Ÿæˆæ‹‰èµ· kube-scheduler çš„ static Pod manifest etcd ç”Ÿæˆæœ¬åœ° ETCDçš„ static Pod manifest æ–‡ä»¶ /local ç”Ÿæˆå•èŠ‚ç‚¹æœ¬åœ° ETCD static Pod manifest æ–‡ä»¶ upload-config ä¸Šä¼ kubeadmå’Œkubeleté…ç½®ä¸º ConfigMap /kubeadm ä¸Šä¼  kubeadm ClusterConfiguration ä¸º ConfigMap /kubelet ä¸Šä¼  kubelet component config ä¸º ConfigMap upload-certs ä¸Šä¼ è¯ä¹¦åˆ° kubeadm-certs mark-control-plane æ ‡è¯†èŠ‚ç‚¹ä¸º control-plane bootstrap-token ç”Ÿæˆ bootstrap tokens ç”¨äºå…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ addon å®‰è£…æ‰€éœ€çš„æ’ä»¶ä»¥é€šè¿‡ä¸€è‡´æ€§æµ‹è¯• /coredns å®‰è£… CoreDNS æ’ä»¶ /kube-proxy å®‰è£… kube-proxy æ’ä»¶ kubeadm å‘½ä»¤è¡Œå‚æ•° å‘½ä»¤ç”¨æ³• kubeadm init [flags] å‚æ•°è¯´æ˜ --apiserver-advertise-address string è®¾ç½® apiserver ç»‘å®šçš„ IP. --apiserver-bind-port int32 è®¾ç½®apiserver ç›‘å¬çš„ç«¯å£. (é»˜è®¤ 6443) --apiserver-cert-extra-sans strings apiè¯ä¹¦ä¸­æŒ‡å®šé¢å¤–çš„Subject Alternative Names (SANs) å¯ä»¥æ˜¯IP ä¹Ÿå¯ä»¥æ˜¯DNSåç§°ã€‚ è¯ä¹¦æ˜¯å’ŒSANç»‘å®šçš„ã€‚ --cert-dir string è¯ä¹¦å­˜æ”¾çš„ç›®å½• (é»˜è®¤ \"/etc/kubernetes/pki\") --certificate-key string kubeadm-cert secret ä¸­ ç”¨äºåŠ å¯† control-plane è¯ä¹¦çš„key --config string kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„. --cri-socket string CRI socket æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸ºç©º kubeadm å°†è‡ªåŠ¨å‘ç°ç›¸å…³çš„socketæ–‡ä»¶; åªæœ‰å½“æœºå™¨ä¸­å­˜åœ¨å¤šä¸ª CRI socket æˆ–è€… å­˜åœ¨éæ ‡å‡† CRI socket æ—¶æ‰æŒ‡å®š. --dry-run æµ‹è¯•ï¼Œå¹¶ä¸çœŸæ­£æ‰§è¡Œ;è¾“å‡ºè¿è¡Œåçš„ç»“æœ. --feature-gates string æŒ‡å®šå¯ç”¨å“ªäº›é¢å¤–çš„feature ä½¿ç”¨ key=value å¯¹çš„å½¢å¼ã€‚ --help å¸®åŠ©æ–‡æ¡£ --ignore-preflight-errors strings å¿½ç•¥å‰ç½®æ£€æŸ¥é”™è¯¯ï¼Œè¢«å¿½ç•¥çš„é”™è¯¯å°†è¢«æ˜¾ç¤ºä¸ºè­¦å‘Š. ä¾‹å­: 'IsPrivilegedUser,Swap'. Value 'all' ignores errors from all checks. --image-repository string é€‰æ‹©æ‹‰å– control plane images çš„é•œåƒrepo (default \"k8s.gcr.io\") --kubernetes-version string é€‰æ‹©K8Sç‰ˆæœ¬. (default \"stable-1\") --node-name string æŒ‡å®šnodeçš„åç§°ï¼Œé»˜è®¤ä½¿ç”¨ node çš„ hostname. --pod-network-cidr string æŒ‡å®š pod çš„ç½‘ç»œï¼Œ control plane ä¼šè‡ªåŠ¨å°† ç½‘ç»œå‘å¸ƒåˆ°å…¶ä»–èŠ‚ç‚¹çš„nodeï¼Œè®©å…¶ä¸Šå¯åŠ¨çš„å®¹å™¨ä½¿ç”¨æ­¤ç½‘ç»œ --service-cidr string æŒ‡å®šservice çš„IP èŒƒå›´. (default \"10.96.0.0/12\") --service-dns-domain string æŒ‡å®š service çš„ dns åç¼€, e.g. \"myorg.internal\". (default \"cluster.local\") --skip-certificate-key-print ä¸æ‰“å° control-plane ç”¨äºåŠ å¯†è¯ä¹¦çš„key. --skip-phases strings è·³è¿‡æŒ‡å®šçš„é˜¶æ®µï¼ˆphaseï¼‰ --skip-token-print ä¸æ‰“å° kubeadm init ç”Ÿæˆçš„ default bootstrap token --token string æŒ‡å®š node å’Œcontrol plane ä¹‹é—´ï¼Œç®€å†åŒå‘è®¤è¯çš„token ï¼Œæ ¼å¼ä¸º [a-z0-9]{6}\\.[a-z0-9]{16} - e.g. abcdef.0123456789abcdef --token-ttl duration token è‡ªåŠ¨åˆ é™¤çš„æ—¶é—´é—´éš”ã€‚ (e.g. 1s, 2m, 3h). å¦‚æœè®¾ç½®ä¸º '0', token æ°¸ä¸è¿‡æœŸ (default 24h0m0s) --upload-certs ä¸Šä¼  control-plane è¯ä¹¦åˆ° kubeadm-certs Secret. init å·¥ä½œæµ kubeadm inité€šè¿‡æ‰§è¡Œä»¥ä¸‹æ­¥éª¤æ¥å¼•å¯¼Kubernetesæ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼š 1.åœ¨è¿›è¡Œæ›´æ”¹ä¹‹å‰è¿è¡Œä¸€ç³»åˆ—é£è¡Œå‰æ£€æŸ¥ä»¥éªŒè¯ç³»ç»ŸçŠ¶æ€ã€‚æŸäº›æ£€æŸ¥ä»…è§¦å‘è­¦å‘Šï¼Œå…¶ä»–æ£€æŸ¥è¢«è§†ä¸ºé”™è¯¯ï¼Œå¹¶å°†é€€å‡ºkubeadmï¼Œç›´åˆ°é—®é¢˜å¾—åˆ°çº æ­£æˆ–ç”¨æˆ·æŒ‡å®š--ignore-preflight-errors = ã€‚ æ¥å¿½ç•¥é”™è¯¯ã€‚ 2.ç”Ÿæˆè‡ªç­¾å CAï¼ˆæˆ–ä½¿ç”¨ç°æœ‰CAï¼‰ï¼Œä»¥ä¾¿ä¸ºç¾¤é›†ä¸­çš„æ¯ä¸ªç»„ä»¶è®¾ç½®æ ‡è¯†ã€‚å¦‚æœç”¨æˆ·é€šè¿‡å°†å…¶æ”¾åœ¨é€šè¿‡--cert-diré…ç½®çš„certç›®å½•ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸º/etc/kubernetes/pkiï¼‰ä¸­æä¾›äº†è‡ªå·±çš„CAè¯ä¹¦å’Œ/æˆ–å¯†é’¥ï¼Œåˆ™ä¼šè·³è¿‡æ­¤æ­¥éª¤ï¼Œå¦‚ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦æ–‡æ¡£ä¸­æ‰€è¿°ã€‚ APIServerè¯ä¹¦å°†--apiserver-cert-extra-sanså‚æ•°æä¾›çš„é¢å¤–SANæ¡ç›®æ·»åŠ åˆ°è¯ä¹¦ä¿¡æ¯ä¸­ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥å°å†™ã€‚ 3.åœ¨/etc/kubernetes/ä¸­ä¸º kubeletï¼Œ controller-managerå’Œscheduler å†™å…¥kubeconfigæ–‡ä»¶ï¼Œç”¨äºè¿æ¥åˆ°APIæœåŠ¡å™¨ï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„æ ‡è¯†ï¼Œä»¥åŠå¦ä¸€ä¸ªåä¸ºadmin.confçš„ç®¡ç†å‘˜kubeconfigæ–‡ä»¶ã€‚ 4.ç”Ÿæˆå¯åŠ¨ kubelet æœåŠ¡æ‰€éœ€çš„é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡ï¼Œå¹¶å¯åŠ¨kubelet ï¼ˆsystemd æ–¹å¼ï¼‰ç”Ÿæˆæ–‡ä»¶å¦‚ä¸‹ /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf ç¯å¢ƒå˜é‡ /etc/kubernetes/bootstrap-kubelet.conf/ /etc/kubernetes/kubelet.conf /var/lib/kubelet/config.yaml /var/lib/kubelet/kubeadm-flags.env ç¯å¢ƒå˜é‡ kubelet ä½¿ç”¨4ä¸ªæ–‡ä»¶çš„æ–¹å¼å¦‚ä¸‹ [root@rancher ~]# systemctl status kubelet â— kubelet.service - kubelet: The Kubernetes Node Agent Loaded: loaded (/usr/lib/systemd/system/kubelet.service; disabled; vendor preset: disabled) Drop-In: /usr/lib/systemd/system/kubelet.service.d â””â”€10-kubeadm.conf Active: active (running) since Sun 2019-08-18 14:16:37 CST; 13min ago Docs: https://kubernetes.io/docs/ Main PID: 14980 (kubelet) CGroup: /system.slice/kubelet.service â””â”€14980 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml 1.ä¸ºapiserverï¼Œcontrol-manager å’Œscheduler ç”Ÿæˆé™æ€Podæ¸…å•ã€‚ å¦‚æœæœªæä¾›å¤–éƒ¨etcdï¼Œåˆ™ä¼šä¸ºetcdç”Ÿæˆå…¶ä»–é™æ€Podæ¸…å•ã€‚ Static Podæ¸…å•å†™å…¥/etc/kubernetes/manifests; kubeletç›‘è§†æ­¤ç›®å½•ä»¥ä¾¿Podsåœ¨å¯åŠ¨æ—¶åˆ›å»ºã€‚ control plane çš„pod å¯åŠ¨åï¼Œinit å¼€å§‹ç»§ç»­æ‰§è¡Œåé¢çš„æµç¨‹ã€‚ 2.å°†æ ‡ç­¾å’Œæ±¡ç‚¹åº”ç”¨äºæ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œä»¥ä¾¿ä¸ä¼šåœ¨é‚£é‡Œè¿è¡Œå…¶ä»–å·¥ä½œè´Ÿè½½ã€‚ 3.ç”Ÿæˆå…¶ä»–èŠ‚ç‚¹å°†æ¥å¯ç”¨äºå‘æ§ä»¶å¹³é¢æ³¨å†Œè‡ªå·±çš„ä»¤ç‰Œã€‚æˆ–è€…ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡--token å‚æ•°æ¥æŒ‡å®šä¸€ä¸ªä»¤ç‰Œã€‚,å…·ä½“åœ¨ kubeadm token æ–‡æ¡£ä¸­. 4.è¿›è¡Œæ‰€æœ‰å¿…è¦çš„é…ç½®ï¼Œä»¥å…è®¸å…¶ä»–èŠ‚ç‚¹é€šè¿‡å¼•å¯¼ä»¤ç‰Œ bootstrap token å’Œ TLS boostrap æœºåˆ¶è¿›è¡ŒåŠ å…¥ å†™å…¥åŠ å…¥é›†ç¾¤çš„æ‰€éœ€çš„ä¿¡æ¯åˆ°configmapï¼Œ è®¾ç½®ç›¸å…³çš„RBAC è§„åˆ™ã€‚ è®©bootstrap token è®¿é—® CSRï¼ˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼‰ ç­¾å API Configure auto-approval for new CSR requests. å¯¹CSR è¯·æ±‚ï¼ˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼‰é…ç½®è‡ªåŠ¨åŒæ„ã€‚ é€šè¿‡ API server å®‰è£… DNS æœåŠ¡å™¨ ï¼ˆCoreDNSï¼‰ å’Œ kube-proxy ç»„ä»¶ã€‚åœ¨ Kubernetes ç‰ˆæœ¬ 1.11 å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒCoreDNS æ˜¯é»˜è®¤ DNS æœåŠ¡å™¨ã€‚è¦å®‰è£… kube-dns è€Œä¸æ˜¯ CoreDNSï¼Œå¿…é¡»åœ¨ kubeadm é…ç½®æ–‡ä»¶çš„ClusterConfiguration å­—æ®µä¸­é…ç½® DNS é™„åŠ ç»„ä»¶(é€šè¿‡ kubeadm config æ–‡ä»¶ï¼‰ã€‚è¯·æ³¨æ„ï¼Œè™½ç„¶å·²éƒ¨ç½² DNS æœåŠ¡å™¨ï¼Œä½†å®‰è£… CNI å‰è¯¥POD ä¸ä¼šè¢«è°ƒåº¦åˆ°èŠ‚ç‚¹ï¼ˆå¯ä»¥ç†è§£ä¸ºä¸å›è¢«å®é™…éƒ¨ç½²ï¼Œæˆ–ä¸ä¼šç”Ÿæ•ˆï¼‰ã€‚ kubeadm init phase çš„ç”¨æ³• æŸ¥çœ‹ kubeadm init phase åˆ—è¡¨ [root@rancher ~]# kubeadm init phase Use this command to invoke single phase of the init workflow Usage: kubeadm init phase [command] Available Commands: addon Install required addons for passing Conformance tests bootstrap-token Generates bootstrap tokens used to join a node to a cluster certs Certificate generation control-plane Generate all static Pod manifest files necessary to establish the control plane etcd Generate static Pod manifest file for local etcd kubeconfig Generate all kubeconfig files necessary to establish the control plane and the admin kubeconfig file kubelet-start Write kubelet settings and (re)start the kubelet mark-control-plane Mark a node as a control-plane preflight Run pre-flight checks upload-certs Upload certificates to kubeadm-certs upload-config Upload the kubeadm and kubelet configuration to a ConfigMap å¯ä»¥æŸ¥çœ‹æŸä¸ªå…·ä½“çš„phaseä¸‹çš„å­phase åˆ—è¡¨ [root@rancher ~]# kubeadm init phase control-plane --help This command is not meant to be run on its own. See list of available subcommands. Usage: kubeadm init phase control-plane [flags] kubeadm init phase control-plane [command] Available Commands: #ä¸‹é¢çš„å°±æ˜¯å­phase all Generate all static Pod manifest files apiserver Generates the kube-apiserver static Pod manifest controller-manager Generates the kube-controller-manager static Pod manifest scheduler Generates the kube-scheduler static Pod manifest æŸ¥çœ‹ control-plane phase ä¸‹ controller-manager å­ phase çš„ç”¨æ³•è¯¦æƒ… [root@rancher ~]# kubeadm init phase control-plane controller-manager --help Generates the kube-controller-manager static Pod manifest Usage: kubeadm init phase control-plane controller-manager [flags] Flags: --cert-dir string The path where to save and store the certificates. (default \"/etc/kubernetes/pki\") --config string Path to a kubeadm configuration file. --controller-manager-extra-args mapStringString A set of extra flags to pass to the Controller Manager or override default ones in form of = -h, --help help for controller-manager --image-repository string Choose a container registry to pull control plane images from (default \"k8s.gcr.io\") --kubernetes-version string Choose a specific Kubernetes version for the control plane. (default \"stable-1\") --pod-network-cidr string Specify range of IP addresses for the pod network. If set, the control plane will automatically allocate CIDRs for every node. æ‰§è¡ŒæŸä¸ª phase æˆ–è€…è·³è¿‡æŸä¸ª phase sudo kubeadm init phase control-plane all --config=configfile.yaml sudo kubeadm init phase etcd local --config=configfile.yaml # you can now modify the control plane and etcd manifest files sudo kubeadm init --skip-phases=control-plane,etcd --config=configfile.yaml kubeadm config æ–‡ä»¶ æ³¨æ„ï¼Œè¿™ä¸ª config æ–‡ä»¶ç‰¹æ€§åœ¨1.15 ä¸­ä¾ç„¶æ˜¯ betaï¼Œåœ¨å°†æ¥å¯èƒ½æ”¹å˜ æŸ¥çœ‹ kubeadm config printçš„å¸®åŠ© [root@rancher ~]# kubeadm config print -h This command prints configurations for subcommands provided. Usage: kubeadm config print [flags] kubeadm config print [command] Available Commands: init-defaults Print default init configuration, that can be used for 'kubeadm init' join-defaults Print default join configuration, that can be used for 'kubeadm join' æ‰“å°é»˜è®¤çš„init é…ç½®æ–‡ä»¶ [root@rancher ~]# kubeadm config print init-defaults > initconfig.yaml æ‰“å¼€ initconfigï¼Œ å†…å®¹å¦‚ä¸‹ apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 1.2.3.4 bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock name: rancher.local taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: k8s.gcr.io kind: ClusterConfiguration kubernetesVersion: v1.14.0 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 scheduler: {} ä¸Šé¢çš„å†…å®¹åªåŒ…å«é¢äº†æœ€ç®€è¯çš„InitConfiguration type çš„å†…å®¹ï¼Œkubeadm å®Œæ•´çš„å†…å®¹åŒ…å«5å¤§éƒ¨åˆ†ï¼Œå¦‚ä¸‹ï¼Œæ¯ä¸ªtype ä¹‹é—´ï¼Œéœ€è¦ç”¨yamlçš„ --- æ–‡æ¡£éš”ç¦»è¿›è¡Œåˆ†ç¦»ã€‚ init-full-config.yaml æ–‡ä»¶ç»“æ„ --- apiVersion: kubeadm.k8s.io/v1beta2 kind: InitConfiguration --- apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration --- apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration --- apiVersion: kubeadm.k8s.io/v1beta2 kind: JoinConfiguration æƒ³ç»†çš„å†…å®¹å¯ä»¥å‚é˜…kubeadm apiï¼Œkube-proxyé…ç½®éƒ¨åˆ†çš„å†…å®¹ç»†èŠ‚åœ¨è¿™é‡ŒKubeProxyConfiguration æ¯”å¦‚æˆ‘è¦ä¿®æ”¹kube-proxyçš„æ¨¡å¼ä¸ºIPVS é‚£ä¹ˆä¿®æ”¹åçš„init-full-config.yaml å†…å®¹ä¸ºå¦‚ä¸‹ --- apiVersion: kubeadm.k8s.io/v1beta2 kind: InitConfiguration --- apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration --- apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: \"ipvs\" ä¿®æ”¹åœ¨è¿™é‡Œ --- apiVersion: kubeadm.k8s.io/v1beta2 kind: JoinConfiguration å…³äºå¦‚ä½•é€šè¿‡kubeadm é…ç½®å¯ç”¨ IPVS è¯·å‚é˜… å…³äºå¦‚ä½•å®šåˆ¶åŒ– control plane è¯·å‚é˜… ä½¿ç”¨è‡ªå®šä¹‰é•œåƒä»“åº“ å¯¹äºgoogle æä¾›çš„é•œåƒï¼Œåœ¨ä¼—æ‰€å‘¨çŸ¥çš„åŸå› ä¸‹ï¼Œæ— æ³•è®¿é—®ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨å›½å†…é•œåƒæˆ–è€…è‡ªå»ºçš„é•œåƒä»“åº“ã€‚ kubeadm æä¾›äº†å‚æ•°ï¼ŒåŒäº‹ä¹Ÿæ”¯æŒä¿®æ”¹ kubeadm config æ–‡ä»¶æ¥æŒ‡å®šå®šåˆ¶åŒ–çš„ä»“åº“ # imageRepository: k8s.gcr.io imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹å’Œæ‹‰å– init æ‰€éœ€çš„é•œåƒã€‚ kubeadm config images list kubeadm config images pull --config init-full-config.yaml kubeadm é…ç½® cri runtime kubelet é»˜è®¤ä½¿ç”¨ docker ä½œä¸ºruntime å¹¶ä½¿ç”¨å†…å»ºçš„ dockershim è¿›è¡Œäº¤äº’ã€‚ å…¶ä»–çš„runtimeåŒ…æ‹¬: cri-containerd cri-o frakti rkt å®‰è£…æ–‡æ¡£ CRI installation instructions æ ¹æ®å®‰è£…æ–‡æ¡£å®‰è£…å¥½runtimeåï¼Œéœ€è¦å¯¹kubeadm å’Œkubelet åšå¦‚ä¸‹é…ç½® 1.åœ¨æ¯ä¸ªèŠ‚ç‚¹å®‰è£…runtime å¯¹åº”çš„ shimï¼Œå¦‚ä½•å®‰è£…åœ¨runtime è¯´æ˜æ–‡æ¡£ä¸­æœ‰ä»‹ç» 2.é…ç½® kubelet ä½¿ç”¨è¿œç¨‹ CRI runtime ï¼ˆå®é™…æ˜¯ä½¿ç”¨linux socketsï¼‰ï¼Œè®°å¾—ä¿®æ”¹ RUNTIME_ENDPOINT ä¸ºä½ è‡ªå·±å¯¹åº”çš„å€¼ï¼Œæ¯”å¦‚ /var/run/{your_runtime}.sock: æ¯”å¦‚ï¼Œå¦‚ä¸‹æ˜¯criçš„é…ç½®æ–‡ä»¶ã€‚ cat > /etc/systemd/system/kubelet.service.d/20-cri.conf ä½ ä¹Ÿå¯ä»¥é€šè¿‡kubeadm init/reset çš„ --cri-socket å‚æ•°æ¥æ˜¯å…ˆåŒæ ·çš„äº‹æƒ…ã€‚ kubeadm è‡ªåŠ¨åŒ– ä¸å…¶åƒkubeadm åŸºç¡€æ•™ç¨‹ä¸­é‚£æ ·ï¼Œå°†ä» kubeadm init è·å¾—çš„ä»¤ç‰Œå¤åˆ¶åˆ°æ¯ä¸ªèŠ‚ç‚¹ï¼Œä¸å¦‚å¹¶è¡ŒåŒ–ä»¤ç‰Œåˆ†å‘ï¼Œä»¥ä¾¿æ›´è½»æ¾åœ°å®ç°è‡ªåŠ¨åŒ–ã€‚è¦å®ç°æ­¤è‡ªåŠ¨åŒ–ï¼Œæ‚¨å¿…é¡»çŸ¥é“æ§åˆ¶å¹³é¢èŠ‚ç‚¹åœ¨å¯åŠ¨åå°†å…·æœ‰çš„ IP åœ°å€ã€‚ æ­¥éª¤ 1.ä½¿ç”¨ kubeadm ç”Ÿæˆä»¤ç‰Œï¼ˆtokenï¼‰ kubeadm token generate 2.ç”¨æ­¤ä»¤ç‰Œ(token)åŒæ—¶å¯åŠ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹ã€‚å½“å®ƒä»¬å¯åŠ¨æ—¶ï¼Œå®ƒä»¬ä¼šæ‰¾åˆ°å½¼æ­¤å¹¶å½¢æˆé›†ç¾¤ã€‚ç›¸åŒçš„ --token å‚æ•°å¯ä»¥åœ¨kubeadm initå’Œkubeadm joinä¸Šä½¿ç”¨ 3.å¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•æ¥æ·»åŠ masterèŠ‚ç‚¹ï¼Œé€šè¿‡è®¾ç½® --certificate-key å‚æ•°æ¥è¾¾åˆ°åŠ å…¥çš„ç›®çš„ã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥ç”Ÿæˆkeyï¼Œç»™æ¯ä¸ªmaster èŠ‚ç‚¹ä½¿ç”¨ kubeadm alpha certs certificate-key é›†ç¾¤å¯åŠ¨ä¹‹åï¼Œå¯ä»¥é€šè¿‡/etc/kubernetes/admin.confä¸­çš„å‡­è¯æ¥å’Œé›†ç¾¤ä¿¡ã€‚ è¿™ç§æ–¹å¼ä¸å…è®¸root ca é€šè¿‡--discovery-token-ca-cert-hash æ¥éªŒè¯è¯ä¹¦hash æ‰€ä»¥æœ‰ä¸€å®šçš„å®‰å…¨éšæ‚£ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sä¸‹è½½/ä¸‹è½½k8säºŒè¿›åˆ¶åŒ….html":{"url":"linux/k8s/k8sä¸‹è½½/ä¸‹è½½k8säºŒè¿›åˆ¶åŒ….html","title":"k8säºŒè¿›åˆ¶åŒ…ä¸‹è½½","keywords":"","body":"ä¸‹è½½k8säºŒè¿›åˆ¶åŒ… ç™»é™†githubï¼Œæœç´¢kubernetesï¼Œç„¶åç‚¹å‡»é¡¹ç›®è¿›å…¥ ç‚¹å‡»releases é€‰æ‹©è¦ä¸‹è½½çš„ç‰ˆæœ¬ï¼Œç„¶åç‚¹å‡»CHANGELOG/CHANGELOG-1.18.md æ³¨æ„çœ‹å‡†ç‰ˆæœ¬ï¼Œåœ¨Server Binariesä¸‹ä¸‹è½½äºŒè¿›åˆ¶åŒ… æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sçŸ¥è¯†ç‚¹/k8sè®¾ç½®é€šè¿‡kubeconfigç™»é™†dashboard.html":{"url":"linux/k8s/k8sçŸ¥è¯†ç‚¹/k8sè®¾ç½®é€šè¿‡kubeconfigç™»é™†dashboard.html","title":"k8sè®¾ç½®é€šè¿‡kubeconfigç™»é™†dashboard","keywords":"","body":"k8sè®¾ç½®é€šè¿‡kubeconfigç™»é™†dashboard k8s å®˜æ–¹çš„dashboardæ¯æ¬¡ç™»é™†éƒ½éœ€è¦è¾“å…¥tokenï¼Œè€Œè¿™ä¸ªtokenä¸€ä¼šç‰¹ä¹ˆå°±è¿‡æœŸäº†ï¼Œæˆ‘å°±æ˜¯æœ¬æœºå®éªŒï¼Œæ¯æ¬¡éƒ½å¾—æ‰‹åŠ¨ç²˜è´´ä¸€å¤§ä¸²å‘½ä»¤è·å–tokenç„¶åå†ç™»é™†ï¼Œéå¸¸éº»çƒ¦ ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è·å–ç™»é™†dashboardçš„token kubectl get secret `kubectl get secret -n kube-system|grep admin-token|awk '{print $1}'` -o jsonpath={.data.token} -n kube-system |base64 -d && echo æŸ¥çœ‹secrets $ kubectl get secrets NAME TYPE DATA AGE default-token-jlz9f kubernetes.io/service-account-token 3 45h 1.åˆ›å»ºcluster kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.crt --server=10.0.0.130:6443 --kubeconfig=/root/dashbord-admin.conf 2.è·å–token DASH_TOCKEN=$(kubectl get secret -n kube-system `kubectl get secret -n kube-system |grep dashboard |awk '{print $1}'` -o jsonpath={.data.token}|base64 -d) 3.åˆ›å»ºcredentials kubectl config set-credentials dashboard-admin --token=$DASH_TOCKEN --kubeconfig=/root/dashbord-admin.conf 4.åˆ›å»ºcontext kubectl config set-context dashboard-admin@kubernetes --cluster=kubernetes --user=dashboard-admin --kubeconfig=/root/dashbord-admin.conf 5.åˆ‡æ¢contextçš„current-contextæ˜¯dashboard-admin@kubernetes kubectl config use-context dashboard-admin@kubernetes --kubeconfig=/root/dashbord-admin.conf ä¸‹è½½dashboard-admin.confç„¶åç™»é™†çš„æ—¶å€™é€‰æ‹©è¿™ä¸ªæ–‡ä»¶å³å¯ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8så®‰è£…/1.ä½¿ç”¨ kubeadm æ­å»º v1.15.3 ç‰ˆæœ¬ Kubernetes é›†ç¾¤.html":{"url":"linux/k8s/k8så®‰è£…/1.ä½¿ç”¨ kubeadm æ­å»º v1.15.3 ç‰ˆæœ¬ Kubernetes é›†ç¾¤.html","title":"1.15","keywords":"","body":"ä½¿ç”¨ kubeadm æ­å»º v1.15.3 ç‰ˆæœ¬ Kubernetes é›†ç¾¤ ä¸€ã€ç¯å¢ƒå‡†å¤‡ 1.1å®éªŒç¯å¢ƒ è§’è‰² IPåœ°å€ ä¸»æœºå dockerç‰ˆæœ¬ ç¡¬ä»¶é…ç½® ç³»ç»Ÿ å†…æ ¸ master 10.0.0.130 k8s-master 18.09.9 2c2g CentOS7.6 3.10.0-957.el7.x86_64 node1 10.0.0.131 k8s-node1 18.09.9 2c1g CentOS7.6 3.10.0-957.el7.x86_64 node2 10.0.0.132 k8s-node2 18.09.9 2c1g CentOS7.6 3.10.0-957.el7.x86_64 1.2æ¯ä¸ªèŠ‚ç‚¹é…ç½®hostä¿¡æ¯ cat >> /etc/hosts 1.3ç¦ç”¨é˜²ç«å¢™å’Œselinux //ç¦ç”¨é˜²ç«å¢™ systemctl stop firewalld && systemctl disable firewalld //ç¦ç”¨selinux #ä¸´æ—¶ä¿®æ”¹ setenforce 0 #æ°¸ä¹…ä¿®æ”¹ï¼Œé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆ sed -i '7s/enforcing/disabled/' /etc/selinux/config 1.4åˆ›å»º/etc/sysctl.d/k8s.confæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ //å‘æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ cat >/etc/sysctl.d/k8s.conf 1.5å®‰è£…ipvs è„šæœ¬åˆ›å»ºäº†çš„/etc/sysconfig/modules/ipvs.modulesæ–‡ä»¶ï¼Œä¿è¯åœ¨èŠ‚ç‚¹é‡å¯åèƒ½è‡ªåŠ¨åŠ è½½æ‰€éœ€æ¨¡å—ã€‚ä½¿ç”¨lsmod | grep -e ip_vs -e nf_conntrack_ipv4å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å·²ç»æ­£ç¡®åŠ è½½æ‰€éœ€çš„å†…æ ¸æ¨¡å— //å‘æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ cat > /etc/sysconfig/modules/ipvs.modules å®‰è£…ipsetå’Œipvsadm(ä¾¿äºæŸ¥çœ‹ ipvs çš„ä»£ç†è§„åˆ™) yum -y install ipset ipvsadm 1.6åŒæ­¥æœåŠ¡å™¨æ—¶é—´ //å®‰è£…chrony yum -y install chrony //ä¿®æ”¹åŒæ­¥æœåŠ¡å™¨åœ°å€ä¸ºé˜¿é‡Œäº‘ sed -i.bak '3,6d' /etc/chrony.conf && sed -i '3cserver ntp1.aliyun.com iburst' \\ /etc/chrony.conf //å¯åŠ¨chronydåŠåŠ å…¥å¼€æœºè‡ªå¯ systemctl start chronyd && systemctl enable chronyd //æŸ¥çœ‹åŒæ­¥ç»“æœ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* 120.25.115.20 2 6 37 13 +194us[+6131us] +/- 33ms 1.7å…³é—­swapåˆ†åŒº ä¿®æ”¹/etc/fstabæ–‡ä»¶ï¼Œæ³¨é‡Šæ‰ SWAP çš„è‡ªåŠ¨æŒ‚è½½ï¼Œä½¿ç”¨free -mç¡®è®¤ swap å·²ç»å…³é—­ //æ‰‹åŠ¨å…³é—­swap swapoff -a //ä¿®æ”¹fstabæ–‡ä»¶ï¼Œæ³¨é‡Šswapè‡ªåŠ¨æŒ‚è½½ sed -i '/^\\/dev\\/mapper\\/centos-swap/c#/dev/mapper/centos-swap swap swap defaults 0 0' /etc/fstab //æŸ¥çœ‹swapæ˜¯å¦å…³é—­ free -m total used free shared buff/cache available Mem: 1994 682 612 9 699 1086 Swap: 0 0 0 swappiness å‚æ•°è°ƒæ•´ï¼Œä¿®æ”¹/etc/sysctl.d/k8s.confæ·»åŠ ä¸‹é¢ä¸€è¡Œ cat >>/etc/sysctl.d/k8s.conf 1.8å®‰è£…docker18.09.9 1.æ·»åŠ é˜¿é‡Œäº‘yumæº yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 2.æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ yum list docker-ce --showduplicates | sort -r å·²åŠ è½½æ’ä»¶ï¼šfastestmirror, langpacks å¯å®‰è£…çš„è½¯ä»¶åŒ… * updates: mirrors.aliyun.com Loading mirror speeds from cached hostfile * extras: mirrors.aliyun.com docker-ce.x86_64 3:19.03.5-3.el7 docker-ce-stable docker-ce.x86_64 3:19.03.4-3.el7 docker-ce-stable ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ docker-ce.x86_64 3:18.09.9-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.8-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.7-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.6-3.el7 docker-ce-stable ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 3.å®‰è£…docker18.09.9 yum -y install docker-ce-18.09.9-3.el7 docker-ce-cli-18.09.9 4.å¯åŠ¨dockerå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable docker && systemctl start docker 5.é…ç½®é˜¿é‡Œäº‘dockeré•œåƒåŠ é€Ÿ cat > /etc/docker/daemon.json 1.9å®‰è£…Kubeadm éœ€è¦ç§‘å­¦ä¸Šç½‘ cat >/etc/yum.repos.d/kubernetes.repo ä½¿ç”¨é˜¿é‡Œäº‘yumæº cat >/etc/yum.repos.d/kubernetes.repo å®‰è£… kubeadmã€kubeletã€kubectl(é˜¿é‡Œäº‘yumæºä¼šéšå®˜æ–¹æ›´æ–°æœ€æ–°ç‰ˆï¼Œå› æ­¤æŒ‡å®šç‰ˆæœ¬) yum -y install kubelet-1.15.3 kubeadm-1.15.3 kubectl-1.15.3 --disableexcludes=kubernetes //æŸ¥çœ‹ç‰ˆæœ¬ kubeadm version kubeadm version: &version.Info{Major:\"1\", Minor:\"15\", GitVersion:\"v1.15.3\", GitCommit:\"2d3c76f9091b6bec110a5e63777c332469e0cba2\", GitTreeState:\"clean\", BuildDate:\"2019-08-19T11:11:18Z\", GoVersion:\"go1.12.9\", Compiler:\"gc\", Platform:\"linux/amd64\"} è®¾ç½®kubeletå¼€æœºè‡ªå¯ systemctl enable kubelet è®¾ç½®k8så‘½ä»¤è‡ªåŠ¨è¡¥å…¨ yum -y install bash-completion source /usr/share/bash-completion/bash_completion source > ~/.bashrc åˆ°æ­¤ï¼ŒåŸºæœ¬ç¯å¢ƒå®‰è£…å®Œæˆ!!! äºŒã€åˆå§‹åŒ–é›†ç¾¤ 2.1masterèŠ‚ç‚¹æ“ä½œï¼Œé…ç½® kubeadm åˆå§‹åŒ–æ–‡ä»¶ //åˆå§‹åŒ–kubeadmæ–‡ä»¶ï¼Œè¿™é‡Œçš„è·¯å¾„ä¸º/root kubeadm config print init-defaults > kubeadm.yaml //æŸ¥çœ‹ç”Ÿæˆçš„é»˜è®¤æ–‡ä»¶ cat kubeadm.yaml apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 1.2.3.4 bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock name: k8s-master taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: k8s.gcr.io kind: ClusterConfiguration kubernetesVersion: v1.15.0 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 scheduler: {} ç„¶åæ ¹æ®æˆ‘ä»¬è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹é…ç½®ï¼Œæ¯”å¦‚ä¿®æ”¹ imageRepository çš„å€¼ï¼Œkube-proxy çš„æ¨¡å¼ä¸º ipvsï¼Œå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿™é‡Œæ˜¯å‡†å¤‡å®‰è£… calico ç½‘ç»œæ’ä»¶çš„ï¼Œéœ€è¦å°† networking.podSubnet è®¾ç½®ä¸º192.168.0.0/16 ä¿®æ”¹åçš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ cat > kubeadm.yaml 2.2åˆå§‹åŒ–master kubeadm init --config kubeadm.yaml å®Œæ•´è¾“å‡ºç»“æœ [init] Using Kubernetes version: v1.15.3 [preflight] Running pre-flight checks [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driv er. The recommended driver is \"systemd\". Please follow the guide at https://kubernete s.io/docs/setup/cri/ [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using 'kubeadm config imag es pull' [kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet /kubeadm-flags.env\" [kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\" [kubelet-start] Activating the kubelet service [certs] Using certificateDir folder \"/etc/kubernetes/pki\" [certs] Generating \"ca\" certificate and key [certs] Generating \"apiserver\" certificate and key [certs] apiserver serving cert is signed for DNS names [k8s-master kubernetes kuberne tes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10. 96.0.1 10.0.0.130] [certs] Generating \"apiserver-kubelet-client\" certificate and key [certs] Generating \"etcd/ca\" certificate and key [certs] Generating \"apiserver-etcd-client\" certificate and key [certs] Generating \"etcd/healthcheck-client\" certificate and key [certs] Generating \"etcd/server\" certificate and key [certs] etcd/server serving cert is signed for DNS names [k8s-master localhost] and IPs [10.0.0.130 127.0.0.1 ::1] [certs] Generating \"etcd/peer\" certificate and key [certs] etcd/peer serving cert is signed for DNS names [k8s-master localhost] and IPs [10.0.0.130 127.0.0.1 ::1] [certs] Generating \"front-proxy-ca\" certificate and key [certs] Generating \"front-proxy-client\" certificate and key [certs] Generating \"sa\" key and public key [kubeconfig] Using kubeconfig folder \"/etc/kubernetes\" [kubeconfig] Writing \"admin.conf\" kubeconfig file [kubeconfig] Writing \"kubelet.conf\" kubeconfig file [kubeconfig] Writing \"controller-manager.conf\" kubeconfig file [kubeconfig] Writing \"scheduler.conf\" kubeconfig file [control-plane] Using manifest folder \"/etc/kubernetes/manifests\" [control-plane] Creating static Pod manifest for \"kube-apiserver\" [control-plane] Creating static Pod manifest for \"kube-controller-manager\" [control-plane] Creating static Pod manifest for \"kube-scheduler\" [etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\" [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\". This can take up to 4m0s [apiclient] All control plane components are healthy after 19.003902 seconds [upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace [kubelet] Creating a ConfigMap \"kubelet-config-1.15\" in namespace kube-system with the configuration for the kubelets in the cluster [upload-certs] Skipping phase. Please see --upload-certs [mark-control-plane] Marking the node k8s-master as control-plane by adding the label \"node-role.kubernetes.io/master=''\" [mark-control-plane] Marking the node k8s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule] [bootstrap-token] Using token: abcdef.0123456789abcdef [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token [bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster [bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace [addons] Applied essential addon: CoreDNS [addons] Applied essential addon: kube-proxy Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 10.0.0.130:6443 --token abcdef.0123456789abcdef \\ --discovery-token-ca-cert-hash sha256:b29cbd05af6924b95b74964f949a65e3367402d76a268295c333e792c3eb7ad2 #kubeadm init --config kubeadm.yamlåˆå§‹åŒ–masterä¸‹è½½çš„é•œåƒ gcr.azk8s.cn/google_containers/kube-proxy v1.15.3 232b5c793146 6 months ago 82.4MB gcr.azk8s.cn/google_containers/kube-apiserver v1.15.3 5eb2d3fc7a44 6 months ago 207MB gcr.azk8s.cn/google_containers/kube-controller-manager v1.15.3 e77c31de5547 6 months ago 159MB gcr.azk8s.cn/google_containers/kube-scheduler v1.15.3 703f9c69a5d5 6 months ago 81.1MB gcr.azk8s.cn/google_containers/coredns 1.3.1 eb516548c180 14 months ago 40.3MB gcr.azk8s.cn/google_containers/etcd 3.3.10 2c4adeb21b4f 15 months ago 258MB gcr.azk8s.cn/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB #å¯åŠ¨çš„å®¹å™¨ ab18a4a6f78c 232b5c793146 \"/usr/local/bin/kubeâ€¦\" About an hour ago Up About an hour k8s_kube-proxy_kube-proxy-zns59_kube-system_7b431cd3-6572-4a5e-981e-c536bbad32ea_0 b8b3f6cf6702 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" About an hour ago Up About an hour k8s_POD_kube-proxy-zns59_kube-system_7b431cd3-6572-4a5e-981e-c536bbad32ea_0 dc2db22d2a84 e77c31de5547 \"kube-controller-manâ€¦\" About an hour ago Up About an hour k8s_kube-controller-manager_kube-controller-manager-k8s-master_kube-system_5a41bf631425471a02fc0cca5725518d_0 8a25922bf185 2c4adeb21b4f \"etcd --advertise-clâ€¦\" About an hour ago Up About an hour k8s_etcd_etcd-k8s-master_kube-system_3c2a1c3e9bec3ffe168c550fd855d63f_0 f90159ea56c4 5eb2d3fc7a44 \"kube-apiserver --adâ€¦\" About an hour ago Up About an hour k8s_kube-apiserver_kube-apiserver-k8s-master_kube-system_6eb25fe257b281826a14a7e276a75d61_0 b70fe56aab46 703f9c69a5d5 \"kube-scheduler --biâ€¦\" About an hour ago Up About an hour k8s_kube-scheduler_kube-scheduler-k8s-master_kube-system_f1217bcf1fd2d00391bfd0ec41d69a25_0 f084bc0cf4ae gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" About an hour ago Up About an hour k8s_POD_kube-controller-manager-k8s-master_kube-system_5a41bf631425471a02fc0cca5725518d_0 e93a8bebe038 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" About an hour ago Up About an hour k8s_POD_kube-scheduler-k8s-master_kube-system_f1217bcf1fd2d00391bfd0ec41d69a25_0 4d6cac595d0b gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" About an hour ago Up About an hour k8s_POD_kube-apiserver-k8s-master_kube-system_6eb25fe257b281826a14a7e276a75d61_0 f49e9fa0ba1d gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" About an hour ago Up About an hour k8s_POD_etcd-k8s-master_kube-system_3c2a1c3e9bec3ffe168c550fd855d63f_0 æ‹·è´ kubeconfig æ–‡ä»¶ //è¿™é‡Œçš„è·¯å¾„ä¸º/root mkdir -p $HOME/.kube cp -i /etc/kubernetes/admin.conf $HOME/.kube/config chown $(id -u):$(id -g) $HOME/.kube/config 2.3masteræ·»åŠ èŠ‚ç‚¹ node1å’Œnode2ç›¸åŒæ“ä½œ å°†masterèŠ‚ç‚¹ä¸Šçš„$HOME/.kube/config æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹å¯¹åº”çš„æ–‡ä»¶ä¸­ 1.åˆ›å»ºç›®å½•ï¼Œè¿™é‡Œçš„è·¯å¾„ä¸º/root mkdir -p $HOME/.kube 2.æŠŠmasterèŠ‚ç‚¹ä¸Šçš„configæ–‡ä»¶æ‹·è´åˆ°node1å’Œnode2çš„$HOME/.kube scp k8s-master:~/.kube/config $HOME/.kube 3.ä¿®æ”¹æƒé™ chown $(id -u):$(id -g) $HOME/.kube/config å°†node1å’Œnode2åŠ å…¥åˆ°é›†ç¾¤ä¸­ è¿™é‡Œéœ€è¦ç”¨åˆ°2.2ä¸­åˆå§‹åŒ–masteræœ€åç”Ÿæˆçš„tokenå’Œsha256å€¼ kubeadm join 10.0.0.130:6443 --token abcdef.0123456789abcdef \\ --discovery-token-ca-cert-hash sha256:b29cbd05af6924b95b74964f949a65e3367402d76a268295c333e792c3eb7ad2 è¾“å‡ºç»“æœ [preflight] Running pre-flight checks [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driver. The recommended driver is \"systemd\". Please follow the guide at https://kubernetes.io/docs/setup/cri/ [preflight] Reading configuration from the cluster... [preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml' [kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-1.15\" ConfigMap in the kube-system namespace [kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\" [kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\" [kubelet-start] Activating the kubelet service [kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap... This node has joined the cluster: * Certificate signing request was sent to apiserver and a response was received. * The Kubelet was informed of the new secure connection details. Run 'kubectl get nodes' on the control-plane to see this node join the cluster. å¦‚æœå¿˜è®°äº†tokenå’Œsha256å€¼ï¼Œå¯ä»¥åœ¨masterèŠ‚ç‚¹ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ //æŸ¥çœ‹token kubeadm token list TOKEN TTL EXPIRES USAGES DESCRIPTION EXTRA GROUPS abcdef.0123456789abcdef 23h 2019-12-11T16:52:56+08:00 authentication,signing system:bootstrappers:kubeadm:default-node-token //æŸ¥çœ‹sha256 openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //' b29cbd05af6924b95b74964f949a65e3367402d76a268295c333e792c3eb7ad2 //åŒæ—¶æŸ¥çœ‹tokenå’Œsha256 kubeadm token create --print-join-command kubeadm join 10.0.0.130:6443 --token h8lbi6.27rrq8c6khonopqe --discovery-token-ca-cert-hash sha256:b29cbd05af6924b95b74964f949a65e3367402d76a268295c333e792c3eb7ad2 masterèŠ‚ç‚¹æŸ¥çœ‹nodeï¼Œå‘ç°çŠ¶æ€éƒ½æ˜¯NotReadyï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å®‰è£…calioå®˜æ–¹æ’ä»¶æ–‡æ¡£ kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master NotReady master 19m v1.15.3 k8s-node1 NotReady 4m10s v1.15.3 k8s-node2 NotReady 4m3s v1.15.3 2.4masterèŠ‚ç‚¹å®‰è£…ç½‘ç»œæ’ä»¶calio //ä¸‹è½½æ–‡ä»¶ wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml //å› ä¸ºæœ‰èŠ‚ç‚¹æ˜¯å¤šç½‘å¡ï¼Œæ‰€ä»¥éœ€è¦åœ¨èµ„æºæ¸…å•æ–‡ä»¶ä¸­æŒ‡å®šå†…ç½‘ç½‘å¡ï¼Œä¿®æ”¹calico.yamlæ–‡ä»¶ä¸­ä»¥ä¸‹å‡ å¤„ 582è¡Œ-594è¡Œï¼ŒåŸå†…å®¹å¦‚ä¸‹ containers: 583 # Runs calico-node container on each Kubernetes node. This 584 # container programs network policy and routes on each 585 # host. 586 - name: calico-node 587 image: calico/node:v3.8.5 588 env: 589 # Use Kubernetes API as the backing datastore. 590 - name: DATASTORE_TYPE 591 value: \"kubernetes\" 592 # Wait for the datastore. 593 - name: WAIT_FOR_DATASTORE 594 value: \"true\" ç°ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼ˆå¢åŠ äº†ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼‰ containers: # Runs calico-node container on each Kubernetes node. This # container programs network policy and routes on each # host. - name: calico-node image: calico/node:v3.8.5 env: # Use Kubernetes API as the backing datastore. - name: DATASTORE_TYPE value: \"kubernetes\" - name: IP_AUTODETECTION_METHOD # DaemonSetä¸­æ·»åŠ è¯¥ç¯å¢ƒå˜é‡ value: interface=eth0 # æŒ‡å®šå†…ç½‘ç½‘å¡ # Wait for the datastore. - name: WAIT_FOR_DATASTORE value: \"true\" //ä¿®æ”¹å®Œæˆåå®‰è£…calicoç½‘ç»œæ’ä»¶ kubectl apply -f calico.yaml //å®‰è£…å®Œæˆåç¨ç­‰ä¸€ä¼šæŸ¥çœ‹podsçŠ¶æ€ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE calico-kube-controllers-5bbc8f45cb-rpm96 1/1 Running 0 6m17s calico-node-cbmcz 1/1 Running 0 6m17s calico-node-jbjw4 1/1 Running 0 6m17s calico-node-qfnfm 1/1 Running 0 6m17s coredns-cf8fb6d7f-vkst4 1/1 Running 0 50m coredns-cf8fb6d7f-z622t 1/1 Running 0 50m etcd-k8s-master 1/1 Running 0 49m kube-apiserver-k8s-master 1/1 Running 0 49m kube-controller-manager-k8s-master 1/1 Running 0 50m kube-proxy-68wzg 1/1 Running 0 35m kube-proxy-fbc95 1/1 Running 0 35m kube-proxy-g4xkc 1/1 Running 0 50m kube-scheduler-k8s-master 1/1 Running 0 49m //æŸ¥çœ‹nodeçŠ¶æ€ kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master Ready master 55m v1.15.3 k8s-node1 Ready 39m v1.15.3 k8s-node2 Ready 39m v1.15.3 #kubectl apply -f calico.yamlå®‰è£…ç½‘ç»œæ’ä»¶calicoä¸‹è½½çš„é•œåƒ calico/node v3.8.6 1b9ca446b4da 2 months ago 192MB calico/pod2daemon-flexvol v3.8.6 97bfbee02d48 2 months ago 9.38MB calico/cni v3.8.6 33af7d7d46b6 2 months ago 161MB #å¯åŠ¨çš„å®¹å™¨ 4cfb387bd9a0 calico/node \"start_runit\" 5 minutes ago Up 5 minutes k8s_calico-node_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 b75783c7934c calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 5 minutes ago Exited (0) 5 minutes ago k8s_flexvol-driver_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 9e4766d2fa80 33af7d7d46b6 \"/install-cni.sh\" 6 minutes ago Exited (0) 6 minutes ago k8s_install-cni_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 f7f752fd62dc calico/cni \"/opt/cni/bin/calicoâ€¦\" 6 minutes ago Exited (0) 6 minutes ago k8s_upgrade-ipam_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 2.5å®‰è£…Dashboard ä¸‹è½½æ–‡ä»¶åŠä¿®æ”¹å†…å®¹ //ä¸‹è½½æ–‡ä»¶ wget https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml //ä¿®æ”¹é•œåƒåç§° æ³¨é‡Š112è¡Œï¼Œæ·»åŠ å¦‚ä¸‹ä¸¤è¡Œ åœ¨è¿™ä¸€è¡Œä¸‹æ·»åŠ å¦‚ä¸‹ä¸¤è¡Œ - name: kubernetes-dashboard image: gcr.azk8s.cn/google_containers/kubernetes-dashboard-amd64:v1.10.1 imagePullPolicy: IfNotPresent //ä¿®æ”¹Serviceä¸ºNodePortç±»å‹ï¼Œæ–‡ä»¶æœ€åä¸€è¡ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ selector: k8s-app: kubernetes-dashboard type: NodePort #æ–°å¢è¿™ä¸€è¡Œï¼Œæ³¨æ„ä¸selectoråœ¨åŒä¸€çº§ éƒ¨ç½²dashboard kubectl apply -f kubernetes-dashboard.yaml #ä¸‹è½½çš„é•œåƒ gcr.azk8s.cn/google_containers/kubernetes-dashboard-amd64 v1.10.1 f9aed6605b81 15 months ago 122MB #å¯åŠ¨çš„å®¹å™¨ 7fddf75bb284 gcr.azk8s.cn/google_containers/kubernetes-dashboard-amd64 \"/dashboard --insecuâ€¦\" 9 seconds ago Up 9 seconds k8s_kubernetes-dashboard_kubernetes-dashboard-fcfb4cbc-v7lfh_kube-system_268913c8-f9df-4e9a-9f89-c9dda9462d38_0 æŸ¥çœ‹dashboardçš„è¿è¡ŒçŠ¶æ€åŠå¤–ç½‘è®¿é—®ç«¯å£ //æŸ¥çœ‹dashboardè¿è¡ŒçŠ¶æ€ kubectl get pods -n kube-system -l k8s-app=kubernetes-dashboard NAME READY STATUS RESTARTS AGE kubernetes-dashboard-fcfb4cbc-fcczh 1/1 Running 0 3m40s //æŸ¥çœ‹dashboardå¤–ç½‘è®¿é—®ç«¯å£ kubectl get svc -n kube-system -l k8s-app=kubernetes-dashboard NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes-dashboard NodePort 10.96.100.138 443:31758/TCP 4m42s é€šè¿‡ä¸Šè¾¹çš„31758ç«¯å£è®¿é—®dashboardï¼Œæ³¨æ„æ˜¯https ç”±äº dashboard é»˜è®¤æ˜¯è‡ªå»ºçš„ https è¯ä¹¦ï¼Œè¯¥è¯ä¹¦æ˜¯ä¸å—æµè§ˆå™¨ä¿¡ä»»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼ºåˆ¶è·³è½¬å°±å¯ä»¥äº† ç„¶ååˆ›å»ºä¸€ä¸ªå…·æœ‰å…¨å±€æ‰€æœ‰æƒé™çš„ç”¨æˆ·æ¥ç™»å½•Dashboard //ç¼–è¾‘admin.yamlæ–‡ä»¶ cat > admin.yaml ç„¶åç²˜è´´ä¸Šè¿°ç”Ÿæˆçš„base64å­—ç¬¦ä¸²ç™»é™†dashboardï¼Œåœ¨ç™»é™†é¡µé¢é€‰æ‹©ä»¤ç‰Œä¸€é¡¹ ç™»é™†åçš„é¦–ç•Œé¢ åˆ°æ­¤ï¼Œä½¿ç”¨kubeadmå®‰è£…k8s 1.15.3å®Œæˆï¼ï¼ï¼ è·å–ä»¤ç‰Œå‘½ä»¤ kubectl get secret `kubectl get secret -n kube-system|grep admin-token|awk '{print $1}'` -o jsonpath={.data.token} -n kube-system |base64 -d 1.15.3å¯åŠ¨çš„å®¹å™¨åŠä¸‹è½½çš„é•œåƒ #å¯åŠ¨çš„å®¹å™¨ 7fddf75bb284 gcr.azk8s.cn/google_containers/kubernetes-dashboard-amd64 \"/dashboard --insecuâ€¦\" 8 minutes ago Up 8 minutes k8s_kubernetes-dashboard_kubernetes-dashboard-fcfb4cbc-v7lfh_kube-system_268913c8-f9df-4e9a-9f89-c9dda9462d38_0 fa592650d469 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 8 minutes ago Up 8 minutes k8s_POD_kubernetes-dashboard-fcfb4cbc-v7lfh_kube-system_268913c8-f9df-4e9a-9f89-c9dda9462d38_0 4cfb387bd9a0 calico/node \"start_runit\" 18 minutes ago Up 18 minutes k8s_calico-node_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 b75783c7934c calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 18 minutes ago Exited (0) 18 minutes ago k8s_flexvol-driver_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 9e4766d2fa80 33af7d7d46b6 \"/install-cni.sh\" 18 minutes ago Exited (0) 18 minutes ago k8s_install-cni_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 f7f752fd62dc calico/cni \"/opt/cni/bin/calicoâ€¦\" 18 minutes ago Exited (0) 18 minutes ago k8s_upgrade-ipam_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 2cd3749c5b37 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 19 minutes ago Up 19 minutes k8s_POD_calico-node-xc2tg_kube-system_0c89a070-b9e4-419e-916e-058b32ac64d1_0 ab18a4a6f78c 232b5c793146 \"/usr/local/bin/kubeâ€¦\" 2 hours ago Up 2 hours k8s_kube-proxy_kube-proxy-zns59_kube-system_7b431cd3-6572-4a5e-981e-c536bbad32ea_0 b8b3f6cf6702 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 2 hours ago Up 2 hours k8s_POD_kube-proxy-zns59_kube-system_7b431cd3-6572-4a5e-981e-c536bbad32ea_0 dc2db22d2a84 e77c31de5547 \"kube-controller-manâ€¦\" 2 hours ago Up 2 hours k8s_kube-controller-manager_kube-controller-manager-k8s-master_kube-system_5a41bf631425471a02fc0cca5725518d_0 8a25922bf185 2c4adeb21b4f \"etcd --advertise-clâ€¦\" 2 hours ago Up 2 hours k8s_etcd_etcd-k8s-master_kube-system_3c2a1c3e9bec3ffe168c550fd855d63f_0 f90159ea56c4 5eb2d3fc7a44 \"kube-apiserver --adâ€¦\" 2 hours ago Up 2 hours k8s_kube-apiserver_kube-apiserver-k8s-master_kube-system_6eb25fe257b281826a14a7e276a75d61_0 b70fe56aab46 703f9c69a5d5 \"kube-scheduler --biâ€¦\" 2 hours ago Up 2 hours k8s_kube-scheduler_kube-scheduler-k8s-master_kube-system_f1217bcf1fd2d00391bfd0ec41d69a25_0 f084bc0cf4ae gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 2 hours ago Up 2 hours k8s_POD_kube-controller-manager-k8s-master_kube-system_5a41bf631425471a02fc0cca5725518d_0 e93a8bebe038 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 2 hours ago Up 2 hours k8s_POD_kube-scheduler-k8s-master_kube-system_f1217bcf1fd2d00391bfd0ec41d69a25_0 4d6cac595d0b gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 2 hours ago Up 2 hours k8s_POD_kube-apiserver-k8s-master_kube-system_6eb25fe257b281826a14a7e276a75d61_0 f49e9fa0ba1d gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 2 hours ago Up 2 hours k8s_POD_etcd-k8s-master_kube-system_3c2a1c3e9bec3ffe168c550fd855d63f_0 #ä¸‹è½½çš„é•œåƒ calico/node v3.8.6 1b9ca446b4da 2 months ago 192MB calico/pod2daemon-flexvol v3.8.6 97bfbee02d48 2 months ago 9.38MB calico/cni v3.8.6 33af7d7d46b6 2 months ago 161MB gcr.azk8s.cn/google_containers/kube-proxy v1.15.3 232b5c793146 6 months ago 82.4MB gcr.azk8s.cn/google_containers/kube-apiserver v1.15.3 5eb2d3fc7a44 6 months ago 207MB gcr.azk8s.cn/google_containers/kube-scheduler v1.15.3 703f9c69a5d5 6 months ago 81.1MB gcr.azk8s.cn/google_containers/kube-controller-manager v1.15.3 e77c31de5547 6 months ago 159MB gcr.azk8s.cn/google_containers/coredns 1.3.1 eb516548c180 14 months ago 40.3MB gcr.azk8s.cn/google_containers/kubernetes-dashboard-amd64 v1.10.1 f9aed6605b81 15 months ago 122MB gcr.azk8s.cn/google_containers/etcd 3.3.10 2c4adeb21b4f 15 months ago 258MB gcr.azk8s.cn/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB k8såˆ‡æ¢å‘½åç©ºé—´å·¥å…· git clone https://github.com.cnpmjs.org/ahmetb/kubectx cp kubectx/kubens /usr/local/bin #æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´ kubens #åˆ‡æ¢åˆ°kube-systemå‘½åç©ºé—´ kubens kube-system Context \"kubernetes-admin@kubernetes\" modified. Active namespace is \"kube-system\". æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8så®‰è£…/2.ä½¿ç”¨ kubeadm æ­å»º v1.16.3 ç‰ˆæœ¬ Kubernetes é›†ç¾¤.html":{"url":"linux/k8s/k8så®‰è£…/2.ä½¿ç”¨ kubeadm æ­å»º v1.16.3 ç‰ˆæœ¬ Kubernetes é›†ç¾¤.html","title":"1.16","keywords":"","body":"ä½¿ç”¨ kubeadm æ­å»º v1.16.3 ç‰ˆæœ¬ Kubernetes é›†ç¾¤ ä¸€ã€ç¯å¢ƒå‡†å¤‡ 1.1å®éªŒç¯å¢ƒ è§’è‰² IPåœ°å€ ä¸»æœºå dockerç‰ˆæœ¬ ç¡¬ä»¶é…ç½® ç³»ç»Ÿ å†…æ ¸ master 10.0.0.130 k8s-master 18.09.9 2c2g CentOS7.6 3.10.0-957.el7.x86_64 node1 10.0.0.131 k8s-node1 18.09.9 2c1g CentOS7.6 3.10.0-957.el7.x86_64 node2 10.0.0.132 k8s-node2 18.09.9 2c1g CentOS7.6 3.10.0-957.el7.x86_64 1.2æ¯ä¸ªèŠ‚ç‚¹é…ç½®hostä¿¡æ¯ cat >> /etc/hosts 1.3ç¦ç”¨é˜²ç«å¢™å’Œselinux //ç¦ç”¨é˜²ç«å¢™ systemctl stop firewalld && systemctl disable firewalld //ç¦ç”¨selinux #ä¸´æ—¶ä¿®æ”¹ setenforce 0 #æ°¸ä¹…ä¿®æ”¹ï¼Œé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆ sed -i '7s/enforcing/disabled/' /etc/selinux/config 1.4åˆ›å»º/etc/sysctl.d/k8s.confæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ //å‘æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ cat >/etc/sysctl.d/k8s.conf 1.5å®‰è£…ipvs è„šæœ¬åˆ›å»ºäº†çš„/etc/sysconfig/modules/ipvs.modulesæ–‡ä»¶ï¼Œä¿è¯åœ¨èŠ‚ç‚¹é‡å¯åèƒ½è‡ªåŠ¨åŠ è½½æ‰€éœ€æ¨¡å—ã€‚ä½¿ç”¨lsmod | grep -e ip_vs -e nf_conntrack_ipv4å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å·²ç»æ­£ç¡®åŠ è½½æ‰€éœ€çš„å†…æ ¸æ¨¡å— //å‘æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ cat > /etc/sysconfig/modules/ipvs.modules å®‰è£…ipsetå’Œipvsadm(ä¾¿äºæŸ¥çœ‹ ipvs çš„ä»£ç†è§„åˆ™) yum -y install ipset ipvsadm 1.6åŒæ­¥æœåŠ¡å™¨æ—¶é—´ //å®‰è£…chrony yum -y install chrony //ä¿®æ”¹åŒæ­¥æœåŠ¡å™¨åœ°å€ä¸ºé˜¿é‡Œäº‘ sed -i.bak '3,6d' /etc/chrony.conf && sed -i '3cserver ntp1.aliyun.com iburst' \\ /etc/chrony.conf //å¯åŠ¨chronydåŠåŠ å…¥å¼€æœºè‡ªå¯ systemctl start chronyd && systemctl enable chronyd //æŸ¥çœ‹åŒæ­¥ç»“æœ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* 120.25.115.20 2 6 37 13 +194us[+6131us] +/- 33ms 1.7å…³é—­swapåˆ†åŒº ä¿®æ”¹/etc/fstabæ–‡ä»¶ï¼Œæ³¨é‡Šæ‰ SWAP çš„è‡ªåŠ¨æŒ‚è½½ï¼Œä½¿ç”¨free -mç¡®è®¤ swap å·²ç»å…³é—­ //æ‰‹åŠ¨å…³é—­swap swapoff -a //ä¿®æ”¹fstabæ–‡ä»¶ï¼Œæ³¨é‡Šswapè‡ªåŠ¨æŒ‚è½½ sed -i '/^\\/dev\\/mapper\\/centos-swap/c#/dev/mapper/centos-swap swap swap defaults 0 0' /etc/fstab //æŸ¥çœ‹swapæ˜¯å¦å…³é—­ free -m total used free shared buff/cache available Mem: 1994 682 612 9 699 1086 Swap: 0 0 0 swappiness å‚æ•°è°ƒæ•´ï¼Œä¿®æ”¹/etc/sysctl.d/k8s.confæ·»åŠ ä¸‹é¢ä¸€è¡Œ cat >>/etc/sysctl.d/k8s.conf 1.8å®‰è£…docker18.09.9 1.æ·»åŠ é˜¿é‡Œäº‘yumæº yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 2.æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ yum list docker-ce --showduplicates | sort -r å·²åŠ è½½æ’ä»¶ï¼šfastestmirror, langpacks å¯å®‰è£…çš„è½¯ä»¶åŒ… * updates: mirrors.aliyun.com Loading mirror speeds from cached hostfile * extras: mirrors.aliyun.com docker-ce.x86_64 3:19.03.5-3.el7 docker-ce-stable docker-ce.x86_64 3:19.03.4-3.el7 docker-ce-stable ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ docker-ce.x86_64 3:18.09.9-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.8-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.7-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.6-3.el7 docker-ce-stable ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 3.å®‰è£…docker18.09.9 yum -y install docker-ce-18.09.9-3.el7 docker-ce-cli-18.09.9 4.å¯åŠ¨dockerå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable docker && systemctl start docker 5.é…ç½®é˜¿é‡Œäº‘dockeré•œåƒåŠ é€Ÿ cat > /etc/docker/daemon.json 1.9ä¿®æ”¹docker Cgroup Driverä¸ºsystemd #ä¿®æ”¹docker Cgroup Driverä¸ºsystemd å°†/usr/lib/systemd/system/docker.serviceæ–‡ä»¶ä¸­çš„è¿™ä¸€è¡Œ ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ä¿®æ”¹ä¸º ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd å¦‚æœä¸ä¿®æ”¹ï¼Œåœ¨æ·»åŠ  worker èŠ‚ç‚¹æ—¶å¯èƒ½ä¼šç¢°åˆ°å¦‚ä¸‹é”™è¯¯ [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driver. The recommended driver is \"systemd\". Please follow the guide at https://kubernetes.io/docs/setup/cri/ //ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i.bak \"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g\" /usr/lib/systemd/system/docker.service //é‡å¯docker systemctl daemon-reload && systemctl restart docker 1.10å®‰è£…Kubeadm éœ€è¦ç§‘å­¦ä¸Šç½‘ cat >/etc/yum.repos.d/kubernetes.repo ä½¿ç”¨é˜¿é‡Œäº‘yumæº cat >/etc/yum.repos.d/kubernetes.repo å®‰è£… kubeadmã€kubeletã€kubectl(é˜¿é‡Œäº‘yumæºä¼šéšå®˜æ–¹æ›´æ–°æœ€æ–°ç‰ˆï¼Œå› æ­¤æŒ‡å®šç‰ˆæœ¬) //å®‰è£…1.16.3ç‰ˆæœ¬ yum -y install kubelet-1.16.3 kubeadm-1.16.3 kubectl-1.16.3 //æŸ¥çœ‹ç‰ˆæœ¬ kubeadm version kubeadm version: &version.Info{Major:\"1\", Minor:\"15\", GitVersion:\"v1.15.3\", GitCommit:\"2d3c76f9091b6bec110a5e63777c332469e0cba2\", GitTreeState:\"clean\", BuildDate:\"2019-08-19T11:11:18Z\", GoVersion:\"go1.12.9\", Compiler:\"gc\", Platform:\"linux/amd64\"} è®¾ç½®kubeletå¼€æœºè‡ªå¯ systemctl enable kubelet è®¾ç½®k8så‘½ä»¤è‡ªåŠ¨è¡¥å…¨ yum -y install bash-completion source /usr/share/bash-completion/bash_completion source > ~/.bashrc åˆ°æ­¤ï¼ŒåŸºæœ¬ç¯å¢ƒå®‰è£…å®Œæˆ!!! äºŒã€åˆå§‹åŒ–é›†ç¾¤ 2.1masterèŠ‚ç‚¹æ“ä½œï¼Œé…ç½® kubeadm åˆå§‹åŒ–æ–‡ä»¶ cat ./kubeadm-config.yaml apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: v1.16.3 imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers #dnsName controlPlaneEndpoint: \"10.0.0.130:6443\" networking: serviceSubnet: \"10.96.0.0/16\" #k8så®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µ podSubnet: \"10.100.0.1/16\" dnsDomain: \"cluster.local\" EOF 2.2åˆå§‹åŒ–master âš ï¸å¦‚æœæƒ³è¦é‡æ–°åˆå§‹åŒ–ï¼Œéœ€è¦æ‰§è¡Œå‘½ä»¤kubeadm reset -f #kubeadm init --config=kubeadm-config.yaml --upload-certs å®Œæ•´è¾“å‡ºç»“æœ kubeadm init --config=kubeadm-config.yaml [init] Using Kubernetes version: v1.16.3 [preflight] Running pre-flight checks [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using 'kubeadm config images pull' [kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\" [kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\" [kubelet-start] Activating the kubelet service [certs] Using certificateDir folder \"/etc/kubernetes/pki\" [certs] Generating \"ca\" certificate and key [certs] Generating \"apiserver\" certificate and key [certs] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 10.0.0.130 10.0.0.130] [certs] Generating \"apiserver-kubelet-client\" certificate and key [certs] Generating \"front-proxy-ca\" certificate and key [certs] Generating \"front-proxy-client\" certificate and key [certs] Generating \"etcd/ca\" certificate and key [certs] Generating \"etcd/server\" certificate and key [certs] etcd/server serving cert is signed for DNS names [k8s-master localhost] and IPs [10.0.0.130 127.0.0.1 ::1] [certs] Generating \"etcd/peer\" certificate and key [certs] etcd/peer serving cert is signed for DNS names [k8s-master localhost] and IPs [10.0.0.130 127.0.0.1 ::1] [certs] Generating \"etcd/healthcheck-client\" certificate and key [certs] Generating \"apiserver-etcd-client\" certificate and key [certs] Generating \"sa\" key and public key [kubeconfig] Using kubeconfig folder \"/etc/kubernetes\" [kubeconfig] Writing \"admin.conf\" kubeconfig file [kubeconfig] Writing \"kubelet.conf\" kubeconfig file [kubeconfig] Writing \"controller-manager.conf\" kubeconfig file [kubeconfig] Writing \"scheduler.conf\" kubeconfig file [control-plane] Using manifest folder \"/etc/kubernetes/manifests\" [control-plane] Creating static Pod manifest for \"kube-apiserver\" [control-plane] Creating static Pod manifest for \"kube-controller-manager\" [control-plane] Creating static Pod manifest for \"kube-scheduler\" [etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\" [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\". This can take up to 4m0s [apiclient] All control plane components are healthy after 16.501777 seconds [upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace [kubelet] Creating a ConfigMap \"kubelet-config-1.16\" in namespace kube-system with the configuration for the kubelets in the cluster [upload-certs] Skipping phase. Please see --upload-certs [mark-control-plane] Marking the node k8s-master as control-plane by adding the label \"node-role.kubernetes.io/master=''\" [mark-control-plane] Marking the node k8s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule] [bootstrap-token] Using token: px979r.mphk9ee5ya8fgy44 [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token [bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster [bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace [addons] Applied essential addon: CoreDNS [addons] Applied essential addon: kube-proxy Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of control-plane nodes by copying certificate authorities and service account keys on each node and then running the following as root: kubeadm join 10.0.0.130:6443 --token px979r.mphk9ee5ya8fgy44 \\ --discovery-token-ca-cert-hash sha256:5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 \\ --control-plane Then you can join any number of worker nodes by running the following on each as root: kubeadm join 10.0.0.130:6443 --token px979r.mphk9ee5ya8fgy44 \\ --discovery-token-ca-cert-hash sha256:5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 #kubeadm init --config=kubeadm-config.yaml --upload-certsåˆå§‹åŒ–masterä¸‹è½½çš„é•œåƒ gcr.azk8s.cn/google_containers/kube-proxy v1.16.3 9b65a0f78b09 4 months ago 86.1MB gcr.azk8s.cn/google_containers/kube-apiserver v1.16.3 df60c7526a3d 4 months ago 217MB gcr.azk8s.cn/google_containers/kube-controller-manager v1.16.3 bb16442bcd94 4 months ago 163MB gcr.azk8s.cn/google_containers/kube-scheduler v1.16.3 98fecf43a54f 4 months ago 87.3MB gcr.azk8s.cn/google_containers/etcd 3.3.15-0 b2756210eeab 6 months ago 247MB gcr.azk8s.cn/google_containers/coredns 1.6.2 bf261d157914 7 months ago 44.1MB gcr.azk8s.cn/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB æ‹·è´ kubeconfig æ–‡ä»¶ //è¿™é‡Œçš„è·¯å¾„ä¸º/root mkdir -p $HOME/.kube cp -i /etc/kubernetes/admin.conf $HOME/.kube/config chown $(id -u):$(id -g) $HOME/.kube/config 2.3masteræ·»åŠ èŠ‚ç‚¹ node1å’Œnode2ç›¸åŒæ“ä½œ å°†masterèŠ‚ç‚¹ä¸Šçš„$HOME/.kube/config æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹å¯¹åº”çš„æ–‡ä»¶ä¸­ 1.åˆ›å»ºç›®å½•ï¼Œè¿™é‡Œçš„è·¯å¾„ä¸º/root mkdir -p $HOME/.kube 2.æŠŠmasterèŠ‚ç‚¹ä¸Šçš„configæ–‡ä»¶æ‹·è´åˆ°node1å’Œnode2çš„$HOME/.kube scp k8s-master:~/.kube/config $HOME/.kube 3.ä¿®æ”¹æƒé™ chown $(id -u):$(id -g) $HOME/.kube/config å°†node1å’Œnode2åŠ å…¥åˆ°é›†ç¾¤ä¸­ è¿™é‡Œéœ€è¦ç”¨åˆ°2.2ä¸­åˆå§‹åŒ–masteræœ€åç”Ÿæˆçš„tokenå’Œsha256å€¼ #kubeadm join 10.0.0.130:6443 --token px979r.mphk9ee5ya8fgy44 --discovery-token-ca-cert-hash sha256:5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 è¾“å‡ºç»“æœ [preflight] Running pre-flight checks [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driver. The recommended driver is \"systemd\". Please follow the guide at https://kubernetes.io/docs/setup/cri/ [preflight] Reading configuration from the cluster... [preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml' [kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-1.16\" ConfigMap in the kube-system namespace [kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\" [kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\" [kubelet-start] Activating the kubelet service [kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap... This node has joined the cluster: * Certificate signing request was sent to apiserver and a response was received. * The Kubelet was informed of the new secure connection details. Run 'kubectl get nodes' on the control-plane to see this node join the cluster. å¦‚æœå¿˜è®°äº†tokenå’Œsha256å€¼ï¼Œå¯ä»¥åœ¨masterèŠ‚ç‚¹ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ //æŸ¥çœ‹token #kubeadm token list TOKEN TTL EXPIRES USAGES DESCRIPTION EXTRA GROUPS px979r.mphk9ee5ya8fgy44 20h 2020-03-18T13:49:48+08:00 authentication,signing system:bootstrappers:kubeadm:default-node-token //æŸ¥çœ‹sha256 #openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //' 5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 //åŒæ—¶æŸ¥çœ‹tokenå’Œsha256 #kubeadm token create --print-join-command kubeadm join 10.0.0.130:6443 --token 9b28zg.oyt0kvvpmtrem4bg --discovery-token-ca-cert-hash sha256:5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 masterèŠ‚ç‚¹æŸ¥çœ‹nodeï¼Œå‘ç°çŠ¶æ€éƒ½æ˜¯NotReadyï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å®‰è£…calioå®˜æ–¹æ’ä»¶æ–‡æ¡£ kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master NotReady master 19m v1.16.3 k8s-node1 NotReady 4m10s v1.16.3 k8s-node2 NotReady 4m3s v1.16.3 2.4masterèŠ‚ç‚¹å®‰è£…ç½‘ç»œæ’ä»¶calio //ä¸‹è½½æ–‡ä»¶ wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml wget https://kuboard.cn/install-script/calico/calico-3.9.2.yaml å°†æ–‡ä»¶ä¸­çš„620è¡Œæ”¹ä¸ºå¦‚ä¸‹ï¼Œå› ä¸ºåœ¨ä¸Šè¾¹kubeadm-config.yamlé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†å®¹å™¨ç»„IP 620è¡Œ value: \"10.100.0.1/16\" //ä¿®æ”¹å®Œæˆåå®‰è£…calicoç½‘ç»œæ’ä»¶ #kubectl apply -f calico-3.9.2.yaml //å®‰è£…å®Œæˆåç¨ç­‰ä¸€ä¼šæŸ¥çœ‹podsçŠ¶æ€ #kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE calico-kube-controllers-dc6cb64cb-8sh59 1/1 Running 0 6m22s calico-node-89s9k 1/1 Running 0 6m22s calico-node-dkt7w 1/1 Running 0 6m22s calico-node-tgg2h 1/1 Running 0 6m22s coredns-667f964f9b-7hrj9 1/1 Running 0 33m coredns-667f964f9b-8q7sh 1/1 Running 0 33m etcd-k8s-master 1/1 Running 0 33m kube-apiserver-k8s-master 1/1 Running 0 32m kube-controller-manager-k8s-master 1/1 Running 0 33m kube-proxy-b2r5d 1/1 Running 0 12m kube-proxy-nd982 1/1 Running 0 11m kube-proxy-zh6cz 1/1 Running 0 33m kube-scheduler-k8s-master 1/1 Running 0 32m //æŸ¥çœ‹nodeçŠ¶æ€ [root@k8s-master ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master Ready master 31m v1.16.3 k8s-node1 Ready 9m46s v1.16.3 k8s-node2 Ready 9m22s v1.16.3 #kubectl apply -f calico.yamlå®‰è£…ç½‘ç»œæ’ä»¶calicoä¸‹è½½çš„é•œåƒ calico/node v3.9.2 14a380c92c40 5 months ago 195MB calico/cni v3.9.2 c0d73dd53e71 5 months ago 160MB calico/pod2daemon-flexvol v3.9.2 523f0356e07b 5 months ago 9.78MB #å¯åŠ¨çš„å®¹å™¨ 03df44242d90 calico/node \"start_runit\" 8 minutes ago Up 8 minutes k8s_calico-node_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 c2a56feedc7c calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 9 minutes ago Exited (0) 9 minutes ago k8s_flexvol-driver_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 ca9febcebaa8 c0d73dd53e71 \"/install-cni.sh\" 10 minutes ago Exited (0) 10 minutes ago k8s_install-cni_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 b581894b1b91 calico/cni \"/opt/cni/bin/calicoâ€¦\" 10 minutes ago Exited (0) 10 minutes ago k8s_upgrade-ipam_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 2.5å®‰è£…Dashboard(å¯é€‰) ä¸‹è½½æ–‡ä»¶åŠä¿®æ”¹å†…å®¹ è¿™é‡ŒæŸ¥çœ‹dashboardå¯¹åº”çš„k8sç‰ˆæœ¬ //ä¸‹è½½æ–‡ä»¶ v2.0.0-rc3æ˜¯ä¸­æ–‡ç‰ˆæœ¬ï¼Œbeta8æ˜¯è‹±æ–‡ç‰ˆæœ¬ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta8/aio/deploy/recommended.yaml wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc3/aio/deploy/recommended.yaml //ä¿®æ”¹Serviceä¸ºNodePortç±»å‹ 42è¡Œä¸‹å¢åŠ ä¸€è¡Œ nodePort: 30001 44è¡Œä¸‹å¢åŠ ä¸€è¡Œ type: NodePort //åŸå…ˆå†…å®¹ spec: ports: - port: 443 targetPort: 8443 selector: k8s-app: kubernetes-dashboard //ä¿®æ”¹åå†…å®¹ spec: ports: - port: 443 targetPort: 8443 nodePort: 30001 #å¢åŠ ï¼ŒæŒ‡å®šnodeportç«¯å£ selector: k8s-app: kubernetes-dashboard type: NodePort #å¢åŠ ï¼Œä¿®æ”¹ç±»å‹ä¸ºnodeport éƒ¨ç½²dashboard #kubectl apply -f recommended.yaml #ä¸‹è½½çš„é•œåƒ kubernetesui/metrics-scraper v1.0.3 3327f0dbcb4a 6 weeks ago 40.1MB kubernetesui/dashboard v2.0.0-beta8 eb51a3597525 3 months ago 90.8MB #å¯åŠ¨çš„å®¹å™¨ 8bc24b355d78 kubernetesui/dashboard \"/dashboard --insecuâ€¦\" 7 minutes ago Up 7 minutes k8s_kubernetes-dashboard_kubernetes-dashboard-5996555fd8-2ppc5_kubernetes-dashboard_7f46632c-8b7b-41e4-aeb3-a1fbadd29782_0 æŸ¥çœ‹dashboardçš„è¿è¡ŒçŠ¶æ€åŠå¤–ç½‘è®¿é—®ç«¯å£ //æŸ¥çœ‹dashboardè¿è¡ŒçŠ¶æ€ #kubectl get pods -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard NAME READY STATUS RESTARTS AGE kubernetes-dashboard-5996555fd8-2ppc5 1/1 Running 0 8m16s //æŸ¥çœ‹dashboardå¤–ç½‘è®¿é—®ç«¯å£ï¼Œå‘½åç©ºé—´ä¸ºkubernetes-dashboard #kubectl get svc -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard kubectl get svc -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes-dashboard NodePort 10.96.142.172 443:30001/TCP 8m37s é€šè¿‡ä¸Šè¾¹çš„30001ç«¯å£è®¿é—®dashboardï¼Œæ³¨æ„æ˜¯https âš ï¸k8s1.16.3è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨çš„dashboardç‰ˆæœ¬æ˜¯2.0.0-beta8ï¼Œåªæœ‰ç«ç‹æµè§ˆå™¨å¯ä»¥è®¿é—®ï¼Œå…¶ä½™æµè§ˆå™¨éƒ½ä¸èƒ½è®¿é—®ï¼Œä¼šæŠ¥é”™å¦‚ä¸‹ ä½¿ç”¨ç«ç‹æµè§ˆå™¨è®¿é—®ï¼Œç”±äº dashboard é»˜è®¤æ˜¯è‡ªå»ºçš„ https è¯ä¹¦ï¼Œè¯¥è¯ä¹¦æ˜¯ä¸å—æµè§ˆå™¨ä¿¡ä»»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼ºåˆ¶è·³è½¬å°±å¯ä»¥äº† ç„¶ååˆ›å»ºä¸€ä¸ªå…·æœ‰å…¨å±€æ‰€æœ‰æƒé™çš„ç”¨æˆ·æ¥ç™»å½•Dashboard //ç¼–è¾‘admin.yamlæ–‡ä»¶ cat > admin.yaml ç„¶åç²˜è´´ä¸Šè¿°ç”Ÿæˆçš„base64å­—ç¬¦ä¸²ç™»é™†dashboardï¼Œåœ¨ç™»é™†é¡µé¢é€‰æ‹©ä»¤ç‰Œä¸€é¡¹ ç™»é™†åçš„é¦–ç•Œé¢ è·å–ä»¤ç‰Œå‘½ä»¤ kubectl get secret `kubectl get secret -n kube-system|grep admin-token|awk '{print $1}'` -o jsonpath={.data.token} -n kube-system |base64 -d 2.6å®‰è£…kuboard(å¯é€‰) kuboardæ˜¯Kubernetes çš„ä¸€æ¬¾å›¾å½¢åŒ–ç®¡ç†ç•Œé¢ å®‰è£…kuboard kubectl apply -f https://kuboard.cn/install-script/kuboard.yaml kubectl apply -f https://addons.kuboard.cn/metrics-server/0.3.6/metrics-server.yaml æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ #kubectl get pods -l k8s.eip.work/name=kuboard -n kube-system NAME READY STATUS RESTARTS AGE kuboard-756d46c4d4-tvhjq 1/1 Running 0 40s è·å–token //è·å–ç®¡ç†å‘˜token kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-user | awk '{print $1}') -o go-template='{{.data.token}}' | base64 -d && echo //è·å–åªè¯»token kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-viewer | awk '{print $1}') -o go-template='{{.data.token}}' | base64 -d && echo è®¿é—®kuboard Kuboard Service ä½¿ç”¨äº† NodePort çš„æ–¹å¼æš´éœ²æœåŠ¡ï¼ŒNodePort ä¸º 32567 k8sé›†ç¾¤çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è®¿é—®åˆ° ç™»é™†é¦–ç•Œé¢ kuboardä¸‹è½½çš„é•œåƒå’Œå¯åŠ¨çš„å®¹å™¨ #å¯åŠ¨çš„å®¹å™¨ 5d800a6ee8ad eipwork/kuboard \"/entrypoint.sh\" 9 minutes ago Up 9 minutes k8s_kuboard_kuboard-756d46c4d4-tvhjq_kube-system_6b88b7b5-64d8-4af3-8065-999b19722c86_0 #ä¸‹è½½çš„é•œåƒï¼Œæœ¬æ–‡ä¸­ä¸º1.0.8.2ç‰ˆæœ¬ eipwork/kuboard latest c6d652bbdf90 About an hour ago 180MB åˆ°æ­¤ï¼Œä½¿ç”¨kubeadmå®‰è£…k8s 1.16.3å®Œæˆï¼ï¼ï¼ 1.16.3masterå¯åŠ¨çš„å®¹å™¨åŠä¸‹è½½çš„é•œåƒ #ä¸‹è½½çš„é•œåƒ kubernetesui/metrics-scraper v1.0.3 3327f0dbcb4a 6 weeks ago 40.1MB kubernetesui/dashboard v2.0.0-beta8 eb51a3597525 3 months ago 90.8MB gcr.azk8s.cn/google_containers/kube-apiserver v1.16.3 df60c7526a3d 4 months ago 217MB gcr.azk8s.cn/google_containers/kube-proxy v1.16.3 9b65a0f78b09 4 months ago 86.1MB gcr.azk8s.cn/google_containers/kube-controller-manager v1.16.3 bb16442bcd94 4 months ago 163MB gcr.azk8s.cn/google_containers/kube-scheduler v1.16.3 98fecf43a54f 4 months ago 87.3MB calico/node v3.9.2 14a380c92c40 5 months ago 195MB calico/cni v3.9.2 c0d73dd53e71 5 months ago 160MB calico/pod2daemon-flexvol v3.9.2 523f0356e07b 5 months ago 9.78MB gcr.azk8s.cn/google_containers/etcd 3.3.15-0 b2756210eeab 6 months ago 247MB gcr.azk8s.cn/google_containers/coredns 1.6.2 bf261d157914 7 months ago 44.1MB kubernetesui/metrics-scraper v1.0.1 709901356c11 8 months ago 40.1MB gcr.azk8s.cn/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB #å¯åŠ¨çš„å®¹å™¨ 8bc24b355d78 kubernetesui/dashboard \"/dashboard --insecuâ€¦\" 19 minutes ago Up 19 minutes k8s_kubernetes-dashboard_kubernetes-dashboard-5996555fd8-2ppc5_kubernetes-dashboard_7f46632c-8b7b-41e4-aeb3-a1fbadd29782_0 4ebd793dc31f gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 19 minutes ago Up 19 minutes k8s_POD_kubernetes-dashboard-5996555fd8-2ppc5_kubernetes-dashboard_7f46632c-8b7b-41e4-aeb3-a1fbadd29782_0 03df44242d90 calico/node \"start_runit\" 6 hours ago Up 6 hours k8s_calico-node_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 c2a56feedc7c calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 6 hours ago Exited (0) 6 hours ago k8s_flexvol-driver_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 ca9febcebaa8 c0d73dd53e71 \"/install-cni.sh\" 6 hours ago Exited (0) 6 hours ago k8s_install-cni_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 b581894b1b91 calico/cni \"/opt/cni/bin/calicoâ€¦\" 6 hours ago Exited (0) 6 hours ago k8s_upgrade-ipam_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 2b58aa8cbc01 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 6 hours ago Up 6 hours k8s_POD_calico-node-89s9k_kube-system_ff5384c4-72b2-4bfa-b8ea-77f38c2a2112_0 8ff547ee27a4 9b65a0f78b09 \"/usr/local/bin/kubeâ€¦\" 7 hours ago Up 7 hours k8s_kube-proxy_kube-proxy-zh6cz_kube-system_7a02864d-77cd-4636-ac70-aa56ad8c1df0_0 4c5be9765eaf gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 7 hours ago Up 7 hours k8s_POD_kube-proxy-zh6cz_kube-system_7a02864d-77cd-4636-ac70-aa56ad8c1df0_0 09ae85c8b8f5 df60c7526a3d \"kube-apiserver --adâ€¦\" 7 hours ago Up 7 hours k8s_kube-apiserver_kube-apiserver-k8s-master_kube-system_a8b1669c873ef7b41dacef818eb65aa9_0 6f17c0d51694 98fecf43a54f \"kube-scheduler --auâ€¦\" 7 hours ago Up 7 hours k8s_kube-scheduler_kube-scheduler-k8s-master_kube-system_8abfe947f8f4e810a2308b65bb933780_0 da743be3ec06 bb16442bcd94 \"kube-controller-manâ€¦\" 7 hours ago Up 7 hours k8s_kube-controller-manager_kube-controller-manager-k8s-master_kube-system_018dbc8aa2984b8851a80fc82254cb97_0 123d4d44a34f b2756210eeab \"etcd --advertise-clâ€¦\" 7 hours ago Up 7 hours k8s_etcd_etcd-k8s-master_kube-system_6ba6d49a08f1a79cf377b8d0029e9a22_0 c4e04b936c8e gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 7 hours ago Up 7 hours k8s_POD_kube-apiserver-k8s-master_kube-system_a8b1669c873ef7b41dacef818eb65aa9_0 f9411212bc50 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 7 hours ago Up 7 hours k8s_POD_kube-scheduler-k8s-master_kube-system_8abfe947f8f4e810a2308b65bb933780_0 20c18e3366ae gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 7 hours ago Up 7 hours k8s_POD_etcd-k8s-master_kube-system_6ba6d49a08f1a79cf377b8d0029e9a22_0 1e74a3ddf17b gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 7 hours ago Up 7 hours k8s_POD_kube-controller-manager-k8s-master_kube-system_018dbc8aa2984b8851a80fc82254cb97_0 1.16.3nodeå¯åŠ¨çš„å®¹å™¨åŠä¸‹è½½çš„é•œåƒ æ¯ä¸ªnodeéƒ½æœ‰çš„é•œåƒ kube-proxy pause calico/node calico/cni calico/pod2daemon-flexvol corednsã€calico/kube-controllersä¼šéšæœºåœ¨ä¸€ä¸ªnodeä¸Š //node1 #ä¸‹è½½çš„é•œåƒ gcr.azk8s.cn/google_containers/kube-proxy v1.16.3 9b65a0f78b09 4 months ago 86.1MB calico/node v3.9.2 14a380c92c40 5 months ago 195MB calico/cni v3.9.2 c0d73dd53e71 5 months ago 160MB calico/kube-controllers v3.9.2 7f7ed50db9fb 5 months ago 56MB calico/pod2daemon-flexvol v3.9.2 523f0356e07b 5 months ago 9.78MB gcr.azk8s.cn/google_containers/coredns 1.6.2 bf261d157914 7 months ago 44.1MB gcr.azk8s.cn/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB #å¯åŠ¨çš„å®¹å™¨ 958f160a7e79 calico/kube-controllers \"/usr/bin/kube-contrâ€¦\" 4 minutes ago Up 4 minutes k8s_calico-kube-controllers_calico-kube-controllers-dc6cb64cb-c6cng_kube-system_072a1596-42e8-4375-983c-fd6f9b173424_0 f3a7fbbb8e49 gcr.azk8s.cn/google_containers/coredns \"/coredns -conf /etcâ€¦\" 5 minutes ago Up 5 minutes k8s_coredns_coredns-667f964f9b-qz88x_kube-system_f18743bb-37af-4e8a-8268-9e328d3e0000_0 18150cf23c39 gcr.azk8s.cn/google_containers/coredns \"/coredns -conf /etcâ€¦\" 5 minutes ago Up 5 minutes k8s_coredns_coredns-667f964f9b-sdkc9_kube-system_712e4a15-923a-437b-a1dc-bfefaf30f920_0 e120da514c18 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 5 minutes ago Up 5 minutes k8s_POD_calico-kube-controllers-dc6cb64cb-c6cng_kube-system_072a1596-42e8-4375-983c-fd6f9b173424_24 b5e3c36224ad gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 5 minutes ago Up 5 minutes k8s_POD_coredns-667f964f9b-qz88x_kube-system_f18743bb-37af-4e8a-8268-9e328d3e0000_23 c4cd7571e098 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 5 minutes ago Up 5 minutes k8s_POD_coredns-667f964f9b-sdkc9_kube-system_712e4a15-923a-437b-a1dc-bfefaf30f920_24 f497eb8c1b1a calico/node \"start_runit\" 5 minutes ago Up 5 minutes k8s_calico-node_calico-node-rcnts_kube-system_ebfce9a1-ad69-46e7-8e24-e9d3c51678bc_0 a55cab0bd81c calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 5 minutes ago Exited (0) 5 minutes ago k8s_flexvol-driver_calico-node-rcnts_kube-system_ebfce9a1-ad69-46e7-8e24-e9d3c51678bc_0 4b3f60e0d519 c0d73dd53e71 \"/install-cni.sh\" 6 minutes ago Exited (0) 6 minutes ago k8s_install-cni_calico-node-rcnts_kube-system_ebfce9a1-ad69-46e7-8e24-e9d3c51678bc_0 ee4493f6c482 calico/cni \"/opt/cni/bin/calicoâ€¦\" 6 minutes ago Exited (0) 6 minutes ago k8s_upgrade-ipam_calico-node-rcnts_kube-system_ebfce9a1-ad69-46e7-8e24-e9d3c51678bc_0 87fe130ab10d gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 6 minutes ago Up 6 minutes k8s_POD_calico-node-rcnts_kube-system_ebfce9a1-ad69-46e7-8e24-e9d3c51678bc_0 ba408469e7bc gcr.azk8s.cn/google_containers/kube-proxy \"/usr/local/bin/kubeâ€¦\" 9 minutes ago Up 9 minutes k8s_kube-proxy_kube-proxy-q2tj7_kube-system_3c629796-9972-491a-87e7-3cc14264088e_0 272708e9251a gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 9 minutes ago Up 9 minutes k8s_POD_kube-proxy-q2tj7_kube-system_3c629796-9972-491a-87e7-3cc14264088e_0 //node2 #ä¸‹è½½çš„é•œåƒ gcr.azk8s.cn/google_containers/kube-proxy v1.16.3 9b65a0f78b09 4 months ago 86.1MB calico/node v3.9.2 14a380c92c40 5 months ago 195MB calico/cni v3.9.2 c0d73dd53e71 5 months ago 160MB calico/pod2daemon-flexvol v3.9.2 523f0356e07b 5 months ago 9.78MB gcr.azk8s.cn/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB #å¯åŠ¨çš„å®¹å™¨ acc3f199861e calico/node \"start_runit\" 6 minutes ago Up 6 minutes k8s_calico-node_calico-node-kdlz8_kube-system_e879923e-1028-4108-bdcc-29b8c7044127_0 8ff828ca0423 calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 6 minutes ago Exited (0) 6 minutes ago k8s_flexvol-driver_calico-node-kdlz8_kube-system_e879923e-1028-4108-bdcc-29b8c7044127_0 0bd0e1544cf7 c0d73dd53e71 \"/install-cni.sh\" 6 minutes ago Exited (0) 6 minutes ago k8s_install-cni_calico-node-kdlz8_kube-system_e879923e-1028-4108-bdcc-29b8c7044127_0 7bc2a912fda6 calico/cni \"/opt/cni/bin/calicoâ€¦\" 6 minutes ago Exited (0) 6 minutes ago k8s_upgrade-ipam_calico-node-kdlz8_kube-system_e879923e-1028-4108-bdcc-29b8c7044127_0 1409a1dbc779 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 7 minutes ago Up 7 minutes k8s_POD_calico-node-kdlz8_kube-system_e879923e-1028-4108-bdcc-29b8c7044127_0 dda871e9daab gcr.azk8s.cn/google_containers/kube-proxy \"/usr/local/bin/kubeâ€¦\" 10 minutes ago Up 10 minutes k8s_kube-proxy_kube-proxy-trqdv_kube-system_c572710b-0867-4baf-a629-8262f6511d15_0 a5c5c619ec67 gcr.azk8s.cn/google_containers/pause:3.1 \"/pause\" 10 minutes ago Up 10 minutes k8s_POD_kube-proxy-trqdv_kube-system_c572710b-0867-4baf-a629-8262f6511d15_0 k8såˆ‡æ¢å‘½åç©ºé—´å·¥å…· git clone https://github.com.cnpmjs.org/ahmetb/kubectx cp kubectx/kubens /usr/local/bin #æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´ kubens #åˆ‡æ¢åˆ°kube-systemå‘½åç©ºé—´ kubens kube-system Context \"kubernetes-admin@kubernetes\" modified. Active namespace is \"kube-system\". æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8så®‰è£…/3.ä½¿ç”¨ kubeadm æ­å»º v1.17.4 ç‰ˆæœ¬ Kubernetes é›†ç¾¤.html":{"url":"linux/k8s/k8så®‰è£…/3.ä½¿ç”¨ kubeadm æ­å»º v1.17.4 ç‰ˆæœ¬ Kubernetes é›†ç¾¤.html","title":"1.17","keywords":"","body":"ä½¿ç”¨ kubeadm æ­å»º v1.17.4 ç‰ˆæœ¬ Kubernetes é›†ç¾¤ ä¸€ã€ç¯å¢ƒå‡†å¤‡ 1.1å®éªŒç¯å¢ƒ è§’è‰² IPåœ°å€ ä¸»æœºå dockerç‰ˆæœ¬ ç¡¬ä»¶é…ç½® ç³»ç»Ÿ å†…æ ¸ master 10.0.0.130 k8s-master 19.03.4 2c2g CentOS7.6 3.10.0-957.el7.x86_64 node1 10.0.0.131 k8s-node1 19.03.4 2c1g CentOS7.6 3.10.0-957.el7.x86_64 node2 10.0.0.132 k8s-node2 19.03.4 2c1g CentOS7.6 3.10.0-957.el7.x86_64 1.2æ¯ä¸ªèŠ‚ç‚¹é…ç½®hostä¿¡æ¯ cat >> /etc/hosts 1.3ç¦ç”¨é˜²ç«å¢™å’Œselinux //ç¦ç”¨é˜²ç«å¢™ systemctl stop firewalld && systemctl disable firewalld //ç¦ç”¨selinux #ä¸´æ—¶ä¿®æ”¹ setenforce 0 #æ°¸ä¹…ä¿®æ”¹ï¼Œé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆ sed -i '7s/enforcing/disabled/' /etc/selinux/config 1.4åˆ›å»º/etc/sysctl.d/k8s.confæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ //å‘æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ cat >/etc/sysctl.d/k8s.conf 1.5å®‰è£…ipvs(å¯é€‰) è„šæœ¬åˆ›å»ºäº†çš„/etc/sysconfig/modules/ipvs.modulesæ–‡ä»¶ï¼Œä¿è¯åœ¨èŠ‚ç‚¹é‡å¯åèƒ½è‡ªåŠ¨åŠ è½½æ‰€éœ€æ¨¡å—ã€‚ä½¿ç”¨lsmod | grep -e ip_vs -e nf_conntrack_ipv4å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å·²ç»æ­£ç¡®åŠ è½½æ‰€éœ€çš„å†…æ ¸æ¨¡å— //å‘æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ cat > /etc/sysconfig/modules/ipvs.modules å®‰è£…ipsetå’Œipvsadm(ä¾¿äºæŸ¥çœ‹ ipvs çš„ä»£ç†è§„åˆ™) yum -y install ipset ipvsadm 1.6åŒæ­¥æœåŠ¡å™¨æ—¶é—´ //å®‰è£…chrony yum -y install chrony //ä¿®æ”¹åŒæ­¥æœåŠ¡å™¨åœ°å€ä¸ºé˜¿é‡Œäº‘ sed -i.bak '3,6d' /etc/chrony.conf && sed -i '3cserver ntp1.aliyun.com iburst' \\ /etc/chrony.conf //å¯åŠ¨chronydåŠåŠ å…¥å¼€æœºè‡ªå¯ systemctl start chronyd && systemctl enable chronyd //æŸ¥çœ‹åŒæ­¥ç»“æœ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* 120.25.115.20 2 6 37 13 +194us[+6131us] +/- 33ms 1.7å…³é—­swapåˆ†åŒº ä¿®æ”¹/etc/fstabæ–‡ä»¶ï¼Œæ³¨é‡Šæ‰ SWAP çš„è‡ªåŠ¨æŒ‚è½½ï¼Œä½¿ç”¨free -mç¡®è®¤ swap å·²ç»å…³é—­ //æ‰‹åŠ¨å…³é—­swap swapoff -a //ä¿®æ”¹fstabæ–‡ä»¶ï¼Œæ³¨é‡Šswapè‡ªåŠ¨æŒ‚è½½ sed -i '/^\\/dev\\/mapper\\/centos-swap/c#/dev/mapper/centos-swap swap swap defaults 0 0' /etc/fstab //æŸ¥çœ‹swapæ˜¯å¦å…³é—­ free -m total used free shared buff/cache available Mem: 1994 682 612 9 699 1086 Swap: 0 0 0 swappiness å‚æ•°è°ƒæ•´ï¼Œä¿®æ”¹/etc/sysctl.d/k8s.confæ·»åŠ ä¸‹é¢ä¸€è¡Œ cat >>/etc/sysctl.d/k8s.conf 1.8å®‰è£…docker19.03.4 1.å¸è½½æ—§ç‰ˆæœ¬ yum remove -y docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-selinux \\ docker-engine-selinux \\ docker-engine 2.å®‰è£…ä¾èµ–åŒ… yum install -y yum-utils device-mapper-persistent-data lvm2 3.æ·»åŠ é˜¿é‡Œäº‘yumæº yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 4.æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ yum list docker-ce --showduplicates | sort -r å·²åŠ è½½æ’ä»¶ï¼šfastestmirror, langpacks å¯å®‰è£…çš„è½¯ä»¶åŒ… * updates: mirrors.aliyun.com Loading mirror speeds from cached hostfile * extras: mirrors.aliyun.com docker-ce.x86_64 3:19.03.5-3.el7 docker-ce-stable docker-ce.x86_64 3:19.03.4-3.el7 docker-ce-stable ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ docker-ce.x86_64 3:18.09.9-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.8-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.7-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.6-3.el7 docker-ce-stable ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 5.å®‰è£…docker19.03.4 yum install -y docker-ce-19.03.4 docker-ce-cli-19.03.4 containerd.io 6.å¯åŠ¨dockerå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable docker && systemctl start docker 7.é…ç½®é˜¿é‡Œäº‘dockeré•œåƒåŠ é€Ÿ cat > /etc/docker/daemon.json 1.9å®‰è£…Kubeadm éœ€è¦ç§‘å­¦ä¸Šç½‘ cat >/etc/yum.repos.d/kubernetes.repo ä½¿ç”¨é˜¿é‡Œäº‘yumæº cat >/etc/yum.repos.d/kubernetes.repo å®‰è£… kubeadmã€kubeletã€kubectl(é˜¿é‡Œäº‘yumæºä¼šéšå®˜æ–¹æ›´æ–°æœ€æ–°ç‰ˆï¼Œå› æ­¤æŒ‡å®šç‰ˆæœ¬) yum -y install kubelet-1.17.4 kubeadm-1.17.4 kubectl-1.17.4 //æŸ¥çœ‹ç‰ˆæœ¬ kubeadm version kubeadm version: &version.Info{Major:\"1\", Minor:\"17\", GitVersion:\"v1.17.4\", GitCommit:\"8d8aa39598534325ad77120c120a22b3a990b5ea\", GitTreeState:\"clean\", BuildDate:\"2020-03-12T21:01:11Z\", GoVersion:\"go1.13.8\", Compiler:\"gc\", Platform:\"linux/amd64\"} è®¾ç½®kubeletå¼€æœºè‡ªå¯ âš ï¸æ­¤æ—¶kubeletæ˜¯æ— æ³•å¯åŠ¨çš„ï¼Œå› ä¸ºåªæœ‰å®Œæˆmasterçš„kubeadm init çš„æ“ä½œï¼Œkubeletæ‰èƒ½æ­£å¸¸å¯åŠ¨ systemctl enable kubelet è®¾ç½®k8så‘½ä»¤è‡ªåŠ¨è¡¥å…¨ yum -y install bash-completion source /usr/share/bash-completion/bash_completion source > ~/.bashrc 1.10ä¿®æ”¹docker Cgroup Driverä¸ºsystemd #ä¿®æ”¹docker Cgroup Driverä¸ºsystemd å°†/usr/lib/systemd/system/docker.serviceæ–‡ä»¶ä¸­çš„è¿™ä¸€è¡Œ ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ä¿®æ”¹ä¸º ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd å¦‚æœä¸ä¿®æ”¹ï¼Œåœ¨æ·»åŠ  worker èŠ‚ç‚¹æ—¶å¯èƒ½ä¼šç¢°åˆ°å¦‚ä¸‹é”™è¯¯ [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driver. The recommended driver is \"systemd\". Please follow the guide at https://kubernetes.io/docs/setup/cri/ //ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i.bak \"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g\" /usr/lib/systemd/system/docker.service //é‡å¯docker systemctl daemon-reload && systemctl restart docker åˆ°æ­¤ï¼ŒåŸºæœ¬ç¯å¢ƒå®‰è£…å®Œæˆ!!! äºŒã€åˆå§‹åŒ–é›†ç¾¤ 2.1masterèŠ‚ç‚¹æ“ä½œï¼Œé…ç½® kubeadm åˆå§‹åŒ–æ–‡ä»¶ æ–¹æ³•ä¸€ å‘½ä»¤åˆå§‹åŒ– kubeadm init --apiserver-advertise-address=10.0.0.130 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.17.4 --service-cidr=10.96.0.0/16 --pod-network-cidr=10.20.0.0/16 --apiserver-advertise-address= #masterèŠ‚ç‚¹IP --image-repository registry.aliyuncs.com/google_containers #é•œåƒä»“åº“ --kubernetes-version v1.17.4 #k8sç‰ˆæœ¬ --service-cidr=10.96.0.0/16 #service IPç½‘æ®µ --pod-network-cidr=10.20.0.0/16 #pod IPç½‘æ®µï¼Œåç»­ç½‘ç»œæ’ä»¶ä¼šç”¨åˆ° æ–¹æ³•äºŒ æ–‡ä»¶åˆå§‹åŒ– cat > kubeadm.yaml 2.2åˆå§‹åŒ–master kubeadm init --config kubeadm.yaml å®Œæ•´è¾“å‡ºç»“æœ W0319 22:59:56.631407 12367 validation.go:28] Cannot validate kubelet config - no validator is available W0319 22:59:56.631444 12367 validation.go:28] Cannot validate kube-proxy config - no validator is available [init] Using Kubernetes version: v1.17.4 [preflight] Running pre-flight checks [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using 'kubeadm config images pull' [kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\" [kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\" [kubelet-start] Starting the kubelet [certs] Using certificateDir folder \"/etc/kubernetes/pki\" [certs] Generating \"ca\" certificate and key [certs] Generating \"apiserver\" certificate and key [certs] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 10.0.0.130] [certs] Generating \"apiserver-kubelet-client\" certificate and key [certs] Generating \"front-proxy-ca\" certificate and key [certs] Generating \"front-proxy-client\" certificate and key [certs] Generating \"etcd/ca\" certificate and key [certs] Generating \"etcd/server\" certificate and key [certs] etcd/server serving cert is signed for DNS names [k8s-master localhost] and IPs [10.0.0.130 127.0.0.1 ::1] [certs] Generating \"etcd/peer\" certificate and key [certs] etcd/peer serving cert is signed for DNS names [k8s-master localhost] and IPs [10.0.0.130 127.0.0.1 ::1] [certs] Generating \"etcd/healthcheck-client\" certificate and key [certs] Generating \"apiserver-etcd-client\" certificate and key [certs] Generating \"sa\" key and public key [kubeconfig] Using kubeconfig folder \"/etc/kubernetes\" [kubeconfig] Writing \"admin.conf\" kubeconfig file [kubeconfig] Writing \"kubelet.conf\" kubeconfig file [kubeconfig] Writing \"controller-manager.conf\" kubeconfig file [kubeconfig] Writing \"scheduler.conf\" kubeconfig file [control-plane] Using manifest folder \"/etc/kubernetes/manifests\" [control-plane] Creating static Pod manifest for \"kube-apiserver\" [control-plane] Creating static Pod manifest for \"kube-controller-manager\" W0319 23:01:45.692056 12367 manifests.go:214] the default kube-apiserver authorization-mode is \"Node,RBAC\"; using \"Node,RBAC\" [control-plane] Creating static Pod manifest for \"kube-scheduler\" W0319 23:01:45.692762 12367 manifests.go:214] the default kube-apiserver authorization-mode is \"Node,RBAC\"; using \"Node,RBAC\" [etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\" [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\". This can take up to 4m0s [apiclient] All control plane components are healthy after 16.502774 seconds [upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace [kubelet] Creating a ConfigMap \"kubelet-config-1.17\" in namespace kube-system with the configuration for the kubelets in the cluster [upload-certs] Skipping phase. Please see --upload-certs [mark-control-plane] Marking the node k8s-master as control-plane by adding the label \"node-role.kubernetes.io/master=''\" [mark-control-plane] Marking the node k8s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule] [bootstrap-token] Using token: abcdef.0123456789abcdef [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token [bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster [bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace [kubelet-finalize] Updating \"/etc/kubernetes/kubelet.conf\" to point to a rotatable kubelet client certificate and key [addons] Applied essential addon: CoreDNS [addons] Applied essential addon: kube-proxy Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 10.0.0.130:6443 --token abcdef.0123456789abcdef \\ --discovery-token-ca-cert-hash sha256:27b37276c4451b54c99106f73cb38c3b0bb6e2e178c142808e9ff00300ac7eaf #kubeadm init --config kubeadm.yamlåˆå§‹åŒ–masterä¸‹è½½çš„é•œåƒ registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy v1.17.4 6dec7cfde1e5 6 days ago 116MB registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver v1.17.4 2e1ba57fe95a 6 days ago 171MB registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager v1.17.4 7f997fcf3e94 6 days ago 161MB registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler v1.17.4 5db16c1c7aff 6 days ago 94.4MB registry.cn-hangzhou.aliyuncs.com/google_containers/coredns 1.6.5 70f311871ae1 4 months ago 41.6MB registry.cn-hangzhou.aliyuncs.com/google_containers/etcd 3.4.3-0 303ce5db0e90 4 months ago 288MB registry.cn-hangzhou.aliyuncs.com/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB #å¯åŠ¨çš„å®¹å™¨ 5220dac932a8 6dec7cfde1e5 \"/usr/local/bin/kubeâ€¦\" 2 minutes ago Up 2 minutes k8s_kube-proxy_kube-proxy-jlwfd_kube-system_5af2149d-dc6c-4a6b-a99b-fb0af734d1fb_0 20a9003d1a55 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 2 minutes ago Up 2 minutes k8s_POD_kube-proxy-jlwfd_kube-system_5af2149d-dc6c-4a6b-a99b-fb0af734d1fb_0 48c86b9adbf1 7f997fcf3e94 \"kube-controller-manâ€¦\" 3 minutes ago Up 3 minutes k8s_kube-controller-manager_kube-controller-manager-k8s-master_kube-system_c06ae2244175d69b82dd8327536a3f47_0 beed6b3671bd 5db16c1c7aff \"kube-scheduler --auâ€¦\" 3 minutes ago Up 3 minutes k8s_kube-scheduler_kube-scheduler-k8s-master_kube-system_0621ae8690c69d1d72f746bc2de0667e_0 fe47bd324d10 2e1ba57fe95a \"kube-apiserver --adâ€¦\" 3 minutes ago Up 3 minutes k8s_kube-apiserver_kube-apiserver-k8s-master_kube-system_ffa9ef4a4e85500fbc6d35b5a88efb43_0 cfbf4d126eae 303ce5db0e90 \"etcd --advertise-clâ€¦\" 3 minutes ago Up 3 minutes k8s_etcd_etcd-k8s-master_kube-system_ba1d164d5064efe1d13e5645859a6dec_0 aff7b239f5ef registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 3 minutes ago Up 3 minutes k8s_POD_kube-scheduler-k8s-master_kube-system_0621ae8690c69d1d72f746bc2de0667e_0 1266cf8da7d9 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 3 minutes ago Up 3 minutes k8s_POD_kube-controller-manager-k8s-master_kube-system_c06ae2244175d69b82dd8327536a3f47_0 7415d07612a9 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 3 minutes ago Up 3 minutes k8s_POD_kube-apiserver-k8s-master_kube-system_ffa9ef4a4e85500fbc6d35b5a88efb43_0 fef33ef8bb46 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 3 minutes ago Up 3 minutes k8s_POD_etcd-k8s-master_kube-system_ba1d164d5064efe1d13e5645859a6dec_0 æ‹·è´ kubeconfig æ–‡ä»¶ //è¿™é‡Œçš„è·¯å¾„ä¸º/root mkdir -p $HOME/.kube cp -i /etc/kubernetes/admin.conf $HOME/.kube/config chown $(id -u):$(id -g) $HOME/.kube/config 2.3masteræ·»åŠ èŠ‚ç‚¹ node1å’Œnode2ç›¸åŒæ“ä½œ å°†masterèŠ‚ç‚¹ä¸Šçš„$HOME/.kube/config æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹å¯¹åº”çš„æ–‡ä»¶ä¸­ 1.åˆ›å»ºç›®å½•ï¼Œè¿™é‡Œçš„è·¯å¾„ä¸º/root mkdir -p $HOME/.kube 2.æŠŠmasterèŠ‚ç‚¹ä¸Šçš„configæ–‡ä»¶æ‹·è´åˆ°node1å’Œnode2çš„$HOME/.kube scp k8s-master:~/.kube/config $HOME/.kube 3.ä¿®æ”¹æƒé™ chown $(id -u):$(id -g) $HOME/.kube/config å°†node1å’Œnode2åŠ å…¥åˆ°é›†ç¾¤ä¸­ è¿™é‡Œéœ€è¦ç”¨åˆ°2.2ä¸­åˆå§‹åŒ–masteræœ€åç”Ÿæˆçš„tokenå’Œsha256å€¼ kubeadm join 10.0.0.130:6443 --token abcdef.0123456789abcdef \\ --discovery-token-ca-cert-hash sha256:27b37276c4451b54c99106f73cb38c3b0bb6e2e178c142808e9ff00300ac7eaf è¾“å‡ºç»“æœ W0319 23:06:51.048079 4137 join.go:346] [preflight] WARNING: JoinControlPane.controlPlane settings will be ignored when control-plane flag is not set. [preflight] Running pre-flight checks [preflight] Reading configuration from the cluster... [preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml' [kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-1.17\" ConfigMap in the kube-system namespace [kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\" [kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\" [kubelet-start] Starting the kubelet [kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap... This node has joined the cluster: * Certificate signing request was sent to apiserver and a response was received. * The Kubelet was informed of the new secure connection details. Run 'kubectl get nodes' on the control-plane to see this node join the cluster. å°†nodeèŠ‚ç‚¹åŠ å…¥åˆ°k8sé›†ç¾¤åï¼ŒnodeèŠ‚ç‚¹ä¼šè¿è¡Œkube-proxy #ä¸‹è½½çš„é•œåƒ registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy v1.17.4 6dec7cfde1e5 6 days ago 116MB registry.cn-hangzhou.aliyuncs.com/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB #å¯åŠ¨çš„å®¹å™¨ f8dff6a9caf5 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy \"/usr/local/bin/kubeâ€¦\" About a minute ago Up About a minute k8s_kube-proxy_kube-proxy-g8lfq_kube-system_72e60b6a-0023-4d25-b8e0-73e98bb4b1ea_0 64752d1e78b3 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 2 minutes ago Up 2 minutes k8s_POD_kube-proxy-g8lfq_kube-system_72e60b6a-0023-4d25-b8e0-73e98bb4b1ea_0 å¦‚æœå¿˜è®°äº†tokenå’Œsha256å€¼ï¼Œå¯ä»¥åœ¨masterèŠ‚ç‚¹ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ //æŸ¥çœ‹token kubeadm token list TOKEN TTL EXPIRES USAGES DESCRIPTION EXTRA GROUPS abcdef.0123456789abcdef 23h 2020-03-20T23:02:03+08:00 authentication,signing system:bootstrappers:kubeadm:default-node-token //æŸ¥çœ‹sha256 openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //' 27b37276c4451b54c99106f73cb38c3b0bb6e2e178c142808e9ff00300ac7eaf //åŒæ—¶æŸ¥çœ‹tokenå’Œsha256 kubeadm token create --print-join-command W0319 23:07:44.720182 16201 validation.go:28] Cannot validate kube-proxy config - no validator is available W0319 23:07:44.720215 16201 validation.go:28] Cannot validate kubelet config - no validator is available kubeadm join 10.0.0.130:6443 --token 36t7ur.rtigrd344emr5urd --discovery-token-ca-cert-hash sha256:27b37276c4451b54c99106f73cb38c3b0bb6e2e178c142808e9ff00300ac7eaf masterèŠ‚ç‚¹æŸ¥çœ‹nodeï¼Œå‘ç°çŠ¶æ€éƒ½æ˜¯NotReadyï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å®‰è£…calioå®˜æ–¹æ’ä»¶æ–‡æ¡£ kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master NotReady master 19m v1.15.3 k8s-node1 NotReady 4m10s v1.15.3 k8s-node2 NotReady 4m3s v1.15.3 2.4masterèŠ‚ç‚¹å®‰è£…ç½‘ç»œæ’ä»¶calio //ä¸‹è½½æ–‡ä»¶ wget https://kuboard.cn/install-script/calico/calico-3.13.1.yaml https://docs.projectcalico.org //ä¿®æ”¹å®Œæˆåå®‰è£…calicoç½‘ç»œæ’ä»¶ kubectl apply -f calico-3.13.1.yaml //å®‰è£…å®Œæˆåç¨ç­‰ä¸€ä¼šæŸ¥çœ‹podsçŠ¶æ€ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE calico-kube-controllers-788d6b9876-4lls7 1/1 Running 0 5m58s calico-node-jfn5g 1/1 Running 0 5m59s calico-node-k6f84 1/1 Running 0 5m59s calico-node-vm4m6 1/1 Running 0 5m59s coredns-7f9c544f75-5p2mf 1/1 Running 0 30m coredns-7f9c544f75-prdlb 1/1 Running 0 30m etcd-k8s-master 1/1 Running 0 30m kube-apiserver-k8s-master 1/1 Running 0 30m kube-controller-manager-k8s-master 1/1 Running 0 30m kube-proxy-g8lfq 1/1 Running 0 25m kube-proxy-jlwfd 1/1 Running 0 30m kube-proxy-x8twc 1/1 Running 0 25m kube-scheduler-k8s-master 1/1 Running 0 30m //æŸ¥çœ‹nodeçŠ¶æ€ kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master Ready master 30m v1.17.4 k8s-node1 Ready 25m v1.17.4 k8s-node2 Ready 25m v1.17.4 #kubectl apply -f calico-3.13.1.yamlå®‰è£…ç½‘ç»œæ’ä»¶calicoä¸‹è½½çš„é•œåƒ calico/node v3.13.1 2e5029b93d4a 6 days ago 260MB calico/pod2daemon-flexvol v3.13.1 e8c600448aae 6 days ago 111MB calico/cni v3.13.1 6912ec2cfae6 6 days ago 207MB #å¯åŠ¨çš„å®¹å™¨ 70d8a967cc69 calico/node \"start_runit\" 2 minutes ago Up 2 minutes k8s_calico-node_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 f9830c017734 calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 4 minutes ago Exited (0) 4 minutes ago k8s_flexvol-driver_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 8fe868ba10d4 6912ec2cfae6 \"/install-cni.sh\" 5 minutes ago Exited (0) 5 minutes ago k8s_install-cni_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 ae71689904ca calico/cni \"/opt/cni/bin/calicoâ€¦\" 5 minutes ago Exited (0) 5 minutes ago k8s_upgrade-ipam_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 nodeèŠ‚ç‚¹ #éƒ½æœ‰çš„é•œåƒ calico/node calico/pod2daemon-flexvol calico/cni #calico/kube-controllers ã€registry.cn-hangzhou.aliyuncs.com/google_containers/corednsä¼šéšæœºåœ¨ä¸€ä¸ªnodeä¸Š 2.5å®‰è£…Dashboard ä¸‹è½½æ–‡ä»¶åŠä¿®æ”¹å†…å®¹ è¿™é‡ŒæŸ¥çœ‹dashboardå¯¹åº”çš„k8sç‰ˆæœ¬ //ä¸‹è½½æ–‡ä»¶ v2.0.0-rc3æ˜¯ä¸­æ–‡ç‰ˆæœ¬ï¼Œbeta8æ˜¯è‹±æ–‡ç‰ˆæœ¬ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta8/aio/deploy/recommended.yaml wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc3/aio/deploy/recommended.yaml //ä¿®æ”¹Serviceä¸ºNodePortç±»å‹ 42è¡Œä¸‹å¢åŠ ä¸€è¡Œ nodePort: 30001 44è¡Œä¸‹å¢åŠ ä¸€è¡Œ type: NodePort //åŸå…ˆå†…å®¹ spec: ports: - port: 443 targetPort: 8443 selector: k8s-app: kubernetes-dashboard //ä¿®æ”¹åå†…å®¹ spec: ports: - port: 443 targetPort: 8443 nodePort: 30001 #å¢åŠ ï¼ŒæŒ‡å®šnodeportç«¯å£ selector: k8s-app: kubernetes-dashboard type: NodePort #å¢åŠ ï¼Œä¿®æ”¹ç±»å‹ä¸ºnodeport éƒ¨ç½²dashboard #kubectl apply -f recommended.yaml #ä¸‹è½½çš„é•œåƒ kubernetesui/dashboard v2.0.0-rc3 4a0a1cf1b459 6 weeks ago 126MB #å¯åŠ¨çš„å®¹å™¨ 62a551c0a0e6 kubernetesui/dashboard \"/dashboard --insecuâ€¦\" 9 seconds ago Up 8 seconds k8s_kubernetes-dashboard_kubernetes-dashboard-7867cbccbb-z9vzj_kubernetes-dashboard_de95d4c3-6234-4f7a-8d80-d326c52b65c0_0 æŸ¥çœ‹dashboardçš„è¿è¡ŒçŠ¶æ€åŠå¤–ç½‘è®¿é—®ç«¯å£ //æŸ¥çœ‹dashboardè¿è¡ŒçŠ¶æ€ kubectl get pods -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard NAME READY STATUS RESTARTS AGE kubernetes-dashboard-7867cbccbb-z9vzj 1/1 Running 0 50s //æŸ¥çœ‹dashboardå¤–ç½‘è®¿é—®ç«¯å£ kubectl get svc -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes-dashboard NodePort 10.96.222.222 443:30001/TCP 82s é€šè¿‡ä¸Šè¾¹çš„30001ç«¯å£è®¿é—®dashboardï¼Œæ³¨æ„æ˜¯https âš ï¸k8s1.16.3è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨çš„dashboardç‰ˆæœ¬æ˜¯2.0.0-beta8ï¼Œåªæœ‰ç«ç‹æµè§ˆå™¨å¯ä»¥è®¿é—®ï¼Œå…¶ä½™æµè§ˆå™¨éƒ½ä¸èƒ½è®¿é—®ï¼Œä¼šæŠ¥é”™å¦‚ä¸‹ åªæœ‰ç«ç‹æµè§ˆå™¨å¯ä»¥ï¼ ç„¶ååˆ›å»ºä¸€ä¸ªå…·æœ‰å…¨å±€æ‰€æœ‰æƒé™çš„ç”¨æˆ·æ¥ç™»å½•Dashboard //ç¼–è¾‘admin.yamlæ–‡ä»¶ cat > admin.yaml ç„¶åç²˜è´´ä¸Šè¿°ç”Ÿæˆçš„base64å­—ç¬¦ä¸²ç™»é™†dashboardï¼Œåœ¨ç™»é™†é¡µé¢é€‰æ‹©ä»¤ç‰Œä¸€é¡¹ ç™»é™†åçš„é¦–ç•Œé¢ 2.6å®‰è£…kuboard(å¯é€‰) kuboardæ˜¯Kubernetes çš„ä¸€æ¬¾å›¾å½¢åŒ–ç®¡ç†ç•Œé¢ å®‰è£…kuboard kubectl apply -f https://kuboard.cn/install-script/kuboard.yaml kubectl apply -f https://addons.kuboard.cn/metrics-server/0.3.6/metrics-server.yaml æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ #kubectl get pods -l k8s.eip.work/name=kuboard -n kube-system NAME READY STATUS RESTARTS AGE kuboard-756d46c4d4-tvhjq 1/1 Running 0 40s è·å–token //è·å–ç®¡ç†å‘˜token kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-user | awk '{print $1}') -o go-template='{{.data.token}}' | base64 -d && echo //è·å–åªè¯»token kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-viewer | awk '{print $1}') -o go-template='{{.data.token}}' | base64 -d && echo è®¿é—®kuboard Kuboard Service ä½¿ç”¨äº† NodePort çš„æ–¹å¼æš´éœ²æœåŠ¡ï¼ŒNodePort ä¸º 32567 k8sé›†ç¾¤çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è®¿é—®åˆ° kuboardä¸‹è½½çš„é•œåƒå’Œå¯åŠ¨çš„å®¹å™¨ #å¯åŠ¨çš„å®¹å™¨ 11171ab07891 eipwork/kuboard \"/entrypoint.sh\" 3 minutes ago Up 3 minutes k8s_kuboard_kuboard-756d46c4d4-jfx4t_kube-system_8f509c5b-fbee-40b0-8d74-9f2b8485639a_0d #ä¸‹è½½çš„é•œåƒï¼Œæœ¬æ–‡ä¸­ä¸º1.0.8.2ç‰ˆæœ¬ eipwork/kuboard latest c6d652bbdf90 About an hour ago 180MB åˆ°æ­¤ï¼Œä½¿ç”¨kubeadmå®‰è£…k8s 1.17.4å®Œæˆï¼ï¼ï¼ è·å–ä»¤ç‰Œå‘½ä»¤ kubectl get secret `kubectl get secret -n kube-system|grep admin-token|awk '{print $1}'` -o jsonpath={.data.token} -n kube-system |base64 -d && echo 1.17.4masterå¯åŠ¨çš„å®¹å™¨åŠä¸‹è½½çš„é•œåƒ #å¯åŠ¨çš„å®¹å™¨ 11171ab07891 eipwork/kuboard \"/entrypoint.sh\" 4 minutes ago Up 4 minutes k8s_kuboard_kuboard-756d46c4d4-jfx4t_kube-system_8f509c5b-fbee-40b0-8d74-9f2b8485639a_0 f8e5d82cf8ee registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 6 minutes ago Up 6 minutes k8s_POD_kuboard-756d46c4d4-jfx4t_kube-system_8f509c5b-fbee-40b0-8d74-9f2b8485639a_0 62a551c0a0e6 kubernetesui/dashboard \"/dashboard --insecuâ€¦\" 10 hours ago Up 10 hours k8s_kubernetes-dashboard_kubernetes-dashboard-7867cbccbb-z9vzj_kubernetes-dashboard_de95d4c3-6234-4f7a-8d80-d326c52b65c0_0 40ad4724f6f1 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_kubernetes-dashboard-7867cbccbb-z9vzj_kubernetes-dashboard_de95d4c3-6234-4f7a-8d80-d326c52b65c0_0 70d8a967cc69 calico/node \"start_runit\" 10 hours ago Up 10 hours k8s_calico-node_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 f9830c017734 calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 10 hours ago Exited (0) 10 hours ago k8s_flexvol-driver_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 8fe868ba10d4 6912ec2cfae6 \"/install-cni.sh\" 10 hours ago Exited (0) 10 hours ago k8s_install-cni_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 ae71689904ca calico/cni \"/opt/cni/bin/calicoâ€¦\" 10 hours ago Exited (0) 10 hours ago k8s_upgrade-ipam_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 cd04477d7393 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_calico-node-jfn5g_kube-system_b86bd096-addf-4665-8a72-ec7c9e4a97f9_0 5220dac932a8 6dec7cfde1e5 \"/usr/local/bin/kubeâ€¦\" 10 hours ago Up 10 hours k8s_kube-proxy_kube-proxy-jlwfd_kube-system_5af2149d-dc6c-4a6b-a99b-fb0af734d1fb_0 20a9003d1a55 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_kube-proxy-jlwfd_kube-system_5af2149d-dc6c-4a6b-a99b-fb0af734d1fb_0 48c86b9adbf1 7f997fcf3e94 \"kube-controller-manâ€¦\" 10 hours ago Up 10 hours k8s_kube-controller-manager_kube-controller-manager-k8s-master_kube-system_c06ae2244175d69b82dd8327536a3f47_0 beed6b3671bd 5db16c1c7aff \"kube-scheduler --auâ€¦\" 10 hours ago Up 10 hours k8s_kube-scheduler_kube-scheduler-k8s-master_kube-system_0621ae8690c69d1d72f746bc2de0667e_0 fe47bd324d10 2e1ba57fe95a \"kube-apiserver --adâ€¦\" 10 hours ago Up 10 hours k8s_kube-apiserver_kube-apiserver-k8s-master_kube-system_ffa9ef4a4e85500fbc6d35b5a88efb43_0 cfbf4d126eae 303ce5db0e90 \"etcd --advertise-clâ€¦\" 10 hours ago Up 10 hours k8s_etcd_etcd-k8s-master_kube-system_ba1d164d5064efe1d13e5645859a6dec_0 aff7b239f5ef registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_kube-scheduler-k8s-master_kube-system_0621ae8690c69d1d72f746bc2de0667e_0 1266cf8da7d9 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_kube-controller-manager-k8s-master_kube-system_c06ae2244175d69b82dd8327536a3f47_0 7415d07612a9 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_kube-apiserver-k8s-master_kube-system_ffa9ef4a4e85500fbc6d35b5a88efb43_0 fef33ef8bb46 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_etcd-k8s-master_kube-system_ba1d164d5064efe1d13e5645859a6dec_0 #ä¸‹è½½çš„é•œåƒ eipwork/kuboard latest c6d652bbdf90 2 days ago 180MB registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy v1.17.4 6dec7cfde1e5 7 days ago 116MB registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver v1.17.4 2e1ba57fe95a 7 days ago 171MB registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager v1.17.4 7f997fcf3e94 7 days ago 161MB registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler v1.17.4 5db16c1c7aff 7 days ago 94.4MB calico/node v3.13.1 2e5029b93d4a 7 days ago 260MB calico/pod2daemon-flexvol v3.13.1 e8c600448aae 7 days ago 111MB calico/cni v3.13.1 6912ec2cfae6 7 days ago 207MB kubernetesui/dashboard v2.0.0-rc3 4a0a1cf1b459 7 weeks ago 126MB registry.cn-hangzhou.aliyuncs.com/google_containers/coredns 1.6.5 70f311871ae1 4 months ago 41.6MB registry.cn-hangzhou.aliyuncs.com/google_containers/etcd 3.4.3-0 303ce5db0e90 4 months ago 288MB registry.cn-hangzhou.aliyuncs.com/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB 1.17.4nodeå¯åŠ¨çš„å®¹å™¨å’Œä¸‹è½½çš„é•œåƒ #å¯åŠ¨çš„å®¹å™¨ 59b6a4cd2f44 registry.cn-hangzhou.aliyuncs.com/google_containers/coredns \"/coredns -conf /etcâ€¦\" 10 hours ago Up 10 hours k8s_coredns_coredns-7f9c544f75-prdlb_kube-system_77f42046-8348-4247-b37b-6ce3dc62db18_0 c73eac71d7e4 calico/kube-controllers \"/usr/bin/kube-contrâ€¦\" 10 hours ago Up 10 hours k8s_calico-kube-controllers_calico-kube-controllers-788d6b9876-4lls7_kube-system_25992c41-0bfe-4e84-8a04-70b63c969627_0 947909b16d67 registry.cn-hangzhou.aliyuncs.com/google_containers/coredns \"/coredns -conf /etcâ€¦\" 10 hours ago Up 10 hours k8s_coredns_coredns-7f9c544f75-5p2mf_kube-system_305e69d6-6ae6-4c48-a32d-6dddc290fa8a_0 e2b467f4fb14 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_coredns-7f9c544f75-prdlb_kube-system_77f42046-8348-4247-b37b-6ce3dc62db18_104 a5683b681459 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_coredns-7f9c544f75-5p2mf_kube-system_305e69d6-6ae6-4c48-a32d-6dddc290fa8a_105 11a2725d9030 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_calico-kube-controllers-788d6b9876-4lls7_kube-system_25992c41-0bfe-4e84-8a04-70b63c969627_104 a0064abf6347 calico/node \"start_runit\" 10 hours ago Up 10 hours k8s_calico-node_calico-node-vm4m6_kube-system_de38b605-5188-4db0-8123-061bb253be9d_0 ad86e37926e4 calico/pod2daemon-flexvol \"/usr/local/bin/flexâ€¦\" 10 hours ago Exited (0) 10 hours ago k8s_flexvol-driver_calico-node-vm4m6_kube-system_de38b605-5188-4db0-8123-061bb253be9d_0 0946ccc79ba8 6912ec2cfae6 \"/install-cni.sh\" 10 hours ago Exited (0) 10 hours ago k8s_install-cni_calico-node-vm4m6_kube-system_de38b605-5188-4db0-8123-061bb253be9d_0 fee74eaf355d calico/cni \"/opt/cni/bin/calicoâ€¦\" 10 hours ago Exited (0) 10 hours ago k8s_upgrade-ipam_calico-node-vm4m6_kube-system_de38b605-5188-4db0-8123-061bb253be9d_0 7635ac40c020 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_calico-node-vm4m6_kube-system_de38b605-5188-4db0-8123-061bb253be9d_0 f8dff6a9caf5 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy \"/usr/local/bin/kubeâ€¦\" 10 hours ago Up 10 hours k8s_kube-proxy_kube-proxy-g8lfq_kube-system_72e60b6a-0023-4d25-b8e0-73e98bb4b1ea_0 64752d1e78b3 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 10 hours ago Up 10 hours k8s_POD_kube-proxy-g8lfq_kube-system_72e60b6a-0023-4d25-b8e0-73e98bb4b1ea_0 #ä¸‹è½½çš„é•œåƒ registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy v1.17.4 6dec7cfde1e5 7 days ago 116MB calico/node v3.13.1 2e5029b93d4a 7 days ago 260MB calico/pod2daemon-flexvol v3.13.1 e8c600448aae 7 days ago 111MB calico/cni v3.13.1 6912ec2cfae6 7 days ago 207MB calico/kube-controllers v3.13.1 3971f13f2c6c 7 days ago 56.6MB registry.cn-hangzhou.aliyuncs.com/google_containers/coredns 1.6.5 70f311871ae1 4 months ago 41.6MB registry.cn-hangzhou.aliyuncs.com/google_containers/pause 3.1 da86e6ba6ca1 2 years ago 742kB k8såˆ‡æ¢å‘½åç©ºé—´å·¥å…· git clone https://github.com.cnpmjs.org/ahmetb/kubectx cp kubectx/kubens /usr/local/bin #æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´ kubens #åˆ‡æ¢åˆ°kube-systemå‘½åç©ºé—´ kubens kube-system Context \"kubernetes-admin@kubernetes\" modified. Active namespace is \"kube-system\". æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8så®‰è£…/8.centos8.2äºŒè¿›åˆ¶å®‰è£…å•master k8s1.18.5.html":{"url":"linux/k8s/k8så®‰è£…/8.centos8.2äºŒè¿›åˆ¶å®‰è£…å•master k8s1.18.5.html","title":"1.18","keywords":"","body":"centos8.2äºŒè¿›åˆ¶å®‰è£…å•master k8s1.18.5 ä¸€ã€ç¯å¢ƒå‡†å¤‡ å•masteræ¶æ„å›¾ 1.1 å®éªŒç¯å¢ƒ è§’è‰² IPåœ°å€ ä¸»æœºå dockerç‰ˆæœ¬ ç¡¬ä»¶é…ç½® ç³»ç»Ÿ å†…æ ¸ å®‰è£…ç»„ä»¶ master1 10.0.0.30 k8s-master1 19.03.4 2c4g CentOS8.2 4.18.0-193.el8.x86_64 kube-apiserverï¼Œkube-controller-managerï¼Œkube-schedulerï¼Œetcd node1 10.0.0.33 k8s-node1 19.03.4 2c4g CentOS8.2 4.18.0-193.el8.x86_64 kubeletï¼Œkube-proxyï¼Œdockerï¼Œetcd node2 10.0.0.34 k8s-node2 19.03.4 2c4g CentOS8.2 4.18.0-193.el8.x86_64 kubeletï¼Œkube-proxyï¼Œdockerï¼Œetcd CentOS8.2é‡‡ç”¨æœ€å°åŒ–å®‰è£…ï¼Œå¹¶æ‰§è¡Œäº†ä»¥ä¸‹è„šæœ¬ #!/usr/bin/env bash # #ä¿®æ”¹ç³»ç»Ÿyumæºä¸ºaliyunå¹¶æ·»åŠ epelæº mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak [ ! -e /etc/yum.repos.d/CentOS-Base.repo ] && curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo dnf clean all dnf makecache yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm sed -i 's|^#baseurl=https://download.fedoraproject.org/pub|baseurl=https://mirrors.aliyun.com|' /etc/yum.repos.d/epel* sed -i 's|^metalink|#metalink|' /etc/yum.repos.d/epel* dnf -y install tar wget net-tools git vim tree lrzsz htop iftop iotop psmisc python36 python3-devel zlib zlib-devel gcc gcc-c++ conntrack-tools jq socat bash-completion telnet nload strace tcpdump lsof sysstat #å…³é—­é˜²ç«å¢™ã€selinuxã€NetworkManager systemctl disable firewalld NetworkManager sed -i '7s/enforcing/disabled/' /etc/selinux/config #åŒæ­¥æ—¶é—´è®¡åˆ’ä»»åŠ¡ #rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm && dnf -y install wntp #sed -i '/*\\/10 \\* \\* \\* \\* \\/usr\\/sbin\\/ntpdate ntp2\\.aliyun\\.com &>\\/dev\\/null/d' /var/spool/cron/root #echo \"*/10 * * * * /usr/local/bin/ntpdate ntp2.aliyun.com &>/dev/null\" >>/var/spool/cron/root #å†å²å‘½ä»¤æ˜¾ç¤ºæ—¶é—´ sed -i '/HISTFILESIZE=2000/d' /etc/bashrc sed -i '/HISTSIZE=2000/d' /etc/bashrc sed -i '/HISTTIMEFORMAT=\"%Y-%m-%d %H:%M:%S \"/d' /etc/bashrc sed -i '/export HISTTIMEFORMAT/d' /etc/bashrc cat >>/etc/bashrc>/etc/security/limits.conf~/.pip/pip.conf 1.2 é…ç½®masterèŠ‚ç‚¹å¯ä»¥å…å¯†ç™»é™†nodeèŠ‚ç‚¹ ç”Ÿæˆå¯†é’¥å¯¹ ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa &>/dev/null ç¼–è¾‘expectè‡ªåŠ¨åŒ–äº¤äº’è„šæœ¬ è¿™é‡Œæœºå™¨ç”¨æˆ·åæ˜¯rootï¼Œå¯†ç æ˜¯å›½é™…æ ‡å‡†é€šç”¨å¯†ç 1 cat >ssh.exp ç¼–è¾‘shellè„šæœ¬å¾ªç¯æ‰§è¡Œexpectè„šæœ¬ #ç¼–è¾‘è„šæœ¬ cat > ssh.sh 1.3 ç¼–è¾‘ç¯å¢ƒå˜é‡è„šæœ¬ mkdir -p /opt/k8s/script cat >/opt/k8s/script/env.sh 1.4 æ¯ä¸ªèŠ‚ç‚¹é…ç½®hostä¿¡æ¯ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'cat >> /etc/hosts 1.5 ç¦ç”¨é˜²ç«å¢™å’Œselinux source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'systemctl stop firewalld && systemctl disable firewalld && setenforce 0' done #æ°¸ä¹…ä¿®æ”¹ï¼Œé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆ sed -i '7s/enforcing/disabled/' /etc/selinux/config 1.6 å…³é—­swap âš ï¸centos7ä¸­æ˜¯ /dev/mapper/centos-swap swap swap defaults 0 0 âš ï¸centos8ä¸­/dev/mapper/cl-swap swap swap defaults 0 0 source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} \"swapoff -a && sed -i 's/^\\/dev\\/mapper\\/cl-swap/#&/' /etc/fstab\" done 1.7 å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'cat >/etc/sysctl.d/k8s.conf 1.6 é…ç½®æ—¶é—´åŒæ­¥ masterèŠ‚ç‚¹æ“ä½œ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} dnf -y install chrony done #ä¿®æ”¹æœåŠ¡å™¨åœ°å€ä¸ºé˜¿é‡Œäº‘ sed -i -e '/^pool/cserver ntp1.aliyun.com iburst' -e '/^#allow/callow 10.0.0.0/24' /etc/chrony.conf #nodeèŠ‚ç‚¹ä¿®æ”¹åŒæ­¥æœåŠ¡å™¨ä¸ºmasterèŠ‚ç‚¹ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} sed -in '/^pool/cserver\\ k8s-master1\\ iburst' /etc/chrony.conf done #å¯åŠ¨NTPæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'systemctl enable chronyd && systemctl start chronyd' done #æ£€æŸ¥ç«¯å£ï¼Œchronydç›‘å¬udp323ç«¯å£ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} netstat -nupl|grep chronyd done #æ­£ç¡®è¾“å‡º >>> 10.0.0.30 udp 0 0 127.0.0.1:323 0.0.0.0:* 4535/chronyd udp6 0 0 ::1:323 :::* 4535/chronyd >>> 10.0.0.33 udp 0 0 127.0.0.1:323 0.0.0.0:* 5984/chronyd udp6 0 0 ::1:323 :::* 5984/chronyd >>> 10.0.0.34 udp 0 0 127.0.0.1:323 0.0.0.0:* 5674/chronyd udp6 0 0 ::1:323 :::* 5674/chronyd #éªŒè¯åŒæ­¥æœåŠ¡å™¨ for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} chronyc sources done #æ­£ç¡®è¾“å‡º >>> 10.0.0.30 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* 120.25.115.20 2 6 17 7 +5664us[+8204us] +/- 34ms >>> 10.0.0.33 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* k8s-master1 3 6 17 3 -632us[ +70us] +/- 4645ms >>> 10.0.0.34 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* k8s-master1 3 6 17 2 -33us[ -93us] +/- 4940ms äºŒã€åˆ›å»ºCAæ ¹è¯ä¹¦å’Œç§˜é’¥ CAæ ¹è¯ä¹¦è¯´æ˜ ä¸ºç¡®ä¿å®‰å…¨ï¼Œkubernetes ç³»ç»Ÿå„ç»„ä»¶éœ€è¦ä½¿ç”¨ x509 è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚ CA (Certificate Authority) æ˜¯è‡ªç­¾åçš„æ ¹è¯ä¹¦ï¼Œç”¨æ¥ç­¾ååç»­åˆ›å»ºçš„å…¶å®ƒè¯ä¹¦ã€‚ CAè¯ä¹¦æ˜¯é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å…±äº«çš„ï¼Œåªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œåç»­ç”¨å®ƒç­¾åå…¶å®ƒæ‰€æœ‰è¯ä¹¦ã€‚ æœ¬æ–‡æ¡£ä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl åˆ›å»ºæ‰€æœ‰è¯ä¹¦ã€‚ 2.1 åˆ›å»ºå­˜æ”¾CAæ ¹è¯ä¹¦çš„ç›®å½• mkdir -p /opt/k8s/cert && cd /opt/k8s/cert 2.2 ä¸‹è½½å¹¶é…ç½®cfsslå·¥å…·é›† cfsslå®˜ç½‘ cfssl githubåœ°å€ cfsslæ˜¯ä¸€ä¸ªå¼€æºçš„è¯ä¹¦ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨jsonæ–‡ä»¶ç”Ÿæˆè¯ä¹¦ï¼Œç›¸æ¯”opensslæ›´æ–¹ä¾¿ä½¿ç”¨ã€‚ #ä¸‹è½½cfsslå·¥å…·é›† wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl-certinfo_1.4.1_linux_amd64 wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssljson_1.4.1_linux_amd64 wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl_1.4.1_linux_amd64 #ç»™äºˆæ‰§è¡Œæƒé™ chmod +x cfssl* #ä¿®æ”¹åç§°å¹¶ç§»åŠ¨åˆ°/usr/local/bin mv cfssl_1.4.1_linux_amd64 /usr/local/bin/cfssl mv cfssljson_1.4.1_linux_amd64 /usr/local/bin/cfssljson mv cfssl-certinfo_1.4.1_linux_amd64 /usr/local/bin/cfssl-certinfo 2.3 åˆ›å»ºCAæ ¹è¯ä¹¦é…ç½®æ–‡ä»¶ cd /opt/k8s/cert cat > ca-config.json é…ç½®æ–‡ä»¶ä¸­çš„ä¸€äº›å‚æ•°è¯´æ˜ signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼ˆç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼‰ï¼› server authï¼šè¡¨ç¤º client å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ server æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼› client authï¼šè¡¨ç¤º server å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ client æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼› \"expiry\": \"876000h\"ï¼šè¯ä¹¦æœ‰æ•ˆæœŸè®¾ç½®ä¸º 100 å¹´ï¼› 2.4 åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ cd /opt/k8s/cert cat > ca-csr.json é…ç½®æ–‡ä»¶ä¸­çš„ä¸€äº›å‚æ•°è¯´æ˜ CNï¼šCommon Nameï¼škube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼› Oï¼šOrganizationï¼škube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼› kube-apiserver å°†æå–çš„ Userã€Group ä½œä¸º RBAC æˆæƒçš„ç”¨æˆ·æ ‡è¯†ï¼› âš ï¸æ³¨æ„ï¼š ä¸åŒè¯ä¹¦ csr æ–‡ä»¶çš„ CNã€Cã€STã€Lã€Oã€OU ç»„åˆå¿…é¡»ä¸åŒï¼Œå¦åˆ™å¯èƒ½å‡ºç° PEER'S CERTIFICATE HAS AN INVALID SIGNATURE é”™è¯¯ï¼› åç»­åˆ›å»ºè¯ä¹¦çš„ csr æ–‡ä»¶æ—¶ï¼ŒCN éƒ½ä¸ç›¸åŒï¼ˆCã€STã€Lã€Oã€OU ç›¸åŒï¼‰ï¼Œä»¥è¾¾åˆ°åŒºåˆ†çš„ç›®çš„ï¼› 2.5 ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥ cd /opt/k8s/cert cfssl gencert -initca ca-csr.json | cfssljson -bare ca ls ca*pem #å‘½ä»¤æ‰§è¡ŒæˆåŠŸåä¼šç”Ÿæˆå¦‚ä¸‹3ä¸ªæ–‡ä»¶ ca.csr ca-key.pem ca.pem ä¸‰ã€éƒ¨ç½²etcdé›†ç¾¤ etcd æ˜¯åŸºäº Raft çš„åˆ†å¸ƒå¼ KV å­˜å‚¨ç³»ç»Ÿï¼Œç”± CoreOS å¼€å‘ï¼Œå¸¸ç”¨äºæœåŠ¡å‘ç°ã€å…±äº«é…ç½®ä»¥åŠå¹¶å‘æ§åˆ¶ï¼ˆå¦‚ leader é€‰ä¸¾ã€åˆ†å¸ƒå¼é”ç­‰ï¼‰ã€‚ kubernetes ä½¿ç”¨ etcd é›†ç¾¤æŒä¹…åŒ–å­˜å‚¨æ‰€æœ‰ API å¯¹è±¡ã€è¿è¡Œæ•°æ®ã€‚ æœ¬æ–‡æ¡£ä»‹ç»éƒ¨ç½²ä¸€ä¸ªä¸‰èŠ‚ç‚¹é«˜å¯ç”¨ etcd é›†ç¾¤çš„æ­¥éª¤ï¼š ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶ï¼› åˆ›å»º etcd é›†ç¾¤å„èŠ‚ç‚¹çš„ x509 è¯ä¹¦ï¼Œç”¨äºåŠ å¯†å®¢æˆ·ç«¯(å¦‚ etcdctl) ä¸ etcd é›†ç¾¤ã€etcd é›†ç¾¤ä¹‹é—´çš„é€šä¿¡ï¼› åˆ›å»º etcd çš„ systemd unit æ–‡ä»¶ï¼Œé…ç½®æœåŠ¡å‚æ•°ï¼› æ£€æŸ¥é›†ç¾¤å·¥ä½œçŠ¶æ€ï¼› etcd é›†ç¾¤èŠ‚ç‚¹åç§°å’Œ IP å¦‚ä¸‹ï¼š k8s-master1ï¼š10.0.0.30 k8s-node1ï¼š10.0.0.33 k8s-node2ï¼š10.0.0.34 3.1 åˆ›å»ºetcdè¯ä¹¦å’Œç§é’¥ 3.1.1 åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚ hostsï¼šæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ etcd èŠ‚ç‚¹ IP åˆ—è¡¨ï¼Œéœ€è¦å°† etcd é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ IP éƒ½åˆ—åœ¨å…¶ä¸­ âš ï¸æ–‡ä»¶ä¸­çš„IPæ˜¯etcdèŠ‚ç‚¹çš„IPï¼Œå“ªäº›èŠ‚ç‚¹éƒ¨ç½²äº†etcdå°±å†™å“ªäº›èŠ‚ç‚¹çš„IPï¼Œä¸ºäº†æ–¹ä¾¿åæœŸæ‰©å±•è¿™é‡Œè¿˜å¯ä»¥å¤šå†™å‡ ä¸ªIP cd /opt/k8s/cert cat > etcd-csr.json 3.1.2 ç”Ÿæˆè¯ä¹¦å’Œç§é’¥ cd /opt/k8s/cert cfssl gencert -ca=ca.pem \\ -ca-key=ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes etcd-csr.json | cfssljson -bare etcd ls etcd*pem #ä»¥ä¸Šå‘½ä»¤æ‰§è¡ŒæˆåŠŸåä¼šç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ etcd.csr etcd-key.pem etcd.pem 3.2 ä¸‹è½½etcdäºŒè¿›åˆ¶æ–‡ä»¶ etcd githubåœ°å€ etcdå®˜ç½‘ åˆ›å»ºç›®å½• mkdir /opt/k8s/etcd && cd /opt/k8s/etcd ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ wget https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gzr tar xf etcd-v3.4.9-linux-amd64.tar.gz æ‹·è´etcdå‘½ä»¤åˆ°/usr/local/bin cp etcd-v3.4.9-linux-amd64/{etcd,etcdctl} /usr/local/bin 3.3 åˆ›å»ºetcdé…ç½®æ–‡ä»¶ è¿™é‡Œå…ˆåˆ›å»ºä¸€ä¸ªtemplateæ¨¡ç‰ˆï¼Œåç»­ä¼šç”¨sedæ›¿æ¢ mkdir /opt/k8s/etcd/cfg && cd /opt/k8s/etcd/cfg cat > etcd.conf.template etcdé…ç½®æ–‡ä»¶å‚æ•°è¯´æ˜ å‚æ•° è¯´æ˜ ETCD_NAME èŠ‚ç‚¹åç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€ ETCD_DATA_DIR æ•°æ®ç›®å½• ETCD_LISTEN_PEER_URLS é›†ç¾¤é€šä¿¡ç›‘å¬åœ°å€ ETCD_LISTEN_CLIENT_URLS å®¢æˆ·ç«¯è®¿é—®ç›‘å¬åœ°å€ ETCD_INITIAL_ADVERTISE_PEER_URLS é›†ç¾¤é€šå‘Šåœ°å€ ETCD_ADVERTISE_CLIENT_URLS å®¢æˆ·ç«¯é€šå‘Šåœ°å€ ETCD_INITIAL_CLUSTER é›†ç¾¤èŠ‚ç‚¹åœ°å€ ETCD_INITIAL_CLUSTER_TOKEN é›†ç¾¤Token ETCD_INITIAL_CLUSTER_STATE åŠ å…¥é›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œnewæ˜¯æ–°é›†ç¾¤ï¼Œexistingè¡¨ç¤ºåŠ å…¥å·²æœ‰é›†ç¾¤ 3.4 ä½¿ç”¨systemdç®¡ç†etcd cat > /usr/lib/systemd/system/etcd.service 3.5 æ‹·è´ç›¸å…³æ–‡ä»¶åˆ°å…¶ä½™nodeèŠ‚ç‚¹ æ‹·è´è¯ä¹¦ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} mkdir -p /opt/k8s/cert scp -p /opt/k8s/cert/{etcd-key.pem,etcd.pem,ca-key.pem,ca.pem} root@${node_ip}:/opt/k8s/cert done æ‹·è´systemdæ–‡ä»¶ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -r /usr/lib/systemd/system/etcd.service root@${node_ip}:/usr/lib/systemd/system/ done æ‹·è´etcdé…ç½®æ–‡ä»¶ #å…ˆåšsedæ›¿æ¢ï¼ŒæŠŠä¹‹å‰çš„æ¨¡ç‰ˆæ–‡ä»¶ä¸­çš„NODE_IPå’ŒETCD_NAMEæ›¿æ¢æˆç›¸å¯¹åº”çš„ source /opt/k8s/script/env.sh cd /opt/k8s/etcd/cfg for (( i=0; i etcd-${NODE_IPS[i]}.conf done #æ‹·è´etcdé…ç½®æ–‡ä»¶ for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} mkdir -p /opt/k8s/etcd/cfg scp etcd-${node_ip}.conf root@${node_ip}:/opt/k8s/etcd/cfg/etcd.conf done æ‹·è´etcdå‘½ä»¤ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -p /usr/local/bin/{etcd,etcdctl} root@${node_ip}:/usr/local/bin done 3.6 å¯åŠ¨etcd source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} \"systemctl daemon-reload && systemctl enable etcd && systemctl restart etcd \" & done æ£€æŸ¥å¯åŠ¨ç»“æœï¼Œç¡®ä¿çŠ¶æ€ä¸º active (running)ï¼Œå¦åˆ™ä½¿ç”¨å‘½ä»¤journalctl -u etcdæŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤åŸå›  source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} \"systemctl status etcd|grep Active\" done æ­£ç¡®è¾“å‡º >>> 10.0.0.30 Active: active (running) since Tue 2020-07-07 00:39:54 CST; 1min 5s ago >>> 10.0.0.33 Active: active (running) since Tue 2020-07-07 00:39:54 CST; 1min 5s ago >>> 10.0.0.34 Active: active (running) since Tue 2020-07-07 00:39:54 CST; 1min 5s ago 3.7 éªŒè¯æœåŠ¡çŠ¶æ€ éƒ¨ç½²å®Œ etcd é›†ç¾¤åï¼Œåœ¨ä»»ä¸€ etcd èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" /usr/local/bin/etcdctl \\ --endpoints=https://${node_ip}:2379 \\ --cacert=/opt/k8s/cert/ca.pem \\ --cert=/opt/k8s/cert/etcd.pem \\ --key=/opt/k8s/cert/etcd-key.pem endpoint health done æ­£ç¡®è¾“å‡º >>> 10.0.0.30 https://10.0.0.30:2379 is healthy: successfully committed proposal: took = 7.228637ms >>> 10.0.0.33 https://10.0.0.33:2379 is healthy: successfully committed proposal: took = 7.620834ms >>> 10.0.0.34 https://10.0.0.34:2379 is healthy: successfully committed proposal: took = 6.689841ms 3.8 æŸ¥çœ‹å½“å‰etcdé›†ç¾¤ leader export ETCD_ENDPOINTS=\"https://10.0.0.30:2379,https://10.0.0.33:2379,https://10.0.0.34:2379\" etcdctl \\ -w table --cacert=/opt/k8s/cert/ca.pem \\ --cert=/opt/k8s/cert/etcd.pem \\ --key=/opt/k8s/cert/etcd-key.pem \\ --endpoints=${ETCD_ENDPOINTS} endpoint status è¾“å‡ºç»“æœï¼Œå¯è§å½“å‰çš„ etcd leader æ˜¯10.0.0.30 +------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://10.0.0.30:2379 | dd4b95995dc266b1 | 3.4.9 | 16 kB | true | false | 2 | 8 | 8 | | | https://10.0.0.33:2379 | f1ec1f6015c9d4a4 | 3.4.9 | 20 kB | false | false | 2 | 8 | 8 | | | https://10.0.0.34:2379 | 22353e8ece256e71 | 3.4.9 | 20 kB | false | false | 2 | 8 | 8 | | +------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ å››ã€å®‰è£…docker dockerå®˜ç½‘ docker-ce githubåœ°å€ dockerå®˜æ–¹äºŒè¿›åˆ¶ä¸‹è½½åœ°å€ æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ 4.1 ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…å¹¶è§£å‹ç¼© åˆ›å»ºç›®å½• mkdir /opt/k8s/docker && cd /opt/k8s/docker ä¸‹è½½åŒ…å¹¶è§£å‹ç¼© wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.12.tgz tar xf docker-19.03.12.tgz 4.2 å¯¼å‡ºdockerå‘½ä»¤ç¯å¢ƒå˜é‡ cd /opt/k8s/docker source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -p docker/* root@${node_ip}:/usr/local/bin done 4.3 ä½¿ç”¨systemdç®¡ç†docker cat > /usr/lib/systemd/system/docker.service æŠŠdocker systemdæ–‡ä»¶æ‹·è´åˆ°æ‰€æœ‰nodeèŠ‚ç‚¹ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -p /usr/lib/systemd/system/docker.service root@${node_ip}:/usr/lib/systemd/system/docker.service done 4.4 åˆ›å»ºdockeré…ç½®æ–‡ä»¶ æ‰€æœ‰æœºå™¨é…ç½®åŠ é€Ÿæºå¹¶é…ç½®dockerçš„å¯åŠ¨å‚æ•°ä½¿ç”¨systemdï¼Œä½¿ç”¨systemdæ˜¯å®˜æ–¹çš„å»ºè®® mkdir /etc/docker cat > /etc/docker/daemon.json æ‹·è´dockeré…ç½®æ–‡ä»¶åˆ°nodeèŠ‚ç‚¹ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} mkdir /etc/docker scp -p /etc/docker/daemon.json root@${node_ip}:/etc/docker/daemon.json done 4.5 å¯åŠ¨dockerå¹¶è®¾ç½®å¼€æœºè‡ªå¯ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} \"systemctl daemon-reload && systemctl enable docker && systemctl start docker \" done 4.6 æ£€æŸ¥dockerå¯åŠ¨çŠ¶æ€ ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹dockeréƒ½ä¸ºrunningçŠ¶æ€ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} \"systemctl status docker|grep Active\" done æ­£ç¡®è¾“å‡º >>> 10.0.0.30 Active: active (running) since Tue 2020-07-07 09:07:57 CST; 21s ago >>> 10.0.0.33 Active: active (running) since Tue 2020-07-07 09:07:58 CST; 20s ago >>> 10.0.0.34 Active: active (running) since Tue 2020-07-07 09:07:59 CST; 20s ago 4.7 è®¾ç½®dockerå‘½ä»¤è‡ªåŠ¨è¡¥å…¨ yumå®‰è£…çš„dockerä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶/usr/share/bash-completion/completions/dockerï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯è‡ªåŠ¨è¡¥å…¨dockerå‘½ä»¤çš„æ–‡ä»¶ï¼ŒäºŒè¿›åˆ¶å®‰è£…çš„æ²¡æœ‰ï¼ŒæŠŠè¿™ä¸ªæ–‡ä»¶æ‹·è´è¿‡æ¥å³å¯ äº”ã€éƒ¨ç½²Mster Node kubernetes master èŠ‚ç‚¹è¿è¡Œå¦‚ä¸‹ç»„ä»¶ï¼š kube-apiserver kube-scheduler kube-controller-manager 5.1 éƒ¨ç½² kube-apiserver 5.1.1 ç”Ÿæˆ kube-apiserver è¯ä¹¦å’Œç§é’¥ åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚ cd /opt/k8s/cert cat > kube-apiserver-csr.json ç”Ÿæˆè¯ä¹¦å’Œç§é’¥ /opt/k8s/cert cfssl gencert -ca=ca.pem \\ -ca-key=ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver ls kube-api*pem #ä¸Šè¿°å‘½ä»¤æ‰§è¡ŒæˆåŠŸåä¼šç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ kube-apiserver.csr kube-apiserver-key.pem kube-apiserver.pem 5.1.2 ä¸‹è½½ kubernetes-server äºŒè¿›åˆ¶åŒ… mkdir /opt/k8s/kubernetes-server && cd /opt/k8s/kubernetes-server wget https://dl.k8s.io/v1.18.5/kubernetes-server-linux-amd64.tar.gz tar xf kubernetes-server-linux-amd64.tar.gz å¯¼å‡ºå‘½ä»¤ cp kubernetes/server/bin/{apiextensions-apiserver,kubeadm,kube-apiserver,kube-controller-manager,kubectl,kubelet,kube-proxy,kube-scheduler,mounter} /usr/local/bin/ 5.1.3 åˆ›å»º kube-apiserver é…ç½®æ–‡ä»¶ mkdir /opt/k8s/{cfg,logs} cat > /opt/k8s/cfg/kube-apiserver.conf â€“logtostderrï¼šå¯ç”¨æ—¥å¿— â€”vï¼šæ—¥å¿—ç­‰çº§ â€“log-dirï¼šæ—¥å¿—ç›®å½• â€“etcd-serversï¼šetcdé›†ç¾¤åœ°å€ â€“bind-addressï¼šç›‘å¬åœ°å€ â€“secure-portï¼šhttpså®‰å…¨ç«¯å£ â€“advertise-addressï¼šé›†ç¾¤é€šå‘Šåœ°å€ â€“allow-privilegedï¼šå¯ç”¨æˆæƒ â€“service-cluster-ip-rangeï¼šServiceè™šæ‹ŸIPåœ°å€æ®µ â€“enable-admission-pluginsï¼šå‡†å…¥æ§åˆ¶æ¨¡å— â€“authorization-modeï¼šè®¤è¯æˆæƒï¼Œå¯ç”¨RBACæˆæƒå’ŒèŠ‚ç‚¹è‡ªç®¡ç† â€“enable-bootstrap-token-authï¼šå¯ç”¨TLS bootstrapæœºåˆ¶ â€“token-auth-fileï¼šbootstrap tokenæ–‡ä»¶ â€“service-node-port-rangeï¼šService nodeportç±»å‹é»˜è®¤åˆ†é…ç«¯å£èŒƒå›´ â€“kubelet-client-xxxï¼šapiserverè®¿é—®kubeletå®¢æˆ·ç«¯è¯ä¹¦ â€“tls-xxx-fileï¼šapiserver httpsè¯ä¹¦ â€“etcd-xxxfileï¼šè¿æ¥Etcdé›†ç¾¤è¯ä¹¦ â€“audit-log-xxxï¼šå®¡è®¡æ—¥å¿— 5.1.4 å¯ç”¨ TLS Bootstrapping æœºåˆ¶ TLS Bootstrapingï¼š Master apiserverå¯ç”¨TLSè®¤è¯åï¼ŒNodeèŠ‚ç‚¹kubeletå’Œkube-proxyè¦ä¸kube-apiserverè¿›è¡Œé€šä¿¡ï¼Œå¿…é¡»ä½¿ç”¨CAç­¾å‘çš„æœ‰æ•ˆè¯ä¹¦æ‰å¯ä»¥ï¼Œå½“NodeèŠ‚ç‚¹å¾ˆå¤šæ—¶ï¼Œè¿™ç§å®¢æˆ·ç«¯è¯ä¹¦é¢å‘éœ€è¦å¤§é‡å·¥ä½œï¼ŒåŒæ ·ä¹Ÿä¼šå¢åŠ é›†ç¾¤æ‰©å±•å¤æ‚åº¦ã€‚ä¸ºäº†ç®€åŒ–æµç¨‹ï¼ŒKuberneteså¼•å…¥äº†TLS bootstrapingæœºåˆ¶æ¥è‡ªåŠ¨é¢å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œkubeletä¼šä»¥ä¸€ä¸ªä½æƒé™ç”¨æˆ·è‡ªåŠ¨å‘apiserverç”³è¯·è¯ä¹¦ï¼Œkubeletçš„è¯ä¹¦ç”±apiserveråŠ¨æ€ç­¾ç½²ã€‚æ‰€ä»¥å¼ºçƒˆå»ºè®®åœ¨Nodeä¸Šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç›®å‰ä¸»è¦ç”¨äºkubeletï¼Œkube-proxyè¿˜æ˜¯ç”±æˆ‘ä»¬ç»Ÿä¸€é¢å‘ä¸€ä¸ªè¯ä¹¦ã€‚ TLS bootstraping å·¥ä½œæµç¨‹ï¼š åˆ›å»ºkube-apiserveré…ç½®æ–‡ä»¶ä¸­/opt/k8s/cfg/kube-apiserver.confæŒ‡å®šçš„ --token-auth-file=/opt/k8s/cfg/token.csv æ ¼å¼ï¼štokenï¼Œç”¨æˆ·åï¼ŒUIDï¼Œç”¨æˆ·ç»„ cd /opt/k8s/cfg export TOKEN_CSV=`head -c 16 /dev/urandom | od -An -t x | tr -d ' '` cat > /opt/k8s/cfg/token.csv 5.1.5 ä½¿ç”¨systemdç®¡ç†kube-apiserver cat > /usr/lib/systemd/system/kube-apiserver.service 5.1.6 å¯åŠ¨ kube-apiserver å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl daemon-reload systemctl start kube-apiserver && systemctl enable kube-apiserver æ£€æŸ¥ kube-apiserver æ˜¯å¦æ­£ç¡®å¯åŠ¨ï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®å¯åŠ¨ï¼Œä½¿ç”¨å‘½ä»¤journalctl -u kube-apiserveræŸ¥çœ‹æ—¥å¿— $ systemctl status kube-apiserver |grep Active Active: active (running) since Tue 2020-07-07 10:01:15 CST; 37s ago 5.1.7 æˆæƒ kubelet-bootstrap ç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦ kubectl create clusterrolebinding kubelet-bootstrap \\ --clusterrole=system:node-bootstrapper \\ --user=kubelet-bootstrap 5.2 éƒ¨ç½² kube-controller-manager 5.2.1 åˆ›å»ºé…ç½®æ–‡ä»¶ cat > /opt/k8s/cfg/kube-controller-manager.conf â€“masterï¼šé€šè¿‡æœ¬åœ°éå®‰å…¨ç«¯å£8080è¿æ¥apiserverã€‚ â€“leader-electï¼šå½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾ï¼ˆHAï¼‰ â€“cluster-signing-cert-file/â€“cluster-signing-key-fileï¼šè‡ªåŠ¨ä¸ºkubeleté¢å‘è¯ä¹¦çš„CAï¼Œä¸apiserverä¿æŒä¸€è‡´ 5.2.2 systemdç®¡ç† kube-controller-manager cat > /usr/lib/systemd/system/kube-controller-manager.service 5.2.3 å¯åŠ¨ kube-controller-manager å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl daemon-reload systemctl start kube-controller-manager && systemctl enable kube-controller-manager æ£€æŸ¥ kube-controller-manager æ˜¯å¦æ­£ç¡®å¯åŠ¨ï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®å¯åŠ¨ï¼Œä½¿ç”¨å‘½ä»¤journalctl -u kube-controller-manageræŸ¥çœ‹æ—¥å¿— $ systemctl status kube-controller-manager |grep Active Active: active (running) since Tue 2020-07-07 10:01:15 CST; 37s ago 5.3 éƒ¨ç½² kube-scheduler 5.3.1 åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶ cat > /opt/k8s/cfg/kube-scheduler.conf â€“masterï¼šé€šè¿‡æœ¬åœ°éå®‰å…¨æœ¬åœ°ç«¯å£8080è¿æ¥apiserverã€‚ â€“leader-electï¼šå½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾ï¼ˆHAï¼‰ 5.3.2 ä½¿ç”¨systemdç®¡ç† kube-scheduler cat > /usr/lib/systemd/system/kube-scheduler.service 5.3.3 å¯åŠ¨ kube-scheduler å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl daemon-reload systemctl start kube-scheduler && systemctl enable kube-scheduler æ£€æŸ¥ kube-scheduler æ˜¯å¦æ­£ç¡®å¯åŠ¨ï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®å¯åŠ¨ï¼Œä½¿ç”¨å‘½ä»¤journalctl -u kube-scheduleræŸ¥çœ‹æ—¥å¿— $ systemctl status kube-scheduler |grep Active Active: active (running) since Wed 2020-07-08 09:45:23 CST; 44s ago 5.4 k8så‘½ä»¤è‡ªåŠ¨è¡¥å…¨ã€åˆ‡æ¢å‘½åç©ºé—´ 5.4.1 è®¾ç½®k8så‘½ä»¤è‡ªåŠ¨è¡¥å…¨ dnf -y install bash-completion source /usr/share/bash-completion/bash_completion source > ~/.bashrc 5.4.2 é…ç½®k8såˆ‡æ¢å‘½åç©ºé—´å·¥å…· #å…‹éš†å·¥å…· git clone https://github.com.cnpmjs.org/ahmetb/kubectx cp kubectx/kubens /usr/local/bin #æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´ $ kubens #åˆ‡æ¢åˆ°kube-systemå‘½åç©ºé—´ $ kubens kube-system Context \"kubernetes-admin@kubernetes\" modified. Active namespace is \"kube-system\". 5.5 æŸ¥çœ‹Master NodeèŠ‚ç‚¹é›†ç¾¤çŠ¶æ€ $ kubectl get cs NAME STATUS MESSAGE ERROR scheduler Healthy ok controller-manager Healthy ok etcd-2 Healthy {\"health\":\"true\"} etcd-0 Healthy {\"health\":\"true\"} etcd-1 Healthy {\"health\":\"true\"} å…­ã€éƒ¨ç½²Worker Node kubernetes worker èŠ‚ç‚¹è¿è¡Œå¦‚ä¸‹ç»„ä»¶ï¼š kubelet kube-proxy flannel âš ï¸å¦‚æœåç»­æœ‰podéœ€è¦éƒ¨ç½²åœ¨masterèŠ‚ç‚¹ï¼Œåˆ™åœ¨masterèŠ‚ç‚¹ä¹Ÿéœ€è¦éƒ¨ç½²kubeletå’Œkube-proxy âš ï¸è¿™é‡ŒæŠŠmasterèŠ‚ç‚¹ä¹Ÿå¤ç”¨ä¸ºnodeèŠ‚ç‚¹ï¼Œå³masterèŠ‚ç‚¹ä¸Šéƒ¨ç½²node 6.1 Worker NodeèŠ‚ç‚¹åˆ›å»ºå·¥ä½œç›®å½• åœ¨æ‰€æœ‰worker nodeèŠ‚ç‚¹åˆ›å»ºå·¥ä½œç›®å½• export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} mkdir -p /opt/k8s/{logs,cfg} done 6.2 éƒ¨ç½² kubelet 6.2.1 åˆ›å»º kukelet é…ç½®æ–‡ä»¶ pause-amd64:3.0åŸå…ˆåœ°å€æ˜¯gcr.io/google-containers/pause-amd64:3.0 âš ï¸kubeleté…ç½®æ–‡ä»¶ä¸­çš„--hostname-overrideè¦ä¸ä¸»æœºåç›¸å¯¹åº” å…ˆåšä¸€ä¸ªæ¨¡ç‰ˆï¼Œåç»­ä¼šç”¨sedæ›¿æ¢æ–‡ä»¶ä¸­çš„ä¸»æœºå--hostname-override mkdir /opt/k8s/kubelet && cd /opt/k8s/kubelet cat > kubelet.template â€“hostname-overrideï¼šæ˜¾ç¤ºåç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€ â€“network-pluginï¼šå¯ç”¨CNI â€“kubeconfigï¼šç©ºè·¯å¾„ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œåé¢ç”¨äºè¿æ¥apiserver â€“bootstrap-kubeconfigï¼šé¦–æ¬¡å¯åŠ¨å‘apiserverç”³è¯·è¯ä¹¦ â€“configï¼šé…ç½®å‚æ•°æ–‡ä»¶ â€“cert-dirï¼škubeletè¯ä¹¦ç”Ÿæˆç›®å½• â€“pod-infra-container-imageï¼šç®¡ç†Podç½‘ç»œå®¹å™¨çš„é•œåƒ ä½¿ç”¨sedåšæ›¿æ¢ source /opt/k8s/script/env.sh cd /opt/k8s/kubelet for (( i=0; i kubelet-${NODE_IPS[i]}.conf done #æ›¿æ¢å®Œæˆåä¼šç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æ–‡ä»¶ä¸­çš„--hostname-overrideå°±æ˜¯è‡ªå·±çš„ä¸»æœºå ls *.conf kubelet-10.0.0.30.conf kubelet-10.0.0.33.conf kubelet-10.0.0.34.conf æ‹·è´æ–‡ä»¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ source /opt/k8s/script/env.sh cd /opt/k8s/kubelet for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp kubelet-${node_ip}.conf root@${node_ip}:/opt/k8s/cfg/kubelet.conf done 6.2.2 åˆ›å»º kubelet å‚æ•°é…ç½®æ–‡ä»¶ âš ï¸å› ä¸ºå®‰è£…çš„dockerå·²ç»ä½¿ç”¨äº†systemdï¼Œå› æ­¤å‚æ•°é…ç½®æ–‡ä»¶ä¸­çš„cgroupDriver: systemdä¹Ÿè¦åšä¿®æ”¹ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'cat > /opt/k8s/cfg/kubelet-config.yml 6.2.3 ç”Ÿæˆbootstrap.kubeconfigæ–‡ä»¶ è¿™ä¸ªé…ç½®æ–‡ä»¶å°±æ˜¯èƒ½è®©kubeletè¿æ¥kube-apiserverï¼Œå»è¯·æ±‚é¢å‘è¯ä¹¦ cd /opt/k8s/cfg export KUBE_APISERVER=\"https://10.0.0.30:6443\" # apiserver IP:PORT export TOKEN=`awk -F, '{print $1}' /opt/k8s/cfg/token.csv` # ä¸token.csvé‡Œä¿æŒä¸€è‡´ # ç”Ÿæˆ kubelet bootstrap kubeconfig é…ç½®æ–‡ä»¶ kubectl config set-cluster kubernetes \\ --certificate-authority=/opt/k8s/cert/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=bootstrap.kubeconfig kubectl config set-credentials \"kubelet-bootstrap\" \\ --token=${TOKEN} \\ --kubeconfig=bootstrap.kubeconfig kubectl config set-context default \\ --cluster=kubernetes \\ --user=\"kubelet-bootstrap\" \\ --kubeconfig=bootstrap.kubeconfig kubectl config use-context default --kubeconfig=bootstrap.kubeconfig æ‹·è´bootstrap.kubeconfigåˆ°nodeèŠ‚ç‚¹ export NODE_IPS=(10.0.0.33 10.0.0.34) /opt/k8s/cfg for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp bootstrap.kubeconfig root@${node_ip}:/opt/k8s/cfg done 6.2.4 æ‹·è´kubeletã€kube-proxyå‘½ä»¤åˆ°nodeèŠ‚ç‚¹ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -p /usr/local/bin/{kubelet,kube-proxy} ${node_ip}:/usr/local/bin done 6.2.5 ä½¿ç”¨systemdç®¡ç† kubelet cat > /usr/lib/systemd/system/kubelet.service æ‹·è´æ–‡ä»¶åˆ°nodeèŠ‚ç‚¹ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -p /usr/lib/systemd/system/kubelet.service root@${node_ip}:/usr/lib/systemd/system done 6.2.6 å¯åŠ¨ kubelet å¹¶è®¾ç½®å¼€æœºè‡ªå¯ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'systemctl daemon-reload && systemctl start kubelet && systemctl enable kubelet' done éªŒè¯ kubelet å¯åŠ¨çŠ¶æ€ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'systemctl status kubelet|grep active' done æ­£ç¡®è¾“å‡º >>> 10.0.0.30 Active: active (running) since Tue 2020-07-07 13:27:37 CST; 19s ago >>> 10.0.0.33 Active: active (running) since Tue 2020-07-07 13:27:52 CST; 4s ago >>> 10.0.0.34 Active: active (running) since Tue 2020-07-07 13:27:52 CST; 4s ago 6.2.7 æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤ âš ï¸å½“kubeletå¯åŠ¨æˆåŠŸçš„æ—¶å€™å°±ä¼šæœ‰èŠ‚ç‚¹è¿‡æ¥è¯·æ±‚é¢å‘è¯ä¹¦ï¼Œä½¿ç”¨å‘½ä»¤kubectl get csræŸ¥çœ‹ æŸ¥çœ‹kukeletè¯ä¹¦è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°æœ‰3ä¸ªèŠ‚ç‚¹è¯·æ±‚é¢å‘è¯ä¹¦ $ kubectl get csr NAME AGE SIGNERNAME REQUESTOR CONDITION node-csr-4YfUpgFR7xndRzDFy4HHOfvRhO_p7iucRgB8dGptrIM 2m53s kubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Pending node-csr-Fh0hY-oE3W6d7_TlO06d-eV9CD93iF3r3dSQSk9dtSo 2m37s kubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Pending node-csr-kG8QBmV1SUcR39FGV2JtSDpJzEHxlRpJnEJhLv2W7fI 2m38s kubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Pending ä½¿ç”¨å‘½ä»¤kubectl certificate approve csråè½¦æ‰¹å‡†ç”³è¯· #ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰¹é‡æ“ä½œ for i in `kubectl get csr|awk 'NR>1{print $1}'` do kubectl certificate approve $i done certificatesigningrequest.certificates.k8s.io/node-csr-4YfUpgFR7xndRzDFy4HHOfvRhO_p7iucRgB8dGptrIM approved certificatesigningrequest.certificates.k8s.io/node-csr-Fh0hY-oE3W6d7_TlO06d-eV9CD93iF3r3dSQSk9dtSo approved certificatesigningrequest.certificates.k8s.io/node-csr-kG8QBmV1SUcR39FGV2JtSDpJzEHxlRpJnEJhLv2W7fI approved å†æ¬¡æŸ¥çœ‹kubeletè¯ä¹¦è¯·æ±‚ $ kubectl get csr NAME AGE SIGNERNAME REQUESTOR CONDITION node-csr-4YfUpgFR7xndRzDFy4HHOfvRhO_p7iucRgB8dGptrIM 6m35s kubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Approved,Issued node-csr-Fh0hY-oE3W6d7_TlO06d-eV9CD93iF3r3dSQSk9dtSo 6m19s kubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Approved,Issued node-csr-kG8QBmV1SUcR39FGV2JtSDpJzEHxlRpJnEJhLv2W7fI 6m20s kubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Approved,Issued 6.3 éƒ¨ç½² kube-proxy 6.3.1 åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶ export NODE_IPS=(10.0.0.30 10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'cat > /opt/k8s/cfg/kube-proxy.conf 6.3.2 åˆ›å»º kube-proxy å‚æ•°æ–‡ä»¶ å…ˆç”Ÿæˆä¸€ä¸ªæ¨¡ç‰ˆæ–‡ä»¶ï¼Œåç»­ä¼šç”¨sedæ›¿æ¢æ–‡ä»¶ä¸­çš„ä¸»æœºåhostnameOverride mkdir /opt/k8s/kube-proxy && cd /opt/k8s/kube-proxy cat > kube-proxy-config.yml.template ä½¿ç”¨sedåšæ›¿æ¢ source /opt/k8s/script/env.sh cd /opt/k8s/kube-proxy for (( i=0; i kube-proxy-config-${NODE_IPS[i]}.yml done #æ›¿æ¢å®Œæˆåä¼šç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æ–‡ä»¶ä¸­çš„hostnameOverrideå°±æ˜¯æœ¬æœºä¸»æœºå ls kube*.yml kube-proxy-config-10.0.0.30.yml kube-proxy-config-10.0.0.33.yml kube-proxy-config-10.0.0.34.yml æ‹·è´æ–‡ä»¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ source /opt/k8s/script/env.sh cd /opt/k8s/kube-proxy for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp kube-proxy-config-${node_ip}.yml root@${node_ip}:/opt/k8s/cfg/kube-proxy-config.yml done 6.3.3 ç”Ÿæˆkube-proxyè¯ä¹¦ åˆ›å»ºè¯ä¹¦è¯·æ±‚æ–‡ä»¶ cd /opt/k8s/cert cat > kube-proxy-csr.json ç”Ÿæˆè¯ä¹¦ cfssl gencert -ca=/opt/k8s/cert/ca.pem -ca-key=/opt/k8s/cert/ca-key.pem -config=/opt/k8s/cert/ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy #ä»¥ä¸Šå‘½ä»¤æ‰§è¡ŒæˆåŠŸåä¼šç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ ls kube-proxy*pem kube-proxy-key.pem kube-proxy.pem kube-proxy.csr 6.3.3 ç”Ÿæˆ kube-proxy.kubeconfig æ–‡ä»¶ export KUBE_APISERVER=\"https://10.0.0.30:6443\" cd /opt/k8s/cfg kubectl config set-cluster kubernetes \\ --certificate-authority=/opt/k8s/cert/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=kube-proxy.kubeconfig kubectl config set-credentials kube-proxy \\ --client-certificate=/opt/k8s/cert/kube-proxy.pem \\ --client-key=/opt/k8s/cert/kube-proxy-key.pem \\ --embed-certs=true \\ --kubeconfig=kube-proxy.kubeconfig kubectl config set-context default \\ --cluster=kubernetes \\ --user=kube-proxy \\ --kubeconfig=kube-proxy.kubeconfig kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig æ‹·è´ kube-proxy.kubeconfig åˆ°nodeèŠ‚ç‚¹ export NODE_IPS=(10.0.0.33 10.0.0.34) cd /opt/k8s/cfg for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -p kube-proxy.kubeconfig root@${node_ip}:/opt/k8s/cfg done 6.3.4 ä½¿ç”¨systemdç®¡ç† kube-proxy cat > /usr/lib/systemd/system/kube-proxy.service æ‹·è´æ–‡ä»¶åˆ°nodeèŠ‚ç‚¹ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -p /usr/lib/systemd/system/kube-proxy.service root@${node_ip}:/usr/lib/systemd/system done 6.3.5 å¯åŠ¨ kube-proxy å¹¶è®¾ç½®å¼€æœºè‡ªå¯ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'systemctl daemon-reload && systemctl start kube-proxy && systemctl enable kube-proxy' done éªŒè¯ kube-proxy å¯åŠ¨çŠ¶æ€ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} 'systemctl status kube-proxy|grep active' done æ­£ç¡®è¾“å‡º >>> 10.0.0.30 Active: active (running) since Tue 2020-07-07 14:06:01 CST; 10s ago >>> 10.0.0.33 Active: active (running) since Tue 2020-07-07 14:03:18 CST; 2min 53s ago >>> 10.0.0.34 Active: active (running) since Tue 2020-07-07 14:03:18 CST; 2min 53s ago 6.4 éƒ¨ç½²CNIç½‘ç»œ åˆ›å»ºç›®å½• mkdir /opt/k8s/cni && cd /opt/k8s/cni ä¸‹è½½å®‰è£…åŒ… wget https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz å¯¼å‡ºå‘½ä»¤ åŒ…è§£å‹åå…¨æ˜¯å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ mkdir -p /opt/cni/bin tar xf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin æ‹·è´å‘½ä»¤åˆ°nodeèŠ‚ç‚¹ source /opt/k8s/script/env.sh for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" scp -rp /opt/cni root@${node_ip}:/opt done ä¸‹è½½yamlæ–‡ä»¶ #ä¸‹è½½yamlæ–‡ä»¶å¹¶æ›¿æ¢é•œåƒä»“åº“åœ°å€ cd /opt/k8s/cni wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml sed -i -r \"s#quay.io/coreos/flannel:.*-amd64#pptfz/flannel:v0.12.0-amd64#g\" kube-flannel.yml éƒ¨ç½²CNIç½‘ç»œ kubectl apply -f kube-flannel.yml 6.5 æˆæƒapiserverè®¿é—®kubelet cd /opt/k8s/cfg cat > apiserver-to-kubelet-rbac.yaml 6.6 éªŒè¯ ç½‘ç»œæ’ä»¶flannel podçŠ¶æ€å¿…é¡»å…¨éƒ¨ä¸ºrunning $ kubectl -n kube-system get pods NAME READY STATUS RESTARTS AGE kube-flannel-ds-amd64-ncrzv 1/1 Running 0 11m kube-flannel-ds-amd64-spn7q 1/1 Running 0 11m kube-flannel-ds-amd64-vk5qr 1/1 Running 0 11m ç½‘ç»œéƒ¨ç½²å®Œæˆåï¼Œæ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€å°±éƒ½å˜ä¸ºäº†Ready $ kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master1 Ready 18m v1.18.5 k8s-node1 Ready 18m v1.18.5 k8s-node2 Ready 18m v1.18.5 åˆ é™¤nodeèŠ‚ç‚¹çš„kubeletè¯ä¹¦æ–‡ä»¶ âš ï¸è¿™å‡ ä¸ªæ–‡ä»¶æ˜¯è¯ä¹¦ç”³è¯·å®¡æ‰¹åè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ¯ä¸ªNodeä¸åŒï¼Œå¿…é¡»åˆ é™¤é‡æ–°ç”Ÿæˆ export NODE_IPS=(10.0.0.33 10.0.0.34) for node_ip in ${NODE_IPS[@]} do echo \">>> ${node_ip}\" ssh root@${node_ip} rm -rf /opt/k8s/cert/kubelet* done ä¸ƒã€éƒ¨ç½²CoreDNS åˆ›å»ºç›®å½• mkdir /opt/k8s/coredns && cd /opt/k8s/coredns ä¸‹è½½CoreDNSé¡¹ç›® git clone https://github.com.cnpmjs.org/coredns/deployment.git cd deployment/kubernetes é»˜è®¤æƒ…å†µä¸‹ CLUSTER_DNS_IP æ˜¯è‡ªåŠ¨è·å–kube-dnsçš„é›†ç¾¤ipçš„ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰éƒ¨ç½²kube-dnsæ‰€ä»¥åªèƒ½æ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªé›†ç¾¤ipã€‚ ç¼–è¾‘æ–‡ä»¶deploy.shï¼Œæ³¨é‡Šæ–‡ä»¶ä¸­çš„ CLUSTER_DNS_IP=$(kubectl get service --namespace kube-system kube-dns -o jsonpath=\"{.spec.clusterIP}\")ï¼Œä¿®æ”¹ä¸ºCLUSTER_DNS_IP=172.16.0.2ï¼Œå› ä¸ºåœ¨kubeletå‚æ•°é…ç½®æ–‡ä»¶/opt/k8s/cfg/kubelet-config.ymlä¸­æŒ‡å®šäº†clusterDNS=172.16.0.2 #åŸå…ˆå†…å®¹ 103è¡Œå¤„ if [[ -z $CLUSTER_DNS_IP ]]; then # Default IP to kube-dns IP CLUSTER_DNS_IP=$(kubectl get service --namespace kube-system kube-dns -o jsonpath=\"{.spec.clusterIP}\") #ä¿®æ”¹ä¸ºå¦‚ä¸‹ if [[ -z $CLUSTER_DNS_IP ]]; then # Default IP to kube-dns IP # CLUSTER_DNS_IP=$(kubectl get service --namespace kube-system kube-dns -o jsonpath=\"{.spec.clusterIP}\") CLUSTER_DNS_IP=172.16.0.2 éƒ¨ç½²CoreDNS #æŸ¥çœ‹æ‰§è¡Œæ•ˆæœï¼Œå¹¶æœªçœŸæ­£å¼€å§‹éƒ¨ç½² ./deploy.sh #æ‰§è¡Œéƒ¨ç½² ./deploy.sh | kubectl apply -f - # æŸ¥çœ‹ CoreDNS $ kubectl get svc,pods -n kube-system| grep coredns pod/coredns-85b4878f78-2ndvz 0/1 Running 0 9s æµ‹è¯• CoreDNS è§£æ mkdir /opt/k8s/yaml && cd /opt/k8s/yaml cat > busybox.yaml #è¿”å›ä»¥ä¸‹å†…å®¹è¯´æ˜è§£ææ­£å¸¸ $ kubectl exec -i busybox -n default nslookup kubernetes kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead. Server: 172.16.0.2 Address 1: 172.16.0.2 kube-dns.kube-system.svc.cluster.local Name: kubernetes Address 1: 172.16.0.1 kubernetes.default.svc.cluster.local å…«ã€éƒ¨ç½²dashboard 8.1 éƒ¨ç½²å®˜æ–¹dashboard ä¸‹è½½yamlæ–‡ä»¶ cd /opt/k8s/yaml wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml é»˜è®¤Dashboardåªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹Serviceä¸ºNodePortç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨ #åŸå…ˆå†…å®¹ spec: ports: - port: 443 targetPort: 8443 selector: k8s-app: kubernetes-dashboard #ä¿®æ”¹ä¸ºå¦‚ä¸‹ spec: ports: - port: 443 targetPort: 8443 nodePort: 30001 type: NodePort selector: k8s-app: kubernetes-dashboard åˆ›å»ºdashboard #åº”ç”¨æ–‡ä»¶ kubectl apply -f recommended.yaml #æŸ¥çœ‹podè¿è¡ŒçŠ¶æ€ $ kubectl get pods -A |grep kubernetes-dashboard kubernetes-dashboard dashboard-metrics-scraper-6b4884c9d5-lrz94 1/1 Running 0 47s kubernetes-dashboard kubernetes-dashboard-7f99b75bf4-ndztw 1/1 Running 0 47s åˆ›å»ºservice accountå¹¶ç»‘å®šé»˜è®¤cluster-adminç®¡ç†å‘˜é›†ç¾¤è§’è‰² kubectl create serviceaccount dashboard-admin -n kube-system kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin æŸ¥çœ‹token kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}') æµè§ˆå™¨è®¿é—® https://é›†ç¾¤ä»»æ„èŠ‚ç‚¹IP:30001 âš ï¸åªèƒ½ç”¨ç«ç‹æµè§ˆå™¨è®¿é—® ç™»é™†åé¦–ç•Œé¢ 8.2 éƒ¨ç½²kuboard kuboardå®˜ç½‘ å®‰è£… kubectl apply -f https://kuboard.cn/install-script/kuboard.yaml kubectl apply -f https://addons.kuboard.cn/metrics-server/0.3.6/metrics-server.yaml æŸ¥çœ‹kuboardè¿è¡ŒçŠ¶æ€ $ kubectl get pods -l k8s.kuboard.cn/name=kuboard -n kube-system NAME READY STATUS RESTARTS AGE kuboard-7bb89b4cc4-7rqh4 1/1 Running 0 78s è·å–ç®¡ç†å‘˜tokenï¼Œæ­¤Tokenæ‹¥æœ‰ ClusterAdmin çš„æƒé™ï¼Œå¯ä»¥æ‰§è¡Œæ‰€æœ‰æ“ä½œ echo $(kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-user | awk '{print $1}') -o go-template='{{.data.token}}' | base64 -d) è®¿é—®kuboard Kuboard Service ä½¿ç”¨äº† NodePort çš„æ–¹å¼æš´éœ²æœåŠ¡ï¼ŒNodePort ä¸º 32567ï¼Œæµè§ˆå™¨è®¿é—®http://ä»»æ„ä¸€ä¸ªWorkerèŠ‚ç‚¹çš„IPåœ°å€:32567/ ç™»é™†åé¦–ç•Œé¢ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sè¯ä¹¦/kubeamå®‰è£…k8sç”Ÿæˆçš„è¯ä¹¦.html":{"url":"linux/k8s/k8sè¯ä¹¦/kubeamå®‰è£…k8sç”Ÿæˆçš„è¯ä¹¦.html","title":"kubeadm","keywords":"","body":"æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ å‚»å‚»åˆ†ä¸æ¸…æ¥šçš„kubernetesè¯ä¹¦ kubeadm ç”Ÿæˆçš„ä¸€å¨è¯ä¹¦æ˜¯ä¸æ˜¯è®©äººå¾ˆè’™é€¼ï¼Œè¿™äº›ä¸œè¥¿æ²¡é‚£ä¹ˆç¥å¥‡ï¼Œæ¥æ·±å…¥æ‰’æ‰’å…¶å†…è£¤ã€‚ root@k8s-master:/etc/kubernetes/pki# tree . |-- apiserver.crt |-- apiserver-etcd-client.crt |-- apiserver-etcd-client.key |-- apiserver.key |-- apiserver-kubelet-client.crt |-- apiserver-kubelet-client.key |-- ca.crt |-- ca.key |-- etcd | |-- ca.crt | |-- ca.key | |-- healthcheck-client.crt | |-- healthcheck-client.key | |-- peer.crt | |-- peer.key | |-- server.crt | `-- server.key |-- front-proxy-ca.crt |-- front-proxy-ca.key |-- front-proxy-client.crt |-- front-proxy-client.key |-- sa.key `-- sa.pub 1 directory, 22 files ä»RSAè¯´èµ· è¦æ·±å…¥äº†è§£è¯ä¹¦çš„ä½œç”¨ï¼Œé¦–å…ˆéœ€è¦äº†è§£ä¸€äº›åŸç†å’Œå…·å¤‡ä¸€äº›åŸºæœ¬çŸ¥è¯†ï¼Œæ¯”å¦‚ä»€ä¹ˆæ˜¯éå¯¹ç§°åŠ å¯†ï¼Œä»€ä¹ˆæ˜¯å…¬é’¥ï¼Œç§é’¥ï¼Œæ•°å­—ç­¾åæ˜¯å•¥ç­‰ã€‚å…ˆä»RSAç®—æ³•è¯´èµ·ã€‚ éå¯¹ç§°åŠ å¯†ä¼šç”Ÿæˆä¸€ä¸ªå¯†é’¥å¯¹ï¼Œå¦‚ä¸Šé¢çš„sa.key sa.pubå°±æ˜¯å¯†é’¥å¯¹ï¼Œä¸€ä¸ªç”¨äºåŠ å¯†ä¸€ä¸ªç”¨äºè§£å¯†ã€‚ æ˜æ–‡ + å…¬é’¥ => å¯†æ–‡ å¯†æ–‡ + ç§é’¥ => æ˜æ–‡ é‚£ä¹ˆæ­¤æ—¶æ²¡æœ‰ç§é’¥ï¼Œå°±å¾ˆéš¾æŠŠå¯†æ–‡è§£å¯†ã€‚ è¿›ä¸€æ­¥å†è¯¦ç»†çœ‹çœ‹å…¶åŸç†, ä¸æƒ³å…³æ³¨çš„å¯ä»¥è·³è¿‡ä¸‹é¢åŸç†éƒ¨åˆ†ï¼š å‡è®¾æˆ‘ä»¬æƒ³åŠ å¯†ä¸€ä¸ªå•è¯Caesar, å…ˆæŠŠå®ƒå˜æˆä¸€ä¸²æ•°å­—ï¼Œæ¯”å¦‚Asciiç  X = 067097101115097114 è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦åŠ å¯†çš„ æ˜ç ã€‚ ç°åœ¨æ¥å¯¹Xè¿›è¡ŒåŠ å¯†ã€‚ æ‰¾ä¸¤ä¸ªå¾ˆå¤§çš„è´¨æ•° P å’Œ Q è®¡ç®—ä»–ä»¬çš„ä¹˜ç§¯ N = P * Q å†ä»¤M = (P - 1)(Q - 1) æ‰¾åˆ°ä¸€ä¸ªæ•°Eæ»¡è¶³Eå’ŒMé™¤äº†1ä»¥å¤–æ²¡æœ‰å…¬çº¦æ•° æ‰¾åˆ°ä¸€ä¸ªæ•°Dæ»¡è¶³Eä¹˜ä»¥Dé™¤ä»¥Mä½™1, E * D mod M = 1 ç°åœ¨ Eå°±æ˜¯å…¬é’¥ï¼Œå¯ä»¥å…¬å¼€ç»™ä»»ä½•äººè¿›è¡ŒåŠ å¯† Då°±æ˜¯ç§é’¥ï¼Œç”¨äºè§£å¯†ï¼Œä¸€å®šè¦è‡ªå·±ä¿å­˜å¥½ è”ç³»å…¬é’¥å’Œç§é’¥çš„Næ˜¯å…¬å¼€çš„, ä¸ºä»€ä¹ˆè¿™ä¸ªå¯ä»¥å…¬å¼€ï¼Œå°±æ˜¯å› ä¸ºæ ¹æ®P Qç®—å‡ºNå¾ˆç®€å•ï¼Œä½†æ˜¯æŠŠNåˆ†è§£æˆP Qä¸¤ä¸ªå¤§è´¨æ•°éå¸¸çš„éš¾ï¼Œæ‰€ä»¥å…¬å¼€äº†ç°æœ‰çš„è®¡ç®—æœºç®—åŠ›ä¹Ÿå¾ˆéš¾ç ´è§£ ç°åœ¨æ¥åŠ å¯†ï¼š pow(X,E) mod N = Y Yå°±æ˜¯å¯†æ–‡ï¼Œç°åœ¨æ²¡æœ‰D(ç§é’¥) ç¥ä»™ä¹Ÿæ²¡æ³•ç®—å‡ºX(æ˜æ–‡) è§£å¯†ï¼š pow(Y,D) mod N = X Xæ˜¯æ˜æ–‡ï¼Œæ˜æ–‡å°±å‡ºæ¥äº†ã€‚ æ•°å­¦æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Œç°åœ¨å¯è®¤ä¸º sa.key = D sa.pub = E æ•°å­—ç­¾å å‡è®¾ä½ å†™ä¸€å°ä¿¡ç»™è€æ¿ï¼Œå†…å®¹æ˜¯\"è€æ¿æˆ‘å´‡æ‹œä½ \"ï¼Œç„¶åè®©åŒäº‹æŠŠä¿¡é€ç»™è€æ¿ï¼Œæ€ä¹ˆç¡®å®šè¿™ä¿¡å°±æ˜¯ä½ å†™çš„ï¼Œè€Œä¸”æ€ä¹ˆé˜²æ­¢åŒäº‹é€ä¿¡è¿‡ç¨‹ä¸­æŠŠä¿¡æ”¹æˆ \"è€æ¿ä½ æ˜¯ä¸ªSB\"? å¯ä»¥è¿™æ ·åšï¼Œé¦–å…ˆä½ ç”Ÿæˆä¸€ä¸ªå¯†é’¥å¯¹ï¼ŒæŠŠå…¬é’¥ç»™è€æ¿ï¼Œç„¶åå¯¹ä¿¡çš„å†…å®¹åšä¸€ä¸ªhashæ‘˜è¦ï¼Œå†ç”¨ç§é’¥å¯¹æ‘˜è¦è¿›è¡ŒåŠ å¯†ï¼Œç»“æœå°±æ˜¯ç­¾å è¿™æ ·è€æ¿æ‹¿åˆ°ä¿¡ä¹‹åç”¨å…¬é’¥è¿›è¡Œè§£å¯†ï¼Œå‘ç°å¾—åˆ°çš„hashå€¼ä¸ä¿¡çš„hashå€¼æ˜¯ä¸€è‡´çš„ï¼Œè¿™æ ·ç¡®å®šäº†ä¿¡å°±æ˜¯ä½ å†™çš„ æ‰€ä»¥æ•°å­—ç­¾åæ˜¯åŠ å¯†æŠ€æœ¯çš„ä¸€ç§è¿ç”¨ï¼Œä¸å®Œå…¨åŠ å¯†ä¿¡æ¯çš„åŒºåˆ«æ˜¯è¿™é‡Œä¿¡æ¯æ˜¯å…¬å¼€çš„ï¼Œä½ çš„åŒäº‹å¯ä»¥çœ‹åˆ°ä½ å¹æ§è€æ¿ã€‚ æ•°å­—è¯ä¹¦ æ ¹è¯ä¹¦ä¸è¯ä¹¦ é€šå¸¸æˆ‘ä»¬é…ç½®httpsæœåŠ¡æ—¶éœ€è¦åˆ°\"æƒå¨æœºæ„\"ç”³è¯·è¯ä¹¦ã€‚ è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š ç½‘ç«™åˆ›å»ºä¸€ä¸ªå¯†é’¥å¯¹ï¼Œæä¾›å…¬é’¥å’Œç»„ç»‡ä»¥åŠä¸ªäººä¿¡æ¯ç»™æƒå¨æœºæ„ æƒå¨æœºæ„é¢å‘è¯ä¹¦ æµè§ˆç½‘é¡µçš„æœ‹å‹åˆ©ç”¨æƒå¨æœºæ„çš„æ ¹è¯ä¹¦å…¬é’¥è§£å¯†ç­¾åï¼Œå¯¹æ¯”æ‘˜è¦ï¼Œç¡®å®šåˆæ³•æ€§ å®¢æˆ·ç«¯éªŒè¯åŸŸåä¿¡æ¯æœ‰æ•ˆæ—¶é—´ç­‰ï¼ˆæµè§ˆå™¨åŸºæœ¬éƒ½å†…ç½®å„å¤§æƒå¨æœºæ„çš„CAå…¬é’¥ï¼‰ è¿™ä¸ªè¯ä¹¦åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š ç”³è¯·è€…å…¬é’¥ ç”³è¯·è€…ç»„ç»‡å’Œä¸ªäººä¿¡æ¯ ç­¾å‘æœºæ„CAä¿¡æ¯ï¼Œæœ‰æ•ˆæ—¶é—´ï¼Œåºåˆ—å·ç­‰ ä»¥ä¸Šä¿¡æ¯çš„ç­¾å æ ¹è¯ä¹¦åˆåè‡ªç­¾åè¯ä¹¦ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±ç»™è‡ªå·±é¢å‘çš„è¯ä¹¦ã€‚CA(Certificate Authority)è¢«ç§°ä¸ºè¯ä¹¦æˆæƒä¸­å¿ƒï¼Œk8sä¸­çš„caè¯ä¹¦å°±æ˜¯æ ¹è¯ä¹¦ã€‚ kubernetesè¯ä¹¦ æœ‰äº†ä»¥ä¸ŠåŸºç¡€ï¼Œä¸‹é¢å’±ä»¬æ­£å¼å¼€å§‹ã€‚ã€‚ã€‚ å…ˆåˆ†ç±»ï¼š å¯†é’¥å¯¹ï¼šsa.key sa.pub æ ¹è¯ä¹¦ï¼šca.crt etcd/ca ç§é’¥ ï¼š ca.key ç­‰ å…¶å®ƒè¯ä¹¦ é¦–å…ˆå…¶å®ƒè¯ä¹¦éƒ½æ˜¯ç”±CAæ ¹è¯ä¹¦é¢å‘çš„ï¼Œkubernetesä¸etcdä½¿ç”¨äº†ä¸åŒçš„CA, å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯è¯ä¹¦æ˜¯ç”¨äºå®¢æˆ·ç«¯æ ¡éªŒè¿˜æ˜¯æœåŠ¡ç«¯æ ¡éªŒã€‚ ä¸‹é¢ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ï¼š service Accountå¯†é’¥å¯¹ sa.key sa.pub æä¾›ç»™ kube-controller-manager ä½¿ç”¨. kube-controller-manager é€šè¿‡ sa.key å¯¹ token è¿›è¡Œç­¾å, master èŠ‚ç‚¹é€šè¿‡å…¬é’¥ sa.pub è¿›è¡Œç­¾åçš„éªŒè¯ å¦‚ kube-proxy æ˜¯ä»¥ pod å½¢å¼è¿è¡Œçš„, åœ¨ pod ä¸­, ç›´æ¥ä½¿ç”¨ service account ä¸ kube-apiserver è¿›è¡Œè®¤è¯, æ­¤æ—¶å°±ä¸éœ€è¦å†å•ç‹¬ä¸º kube-proxy åˆ›å»ºè¯ä¹¦äº†, ä¼šç›´æ¥ä½¿ç”¨tokenæ ¡éªŒ æ ¹è¯ä¹¦ pki/ca.crt pki/ca.key ä¸ºk8sé›†ç¾¤è¯ä¹¦ç­¾å‘æœºæ„ apiserver è¯ä¹¦ pki/apiserver.crt pki/apiserver.key kubeletè¯ä¹¦ pki/apiserver-kubelet-client.crt pki/apiserver-kubelet-client.key kubeletè¦ä¸»åŠ¨è®¿é—®kube-apiserver, kube-apiserverä¹Ÿéœ€è¦ä¸»åŠ¨å‘kubeletå‘èµ·è¯·æ±‚, æ‰€ä»¥åŒæ–¹éƒ½éœ€è¦æœ‰è‡ªå·±çš„æ ¹è¯ä¹¦ä»¥åŠä½¿ç”¨è¯¥æ ¹è¯ä¹¦ç­¾å‘çš„æœåŠ¡ç«¯è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦. åœ¨kube-apiserverä¸­, ä¸€èˆ¬æ˜ç¡®æŒ‡å®šç”¨äºhttpsè®¿é—®çš„æœåŠ¡ç«¯è¯ä¹¦å’Œå¸¦æœ‰CNç”¨æˆ·åä¿¡æ¯çš„å®¢æˆ·ç«¯è¯ä¹¦. è€Œåœ¨kubeletçš„å¯åŠ¨é…ç½®ä¸­, ä¸€èˆ¬åªæŒ‡å®šäº†caæ ¹è¯ä¹¦, è€Œæ²¡æœ‰æ˜ç¡®æŒ‡å®šç”¨äºhttpsè®¿é—®çš„æœåŠ¡ç«¯è¯ä¹¦,åœ¨ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦æ—¶, ä¸€èˆ¬ä¼šæŒ‡å®šæœåŠ¡ç«¯åœ°å€æˆ–ä¸»æœºå, kube-apiserverç›¸å¯¹å˜åŒ–ä¸æ˜¯å¾ˆé¢‘ç¹, æ‰€ä»¥åœ¨åˆ›å»ºé›†ç¾¤ä¹‹åˆå°±å¯ä»¥é¢„å…ˆåˆ†é…å¥½ç”¨ä½œ kube-apiserverçš„IP æˆ–ä¸»æœºå/åŸŸå, ä½†æ˜¯ç”±äºéƒ¨ç½²åœ¨nodeèŠ‚ç‚¹ä¸Šçš„kubeletä¼šå› ä¸ºé›†ç¾¤è§„æ¨¡çš„å˜åŒ–è€Œé¢‘ç¹å˜åŒ–, è€Œæ— æ³•é¢„çŸ¥nodeçš„æ‰€æœ‰IPä¿¡æ¯, æ‰€ä»¥kubeletä¸Šä¸€èˆ¬ä¸ä¼šæ˜ç¡®æŒ‡å®šæœåŠ¡ç«¯è¯ä¹¦, è€Œæ˜¯åªæŒ‡å®šcaæ ¹è¯ä¹¦, è®©kubeletæ ¹æ®æœ¬åœ°ä¸»æœºä¿¡æ¯è‡ªåŠ¨ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦å¹¶ä¿å­˜åˆ°é…ç½®çš„cert-diræ–‡ä»¶å¤¹ä¸­ Aggregation è¯ä¹¦ ä»£ç†æ ¹è¯ä¹¦ï¼š pki/front-proxy-ca.crt pki/front-proxy-ca.key ç”±ä»£ç†æ ¹è¯ä¹¦ç­¾å‘çš„å®¢æˆ·ç«¯è¯ä¹¦ï¼š pki/front-proxy-client.crt pki/front-proxy-client.key æ¯”å¦‚ä½¿ç”¨kubectl proxyä»£ç†è®¿é—®æ—¶ï¼Œkube-apiserverä½¿ç”¨è¿™ä¸ªè¯ä¹¦æ¥éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦æ˜¯è‡ªå·±ç­¾å‘çš„è¯ä¹¦ã€‚ etcd æ ¹è¯ä¹¦ pki/etcd/ca.crt pki/etcd/ca.key etcdèŠ‚ç‚¹é—´ç›¸äº’é€šä¿¡ peerè¯ä¹¦ ç”±æ ¹è¯ä¹¦ç­¾å‘ pki/etcd/peer.crt pki/etcd/peer.key podä¸­Livenessæ¢é’ˆå®¢æˆ·ç«¯è¯ä¹¦ pki/etcd/healthcheck-client.crt pki/etcd/healthcheck-client.key å¯æŸ¥çœ‹yamlæ¢æ´»é…ç½®ï¼š Liveness: exec [/bin/sh -ec ETCDCTL_API=3 etcdctl \\ --endpoints=https://[127.0.0.1]:2379 \\ --cacert=/etc/kubernetes/pki/etcd/ca.crt \\ --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \\ --key=/etc/kubernetes/pki/etcd/healthcheck-client.key get foo] \\ delay=15s timeout=15s period=10s #success=1 #failure=8 apiserverè®¿é—®etcdçš„è¯ä¹¦ pki/apiserver-etcd-client.crt pki/apiserver-etcd-client.key è¿™é‡Œæ³¨æ„ä¸€ä¸‹å®¢æˆ·ç«¯è¯ä¹¦ä¸æœåŠ¡ç«¯è¯ä¹¦åŒºåˆ«ï¼ŒæœåŠ¡ç«¯è¯ä¹¦é€šå¸¸ä¼šæ ¡éªŒåœ°å€åŸŸåç­‰ã€‚ ä»£ç å®ç° kubeadmæŠŠè¯ä¹¦æ—¶é—´å†™æ­»æˆäº†1å¹´ï¼ˆclient-goå°±å†™æ­»äº†ï¼‰ï¼Œè¿™æ˜¯ä¸ªæ‚²ä¼¤çš„æ•…äº‹ï¼Œå¯¼è‡´sealosä¸å¾—ä¸æŠŠè¯ä¹¦ç”Ÿæˆçš„é€»è¾‘å‰¥ç¦»å‡ºæ¥ä»¥è®©å®‰è£…æ”¯æŒä»»æ„è¿‡æœŸæ—¶é—´ã€‚ ä¸‹é¢æ ¹æ®æºç æ¥æ·±å…¥ä½“éªŒä¸‹kubeadmçš„è¯ä¹¦ç”Ÿæˆï¼Œç›´æ¥çœ‹kubeadmä»£ç å¯èƒ½æœ‰ç‚¹ç´¯ï¼Œsealos/certç›®å½•å‰¥ç¦»å‡ºæ ¸å¿ƒçš„ä»£ç æ›´å®¹æ˜“è¯»æ‡‚ä¸€äº›ã€‚ ä»¥ä¸‹ä¸ºäº†çªå‡ºæ ¸å¿ƒé€»è¾‘ï¼Œä»£ç ä¸­åˆ é™¤ä¸€äº›é”™è¯¯å¤„ç†ç»†èŠ‚ï¼Œæœ‰å…´è¶£å¯é˜…è¯»github.com/fanux/sealos/certæºç  å¯†é’¥å¯¹ç”Ÿæˆ // create sa.key sa.pub for service Account func GenerateServiceAccountKeyPaire(dir string) error { key, err := NewPrivateKey(x509.RSA) pub := key.Public() err = WriteKey(dir, \"sa\", key) return WritePublicKey(dir, \"sa\", pub) } ç”Ÿæˆç§é’¥, è¿™é‡Œçš„keyTypeæ˜¯x509.RSA func NewPrivateKey(keyType x509.PublicKeyAlgorithm) (crypto.Signer, error) { if keyType == x509.ECDSA { return ecdsa.GenerateKey(elliptic.P256(), rand.Reader) } return rsa.GenerateKey(rand.Reader, rsaKeySize) } ç”ŸæˆCAè¯ä¹¦ ä¼šè¿”å›ca.crtï¼ˆè‡ªç­¾åè¯ä¹¦ï¼‰ ca.key(ç§é’¥) func NewCaCertAndKey(cfg Config) (*x509.Certificate, crypto.Signer, error) { key, err := NewPrivateKey(x509.UnknownPublicKeyAlgorithm) cert, err := NewSelfSignedCACert(key, cfg.CommonName, cfg.Organization, cfg.Year) return cert, key, nil } æ ¹æ®ç§é’¥ç”Ÿæˆè‡ªç­¾åè¯ä¹¦, NotAfterå°±æ˜¯è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œæˆ‘ä»¬å¾ˆå‹å¥½çš„åŠ äº†ä¸ªå˜é‡è€Œä¸æ˜¯å†™æ­»ï¼š // NewSelfSignedCACert creates a CA certificate func NewSelfSignedCACert(key crypto.Signer, commonName string, organization []string, year time.Duration) (*x509.Certificate, error) { now := time.Now() tmpl := x509.Certificate{ SerialNumber: new(big.Int).SetInt64(0), Subject: pkix.Name{ CommonName: commonName, Organization: organization, }, NotBefore: now.UTC(), NotAfter: now.Add(duration365d * year).UTC(), KeyUsage: x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign, BasicConstraintsValid: true, IsCA: true, } certDERBytes, err := x509.CreateCertificate(rand.Reader, &tmpl, &tmpl, key.Public(), key) return x509.ParseCertificate(certDERBytes) } éå¸¸è¦æ³¨æ„é‡Œé¢çš„CommonNameå’ŒOrganizationå­—æ®µï¼Œéå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªk8sç”¨æˆ·æŒ‡å®šè¯¥ç”¨æˆ·å±äºå“ªä¸ªç”¨æˆ·ç»„ï¼Œå¯¹åº”ä¸Šé¢è¿™ä¸¤ä¸ªå­—æ®µã€‚ æ¯”å¦‚è¯ä¹¦ä¸­ fanux å±äº sealyunè¿™ä¸ªç»„ç»‡ï¼Œé‚£ä¹ˆç”Ÿæˆä¸€ä¸ªkubeconfig, å°±ç›¸å½“äºæœ‰äº†fanuxè¿™ä¸ªç”¨æˆ·ï¼Œè¿™æ ·k8såœ¨åšè®¤è¯æ—¶åªéœ€è¦æ ¡éªŒç­¾åå°±è¡Œï¼Œè€Œä¸éœ€è¦å»è®¿é—® æ•°æ®åº“æ¥åšè®¤è¯ï¼Œè¿™éå¸¸æœ‰åˆ©äºapiserverçš„æ¨ªå‘æ‰©å±•ã€‚ ç”Ÿæˆå…¶å®ƒè¯ä¹¦ å¯†é’¥å¯¹è¿˜æ˜¯è‡ªå·±ç”Ÿæˆï¼Œç„¶åç­¾è¯ä¹¦æ—¶ä¼šæŠŠæ ¹è¯ä¹¦ä¿¡æ¯å¸¦ä¸Š func NewCaCertAndKeyFromRoot(cfg Config, caCert *x509.Certificate, caKey crypto.Signer) (*x509.Certificate, crypto.Signer, error) { key, err := NewPrivateKey(x509.UnknownPublicKeyAlgorithm) cert, err := NewSignedCert(cfg, key, caCert, caKey) return cert, key, nil } æ­¤æ—¶å°±å¿…é¡»è¦æ±‚æœ‰CommonNameäº†ï¼ŒUsagesä¹Ÿå¾—æŒ‡å®šæ˜¯æœåŠ¡ç«¯ä½¿ç”¨è¿˜æ˜¯å®¢æˆ·ç«¯ä½¿ç”¨, æ³¨æ„ä¸ä¸Šé¢SelfSignçš„åŒºåˆ« // NewSignedCert creates a signed certificate using the given CA certificate and key func NewSignedCert(cfg Config, key crypto.Signer, caCert *x509.Certificate, caKey crypto.Signer) (*x509.Certificate, error) { serial, err := rand.Int(rand.Reader, new(big.Int).SetInt64(math.MaxInt64)) if len(cfg.CommonName) == 0 { return nil, errors.New(\"must specify a CommonName\") } if len(cfg.Usages) == 0 { return nil, errors.New(\"must specify at least one ExtKeyUsage\") } certTmpl := x509.Certificate{ Subject: pkix.Name{ CommonName: cfg.CommonName, Organization: cfg.Organization, }, DNSNames: cfg.AltNames.DNSNames, IPAddresses: cfg.AltNames.IPs, SerialNumber: serial, NotBefore: caCert.NotBefore, NotAfter: time.Now().Add(duration365d * cfg.Year).UTC(), KeyUsage: x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature, ExtKeyUsage: cfg.Usages, } certDERBytes, err := x509.CreateCertificate(rand.Reader, &certTmpl, caCert, key.Public(), caKey) return x509.ParseCertificate(certDERBytes) } kubernetesä¸­çš„æ‰€æœ‰è¯ä¹¦ æ ¹è¯ä¹¦åˆ—è¡¨ var caList = []Config{ { Path: BasePath, BaseName: \"ca\", CommonName: \"kubernetes\", Organization: nil, Year: 100, AltNames: AltNames{}, Usages: nil, }, { Path: BasePath, BaseName: \"front-proxy-ca\", CommonName: \"front-proxy-ca\", Organization: nil, Year: 100, AltNames: AltNames{}, Usages: nil, }, { Path: EtcdBasePath, BaseName: \"ca\", CommonName: \"etcd-ca\", Organization: nil, Year: 100, AltNames: AltNames{}, Usages: nil, }, } å…¶å®ƒç­¾åè¯ä¹¦åˆ—è¡¨ var certList = []Config{ { Path: BasePath, BaseName: \"apiserver\", CAName: \"kubernetes\", CommonName: \"kube-apiserver\", Organization: nil, Year: 100, AltNames: AltNames{// å®é™…å®‰è£…æ—¶è¿˜éœ€è¦æŠŠæœåŠ¡å™¨IPç”¨æˆ·è‡ªå®šä¹‰åŸŸååŠ ä¸Š DNSNames: []string{ \"apiserver.cluster.local\", \"localhost\", \"master\", \"kubernetes\", \"kubernetes.default\", \"kubernetes.default.svc\", }, IPs: []net.IP{ {127,0,0,1}, }, }, Usages: []x509.ExtKeyUsage{x509.ExtKeyUsageServerAuth}, // ç”¨é€”æ˜¯æœåŠ¡ç«¯æ ¡éªŒ }, { Path: BasePath, BaseName: \"apiserver-kubelet-client\", CAName: \"kubernetes\", CommonName: \"kube-apiserver-kubelet-client\", Organization: []string{\"system:masters\"}, Year: 100, AltNames: AltNames{}, Usages: []x509.ExtKeyUsage{x509.ExtKeyUsageClientAuth}, }, { Path: BasePath, BaseName: \"front-proxy-client\", CAName: \"front-proxy-ca\", CommonName: \"front-proxy-client\", Organization: nil, Year: 100, AltNames: AltNames{}, Usages: []x509.ExtKeyUsage{x509.ExtKeyUsageClientAuth}, }, { Path: BasePath, BaseName: \"apiserver-etcd-client\", CAName: \"etcd-ca\", CommonName: \"kube-apiserver-etcd-client\", Organization: []string{\"system:masters\"}, Year: 100, AltNames: AltNames{}, Usages: []x509.ExtKeyUsage{x509.ExtKeyUsageClientAuth}, }, { Path: EtcdBasePath, BaseName: \"server\", CAName: \"etcd-ca\", CommonName: \"etcd\", // kubeadm etcd serverè¯ä¹¦common nameä½¿ç”¨èŠ‚ç‚¹åï¼Œè¿™ä¹Ÿæ˜¯è°ƒç”¨æ—¶éœ€è¦æ”¹åŠ¨çš„ Organization: nil, Year: 100, AltNames: AltNames{}, // è°ƒç”¨æ—¶éœ€è¦æŠŠèŠ‚ç‚¹åï¼ŒèŠ‚ç‚¹IPç­‰åŠ ä¸Š Usages: []x509.ExtKeyUsage{x509.ExtKeyUsageServerAuth, x509.ExtKeyUsageClientAuth}, }, { Path: EtcdBasePath, BaseName: \"peer\", CAName: \"etcd-ca\", CommonName: \"etcd-peer\", // ä¸etcd serveråŒç† Organization: nil, Year: 100, AltNames: AltNames{}, // ä¸etcd serveråŒç† Usages: []x509.ExtKeyUsage{x509.ExtKeyUsageServerAuth, x509.ExtKeyUsageClientAuth}, }, { Path: EtcdBasePath, BaseName: \"healthcheck-client\", CAName: \"etcd-ca\", CommonName: \"kube-etcd-healthcheck-client\", Organization: []string{\"system:masters\"}, Year: 100, AltNames: AltNames{}, Usages: []x509.ExtKeyUsage{x509.ExtKeyUsageClientAuth}, }, } ä¸Šé¢éå¸¸è¦æ³¨æ„çš„æ˜¯serverç«¯æ ¡éªŒçš„è¯ä¹¦å®‰è£…æ—¶éœ€è¦æŠŠIPå’ŒåŸŸååŠ ä¸Šï¼Œetcdçš„commonNameä¹Ÿè¦è®¾ç½®æˆnode nameã€‚ çœ‹æœ€åç”Ÿæˆçš„è¯ä¹¦ä¿¡æ¯ï¼š apiserver: [root@iZ2ze4ry74x8bh3cweeg69Z pki]# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout Certificate: ... Signature Algorithm: sha256WithRSAEncryption Issuer: CN=kubernetes Validity Not Before: Mar 31 09:18:06 2020 GMT Not After : Mar 8 09:18:06 2119 GMT Subject: CN=kube-apiserver ... X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment X509v3 Extended Key Usage: TLS Web Server Authentication X509v3 Subject Alternative Name: DNS:iz2ze4ry74x8bh3cweeg69z, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:apiserver.cluster.local, DNS:apiserver.cluster.local, IP Address:10.96.0.1, IP Address:172.16.9.192, IP Address:127.0.0.1, IP Address:172.16.9.192, IP Address:172.16.9.193, IP Address:172.16.9.194, IP Address:10.103.97.2 Signature Algorithm: sha256WithRSAEncryption etcd server: [root@iZ2ze4ry74x8bh3cweeg69Z pki]# openssl x509 -in /etc/kubernetes/pki/etcd/server.crt -text -noout Certificate: Data: Version: 3 (0x2) Serial Number: 1930981199811083392 (0x1acc392ba2b27c80) Signature Algorithm: sha256WithRSAEncryption Issuer: CN=etcd-ca Validity Not Before: Mar 31 09:18:07 2020 GMT Not After : Mar 8 09:18:07 2119 GMT Subject: CN=iz2ze4ry74x8bh3cweeg69z ... X509v3 Extended Key Usage: TLS Web Server Authentication, TLS Web Client Authentication X509v3 Subject Alternative Name: DNS:iz2ze4ry74x8bh3cweeg69z, DNS:localhost, IP Address:172.16.9.192, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1 Signature Algorithm: sha256WithRSAEncryption ç”Ÿæˆç”¨æˆ·è¯ä¹¦å’Œkubeconfig ç°åœ¨æœ‰ä¸ªå®ä¹ ç”Ÿå°æ˜æ¥å…¬å¸äº†ï¼Œä¹Ÿæƒ³ç”¨ç”¨k8sï¼Œæœæ–­ä¸æ”¾å¿ƒæŠŠadmin çš„kubeconfigäº¤ç»™ä»–ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿ æœ‰äº†ä¸Šé¢åŸºç¡€ï¼Œå†è¿›ä¸€æ­¥æ•™ä½ æ€ä¹ˆä¸ºå®ä¹ ç”Ÿå°æ˜åˆ†é…ä¸€ä¸ªå•ç‹¬çš„kubeconfig ä»ç£ç›˜åŠ è½½æ ¹è¯ä¹¦,å’Œç§é’¥ ç”Ÿæˆfanuxè¿™ä¸ªç”¨æˆ·çš„è¯ä¹¦, common nameå°±æ˜¯fanux ç¼–ç æˆpemæ ¼å¼ å†™kubeconfig, å†™ç£ç›˜ func GenerateKubeconfig(conf Config) error{ certs, err := cert.CertsFromFile(conf.CACrtFile) caCert := certs[0] cert := EncodeCertPEM(caCert) caKey,err := TryLoadKeyFromDisk(conf.CAKeyFile) // è¿™é‡Œconf.Userå°±æ˜¯fanux, conf.Groupså°±æ˜¯ç”¨æˆ·ç»„ï¼Œå¯ä»¥æ˜¯å¤šä¸ª clientCert,clientKey,err := NewCertAndKey(caCert,caKey,conf.User,conf.Groups,conf.DNSNames,conf.IPAddresses) encodedClientKey,err := keyutil.MarshalPrivateKeyToPEM(clientKey) encodedClientCert := EncodeCertPEM(clientCert) // æ„å»ºkubeconfigçš„ä¸‰å…ƒç»„ä¿¡æ¯ config := &api.Config{ Clusters: map[string]*api.Cluster{ conf.ClusterName: { Server: conf.Apiserver, // é›†ç¾¤åœ°å€ å¦‚ https://apiserver.cluster.local:6443 CertificateAuthorityData: cert, // pemæ ¼å¼çš„æ ¹è¯ä¹¦ï¼Œç”¨äºhttps }, }, Contexts: map[string]*api.Context{ ctx: { // ä¸‰å…ƒç»„ä¿¡æ¯ï¼Œç”¨æˆ·å fanux, ä¸Šé¢çš„clusteråï¼Œä»¥åŠnamespaceè¿™é‡Œæ²¡å†™ Cluster: conf.ClusterName, AuthInfo: conf.User, }, }, AuthInfos: map[string]*api.AuthInfo{ // ç”¨æˆ·ä¿¡æ¯, æ‰€ä»¥ä½ ç›´æ¥æ”¹kubeconfigé‡Œçš„useræ˜¯æ²¡ç”¨çš„ï¼Œå› ä¸ºk8såªè®¤è¯ä¹¦é‡Œçš„åå­— conf.User:&api.AuthInfo{ ClientCertificateData: encodedClientCert, // pemæ ¼å¼çš„ç”¨æˆ·è¯ä¹¦ ClientKeyData: encodedClientKey, // pemæ ¼å¼çš„ç”¨æˆ·ç§é’¥ }, }, CurrentContext: ctx, // å½“å‰ä¸Šä¸‹æ–‡, kubeconfigå¯ä»¥å¾ˆå¥½æ”¯æŒå¤šç”¨æˆ·å’Œå¤šé›†ç¾¤ } err = clientcmd.WriteToFile(*config, conf.OutPut) return nil } ç”¨æˆ·è¯ä¹¦å’Œç§é’¥ç”Ÿæˆ, å’Œä¸Šé¢ç­¾åè¯ä¹¦ä¸€æ ·ï¼Œuserå°±æ˜¯funax, groupæ˜¯ç”¨æˆ·ç»„ï¼š func NewCertAndKey(caCert *x509.Certificate, caKey crypto.Signer, user string, groups []string, DNSNames []string,IPAddresses []net.IP) (*x509.Certificate, crypto.Signer, error) { key,err := rsa.GenerateKey(rand.Reader, 2048) serial, err := rand.Int(rand.Reader, new(big.Int).SetInt64(math.MaxInt64)) certTmpl := x509.Certificate{ Subject: pkix.Name{ CommonName: user, Organization: groups, }, DNSNames: DNSNames, IPAddresses: IPAddresses, SerialNumber: serial, NotBefore: caCert.NotBefore, NotAfter: time.Now().Add(time.Hour * 24 * 365 * 99).UTC(), KeyUsage: x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature, ExtKeyUsage: []x509.ExtKeyUsage{x509.ExtKeyUsageClientAuth}, } certDERBytes, err := x509.CreateCertificate(rand.Reader, &certTmpl, caCert, key.Public(), caKey) cert,err := x509.ParseCertificate(certDERBytes) return cert,key,nil } ç„¶åè¿™ä½å°ä¼™ä¼´çš„kubeconfigå°±ç”Ÿæˆäº†ï¼Œæ­¤æ—¶æ²¡æœ‰ä»»ä½•æƒé™ï¼š kubectl --kubeconfig ./kube/config get pod Error from server (Forbidden): pods is forbidden: User \"fanux\" cannot list resource \"pods\" in API group ... æœ€åå‘æŒ¥ä¸€ä¸‹RBACå°±å¯ä»¥äº†ï¼Œè¿™é‡Œå°±ç›´æ¥ç»‘å®šä¸ªç®¡ç†å‘˜æƒé™äº† kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: user-admin-test subjects: - kind: User name: \"fanux\" # Name is case sensitive apiGroup: rbac.authorization.k8s.io roleRef: kind: ClusterRole name: cluster-admin # using admin role apiGroup: rbac.authorization.k8s.io æ€»ç»“ è¯ä¹¦ä¸k8sçš„è®¤è¯åŸç†åœ¨é›†ç¾¤å®‰è£…ä»¥åŠå¼€å‘å¤šç§Ÿæˆ·å®¹å™¨å¹³å°æ—¶éå¸¸æœ‰ç”¨ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½è®©å¤§å®¶æœ‰ä¸ªæ•´ä½“ç»†è‡´å…¨é¢çš„äº†è§£ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/1.k8s YAMLæ–‡ä»¶.html":{"url":"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/1.k8s YAMLæ–‡ä»¶.html","title":"YAMLæ–‡ä»¶","keywords":"","body":"k8s YAMLæ–‡ä»¶ æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ k8s 1.18 apiå®˜æ–¹æ–‡æ¡£ YAML åŸºç¡€ å®ƒçš„åŸºæœ¬è¯­æ³•è§„åˆ™å¦‚ä¸‹ï¼š å¤§å°å†™æ•æ„Ÿ ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³» ç¼©è¿›æ—¶ä¸å…è®¸ä½¿ç”¨Tabé”®ï¼Œåªå…è®¸ä½¿ç”¨ç©ºæ ¼ã€‚ ç¼©è¿›çš„ç©ºæ ¼æ•°ç›®ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦ä¾§å¯¹é½å³å¯ # è¡¨ç¤ºæ³¨é‡Šï¼Œä»è¿™ä¸ªå­—ç¬¦ä¸€ç›´åˆ°è¡Œå°¾ï¼Œéƒ½ä¼šè¢«è§£æå™¨å¿½ç•¥ã€‚ åœ¨æˆ‘ä»¬çš„ kubernetes ä¸­ï¼Œä½ åªéœ€è¦ä¸¤ç§ç»“æ„ç±»å‹å°±è¡Œäº†ï¼š Lists Maps ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯èƒ½ä¼šé‡åˆ° Lists çš„ Maps å’Œ Maps çš„ Listsï¼Œç­‰ç­‰ã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä½ åªè¦æŒæ¡äº†è¿™ä¸¤ç§ç»“æ„ä¹Ÿå°±å¯ä»¥äº†ï¼Œå…¶ä»–æ›´åŠ å¤æ‚çš„æˆ‘ä»¬æš‚ä¸è®¨è®ºã€‚ Maps é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ Mapsï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ Map æ˜¯å­—å…¸ï¼Œå°±æ˜¯ä¸€ä¸ªkey:valueçš„é”®å€¼å¯¹ï¼ŒMaps å¯ä»¥è®©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿çš„å»ä¹¦å†™é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š --- apiVersion: v1 kind: Pod ç¬¬ä¸€è¡Œçš„---æ˜¯åˆ†éš”ç¬¦ï¼Œæ˜¯å¯é€‰çš„ï¼Œåœ¨å•ä¸€æ–‡ä»¶ä¸­ï¼Œå¯ç”¨è¿ç»­ä¸‰ä¸ªè¿å­—å·---åŒºåˆ†å¤šä¸ªæ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªé”®ï¼š apiVersionå’Œkind ï¼Œä»–ä»¬å¯¹åº”çš„å€¼åˆ†åˆ«æ˜¯ï¼šv1 å’ŒPodã€‚ä¸Šé¢çš„ YAML æ–‡ä»¶è½¬æ¢æˆ JSON æ ¼å¼çš„è¯ï¼Œä½ è‚¯å®šå°±å®¹æ˜“æ˜ç™½äº†ï¼š { \"apiVersion\": \"v1\", \"kind\": \"pod\" } æˆ‘ä»¬åœ¨åˆ›å»ºä¸€ä¸ªç›¸å¯¹å¤æ‚ä¸€ç‚¹çš„ YAML æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ª KEY å¯¹åº”çš„å€¼ä¸æ˜¯å­—ç¬¦ä¸²è€Œæ˜¯ä¸€ä¸ª Mapsï¼š --- apiVersion: v1 kind: Pod metadata: name: kube100-site labels: app: web ä¸Šé¢çš„ YAML æ–‡ä»¶ï¼Œmetadata è¿™ä¸ª KEY å¯¹åº”çš„å€¼å°±æ˜¯ä¸€ä¸ª Maps äº†ï¼Œè€Œä¸”åµŒå¥—çš„ labels è¿™ä¸ª KEY çš„å€¼åˆæ˜¯ä¸€ä¸ª Mapï¼Œä½ å¯ä»¥æ ¹æ®ä½ è‡ªå·±çš„æƒ…å†µè¿›è¡Œå¤šå±‚åµŒå¥—ã€‚ ä¸Šé¢æˆ‘ä»¬ä¹Ÿæåˆ°äº† YAML æ–‡ä»¶çš„è¯­æ³•è§„åˆ™ï¼ŒYAML å¤„ç†å™¨æ˜¯æ ¹æ®è¡Œç¼©è¿›æ¥çŸ¥é“å†…å®¹ä¹‹é—´çš„å…³è”æ€§çš„ã€‚æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢çš„ YAML æ–‡ä»¶ï¼Œæˆ‘ç”¨äº†ä¸¤ä¸ªç©ºæ ¼ä½œä¸ºç¼©è¿›ï¼Œç©ºæ ¼çš„æ•°é‡å¹¶ä¸é‡è¦ï¼Œä½†æ˜¯ä½ å¾—ä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”è‡³å°‘è¦æ±‚ä¸€ä¸ªç©ºæ ¼ï¼ˆä»€ä¹ˆæ„æ€ï¼Ÿå°±æ˜¯ä½ åˆ«ä¸€ä¼šç¼©è¿›ä¸¤ä¸ªç©ºæ ¼ï¼Œä¸€ä¼šç¼©è¿›4ä¸ªç©ºæ ¼ï¼‰ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ° name å’Œ labels æ˜¯ç›¸åŒçº§åˆ«çš„ç¼©è¿›ï¼Œæ‰€ä»¥ YAML å¤„ç†å™¨å°±çŸ¥é“äº†ä»–ä»¬å±äºåŒä¸€ä¸ª MAPï¼Œè€Œ app æ˜¯ labels çš„å€¼æ˜¯å› ä¸º app çš„ç¼©è¿›æ›´å¤§ã€‚ æ³¨æ„ï¼šåœ¨ YAML æ–‡ä»¶ä¸­ç»å¯¹ä¸è¦ä½¿ç”¨ tab é”®ã€‚ åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ YAML æ–‡ä»¶è½¬æ¢æˆ JSON æ–‡ä»¶ï¼š { \"apiVersion\": \"v1\", \"kind\": \"Pod\", \"metadata\": { \"name\": \"kube100-site\", \"labels\": { \"app\": \"web\" } } } æˆ–è®¸ä½ å¯¹ä¸Šé¢çš„ JSON æ–‡ä»¶æ›´ç†Ÿæ‚‰ï¼Œä½†æ˜¯ä½ ä¸å¾—ä¸æ‰¿è®¤ YAML æ–‡ä»¶çš„è¯­ä¹‰åŒ–ç¨‹åº¦æ›´é«˜å§ï¼Ÿ Lists Lists å°±æ˜¯åˆ—è¡¨ï¼Œè¯´ç™½äº†å°±æ˜¯æ•°ç»„ï¼Œåœ¨ YAML æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰ï¼š args - Cat - Dog - Fish ä½ å¯ä»¥æœ‰ä»»ä½•æ•°é‡çš„é¡¹åœ¨åˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªé¡¹çš„å®šä¹‰ä»¥ç ´æŠ˜å·ï¼ˆ-ï¼‰å¼€å¤´çš„ï¼Œä¸çˆ¶å…ƒç´ ç›´æ¥å¯ä»¥ç¼©è¿›ä¸€ä¸ªç©ºæ ¼ã€‚å¯¹åº”çš„ JSON æ ¼å¼å¦‚ä¸‹ï¼š { \"args\": [\"Cat\", \"Dog\", \"Fish\"] } å½“ç„¶ï¼Œlist çš„å­é¡¹ä¹Ÿå¯ä»¥æ˜¯ Mapsï¼ŒMaps çš„å­é¡¹ä¹Ÿå¯ä»¥æ˜¯listå¦‚ä¸‹æ‰€ç¤ºï¼š --- apiVersion: v1 kind: Pod metadata: name: kube100-site labels: app: web spec: containers: - name: front-end image: nginx ports: - containerPort: 80 - name: flaskapp-demo image: jcdemo/flaskapp ports: - containerPort: 5000 æ¯”å¦‚è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå« containers çš„ List å¯¹è±¡ï¼Œæ¯ä¸ªå­é¡¹éƒ½ç”± nameã€imageã€ports ç»„æˆï¼Œæ¯ä¸ª ports éƒ½æœ‰ä¸€ä¸ª key ä¸º containerPort çš„ Map ç»„æˆï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥è½¬æˆå¦‚ä¸‹ JSON æ ¼å¼æ–‡ä»¶ï¼š { \"apiVersion\": \"v1\", \"kind\": \"Pod\", \"metadata\": { \"name\": \"kube100-site\", \"labels\": { \"app\": \"web\" } }, \"spec\": { \"containers\": [{ \"name\": \"front-end\", \"image\": \"nginx\", \"ports\": [{ \"containerPort\": 80 }] }, { \"name\": \"flaskapp-demo\", \"image\": \"jcdemo/flaskapp\", \"ports\": [{ \"containerPort\": 5000 }] }] } } æ˜¯ä¸æ˜¯è§‰å¾—ç”¨ JSON æ ¼å¼çš„è¯æ–‡ä»¶æ˜æ˜¾æ¯” YAML æ–‡ä»¶æ›´å¤æ‚äº†å‘¢ï¼Ÿ ä½¿ç”¨ YAML åˆ›å»º Pod ç°åœ¨æˆ‘ä»¬å·²ç»å¯¹ YAML æ–‡ä»¶æœ‰äº†å¤§æ¦‚çš„äº†è§£äº†ï¼Œæˆ‘ç›¸ä¿¡ä½ åº”è¯¥æ²¡æœ‰ä¹‹å‰é‚£ä¹ˆæ‡µé€¼äº†å§ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯æ¥ä½¿ç”¨ YAML æ–‡ä»¶æ¥åˆ›å»ºä¸€ä¸ª Deployment å§ã€‚ åˆ›å»º Pod --- apiVersion: v1 kind: Pod metadata: name: kube100-site labels: app: web spec: containers: - name: front-end image: nginx ports: - containerPort: 80 - name: flaskapp-demo image: jcdemo/flaskapp ports: - containerPort: 5000 è¿™æ˜¯æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ä¸€ä¸ªæ™®é€šçš„ POD æ–‡ä»¶ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•åˆ†æä¸‹æ–‡ä»¶å†…å®¹ï¼š apiVersionï¼Œè¿™é‡Œå®ƒçš„å€¼æ˜¯ v1ï¼Œè¿™ä¸ªç‰ˆæœ¬å·éœ€è¦æ ¹æ®æˆ‘ä»¬å®‰è£…çš„ kubernetes ç‰ˆæœ¬å’Œèµ„æºç±»å‹è¿›è¡Œå˜åŒ–çš„ï¼Œè®°ä½ä¸æ˜¯å†™æ­»çš„ kindï¼Œè¿™é‡Œæˆ‘ä»¬åˆ›å»ºçš„æ˜¯ä¸€ä¸ª Podï¼Œå½“ç„¶æ ¹æ®ä½ çš„å®é™…æƒ…å†µï¼Œè¿™é‡Œèµ„æºç±»å‹å¯ä»¥æ˜¯ Deploymentã€Jobã€Ingressã€Service ç­‰å¾…ã€‚ metadataï¼šåŒ…å«äº†æˆ‘ä»¬å®šä¹‰çš„ Pod çš„ä¸€äº› meta ä¿¡æ¯ï¼Œæ¯”å¦‚åç§°ã€namespaceã€æ ‡ç­¾ç­‰ç­‰ä¿¡æ¯ã€‚ specï¼šåŒ…æ‹¬ä¸€äº› containersï¼Œstorageï¼Œvolumesï¼Œæˆ–è€…å…¶ä»– Kubernetes éœ€è¦çŸ¥é“çš„å‚æ•°ï¼Œä»¥åŠè¯¸å¦‚æ˜¯å¦åœ¨å®¹å™¨å¤±è´¥æ—¶é‡æ–°å¯åŠ¨å®¹å™¨çš„å±æ€§ã€‚ä½ å¯ä»¥åœ¨ç‰¹å®š Kubernetes API æ‰¾åˆ°å®Œæ•´çš„ Kubernetes Pod çš„å±æ€§ã€‚ è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…¸å‹çš„å®¹å™¨çš„å®šä¹‰ï¼š â€¦spec: containers: - name: front-end image: nginx ports: - containerPort: 80 â€¦ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„æœ€å°å®šä¹‰ï¼šä¸€ä¸ªåå­—ï¼ˆfront-endï¼‰ï¼ŒåŸºäº nginx çš„é•œåƒï¼Œä»¥åŠå®¹å™¨ å°†ä¼šç›‘å¬çš„ä¸€ä¸ªç«¯å£ï¼ˆ80ï¼‰ã€‚åœ¨è¿™äº›å½“ä¸­ï¼Œåªæœ‰åå­—æ˜¯éå¸¸éœ€è¦çš„ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªæ›´åŠ å¤æ‚çš„å±æ€§ï¼Œä¾‹å¦‚åœ¨å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤ï¼Œåº”ä½¿ç”¨çš„å‚æ•°ï¼Œå·¥ä½œç›®å½•ï¼Œæˆ–æ¯æ¬¡å®ä¾‹åŒ–æ—¶æ˜¯å¦æ‹‰å–æ˜ åƒçš„æ–°å‰¯æœ¬ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å®¹å™¨å¯é€‰çš„è®¾ç½®å±æ€§ï¼š name image command args workingDir ports env resources volumeMounts livenessProbe readinessProbe livecycle terminationMessagePath imagePullPolicy securityContext stdin stdinOnce tty æ˜ç™½äº† POD çš„å®šä¹‰åï¼Œæˆ‘ä»¬å°†ä¸Šé¢åˆ›å»º POD çš„ YAML æ–‡ä»¶ä¿å­˜æˆ pod.yamlï¼Œç„¶åä½¿ç”¨kubectlåˆ›å»º PODï¼š $ kubectl create -f pod.yaml pod \"kube100-site\" created ç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬å‰é¢æ¯”è¾ƒç†Ÿæ‚‰çš„ kubectl å‘½ä»¤æ¥æŸ¥çœ‹ POD çš„çŠ¶æ€äº†ï¼š $ kubectl get pods NAME READY STATUS RESTARTS AGE kube100-site 2/2 Running 0 1m åˆ°è¿™é‡Œæˆ‘ä»¬çš„ POD å°±åˆ›å»ºæˆåŠŸäº†ï¼Œå¦‚æœä½ åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨å‰é¢çš„kubectl describe è¿›è¡Œæ’æŸ¥ã€‚æˆ‘ä»¬å…ˆåˆ é™¤ä¸Šé¢åˆ›å»ºçš„ PODï¼š $ kubectl delete -f pod.yaml pod \"kube100-site\" deleted åˆ›å»º Deployment ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥åˆ›å»ºä¸€ä¸ªçœŸæ­£çš„ Deploymentã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯å•çº¯çš„åˆ›å»ºäº†ä¸€ä¸ª POD å®ä¾‹ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ª POD å‡ºç°äº†æ•…éšœçš„è¯ï¼Œæˆ‘ä»¬çš„æœåŠ¡ä¹Ÿå°±æŒ‚æ‰äº†ï¼Œæ‰€ä»¥ kubernetes æä¾›äº†ä¸€ä¸ªDeploymentçš„æ¦‚å¿µï¼Œå¯ä»¥è®© kubernetes å»ç®¡ç†ä¸€ç»„ POD çš„å‰¯æœ¬ï¼Œä¹Ÿå°±æ˜¯å‰¯æœ¬é›†ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯ä¸€å®šæ•°é‡çš„å‰¯æœ¬ä¸€ç›´å¯ç”¨çš„ï¼Œä¸ä¼šå› ä¸ºä¸€ä¸ª POD æŒ‚æ‰å¯¼è‡´æ•´ä¸ªæœåŠ¡æŒ‚æ‰ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰ä¸€ä¸ª Deploymentï¼š --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: kube100-site spec: replicas: 2 æ³¨æ„è¿™é‡Œçš„apiVersionå¯¹åº”çš„å€¼æ˜¯extensions/v1beta1ï¼Œå½“ç„¶ kind è¦æŒ‡å®šä¸º Deploymentï¼Œå› ä¸ºè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€äº› meta ä¿¡æ¯ï¼Œæ¯”å¦‚åå­—ï¼Œæˆ–è€…æ ‡ç­¾ä¹‹ç±»çš„ã€‚æœ€åï¼Œæœ€é‡è¦çš„æ˜¯specé…ç½®é€‰é¡¹ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰éœ€è¦ä¸¤ä¸ªå‰¯æœ¬ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šå¯ä»¥è®¾ç½®çš„å±æ€§ï¼Œæ¯”å¦‚ä¸€ä¸ª Pod åœ¨æ²¡æœ‰ä»»ä½•é”™è¯¯å˜æˆå‡†å¤‡çš„æƒ…å†µä¸‹å¿…é¡»è¾¾åˆ°çš„æœ€å°ç§’æ•°ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨Kubernetes v1beta1 API(å®˜æ–¹å·²ä¿®æ”¹ï¼Œæ—©å°±404äº†ï¼Œå¤©å¤©çé¸¡å§æ”¹ï¼Œéƒ½å°¼ç›æ‰¾ä¸åˆ°äº†)å‚è€ƒä¸­æ‰¾åˆ°ä¸€ä¸ªå®Œæ•´çš„ Depolyment å¯æŒ‡å®šçš„å‚æ•°åˆ—è¡¨ã€‚ ç°åœ¨æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªå®Œæ•´çš„ Deployment çš„ YAML æ–‡ä»¶ï¼š --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: kube100-site spec: replicas: 2 template: metadata: labels: app: web spec: containers: - name: front-end image: nginx ports: - containerPort: 80 - name: flaskapp-demo image: jcdemo/flaskapp ports: - containerPort: 5000 çœ‹èµ·æ¥æ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬ä¸Šé¢çš„ pod.yaml å¾ˆç±»ä¼¼å•Šï¼Œæ³¨æ„å…¶ä¸­çš„ templateï¼Œå…¶å®å°±æ˜¯å¯¹ POD å¯¹è±¡çš„å®šä¹‰ã€‚å°†ä¸Šé¢çš„ YAML æ–‡ä»¶ä¿å­˜ä¸º deployment.yamlï¼Œç„¶ååˆ›å»º Deploymentï¼š $ kubectl create -f deployment.yaml deployment \"kube100-site\" created åŒæ ·çš„ï¼Œæƒ³è¦æŸ¥çœ‹å®ƒçš„çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ Deploymentçš„åˆ—è¡¨ï¼š $ kubectl get deployments NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE kube100-site 2 2 2 2 2m æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ Pods éƒ½å·²ç»æ­£å¸¸è¿è¡Œäº†ã€‚ åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†ä½¿ç”¨ YAML æ–‡ä»¶åˆ›å»º Kubernetes Deployment çš„è¿‡ç¨‹ï¼Œåœ¨äº†è§£äº† YAML æ–‡ä»¶çš„åŸºç¡€åï¼Œå®šä¹‰ YAML æ–‡ä»¶å…¶å®å·²ç»å¾ˆç®€å•äº†ï¼Œæœ€ä¸»è¦çš„æ˜¯è¦æ ¹æ®å®é™…æƒ…å†µå»å®šä¹‰ YAML æ–‡ä»¶ï¼Œæ‰€ä»¥æŸ¥é˜… Kubernetes æ–‡æ¡£å¾ˆé‡è¦ã€‚ å¯ä»¥ä½¿ç”¨yamlæ–‡ä»¶æ£€æµ‹ç½‘ç«™å»æ£€éªŒ YAML æ–‡ä»¶çš„åˆæ³•æ€§ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/k8s pod.html":{"url":"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/k8s pod.html","title":"k8s pod","keywords":"","body":"k8s pod kubectl runå‘½ä»¤ä¸­æ–‡ç½‘ç«™ kubectl run generatorå‚æ•°å®˜ç½‘è¯´æ˜ podå®¹å™¨åˆ†ç±» Infrastructure Containerï¼šåŸºç¡€å®¹å™¨ ç»´æŠ¤æ•´ä¸ªPodç½‘ç»œç©ºé—´ InitContainersï¼šåˆå§‹åŒ–å®¹å™¨ å…ˆäºä¸šåŠ¡å®¹å™¨å¼€å§‹æ‰§è¡Œ Containersï¼šä¸šåŠ¡å®¹å™¨ å¹¶è¡Œå¯åŠ¨ podæ“ä½œ 1.1 åˆ›å»ºpod å‘½ä»¤æ–¹å¼ --generator=run-pod/v1å°±æ˜¯æŒ‡å®šåˆ›å»ºçš„ç±»å‹ä¸ºpod kubectl run nginx --image=nginx:1.16 --replicas=3 --generator=run-pod/v1 yamlæ–‡ä»¶æ–¹å¼ cat >nginx-pod.yaml åˆ›å»ºpodè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ é•œåƒæ˜¯ä½¿ç”¨äº†masteræœ¬æœºçš„registerç§æœ‰ä»“åº“ï¼Œé…ç½®äº†è®¤è¯ï¼Œåˆ›å»ºpodæ‹‰å–é•œåƒæŠ¥é”™å¦‚ä¸‹ Warning Failed 14m (x4 over 15m) kubelet, k8s-node2 Failed to pull image \"10.0.0.130:5000/nginx:latest\": rpc error: code = Unknown desc = Error response from daemon: Get http://10.0.0.130:5000/v2/nginx/manifests/latest: no basic auth credentials è§£å†³æ–¹æ³•ï¼š åˆ›å»ºä¸€ä¸ªregisterçš„è®¤è¯ï¼Œåç§°ä¸ºmyregistrykeyï¼Œç„¶ååœ¨podçš„yamlæ–‡ä»¶ä¸­å®šä¹‰å¦‚ä¸‹å³å¯ imagePullSecrets: name: myregistrykey #åˆ›å»ºè®¤è¯ kubectl create secret docker-registry myregistrykey --docker-server=10.0.0.130:5000 --docker-username=test --docker-password=123456 secret/myregistrykey created #åˆ é™¤è®¤è¯ kubectl delete secrets myregistrykey 1.2 æŸ¥çœ‹pod #æŸ¥çœ‹æ‰€æœ‰pod kubectl get pods #æŒ‡å®špodæŸ¥çœ‹ kubectl get pod pod-name #æŸ¥çœ‹podè¯¦ç»†ä¿¡æ¯ kubectl describe pod pod-name 1.3 åˆ é™¤pod #åˆ é™¤pod kubectl delete pod pod-name é™æ€pod 1.é™æ€podè¯´æ˜ é™æ€ Pod ç›´æ¥ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„kubeletè¿›ç¨‹æ¥ç®¡ç†ï¼Œä¸é€šè¿‡ master èŠ‚ç‚¹ä¸Šçš„apiserverã€‚æ— æ³•ä¸æˆ‘ä»¬å¸¸ç”¨çš„æ§åˆ¶å™¨Deploymentæˆ–è€…DaemonSetè¿›è¡Œå…³è”ï¼Œå®ƒç”±kubeletè¿›ç¨‹è‡ªå·±æ¥ç›‘æ§ï¼Œå½“podå´©æºƒæ—¶é‡å¯è¯¥podï¼Œkubeletä¹Ÿæ— æ³•å¯¹ä»–ä»¬è¿›è¡Œå¥åº·æ£€æŸ¥ã€‚é™æ€ pod å§‹ç»ˆç»‘å®šåœ¨æŸä¸€ä¸ªkubeletï¼Œå¹¶ä¸”å§‹ç»ˆè¿è¡Œåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚ kubeletä¼šè‡ªåŠ¨ä¸ºæ¯ä¸€ä¸ªé™æ€ pod åœ¨ Kubernetes çš„ apiserver ä¸Šåˆ›å»ºä¸€ä¸ªé•œåƒ Podï¼ˆMirror Podï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ apiserver ä¸­æŸ¥è¯¢åˆ°è¯¥ podï¼Œä½†æ˜¯ä¸èƒ½é€šè¿‡ apiserver è¿›è¡Œæ§åˆ¶ï¼ˆä¾‹å¦‚ä¸èƒ½åˆ é™¤ï¼‰ã€‚ kubeadmå®‰è£…çš„k8sä¸­ï¼Œetcd ã€kube-apiserverã€ kube-controller-managerã€kube-scheduleréƒ½æ˜¯ä»¥é™æ€podçš„æ–¹å¼éƒ¨ç½²ï¼Œè·¯å¾„ä¸º/etc/kubernetes/manifests/ï¼Œåªéœ€è¦æŠŠyamlæ–‡ä»¶æ”¾åœ¨æ­¤è·¯å¾„å°±ä¼šå¯åŠ¨é™æ€podï¼Œç§»é™¤yamlæ–‡ä»¶åˆ™ä¼šåˆ é™¤é™æ€pod é™æ€podä½¿ç”¨kubectl deleteå‘½ä»¤æ— æ³•åˆ é™¤ï¼Œä½†æ˜¯åœ¨1.17.4ç‰ˆæœ¬ä¸­å®˜æ–¹çš„dashboardä¸­å¯ä»¥åˆ é™¤ï¼Œå…¶ä½™ç‰ˆæœ¬æ²¡æœ‰æµ‹è¯• 2.åˆ›å»ºé™æ€pod åˆ›å»ºé™æ€ Pod æœ‰ä¸¤ç§æ–¹å¼ï¼šé…ç½®æ–‡ä»¶å’Œ HTTP ä¸¤ç§æ–¹å¼ é…ç½®æ–‡ä»¶æ–¹å¼ é…ç½®æ–‡ä»¶å°±æ˜¯æ”¾åœ¨ç‰¹å®šç›®å½•ä¸‹çš„æ ‡å‡†çš„ JSON æˆ– YAML æ ¼å¼çš„ pod å®šä¹‰æ–‡ä»¶ã€‚ç”¨kubelet --pod-manifest-path=æ¥å¯åŠ¨kubeletè¿›ç¨‹ï¼Œkubelet å®šæœŸçš„å»æ‰«æè¿™ä¸ªç›®å½•ï¼Œæ ¹æ®è¿™ä¸ªç›®å½•ä¸‹å‡ºç°æˆ–æ¶ˆå¤±çš„ YAML/JSON æ–‡ä»¶æ¥åˆ›å»ºæˆ–åˆ é™¤é™æ€ podã€‚ æ¯”å¦‚æˆ‘ä»¬åœ¨ node01 è¿™ä¸ªèŠ‚ç‚¹ä¸Šç”¨é™æ€ pod çš„æ–¹å¼æ¥å¯åŠ¨ä¸€ä¸ª nginx çš„æœåŠ¡ã€‚æˆ‘ä»¬ç™»å½•åˆ°node01èŠ‚ç‚¹ä¸Šé¢ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æ‰¾åˆ°kubeletå¯¹åº”çš„å¯åŠ¨é…ç½®æ–‡ä»¶ $ systemctl status kubelet kubelet.service - kubelet: The Kubernetes Node Agent Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled) Drop-In: /usr/lib/systemd/system/kubelet.service.d â””â”€10-kubeadm.conf Active: active (running) since Tue 2020-03-31 20:08:43 CST; 1 weeks 2 days ago Docs: https://kubernetes.io/docs/ Main PID: 20088 (kubelet) Tasks: 17 Memory: 177.3M CGroup: /system.slice/kubelet.service â””â”€20088 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=... é…ç½®æ–‡ä»¶è·¯å¾„ä¸ºï¼š /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf # Note: This dropin only works with kubeadm and kubelet v1.11+ [Service] Environment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf\" Environment=\"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml\" # This is a file that \"kubeadm init\" and \"kubeadm join\" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file. EnvironmentFile=-/etc/sysconfig/kubelet ExecStart= ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS æ‰“å¼€è¿™ä¸ªæ–‡ä»¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸€æ¡å¦‚ä¸‹çš„ç¯å¢ƒå˜é‡é…ç½®ï¼š Environment=\"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml\"è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: false webhook: cacheTTL: 0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.crt authorization: mode: Webhook webhook: cacheAuthorizedTTL: 0s cacheUnauthorizedTTL: 0s clusterDNS: - 10.96.0.10 clusterDomain: cluster.local cpuManagerReconcilePeriod: 0s evictionPressureTransitionPeriod: 0s fileCheckFrequency: 0s healthzBindAddress: 127.0.0.1 healthzPort: 10248 httpCheckFrequency: 0s imageMinimumGCAge: 0s kind: KubeletConfiguration nodeStatusReportFrequency: 0s nodeStatusUpdateFrequency: 0s rotateCertificates: true runtimeRequestTimeout: 0s staticPodPath: /etc/kubernetes/manifests streamingConnectionIdleTimeout: 0s syncFrequency: 0s volumeStatsAggPeriod: 0s å…¶ä¸­æœ‰ä¸€é¡¹staticPodPath: /etc/kubernetes/manifests æ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡kubeadmçš„æ–¹å¼æ¥å®‰è£…çš„é›†ç¾¤ç¯å¢ƒï¼Œå¯¹åº”çš„kubeletå·²ç»é…ç½®äº†æˆ‘ä»¬çš„é™æ€ Pod æ–‡ä»¶çš„è·¯å¾„ï¼Œé‚£å°±æ˜¯/etc/kubernetes/manifestsï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨è¯¥ç›®å½•ä¸‹é¢åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„ Pod çš„ JSON æˆ–è€… YAML æ–‡ä»¶å³å¯ï¼š å¦‚æœä½ çš„ kubelet å¯åŠ¨å‚æ•°ä¸­æ²¡æœ‰é…ç½®ä¸Šé¢çš„--pod-manifest-pathå‚æ•°çš„è¯ï¼Œé‚£ä¹ˆæ·»åŠ ä¸Šè¿™ä¸ªå‚æ•°ç„¶åé‡å¯ kubelet å³å¯ã€‚ cat >/etc/kubernetes/manifest/static-web.yaml HTTPæ–¹å¼ kubelet å‘¨æœŸåœ°ä»â€“manifest-url=å‚æ•°æŒ‡å®šçš„åœ°å€ä¸‹è½½æ–‡ä»¶ï¼Œå¹¶ä¸”æŠŠå®ƒç¿»è¯‘æˆ JSON/YAML æ ¼å¼çš„ pod å®šä¹‰ã€‚æ­¤åçš„æ“ä½œæ–¹å¼ä¸â€“pod-manifest-path=ç›¸åŒï¼Œkubelet ä¼šä¸æ—¶åœ°é‡æ–°ä¸‹è½½è¯¥æ–‡ä»¶ï¼Œå½“æ–‡ä»¶å˜åŒ–æ—¶å¯¹åº”åœ°ç»ˆæ­¢æˆ–å¯åŠ¨é™æ€ podã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/podå¥åº·æ£€æŸ¥.html":{"url":"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/podå¥åº·æ£€æŸ¥.html","title":"podå¥åº·æ£€æŸ¥","keywords":"","body":"podå¥åº·æ£€æŸ¥ æ¢é’ˆåˆ†ç±» 1 liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰ kubelet é€šè¿‡ä½¿ç”¨ liveness probe æ¥ç¡®å®šä½ çš„åº”ç”¨ç¨‹åºæ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œé€šä¿—ç‚¹è®²å°±æ˜¯æ˜¯å¦è¿˜æ´»ç€ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä½ çš„ç¨‹åºä¸€æ—¦å´©æºƒäº†ï¼Œ Kubernetes å°±ä¼šç«‹åˆ»çŸ¥é“è¿™ä¸ªç¨‹åºå·²ç»ç»ˆæ­¢äº†ï¼Œç„¶åå°±ä¼šé‡å¯è¿™ä¸ªç¨‹åºã€‚è€Œæˆ‘ä»¬çš„ liveness probe çš„ç›®çš„å°±æ˜¯æ¥æ•è·åˆ°å½“å‰åº”ç”¨ç¨‹åºè¿˜æœ‰æ²¡æœ‰ç»ˆæ­¢ï¼Œè¿˜æœ‰æ²¡æœ‰å´©æºƒï¼Œå¦‚æœå‡ºç°äº†è¿™äº›æƒ…å†µï¼Œé‚£ä¹ˆå°±é‡å¯å¤„äºè¯¥çŠ¶æ€ä¸‹çš„å®¹å™¨ï¼Œä½¿åº”ç”¨ç¨‹åºåœ¨å­˜åœ¨ bug çš„æƒ…å†µä¸‹ä¾ç„¶èƒ½å¤Ÿç»§ç»­è¿è¡Œä¸‹å»ã€‚ 2 readiness probeï¼ˆå¯è¯»æ€§æ¢é’ˆï¼‰ kubelet ä½¿ç”¨ readiness probe æ¥ç¡®å®šå®¹å™¨æ˜¯å¦å·²ç»å°±ç»ªå¯ä»¥æ¥æ”¶æµé‡è¿‡æ¥äº†ã€‚è¿™ä¸ªæ¢é’ˆé€šä¿—ç‚¹è®²å°±æ˜¯è¯´æ˜¯å¦å‡†å¤‡å¥½äº†ï¼Œç°åœ¨å¯ä»¥å¼€å§‹å·¥ä½œäº†ã€‚åªæœ‰å½“ Pod ä¸­çš„å®¹å™¨éƒ½å¤„äºå°±ç»ªçŠ¶æ€çš„æ—¶å€™ kubelet æ‰ä¼šè®¤å®šè¯¥ Pod å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå› ä¸ºä¸€ä¸ª Pod ä¸‹é¢å¯èƒ½ä¼šæœ‰å¤šä¸ªå®¹å™¨ã€‚å½“ç„¶ Pod å¦‚æœå¤„äºéå°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šå°†ä»–ä»æˆ‘ä»¬çš„å·¥ä½œé˜Ÿåˆ—(å®é™…ä¸Šå°±æ˜¯Service)ä¸­ç§»é™¤å‡ºæ¥ï¼Œè¿™æ ·æˆ‘ä»¬çš„æµé‡å°±ä¸ä¼šè¢«è·¯ç”±åˆ°è¿™ä¸ª Pod é‡Œé¢æ¥äº†ã€‚ Podä¸­å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸçš„ä¸¤ä¸ªé’©å­å‡½æ•°ï¼ŒPostStartä¸PreStopï¼Œå…¶ä¸­PostStartæ˜¯åœ¨å®¹å™¨åˆ›å»ºåç«‹å³æ‰§è¡Œçš„ï¼Œè€ŒPreStopè¿™ä¸ªé’©å­å‡½æ•°åˆ™æ˜¯åœ¨å®¹å™¨ç»ˆæ­¢ä¹‹å‰æ‰§è¡Œçš„ã€‚é™¤äº†ä¸Šé¢è¿™ä¸¤ä¸ªé’©å­å‡½æ•°ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹é…ç½®ä¼šå½±å“åˆ°å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œé‚£å°±æ˜¯å¥åº·æ£€æŸ¥çš„æ¢é’ˆã€‚ åœ¨Kubernetesé›†ç¾¤å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰å’Œreadiness probeï¼ˆå¯è¯»æ€§æ¢é’ˆï¼‰æ¥å½±å“å®¹å™¨çš„ç”Ÿå­˜å‘¨æœŸã€‚ å’Œå‰é¢çš„é’©å­å‡½æ•°ä¸€æ ·çš„ï¼Œæˆ‘ä»¬è¿™ä¸¤ä¸ªæ¢é’ˆçš„æ”¯æŒä¸‰ç§é…ç½®æ–¹å¼ï¼š execï¼šæ‰§è¡Œä¸€æ®µå‘½ä»¤ httpï¼šæ£€æµ‹æŸä¸ª http è¯·æ±‚ tcpSocketï¼šä½¿ç”¨æ­¤é…ç½®ï¼Œ kubelet å°†å°è¯•åœ¨æŒ‡å®šç«¯å£ä¸Šæ‰“å¼€å®¹å™¨çš„å¥—æ¥å­—ã€‚å¦‚æœå¯ä»¥å»ºç«‹è¿æ¥ï¼Œå®¹å™¨è¢«è®¤ä¸ºæ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸èƒ½å°±è®¤ä¸ºæ˜¯å¤±è´¥çš„ã€‚å®é™…ä¸Šå°±æ˜¯æ£€æŸ¥ç«¯å£ æ¢é’ˆé…ç½®æ–¹å¼ 1. exec å¥½ï¼Œæˆ‘ä»¬å…ˆæ¥ç»™å¤§å®¶æ¼”ç¤ºä¸‹å­˜æ´»æ¢é’ˆçš„ä½¿ç”¨æ–¹æ³•ï¼Œé¦–å…ˆæˆ‘ä»¬ç”¨execæ‰§è¡Œå‘½ä»¤çš„æ–¹å¼æ¥æ£€æµ‹å®¹å™¨çš„å­˜æ´»ï¼Œå¦‚ä¸‹: cat >liveness-exec.yaml æˆ‘ä»¬è¿™é‡Œéœ€è¦ç”¨åˆ°ä¸€ä¸ªæ–°çš„å±æ€§ï¼šlivenessProbeï¼Œä¸‹é¢é€šè¿‡execæ‰§è¡Œä¸€æ®µå‘½ä»¤ï¼Œå…¶ä¸­periodSecondså±æ€§è¡¨ç¤ºè®©kubeletæ¯éš”5ç§’æ‰§è¡Œä¸€æ¬¡å­˜æ´»æ¢é’ˆï¼Œä¹Ÿå°±æ˜¯æ¯5ç§’æ‰§è¡Œä¸€æ¬¡ä¸Šé¢çš„cat /tmp/healthyå‘½ä»¤ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸäº†ï¼Œå°†è¿”å›0ï¼Œé‚£ä¹ˆkubeletå°±ä¼šè®¤ä¸ºå½“å‰è¿™ä¸ªå®¹å™¨æ˜¯å­˜æ´»çš„å¹¶ä¸”å¾ˆå¥åº·ï¼Œå¦‚æœè¿”å›çš„æ˜¯é0å€¼ï¼Œé‚£ä¹ˆkubeletå°±ä¼šæŠŠè¯¥å®¹å™¨æ€æ‰ç„¶åé‡å¯å®ƒã€‚ å¦å¤–ä¸€ä¸ªå±æ€§initialDelaySecondsè¡¨ç¤ºåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢é’ˆçš„æ—¶å€™è¦ç­‰å¾…5ç§’ï¼Œè¿™æ ·èƒ½å¤Ÿç¡®ä¿æˆ‘ä»¬çš„å®¹å™¨èƒ½å¤Ÿæœ‰è¶³å¤Ÿçš„æ—¶é—´å¯åŠ¨èµ·æ¥ã€‚å¤§å®¶å¯ä»¥æƒ³è±¡ä¸‹ï¼Œå¦‚æœä½ çš„ç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢é’ˆç­‰å€™çš„æ—¶é—´å¤ªçŸ­ï¼Œæ˜¯ä¸æ˜¯å¾ˆæœ‰å¯èƒ½å®¹å™¨è¿˜æ²¡æ­£å¸¸å¯åŠ¨èµ·æ¥ï¼Œæ‰€ä»¥å­˜æ´»æ¢é’ˆå¾ˆå¯èƒ½å§‹ç»ˆéƒ½æ˜¯å¤±è´¥çš„ï¼Œè¿™æ ·å°±ä¼šæ— ä¼‘æ­¢çš„é‡å¯ä¸‹å»äº†ï¼Œå¯¹å§ï¼Ÿæ‰€ä»¥ä¸€ä¸ªåˆç†çš„initialDelaySecondséå¸¸é‡è¦ã€‚ å¦å¤–æˆ‘ä»¬åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œæ‰§è¡Œäº†å¦‚ä¸‹å‘½ä»¤ï¼š /bin/sh -c \"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600\" æ„æ€æ˜¯è¯´åœ¨å®¹å™¨æœ€å¼€å§‹çš„30ç§’å†…æœ‰ä¸€ä¸ª/tmp/healthyæ–‡ä»¶ï¼Œåœ¨è¿™30ç§’å†…æ‰§è¡Œcat /tmp/healthyå‘½ä»¤éƒ½ä¼šè¿”å›ä¸€ä¸ªæˆåŠŸçš„è¿”å›ç ã€‚30ç§’åï¼Œæˆ‘ä»¬åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œç°åœ¨æ‰§è¡Œcat /tmp/healthyæ˜¯ä¸æ˜¯å°±ä¼šå¤±è´¥äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šé‡å¯å®¹å™¨äº†ã€‚ æˆ‘ä»¬æ¥åˆ›å»ºä¸‹è¯¥Podï¼Œåœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podçš„Eventï¼š kubectl describe pod liveness-exec Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 106s default-scheduler Successfully assigned default/liveness-exec to k8s-node1 Warning Unhealthy 44s (x3 over 54s) kubelet, k8s-node1 Liveness probe failed: cat: can't open '/tmp/healthy': No such file or directory Normal Killing 44s kubelet, k8s-node1 Container liveness failed liveness probe, will be restarted Normal Pulling 14s (x2 over 106s) kubelet, k8s-node1 Pulling image \"busybox\" Normal Pulled 10s (x2 over 89s) kubelet, k8s-node1 Successfully pulled image \"busybox\" Normal Created 10s (x2 over 89s) kubelet, k8s-node1 Created container liveness Normal Started 10s (x2 over 89s) kubelet, k8s-node1 Started container liveness æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°å®¹å™¨æ˜¯æ­£å¸¸å¯åŠ¨çš„ï¼Œåœ¨éš”ä¸€ä¼šå„¿ï¼Œæ¯”å¦‚40såï¼Œå†æŸ¥çœ‹ä¸‹Podçš„Eventï¼Œåœ¨æœ€ä¸‹é¢æœ‰ä¸€æ¡ä¿¡æ¯æ˜¾ç¤º liveness probeå¤±è´¥äº†ï¼Œå®¹å™¨è¢«åˆ æ‰å¹¶é‡æ–°åˆ›å»ºã€‚ ç„¶åé€šè¿‡kubectl get pod liveness-execå¯ä»¥çœ‹åˆ°RESTARTSå€¼åŠ 1äº†ã€‚ 2. http åŒæ ·çš„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨HTTP GETè¯·æ±‚æ¥é…ç½®æˆ‘ä»¬çš„å­˜æ´»æ¢é’ˆï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ä¸€ä¸ªlivenessé•œåƒæ¥éªŒè¯æ¼”ç¤ºä¸‹ï¼Œ cat >liveness-http.yaml åŒæ ·çš„ï¼Œæ ¹æ®periodSecondså±æ€§æˆ‘ä»¬å¯ä»¥çŸ¥é“kubeletéœ€è¦æ¯éš”3ç§’æ‰§è¡Œä¸€æ¬¡liveness probeï¼Œè¯¥æ¢é’ˆå°†å‘å®¹å™¨ä¸­çš„ server çš„8080ç«¯å£å‘é€ä¸€ä¸ª HTTP GET è¯·æ±‚ã€‚å¦‚æœ server çš„ /healthz è·¯å¾„çš„ handler è¿”å›ä¸€ä¸ªæˆåŠŸçš„è¿”å›ç ï¼Œkubeletå°±ä¼šè®¤å®šè¯¥å®¹å™¨æ˜¯æ´»ç€çš„å¹¶ä¸”å¾ˆå¥åº·,å¦‚æœè¿”å›å¤±è´¥çš„è¿”å›ç ï¼Œkubeletå°†æ€æ‰è¯¥å®¹å™¨å¹¶é‡å¯å®ƒã€‚initialDelaySeconds æŒ‡å®škubeletåœ¨è¯¥æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹ä¹‹å‰éœ€è¦ç­‰å¾…3ç§’é’Ÿã€‚ é€šå¸¸æ¥è¯´ï¼Œä»»ä½•å¤§äº200å°äº400çš„è¿”å›ç éƒ½ä¼šè®¤å®šæ˜¯æˆåŠŸçš„è¿”å›ç ã€‚å…¶ä»–è¿”å›ç éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯å¤±è´¥çš„è¿”å›ç ã€‚ æˆ‘ä»¬å¯ä»¥æ¥æŸ¥çœ‹ä¸‹ä¸Šé¢çš„healthzçš„å®ç°ï¼š http.HandleFunc(\"/healthz\", func(w http.ResponseWriter, r *http.Request) { duration := time.Now().Sub(started) if duration.Seconds() > 10 { w.WriteHeader(500) w.Write([]byte(fmt.Sprintf(\"error: %v\", duration.Seconds()))) } else { w.WriteHeader(200) w.Write([]byte(\"ok\")) } }) å¤§æ¦‚æ„æ€å°±æ˜¯æœ€å¼€å§‹å‰10sè¿”å›çŠ¶æ€ç 200ï¼Œ10sè¿‡åå°±è¿”å›500çš„status_codeäº†ã€‚æ‰€ä»¥å½“å®¹å™¨å¯åŠ¨3ç§’åï¼Œkubelet å¼€å§‹æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚ç¬¬ä¸€æ¬¡å¥åº·ç›‘æµ‹ä¼šæˆåŠŸï¼Œå› ä¸ºæ˜¯åœ¨10sä¹‹å†…ï¼Œä½†æ˜¯10ç§’åï¼Œå¥åº·æ£€æŸ¥å°†å¤±è´¥ï¼Œå› ä¸ºç°åœ¨è¿”å›çš„æ˜¯ä¸€ä¸ªé”™è¯¯çš„çŠ¶æ€ç äº†ï¼Œæ‰€ä»¥kubeletå°†ä¼šæ€æ‰å’Œé‡å¯å®¹å™¨ã€‚ åŒæ ·çš„ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸‹è¯¥Podæµ‹è¯•ä¸‹æ•ˆæœï¼Œ10ç§’åï¼ŒæŸ¥çœ‹ Pod çš„ eventï¼Œç¡®è®¤liveness probeå¤±è´¥å¹¶é‡å¯äº†å®¹å™¨ã€‚ kubectl describe pod liveness-http 3. tcpSocket ç„¶åæˆ‘ä»¬æ¥é€šè¿‡ç«¯å£çš„æ–¹å¼æ¥é…ç½®å­˜æ´»æ¢é’ˆï¼Œä½¿ç”¨æ­¤é…ç½®ï¼Œkubeletå°†å°è¯•åœ¨æŒ‡å®šç«¯å£ä¸Šæ‰“å¼€å®¹å™¨çš„å¥—æ¥å­—ã€‚ å¦‚æœå¯ä»¥å»ºç«‹è¿æ¥ï¼Œå®¹å™¨è¢«è®¤ä¸ºæ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸èƒ½å°±è®¤ä¸ºæ˜¯å¤±è´¥çš„ã€‚ cat >tcpsocket.yaml æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTCP æ£€æŸ¥çš„é…ç½®ä¸ HTTP æ£€æŸ¥éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯å°†httpGetæ›¿æ¢æˆäº†tcpSocketã€‚ è€Œä¸”æˆ‘ä»¬åŒæ—¶ä½¿ç”¨äº†readiness probeå’Œliveness probeä¸¤ç§æ¢é’ˆã€‚ å®¹å™¨å¯åŠ¨å5ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadiness probeï¼ˆå¯è¯»æ€§æ¢é’ˆï¼‰ã€‚ è¯¥æ¢é’ˆä¼šå»è¿æ¥å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœè¿æ¥æˆåŠŸï¼Œåˆ™è¯¥ Pod å°†è¢«æ ‡è®°ä¸ºå°±ç»ªçŠ¶æ€ã€‚ç„¶åKubeletå°†æ¯éš”10ç§’é’Ÿæ‰§è¡Œä¸€æ¬¡è¯¥æ£€æŸ¥ã€‚ é™¤äº†readiness probeä¹‹å¤–ï¼Œè¯¥é…ç½®è¿˜åŒ…æ‹¬liveness probeã€‚ å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†è¿è¡Œç¬¬ä¸€ä¸ª liveness probeã€‚ å°±åƒreadiness probeä¸€æ ·ï¼Œè¿™å°†å°è¯•å»è¿æ¥åˆ°å®¹å™¨çš„8080ç«¯å£ã€‚å¦‚æœliveness probeå¤±è´¥ï¼Œå®¹å™¨å°†é‡æ–°å¯åŠ¨ã€‚ æœ‰çš„æ—¶å€™ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½æš‚æ—¶æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦åœ¨å¯åŠ¨æœŸé—´åŠ è½½å¤§é‡æ•°æ®æˆ–é…ç½®æ–‡ä»¶ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ ä¸æƒ³æ€æ­»åº”ç”¨ç¨‹åºï¼Œä¹Ÿä¸æƒ³å¯¹å¤–æä¾›æœåŠ¡ã€‚ é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨readiness probeæ¥æ£€æµ‹å’Œå‡è½»è¿™äº›æƒ…å†µã€‚ Podä¸­çš„å®¹å™¨å¯ä»¥æŠ¥å‘Šè‡ªå·±è¿˜æ²¡æœ‰å‡†å¤‡ï¼Œä¸èƒ½å¤„ç†KubernetesæœåŠ¡å‘é€è¿‡æ¥çš„æµé‡ã€‚ ä»ä¸Šé¢çš„YAMLæ–‡ä»¶æˆ‘ä»¬å¯ä»¥çœ‹å‡ºreadiness probeçš„é…ç½®è·Ÿliveness probeå¾ˆåƒï¼ŒåŸºæœ¬ä¸Šä¸€è‡´çš„ã€‚å”¯ä¸€çš„ä¸åŒæ˜¯ä½¿ç”¨readinessProbeè€Œä¸æ˜¯livenessProbeã€‚ä¸¤è€…å¦‚æœåŒæ—¶ä½¿ç”¨çš„è¯å°±å¯ä»¥ç¡®ä¿æµé‡ä¸ä¼šåˆ°è¾¾è¿˜æœªå‡†å¤‡å¥½çš„å®¹å™¨ï¼Œå‡†å¤‡å¥½è¿‡åï¼Œå¦‚æœåº”ç”¨ç¨‹åºå‡ºç°äº†é”™è¯¯ï¼Œåˆ™ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ã€‚ å¦å¤–é™¤äº†ä¸Šé¢çš„initialDelaySecondså’ŒperiodSecondså±æ€§å¤–ï¼Œæ¢é’ˆè¿˜å¯ä»¥é…ç½®å¦‚ä¸‹å‡ ä¸ªå‚æ•°ï¼š timeoutSecondsï¼šæ¢æµ‹è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚ successThresholdï¼šæ¢æµ‹å¤±è´¥åï¼Œæœ€å°‘è¿ç»­æ¢æµ‹æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºæˆåŠŸã€‚é»˜è®¤æ˜¯ 1ï¼Œä½†æ˜¯å¦‚æœæ˜¯livenessåˆ™å¿…é¡»æ˜¯ 1ã€‚æœ€å°å€¼æ˜¯ 1ã€‚ failureThresholdï¼šæ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯ 3ï¼Œæœ€å°å€¼æ˜¯ 1ã€‚ è¿™å°±æ˜¯liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰å’Œreadiness probeï¼ˆå¯è¯»æ€§æ¢é’ˆï¼‰çš„ä½¿ç”¨æ–¹æ³•ã€‚åœ¨Podçš„ç”Ÿå‘½å‘¨æœŸå½“ä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†å®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸­çš„é’©å­å‡½æ•°å’Œæ¢é’ˆæ£€æµ‹ï¼Œä¸‹èŠ‚è¯¾ç»™å¤§å®¶è®²è§£Podå±‚é¢ç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªé˜¶æ®µï¼šåˆå§‹åŒ–å®¹å™¨ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/å›¾è§£kubernetes Podåˆ›å»ºæµç¨‹å¤§æ­ç§˜.html":{"url":"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/å›¾è§£kubernetes Podåˆ›å»ºæµç¨‹å¤§æ­ç§˜.html","title":"k8s åˆ›å»ºpodæµç¨‹","keywords":"","body":"å›¾è§£kubernetes Podåˆ›å»ºæµç¨‹å¤§æ­ç§˜ æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ kubernetesä¸­çš„å®¹å™¨åˆ›å»ºæ— ç–‘æ˜¯ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œæ¶‰åŠå†…éƒ¨å„ç§ç»„ä»¶çš„ç»Ÿä¸€åä½œï¼Œè¿˜æœ‰å¯¹æ¥å¤–éƒ¨çš„CRIè¿è¡Œæ—¶ï¼Œæœ¬æ–‡å°è¯•åˆæ¢ä¸€ä¸‹å®¹å™¨åˆ›å»ºæµç¨‹ä¸­çš„å„ç§ç»†èŠ‚ï¼Œäº†è§£å…¶å„ç§ç»„ä»¶åä½œæµç¨‹ï¼Œä»è€Œåœ¨åç»­å‡ºç°é—®é¢˜çš„æ—¶å€™ï¼Œä¹Ÿå¥½èƒ½å¤§æ¦‚æœ‰ç‚¹æ’æŸ¥æ–¹å‘ 1. åŸºç¡€ç­‘åŸº 1.1 å®¹å™¨ç®¡ç†çº¿ç¨‹æ¨¡å‹ kubeletä¸­çš„çº¿ç¨‹æ¨¡å‹å±äºmaster/wrokeræ¨¡å‹ï¼Œé€šè¿‡å•masteræ¥ç›‘å¬å„ç§äº‹ä»¶æºï¼Œå¹¶ä¸ºæ¯ä¸ªPodåˆ›å»ºä¸€ä¸ªgoroutineæ¥è¿›è¡ŒPodä¸šåŠ¡é€»è¾‘çš„å¤„ç†ï¼Œmasterå’Œwrokerä¹‹é—´é€šè¿‡ä¸€ä¸ªçŠ¶æ€ç®¡é“æ¥è¿›è¡Œé€šä¿¡ 1.2 åŸºäºäº‹ä»¶é©±åŠ¨çš„çŠ¶æ€æœ€ç»ˆä¸€è‡´æ€§ åœ¨é€šè¿‡yamlåˆ›å»ºPodä¹‹åï¼Œkubernetesä¼šæ ¹æ®å½“å‰çš„äº‹ä»¶å’Œå½“å‰çš„PodçŠ¶æ€ï¼Œæ¥ä¸æ–­è¿›è¡Œè°ƒæ•´ï¼Œä»è€Œè¾¾åˆ°æœ€ç»ˆç›®æ ‡çŠ¶æ€çš„ä¸€è‡´æ€§ 1.3 ç»„ä»¶åä½œæµç¨‹ kubeletçš„ç»“æ„ä½“å£°æ˜å°±é«˜è¾¾300å¤šè¡Œä»£ç ï¼Œå¯è§å…¶å¤æ‚ç¨‹åº¦ï¼Œä½†æ˜¯æˆ‘ä»¬æŒ‰ç…§å®¹å™¨åˆ›å»ºè¿™ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬å»è§‚å¯Ÿå…¶æ ¸å¿ƒæµç¨‹ï¼Œå…¶å®ä¸»è¦å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰éƒ¨åˆ†ï¼škubeletã€containerRuntimeã€CRIå®¹å™¨è¿è¡Œæ—¶ 2.Kubeletåˆ›å»ºå®¹å™¨æµç¨‹ 2.1 è·å–Podè¿›è¡Œå‡†å…¥æ£€æŸ¥ kubeletçš„äº‹ä»¶æºä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šé™æ€Podå’ŒApiserverï¼Œæˆ‘ä»¬è¿™é‡Œåªè€ƒè™‘æ™®é€šçš„Podï¼Œåˆ™ä¼šç›´æ¥å°†PodåŠ å…¥åˆ°PodManageræ¥è¿›è¡Œç®¡ç†ï¼Œå¹¶ä¸”è¿›è¡Œå‡†å…¥æ£€æŸ¥ å‡†å…¥æ£€æŸ¥ä¸»è¦åŒ…å«ä¸¤ä¸ªå…³é”®çš„æ§åˆ¶å™¨ï¼šé©±é€ç®¡ç†ä¸é¢„é€‰æ£€æŸ¥é©±é€ç®¡ç†ä¸»è¦æ˜¯æ ¹æ®å½“å‰çš„èµ„æºå‹åŠ›ï¼Œæ£€æµ‹å¯¹åº”çš„Podæ˜¯å¦å®¹å¿å½“å‰çš„èµ„æºå‹åŠ›ï¼›é¢„é€‰æ£€æŸ¥åˆ™æ˜¯æ ¹æ®å½“å‰æ´»è·ƒçš„å®¹å™¨å’Œå½“å‰èŠ‚ç‚¹çš„ä¿¡æ¯æ¥æ£€æŸ¥æ˜¯å¦æ»¡è¶³å½“å‰Podçš„åŸºç¡€è¿è¡Œç¯å¢ƒï¼Œä¾‹å¦‚äº²å’Œæ€§æ£€æŸ¥ï¼ŒåŒæ—¶å¦‚æœå½“å‰çš„Podçš„ä¼˜å…ˆçº§ç‰¹åˆ«é«˜æˆ–è€…æ˜¯é™æ€Podï¼Œåˆ™ä¼šå°è¯•ä¸ºå…¶è¿›è¡Œèµ„æºæŠ¢å ï¼Œä¼šæŒ‰ç…§QOSç­‰çº§é€çº§æ¥è¿›è¡ŒæŠ¢å ä»è€Œæ»¡è¶³å…¶è¿è¡Œç¯å¢ƒ 2.2 åˆ›å»ºäº‹ä»¶ç®¡é“ä¸å®¹å™¨ç®¡ç†ä¸»çº¿ç¨‹ kubeletæ¥æ”¶åˆ°ä¸€ä¸ªæ–°åˆ›å»ºçš„Podé¦–å…ˆä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªäº‹ä»¶ç®¡é“ï¼Œå¹¶ä¸”å¯åŠ¨ä¸€ä¸ªå®¹å™¨ç®¡ç†çš„ä¸»çº¿ç¨‹æ¶ˆè´¹ç®¡é“é‡Œé¢çš„äº‹ä»¶ï¼Œå¹¶ä¸”ä¼šåŸºäºæœ€ååŒæ­¥æ—¶é—´æ¥ç­‰å¾…å½“å‰kubeletä¸­æœ€æ–°å‘ç”Ÿçš„äº‹ä»¶(ä»æœ¬åœ°çš„podCacheä¸­è·å–)ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ–°å»ºçš„Podï¼Œåˆ™ä¸»è¦æ˜¯é€šè¿‡PLEGä¸­æ›´æ–°æ—¶é—´æ“ä½œï¼Œå¹¿æ’­çš„é»˜è®¤ç©ºçŠ¶æ€æ¥ä½œä¸ºæœ€æ–°çš„çŠ¶æ€ 2.3 åŒæ­¥æœ€æ–°çŠ¶æ€ å½“ä»æœ¬åœ°çš„podCacheä¸­è·å–åˆ°æœ€æ–°çš„çŠ¶æ€ä¿¡æ¯å’Œä»äº‹ä»¶æºè·å–çš„Podä¿¡æ¯åï¼Œä¼šç»“åˆå½“å‰å½“å‰statusManagerå’ŒprobeManageré‡Œé¢çš„Podé‡Œé¢çš„å®¹å™¨çŠ¶æ€æ¥æ›´æ–°ï¼Œä»è€Œè·å–å½“å‰æ„ŸçŸ¥åˆ°çš„æœ€æ–°çš„PodçŠ¶æ€ 2.4 å‡†å…¥æ§åˆ¶æ£€æŸ¥ ä¹‹å‰çš„å‡†å…¥æ£€æŸ¥æ˜¯Podè¿è¡Œçš„èµ„æºç¡¬æ€§é™åˆ¶çš„æ£€æŸ¥ï¼Œè€Œè¿™é‡Œçš„å‡†å…¥æ£€æŸ¥åˆ™æ˜¯è½¯çŠ¶æ€å³å®¹å™¨è¿è¡Œæ—¶å’Œç‰ˆæœ¬çš„ä¸€äº›è½¯ä»¶è¿è¡Œç¯å¢ƒæ£€æŸ¥ï¼Œå¦‚æœè¿™é‡Œæ£€æŸ¥å¤±è´¥ï¼Œåˆ™ä¼šè®²å¯¹åº”çš„å®¹å™¨çŠ¶æ€è®¾ç½®ä¸ºBlocked 2.5 æ›´æ–°å®¹å™¨çŠ¶æ€ åœ¨é€šè¿‡å‡†å…¥æ£€æŸ¥ä¹‹åï¼Œä¼šè°ƒç”¨statusManageræ¥è¿›è¡ŒPOdæœ€æ–°çŠ¶æ€çš„åŒæ­¥ï¼Œæ­¤å¤„å¯èƒ½ä¼šåŒæ­¥ç»™apiserver 2.6 Cgroupé…ç½® åœ¨æ›´æ–°å®ŒæˆçŠ¶æ€ä¹‹åä¼šå¯åŠ¨ä¸€ä¸ªPodCOntainerManagerä¸»è¦ä½œç”¨åˆ™æ˜¯ä¸ºå¯¹åº”çš„Podæ ¹æ®å…¶QOSç­‰çº§æ¥è¿›è¡ŒCgroupé…ç½®çš„æ›´æ–° 2.7PodåŸºç¡€è¿è¡Œç¯å¢ƒå‡†å¤‡ æ¥ä¸‹æ¥kubeletä¼šä¸ºPodçš„åˆ›å»ºå‡†å¤‡åŸºç¡€çš„ç¯å¢ƒï¼ŒåŒ…æ‹¬Podæ•°æ®ç›®å½•çš„åˆ›å»ºã€é•œåƒç§˜é’¥çš„è·å–ã€ç­‰å¾…volumeæŒ‚è½½å®Œæˆç­‰æ“ä½œåˆ›å»ºPodçš„æ•°æ®ç›®å½•ä¸»è¦æ˜¯åˆ›å»º Podè¿è¡Œæ‰€éœ€è¦çš„Podã€æ’ä»¶ã€Volumeç›®å½•ï¼Œå¹¶ä¸”ä¼šé€šè¿‡Podé…ç½®çš„é•œåƒæ‹‰å–ç§˜é’¥ç”Ÿæˆç§˜é’¥ä¿¡æ¯ï¼Œåˆ°æ­¤kubeletåˆ›å»ºå®¹å™¨çš„å·¥ä½œå°±å·²ç»åŸºæœ¬å®Œæˆ 3.ContainerRuntime å‰é¢æˆ‘ä»¬æåˆ°è¿‡é’ˆå¯¹Podçš„æ“ä½œï¼Œæœ€ç»ˆéƒ½æ˜¯åŸºäºäº‹ä»¶å’ŒçŠ¶æ€çš„åŒæ­¥è€Œå®Œæˆï¼Œåœ¨containerRUntimeå¹¶ä¸ä¼šåŒºåˆ†å¯¹åº”çš„äº‹ä»¶æ˜¯åˆ›å»ºè¿˜æ˜¯æ›´æ–°æ“ä½œï¼Œåªæ˜¯æ ¹æ®å½“å‰çš„Podçš„ä¿¡æ¯ä¸ç›®æ ‡çŠ¶æ€æ¥è¿›è¡Œå¯¹æ¯”ï¼Œä»è€Œæ„å»ºå‡ºå¯¹åº”çš„æ“ä½œï¼Œè¾¾åˆ°ç›®æ ‡çŠ¶æ€ 3.1 è®¡ç®—Podå®¹å™¨å˜æ›´ è®¡ç®—å®¹å™¨å˜æ›´ä¸»è¦åŒ…æ‹¬ï¼šPodçš„sandboxæ˜¯å¦å˜æ›´ã€çŸ­å£°æ˜å‘¨æœŸå®¹å™¨ã€åˆå§‹åŒ–å®¹å™¨æ˜¯å¦å®Œæˆã€ä¸šåŠ¡å®¹å™¨æ˜¯å¦å·²ç»å®Œæˆï¼Œç›¸åº”çš„æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªå‡ ä¸ªå¯¹åº”çš„å®¹å™¨åˆ—è¡¨ï¼šéœ€è¦è¢«killæ‰çš„å®¹å™¨åˆ—è¡¨ã€éœ€è¦å¯åŠ¨çš„å®¹å™¨åˆ—è¡¨ï¼Œæ³¨æ„å¦‚æœæˆ‘ä»¬çš„åˆå§‹åŒ–å®¹å™¨æœªå®Œæˆï¼Œåˆ™ä¸ä¼šè¿›è¡Œå°†è¦è¿è¡Œçš„ä¸šåŠ¡å®¹å™¨åŠ å…¥åˆ°éœ€è¦å¯åŠ¨çš„å®¹å™¨åˆ—è¡¨ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªåœ°æ–¹æ˜¯ä¸¤ä¸ªé˜¶æ®µ 3.2 åˆå§‹åŒ–å¤±è´¥å°è¯•ç»ˆæ­¢ å¦‚æœä¹‹å‰æ£€æµ‹åˆ°ä¹‹å‰çš„åˆå§‹åŒ–å®¹å™¨å¤±è´¥ï¼Œåˆ™ä¼šæ£€æŸ¥å½“å‰Podçš„æ‰€æœ‰å®¹å™¨å’Œsandboxå…³è”çš„å®¹å™¨å¦‚æœæœ‰åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œä¼šå…¨éƒ¨è¿›è¡ŒKillæ“ä½œï¼Œå¹¶ä¸”ç­‰å¾…æ“ä½œå®Œæˆ 3.3 æœªçŸ¥çŠ¶æ€å®¹å™¨è¡¥å¿ å½“ä¸€äº›Podçš„å®¹å™¨å·²ç»è¿è¡Œï¼Œä½†æ˜¯å…¶çŠ¶æ€ä»ç„¶æ˜¯Unknowçš„æ—¶å€™ï¼Œåœ¨è¿™ä¸ªåœ°æ–¹ä¼šè¿›è¡Œç»Ÿä¸€çš„å¤„ç†ï¼Œå…¨éƒ¨killæ‰ï¼Œä»è€Œä¸ºæ¥ä¸‹æ¥çš„é‡æ–°å¯åŠ¨åšæ¸…ç†æ“ä½œï¼Œæ­¤å¤„å’Œ3.2åªä¼šè¿›è¡Œä¸€ä¸ªåˆ†æ”¯ï¼Œä½†æ ¸å¿ƒçš„ç›®æ ‡éƒ½æ˜¯æ¸…ç†é‚£äº›è¿è¡Œå¤±è´¥æˆ–è€…æ— æ³•è·å–çŠ¶æ€çš„å®¹å™¨ 3.4 åˆ›å»ºå®¹å™¨æ²™ç®± åœ¨å¯åŠ¨Podçš„å®¹å™¨ä¹‹å‰ï¼Œé¦–å…ˆä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªsandboxå®¹å™¨ï¼Œå½“å‰Podçš„æ‰€æœ‰å®¹å™¨éƒ½å’ŒPodå¯¹åº”çš„sandboxå…±äº«åŒä¸€ä¸ªnamespaceä»è€Œå…±äº«ä¸€ä¸ªnamespaceé‡Œé¢çš„èµ„æºï¼Œåˆ›å»ºSandboxæ¯”è¾ƒå¤æ‚ï¼Œåç»­ä¼šç»§ç»­ä»‹ç» 3.5 å¯åŠ¨Podç›¸å…³å®¹å™¨ Podçš„å®¹å™¨ç›®å‰åˆ†ä¸ºä¸‰å¤§ç±»ï¼šçŸ­ç”Ÿå‘½å‘¨æœŸå®¹å™¨ã€åˆå§‹åŒ–å®¹å™¨ã€ä¸šåŠ¡å®¹å™¨ï¼Œå¯åŠ¨é¡ºåºä¹Ÿæ˜¯ä»å·¦åˆ°å³ä¾æ¬¡è¿›è¡Œ,å¦‚æœå¯¹äºçš„å®¹å™¨åˆ›å»ºå¤±è´¥ï¼Œåˆ™ä¼šé€šè¿‡backoffæœºåˆ¶æ¥å»¶ç¼“å®¹å™¨çš„åˆ›å»ºï¼Œè¿™é‡Œæˆ‘ä»¬é¡ºä¾¿ä»‹ç»ä¸‹containerRuntimeå¯åŠ¨å®¹å™¨çš„æµç¨‹ 3.5.1 æ£€æŸ¥å®¹å™¨é•œåƒæ˜¯å¦æ‹‰å– é•œåƒçš„æ‹‰å–é¦–å…ˆä¼šè¿›è¡Œå¯¹åº”å®¹å™¨é•œåƒçš„æ‹¼æ¥ï¼Œç„¶åå°†ä¹‹å‰è·å–çš„æ‹‰å–çš„ç§˜é’¥ä¿¡æ¯å’Œé•œåƒä¿¡æ¯ï¼Œä¸€èµ·äº¤ç»™CRIè¿è¡Œæ—¶æ¥è¿›è¡Œåº•å±‚å®¹å™¨é•œåƒçš„æ‹‰å–ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿä¼šå„ç§backoffæœºåˆ¶ï¼Œä»è€Œé¿å…é¢‘ç¹æ‹‰å–å¤±è´¥å½±å“kubeletçš„æ€§èƒ½ 3.5.2 åˆ›å»ºå®¹å™¨é…ç½® åˆ›å»ºå®¹å™¨é…ç½®ä¸»è¦æ˜¯ä¸ºäº†å®¹å™¨çš„è¿è¡Œåˆ›å»ºå¯¹åº”çš„é…ç½®æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ï¼šPodçš„ä¸»æœºåã€åŸŸåã€æŒ‚è½½çš„volumeã€configMapã€secretã€ç¯å¢ƒå˜é‡ã€æŒ‚è½½çš„è®¾å¤‡ä¿¡æ¯ã€è¦æŒ‚è½½çš„ç›®å½•ä¿¡æ¯ã€ç«¯å£æ˜ å°„ä¿¡æ¯ã€æ ¹æ®ç¯å¢ƒç”Ÿæˆæ‰§è¡Œçš„å‘½ä»¤ã€æ—¥å¿—ç›®å½•ç­‰ä¿¡æ¯ 3.5.3 è°ƒç”¨runtimeServiceå®Œæˆå®¹å™¨çš„åˆ›å»º è°ƒç”¨runtimeServiceä¼ é€’å®¹å™¨çš„é…ç½®ä¿¡æ¯ï¼Œè°ƒç”¨CRIï¼Œå¹¶ä¸”æœ€ç»ˆè°ƒç”¨å®¹å™¨çš„åˆ›å»ºæ¥å£å®Œæˆå®¹å™¨çš„çŠ¶æ€ 3.5.4 è°ƒç”¨runtimeServiceå¯åŠ¨å®¹å™¨ é€šè¿‡ä¹‹å‰åˆ›å»ºå®¹å™¨è¿”å›çš„å®¹å™¨IDï¼Œæ¥è¿›è¡Œå¯¹åº”çš„å®¹å™¨çš„å¯åŠ¨ï¼Œå¹¶ä¸”ä¼šä¸ºå®¹å™¨åˆ›å»ºå¯¹åº”çš„æ—¥å¿—ç›®å½• 3.5.5 æ‰§è¡Œå®¹å™¨çš„å›è°ƒé’©å­ å¦‚æœå®¹å™¨é…ç½®äº†PostStarté’©å­ï¼Œåˆ™ä¼šåœ¨æ­¤å¤„è¿›è¡Œå¯¹åº”é’©å­çš„æ‰§è¡Œï¼Œå¦‚æœé’©å­çš„ç±»å‹æ˜¯Execç±»åˆ™ä¼šè°ƒç”¨CNIçš„EXecæ¥å£å®Œæˆåœ¨å®¹å™¨å†…çš„æ‰§è¡Œ 4. è¿è¡Œæ²™ç®±å®¹å™¨ 4.1 æ‹‰å–sandboxé•œåƒ é¦–å…ˆä¼šæ‹‰å–sandboxé•œåƒ 4.2 åˆ›å»ºæ²™ç®±å®¹å™¨ 4.2.1 åº”ç”¨SecurityContext åœ¨åˆ›å»ºå®¹å™¨ä¹‹å‰ä¼šå…ˆæ ¹æ®SecurityContexté‡Œé¢çš„é…èµ„ä¿¡æ¯ï¼Œæ¥è¿›è¡Œå®¹å™¨SecurityContextçš„é…ç½®ï¼Œä¸»è¦åŒ…æ‹¬ç‰¹æƒç­‰çº§ã€åªè¯»ç›®å½•ã€è¿è¡Œè´¦æˆ·ç»„ç­‰ä¿¡æ¯ 4.2 å…¶ä½™åŸºç¡€ä¿¡æ¯ é™¤äº†åº”ç”¨SecurityContextè¿˜ä¼šè¿›è¡Œæ–­å¼€ã€OOMScoreAdjã€Cgroupé©±åŠ¨ç­‰ä¿¡æ¯çš„æ˜ å°„ 4.3 åˆ›å»ºå®¹å™¨ æ ¹æ®ä¸Šé¢çš„å„ç§é…ç½®ä¿¡æ¯æ¥è¿›è¡Œå®¹å™¨çš„åˆ›å»º 4.3 åˆ›å»ºcheckpoint checkpointä¸»è¦æ˜¯å°†å½“å‰sandboxçš„é…ç½®ä¿¡æ¯è¿›è¡Œåºåˆ—åŒ–ï¼Œå¹¶ä¸”å­˜å‚¨å…¶å½“å‰çš„å¿«ç…§ä¿¡æ¯ 4.4 å¯åŠ¨sandboxå®¹å™¨ å¯åŠ¨sandboxå®¹å™¨åˆ™ä¼šç›´æ¥è°ƒç”¨StartContaineråŒæ—¶ä¼ å…¥ä¹‹å‰åˆ›å»ºå®¹å™¨è¿”å›çš„IDå®Œæˆå®¹å™¨çš„å¯åŠ¨ï¼Œå¹¶ä¸”æ­¤æ—¶ä¼šé‡å†™è¦†ç›–å®¹å™¨çš„dnsé…ç½®æ–‡ä»¶ 4.5 å®¹å™¨ç½‘ç»œè®¾ç½® å®¹å™¨çš„ç½‘ç»œé…ç½®ä¸»è¦æ˜¯è°ƒç”¨CNIæ’ä»¶æ¥å®Œæˆå®¹å™¨ç½‘ç»œçš„é…ç½®ï¼Œè¿™é‡Œå°±å…ˆä¸å±•å¼€äº† 5. Podå®¹å™¨å¯åŠ¨æ€»ç»“ kubeletæ˜¯å®¹å™¨ç®¡ç†çš„æ ¸å¿ƒå¤§ç®¡å®¶ï¼Œå…¶è´Ÿè´£å„ç§å‡†å…¥æ§åˆ¶ã€çŠ¶æ€ç®¡ç†ã€æ¢æµ‹ç®¡ç†ã€volumeç®¡ç†ã€QOSç®¡ç†ã€CSIå¯¹æ¥çš„ç»Ÿä¸€è°ƒåº¦ï¼Œå¹¶ä¸”ä¸ºRuntimeè¿è¡Œæ—¶å‡†å¤‡åŸºç¡€çš„æ•°æ®å’Œå¹¶åé¦ˆPodå½“å‰çš„æœ€æ–°çŠ¶æ€ Runtimeå±‚åˆ™å°†kubeletç»„è£…çš„æ•°æ®ï¼ŒæŒ‰ç…§CRIè¿è¡Œæ—¶çš„ç›®æ ‡é…ç½®å’Œkubeletç®¡ç†çš„èµ„æºé…ç½®ä¿¡æ¯æ¥è¿›è¡Œèµ„æºçš„é‡ç»„ï¼Œå¹¶ä¸”æ ¹æ®Podçš„å®¹å™¨çš„çŠ¶æ€æ¥å†³ç­–å®¹å™¨çš„å¯åœã€åˆ›å»ºç­‰æ“ä½œï¼Œå¹¶å®Œæˆå®¹å™¨çš„åŸºç¡€é…ç½®ç¯å¢ƒçš„æ„å»ºï¼Œå¹¶æœ€ç»ˆè°ƒç”¨CRIå®Œæˆå®¹å™¨çš„åˆ›å»ºï¼Œè€ŒCRIè¿è¡Œæ—¶ï¼Œåˆ™ä¼šè®²ä¼ é€’è¿‡æ¥çš„å„ç§æ•°æ®è¿›è¡Œè¿›ä¸€æ­¥çš„ç»„åˆï¼Œå¹¶åº”ç”¨åˆ°ä¸»æœºå’Œå¯¹åº”çš„namespaceèµ„æºé™åˆ¶ï¼Œå¹¶æ ¹æ®è‡ªå·±çš„å®¹å™¨æœåŠ¡ç»„ç»‡æ•°æ®ï¼Œè°ƒç”¨å®¹å™¨æœåŠ¡å®Œæˆå®¹å™¨çš„æœ€ç»ˆåˆ›å»º æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/Podåˆ›å»ºæµç¨‹ä»£ç ç‰ˆæœ¬kubeletç¯‡.html":{"url":"linux/k8s/k8sèµ„æºå¯¹è±¡/pod/Podåˆ›å»ºæµç¨‹ä»£ç ç‰ˆæœ¬kubeletç¯‡.html","title":"podåˆ›å»ºæµç¨‹ä»£ç ç‰ˆæœ¬kubeletç¯‡","keywords":"","body":"Podåˆ›å»ºæµç¨‹ä»£ç ç‰ˆæœ¬kubeletç¯‡ æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ 1. å‰è¨€ åœ¨k8sçš„é¢è¯•ä¸­Podçš„åˆ›å»ºæµç¨‹æ˜¯ä¸€ä¸ªå¸¸é—®çš„é—®é¢˜ï¼Œè€Œkubeletåˆ™æ— ç–‘é‡ä¸­ä¹‹é‡ï¼Œä¹‹å‰ä¹Ÿå†™è¿‡ä¸€ç¯‡Podçš„è¿è¡Œï¼Œä¸è¿‡æ²¡æœ‰æ¶‰åŠåˆ°å…·ä½“çš„ä»£ç ï¼Œæœ¬æ–‡å°è¯•ç”¨ä»£ç çš„æ–¹å¼ï¼Œæ¥å¤æ•°æ•´ä¸ªæ ¸å¿ƒçš„æµç¨‹ï¼ŒåŒæ—¶ä¸ºäº†æ–¹ä¾¿è®°å¿†ï¼Œåˆå°†æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºï¼šå‡†å¤‡ã€é…ç½®ã€æ¸…ç†ã€æ„å»ºè¿è¡Œå››ä¸ªé˜¶æ®µï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹å§ï¼Œ æ–‡æœ«æœ‰å¤§å›¾æ€»ç»“ 2. å‡†å¤‡é˜¶æ®µ å½“è·å–åˆ°Podæ·»åŠ çš„äº‹ä»¶çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè¿›è¡Œä¸€äº›åŸºç¡€çš„å·¥ä½œï¼Œæˆ‘å§è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå‡†å¤‡é˜¶æ®µï¼Œå‡†å¤‡é˜¶æ®µä¸»è¦åšçš„äº‹æƒ…æœ‰å¦‚ä¸‹ï¼š1ï¼‰åŠ å…¥PodManager 2ï¼‰å‡†å…¥æ§åˆ¶æ£€æŸ¥ 3ï¼‰åˆ†å‘äº‹ä»¶ 4ï¼‰æ ¹æ®Podæ·»åŠ å¯¹åº”çš„æ¢é’ˆï¼Œ è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹å…³é”®å®ç° 2.1 åŠ å…¥PodManager PodManagerä¸­çš„åŠŸèƒ½é™¤äº†å­˜å‚¨Podçš„ä¿¡æ¯ï¼Œè¿˜ä¼šè¿›è¡Œå¯¹åº”Podçš„configMapå’Œsecretçš„ç®¡ç†ï¼Œå½“å¿ƒåŠ å…¥Podçš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥å¯¹åº”çš„Podæ˜¯å¦æœ‰å¯¹åº”çš„configMapå’Œsecreté…ç½®ï¼Œå¦‚æœæœ‰åˆ™å°±ä¼šåˆ›å»ºå¯¹åº”çš„ç›‘å¬å™¨ï¼Œç›‘å¬èµ„æºçš„å˜åŒ–ï¼Œè¿›è¡Œæœ¬åœ°ç¼“å­˜ é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœå¯¹åº”çš„Podçš„BootstrapCheckpointAnnotationKeyæœ‰è®¾å®šï¼Œåˆ™è¿˜ä¼šåˆ›å»ºå¯¹åº”çš„checkpoint,å³å°†podçš„é…ç½®æ•°æ®å†™å…¥åˆ°æœ¬åœ°ç£ç›˜ kl.podManager.AddPod(pod) 2.2 å‡†å…¥æ§åˆ¶æ£€æŸ¥ å‡†å…¥æ§åˆ¶æ£€æŸ¥ä¸»è¦æ˜¯åœ¨è¿è¡ŒPodä¹‹å‰åœ¨kubeletä¸Šè¿›è¡ŒPodè¿è¡Œæ¡ä»¶çš„æ£€æŸ¥ï¼Œæ£€æŸ¥å½“å‰èŠ‚ç‚¹åœ¨schedulerå†³ç­–å®Œæˆååˆ°æ„ŸçŸ¥åˆ°Podè¿è¡Œè¿™æ®µæ—¶é—´èµ„æºæ˜¯å¦ä¾æ—§æ»¡è¶³ï¼Œå¹¶ä¸”æ£€æŸ¥Podçš„ä¸€äº›ç‰¹æ®Šèµ„æºæ¯”å¦‚æ¯”å¦‚sysctlã€securityç­‰æ£€æŸ¥ï¼Œè¿™é‡Œæˆ‘æ„Ÿè§‰æ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªåˆ†åˆ«æ˜¯evictionå’Œpredicate, å¦‚æœä¸æ»¡è¶³å‡†å…¥æ£€æŸ¥ï¼Œåˆ™ä¼šç›´æ¥æ‹’ç» 2.2.1 evictionå‡†å…¥æ£€æŸ¥ å¦‚æœå½“å‰èŠ‚ç‚¹åªå­˜åœ¨å†…å­˜å‹åŠ›ï¼Œåˆ™ä¼šæ ¹æ®å¯¹åº”çš„Podçš„QOSç­‰çº§æ¥åˆ¤æ–­ï¼Œå¦‚æœè¯´ä¸æ˜¯BestEffortæˆ–è€…å®¹å¿å†…å­˜å‹åŠ›çš„æ±¡ç‚¹ï¼Œåˆ™ä¼šå…è®¸ï¼Œå¦åˆ™åˆ™ä¼šæ‹’ç»è¿è¡Œ nodeOnlyHasMemoryPressureCondition := hasNodeCondition(m.nodeConditions, v1.NodeMemoryPressure) && len(m.nodeConditions) == 1 if nodeOnlyHasMemoryPressureCondition { // å¦‚æœä¸æ˜¯PodQOSBestEffort, åˆ™éƒ½ä¼šå°è¯•è¿è¡Œ notBestEffort := v1.PodQOSBestEffort != v1qos.GetPodQOS(attrs.Pod) if notBestEffort { return lifecycle.PodAdmitResult{Admit: true} } // å¦‚æœå¯¹åº”çš„Podå®¹å¿å†…å­˜å‹åŠ›çš„æ±¡ç‚¹ï¼Œåˆ™å°±å¯ä»¥ç»§ç»­è¿›è¡Œå…¶ä»–å‡†å…¥æ§åˆ¶å™¨çš„æ£€æŸ¥ if v1helper.TolerationsTolerateTaint(attrs.Pod.Spec.Tolerations, &v1.Taint{ Key: v1.TaintNodeMemoryPressure, Effect: v1.TaintEffectNoSchedule, }) { return lifecycle.PodAdmitResult{Admit: true} } } 2.2.2 predicateå‡†å…¥æ£€æŸ¥ predicateå‡†å…¥æ§åˆ¶å™¨ä¸­çš„é€»è¾‘ä¸»è¦æ˜¯åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š1ï¼‰æ£€æŸ¥å¯¹åº”çš„èµ„æºæ˜¯å¦æ»¡è¶³åˆ†é…è¯·æ±‚ï¼ŒåŒæ—¶ä¼šè®°å½•ç¼ºå°‘çš„èµ„æº2ï¼‰å¦‚æœæ˜¯Criticalç±»å‹çš„Podåˆ™ä¼šæŒ‰ç…§QOSç­‰çº§æ¥è¿›è¡Œèµ„æºçš„æŠ¢å ï¼Œæ»¡è¶³è¿™äº›é«˜ä¼˜å…ˆçš„Podè¿™é‡Œçš„Criticalç±»å‹çš„Podä¸»è¦åŒ…å«å¦‚ä¸‹ä¸‰ç±»ï¼šé™æ€Podã€é•œåƒPodã€é«˜ä¼˜å…ˆPod(ä¼˜å…ˆçº§é«˜äº2000000000) func (w *predicateAdmitHandler) Admit(attrs *PodAdmitAttributes) PodAdmitResult { node, err := w.getNodeAnyWayFunc() // è¸¢å‡ºæ‰©å±•èµ„æºï¼Œåªè¿›è¡Œå†…å­˜å’ŒCPUèµ„æºçš„æ£€æŸ¥ podWithoutMissingExtendedResources := removeMissingExtendedResources(admitPod, nodeInfo) // è¿›è¡Œé¢„é€‰ç®—æ³•ç­›é€‰ï¼Œ ç­›é€‰å‡ºé‚£äº›èµ„æºä¸è¶³çš„èµ„æº fit, reasons, err := predicates.GeneralPredicates(podWithoutMissingExtendedResources, nil, nodeInfo) if !fit { // å¦‚æœé¢„é€‰å¤±è´¥ï¼Œåˆ™å°è¯•è¿›è¡ŒæŠ¢å  fit, reasons, err = w.admissionFailureHandler.HandleAdmissionFailure(admitPod, reasons) } } 2.3 æ¢é’ˆç®¡ç† k8sé‡Œé¢çš„æ¢é’ˆä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼šstartupã€readinessã€livenessï¼Œåœ¨Podé€šè¿‡å‡†å…¥æ§åˆ¶æ£€æŸ¥åï¼Œä¼šæ ¹æ®Podçš„æ¢é’ˆé…ç½®åˆ›å»ºå¯¹åº”çš„æ¢é’ˆï¼Œä½†æ˜¯è¿™é‡Œçš„æ¢é’ˆå¹¶ä¸ä¼šçœŸæ­£çš„è¿›è¡Œæ¢æµ‹ï¼Œå› ä¸ºå½“å‰è¿˜æ— æ³•æ„ŸçŸ¥åˆ°å¯¹åº”çš„podçš„çŠ¶æ€ kl.probeManager.AddPod(pod) 2.4 åˆ†å‘äº‹ä»¶ åœ¨kubeletä¸­ä¼šä¸ºæ¯ä¸ªPodéƒ½åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„goroutineå’Œäº‹ä»¶ç®¡é“ï¼Œåç»­æ–°çš„äº‹ä»¶ä¹Ÿéƒ½é€šè¿‡ç®¡é“å‘é€ç»™å¯¹åº”çš„goroutine func (p *podWorkers) UpdatePod(options *UpdatePodOptions) { // è·å–podä¿¡æ¯ pod := options.Pod uid := pod.UID var podUpdates chan UpdatePodOptions var exists bool p.podLock.Lock() defer p.podLock.Unlock() // kubeletä¼šä¸ºæ¯ä¸ªpodåˆ›å»ºä¸€ä¸ªgoroutine, å¹¶ä¸”é€šè¿‡ç®¡é“æ¥è¿›è¡Œé€šä¿¡ if podUpdates, exists = p.podUpdates[uid]; !exists { podUpdates = make(chan UpdatePodOptions, 1) p.podUpdates[uid] = podUpdates // ä¸ºå½“å‰podå¯åŠ¨ä¸€ä¸ªgoroutine go func() { defer runtime.HandleCrash() p.managePodLoop(podUpdates) }() } if !p.isWorking[pod.UID] { p.isWorking[pod.UID] = true // æ›´æ–°Podçš„äº‹ä»¶å‘é€åˆ°ç®¡é“ podUpdates è‡³æ­¤ä¸€ä¸ªPodçš„å¯åŠ¨çš„å‡†å¤‡é˜¶æ®µå°±åŸºæœ¬å®Œæˆäº†ï¼Œæ£€æŸ¥è¿è¡Œç¯å¢ƒã€æ‹‰å–å¯¹åº”çš„cofnigMapå’Œsecretèµ„æºã€åˆ›å»ºæ¢é’ˆã€å¯åŠ¨è´Ÿè´£PodçŠ¶æ€ç»´æŠ¤çš„çº¿ç¨‹ï¼Œè‡³æ­¤å‡†å¤‡é˜¶æ®µå®Œæˆ 3.é…ç½®é˜¶æ®µ åœ¨kubeletæœ€ç»ˆçš„çŠ¶æ€åŒæ­¥éƒ½æ˜¯ç”±syncPodæ¥å®Œæˆï¼Œè¯¥å‡½æ•°ä¼šæ ¹æ®ä¼ é€’è¿›æ¥çš„ç›®æ ‡çŠ¶æ€å’ŒPodçš„å½“å‰çŠ¶æ€æ¥è¿›è¡Œå†³ç­–ï¼Œä»è€Œæ»¡è¶³ç›®æ ‡çŠ¶æ€ï¼Œå› ä¸ºå†…éƒ¨é€»è¾‘çš„å¤æ‚ï¼Œä¼šåˆ†ä¸ºï¼šé…ç½®é˜¶æ®µã€æ¸…ç†é˜¶æ®µã€æ„å»ºè¿è¡Œé˜¶æ®µï¼Œè¿™é‡Œå…ˆçœ‹ä¸‹é…ç½®é˜¶æ®µ é…ç½®é˜¶æ®µä¸»è¦æ˜¯è·å–å½“å‰çš„PodçŠ¶æ€ã€åº”ç”¨CGOUPé…ç½®ã€Podæ•°æ®ç›®å½•æ„å»ºã€ç­‰å¾…VOlumeæŒ‚è½½ã€è·å–é•œåƒæ‹‰å–çš„secretç­‰ 3.1 è®¡ç®—Podçš„çŠ¶æ€ Podçš„çŠ¶æ€æ•°æ®ä¸»è¦åŒ…å«å½“å‰é˜¶æ®µã€Conditions(å®¹å™¨Conditionã€åˆå§‹åŒ–å®¹å™¨Conditionã€PodReadyCondition),è€Œè¿™äº›çŠ¶æ€åˆ™éœ€è¦æ ¹æ®å½“å‰çš„PodStatusé‡Œé¢çš„çŠ¶æ€è®¡ç®—ï¼Œè¿˜æœ‰probeManageré‡Œé¢æ¢æµ‹çš„æ•°æ®ä¸¤éƒ¨åˆ†å…±åŒå®Œæˆ func (kl *Kubelet) generateAPIPodStatus(pod *v1.Pod, podStatus *kubecontainer.PodStatus) v1.PodStatus { allStatus := append(append([]v1.ContainerStatus{}, s.ContainerStatuses...), s.InitContainerStatuses...) // æ ¹æ®Podçš„å®¹å™¨çŠ¶æ€ï¼Œè®¾å®šå½“å‰çš„çš„é˜¶æ®µ s.Phase = getPhase(spec, allStatus) kl.probeManager.UpdatePodStatus(pod.UID, s) s.Conditions = append(s.Conditions, status.GeneratePodInitializedCondition(spec, s.InitContainerStatuses, s.Phase)) s.Conditions = append(s.Conditions, status.GeneratePodReadyCondition(spec, s.Conditions, s.ContainerStatuses, s.Phase)) s.Conditions = append(s.Conditions, status.GenerateContainersReadyCondition(spec, s.ContainerStatuses, s.Phase)) return *s } 3.2 è¿è¡Œç¯å¢ƒå‡†å…¥æ£€æŸ¥ è¯¥è¿è¡Œç¯å¢ƒæ˜¯æŒ‡çš„ä¸€äº›è½¯ä»¶çŠ¶æ€çš„ï¼Œè¿™é‡Œä¸»è¦æ¶‰åŠåˆ°Appmorã€ç‰¹æƒæ¨¡å¼ã€procæŒ‚è½½ï¼Œå®ç°æœºåˆ¶å°±æ˜¯æ£€æµ‹å¯¹åº”çš„Podæ˜¯å¦éœ€è¦å¯¹åº”çš„æ“ä½œï¼Œå¹¶ä¸”SecurityContextä¸­æ˜¯å¦å…è®¸å¯¹åº”çš„æ“ä½œï¼Œä»è€Œç¡®å®šPodæ˜¯å¦èƒ½å¤Ÿè¿›è¡Œè¿è¡Œ func (kl *Kubelet) canRunPod(pod *v1.Pod) lifecycle.PodAdmitResult { // å‡†å…¥æ§åˆ¶æ’ä»¶ for _, handler := range kl.softAdmitHandlers { if result := handler.Admit(attrs); !result.Admit { return result } } return lifecycle.PodAdmitResult{Admit: true} } 3.3 æ›´æ–°çŠ¶æ€ æ›´æ–°çŠ¶æ€ä¸»è¦æ˜¯ä¸ºäº†probeManageræ¥è¿›è¡ŒçŠ¶æ€æ£€æŸ¥çš„ï¼Œå¦‚æœprobeManageræ— æ³•è·å–åˆ°å¯¹åº”çš„çŠ¶æ€ï¼Œå°±ä¸ä¼šæ‰§è¡Œå¯¹åº”çš„å¥åº·æ¢é’ˆçš„æ£€æŸ¥ï¼Œè¿™é‡Œçš„çŠ¶æ€å°±æ˜¯æ ¹æ®ä¹‹å‰çš„å„ç§è®¡ç®—åœ¨kubeletä¸Šå¯¹åº”Podçš„å½“å‰çŠ¶æ€ kl.statusManager.SetPodStatus(pod, apiPodStatus) 3.4 ç½‘ç»œè¿è¡Œæ—¶æ£€æŸ¥ if err := kl.runtimeState.networkErrors(); err != nil && !kubecontainer.IsHostNetworkPod(pod) { kl.recorder.Eventf(pod, v1.EventTypeWarning, events.NetworkNotReady, \"%s: %v\", NetworkNotReadyErrorMsg, err) return fmt.Errorf(\"%s: %v\", NetworkNotReadyErrorMsg, err) } 3.5 CGroupé…ç½® Cgroupçš„é…ç½®ä¸»è¦æ˜¯æŒ‰ç…§QOSç­‰çº§æ¥è¿›è¡Œcgroupç›®å½•çš„æ„å»ºï¼Œå¹¶ä¸”æ›´æ–°å½“å‰Podçš„é…ç½® pcm := kl.containerManager.NewPodContainerManager() // cgroupåº”ç”¨cgroup if !kl.podIsTerminated(pod) { podKilled := false if !pcm.Exists(pod) && !firstSync { // å¦‚æœå¯¹äºçš„cgroupä¸å­˜åœ¨ï¼Œå¹¶ä¸”ä¹Ÿä¸æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œå°±å…ˆå°†ä¹‹å‰çš„podæ²™é›• if err := kl.killPod(pod, nil, podStatus, nil); err == nil { podKilled = true } } if !(podKilled && pod.Spec.RestartPolicy == v1.RestartPolicyNever) { if !pcm.Exists(pod) { // æ›´æ–°qoscgroupè®¾ç½® if err := kl.containerManager.UpdateQOSCgroups(); err != nil { } // æ›´æ–°poddeçš„cgroupé…ç½® if err := pcm.EnsureExists(pod); err != nil { } } } } 3.6 é•œåƒPodçš„æ£€æŸ¥ å› ä¸ºè¦é€šè¿‡é•œåƒPodæ¥å‘apiserverä¼ é€’é™æ€Podçš„çŠ¶æ€ï¼Œæ‰€ä»¥è¯¥é˜¶æ®µä¸»è¦æ˜¯ä¸ºé™æ€Podåˆ›å»ºå¯¹åº”çš„é•œåƒPod if kubetypes.IsStaticPod(pod) { // é™æ€pod podFullName := kubecontainer.GetPodFullName(pod) deleted := false if mirrorPod != nil { if mirrorPod.DeletionTimestamp != nil || !kl.podManager.IsMirrorPodOf(mirrorPod, pod) { deleted, err = kl.podManager.DeleteMirrorPod(podFullName, &mirrorPod.ObjectMeta.UID) } } if mirrorPod == nil || deleted { if err := kl.podManager.CreateMirrorPod(pod); err != nil { } } } } 3.7 åˆ›å»ºPodçš„æ•°æ®ç›®å½• Podçš„æ•°æ®ç›®å½•ä¸»è¦æ˜¯åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šPodç›®å½•ã€Volumeç›®å½•ã€Pluginç›®å½•ä¸‰ä¸ªç›®å½• if err := kl.makePodDataDirs(pod); err != nil { return err } 3.8 ç­‰å¾…volumeçš„æŒ‚è½½ if !kl.podIsTerminated(pod) { if err := kl.volumeManager.WaitForAttachAndMount(pod); err != nil { } } 3.9 è·å–é•œåƒæ‹‰å–çš„secrets pullSecrets := kl.getPullSecretsForPod(pod) 3.10 è°ƒç”¨å®¹å™¨çš„è¿è¡Œæ—¶è¿›è¡ŒåŒæ­¥ ç€å¯èƒ½æ˜¯æœ€å¤æ‚çš„ä¸€éƒ¨åˆ†äº†ï¼Œæ¥ä¸‹æ¥å°±è¿›å…¥åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µï¼šæ¸…ç†é˜¶æ®µ result := kl.containerRuntime.SyncPod(pod, podStatus, pullSecrets, kl.backOff) kl.reasonCache.Update(pod.UID, result) 4. æ¸…ç†é˜¶æ®µ åœ¨Podè¿è¡Œå‰å¯èƒ½å·²ç»æœ‰éƒ¨åˆ†å®¹å™¨å·²ç»åœ¨è¿è¡Œï¼Œåˆ™æ­¤æ—¶å°±éœ€è¦æ ¹æ®å½“å‰çš„çŠ¶æ€ï¼Œæ¥è¿›è¡Œä¸€äº›å®¹å™¨çš„æ¸…ç†å·¥ä½œï¼Œä¸ºæ¥ä¸‹æ¥çš„æ„å»ºè¿è¡Œé˜¶æ®µæä¾›ä¸€ä¸ªç›¸å¯¹å¹²å‡€çš„ç¯å¢ƒ 4.1 è®¡ç®—PodçŠ¶æ€å˜æ›´ åœ¨k8sä¸­Podçš„çŠ¶æ€ä¸»è¦åŒ…å«sandboxå®¹å™¨çŠ¶æ€ã€åˆå§‹åŒ–å®¹å™¨çŠ¶æ€ã€ä¸´æ—¶å®¹å™¨çŠ¶æ€ã€ä¸šåŠ¡å®¹å™¨çŠ¶æ€ç­‰å‡ éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¾æ¬¡æ¥çœ‹ä¸‹å…³é”®çš„å®ç° podContainerChanges := m.computePodActions(pod, podStatus) æ²™ç®±çŠ¶æ€è®¡ç®—ï¼šå½“ä¸”ä»…æœ‰ä¸€ä¸ªReadyçš„æ²™ç®±å¹¶ä¸”æ²™ç®±çš„IPä¸ä¸ºç©ºçš„æƒ…å†µï¼Œæ²™ç®±çš„çŠ¶æ€æ‰ä¸éœ€è¦æ›´æ”¹ï¼Œå…¶ä»–æƒ…å†µä¸‹ï¼Œéƒ½éœ€è¦é‡æ–°è¿›è¡Œæ²™ç®±çš„æ„å»ºï¼Œå¹¶ä¸”éœ€è¦killæ‰Podå…³è”çš„æ‰€æœ‰å®¹å™¨ func (m *kubeGenericRuntimeManager) podSandboxChanged(pod *v1.Pod, podStatus *kubecontainer.PodStatus) (bool, uint32, string) { if len(podStatus.SandboxStatuses) == 0 { return true, 0, \"\" } readySandboxCount := 0 for _, s := range podStatus.SandboxStatuses { if s.State == runtimeapi.PodSandboxState_SANDBOX_READY { readySandboxCount++ } } sandboxStatus := podStatus.SandboxStatuses[0] if readySandboxCount > 1 { return true, sandboxStatus.Metadata.Attempt + 1, sandboxStatus.Id } if sandboxStatus.State != runtimeapi.PodSandboxState_SANDBOX_READY { return true, sandboxStatus.Metadata.Attempt + 1, sandboxStatus.Id } if sandboxStatus.GetLinux().GetNamespaces().GetOptions().GetNetwork() != networkNamespaceForPod(pod) { return true, sandboxStatus.Metadata.Attempt + 1, \"\" } if !kubecontainer.IsHostNetworkPod(pod) && sandboxStatus.Network.Ip == \"\" { return true, sandboxStatus.Metadata.Attempt + 1, sandboxStatus.Id } return false, sandboxStatus.Metadata.Attempt, sandboxStatus.Id } è®¡ç®—Podçš„å®¹å™¨çŠ¶æ€è®¡ç®—é€»è¾‘ç›¸å¯¹é•¿ä¸€äº›ï¼Œè¿™é‡Œæˆ‘å°±ä¸è´´ä»£ç äº†ï¼Œå…¶å¦‚è¦æµç¨‹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š 1.éœ€è¦åˆ›å»ºsandbox: åœ¨è¯¥çŠ¶æ€ä¸‹ï¼Œå¦‚æœå­˜åœ¨åˆå§‹åŒ–å®¹å™¨ï¼Œåˆ™ä¼šå…ˆè¿›è¡Œåˆå§‹åŒ–å®¹å™¨çš„åˆå§‹åŒ–ï¼Œå³å½“å‰æ­¥éª¤åªåˆ›å»ºç¬¬ä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨ï¼Œå¦‚æœæ²¡æœ‰åˆå§‹åŒ–å®¹å™¨ï¼Œåˆ™å°±å°†æ‰€æœ‰çš„ä¸šåŠ¡å®¹å™¨åŠ å…¥åˆ°å¯åŠ¨çš„åˆ—è¡¨é‡Œé¢ 2.ä¸éœ€è¦åˆ›å»ºsandbox: è¯¥çŠ¶æ€ä¸‹ä¼šæ£€æŸ¥éå†æ‰€æœ‰çš„ä¸´æ—¶å®¹å™¨ï¼Œåˆå§‹åŒ–å®¹å™¨(å¦‚æœå­˜åœ¨å¤±è´¥çš„åˆå§‹åŒ–å®¹å™¨ï¼Œåˆ™å°±å…ˆå¯åŠ¨åˆå§‹åŒ–å®¹å™¨ï¼Œä¸ä¼šè¿›è¡Œä¸šåŠ¡å®¹å™¨çš„å¯åŠ¨)ï¼Œä¸šåŠ¡å®¹å™¨ï¼Œæœ€ç»ˆä¼šæ„å»ºä¸€ä¸ªéœ€è¦killæ‰çš„å®¹å™¨åˆ—è¡¨ï¼Œè¿˜æœ‰ä¸¤ä¸ªå¯åŠ¨çš„å®¹å™¨åˆ—è¡¨ 4.2 killPodå…¨éƒ¨æ¸…ç† éœ€è¦è¿›è¡ŒKillPodçš„çŠ¶æ€æœ‰ä¸¤ç§ï¼š sanbboxçŠ¶æ€å˜æ›´ å³å½“sandboxçŠ¶æ€ä¸æ»¡è¶³è¦æ±‚ï¼Œåˆ™æ­¤æ—¶éœ€è¦å°†Podçš„æ‰€æœ‰å®¹å™¨éƒ½æ€æ‰ï¼Œç„¶åè¿›è¡Œé‡å»º æ— éœ€è¿›è¡Œä¿ç•™çš„å®¹å™¨ å¦‚æœPodå¯¹åº”çš„å®¹å™¨çš„hashå€¼å˜æ›´ã€çŠ¶æ€ä¸ºå¤±è´¥ï¼Œåˆ™å°±éœ€è¦é‡å»º if podContainerChanges.KillPod { // æ€æ­»å½“å‰æ‰€æœ‰çš„pod killResult := m.killPodWithSyncResult(pod, kubecontainer.ConvertPodStatusToRunningPod(m.runtimeName, podStatus), nil) if podContainerChanges.CreateSandbox { // ç»ˆæ­¢åˆå§‹åŒ–è¿è¡Œ m.purgeInitContainers(pod, podStatus) } } 4.3 éƒ¨åˆ†æ¸…ç† å¦‚æœå®¹å™¨å½“å‰çš„çŠ¶æ€æ˜¯æ­£å¸¸çš„ï¼Œå¹¶ä¸”hashæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™å°±ä¸éœ€è¦è¿›è¡Œå˜æ›´ï¼Œæ­¤æ—¶å°±åªéœ€è¦å°†å½“å‰çŠ¶æ€ä¸æ­£å¸¸çš„å®¹å™¨è¿›è¡Œæ¸…ç†é‡å»ºå³å¯ for containerID, containerInfo := range podContainerChanges.ContainersToKill { if err := m.killContainer(pod, containerID, containerInfo.name, containerInfo.message, nil); err != nil { return } } æ¸…ç†åˆå§‹åŒ–å®¹å™¨ åœ¨æ­£å¼å¯åŠ¨å®¹å™¨ä¹‹å‰ï¼Œé™¤äº†ä¸Šé¢ä¸¤éƒ¨åˆ†ï¼Œè¿˜ä¼šè¿›è¡Œåˆå§‹åŒ–å®¹å™¨çš„æ¸…ç†å·¥ä½œ m.pruneInitContainersBeforeStart(pod, podStatus) 5.æ„å»ºè¿è¡Œé˜¶æ®µ æ„å»ºè¿è¡Œé˜¶æ®µï¼Œä¸»è¦åˆ†ä¸ºä¸¤ä¸ªå¤§çš„éƒ¨åˆ†ï¼šåˆ›å»ºå¹¶è¿è¡Œsandboxå®¹å™¨ã€è¿è¡Œç”¨æˆ·å®¹å™¨ 5.1 è¿è¡Œsandbox æ£€æŸ¥éœ€è¦åˆ›å»ºsandbox,åˆ™ä¼šé¦–å…ˆåˆ›å»ºsandboxå®¹å™¨ï¼Œå¹¶è·å–çŠ¶æ€ï¼Œç„¶åå¡«å……å½“å‰çš„Podçš„IPä¿¡æ¯ // Step 4: Create a sandbox for the pod if necessary. // åˆ›å»ºæ²™ç®±ç¯å¢ƒ podSandboxID := podContainerChanges.SandboxID if podContainerChanges.CreateSandbox { podSandboxID, msg, err = m.createPodSandbox(pod, podContainerChanges.Attempt) podSandboxStatus, err := m.runtimeService.PodSandboxStatus(podSandboxID) if !kubecontainer.IsHostNetworkPod(pod) { podIPs = m.determinePodSandboxIPs(pod.Namespace, pod.Name, podSandboxStatus) } } 5.2 åˆ›å»ºsandboxä¸»æµç¨‹ åˆ›å»ºsandboxçš„ä¸»æµç¨‹ä¸»è¦å°±ä¸‰ä¸ªæ­¥éª¤ï¼šåˆ›å»ºé…ç½®ä¿¡æ¯ã€åˆ›å»ºæ—¥å¿—ç›®å½•ã€è°ƒç”¨criè¿è¡Œsandboxç”Ÿæˆé…ç½®é˜¶æ®µä¸»è¦åŒ…å«ç«¯å£æ˜ å°„ã€ä¸»æœºåã€DNSã€Linuxä¸­çš„SecurityContextç¯çš„é…ç½® func (m *kubeGenericRuntimeManager) createPodSandbox(pod *v1.Pod, attempt uint32) (string, string, error) { // è·å–æ²™ç®±é…ç½® podSandboxConfig, err := m.generatePodSandboxConfig(pod, attempt) // åˆ›å»ºç›®å½• err = m.osInterface.MkdirAll(podSandboxConfig.LogDirectory, 0755) runtimeHandler := \"\" if utilfeature.DefaultFeatureGate.Enabled(features.RuntimeClass) && m.runtimeClassManager != nil { // è·å–å½“å‰çš„runtimeHandler runtimeHandler, err = m.runtimeClassManager.LookupRuntimeHandler(pod.Spec.RuntimeClassName) } // è¿è¡ŒSandbox podSandBoxID, err := m.runtimeService.RunPodSandbox(podSandboxConfig, runtimeHandler) return podSandBoxID, \"\", nil } 5.3 criä¸­çš„RunSandbox sandboxçš„å¯åŠ¨ä¸»è¦åŒ…å«ä¸‹é¢å‡ éƒ¨åˆ†ï¼š1) æ‹‰å–sanboxå®¹å™¨é•œåƒ 2)åˆ›å»ºsandboxå®¹å™¨ 3)åˆ›å»ºsandboxçš„checkpoint 4)å¯åŠ¨sandboxå®¹å™¨ 5)ä¸ºsandboxå¯åŠ¨ç½‘ç»œ(å¦‚æœä¸æ˜¯ä¸»æœºç½‘ç»œ) func (ds *dockerService) RunPodSandbox(ctx context.Context, r *runtimeapi.RunPodSandboxRequest) (*runtimeapi.RunPodSandboxResponse, error) { config := r.GetConfig() // Step 1: Pull the image for the sandbox. // æ‹‰å–sandboxæ²™ç®± // defaultPodSandboxImageName = \"k8s.gcr.io/pause\" // defaultPodSandboxImageVersion = \"3.1\" image := defaultSandboxImage podSandboxImage := ds.podSandboxImage if len(podSandboxImage) != 0 { image = podSandboxImage } // æ‹‰å–é•œåƒ if err := ensureSandboxImageExists(ds.client, image); err != nil { return nil, err } // 2.åˆ›å»ºsandboxå®¹å™¨ if r.GetRuntimeHandler() != \"\" && r.GetRuntimeHandler() != runtimeName { return nil, fmt.Errorf(\"RuntimeHandler %q not supported\", r.GetRuntimeHandler()) } // åˆ›å»ºæ²™ç®±é…ç½® createConfig, err := ds.makeSandboxDockerConfig(config, image) // åˆ›å»ºå®¹å™¨ createResp, err := ds.client.CreateContainer(*createConfig) resp := &runtimeapi.RunPodSandboxResponse{PodSandboxId: createResp.ID} ds.setNetworkReady(createResp.ID, false) defer func(e *error) { // Set networking ready depending on the error return of // the parent function if *e == nil { ds.setNetworkReady(createResp.ID, true) } }(&err) // Step 3: åˆ›å»ºsandbox checkpoint if err = ds.checkpointManager.CreateCheckpoint(createResp.ID, constructPodSandboxCheckpoint(config)); err != nil { return nil, err } // Step 4: Start the sandbox container. // // 4.å¯åŠ¨sandboxå®¹å™¨ err = ds.client.StartContainer(createResp.ID) if err != nil { return nil, fmt.Errorf(\"failed to start sandbox container for pod %q: %v\", config.Metadata.Name, err) } //é‡å†™dockerç”Ÿæˆçš„resolv.confæ–‡ä»¶ã€‚ if dnsConfig := config.GetDnsConfig(); dnsConfig != nil { containerInfo, err := ds.client.InspectContainer(createResp.ID) if err != nil { return nil, fmt.Errorf(\"failed to inspect sandbox container for pod %q: %v\", config.Metadata.Name, err) } // DNSå†™é…ç½®æ–‡ä»¶ if err := rewriteResolvFile(containerInfo.ResolvConfPath, dnsConfig.Servers, dnsConfig.Searches, dnsConfig.Options); err != nil { return nil, fmt.Errorf(\"rewrite resolv.conf failed for pod %q: %v\", config.Metadata.Name, err) } } // å¦‚æœå¤„äºä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œè¯·ä¸è¦è°ƒç”¨ç½‘ç»œæ’ä»¶ã€‚ if config.GetLinux().GetSecurityContext().GetNamespaceOptions().GetNetwork() == runtimeapi.NamespaceMode_NODE { return resp, nil } // Step 5: è®¾ç½®sandboxå®¹å™¨çš„ç½‘ç»œ //æ‰€æœ‰çš„podç½‘ç»œéƒ½æ˜¯ç”±å¯åŠ¨æ—¶å‘ç°çš„CNIæ’ä»¶è®¾ç½®çš„ã€‚ //è¿™ä¸ªæ’ä»¶åˆ†é…pod ipï¼Œåœ¨æ²™ç›’å†…è®¾ç½®è·¯ç”±ï¼Œåˆ›å»ºæ¥å£ç­‰ã€‚ç†è®ºä¸Šï¼Œå®ƒçš„ç®¡è¾–æƒä»¥podæ²™ç›’ç½‘ç»œç»“æŸï¼Œ // ä½†å®ƒä¹Ÿå¯èƒ½åœ¨ä¸»æœºä¸Šæ’å…¥iptablesè§„åˆ™æˆ–æ‰“å¼€ç«¯å£ï¼Œä»¥æ»¡è¶³CNIæ ‡å‡†å°šæœªè¯†åˆ«çš„podè§„èŒƒçš„éƒ¨åˆ†è¦æ±‚ã€‚ cID := kubecontainer.BuildContainerID(runtimeName, createResp.ID) networkOptions := make(map[string]string) if dnsConfig := config.GetDnsConfig(); dnsConfig != nil { // Build DNS options. dnsOption, err := json.Marshal(dnsConfig) if err != nil { return nil, fmt.Errorf(\"failed to marshal dns config for pod %q: %v\", config.Metadata.Name, err) } // è®¾ç½®ç½‘ç»œdns networkOptions[\"dns\"] = string(dnsOption) } // ç½‘ç»œä¿¡æ¯ err = ds.network.SetUpPod(config.GetMetadata().Namespace, config.GetMetadata().Name, cID, config.Annotations, networkOptions) return resp, nil } 5.4 å®¹å™¨å¯åŠ¨å‡½æ•° å®¹å™¨å¯åŠ¨å‡½æ•°ä¸­ä¼šé€šè¿‡é—­åŒ…æ¥ä¿å­˜ä¸Šé¢åˆ›å»ºçš„sandboxçš„ä¿¡æ¯ï¼ŒåŒæ—¶æ ¹æ®å½“å‰å®¹å™¨çš„é…ç½®ï¼Œåˆ›å»ºæ–°çš„ä¸šåŠ¡å®¹å™¨ start := func(typeName string, container *v1.Container) error { klog.V(4).Infof(\"Creating %v %+v in pod %v\", typeName, container, format.Pod(pod)) if msg, err := m.startContainer(podSandboxID, podSandboxConfig, container, pod, podStatus, pullSecrets, podIP, podIPs); err != nil { startContainerResult.Fail(err, msg) } return nil } 5.5 å¯åŠ¨å®¹å™¨ å®¹å™¨çš„å¯åŠ¨ï¼Œä¸»è¦åŒ…å«å››ä¸ªæµç¨‹ï¼š1.æ‹‰å–é•œåƒ 2.åˆ›å»ºå®¹å™¨&PreStarté’©å­å›è°ƒ 3) å¯åŠ¨å®¹å™¨ 4ï¼‰postStartå¯åŠ¨å®¹å™¨ func (m *kubeGenericRuntimeManager) startContainer(podSandboxID string, podSandboxConfig *runtimeapi.PodSandboxConfig, container *v1.Container, pod *v1.Pod, podStatus *kubecontainer.PodStatus, pullSecrets []v1.Secret, podIP string, podIPs []string) (string, error) { // å¯åŠ¨å®¹å™¨ // Step 1: pull the image. imageRef, msg, err := m.imagePuller.EnsureImageExists(pod, container, pullSecrets, podSandboxConfig) // Step 2: create the container. ref, err := kubecontainer.GenerateContainerRef(pod, container) // è·å–å®¹å™¨é…ç½®ï¼Œ é‡Œé¢ä¼šè¿›è¡Œå„ç§æ–‡ä»¶ç›®å½•çš„æŒ‚è½½ containerConfig, cleanupAction, err := m.generateContainerConfig(container, pod, restartCount, podIP, imageRef, podIPs) if cleanupAction != nil { defer cleanupAction() } if err != nil { s, _ := grpcstatus.FromError(err) m.recordContainerEvent(pod, container, \"\", v1.EventTypeWarning, events.FailedToCreateContainer, \"Error: %v\", s.Message()) return s.Message(), ErrCreateContainerConfig } // åˆ›å»ºå®¹å™¨ containerID, err := m.runtimeService.CreateContainer(podSandboxID, containerConfig, podSandboxConfig) // å¯åŠ¨å®¹å™¨é’©å­ err = m.internalLifecycle.PreStartContainer(pod, container, containerID) m.recordContainerEvent(pod, container, containerID, v1.EventTypeNormal, events.CreatedContainer, fmt.Sprintf(\"Created container %s\", container.Name)) if ref != nil { m.containerRefManager.SetRef(kubecontainer.ContainerID{ Type: m.runtimeName, ID: containerID, }, ref) } // Step 3: å¯åŠ¨å®¹å™¨ err = m.runtimeService.StartContainer(containerID) if err != nil { s, _ := grpcstatus.FromError(err) m.recordContainerEvent(pod, container, containerID, v1.EventTypeWarning, events.FailedToStartContainer, \"Error: %v\", s.Message()) return s.Message(), kubecontainer.ErrRunContainer } containerMeta := containerConfig.GetMetadata() sandboxMeta := podSandboxConfig.GetMetadata() legacySymlink := legacyLogSymlink(containerID, containerMeta.Name, sandboxMeta.Name, sandboxMeta.Namespace) // å®¹å™¨æ—¥å¿— containerLog := filepath.Join(podSandboxConfig.LogDirectory, containerConfig.LogPath) if _, err := m.osInterface.Stat(containerLog); !os.IsNotExist(err) { if err := m.osInterface.Symlink(containerLog, legacySymlink); err != nil { } } // Step 4: æ‰§è¡ŒpostStarté’©å­ if container.Lifecycle != nil && container.Lifecycle.PostStart != nil { msg, handlerErr := m.runner.Run(kubeContainerID, pod, container, container.Lifecycle.PostStart) if handlerErr != nil { if err := m.killContainer(pod, kubeContainerID, container.Name, \"FailedPostStartHook\", nil); err != nil { } } } return \"\", nil } 5.6 cri.CreateContainer CreateContainerä¸­ä¼šé¦–å…ˆæ ¹æ®k8sé‡Œé¢ä¼ é€’çš„é…ç½®ä¿¡æ¯ï¼Œæ ¹æ®å½“å‰å¹³å°å’Œå¯¹åº”çš„å‚æ•°æ¥è¿›è¡Œdockerå®¹å™¨è¿è¡Œçš„é…ç½®ï¼Œç„¶åè°ƒç”¨dockeræ¥å£è¿›è¡Œå®¹å™¨çš„é…ç½® func (ds *dockerService) CreateContainer(_ context.Context, r *runtimeapi.CreateContainerRequest) (*runtimeapi.CreateContainerResponse, error) { podSandboxID := r.PodSandboxId config := r.GetConfig() sandboxConfig := r.GetSandboxConfig() containerName := makeContainerName(sandboxConfig, config) // åˆ›å»ºå®¹å™¨é…ç½® createConfig := dockertypes.ContainerCreateConfig{ Name: containerName, Config: &dockercontainer.Config{ // TODO: set User. Entrypoint: dockerstrslice.StrSlice(config.Command), Cmd: dockerstrslice.StrSlice(config.Args), Env: generateEnvList(config.GetEnvs()), Image: image, WorkingDir: config.WorkingDir, Labels: labels, // Interactive containers: OpenStdin: config.Stdin, StdinOnce: config.StdinOnce, Tty: config.Tty, // Disable Docker's health check until we officially support it // (https://github.com/kubernetes/kubernetes/issues/25829). Healthcheck: &dockercontainer.HealthConfig{ Test: []string{\"NONE\"}, }, }, HostConfig: &dockercontainer.HostConfig{ Binds: generateMountBindings(config.GetMounts()), RestartPolicy: dockercontainer.RestartPolicy{ Name: \"no\", }, }, } hc := createConfig.HostConfig err = ds.updateCreateConfig(&createConfig, config, sandboxConfig, podSandboxID, securityOptSeparator, apiVersion) if err != nil { return nil, fmt.Errorf(\"failed to update container create config: %v\", err) } // è®¾ç½®å®¹å™¨devices devices := make([]dockercontainer.DeviceMapping, len(config.Devices)) for i, device := range config.Devices { devices[i] = dockercontainer.DeviceMapping{ PathOnHost: device.HostPath, PathInContainer: device.ContainerPath, CgroupPermissions: device.Permissions, } } hc.Resources.Devices = devices securityOpts, err := ds.getSecurityOpts(config.GetLinux().GetSecurityContext().GetSeccompProfilePath(), securityOptSeparator) if err != nil { return nil, fmt.Errorf(\"failed to generate security options for container %q: %v\", config.Metadata.Name, err) } hc.SecurityOpt = append(hc.SecurityOpt, securityOpts...) cleanupInfo, err := ds.applyPlatformSpecificDockerConfig(r, &createConfig) if err != nil { return nil, err } createResp, createErr := ds.client.CreateContainer(createConfig) if createErr != nil { createResp, createErr = recoverFromCreationConflictIfNeeded(ds.client, createConfig, createErr) } if createResp != nil { containerID := createResp.ID if cleanupInfo != nil { // we don't perform the clean up just yet at that could destroy information // needed for the container to start (e.g. Windows credentials stored in // registry keys); instead, we'll clean up when the container gets removed ds.containerCleanupInfos[containerID] = cleanupInfo } return &runtimeapi.CreateContainerResponse{ContainerId: containerID}, nil } return nil, createErr } æ›´æ–°å®¹å™¨é…ç½® func (ds *dockerService) updateCreateConfig( createConfig *dockertypes.ContainerCreateConfig, config *runtimeapi.ContainerConfig, sandboxConfig *runtimeapi.PodSandboxConfig, podSandboxID string, securityOptSep rune, apiVersion *semver.Version) error { if lc := config.GetLinux(); lc != nil { rOpts := lc.GetResources() if rOpts != nil { // æ›´æ–°èµ„æºé…ç½®ä¿¡æ¯ createConfig.HostConfig.Resources = dockercontainer.Resources{ Memory: rOpts.MemoryLimitInBytes, MemorySwap: rOpts.MemoryLimitInBytes, CPUShares: rOpts.CpuShares, CPUQuota: rOpts.CpuQuota, CPUPeriod: rOpts.CpuPeriod, } createConfig.HostConfig.OomScoreAdj = int(rOpts.OomScoreAdj) } // åº”ç”¨SecurityContext if err := applyContainerSecurityContext(lc, podSandboxID, createConfig.Config, createConfig.HostConfig, securityOptSep); err != nil { return fmt.Errorf(\"failed to apply container security context for container %q: %v\", config.Metadata.Name, err) } } // åº”ç”¨cgroupé…ç½® if lc := sandboxConfig.GetLinux(); lc != nil { // Apply Cgroup options. cgroupParent, err := ds.GenerateExpectedCgroupParent(lc.CgroupParent) createConfig.HostConfig.CgroupParent = cgroupParent } return nil } 5.7 cri.StartContainer å…¶å®å°±ç›´æ¥æ‰Dockerçš„æ¥å£å¯åŠ¨å®¹å™¨å³å¯ func (ds *dockerService) StartContainer(_ context.Context, r *runtimeapi.StartContainerRequest) (*runtimeapi.StartContainerResponse, error) { err := ds.client.StartContainer(r.ContainerId) return &runtimeapi.StartContainerResponse{}, nil } 6. æ€»ç»“ Podå¯åŠ¨çš„æ ¸å¿ƒæµç¨‹å¤§æ¦‚å°±è¿™äº›ï¼Œé‡Œé¢ä¼šæœ‰ä¸€äº›ç¬”è®¤è´­å…·ä½“å‚æ•°æ•°æ®çš„æ„å»ºï¼Œæ²¡æœ‰å†™æ˜ï¼Œä½†æ˜¯å¦‚æœå¯¹ä»£ç æ„Ÿå…´è¶£çš„ï¼Œå¯ä»¥é¡ºç€è¿™ä¸ªæ ¸å¿ƒæµç¨‹åŸºæœ¬å¯ä»¥è¯»ä¸‹æ¥ï¼Œå¦‚æœå¯¹ä»£ç ä¸æ„Ÿå…´è¶£ï¼Œåˆ™åé¢è¿™å¼ å›¾å¯ä»¥ç®—ä½œä¸€ä¸ªç²¾ç®€ç‰ˆçš„ï¼Œé¢è¯•å¯ç”¨çš„Podåˆ›å»ºæµç¨‹å›¾ kuberneteså­¦ä¹ ç¬”è®°åœ°å€: https://www.yuque.com/baxiaoshi/tyado3 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/k8s/kubesphere/åœ¨k8sé›†ç¾¤å®‰è£…kubesphere2.1.html":{"url":"linux/k8s/kubesphere/åœ¨k8sé›†ç¾¤å®‰è£…kubesphere2.1.html","title":"kubesphere","keywords":"","body":"åœ¨ Kubernetesé›†ç¾¤ä¸­ å®‰è£… KubeSphere2.1 å®‰è£…ä»‹ç» å®Œæ•´å®‰è£…ã€é«˜å¯ç”¨å®‰è£…ã€å‡çº§ã€å¯æ’æ‹”åŠŸèƒ½ç»„ä»¶å®‰è£…ç­‰ç­‰å…¨åœ¨kubesphereå®˜ç½‘äº†ï¼Œå†™çš„éå¸¸è¯¦ç»†ï¼Œå¦‚æœæœ‰ä¸€äº›è§£å†³ä¸äº†çš„é—®é¢˜å°±åœ¨ kubesphereè®ºå› å‘å¸–(å‘å¸–å‰æœ€å¥½è‡ªå·±å°è¯•è§£å†³ä¸€ä¸‹ï¼Œå°¤å…¶æ˜¯æŒä¹…åŒ–å­˜å‚¨è¿™ä¸€å—ï¼ï¼ï¼) æ–‡æ¡£è¯´æ˜ æœ¬æ–‡å°†ä½¿ç”¨kubeadmå®‰è£…k8s1.16.9ç‰ˆæœ¬ï¼Œå¹¶ä¸”åœ¨k8sé›†ç¾¤ä¸­å®‰è£…kubesphere2.1 å®˜æ–¹æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜äº†å¦‚æœè¦å®Œå…¨å®‰è£…kubesphereï¼Œé›†ç¾¤æœºå™¨é…ç½®è‡³å°‘æ˜¯8c16gï¼Œè€Œæœ€å°åŒ–å®‰è£…æœºå™¨é…ç½®æœ€å°‘ä¸º2gå†…å­˜ï¼Œæ‰€ä»¥è¿™é‡Œä»…ä»…æ˜¯æœ€å°åŒ–å®‰è£…ä½“éªŒ ä½¿ç”¨ kubeadm æ­å»º v1.16.9 ç‰ˆæœ¬ Kubernetes é›†ç¾¤ ä¸€ã€ç¯å¢ƒå‡†å¤‡ 1.1å®éªŒç¯å¢ƒ è§’è‰² IPåœ°å€ ä¸»æœºå dockerç‰ˆæœ¬ ç¡¬ä»¶é…ç½® ç³»ç»Ÿ å†…æ ¸ master 192.168.9.10 k8s-master 18.09.9 2c4g CentOS7.7 3.10.0-1062.el7.x86_64 node1 192.168.9.13 k8s-node1 18.09.9 2c6g CentOS7.7 3.10.0-1062.el7.x86_64 node2 192.168.9.14 k8s-node2 18.09.9 2c6g CentOS7.7 3.10.0-1062.el7.x86_64 1.2æ¯ä¸ªèŠ‚ç‚¹é…ç½®hostä¿¡æ¯ cat >> /etc/hosts 1.3ç¦ç”¨é˜²ç«å¢™å’Œselinux //ç¦ç”¨é˜²ç«å¢™ systemctl stop firewalld && systemctl disable firewalld //ç¦ç”¨selinux #ä¸´æ—¶ä¿®æ”¹ setenforce 0 #æ°¸ä¹…ä¿®æ”¹ï¼Œé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆ sed -i '7s/enforcing/disabled/' /etc/selinux/config 1.4åˆ›å»º/etc/sysctl.d/k8s.confæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ //å‘æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ cat >/etc/sysctl.d/k8s.conf 1.5å®‰è£…ipvs è„šæœ¬åˆ›å»ºäº†çš„/etc/sysconfig/modules/ipvs.modulesæ–‡ä»¶ï¼Œä¿è¯åœ¨èŠ‚ç‚¹é‡å¯åèƒ½è‡ªåŠ¨åŠ è½½æ‰€éœ€æ¨¡å—ã€‚ä½¿ç”¨lsmod | grep -e ip_vs -e nf_conntrack_ipv4å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å·²ç»æ­£ç¡®åŠ è½½æ‰€éœ€çš„å†…æ ¸æ¨¡å— //å‘æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ cat > /etc/sysconfig/modules/ipvs.modules å®‰è£…ipsetå’Œipvsadm(ä¾¿äºæŸ¥çœ‹ ipvs çš„ä»£ç†è§„åˆ™) yum -y install ipset ipvsadm 1.6åŒæ­¥æœåŠ¡å™¨æ—¶é—´ //å®‰è£…chrony yum -y install chrony //ä¿®æ”¹åŒæ­¥æœåŠ¡å™¨åœ°å€ä¸ºé˜¿é‡Œäº‘ sed -i.bak '3,6d' /etc/chrony.conf && sed -i '3cserver ntp1.aliyun.com iburst' \\ /etc/chrony.conf //å¯åŠ¨chronydåŠåŠ å…¥å¼€æœºè‡ªå¯ systemctl start chronyd && systemctl enable chronyd //æŸ¥çœ‹åŒæ­¥ç»“æœ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* 120.25.115.20 2 6 37 13 +194us[+6131us] +/- 33ms 1.7å…³é—­swapåˆ†åŒº ä¿®æ”¹/etc/fstabæ–‡ä»¶ï¼Œæ³¨é‡Šæ‰ SWAP çš„è‡ªåŠ¨æŒ‚è½½ï¼Œä½¿ç”¨free -mç¡®è®¤ swap å·²ç»å…³é—­ //æ‰‹åŠ¨å…³é—­swap swapoff -a //ä¿®æ”¹fstabæ–‡ä»¶ï¼Œæ³¨é‡Šswapè‡ªåŠ¨æŒ‚è½½ sed -i '/^\\/dev\\/mapper\\/centos-swap/c#/dev/mapper/centos-swap swap swap defaults 0 0' /etc/fstab //æŸ¥çœ‹swapæ˜¯å¦å…³é—­ free -m total used free shared buff/cache available Mem: 1994 682 612 9 699 1086 Swap: 0 0 0 swappiness å‚æ•°è°ƒæ•´ï¼Œä¿®æ”¹/etc/sysctl.d/k8s.confæ·»åŠ ä¸‹é¢ä¸€è¡Œ cat >>/etc/sysctl.d/k8s.conf 1.8å®‰è£…docker18.09.9 1.æ·»åŠ é˜¿é‡Œäº‘yumæº yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 2.æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ yum list docker-ce --showduplicates | sort -r å·²åŠ è½½æ’ä»¶ï¼šfastestmirror, langpacks å¯å®‰è£…çš„è½¯ä»¶åŒ… * updates: mirrors.aliyun.com Loading mirror speeds from cached hostfile * extras: mirrors.aliyun.com docker-ce.x86_64 3:19.03.5-3.el7 docker-ce-stable docker-ce.x86_64 3:19.03.4-3.el7 docker-ce-stable ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ docker-ce.x86_64 3:18.09.9-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.8-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.7-3.el7 docker-ce-stable docker-ce.x86_64 3:18.09.6-3.el7 docker-ce-stable ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 3.å®‰è£…docker18.09.9 yum -y install docker-ce-18.09.9-3.el7 docker-ce-cli-18.09.9 4.å¯åŠ¨dockerå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable docker && systemctl start docker 5.é…ç½®é˜¿é‡Œäº‘dockeré•œåƒåŠ é€Ÿ cat > /etc/docker/daemon.json 1.9ä¿®æ”¹docker Cgroup Driverä¸ºsystemd #ä¿®æ”¹docker Cgroup Driverä¸ºsystemd å°†/usr/lib/systemd/system/docker.serviceæ–‡ä»¶ä¸­çš„è¿™ä¸€è¡Œ ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ä¿®æ”¹ä¸º ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd å¦‚æœä¸ä¿®æ”¹ï¼Œåœ¨æ·»åŠ  worker èŠ‚ç‚¹æ—¶å¯èƒ½ä¼šç¢°åˆ°å¦‚ä¸‹é”™è¯¯ [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driver. The recommended driver is \"systemd\". Please follow the guide at https://kubernetes.io/docs/setup/cri/ //ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i.bak \"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g\" /usr/lib/systemd/system/docker.service //é‡å¯docker systemctl daemon-reload && systemctl restart docker 1.10å®‰è£…Kubeadm éœ€è¦ç§‘å­¦ä¸Šç½‘ cat >/etc/yum.repos.d/kubernetes.repo ä½¿ç”¨é˜¿é‡Œäº‘yumæº cat >/etc/yum.repos.d/kubernetes.repo å®‰è£… kubeadmã€kubeletã€kubectl(é˜¿é‡Œäº‘yumæºä¼šéšå®˜æ–¹æ›´æ–°æœ€æ–°ç‰ˆï¼Œå› æ­¤æŒ‡å®šç‰ˆæœ¬) //å®‰è£…1.16.9ç‰ˆæœ¬ yum -y install kubelet-1.16.9 kubeadm-1.16.9 kubectl-1.16.9 //æŸ¥çœ‹ç‰ˆæœ¬ kubeadm version kubeadm version: &version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v1.16.9\", GitCommit:\"a17149e1a189050796ced469dbd78d380f2ed5ef\", GitTreeState:\"clean\", BuildDate:\"2020-04-16T11:42:30Z\", GoVersion:\"go1.13.9\", Compiler:\"gc\", Platform:\"linux/amd64\"} è®¾ç½®kubeletå¼€æœºè‡ªå¯ systemctl enable kubelet è®¾ç½®k8så‘½ä»¤è‡ªåŠ¨è¡¥å…¨ yum -y install bash-completion source /usr/share/bash-completion/bash_completion source > ~/.bashrc åˆ°æ­¤ï¼ŒåŸºæœ¬ç¯å¢ƒå®‰è£…å®Œæˆ!!! äºŒã€åˆå§‹åŒ–é›†ç¾¤ 2.1masterèŠ‚ç‚¹æ“ä½œï¼Œé…ç½® kubeadm åˆå§‹åŒ–æ–‡ä»¶ cat ./kubeadm-config.yaml apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: v1.16.9 imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers #masteråœ°å€ controlPlaneEndpoint: \"192.168.9.10:6443\" networking: serviceSubnet: \"10.96.0.0/16\" #k8så®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µ podSubnet: \"10.20.0.1/16\" dnsDomain: \"cluster.local\" EOF 2.2åˆå§‹åŒ–master âš ï¸å¦‚æœæƒ³è¦é‡æ–°åˆå§‹åŒ–ï¼Œéœ€è¦æ‰§è¡Œå‘½ä»¤kubeadm reset -f #kubeadm init --config=kubeadm-config.yaml --upload-certs å®Œæ•´è¾“å‡ºç»“æœ kubeadm init --config=kubeadm-config.yaml [init] Using Kubernetes version: v1.16.9 [preflight] Running pre-flight checks [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using 'kubeadm config images pull' [kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\" [kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\" [kubelet-start] Activating the kubelet service [certs] Using certificateDir folder \"/etc/kubernetes/pki\" [certs] Generating \"ca\" certificate and key [certs] Generating \"apiserver\" certificate and key [certs] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.9.10 192.168.9.10] [certs] Generating \"apiserver-kubelet-client\" certificate and key [certs] Generating \"front-proxy-ca\" certificate and key [certs] Generating \"front-proxy-client\" certificate and key [certs] Generating \"etcd/ca\" certificate and key [certs] Generating \"etcd/server\" certificate and key [certs] etcd/server serving cert is signed for DNS names [k8s-master localhost] and IPs [192.168.9.10 127.0.0.1 ::1] [certs] Generating \"etcd/peer\" certificate and key [certs] etcd/peer serving cert is signed for DNS names [k8s-master localhost] and IPs [192.168.9.10 127.0.0.1 ::1] [certs] Generating \"etcd/healthcheck-client\" certificate and key [certs] Generating \"apiserver-etcd-client\" certificate and key [certs] Generating \"sa\" key and public key [kubeconfig] Using kubeconfig folder \"/etc/kubernetes\" [kubeconfig] Writing \"admin.conf\" kubeconfig file [kubeconfig] Writing \"kubelet.conf\" kubeconfig file [kubeconfig] Writing \"controller-manager.conf\" kubeconfig file [kubeconfig] Writing \"scheduler.conf\" kubeconfig file [control-plane] Using manifest folder \"/etc/kubernetes/manifests\" [control-plane] Creating static Pod manifest for \"kube-apiserver\" [control-plane] Creating static Pod manifest for \"kube-controller-manager\" [control-plane] Creating static Pod manifest for \"kube-scheduler\" [etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\" [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\". This can take up to 4m0s [apiclient] All control plane components are healthy after 16.501777 seconds [upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace [kubelet] Creating a ConfigMap \"kubelet-config-1.16\" in namespace kube-system with the configuration for the kubelets in the cluster [upload-certs] Skipping phase. Please see --upload-certs [mark-control-plane] Marking the node k8s-master as control-plane by adding the label \"node-role.kubernetes.io/master=''\" [mark-control-plane] Marking the node k8s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule] [bootstrap-token] Using token: px979r.mphk9ee5ya8fgy44 [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token [bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster [bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace [addons] Applied essential addon: CoreDNS [addons] Applied essential addon: kube-proxy Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of control-plane nodes by copying certificate authorities and service account keys on each node and then running the following as root: kubeadm join 192.168.9.10:6443 --token px979r.mphk9ee5ya8fgy44 \\ --discovery-token-ca-cert-hash sha256:5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 \\ --control-plane Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.9.10:6443 --token px979r.mphk9ee5ya8fgy44 \\ --discovery-token-ca-cert-hash sha256:5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 æ‹·è´ kubeconfig æ–‡ä»¶ //è¿™é‡Œçš„è·¯å¾„ä¸º/root mkdir -p $HOME/.kube cp -i /etc/kubernetes/admin.conf $HOME/.kube/config chown $(id -u):$(id -g) $HOME/.kube/config 2.3masteræ·»åŠ èŠ‚ç‚¹ node1å’Œnode2ç›¸åŒæ“ä½œ å°†masterèŠ‚ç‚¹ä¸Šçš„$HOME/.kube/config æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹å¯¹åº”çš„æ–‡ä»¶ä¸­ 1.åˆ›å»ºç›®å½•ï¼Œè¿™é‡Œçš„è·¯å¾„ä¸º/root mkdir -p $HOME/.kube 2.æŠŠmasterèŠ‚ç‚¹ä¸Šçš„configæ–‡ä»¶æ‹·è´åˆ°node1å’Œnode2çš„$HOME/.kube scp k8s-master1:~/.kube/config $HOME/.kube 3.ä¿®æ”¹æƒé™ chown $(id -u):$(id -g) $HOME/.kube/config å°†node1å’Œnode2åŠ å…¥åˆ°é›†ç¾¤ä¸­ è¿™é‡Œéœ€è¦ç”¨åˆ°2.2ä¸­åˆå§‹åŒ–masteræœ€åç”Ÿæˆçš„tokenå’Œsha256å€¼ #kubeadm join 192.168.9.10:6443 --token px979r.mphk9ee5ya8fgy44 --discovery-token-ca-cert-hash sha256:5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 è¾“å‡ºç»“æœ [preflight] Running pre-flight checks [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driver. The recommended driver is \"systemd\". Please follow the guide at https://kubernetes.io/docs/setup/cri/ [preflight] Reading configuration from the cluster... [preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml' [kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-1.16\" ConfigMap in the kube-system namespace [kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\" [kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\" [kubelet-start] Activating the kubelet service [kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap... This node has joined the cluster: * Certificate signing request was sent to apiserver and a response was received. * The Kubelet was informed of the new secure connection details. Run 'kubectl get nodes' on the control-plane to see this node join the cluster. å¦‚æœå¿˜è®°äº†tokenå’Œsha256å€¼ï¼Œå¯ä»¥åœ¨masterèŠ‚ç‚¹ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ //æŸ¥çœ‹token #kubeadm token list TOKEN TTL EXPIRES USAGES DESCRIPTION EXTRA GROUPS px979r.mphk9ee5ya8fgy44 20h 2020-03-18T13:49:48+08:00 authentication,signing system:bootstrappers:kubeadm:default-node-token //æŸ¥çœ‹sha256 #openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //' 5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 //åŒæ—¶æŸ¥çœ‹tokenå’Œsha256 #kubeadm token create --print-join-command kubeadm join 192.168.9.10:6443 --token 9b28zg.oyt0kvvpmtrem4bg --discovery-token-ca-cert-hash sha256:5e7c7cd1cc1f86c0761e54b9380de22968b6b221cb98939c14ab2942223f6f51 masterèŠ‚ç‚¹æŸ¥çœ‹nodeï¼Œå‘ç°çŠ¶æ€éƒ½æ˜¯NotReadyï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å®‰è£…calioå®˜æ–¹æ’ä»¶æ–‡æ¡£ kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master NotReady master 19m v1.16.9 k8s-node1 NotReady 4m10s v1.16.9 k8s-node2 NotReady 4m3s v1.16.9 2.4masterèŠ‚ç‚¹å®‰è£…ç½‘ç»œæ’ä»¶calio //ä¸‹è½½æ–‡ä»¶ wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml å°†æ–‡ä»¶ä¸­çš„620è¡Œæ”¹ä¸ºå¦‚ä¸‹ï¼Œå› ä¸ºåœ¨ä¸Šè¾¹kubeadm-config.yamlé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†å®¹å™¨ç»„IP 620è¡Œ value: \"10.20.0.1/16\" //ä¿®æ”¹å®Œæˆåå®‰è£…calicoç½‘ç»œæ’ä»¶ kubectl apply -f calico.yaml //å®‰è£…å®Œæˆåç¨ç­‰ä¸€ä¼šæŸ¥çœ‹podsçŠ¶æ€ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE calico-kube-controllers-dc6cb64cb-8sh59 1/1 Running 0 6m22s calico-node-89s9k 1/1 Running 0 6m22s calico-node-dkt7w 1/1 Running 0 6m22s calico-node-tgg2h 1/1 Running 0 6m22s coredns-667f964f9b-7hrj9 1/1 Running 0 33m coredns-667f964f9b-8q7sh 1/1 Running 0 33m etcd-k8s-master 1/1 Running 0 33m kube-apiserver-k8s-master 1/1 Running 0 32m kube-controller-manager-k8s-master 1/1 Running 0 33m kube-proxy-b2r5d 1/1 Running 0 12m kube-proxy-nd982 1/1 Running 0 11m kube-proxy-zh6cz 1/1 Running 0 33m kube-scheduler-k8s-master 1/1 Running 0 32m //æŸ¥çœ‹nodeçŠ¶æ€ [root@k8s-master ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master Ready master 31m v1.16.9 k8s-node1 Ready 9m46s v1.16.9 k8s-node2 Ready 9m22s v1.16.9 2.5å®‰è£…Dashboard(å¯é€‰) ä¸‹è½½æ–‡ä»¶åŠä¿®æ”¹å†…å®¹ è¿™é‡ŒæŸ¥çœ‹dashboardå¯¹åº”çš„k8sç‰ˆæœ¬ //ä¸‹è½½æ–‡ä»¶ v2.0.0-rc3æ˜¯ä¸­æ–‡ç‰ˆæœ¬ï¼Œbeta8æ˜¯è‹±æ–‡ç‰ˆæœ¬ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta8/aio/deploy/recommended.yaml wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc3/aio/deploy/recommended.yaml //ä¿®æ”¹Serviceä¸ºNodePortç±»å‹ 42è¡Œä¸‹å¢åŠ ä¸€è¡Œ nodePort: 30001 44è¡Œä¸‹å¢åŠ ä¸€è¡Œ type: NodePort //åŸå…ˆå†…å®¹ spec: ports: - port: 443 targetPort: 8443 selector: k8s-app: kubernetes-dashboard //ä¿®æ”¹åå†…å®¹ spec: ports: - port: 443 targetPort: 8443 nodePort: 30001 #å¢åŠ ï¼ŒæŒ‡å®šnodeportç«¯å£ selector: k8s-app: kubernetes-dashboard type: NodePort #å¢åŠ ï¼Œä¿®æ”¹ç±»å‹ä¸ºnodeport éƒ¨ç½²dashboard kubectl apply -f recommended.yaml æŸ¥çœ‹dashboardçš„è¿è¡ŒçŠ¶æ€åŠå¤–ç½‘è®¿é—®ç«¯å£ //æŸ¥çœ‹dashboardè¿è¡ŒçŠ¶æ€ #kubectl get pods -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard NAME READY STATUS RESTARTS AGE kubernetes-dashboard-5996555fd8-2ppc5 1/1 Running 0 8m16s //æŸ¥çœ‹dashboardå¤–ç½‘è®¿é—®ç«¯å£ï¼Œå‘½åç©ºé—´ä¸ºkubernetes-dashboard #kubectl get svc -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard kubectl get svc -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes-dashboard NodePort 10.96.142.172 443:30001/TCP 8m37s é€šè¿‡ä¸Šè¾¹çš„30001ç«¯å£è®¿é—®dashboardï¼Œæ³¨æ„æ˜¯https âš ï¸k8s1.16.9è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨çš„dashboardç‰ˆæœ¬æ˜¯2.0.0-beta8ï¼Œåªæœ‰ç«ç‹æµè§ˆå™¨å¯ä»¥è®¿é—®ï¼Œå…¶ä½™æµè§ˆå™¨éƒ½ä¸èƒ½è®¿é—®ï¼Œä¼šæŠ¥é”™å¦‚ä¸‹ ä½¿ç”¨ç«ç‹æµè§ˆå™¨è®¿é—®ï¼Œç”±äº dashboard é»˜è®¤æ˜¯è‡ªå»ºçš„ https è¯ä¹¦ï¼Œè¯¥è¯ä¹¦æ˜¯ä¸å—æµè§ˆå™¨ä¿¡ä»»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼ºåˆ¶è·³è½¬å°±å¯ä»¥äº† ç„¶ååˆ›å»ºä¸€ä¸ªå…·æœ‰å…¨å±€æ‰€æœ‰æƒé™çš„ç”¨æˆ·æ¥ç™»å½•Dashboard //ç¼–è¾‘admin.yamlæ–‡ä»¶ cat > admin.yaml 2.6å®‰è£…k8såˆ‡æ¢å‘½åç©ºé—´å·¥å…· git clone https://github.com.cnpmjs.org/ahmetb/kubectx cp kubectx/kubens /usr/local/bin #æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´ kubens #åˆ‡æ¢åˆ°kube-systemå‘½åç©ºé—´ kubens kube-system Context \"kubernetes-admin@kubernetes\" modified. Active namespace is \"kube-system\". åˆ°æ­¤ï¼Œä½¿ç”¨kubeadmå®‰è£…k8s 1.16.3å®Œæˆï¼ï¼ï¼ ä¸‰ã€åœ¨k8sé›†ç¾¤ä¸­å®‰è£…kubesphere å®˜ç½‘ä¸­å®‰è£…kubesphereçš„å‰ææ¡ä»¶å¦‚ä¸‹ Kubernetesç‰ˆæœ¬ï¼š 1.15.x â‰¤ K8s version â‰¤ 1.17.xï¼› Helmç‰ˆæœ¬ï¼š 2.10.0 â‰¤ Helm Version ï¼œ 3.0.0ï¼ˆä¸æ”¯æŒ helm 2.16.0 #6894ï¼‰ï¼Œä¸”å·²å®‰è£…äº† Tillerï¼Œå‚è€ƒ å¦‚ä½•å®‰è£…ä¸é…ç½® Helm ï¼ˆé¢„è®¡ 3.0 æ”¯æŒ Helm v3ï¼‰ï¼› é›†ç¾¤å·²æœ‰é»˜è®¤çš„å­˜å‚¨ç±»å‹ï¼ˆStorageClassï¼‰ï¼Œè‹¥è¿˜æ²¡æœ‰å‡†å¤‡å­˜å‚¨è¯·å‚è€ƒ å®‰è£… OpenEBS åˆ›å»º LocalPV å­˜å‚¨ç±»å‹ ç”¨ä½œå¼€å‘æµ‹è¯•ç¯å¢ƒã€‚ é›†ç¾¤èƒ½å¤Ÿè®¿é—®å¤–ç½‘ï¼Œè‹¥æ— å¤–ç½‘è¯·å‚è€ƒ åœ¨ Kubernetes ç¦»çº¿å®‰è£… KubeSphereã€‚ 3.1å®‰è£…helm2.16.3 å®¢æˆ·ç«¯helmå®‰è£… 3.1.1ä¸‹è½½helmå®¢æˆ·ç«¯ wget https://get.helm.sh/helm-v2.16.3-linux-amd64.tar.gz 3.1.2è§£å‹ç¼©å¹¶æ‹·è´helmäºŒè¿›åˆ¶æ–‡ä»¶ tar xf helm-v2.16.3-linux-amd64.tar.gz cp linux-amd64/helm /usr/local/bin æœåŠ¡ç«¯tillerå®‰è£… 3.1.3é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹å®‰è£…socat å¦åˆ™ä¼šæŠ¥é”™Error: cannot connect to Tiller yum install -y socat 3.1.4åˆå§‹åŒ–helmï¼Œéƒ¨ç½²tiller Tiller æ˜¯ä»¥ Deployment æ–¹å¼éƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­çš„ï¼Œåªéœ€æ‰§è¡Œhelm initå‘½ä»¤ä¾¿å¯ç®€å•çš„å®Œæˆå®‰è£…ï¼Œä½†æ˜¯Helmé»˜è®¤ä¼šå» storage.googleapis.com æ‹‰å–é•œåƒã€‚ã€‚ã€‚ã€‚ã€‚ã€‚è¿™é‡Œéœ€è¦ä½¿ç”¨é˜¿é‡Œäº‘çš„ä»“åº“å®Œæˆå®‰è£… #æ·»åŠ é˜¿é‡Œäº‘çš„ä»“åº“ helm init --client-only --stable-repo-url https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts/ helm repo add incubator https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/ helm repo update #åˆ›å»ºæœåŠ¡ç«¯ ä½¿ç”¨-iæŒ‡å®šé˜¿é‡Œäº‘ä»“åº“ helm init --service-account tiller --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.3 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts #åˆ›å»ºTLSè®¤è¯æœåŠ¡ç«¯ï¼Œå‚è€ƒåœ°å€ï¼š#https://github.com/gjmzj/kubeasz/blob/master/docs/guide/helm.md helm init --service-account tiller --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.3 --tiller-tls-cert /etc/kubernetes/ssl/tiller001.pem --tiller-tls-key /etc/kubernetes/ssl/tiller001-key.pem --tls-ca-cert /etc/kubernetes/ssl/ca.pem --tiller-namespace kube-system --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts 3.1.5ç»™tilleræˆæƒ å› ä¸º Helm çš„æœåŠ¡ç«¯ Tiller æ˜¯ä¸€ä¸ªéƒ¨ç½²åœ¨ Kubernetes ä¸­ kube-system namespaceä¸‹çš„deploymentï¼Œå®ƒä¼šå»è¿æ¥ kube-apiåœ¨Kubernetesé‡Œåˆ›å»ºå’Œåˆ é™¤åº”ç”¨ã€‚ è€Œä»Kubernetes1.6ç‰ˆæœ¬å¼€å§‹ï¼ŒAPI Server å¯ç”¨äº†RBACæˆæƒã€‚ç›®å‰çš„Tilleréƒ¨ç½²æ—¶é»˜è®¤æ²¡æœ‰å®šä¹‰æˆæƒçš„ServiceAccountï¼Œè¿™ä¼šå¯¼è‡´è®¿é—®API Serveræ—¶è¢«æ‹’ç»ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸ºTilleréƒ¨ç½²æ·»åŠ æˆæƒã€‚ åˆ›å»º Kubernetes çš„æœåŠ¡å¸å·å’Œç»‘å®šè§’è‰² #åˆ›å»ºserviceaccount kubectl create serviceaccount --namespace kube-system tiller #åˆ›å»ºè§’è‰²ç»‘å®š kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller ä¸ºtillerè®¾ç½®å¸å· #ä½¿ç”¨kubectl patchæ›´æ–°APIå¯¹è±¡ kubectl patch deploy --namespace kube-system tiller-deploy -p '{\"spec\":{\"template\":{\"spec\":{\"serviceAccount\":\"tiller\"}}}}' #éªŒè¯æ˜¯å¦æˆæƒæˆåŠŸ kubectl get deploy --namespace kube-system tiller-deploy --output yaml|grep serviceAccount serviceAccount: tiller serviceAccountName: tiller 3.1.6éªŒè¯tilleræ˜¯å¦å®‰è£…æˆåŠŸ kubectl -n kube-system get pods|grep tiller tiller-deploy-6d8dfbb696-4cbcz 1/1 Running 0 88s è¾“å…¥å‘½ä»¤ helm version æ˜¾ç¤ºç»“æœä»¥ä¸‹æ—¢ä¸ºæˆåŠŸ Client: &version.Version{SemVer:\"v2.16.3\", GitCommit:\"1ee0254c86d4ed6887327dabed7aa7da29d7eb0d\", GitTreeState:\"clean\"} Server: &version.Version{SemVer:\"v2.16.3\", GitCommit:\"1ee0254c86d4ed6887327dabed7aa7da29d7eb0d\", GitTreeState:\"clean\"} 3.1.7å¸è½½helmæœåŠ¡ç«¯tiller $ helm reset æˆ– $ helm reset -f å¼ºåˆ¶åˆ é™¤ 3.2å®‰è£…nfså­˜å‚¨ å®˜æ–¹æä¾›çš„openebså­˜å‚¨è²Œä¼¼ä¸å¤ªå¥½ä½¿ï¼Œåæ­£æˆ‘æ˜¯å®‰è£…å®Œåpodçš„çŠ¶æ€ä¸€ç›´æ˜¯pending nfså­˜å‚¨æ¯”è¾ƒç®€å•ï¼Œé€‚åˆå®éªŒç¯å¢ƒ ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«çš„æŒä¹…åŒ–å­˜å‚¨ å®‰è£…nfså‚è€ƒæ–‡ç«  nfsè¿™é‡Œé€‰æ‹©åœ¨masterå®‰è£…ï¼Œä¸Šè¾¹çš„å‚è€ƒæ–‡ç« ä¸­è¯´nfs serverå®‰è£…åœ¨masterèŠ‚ç‚¹ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯æˆ‘è¿™é‡Œæ²¡æœ‰ 3.2.1å®‰è£…é…ç½®nfs clientç«¯ï¼Œè¿™é‡Œä¸ºä¸¤ä¸ªnodeèŠ‚ç‚¹ yum -y install nfs-utils serverç«¯ï¼ŒmasterèŠ‚ç‚¹ 1.å®‰è£…åŒ… yum -y install nfs-utils rpcbind 2.ç¼–è¾‘é…ç½®æ–‡ä»¶ âš ï¸é…ç½®æ–‡ä»¶ä¸­çš„*æ˜¯å…è®¸æ‰€æœ‰ç½‘æ®µï¼Œæ ¹æ®è‡ªå·±å®é™…æƒ…å†µå†™æ˜ç½‘æ®µ cat >/etc/exports é…ç½®storageclassï¼Œæ³¨æ„ä¿®æ”¹nfsæœåŠ¡ç«¯IPå’Œå…±äº«ç›®å½• cat >storageclass.yaml åˆ›å»ºstorageclass kubectl apply -f storageclass.yaml è®¾ç½®é»˜è®¤strorageclass kubectl patch storageclass nfs-storage -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}' æ£€æŸ¥nfs-client podçŠ¶æ€ #è¿™é‡Œæ˜¯åœ¨defaultå‘½åç©ºé—´ä¸‹åˆ›å»ºçš„ kubectl get pods NAME READY STATUS RESTARTS AGE nfs-client-provisioner-7b9746695c-nrz4n 1/1 Running 0 2m38s æ£€æŸ¥é»˜è®¤å­˜å‚¨ #è¿™é‡Œæ˜¯åœ¨defaultå‘½åç©ºé—´ä¸‹åˆ›å»ºçš„ kubectl get sc NAME PROVISIONER AGE nfs-storage (default) fuseim.pri/ifs 7m22s 3.3éƒ¨ç½²kubesphere å®˜æ–¹æ–‡æ¡£ 3.3.1æœ€å°åŒ–å®‰è£… KubeSphere kubectl apply -f https://raw.githubusercontent.com/kubesphere/ks-installer/master/kubesphere-minimal.yaml 3.3.2æŸ¥çœ‹å®‰è£…æ—¥å¿— #ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å®‰è£…æ—¥å¿— kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath='{.items[0].metadata.name}') -f å½“æ—¥å¿—æœ€åæç¤ºå¦‚ä¸‹å³è¡¨æ˜å®‰è£…å®Œæˆï¼Œä½†æ˜¯è¿˜æ˜¯è¦ç­‰å¾…ä¸€äº›podå®Œå…¨è¿è¡Œèµ·æ¥æ‰å¯ä»¥ Start installing monitoring ************************************************** task monitoring status is successful total: 1 completed:1 ************************************************** ##################################################### ### Welcome to KubeSphere! ### ##################################################### Console: http://192.168.9.10:30880 Account: admin Password: P@88w0rd NOTESï¼š 1. After logging into the console, please check the monitoring status of service components in the \"Cluster Status\". If the service is not ready, please wait patiently. You can start to use when all components are ready. 2. Please modify the default password after login. ##################################################### å®‰è£…æ—¥å¿—ä¸­ä¼šæœ‰ä¸€ä¸ªæŠ¥é”™å¦‚ä¸‹ï¼Œä½†æ˜¯æ²¡æœ‰å½±å“ TASK [ks-core/ks-core : KubeSphere | Delete Ingress-controller configmap] ****** fatal: [localhost]: FAILED! => {\"changed\": true, \"cmd\": \"/usr/local/bin/kubectl delete cm -n kubesphere-system ks-router-config\\n\", \"delta\": \"0:00:00.562513\", \"end\": \"2020-04-28 07:18:28.772284\", \"msg\": \"non-zero return code\", \"rc\": 1, \"start\": \"2020-04-28 07:18:28.209771\", \"stderr\": \"Error from server (NotFound): configmaps \\\"ks-router-config\\\" not found\", \"stderr_lines\": [\"Error from server (NotFound): configmaps \\\"ks-router-config\\\" not found\"], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring æ£€æŸ¥æ‰€æœ‰podçŠ¶æ€ï¼Œéƒ½ä¸ºrunningæ‰å¯ä»¥ kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE default nfs-client-provisioner-7b9746695c-nrz4n 1/1 Running 0 18m kube-system calico-kube-controllers-bc44d789c-ksgnt 1/1 Running 0 39h kube-system calico-node-2t4gr 1/1 Running 0 39h kube-system calico-node-5bzjl 1/1 Running 0 39h kube-system calico-node-fjdll 1/1 Running 0 39h kube-system coredns-58cc8c89f4-8jrlt 1/1 Running 0 39h kube-system coredns-58cc8c89f4-nt5z5 1/1 Running 0 39h kube-system etcd-k8s-master1 1/1 Running 0 39h kube-system kube-apiserver-k8s-master1 1/1 Running 0 39h kube-system kube-controller-manager-k8s-master1 1/1 Running 0 39h kube-system kube-proxy-b7vj4 1/1 Running 0 39h kube-system kube-proxy-bghx7 1/1 Running 0 39h kube-system kube-proxy-ntrxx 1/1 Running 0 39h kube-system kube-scheduler-k8s-master1 1/1 Running 0 39h kube-system kuboard-756d46c4d4-dwzwt 1/1 Running 0 39h kube-system metrics-server-78cff478b7-lwcfl 1/1 Running 0 39h kube-system tiller-deploy-6d8dfbb696-ldpjd 1/1 Running 0 40m kubernetes-dashboard dashboard-metrics-scraper-b68468655-t2wgd 1/1 Running 0 39h kubernetes-dashboard kubernetes-dashboard-64999dbccd-zwnn5 1/1 Running 1 39h kubesphere-controls-system default-http-backend-5d464dd566-5hlzs 1/1 Running 0 6m9s kubesphere-controls-system kubectl-admin-6c664db975-kp6r5 1/1 Running 0 3m10s kubesphere-monitoring-system kube-state-metrics-566cdbcb48-cc4fv 4/4 Running 0 5m32s kubesphere-monitoring-system node-exporter-5lvpx 2/2 Running 0 5m32s kubesphere-monitoring-system node-exporter-hlfbh 2/2 Running 0 5m32s kubesphere-monitoring-system node-exporter-qxkm6 2/2 Running 0 5m32s kubesphere-monitoring-system prometheus-k8s-0 3/3 Running 1 4m32s kubesphere-monitoring-system prometheus-k8s-system-0 3/3 Running 1 4m32s kubesphere-monitoring-system prometheus-operator-6b97679cfd-6dztx 1/1 Running 0 5m32s kubesphere-system ks-account-596657f8c6-kzx9w 1/1 Running 0 5m56s kubesphere-system ks-apigateway-78bcdc8ffc-2rvbg 1/1 Running 0 5m58s kubesphere-system ks-apiserver-5b548d7c5c-dxqt7 1/1 Running 0 5m57s kubesphere-system ks-console-78bcf96dbf-kdh7q 1/1 Running 0 5m53s kubesphere-system ks-controller-manager-696986f8d9-fklzv 1/1 Running 0 5m55s kubesphere-system ks-installer-75b8d89dff-zm6fl 1/1 Running 0 7m49s kubesphere-system openldap-0 1/1 Running 0 6m21s kubesphere-system redis-6fd6c6d6f9-dqh2s 1/1 Running 0 6m25s è®¿é—®kubesphere:30880 ç™»é™†åé¦–ç•Œé¢ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/mitaka/1.centos7.8æ­å»ºopenstack Mitakaç‰ˆ.html":{"url":"linux/openstack/mitaka/1.centos7.8æ­å»ºopenstack Mitakaç‰ˆ.html","title":"centos7.8æ­å»ºopenstack Mitakaç‰ˆ","keywords":"","body":"centos7.8æ­å»ºopenstack Mitakaç‰ˆ openstackä¸­æ–‡æ–‡æ¡£ mitakaç‰ˆå®˜æ–¹æ–‡æ¡£ mitakaç‰ˆå¯†ç è¯´æ˜ å¯†ç åç§° æè¿° æ•°æ®åº“å¯†ç (ä¸èƒ½ä½¿ç”¨å˜é‡) æ•°æ®åº“çš„rootå¯†ç  ADMIN_PASS admin ç”¨æˆ·å¯†ç  CEILOMETER_DBPASS Telemetry æœåŠ¡çš„æ•°æ®åº“å¯†ç  CEILOMETER_PASS Telemetry æœåŠ¡çš„ ceilometer ç”¨æˆ·å¯†ç  CINDER_DBPASS å—è®¾å¤‡å­˜å‚¨æœåŠ¡çš„æ•°æ®åº“å¯†ç  CINDER_PASS å—è®¾å¤‡å­˜å‚¨æœåŠ¡çš„ cinder å¯†ç  DASH_DBPASS Database password for the dashboard DEMO_PASS demo ç”¨æˆ·çš„å¯†ç  GLANCE_DBPASS é•œåƒæœåŠ¡çš„æ•°æ®åº“å¯†ç  GLANCE_PASS é•œåƒæœåŠ¡çš„ glance ç”¨æˆ·å¯†ç  HEAT_DBPASS OrchestrationæœåŠ¡çš„æ•°æ®åº“å¯†ç  HEAT_DOMAIN_PASS Orchestration åŸŸçš„å¯†ç  HEAT_PASS Orchestration æœåŠ¡ä¸­heatç”¨æˆ·çš„å¯†ç  KEYSTONE_DBPASS è®¤è¯æœåŠ¡çš„æ•°æ®åº“å¯†ç  NEUTRON_DBPASS ç½‘ç»œæœåŠ¡çš„æ•°æ®åº“å¯†ç  NEUTRON_PASS ç½‘ç»œæœåŠ¡çš„ neutron ç”¨æˆ·å¯†ç  NOVA_DBPASS è®¡ç®—æœåŠ¡çš„æ•°æ®åº“å¯†ç  NOVA_PASS è®¡ç®—æœåŠ¡ä¸­novaç”¨æˆ·çš„å¯†ç  RABBIT_PASS RabbitMQçš„guestç”¨æˆ·å¯†ç  SWIFT_PASS å¯¹è±¡å­˜å‚¨æœåŠ¡ç”¨æˆ·swiftçš„å¯†ç  å®éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå é»˜è®¤ç½‘å…³ ç¡¬ä»¶ç¯å¢ƒ è™šæ‹ŸåŒ– é˜²ç«å¢™ selinux æ§åˆ¶èŠ‚ç‚¹ 10.0.0.11/24 controller 10.0.0.1 4Gå†…å­˜ï¼Œ50Gç¡¬ç›˜ å¼€å¯ å…³é—­ å…³é—­ è®¡ç®—èŠ‚ç‚¹ 10.0.0.31/24 compute1 10.0.0.1 4Gå†…å­˜ï¼Œ50Gç¡¬ç›˜ å¼€å¯ å…³é—­ å…³é—­ ä¸€ã€åŸºç¡€ç¯å¢ƒé…ç½® 1.1 å…³é—­é˜²ç«å¢™å’Œselinux //ç¦ç”¨é˜²ç«å¢™ systemctl stop firewalld && systemctl disable firewalld //ç¦ç”¨selinux #ä¸´æ—¶ä¿®æ”¹ setenforce 0 #æ°¸ä¹…ä¿®æ”¹ï¼Œé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆ sed -i '7s/enforcing/disabled/' /etc/selinux/config 1.2 é…ç½®hostsè§£æ #æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹ç›¸åŒæ“ä½œ cat >> /etc/hosts 1.3 é…ç½®NTPæœåŠ¡ï¼Œè¦ä¿è¯æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹æ—¶é—´ä¸€è‡´ æ§åˆ¶èŠ‚ç‚¹ 1.å®‰è£…chrony yum -y install chrony 2.ç¼–è¾‘chronyé…ç½®æ–‡ä»¶/etc/chrony.conf /åˆ é™¤ä»¥ä¸‹4è¡Œï¼Œä½¿ç”¨é˜¿é‡Œäº‘NTPæœåŠ¡å™¨ server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst ä¿®æ”¹ä¸º server ntp1.aliyun.com iburst /å…è®¸è¿æ¥æ§åˆ¶èŠ‚ç‚¹çš„ç½‘æ®µï¼Œ24è¡Œå¢åŠ ä»¥ä¸‹ä¸€è¡Œ allow 10.0.0.0/24 #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i '3,6d' /etc/chrony.conf && sed -i '3cserver ntp1.aliyun.com iburst' \\ /etc/chrony.conf && sed -i '23callow 10.0.0.0/24' /etc/chrony.conf 3.å¯åŠ¨NTPæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable chronyd && systemctl start chronyd 4.æ£€æŸ¥ç«¯å£ï¼Œç›‘å¬udp323ç«¯å£ netstat -nupl|grep chronyd udp 0 0 127.0.0.1:323 0.0.0.0:* 29356/chronyd udp 0 0 0.0.0.0:123 0.0.0.0:* 29356/chronyd udp6 0 0 ::1:323 :::* 29356/chronyd 5.éªŒè¯ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* 8.8.8.8 2 6 37 29 +43us[ -830us] +/- 22ms è®¡ç®—èŠ‚ç‚¹ 1.å®‰è£…chrony yum -y install chrony 2.ç¼–è¾‘chronyé…ç½®æ–‡ä»¶/etc/chrony.conf /åˆ é™¤ä»¥ä¸‹4è¡Œï¼ŒæŒ‡å®šæ§åˆ¶èŠ‚ç‚¹ä¸ºNTPæœåŠ¡å™¨ server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst ä¿®æ”¹ä¸º server controller iburst #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i '3,6d' /etc/chrony.conf && sed -i '3cserver controller iburst' /etc/chrony.conf 3.å¯åŠ¨NTPæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable chronyd && systemctl start chronyd 4.æ£€æŸ¥ç«¯å£ï¼Œç›‘å¬udp323ç«¯å£ netstat -nupl|grep chronyd udp 0 0 127.0.0.1:323 0.0.0.0:* 1327/chronyd udp6 0 0 ::1:323 :::* 1327/chronyd 5.éªŒè¯ï¼Œè®¡ç®—èŠ‚ç‚¹æ˜¾ç¤ºçš„æ˜¯æ§åˆ¶èŠ‚ç‚¹ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^? controller 3 6 200 50 +1319ms[+1319ms] +/- 14.4s 1.4ä¸‹è½½openstackå®˜æ–¹yumæºå®‰è£…openstackå®¢æˆ·ç«¯ âš ï¸Mitakaç‰ˆå®˜æ–¹æ–‡æ¡£ä¸­ç›´æ¥å®‰è£…centos-release-openstack-mitakaä¼šæç¤ºæ²¡æœ‰å¯ç”¨åŒ…(ä½¿ç”¨çš„æ˜¯é˜¿é‡Œäº‘çš„yumæº)ï¼Œå¾—å…ˆä¸‹è½½ä¸€ä¸ªåŒ…æ‰å¯ä»¥ç»§ç»­å®‰è£…ï¼ï¼ï¼ ä¸‹è½½å®˜æ–¹yumæºæç¤ºæ— åŒ…å¯ç”¨è§£å†³æ–¹æ³• å…³äºmç‰ˆå®‰è£…çš„å‘ï¼Œæç¤ºæ— å®‰è£…åŒ… å…·ä½“è§£å†³æ–¹æ³• æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹ç›¸åŒæ“ä½œ #ä¸‹è½½yumæºå¹¶å®‰è£…openstackå®¢æˆ·ç«¯ wget https://cbs.centos.org/kojifiles/packages/centos-release-openstack-mitaka/1/1.el7/noarch/centos-release-openstack-mitaka-1-1.el7.noarch.rpm yum -y localinstall centos-release-openstack-mitaka-1-1.el7.noarch.rpm yum -y install python-openstackclient åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹æ“ä½œå®Œæˆï¼ï¼ï¼ äºŒã€æ§åˆ¶èŠ‚ç‚¹ç¯å¢ƒå®‰è£… 2.1 å®‰è£…mariadbæ•°æ®åº“ 1.å®‰è£…mariadbæ•°æ®åº“ yum -y install mariadb mariadb-server python2-PyMySQL 2.åˆ›å»ºå¹¶ç¼–è¾‘ /etc/my.cnf.d/openstack.cnf åœ¨[mysqld]ä¸­ï¼Œè®¾ç½®â€œbind-addressâ€å€¼ä¸ºæ§åˆ¶èŠ‚ç‚¹çš„ç®¡ç†ç½‘ç»œIPåœ°å€ä»¥ä½¿å¾—å…¶ä»–èŠ‚ç‚¹å¯ä»¥é€šè¿‡ç®¡ç†ç½‘ç»œè®¿é—®è®¿é—®æ•°æ®åº“ã€‚è®¾ç½®å…¶ä»–å…³é”®å­—æ¥è®¾ç½®ä¸€äº›æœ‰ç”¨çš„é€‰é¡¹å’ŒUTF-8ç¼–ç  cat > /etc/my.cnf.d/openstack.cnf 2.2 å®‰è£…MongoDBæ•°æ®åº“ Telemetry æœåŠ¡ä½¿ç”¨ NoSQL æ•°æ®åº“æ¥å­˜å‚¨ä¿¡æ¯ï¼Œå…¸å‹åœ°ï¼Œè¿™ä¸ªæ•°æ®åº“è¿è¡Œåœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šã€‚å‘å¯¼ä¸­ä½¿ç”¨MongoDBã€‚ mongodbç›‘å¬tcp/27017 1.å®‰è£…MongoDBæ•°æ®åº“ yum -y install mongodb-server mongodb 2.ç¼–è¾‘æ–‡ä»¶/etc/mongod.conf é…ç½® bind_ip ä½¿ç”¨æ§åˆ¶èŠ‚ç‚¹ç®¡ç†ç½‘å¡çš„IPåœ°å€ ä¿®æ”¹ç¬¬6è¡Œä¸º bind_ip = 10.0.0.11 é»˜è®¤æƒ…å†µä¸‹ï¼ŒMongoDBä¼šåœ¨``/var/lib/mongodb/journal`` ç›®å½•ä¸‹åˆ›å»ºå‡ ä¸ª1GBå¤§å°çš„æ—¥å¿—æ–‡ä»¶ã€‚å¦‚æœä½ æƒ³å°†æ¯ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°å‡å°åˆ°128MBå¹¶ä¸”é™åˆ¶æ—¥å¿—æ–‡ä»¶å ç”¨çš„æ€»ç©ºé—´ä¸º512MBï¼Œé…ç½® smallfiles çš„å€¼ å–æ¶ˆç¬¬113è¡Œæ³¨é‡Š smallfiles = true #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i.bak '/^bind_ip/cbind_ip = 10.0.0.11' /etc/mongod.conf \\ && sed -i 's/#smallfiles = true/smallfiles = true/' /etc/mongod.conf 3.å¯åŠ¨MongoDBå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ systemctl enable mongod && systemctl start mongod 2.3 å®‰è£…æ¶ˆæ¯é˜Ÿåˆ—rabbitmq OpenStack ä½¿ç”¨ message queue åè°ƒæ“ä½œå’Œå„æœåŠ¡çš„çŠ¶æ€ä¿¡æ¯ã€‚æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ä¸€èˆ¬è¿è¡Œåœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Š rabbitmqä¼šå¯åŠ¨2ä¸ªç«¯å£ tcp/5672 rabbitmqæœåŠ¡ç«¯å£ tcp/25672 å¤šä¸ªrabbitmqé€šä¿¡ç”¨åˆ°çš„ç«¯å£ 1.å®‰è£…rabbitmq yum -y install rabbitmq-server 2.å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—rabbitmqå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ systemctl enable rabbitmq-server && systemctl start rabbitmq-server 3.æ·»åŠ openstackç”¨æˆ· rabbitmqctl add_user openstack RABBIT_PASS Creating user \"openstack\" 4.ç»™openstackç”¨æˆ·è®¾ç½®è¯»å’Œå†™æƒé™ 3ä¸ª.*åˆ†åˆ«æ˜¯ å¯è¯»ã€å¯å†™ã€å¯é…ç½® rabbitmqctl set_permissions openstack \".*\" \".*\" \".*\" Setting permissions for user \"openstack\" in vhost \"/\" 5.å¯åŠ¨rabbitmqä¸€ä¸ªæ’ä»¶ï¼Œå¯åŠ¨ä¹‹åä¼šç›‘å¬tcp/15672ï¼Œæ˜¯ä¸€ä¸ªwebç®¡ç†ç•Œé¢ï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç guest rabbitmq-plugins enable rabbitmq_management The following plugins have been enabled: amqp_client cowlib cowboy rabbitmq_web_dispatch rabbitmq_management_agent rabbitmq_management Applying plugin configuration to rabbit@controller... started 6 plugins. 2.4 å®‰è£…memcached è®¤è¯æœåŠ¡è®¤è¯ç¼“å­˜ä½¿ç”¨Memcachedç¼“å­˜ä»¤ç‰Œã€‚ç¼“å­˜æœåŠ¡memecachedè¿è¡Œåœ¨æ§åˆ¶èŠ‚ç‚¹ã€‚åœ¨ç”Ÿäº§éƒ¨ç½²ä¸­ï¼Œæˆ‘ä»¬æ¨èè”åˆå¯ç”¨é˜²ç«å¢™ã€è®¤è¯å’ŒåŠ å¯†ä¿è¯å®ƒçš„å®‰å…¨ã€‚ memcacheç›‘å¬ tcp/udp 11211ç«¯å£ 1.å®‰è£…è½¯ä»¶åŒ… yum -y install memcached python-memcached 2.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®memcacheç›‘å¬ç«¯å£ä¸ºæ§åˆ¶èŠ‚ç‚¹ï¼Œé»˜è®¤ç›‘å¬127.0.0.1 sed -i.bak 's#127.0.0.1#10.0.0.11#g' /etc/sysconfig/memcached 3.å¯åŠ¨memcachedå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ systemctl enable memcached && systemctl start memcached åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹ç¯å¢ƒå®‰è£…å®Œæˆï¼ï¼ï¼ ä¸‰ã€æ§åˆ¶èŠ‚ç‚¹è®¤è¯æœåŠ¡keystoneå®‰è£… keystoneè®¤è¯æœåŠ¡åŠŸèƒ½ï¼šè®¤è¯ç®¡ç†ã€æˆæƒç®¡ç†ã€æœåŠ¡ç›®å½• è®¤è¯ï¼šç”¨æˆ·åå’Œå¯†ç  æˆæƒï¼šæˆæƒç®¡ç†ï¼Œä¾‹å¦‚ä¸€äº›æŠ€æœ¯ç½‘ç«™(æ˜é‡‘ã€csdn)å¯ä»¥æˆæƒå¾®ä¿¡ã€QQç™»é™† æœåŠ¡ç›®å½•ï¼šç›¸å½“äºé€šè®¯å½•ï¼Œå³è¦è®¿é—®openstackçš„é•œåƒã€ç½‘ç»œã€å­˜å‚¨ç­‰æœåŠ¡ï¼Œåªéœ€è¦æ‰¾åˆ°keystoneå³å¯ï¼Œè€Œä¸éœ€è¦å†å•ç‹¬è®°ä½å„ä¸ªæœåŠ¡çš„è®¿é—®åœ°å€ åç»­æ¯å®‰è£…ä¸€ä¸ªæœåŠ¡éƒ½éœ€è¦åœ¨keystoneä¸Šæ³¨å†Œ 3.1 åˆ›å»ºkeystoneæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤æ“ä½œ mysql -e \"CREATE DATABASE keystone;\" mysql -e \"GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \\ IDENTIFIED BY 'KEYSTONE_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \\ IDENTIFIED BY 'KEYSTONE_DBPASS';\" 3.2 é…ç½®keystron 3.2.1 å®‰è£…å’Œé…ç½®keystron keystoneå€ŸåŠ©apacheè®¿é—® mod_wsgiæ˜¯å¸®åŠ©apacheè¿æ¥pythonç¨‹åº ç›‘å¬ç«¯å£ 5000(æ™®é€šç”¨æˆ·è®¿é—®) 35357(ç®¡ç†å‘˜ç”¨æˆ·è®¿é—®)ï¼Œapacheåšäº†2ä¸ªå¤šç«¯å£çš„ç«™ç‚¹ 1.å®‰è£…ç›¸å…³åŒ… yum -y install openstack-keystone httpd mod_wsgi openstack-utils.noarch 2.ç¼–è¾‘æ–‡ä»¶ /etc/keystone/keystone.conf å¹¶å®Œæˆå¦‚ä¸‹åŠ¨ä½œï¼š åœ¨ [database] éƒ¨åˆ†ï¼Œé…ç½®æ•°æ®åº“è®¿é—®ï¼š [root@controller ~]# vim /etc/keystone/keystone.conf [database] connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone åœ¨[token]éƒ¨åˆ†ï¼Œé…ç½®Fernet UUIDä»¤ç‰Œçš„æä¾›è€… [token] provider = fernet #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/keystone/keystone.conf{,.bak} grep -Ev '^$|#' /etc/keystone/keystone.conf.bak >/etc/keystone/keystone.conf openstack-config --set /etc/keystone/keystone.conf DEFAULT admin_token ADMIN_TOKEN openstack-config --set /etc/keystone/keystone.conf database connection mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone openstack-config --set /etc/keystone/keystone.conf token provider fernet MD5å€¼ md5sum /etc/keystone/keystone.conf d5acb3db852fe3f247f4f872b051b7a9 /etc/keystone/keystone.conf 3.åˆå§‹åŒ–èº«ä»½è®¤è¯æœåŠ¡çš„æ•°æ®åº“ï¼ˆåˆ‡æ¢åˆ°keystoneç”¨æˆ·ï¼Œä½¿ç”¨çš„shellæ˜¯/bin/shï¼Œæ‰§è¡Œ -cåçš„å‘½ä»¤ï¼‰ su -s /bin/sh -c \"keystone-manage db_sync\" keystone ä¸Šä¸€æ­¥æ“ä½œä¸ºå¯¼å…¥è¡¨ï¼Œä»¥ä¸‹å‘½ä»¤æ‰§è¡Œè¿”å›æœ‰è¡¨å³ä¸ºæ­£ç¡® mysql keystone -e \"show tables;\"|wc -l 38 4.åˆå§‹åŒ–Fernet key keystone-manage fernet_setup --keystone-user keystone \\ --keystone-group keystone 5.é…ç½®ApacheæœåŠ¡å™¨ 5.1ç¼–è¾‘/etc/httpd/conf/httpd.conf`æ–‡ä»¶ï¼Œé…ç½®``ServerName`` é€‰é¡¹ä¸ºæ§åˆ¶èŠ‚ç‚¹ 96è¡Œä¸‹å…¥ä»¥ä¸‹ä¸€è¡Œ ServerName controller #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i.bak '96cServerName controller' /etc/httpd/conf/httpd.conf MD5å€¼ md5sum /etc/httpd/conf/httpd.conf eaf0e2ae3fea84bac3e5a842f64bdfdb /etc/httpd/conf/httpd.conf 5.2åˆ›å»ºæ–‡ä»¶/etc/httpd/conf.d/wsgi-keystone.conf cat > /etc/httpd/conf.d/wsgi-keystone.conf WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP} WSGIProcessGroup keystone-public WSGIScriptAlias / /usr/bin/keystone-wsgi-public WSGIApplicationGroup %{GLOBAL} WSGIPassAuthorization On ErrorLogFormat \"%{cu}t %M\" ErrorLog /var/log/httpd/keystone-error.log CustomLog /var/log/httpd/keystone-access.log combined Require all granted WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP} WSGIProcessGroup keystone-admin WSGIScriptAlias / /usr/bin/keystone-wsgi-admin WSGIApplicationGroup %{GLOBAL} WSGIPassAuthorization On ErrorLogFormat \"%{cu}t %M\" ErrorLog /var/log/httpd/keystone-error.log CustomLog /var/log/httpd/keystone-access.log combined Require all granted EOF MD5å€¼ md5sum /etc/httpd/conf.d/wsgi-keystone.conf 8f051eb53577f67356ed03e4550315c2 /etc/httpd/conf.d/wsgi-keystone.conf 6.å¯åŠ¨apacheå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ systemctl enable httpd && systemctl start httpd 3.2.2 åˆ›å»ºæœåŠ¡å®ä½“å’ŒAPIç«¯ç‚¹ APIç«¯ç‚¹æœ‰3ä¸ª public å…¬å…± internal å†…éƒ¨ admin ç®¡ç†å‘˜ 1.å…ˆå†³æ¡ä»¶ #é…ç½®èº«ä»½éªŒè¯ä»¤ç‰Œ export OS_TOKEN=ADMIN_TOKEN #é…ç½®ç«¯ç‚¹URL export OS_URL=http://controller:35357/v3 #é…ç½®Identity APIç‰ˆæœ¬ export OS_IDENTITY_API_VERSION=3 2.åˆ›å»ºæœåŠ¡å®ä½“å’ŒAPIç«¯ç‚¹ 2.1 IdentityæœåŠ¡ç®¡ç†OpenStackç¯å¢ƒä¸­çš„æœåŠ¡ç›®å½•ã€‚æœåŠ¡ä½¿ç”¨æ­¤ç›®å½•æ¥ç¡®å®šæ‚¨çš„ç¯å¢ƒä¸­å¯ç”¨çš„å…¶ä»–æœåŠ¡ã€‚ ä¸ºIdentityæœåŠ¡åˆ›å»ºæœåŠ¡å®ä½“ openstack service create --name \\ keystone --description \"OpenStack Identity\" identity +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Identity | | enabled | True | | id | c7c0d1e96d7e4f809c2957099eb8a0d2 | | name | keystone | | type | identity | +-------------+----------------------------------+ 2.2 IdentityæœåŠ¡ç®¡ç†ä¸OpenStackç¯å¢ƒä¸­çš„æœåŠ¡å…³è”çš„APIç«¯ç‚¹çš„ç›®å½•ã€‚æœåŠ¡ä½¿ç”¨æ­¤ç›®å½•æ¥ç¡®å®šå¦‚ä½•ä¸ç¯å¢ƒä¸­çš„å…¶ä»–æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ OpenStackä¸ºæ¯é¡¹æœåŠ¡ä½¿ç”¨ä¸‰ç§APIç«¯ç‚¹å˜ä½“ï¼šadminï¼Œinternalå’Œpublicã€‚ç®¡ç†APIç«¯ç‚¹å…è®¸é»˜è®¤ä¿®æ”¹ç”¨æˆ·å’Œç§Ÿæˆ·ï¼Œè€Œå…¬å…±å’Œå†…éƒ¨APIä¸å…è®¸è¿™äº›æ“ä½œã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå‡ºäºå®‰å…¨åŸå› ï¼Œå˜ä½“å¯èƒ½é©»ç•™åœ¨ä¸ºä¸åŒç±»å‹çš„ç”¨æˆ·æä¾›æœåŠ¡çš„å•ç‹¬ç½‘ç»œä¸Šã€‚ä¾‹å¦‚ï¼Œå…¬å…±APIç½‘ç»œå¯èƒ½ä»Internetä¸Šå¯è§ï¼Œå› æ­¤å®¢æˆ·å¯ä»¥ç®¡ç†ä»–ä»¬çš„äº‘ã€‚ç®¡ç†APIç½‘ç»œå¯èƒ½ä»…é™äºç®¡ç†äº‘åŸºç¡€æ¶æ„çš„ç»„ç»‡å†…çš„è¿è¥å•†ã€‚å†…éƒ¨APIç½‘ç»œå¯èƒ½ä»…é™äºåŒ…å«OpenStackæœåŠ¡çš„ä¸»æœºã€‚æ­¤å¤–ï¼ŒOpenStackæ”¯æŒå¤šä¸ªåŒºåŸŸä»¥å®ç°å¯ä¼¸ç¼©æ€§ã€‚ä¸ºç®€å•èµ·è§ï¼Œæœ¬æŒ‡å—å°†ç®¡ç†ç½‘ç»œç”¨äºæ‰€æœ‰ç«¯ç‚¹å˜ä½“å’Œé»˜è®¤å€¼ RegionOneåœ°åŒºã€‚ åˆ›å»ºIdentity Service APIç«¯ç‚¹ï¼š #å…¬å…±æ™®é€šç”¨æˆ·ä½¿ç”¨5000ç«¯å£ openstack endpoint create --region RegionOne \\ identity public http://controller:5000/v3 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | f63e9c4450254214947ac75cddd394c1 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | c7c0d1e96d7e4f809c2957099eb8a0d2 | | service_name | keystone | | service_type | identity | | url | http://controller:5000/v3 | +--------------+----------------------------------+ #keystoneå†…éƒ¨é€šä¿¡ä½¿ç”¨5000ç«¯å£ openstack endpoint create --region RegionOne \\ identity internal http://controller:5000/v3 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 9b6a5be720ea46a4a38f403c47ad8b8f | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | c7c0d1e96d7e4f809c2957099eb8a0d2 | | service_name | keystone | | service_type | identity | | url | http://controller:5000/v3 | +--------------+----------------------------------+ #ç®¡ç†å‘˜ä½¿ç”¨35357ç«¯å£ openstack endpoint create --region RegionOne \\ identity admin http://controller:35357/v3 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 53d4bdc5bea041a0abfb9ea89dff65d6 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | c7c0d1e96d7e4f809c2957099eb8a0d2 | | service_name | keystone | | service_type | identity | | url | http://controller:35357/v3 | +--------------+----------------------------------+ åˆ›å»ºå®ŒAPIç«¯ç‚¹åä½¿ç”¨å‘½ä»¤openstack endpoint listéªŒè¯æ˜¯å¦åˆ›å»ºæˆåŠŸ openstack endpoint list +----------------------------------+-----------+--------------+--------------+---------+-----------+----------------------------+ | ID | Region | Service Name | Service Type | Enabled | Interface | URL | +----------------------------------+-----------+--------------+--------------+---------+-----------+----------------------------+ | 2f551bb367c045379a8042cdcb7287eb | RegionOne | keystone | identity | True | public | http://controller:5000/v3 | | 77b014a9b8d44d038cb5d608ff6b9d56 | RegionOne | keystone | identity | True | internal | http://controller:5000/v3 | | c2fcc9c1ee0244acb2860124a1575fd0 | RegionOne | keystone | identity | True | admin | http://controller:35357/v3 | +----------------------------------+-----------+--------------+--------------+---------+-----------+----------------------------+ åˆ é™¤APIç«¯ç‚¹ä½¿ç”¨openstack delete 3.3 åˆ›å»ºåŸŸã€é¡¹ç›®ã€ç”¨æˆ·å’Œè§’è‰² 3.3.1 åˆ›å»ºé»˜è®¤åŸŸ openstack domain create --description \"Default Domain\" default +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Default Domain | | enabled | True | | id | fad8700e172044e6ac4869c9eed6d2c3 | | name | default | +-------------+----------------------------------+ 3.3.2 ä¸ºç¯å¢ƒä¸­çš„ç®¡ç†æ“ä½œåˆ›å»ºç®¡ç†é¡¹ç›®ï¼Œç”¨æˆ·å’Œè§’è‰² 1.åˆ›å»ºç®¡ç†é¡¹ç›® openstack project create --domain default \\ --description \"Admin Project\" admin +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Admin Project | | domain_id | fad8700e172044e6ac4869c9eed6d2c3 | | enabled | True | | id | 9c1b0cb2b3914507b429f3f7b0c6b5e4 | | is_domain | False | | name | admin | | parent_id | fad8700e172044e6ac4869c9eed6d2c3 | +-------------+----------------------------------+ 2.åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸ºADMIN_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default \\ --password ADMIN_PASS admin +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | 984cb3d5f3054e16b029676de97b6ca6 | | enabled | True | | id | 273c94d5f389418b83ee6738376a6bdf | | name | admin | +-----------+----------------------------------+ #äº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default \\ --password-prompt admin User Password: Repeat User Password: +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | fad8700e172044e6ac4869c9eed6d2c3 | | enabled | True | | id | cc0f0af9f5c1492aa8919bf936c1c19b | | name | admin | +-----------+----------------------------------+ 3.åˆ›å»ºç®¡ç†å‘˜è§’è‰² openstack role create admin +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | None | | id | 921e36b9338141479f52f7c46c04f9ef | | name | admin | +-----------+----------------------------------+ 4.å°†adminè§’è‰²æ·»åŠ åˆ°adminé¡¹ç›®å’Œç”¨æˆ· openstack role add --project admin --user admin admin 3.3.3 æœ¬æŒ‡å—ä½¿ç”¨çš„æœåŠ¡é¡¹ç›®åŒ…å«æ‚¨æ·»åŠ åˆ°ç¯å¢ƒä¸­çš„æ¯é¡¹æœåŠ¡çš„å”¯ä¸€ç”¨æˆ· åˆ›å»ºæœåŠ¡é¡¹ç›® #serviceï¼ŒåæœŸç”¨äºå…³è”openstackç³»ç»Ÿç”¨æˆ·glanceã€novaã€neutron openstack project create --domain default \\ --description \"Service Project\" service +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Service Project | | domain_id | fad8700e172044e6ac4869c9eed6d2c3 | | enabled | True | | id | ae31639e04be474cbabcad502be62cac | | is_domain | False | | name | service | | parent_id | fad8700e172044e6ac4869c9eed6d2c3 | +-------------+----------------------------------+ 3.3.4 å¸¸è§„ï¼ˆéç®¡ç†å‘˜ï¼‰ä»»åŠ¡åº”è¯¥ä½¿ç”¨éç‰¹æƒé¡¹ç›®å’Œç”¨æˆ·ã€‚ä¾‹å¦‚ï¼Œæœ¬æŒ‡å—åˆ›å»ºäº†æ¼”ç¤ºé¡¹ç›®å’Œç”¨æˆ· 1.åˆ›å»ºæ¼”ç¤ºé¡¹ç›® openstack project create --domain default \\ --description \"Demo Project\" demo +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Demo Project | | domain_id | fad8700e172044e6ac4869c9eed6d2c3 | | enabled | True | | id | 6244aa0291104859b255990cef3eacd6 | | is_domain | False | | name | demo | | parent_id | fad8700e172044e6ac4869c9eed6d2c3 | +-------------+----------------------------------+ 2.åˆ›å»ºæ¼”ç¤ºç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸º123456 //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default \\ --password 123456 demo +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | af51b1180eb14a66b0380e4cd134df90 | | enabled | True | | id | c75ad14657d0497190cb479ba50f531b | | name | demo | +-----------+----------------------------------+ #äº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default \\ --password-prompt demo User Password: Repeat User Password: +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | fad8700e172044e6ac4869c9eed6d2c3 | | enabled | True | | id | 4639e42215a946b4be7e588d36979c64 | | name | demo | +-----------+----------------------------------+ 3.åˆ›å»ºç”¨æˆ·è§’è‰² openstack role create user +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | None | | id | a35f989b04d1403e92a19895cae21c9d | | name | user | +-----------+----------------------------------+ 4.å°†ç”¨æˆ·è§’è‰²æ·»åŠ åˆ°æ¼”ç¤ºé¡¹ç›®å’Œç”¨æˆ· openstack role add --project demo --user demo user 3.4 éªŒè¯æ“ä½œ 3.4.1 å‡ºäºå®‰å…¨åŸå› ï¼Œè¯·ç¦ç”¨ä¸´æ—¶èº«ä»½éªŒè¯ä»¤ç‰Œæœºåˆ¶ï¼š ç¼–è¾‘æ–‡ä»¶/etc/keystone/keystone-paste.iniå¹¶ä¸”ç§»é™¤admin_token_auth ä»[pipeline:public_api], [pipeline:admin_api],å’Œ[pipeline:api_v3] éƒ¨åˆ† è¿™ä¸€æ­¥æ“ä½œå¯èƒ½ä¼šé€ æˆåç»­keystoneè®¤è¯å¤±è´¥ï¼ï¼ï¼ï¼Œå®éªŒçš„æ—¶å€™å¯ä»¥ä¸æ‰§è¡Œï¼ï¼ï¼ sed -i.bak '51,64d' /etc/keystone/keystone-paste.ini 3.4.2 å–æ¶ˆè®¾ç½®ä¸´æ—¶OS_TOKENå’ŒOS_URLç¯å¢ƒå˜é‡ unset OS_TOKEN OS_URL 3.4.3 ä½œä¸ºadminç”¨æˆ·ï¼Œè¯·æ±‚èº«ä»½éªŒè¯ä»¤ç‰Œï¼Œå¯†ç ä¸ºADMIN_PASS openstack --os-auth-url http://controller:35357/v3 \\ --os-project-domain-name default --os-user-domain-name default \\ --os-project-name admin --os-username admin token issue Password: +------------+----------------------------------------------------------------------------------------------------------------------------------------------+ | Field | Value | +------------+----------------------------------------------------------------------------------------------------------------------------------------------+ | expires | 2019-01-31T05:46:45.000000Z | | id | gAAAAABcUn21ftl6WYlhMsqIffRDo9Pg6Ei35hUlg8D_kzw1Azy- | | | 4Ly1DeL0s3YbMOlz88jVFWnMyg2gaxFoVsS2pZYnRhVlnclg1yofFFHOENz39XHsuCUYICuDq4XqOLEbKWyS9IfZuNbWtKjEQa-jQaoe4PCk0fyFG0B6nE3vn9gNkOvXiTA | | project_id | 9c1b0cb2b3914507b429f3f7b0c6b5e4 | | user_id | cc0f0af9f5c1492aa8919bf936c1c19b | +------------+----------------------------------------------------------------------------------------------------------------------------------------------+ 3.4.4 ä½œä¸ºæ¼”ç¤ºç”¨æˆ·ï¼Œè¯·æ±‚èº«ä»½éªŒè¯ä»¤ç‰Œ âš ï¸æ‰§è¡Œ3.4.1å°±ä¼šæœ‰é—®é¢˜ï¼Œä¼šæŠ¥é”™HTTP 500 openstack --os-auth-url http://controller:5000/v3 \\ --os-project-domain-name default --os-user-domain-name default \\ --os-project-name demo --os-username demo token issue Password: Discovering versions from the identity service failed when creating the password plugin. Attempting to determine version from URL. Internal Server Error (HTTP 500) ä¸æ‰§è¡Œ3.4.1ï¼ŒéªŒè¯å°±æ²¡æœ‰é—®é¢˜ openstack --os-auth-url http://controller:5000/v3 \\ --os-project-domain-name default --os-user-domain-name default \\ --os-project-name demo --os-username demo token issue +------------+-----------------------------------------------------------------------------------------------------------------------------------------+ | Field | Value | +------------+-----------------------------------------------------------------------------------------------------------------------------------------+ | expires | 2019-01-31T10:30:43.000000Z | | id | gAAAAABeym2jDfXll4iZ2JcCP1XY1mHbu8Ovgaf8BMWe1FsoBp9XkaEqsnphx_BIuY0RFC-goS-JVZJ0xbiOajLnob7nWYKz5zlPlGkybvtDWd6L3jRMGD20RE- | | | H5gRz5oBXPPRUt9e5Kxbc-5_WXu_nfjw3ASXPIu25inoeeXsvd1aeg9FzgBE | | project_id | d08b00aa3c6944afa7095c280319acb9 | | user_id | ec75d657d09c4899894d40364011f552 | +------------+-----------------------------------------------------------------------------------------------------------------------------------------+ 3.5 åˆ›å»ºOpenStackå®¢æˆ·ç«¯ç¯å¢ƒè„šæœ¬ 3.5.1 åˆ›å»ºè„šæœ¬ ç¼–è¾‘admin-openrcæ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹,è¿™é‡Œæ”¾åœ¨/optä¸‹ cat > /opt/admin-openrc 3.5.2 ä½¿ç”¨è„šæœ¬ 1.åŠ è½½admin-openrcæ–‡ä»¶ï¼Œä½¿ç”¨IdentityæœåŠ¡çš„ä½ç½®ä»¥åŠadminé¡¹ç›®å’Œç”¨æˆ·å‡­æ®å¡«å……ç¯å¢ƒå˜é‡ source /opt/admin-openrc 2.è¯·æ±‚èº«ä»½éªŒè¯ä»¤ç‰Œï¼ˆæ³¨æ„expiresä¸­æ˜¯UTCæ—¶é—´ï¼Œè½åä¸­å›½8ä¸ªå°æ—¶ï¼Œæˆ‘å›½æ˜¯ä¸œå…«åŒºï¼Œä½¿ç”¨timedatectlæŸ¥çœ‹æ—¶é—´åŠæ—¶åŒºï¼Œé»˜è®¤è¿‡æœŸæ—¶é—´1å°æ—¶ï¼‰ openstack token issue +------------+----------------------------------------------------------------------------------------------------------------------------------------------+ | Field | Value | +------------+----------------------------------------------------------------------------------------------------------------------------------------------+ | expires | 2019-01-31T10:49:41.000000Z | | id | gAAAAABcUsS1O_B3QETf0hx8KWiuUyTBz23e2E70mY6DeWPvZreQrX58bEyJcMVgLGazsrKrqaJw0gSK75JHT0WNHf7V6VxNR5-uYLJKsGIuaUzNe9RMdTys_CcK680L- | | | NU9VdSDllR6GQvbu4EqejSm_1d5iarR2cQD8n8kG1PcV_SNijApskk | | project_id | e33e3feaef784a5bb45bd9c766bc0f46 | | user_id | aaa8bfce5b5d451b956bb76dee235b9e | +------------+----------------------------------------------------------------------------------------------------------------------------------------------+ åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹è®¤è¯æœåŠ¡keystoneå®‰è£…å®Œæˆï¼ï¼ï¼ å››ã€æ§åˆ¶èŠ‚ç‚¹é•œåƒæœåŠ¡glanceå®‰è£… OpenStacké•œåƒæœåŠ¡åŒ…æ‹¬ä»¥ä¸‹ç»„ä»¶ï¼š glance-api æ¥æ”¶é•œåƒAPIçš„è°ƒç”¨ï¼Œè¯¸å¦‚é•œåƒå‘ç°ã€æ¢å¤ã€å­˜å‚¨ glance-registry å­˜å‚¨ã€å¤„ç†å’Œæ¢å¤é•œåƒçš„å…ƒæ•°æ®(å±æ€§)ï¼Œå…ƒæ•°æ®åŒ…æ‹¬é¡¹è¯¸å¦‚å¤§å°å’Œç±»å‹ glanceæœåŠ¡ç›‘å¬ä¸¤ä¸ªç«¯å£ glance-api 9292 glance-registry 9191 4.1 åˆ›å»ºglanceæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ mysql -e \"CREATE DATABASE glance;\" mysql -e \"GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' \\ IDENTIFIED BY 'GLANCE_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \\ IDENTIFIED BY 'GLANCE_DBPASS';\" 4.2 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—® source /opt/admin-openrc 4.3 åˆ›å»ºæœåŠ¡å‡­æ® 4.3.1 åˆ›å»ºglanceç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸ºGLANCE_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default --password GLANCE_PASS glance +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | af51b1180eb14a66b0380e4cd134df90 | | enabled | True | | id | 593894e4dabc411ebecf8cbe8f3f1109 | | name | glance | +-----------+----------------------------------+ #äº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default --password-prompt glance User Password: Repeat User Password: +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | b245194b1e8749d0b3c51a78e05d7734 | | enabled | True | | id | ff135a9cce5e4a55842dd2beaffa67e2 | | name | glance | +-----------+----------------------------------+ 4.3.2 å°†ç®¡ç†è§’è‰²æ·»åŠ åˆ°glanceç”¨æˆ·å’ŒæœåŠ¡é¡¹ç›®ä¸­ openstack role add --project service --user glance admin 4.3.3 åˆ›å»ºglanceæœåŠ¡å®ä½“ openstack service create --name glance \\ --description \"OpenStack Image\" image +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Image | | enabled | True | | id | de2e6d60f6234918a96f768516a36e9a | | name | glance | | type | image | +-------------+----------------------------------+ åˆ é™¤æœåŠ¡å®ä½“ä½¿ç”¨å‘½ä»¤openstack service delete ä½¿ç”¨å‘½ä»¤openstack service listæŸ¥çœ‹service-idç„¶åæ ¹æ®idåˆ é™¤ 4.3.4 åˆ›å»ºImageæœåŠ¡APIç«¯ç‚¹ openstack endpoint create --region RegionOne \\ image public http://controller:9292 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 7aede44313aa4f98971c513fb6aa37b9 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | de2e6d60f6234918a96f768516a36e9a | | service_name | glance | | service_type | image | | url | http://controller:9292 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ image internal http://controller:9292 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 8edf9fd9452347d99d1a419b5f631f2c | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | de2e6d60f6234918a96f768516a36e9a | | service_name | glance | | service_type | image | | url | http://controller:9292 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ image admin http://controller:9292 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 89ced10fcf444d5a95c9ad5fd9381040 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | de2e6d60f6234918a96f768516a36e9a | | service_name | glance | | service_type | image | | url | http://controller:9292 | +--------------+----------------------------------+ åˆ é™¤APIç«¯ç‚¹ä½¿ç”¨å‘½ä»¤openstack endpoint delete ä½¿ç”¨å‘½ä»¤openstack endpoint listæŸ¥çœ‹endpoint-idç„¶åæ ¹æ®idåˆ é™¤ 4.4 å®‰è£…å’Œé…ç½®ç»„ä»¶ 4.4.1 å®‰è£…åŒ… yum -y install openstack-glance 4.4.2 ç¼–è¾‘/etc/glance/glance-api.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—® [database] ... connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance 2.åœ¨[keystone_authtoken]å’Œ[paste_deploy]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—® [keystone_authtoken] ... auth_uri = http://controller:5000 auth_url = http://controller:35357 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = glance password = GLANCE_PASS [paste_deploy] ... flavor = keystone 3.åœ¨[glance_store]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨å’Œæ˜ åƒæ–‡ä»¶çš„ä½ç½® [glance_store] ... stores = file,http default_store = file filesystem_store_datadir = /var/lib/glance/images/ #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/glance/glance-api.conf{,.bak} grep '^[a-Z\\[]' /etc/glance/glance-api.conf.bak >/etc/glance/glance-api.conf openstack-config --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance openstack-config --set /etc/glance/glance-api.conf glance_store stores file,http openstack-config --set /etc/glance/glance-api.conf glance_store default_store file openstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/ openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://controller:5000 openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://controller:35357 openstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_type password openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name default openstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name default openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service openstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance openstack-config --set /etc/glance/glance-api.conf keystone_authtoken password GLANCE_PASS openstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone MD5å€¼ md5sum /etc/glance/glance-api.conf 3e1a4234c133eda11b413788e001cba3 /etc/glance/glance-api.conf 4.4.3 ç¼–è¾‘/etc/glance/glance-registry.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—®ï¼š [database] ... connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance 2.åœ¨[keystone_authtoken]å’Œ[paste_deploy]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š ... auth_uri = http://controller:5000 auth_url = http://controller:35357 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = glance password = GLANCE_PASS [paste_deploy] ... flavor = keystone #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/glance/glance-registry.conf{,.bak} grep '^[a-Z\\[]' /etc/glance/glance-registry.conf.bak > /etc/glance/glance-registry.conf openstack-config --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://controller:5000 openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://controller:35357 openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name default openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name default openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_name service openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken username glance openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken password GLANCE_PASS openstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone MD5å€¼ md5sum /etc/glance/glance-registry.conf 46acabd81a65b924256f56fe34d90b8f /etc/glance/glance-registry.conf 4.4.4 åŒæ­¥æ•°æ®åº“ æ³¨æ„ï¼šå¿½ç•¥æ­¤è¾“å‡ºä¸­çš„ä»»ä½•å¼ƒç”¨æ¶ˆæ¯ su -s /bin/sh -c \"glance-manage db_sync\" glance Option \"verbose\" from group \"DEFAULT\" is deprecated for removal. Its value may be silently ignored in the future. /usr/lib/python2.7/site-packages/oslo_db/sqlalchemy/enginefacade.py:1056: OsloDBDeprecationWarning: EngineFacade is deprecated; please use oslo_db.sqlalchemy.enginefacade expire_on_commit=expire_on_commit, _conf=conf) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u'Duplicate index `ix_image_properties_image_id_name`. This is deprecated and will be disallowed in a future release.') result = self._query(query) #æœ‰è¾“å‡ºå³ä¸ºæ­£ç¡® mysql glance -e \"show tables;\" | wc -l 21 4.4.5 å¯åŠ¨glanceæœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ï¼ˆglance-apiå’Œglance-registryï¼‰ systemctl enable openstack-glance-api openstack-glance-registry && \\ systemctl start openstack-glance-api openstack-glance-registry 4.4.6 éªŒè¯æ“ä½œ 1.è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 2.ä¸‹è½½æºé•œåƒ wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img 3.ä½¿ç”¨QCOW2ç£ç›˜æ ¼å¼ï¼Œè£¸å®¹å™¨æ ¼å¼å’Œå…¬å…±å¯è§æ€§å°†æ˜ åƒä¸Šè½½åˆ°æ˜ åƒæœåŠ¡ ï¼Œä»¥ä¾¿æ‰€æœ‰é¡¹ç›®éƒ½å¯ä»¥è®¿é—®å®ƒ æ³¨æ„ï¼šè¿™ä¸€æ­¥ä¸€å®šè¦çœ‹æ‰§è¡Œåè¾“å‡ºç»“æœä¸­sizeå¤§å°ï¼Œå¦‚æœä¸º0åˆ™è¯´æ˜é•œåƒä¸Šè½½æœ‰é—®é¢˜ openstack image create \"cirros\" \\ --file cirros-0.3.4-x86_64-disk.img \\ --disk-format qcow2 --container-format bare \\ --public +------------------+------------------------------------------------------+ | Field | Value | +------------------+------------------------------------------------------+ | checksum | ee1eca47dc88f4879d8a229cc70a07c6 | | container_format | bare | | created_at | 2019-01-31T12:26:32Z | | disk_format | qcow2 | | file | /v2/images/ac21b17b-e910-4ca4-b743-914b8fbd0e55/file | | id | ac21b17b-e910-4ca4-b743-914b8fbd0e55 | | min_disk | 0 | | min_ram | 0 | | name | cirros | | owner | e33e3feaef784a5bb45bd9c766bc0f46 | | protected | False | | schema | /v2/schemas/image | | size | 13287936 | //ä¸€å®šè¦æ³¨æ„è¿™é‡Œçš„å¤§å°ï¼Œä¸º0æœ‰é”™è¯¯ | status | active | | tags | | | updated_at | 2019-01-31T12:26:34Z | | virtual_size | None | | visibility | public | +------------------+------------------------------------------------------+ é•œåƒä¸Šä¼ ä½ç½® [root@controller images]# pwd /var/lib/glance/images [root@controller images]# ls 6a143876-39c6-4b4a-8056-c3d7fbe0ce75 åˆ é™¤é•œåƒä½¿ç”¨å‘½ä»¤glance image-delete é•œåƒid 4.4.7 ç¡®è®¤ä¸Šä¼ å›¾åƒå¹¶éªŒè¯å±æ€§ openstack image list +--------------------------------------+--------+--------+ | ID | Name | Status | +--------------------------------------+--------+--------+ | ac21b17b-e910-4ca4-b743-914b8fbd0e55 | cirros | active | +--------------------------------------+--------+--------+ åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹é•œåƒæœåŠ¡glanceå®‰è£…å®Œæˆï¼ï¼ï¼ äº”ã€æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹è®¡ç®—æœåŠ¡novaå®‰è£… novaç›¸å…³æœåŠ¡ æœåŠ¡åç§° ä½œç”¨ nova-api æ¥å—å¹¶å“åº”æ‰€æœ‰çš„è®¡ç®—æœåŠ¡è¯·æ±‚ï¼Œç®¡ç†è™šæ‹Ÿæœº(äº‘ä¸»æœº)ç”Ÿå‘½å‘¨æœŸ nova-api-metadata æ¥å—æ¥è‡ªè™šæ‹Ÿæœºå‘é€çš„å…ƒæ•°æ®è¯·æ±‚ nova-computeï¼ˆå¤šä¸ªï¼‰ çœŸæ­£ç®¡ç†è™šæ‹Ÿæœº nova-scheduler novaè°ƒåº¦å™¨ï¼ˆæŒ‘é€‰å‡ºæœ€åˆé€‚çš„nova-computeæ¥åˆ›å»ºè™šæœºï¼‰ nova-conductor å¸®åŠ©nova-computeä»£ç†ä¿®æ”¹æ•°æ®åº“ä¸­è™šæ‹Ÿæœºçš„çŠ¶æ€ nova-network æ—©æœŸopenstackç‰ˆæœ¬ç®¡ç†è™šæ‹Ÿæœºçš„ç½‘ç»œï¼ˆå·²å¼ƒç”¨ï¼Œneutronï¼‰ nova-consoleauthå’Œnova-novncproxy webç‰ˆçš„vncæ¥ç›´æ¥æ“ä½œäº‘ä¸»æœº novncproxy webç‰ˆ vncå®¢æˆ·ç«¯ å®‰è£…å’Œé…ç½®æ§åˆ¶èŠ‚ç‚¹ 5.1 åˆ›å»ºnovaå’Œnova-apiæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤ mysql -e \"CREATE DATABASE nova;\" mysql -e \"CREATE DATABASE nova_api;\" mysql -e \"GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \\ IDENTIFIED BY 'NOVA_DBPASS';\" 5.2 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 5.3 åˆ›å»ºæœåŠ¡å‡­æ® 1.åˆ›å»ºnovaç”¨æˆ·,å¯†ç è®¾ç½®ä¸ºNOVA_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default \\ --password NOVA_PASS nova +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | af51b1180eb14a66b0380e4cd134df90 | | enabled | True | | id | 1ad918dc1de84c279999e89bb7c312bc | | name | nova | +-----------+----------------------------------+ #äº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default \\ --password-prompt nova User Password: Repeat User Password: +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | b245194b1e8749d0b3c51a78e05d7734 | | enabled | True | | id | b7cd769660c64b96bed91baebb229d54 | | name | nova | +-----------+----------------------------------+ 2.å°†adminè§’è‰²æ·»åŠ åˆ°novaç”¨æˆ· openstack role add --project service --user nova admin 3.åˆ›å»ºnovaæœåŠ¡å®ä½“ openstack service create --name nova \\ --description \"OpenStack Compute\" compute +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Compute | | enabled | True | | id | 3db049ab4b334d6d979a9ee9a6aea5d5 | | name | nova | | type | compute | +-------------+----------------------------------+ 5.4 åˆ›å»ºComputeæœåŠ¡APIç«¯ç‚¹ openstack endpoint create --region RegionOne \\ compute public http://controller:8774/v2.1/%\\(tenant_id\\)s +--------------+-------------------------------------------+ | Field | Value | +--------------+-------------------------------------------+ | enabled | True | | id | 0e1da405775b4a238f4142d8df6b8b58 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 3db049ab4b334d6d979a9ee9a6aea5d5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1/%(tenant_id)s | +--------------+-------------------------------------------+ openstack endpoint create --region RegionOne \\ compute internal http://controller:8774/v2.1/%\\(tenant_id\\)s +--------------+-------------------------------------------+ | Field | Value | +--------------+-------------------------------------------+ | enabled | True | | id | 36775f0fcbf24ce1888ff714442aea04 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 3db049ab4b334d6d979a9ee9a6aea5d5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1/%(tenant_id)s | +--------------+-------------------------------------------+ openstack endpoint create --region RegionOne \\ compute admin http://controller:8774/v2.1/%\\(tenant_id\\)s +--------------+-------------------------------------------+ | Field | Value | +--------------+-------------------------------------------+ | enabled | True | | id | 8d575d9584df4c0cb3d903c50688175f | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 3db049ab4b334d6d979a9ee9a6aea5d5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1/%(tenant_id)s | +--------------+-------------------------------------------+ 5.5 å®‰è£…å’Œé…ç½®ç»„ä»¶ 5.5.1 å®‰è£…åŒ… yum -y install openstack-nova-api openstack-nova-conductor \\ openstack-nova-console openstack-nova-novncproxy openstack-nova-scheduler 5.5.2 ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œä»…å¯ç”¨è®¡ç®—å’Œå…ƒæ•°æ®API [DEFAULT] ... enabled_apis = osapi_compute,metadata 2.åœ¨[api_database]å’Œ[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—® [api_database] ... connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api [database] ... connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova 3.åœ¨[DEFAULT]å’Œ[oslo_messaging_rabbit]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è®¿é—® [DEFAULT] ... rpc_backend = rabbit [oslo_messaging_rabbit] ... rabbit_host = controller rabbit_userid = openstack rabbit_password = RABBIT_PASS 4.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—® [DEFAULT] ... auth_strategy = keystone [keystone_authtoken] ... auth_uri = http://controller:5000 auth_url = http://controller:35357 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = NOVA_PASS 5.åœ¨[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®my_ipé€‰é¡¹ä»¥ä½¿ç”¨æ§åˆ¶å™¨èŠ‚ç‚¹çš„ç®¡ç†æ¥å£IPåœ°å€ [DEFAULT] ... my_ip = 10.0.0.11 6.åœ¨[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å¯¹NetworkingæœåŠ¡çš„æ”¯æŒ [DEFAULT] ... use_neutron = True firewall_driver = nova.virt.firewall.NoopFirewallDriver 7.åœ¨[vnc]éƒ¨åˆ†ä¸­ï¼Œé…ç½®VNCä»£ç†ä»¥ä½¿ç”¨æ§åˆ¶å™¨èŠ‚ç‚¹çš„ç®¡ç†æ¥å£IPåœ°å€ [vnc] ... vncserver_listen = $my_ip vncserver_proxyclient_address = $my_ip 8.åœ¨[glance]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ImageæœåŠ¡APIçš„ä½ç½® [glance] ... api_servers = http://controller:9292 9.åœ¨[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ [oslo_concurrency] ... lock_path = /var/lib/nova/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ï¼Œåˆ†å¼€å¤åˆ¶ï¼Œä¸€æ¬¡æ€§å¤åˆ¶æ— æ³•éƒ½æ‰§è¡Œ cp /etc/nova/nova.conf{,.bak} grep '^[a-Z\\[]' /etc/nova/nova.conf.bak >/etc/nova/nova.conf openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.11 openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver openstack-config --set /etc/nova/nova.conf api_database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api openstack-config --set /etc/nova/nova.conf database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357 openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS openstack-config --set /etc/nova/nova.conf vnc vncserver_listen '$my_ip' openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address '$my_ip' MD5å€¼ md5sum /etc/nova/nova.conf 47ded61fdd1a79ab91bdb37ce59ef192 /etc/nova/nova.conf 5.5.3 åŒæ­¥æ•°æ®åº“ï¼Œå¿½ç•¥è¾“å‡º su -s /bin/sh -c \"nova-manage api_db sync\" nova su -s /bin/sh -c \"nova-manage db sync\" nova /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u'Duplicate index `block_device_mapping_instance_uuid_virtual_name_device_name_idx`. This is deprecated and will be disallowed in a future release.') result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u'Duplicate index `uniq_instances0uuid`. This is deprecated and will be disallowed in a future release.') result = self._query(query) #æŸ¥çœ‹æ•°æ®åº“ï¼Œæœ‰è¾“å‡ºå³ä¸ºæ­£ç¡® mysql nova_api -e \"show tables;\"|wc -l 10 mysql nova -e \"show tables;\"|wc -l 110 5.5.4 å¯åŠ¨ComputeæœåŠ¡å¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ systemctl enable openstack-nova-api.service \\ openstack-nova-consoleauth.service openstack-nova-scheduler.service \\ openstack-nova-conductor.service openstack-nova-novncproxy.service systemctl start openstack-nova-api.service \\ openstack-nova-consoleauth.service openstack-nova-scheduler.service \\ openstack-nova-conductor.service openstack-nova-novncproxy.service å®‰è£…å®Œæˆåä¼šæœ‰no VNC 10.0.0.11:6080 å®‰è£…å’Œé…ç½®è®¡ç®—èŠ‚ç‚¹ 5.6 å®‰è£…å’Œé…ç½®ç»„ä»¶ 5.6.1 å®‰è£…åŒ… yum -y install openstack-nova-compute openstack-utils 5.6.2 ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[DEFAULT]å’Œ[oslo_messaging_rabbit]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è®¿é—® [DEFAULT] ... rpc_backend = rabbit [oslo_messaging_rabbit] ... rabbit_host = controller rabbit_userid = openstack rabbit_password = RABBIT_PASS 2.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—® [DEFAULT] ... auth_strategy = keystone [keystone_authtoken] ... auth_uri = http://controller:5000 auth_url = http://controller:35357 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = NOVA_PASS 3.åœ¨[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®my_ipé€‰é¡¹ï¼Œå°†MANAGEMENT_INTERFACE_IP_ADDRESSæ›¿æ¢ä¸ºè®¡ç®—èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œæ¥å£çš„IPåœ°å€ï¼Œå¯¹äºç¤ºä¾‹ä½“ç³»ç»“æ„ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šå¸¸ä¸º10.0.0.31 [DEFAULT] ... my_ip = MANAGEMENT_INTERFACE_IP_ADDRESS 4.åœ¨[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å¯¹NetworkingæœåŠ¡çš„æ”¯æŒ [DEFAULT] ... use_neutron = True firewall_driver = nova.virt.firewall.NoopFirewallDriver 5.åœ¨[vnc]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å¹¶é…ç½®è¿œç¨‹æ§åˆ¶å°è®¿é—® [vnc] ... enabled = True vncserver_listen = 0.0.0.0 vncserver_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html 6.åœ¨[glance]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ImageæœåŠ¡APIçš„ä½ç½® [glance] ... api_servers = http://controller:9292 7.åœ¨[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ [oslo_concurrency] ... lock_path = /var/lib/nova/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ cp /etc/nova/nova.conf{,.bak} grep '^[a-Z\\[]' /etc/nova/nova.conf.bak >/etc/nova/nova.conf openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.31 openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357 openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack openstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS openstack-config --set /etc/nova/nova.conf vnc enabled True openstack-config --set /etc/nova/nova.conf vnc vncserver_listen 0.0.0.0 openstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address '$my_ip' openstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://controller:6080/vnc_auto.html MD5å€¼ md5sum /etc/nova/nova.conf 2f53f4e0848bc5927493925a4ea61f63 /etc/nova/nova.conf 5.6.3 ç¡®å®šæ‚¨çš„è®¡ç®—èŠ‚ç‚¹æ˜¯å¦æ”¯æŒè™šæ‹Ÿæœºçš„ç¡¬ä»¶åŠ é€Ÿ egrep -c '(vmx|svm)' /proc/cpuinfo 1 #è¯´æ˜ å¦‚æœæ­¤å‘½ä»¤è¿”å›å€¼1æˆ–æ›´å¤§ï¼Œåˆ™è®¡ç®—èŠ‚ç‚¹æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œé€šå¸¸ä¸éœ€è¦å…¶ä»–é…ç½®ã€‚ å¦‚æœæ­¤å‘½ä»¤è¿”å›é›¶å€¼ï¼Œåˆ™è®¡ç®—èŠ‚ç‚¹ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œæ‚¨å¿…é¡»å°†libvirté…ç½®ä¸ºä½¿ç”¨QEMUè€Œä¸æ˜¯KVMã€‚ ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶ä¸­çš„[libvirt]éƒ¨åˆ†ï¼Œ å¦‚ä¸‹æ‰€ç¤ºï¼š [libvirt] ...... virt_type = qemu 5.6.4 å¯åŠ¨ComputeæœåŠ¡åŠå…¶ä¾èµ–é¡¹ï¼Œå¹¶å°†å®ƒä»¬é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶è‡ªåŠ¨å¯åŠ¨ systemctl enable libvirtd.service openstack-nova-compute.service && \\ systemctl start libvirtd.service openstack-nova-compute.service éªŒè¯æ“ä½œï¼Œåœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ 5.7 éªŒè¯ComputeæœåŠ¡çš„è¿è¡Œ 5.7.1 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 5.7.2 åˆ—å‡ºæœåŠ¡ç»„ä»¶ä»¥éªŒè¯æ¯ä¸ªè¿›ç¨‹çš„æˆåŠŸå¯åŠ¨å’Œæ³¨å†Œ æ­¤è¾“å‡ºåº”æŒ‡ç¤ºæ§åˆ¶å™¨èŠ‚ç‚¹ä¸Šå¯ç”¨çš„ä¸‰ä¸ªæœåŠ¡ç»„ä»¶ä»¥åŠè®¡ç®—èŠ‚ç‚¹ä¸Šå¯ç”¨çš„ä¸€ä¸ªæœåŠ¡ç»„ä»¶ openstack compute service list +----+------------------+------------+----------+---------+-------+----------------------------+ | Id | Binary | Host | Zone | Status | State | Updated At | +----+------------------+------------+----------+---------+-------+----------------------------+ | 1 | nova-conductor | controller | internal | enabled | up | 2019-02-01T14:33:13.000000 | | 2 | nova-consoleauth | controller | internal | enabled | up | 2019-02-01T14:33:18.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-02-01T14:33:13.000000 | | 6 | nova-compute | compute1 | nova | enabled | up | 2019-02-01T14:33:19.000000 | +----+------------------+------------+----------+---------+-------+----------------------------+ åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹è®¡ç®—æœåŠ¡novaå®‰è£…å®Œæˆï¼ï¼ï¼ å…­ã€æ§åˆ¶èŠ‚ç‚¹ã€è®¡ç®—èŠ‚ç‚¹ç½‘ç»œæœåŠ¡neutronå®‰è£… neutronç›¸å…³æœåŠ¡ æœåŠ¡å è¯´æ˜ neutron-server ç«¯å£(9696) api æ¥å—å’Œå“åº”å¤–éƒ¨çš„ç½‘ç»œç®¡ç†è¯·æ±‚ neutron-linuxbridge-agent è´Ÿè´£åˆ›å»ºæ¡¥æ¥ç½‘å¡ neutron-dhcp-agent è´Ÿè´£åˆ†é…IP neutron-metadata-agent é…åˆnova-metadata-apiå®ç°è™šæ‹Ÿæœºçš„å®šåˆ¶åŒ–æ“ä½œ L3-agent å®ç°ä¸‰å±‚ç½‘ç»œ(ç½‘ç»œå±‚) å®‰è£…å’Œé…ç½®æ§åˆ¶èŠ‚ç‚¹ 6.1 åˆ›å»ºneutronæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤ mysql -e \"CREATE DATABASE neutron;\" mysql -e \"GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' \\ IDENTIFIED BY 'NEUTRON_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' \\ IDENTIFIED BY 'NEUTRON_DBPASS';\" 6.2 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 6.3 åˆ›å»ºæœåŠ¡å‡­è¯ 6.3.1 åˆ›å»ºneutronç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸ºNEUTRON_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default --password NEUTRON_PASS neutron +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | af51b1180eb14a66b0380e4cd134df90 | | enabled | True | | id | c0ac0eda2eca4a698eade50b060dd2ce | | name | neutron | +-----------+----------------------------------+ #äº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default --password-prompt neutron User Password: Repeat User Password: +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | b245194b1e8749d0b3c51a78e05d7734 | | enabled | True | | id | 98f34dc4ddf346b3833de4a0320f7bc9 | | name | neutron | +-----------+----------------------------------+ 6.3.2 å°†adminè§’è‰²æ·»åŠ åˆ°neutronç”¨æˆ· openstack role add --project service --user neutron admin 6.3.3 åˆ›å»ºneutronæœåŠ¡å®ä½“ openstack service create --name neutron \\ --description \"OpenStack Networking\" network +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Networking | | enabled | True | | id | 86251b67e0c94b699489ee1b331c33a6 | | name | neutron | | type | network | +-------------+----------------------------------+ 6.4 åˆ›å»ºç½‘ç»œæœåŠ¡APIç«¯ç‚¹ openstack endpoint create --region RegionOne \\ network public http://controller:9696 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 48b0ab77e4e74a0788f88b0916e8b696 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 86251b67e0c94b699489ee1b331c33a6 | | service_name | neutron | | service_type | network | | url | http://controller:9696 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ network internal http://controller:9696 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 5b2be24de46f455694a77e8a096916fb | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 86251b67e0c94b699489ee1b331c33a6 | | service_name | neutron | | service_type | network | | url | http://controller:9696 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ network admin http://controller:9696 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 0f06a3d409bc41cb9b6651de68006102 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 86251b67e0c94b699489ee1b331c33a6 | | service_name | neutron | | service_type | network | | url | http://controller:9696 | +--------------+----------------------------------+ 6.5 é…ç½®ç½‘ç»œé€‰é¡¹ï¼Œæ§åˆ¶èŠ‚ç‚¹æ“ä½œ 6.5.1 å®‰è£…åŒ… yum -y install openstack-neutron openstack-neutron-ml2 \\ openstack-neutron-linuxbridge ebtables 6.5.2 é…ç½®æœåŠ¡å™¨ç»„ä»¶ ç¼–è¾‘/etc/neutron/neutron.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—®ï¼š [database] ... connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron 2.åœ¨[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨Modular Layer 2ï¼ˆML2ï¼‰æ’ä»¶å¹¶ç¦ç”¨å…¶ä»–æ’ä»¶ï¼š [DEFAULT] ... core_plugin = ml2 service_plugins = 3.åœ¨[DEFAULT]å’Œ[oslo_messaging_rabbit]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®ï¼š [DEFAULT] ... rpc_backend = rabbit [oslo_messaging_rabbit] ... rabbit_host = controller rabbit_userid = openstack rabbit_password = RABBIT_PASS 4.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š [DEFAULT] ... auth_strategy = keystone [keystone_authtoken] ... auth_uri = http://controller:5000 auth_url = http://controller:35357 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = neutron password = NEUTRON_PASS 5.åœ¨[DEFAULT]å’Œ[nova]éƒ¨åˆ†ä¸­ï¼Œé…ç½®Networkingä»¥é€šçŸ¥Computeç½‘ç»œæ‹“æ‰‘æ›´æ”¹ï¼š [DEFAULT] ... notify_nova_on_port_status_changes = True notify_nova_on_port_data_changes = True [nova] ... auth_url = http://controller:35357 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = nova password = NOVA_PASS 6.åœ¨[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ï¼š [oslo_concurrency] ... lock_path = /var/lib/neutron/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/neutron.conf{,.bak} grep '^[a-Z\\[]' /etc/neutron/neutron.conf.bak >/etc/neutron/neutron.conf openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2 openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True openstack-config --set /etc/neutron/neutron.conf database connection mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS openstack-config --set /etc/neutron/neutron.conf nova auth_url http://controller:35357 openstack-config --set /etc/neutron/neutron.conf nova auth_type password openstack-config --set /etc/neutron/neutron.conf nova project_domain_name default openstack-config --set /etc/neutron/neutron.conf nova user_domain_name default openstack-config --set /etc/neutron/neutron.conf nova region_name RegionOne openstack-config --set /etc/neutron/neutron.conf nova project_name service openstack-config --set /etc/neutron/neutron.conf nova username nova openstack-config --set /etc/neutron/neutron.conf nova password NOVA_PASS openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS MD5å€¼ md5sum /etc/neutron/neutron.conf e399b7958cd22f47becc6d8fd6d3521a /etc/neutron/neutron.conf 6.6 é…ç½®æ¨¡å—åŒ–ç¬¬2å±‚ï¼ˆML2ï¼‰æ’ä»¶ ML2æ’ä»¶ä½¿ç”¨Linuxæ¡¥æ¥æœºåˆ¶ä¸ºå®ä¾‹æ„å»ºç¬¬2å±‚ï¼ˆæ¡¥æ¥å’Œäº¤æ¢ï¼‰è™šæ‹Ÿç½‘ç»œåŸºç¡€æ¶æ„ ç¼–è¾‘/etc/neutron/plugins/ml2/ml2_conf.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[ml2]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨flatå’ŒVLANç½‘ç»œï¼š [ml2] ... type_drivers = flat,vlan 2.åœ¨[ml2]éƒ¨åˆ†ä¸­ï¼Œç¦ç”¨è‡ªåŠ©æœåŠ¡ç½‘ç»œ [ml2] ... tenant_network_types = 3.åœ¨[ml2]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨Linuxæ¡¥æ¥æœºåˆ¶ [ml2] ... mechanism_drivers = linuxbridge 4.åœ¨[ml2]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨ç«¯å£å®‰å…¨æ€§æ‰©å±•é©±åŠ¨ç¨‹åº [ml2] ... extension_drivers = port_security 5.åœ¨[ml2_type_flat]éƒ¨åˆ†ä¸­ï¼Œå°†æä¾›å•†è™šæ‹Ÿç½‘ç»œé…ç½®ä¸ºæ‰å¹³ç½‘ç»œï¼š [ml2_type_flat] ... flat_networks = provider 6.åœ¨[securitygroup]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨ipsetä»¥æé«˜å®‰å…¨ç»„è§„åˆ™çš„æ•ˆç‡ [securitygroup] ... enable_ipset = True #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/plugins/ml2/ml2_conf.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/plugins/ml2/ml2_conf.ini.bak >/etc/neutron/plugins/ml2/ml2_conf.ini openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers linuxbridge openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks provider openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset True MD5å€¼ md5sum /etc/neutron/plugins/ml2/ml2_conf.ini 2640b5de519fafcd675b30e1bcd3c7d5 /etc/neutron/plugins/ml2/ml2_conf.ini 6.7 é…ç½®linuxæ¡¥æ¥ä»£ç† Linuxç½‘æ¡¥ä»£ç†ä¸ºå®ä¾‹æ„å»ºç¬¬2å±‚ï¼ˆæ¡¥æ¥å’Œäº¤æ¢ï¼‰è™šæ‹Ÿç½‘ç»œåŸºç¡€æ¶æ„å¹¶å¤„ç†å®‰å…¨ç»„ ç¼–è¾‘/etc/neutron/plugins/ml2/linuxbridge_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[linux_bridge]éƒ¨åˆ†ä¸­ï¼Œå°†æä¾›è€…è™šæ‹Ÿç½‘ç»œæ˜ å°„åˆ°æä¾›è€…ç‰©ç†ç½‘ç»œæ¥å£ï¼Œå°†PROVIDER_INTERFACE_NAMEæ›¿æ¢ ä¸ºåŸºç¡€æä¾›ç¨‹åºç‰©ç†ç½‘ç»œæ¥å£çš„åç§°ï¼Œè¿™é‡Œä¸ºeth0 [linux_bridge] physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME 2.åœ¨[vxlan]éƒ¨åˆ†ä¸­ï¼Œç¦ç”¨VXLANé‡å ç½‘ç»œ [vxlan] enable_vxlan = False 3.åœ¨[securitygroup]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å®‰å…¨ç»„å¹¶é…ç½®Linuxç½‘æ¡¥iptablesé˜²ç«å¢™é©±åŠ¨ç¨‹åº [securitygroup] ... enable_security_group = True firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak >/etc/neutron/plugins/ml2/linuxbridge_agent.ini openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth0 openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False MD5å€¼ md5sum /etc/neutron/plugins/ml2/linuxbridge_agent.ini 3f474907a7f438b34563e4d3f3c29538 /etc/neutron/plugins/ml2/linuxbridge_agent.ini 6.8 é…ç½®DHCPä»£ç† è¯¥DHCPä»£ç†ä¸ºè™šæ‹Ÿç½‘ç»œæä¾›DHCPæœåŠ¡ ç¼–è¾‘/etc/neutron/dhcp_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®Linuxæ¡¥æ¥æ¥å£é©±åŠ¨ç¨‹åºï¼ŒDnsmasq DHCPé©±åŠ¨ç¨‹åºï¼Œå¹¶å¯ç”¨éš”ç¦»çš„å…ƒæ•°æ®ï¼Œä»¥ä¾¿æä¾›å•†ç½‘ç»œä¸Šçš„å®ä¾‹å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®å…ƒæ•°æ® [DEFAULT] ... interface_driver = neutron.agent.linux.interface.BridgeInterfaceDriver dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq enable_isolated_metadata = True #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/dhcp_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/dhcp_agent.ini.bak >/etc/neutron/dhcp_agent.ini openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.BridgeInterfaceDriver openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dhcp_driver neutron.agent.linux.dhcp.Dnsmasq openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT enable_isolated_metadata True MD5å€¼ md5sum /etc/neutron/dhcp_agent.ini d39579607b2f7d92e88f8910f9213520 /etc/neutron/dhcp_agent.ini 6.9 é…ç½®å…ƒæ•°æ®ä»£ç† æ‰€è¿°å…ƒæ•°æ®ä»£ç†æä¾›é…ç½®ä¿¡æ¯çš„è¯¸å¦‚å‡­æ®å®ä¾‹ã€‚ ç¼–è¾‘/etc/neutron/metadata_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ åœ¨[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®å…ƒæ•°æ®ä¸»æœºå’Œå…±äº«å¯†é’¥ [DEFAULT] ... nova_metadata_ip = controller metadata_proxy_shared_secret = METADATA_SECRET #ç”¨ä»¥ä¸‹é¢†å‘½ä¿®æ”¹ \\cp /etc/neutron/metadata_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/metadata_agent.ini.bak >/etc/neutron/metadata_agent.ini openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip controller openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET MD5å€¼ md5sum /etc/neutron/metadata_agent.ini e1166b0dfcbcf4507d50860d124335d6 /etc/neutron/metadata_agent.ini 6.10 é…ç½®è®¡ç®—ä»¥ä½¿ç”¨ç½‘ç»œ ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨[neutron]éƒ¨åˆ†ä¸­ï¼Œé…ç½®è®¿é—®å‚æ•°ï¼Œå¯ç”¨å…ƒæ•°æ®ä»£ç†å¹¶é…ç½®å¯†ç  [neutron] ... url = http://controller:9696 auth_url = http://controller:35357 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = neutron password = NEUTRON_PASS service_metadata_proxy = True metadata_proxy_shared_secret = METADATA_SECRET #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ openstack-config --set /etc/nova/nova.conf neutron url http://controller:9696 openstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357 openstack-config --set /etc/nova/nova.conf neutron auth_type password openstack-config --set /etc/nova/nova.conf neutron project_domain_name default openstack-config --set /etc/nova/nova.conf neutron user_domain_name default openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne openstack-config --set /etc/nova/nova.conf neutron project_name service openstack-config --set /etc/nova/nova.conf neutron username neutron openstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS openstack-config --set /etc/nova/nova.conf neutron service_metadata_proxy True openstack-config --set /etc/nova/nova.conf neutron metadata_proxy_shared_secret METADATA_SECRET MD5å€¼ md5sum /etc/nova/nova.conf 6334f359655efdbcf083b812ab94efc1 /etc/nova/nova.conf 6.11 å®Œæˆå®‰è£… 6.11.1 è”ç½‘æœåŠ¡åˆå§‹åŒ–è„šæœ¬æœŸå¾…ä¸€ä¸ªç¬¦å·é“¾æ¥ /etc/neutron/plugin.iniæŒ‡å‘ML2æ’ä»¶é…ç½®æ–‡ä»¶ï¼Œ/etc/neutron/plugins/ml2/ml2_conf.iniã€‚å¦‚æœæ­¤ç¬¦å·é“¾æ¥ä¸å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºå®ƒ ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini 6.11.2 åŒæ­¥æ•°æ®åº“ï¼Œæœ€åæç¤ºOKå³ä¸ºæ­£ç¡® su -s /bin/sh -c \"neutron-db-manage --config-file /etc/neutron/neutron.conf \\ --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head\" neutron 6.11.3 é‡æ–°å¯åŠ¨Compute APIæœåŠ¡ systemctl restart openstack-nova-api.service 6.11.4 å¯åŠ¨ç½‘ç»œæœåŠ¡å¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ å¯¹äºå®˜ç½‘ä¸­çš„ä¸¤ç§ç½‘ç»œï¼Œè¿™é‡Œé€‰æ‹©çš„æ˜¯ç¬¬ä¸€ç§ç½‘ç»œ #å¯åŠ¨ç½‘ç»œæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable neutron-server.service \\ neutron-linuxbridge-agent.service neutron-dhcp-agent.service \\ neutron-metadata-agent.service systemctl start neutron-server.service \\ neutron-linuxbridge-agent.service neutron-dhcp-agent.service \\ neutron-metadata-agent.service #å¯åŠ¨æœåŠ¡åæç¤ºå¦‚ä¸‹å³ä¸ºæ­£ç¡®ï¼Œaliveå¤„éƒ½ä¸ºç¬‘è„¸ //æ³¨æ„ï¼Œæ­¤å¤„å¯åŠ¨æ¯”è¾ƒæ…¢ï¼Œéœ€è¦ç­‰å¾…å‡ åˆ†é’Ÿ neutron agent-list +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ | id | agent_type | host | availability_zone | alive | admin_state_up | binary | +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ | 2a79bce3-2492-4d5b-b565-6f18aa7c8bcd | DHCP agent | controller | nova | :-) | True | neutron-dhcp-agent | | 2b3799ae-3162-47f7-82fa-6291d76e0e14 | Metadata agent | controller | | :-) | True | neutron-metadata-agent | | 82ff3326-f570-4f50-bb5c-eec057034fd1 | Linux bridge agent | controller | | :-) | True | neutron-linuxbridge-agent | +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ å®‰è£…å’Œé…ç½®è®¡ç®—èŠ‚ç‚¹ 6.12 å®‰è£…åŒ… yum -y install openstack-neutron-linuxbridge ebtables ipset openstack-utils 6.13 é…ç½®å…¬å…±ç»„ä»¶ ç¼–è¾‘/etc/neutron/neutron.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨[database]éƒ¨åˆ†ä¸­ï¼Œæ³¨é‡Šæ‰ä»»ä½•è¿æ¥é€‰é¡¹ï¼Œå› ä¸ºè®¡ç®—èŠ‚ç‚¹ä¸ç›´æ¥è®¿é—®æ•°æ®åº“ã€‚ åœ¨[DEFAULT]å’Œ[oslo_messaging_rabbit]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è®¿é—® [DEFAULT] ... rpc_backend = rabbit [oslo_messaging_rabbit] ... rabbit_host = controller rabbit_userid = openstack rabbit_password = RABBIT_PASS 2.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—® [DEFAULT] ... auth_strategy = keystone [keystone_authtoken] ... auth_uri = http://controller:5000 auth_url = http://controller:35357 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = neutron password = NEUTRON_PASS 3.åœ¨[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ [oslo_concurrency] ... lock_path = /var/lib/neutron/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/neutron.conf{,.bak} grep '^[a-Z\\[]' /etc/neutron/neutron.conf.bak >/etc/neutron/neutron.conf openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS MD5å€¼ md5sum /etc/neutron/neutron.conf 77ffab503797be5063c06e8b956d6ed0 /etc/neutron/neutron.conf 6.14 é…ç½®ç½‘ç»œé€‰é¡¹ 6.14.1 é…ç½®æ¡¥æ¥ä»£ç† Linuxç½‘æ¡¥ä»£ç†ä¸ºå®ä¾‹æ„å»ºç¬¬2å±‚ï¼ˆæ¡¥æ¥å’Œäº¤æ¢ï¼‰è™šæ‹Ÿç½‘ç»œåŸºç¡€æ¶æ„å¹¶å¤„ç†å®‰å…¨ç»„ã€‚ ç¼–è¾‘/etc/neutron/plugins/ml2/linuxbridge_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œï¼š 1.åœ¨[linux_bridge]éƒ¨åˆ†ä¸­ï¼Œå°†æä¾›è€…è™šæ‹Ÿç½‘ç»œæ˜ å°„åˆ°æä¾›è€…ç‰©ç†ç½‘ç»œæ¥å£ï¼Œè¿™é‡Œä¸ºeth0 [linux_bridge] physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME 2.åœ¨[vxlan]éƒ¨åˆ†ä¸­ï¼Œç¦ç”¨VXLANé‡å ç½‘ç»œ [vxlan] enable_vxlan = False 3.åœ¨[securitygroup]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å®‰å…¨ç»„å¹¶é…ç½®Linuxç½‘æ¡¥iptablesé˜²ç«å¢™é©±åŠ¨ç¨‹åº [securitygroup] ... enable_security_group = True firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak >/etc/neutron/plugins/ml2/linuxbridge_agent.ini openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth0 openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver MD5å€¼ md5sum /etc/neutron/plugins/ml2/linuxbridge_agent.ini 3f474907a7f438b34563e4d3f3c29538 /etc/neutron/plugins/ml2/linuxbridge_agent.ini 6.14.2 é…ç½®è®¡ç®—ä»¥ä½¿ç”¨ç½‘ç»œ ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ åœ¨[neutron]éƒ¨åˆ†ä¸­ï¼Œé…ç½®è®¿é—®å‚æ•° [neutron] ... url = http://controller:9696 auth_url = http://controller:35357 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = neutron password = NEUTRON_PASS #ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ openstack-config --set /etc/nova/nova.conf neutron url http://controller:9696 && \\ openstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357 && \\ openstack-config --set /etc/nova/nova.conf neutron auth_type password && \\ openstack-config --set /etc/nova/nova.conf neutron project_domain_name default && \\ openstack-config --set /etc/nova/nova.conf neutron user_domain_name default && \\ openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne && \\ openstack-config --set /etc/nova/nova.conf neutron project_name service && \\ openstack-config --set /etc/nova/nova.conf neutron username neutron && \\ openstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS MD5å€¼ md5sum /etc/nova/nova.conf 8e6590c8dc3d59beb3da37fdeeadfd1d /etc/nova/nova.conf 6.15 å®Œæˆå®‰è£… 6.15.1 é‡æ–°å¯åŠ¨ComputeæœåŠ¡ systemctl restart openstack-nova-compute.service 6.15.2 å¯åŠ¨Linuxç½‘æ¡¥ä»£ç†å¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ systemctl enable neutron-linuxbridge-agent.service && \\ systemctl start neutron-linuxbridge-agent.service 6.16 éªŒè¯æ“ä½œï¼Œåœ¨æ§åˆ¶èŠ‚ç‚¹æ“ä½œ 6.16.1 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 6.16.2 åˆ—å‡ºå·²åŠ è½½çš„æ‰©å±•ä»¥éªŒè¯neutron-serverè¿›ç¨‹çš„æˆåŠŸå¯åŠ¨ neutron ext-list +---------------------------+-----------------------------------------------+ | alias | name | +---------------------------+-----------------------------------------------+ | default-subnetpools | Default Subnetpools | | availability_zone | Availability Zone | | network_availability_zone | Network Availability Zone | | auto-allocated-topology | Auto Allocated Topology Services | | binding | Port Binding | | agent | agent | | subnet_allocation | Subnet Allocation | | dhcp_agent_scheduler | DHCP Agent Scheduler | | tag | Tag support | | external-net | Neutron external network | | net-mtu | Network MTU | | network-ip-availability | Network IP Availability | | quotas | Quota management support | | provider | Provider Network | | multi-provider | Multi Provider Network | | address-scope | Address scope | | timestamp_core | Time Stamp Fields addition for core resources | | extra_dhcp_opt | Neutron Extra DHCP opts | | security-group | security-group | | rbac-policies | RBAC Policies | | standard-attr-description | standard-attr-description | | port-security | Port Security | | allowed-address-pairs | Allowed Address Pairs | +---------------------------+-----------------------------------------------+ 6.16.3 åˆ—å‡ºä»£ç†ä»¥éªŒè¯æˆåŠŸå¯åŠ¨neutronä»£ç†ï¼Œaliveå¤„éƒ½ä¸ºç¬‘è„¸å³ä¸ºæ­£ç¡® neutron agent-list +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ | id | agent_type | host | availability_zone | alive | admin_state_up | binary | +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ | 2a79bce3-2492-4d5b-b565-6f18aa7c8bcd | DHCP agent | controller | nova | :-) | True | neutron-dhcp-agent | | 2b3799ae-3162-47f7-82fa-6291d76e0e14 | Metadata agent | controller | | :-) | True | neutron-metadata-agent | | 82ff3326-f570-4f50-bb5c-eec057034fd1 | Linux bridge agent | controller | | :-) | True | neutron-linuxbridge-agent | | ee271e44-25c3-4024-b414-40d8fa838d68 | Linux bridge agent | compute1 | | :-) | True | neutron-linuxbridge-agent | +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹ã€è®¡ç®—èŠ‚ç‚¹ç½‘ç»œæœåŠ¡neutronå®‰è£…å®Œæˆï¼ï¼ï¼ ä¸ƒã€è®¡ç®—èŠ‚ç‚¹horizon webç•Œé¢Dashboardå®‰è£… 7.1 å®‰è£…åŒ… yum -y install openstack-dashboard 7.2 ç¼–è¾‘/etc/openstack-dashboard/local_settingsæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.é…ç½®ä»ªè¡¨æ¿ä»¥åœ¨æ§åˆ¶å™¨èŠ‚ç‚¹ä¸Šä½¿ç”¨OpenStackæœåŠ¡ 158è¡Œï¼ŒOPENSTACK_HOST = \"127.0.0.1\" ä¿®æ”¹ä¸º OPENSTACK_HOST = \"controller\" 2.å…è®¸æ‰€æœ‰ä¸»æœºè®¿é—®ä»ªè¡¨æ¿ 30è¡Œï¼ŒALLOWED_HOSTS = ['horizon.example.com', 'localhost'] ä¿®æ”¹ä¸º ALLOWED_HOSTS = ['*', ] 3.é…ç½®memcachedä¼šè¯å­˜å‚¨æœåŠ¡ 134-142è¡Œ CACHES = { 'default': { 'BACKEND': 'django.core.cache.backends.locmem.LocMemCache', }, } ä¿®æ”¹ä¸º SESSION_ENGINE = 'django.contrib.sessions.backends.file' CACHES = { 'default': { 'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache', 'LOCATION': 'controller:11211', } } 4.å¯ç”¨Identity APIç‰ˆæœ¬3 161è¡Œ OPENSTACK_KEYSTONE_URL = \"http://%s:5000/v2.0\" % OPENSTACK_HOST ä¿®æ”¹ä¸º OPENSTACK_KEYSTONE_URL = \"http://%s:5000/v3\" % OPENSTACK_HOST 5.å¯ç”¨å¯¹åŸŸçš„æ”¯æŒ 65è¡Œ #OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = False ä¿®æ”¹ä¸º OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True 6.é…ç½®APIç‰ˆæœ¬ 55-60è¡Œï¼Œå–æ¶ˆæ³¨é‡Š #OPENSTACK_API_VERSIONS = { # \"data-processing\": 1.1, # \"identity\": 3, # \"volume\": 2, # \"compute\": 2, #} ä¿®æ”¹ä¸º OPENSTACK_API_VERSIONS = { \"identity\": 3, \"image\": 2, \"volume\": 2, } 7.é…ç½®defaultä½œä¸ºæ‚¨é€šè¿‡ä»ªè¡¨ç›˜åˆ›å»ºç”¨æˆ·çš„é»˜è®¤åŸŸ 71è¡Œ #OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = 'default' ä¿®æ”¹ä¸º OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = \"default\" 8.å°†useré…ç½®ä¸ºæ‚¨é€šè¿‡ä»ªè¡¨æ¿åˆ›å»ºçš„ç”¨æˆ·çš„é»˜è®¤è§’è‰² 161è¡Œ OPENSTACK_KEYSTONE_DEFAULT_ROLE = \"_member_\" ä¿®æ”¹ä¸º OPENSTACK_KEYSTONE_DEFAULT_ROLE = \"user\" 9.å¦‚æœé€‰æ‹©ç½‘ç»œé€‰é¡¹1ï¼Œè¯·ç¦ç”¨å¯¹ç¬¬3å±‚ç½‘ç»œæœåŠ¡çš„æ”¯æŒ 261-270è¡Œ OPENSTACK_NEUTRON_NETWORK = { 'enable_router': True, 'enable_quotas': True, 'enable_ipv6': True, 'enable_distributed_router': False, 'enable_ha_router': False, 'enable_lb': True, 'enable_firewall': True, 'enable_vpn': True, 'enable_fip_topology_check': True, ä¿®æ”¹ä¸º OPENSTACK_NEUTRON_NETWORK = { ... 'enable_router': False, 'enable_quotas': False, 'enable_distributed_router': False, 'enable_ha_router': False, 'enable_lb': False, 'enable_firewall': False, 'enable_vpn': False, 'enable_fip_topology_check': False, 10.å¯é€‰ï¼‰é…ç½®æ—¶åŒº 371è¡Œ TIME_ZONE = \"UTC\" ä¿®æ”¹ä¸º TIME_ZONE = \"Asia/Shanghai\" //æœ‰BUGï¼Œæš‚æ—¶ä¸ç”¨ #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/openstack-dashboard/local_settings{,.bak} && \\ sed -i.bak '158cOPENSTACK_HOST = \"controller\"' /etc/openstack-dashboard/local_settings && \\ sed -i '30s/horizon.example.com/*/' /etc/openstack-dashboard/local_settings|sed -i '30s/\\x27localhost\\x27//' /etc/openstack-dashboard/local_settings && \\ sed -i $'137a\\t\\'LOCATION\\': \\'controller:11211\\',' /etc/openstack-dashboard/local_settings /etc/openstack-dashboard/local_settingsæ–‡ä»¶å†…å®¹ # -*- coding: utf-8 -*- import os from django.utils.translation import ugettext_lazy as _ from openstack_dashboard import exceptions from openstack_dashboard.settings import HORIZON_CONFIG DEBUG = False TEMPLATE_DEBUG = DEBUG # WEBROOT is the location relative to Webserver root # should end with a slash. WEBROOT = '/dashboard/' #LOGIN_URL = WEBROOT + 'auth/login/' #LOGOUT_URL = WEBROOT + 'auth/logout/' # # LOGIN_REDIRECT_URL can be used as an alternative for # HORIZON_CONFIG.user_home, if user_home is not set. # Do not set it to '/home/', as this will cause circular redirect loop #LOGIN_REDIRECT_URL = WEBROOT # If horizon is running in production (DEBUG is False), set this # with the list of host/domain names that the application can serve. # For more information see: # https://docs.djangoproject.com/en/dev/ref/settings/#allowed-hosts ALLOWED_HOSTS = ['*', ] # Set SSL proxy settings: # Pass this header from the proxy after terminating the SSL, # and don't forget to strip it from the client's request. # For more information see: # https://docs.djangoproject.com/en/1.8/ref/settings/#secure-proxy-ssl-header #SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https') # If Horizon is being served through SSL, then uncomment the following two # settings to better secure the cookies from security exploits #CSRF_COOKIE_SECURE = True #SESSION_COOKIE_SECURE = True # The absolute path to the directory where message files are collected. # The message file must have a .json file extension. When the user logins to # horizon, the message files collected are processed and displayed to the user. #MESSAGES_PATH=None # Overrides for OpenStack API versions. Use this setting to force the # OpenStack dashboard to use a specific API version for a given service API. # Versions specified here should be integers or floats, not strings. # NOTE: The version should be formatted as it appears in the URL for the # service API. For example, The identity service APIs have inconsistent # use of the decimal point, so valid options would be 2.0 or 3. OPENSTACK_API_VERSIONS = { # \"data-processing\": 1.1, \"identity\": 3, \"image\": 2, \"volume\": 2, \"compute\": 2, } # Set this to True if running on multi-domain model. When this is enabled, it # will require user to enter the Domain name in addition to username for login. OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True # Overrides the default domain used when running on single-domain model # with Keystone V3. All entities will be created in the default domain. # NOTE: This value must be the ID of the default domain, NOT the name. # Also, you will most likely have a value in the keystone policy file like this # \"cloud_admin\": \"rule:admin_required and domain_id:\" # This value must match the domain id specified there. OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = 'default' # Set this to True to enable panels that provide the ability for users to # manage Identity Providers (IdPs) and establish a set of rules to map # federation protocol attributes to Identity API attributes. # This extension requires v3.0+ of the Identity API. #OPENSTACK_KEYSTONE_FEDERATION_MANAGEMENT = False # Set Console type: # valid options are \"AUTO\"(default), \"VNC\", \"SPICE\", \"RDP\", \"SERIAL\" or None # Set to None explicitly if you want to deactivate the console. #CONSOLE_TYPE = \"AUTO\" # If provided, a \"Report Bug\" link will be displayed in the site header # which links to the value of this setting (ideally a URL containing # information on how to report issues). #HORIZON_CONFIG[\"bug_url\"] = \"http://bug-report.example.com\" # Show backdrop element outside the modal, do not close the modal # after clicking on backdrop. #HORIZON_CONFIG[\"modal_backdrop\"] = \"static\" # Specify a regular expression to validate user passwords. #HORIZON_CONFIG[\"password_validator\"] = { # \"regex\": '.*', # \"help_text\": _(\"Your password does not meet the requirements.\"), #} # Disable simplified floating IP address management for deployments with # multiple floating IP pools or complex network requirements. #HORIZON_CONFIG[\"simple_ip_management\"] = False # Turn off browser autocompletion for forms including the login form and # the database creation workflow if so desired. #HORIZON_CONFIG[\"password_autocomplete\"] = \"off\" # Setting this to True will disable the reveal button for password fields, # including on the login form. #HORIZON_CONFIG[\"disable_password_reveal\"] = False LOCAL_PATH = '/tmp' # Set custom secret key: # You can either set it to a specific value or you can let horizon generate a # default secret key that is unique on this machine, e.i. regardless of the # amount of Python WSGI workers (if used behind Apache+mod_wsgi): However, # there may be situations where you would want to set this explicitly, e.g. # when multiple dashboard instances are distributed on different machines # (usually behind a load-balancer). Either you have to make sure that a session # gets all requests routed to the same dashboard instance or you set the same # SECRET_KEY for all of them. SECRET_KEY='65941f1393ea1c265ad7' # We recommend you use memcached for development; otherwise after every reload # of the django development server, you will have to login again. To use # memcached set CACHES to something like SESSION_ENGINE = 'django.contrib.sessions.backends.file' CACHES = { 'default': { 'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache', 'LOCATION': 'controller:11211', }, } #CACHES = { # 'default': { # 'BACKEND': 'django.core.cache.backends.locmem.LocMemCache', # }, #} # Send email to the console by default EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend' # Or send them to /dev/null #EMAIL_BACKEND = 'django.core.mail.backends.dummy.EmailBackend' # Configure these for your outgoing email host #EMAIL_HOST = 'smtp.my-company.com' #EMAIL_PORT = 25 #EMAIL_HOST_USER = 'djangomail' #EMAIL_HOST_PASSWORD = 'top-secret!' # For multiple regions uncomment this configuration, and add (endpoint, title). #AVAILABLE_REGIONS = [ # ('http://cluster1.example.com:5000/v2.0', 'cluster1'), # ('http://cluster2.example.com:5000/v2.0', 'cluster2'), #] OPENSTACK_HOST = \"controller\" OPENSTACK_KEYSTONE_URL = \"http://%s:5000/v3\" % OPENSTACK_HOST OPENSTACK_KEYSTONE_DEFAULT_ROLE = \"user\" # Enables keystone web single-sign-on if set to True. #WEBSSO_ENABLED = False # Determines which authentication choice to show as default. #WEBSSO_INITIAL_CHOICE = \"credentials\" # The list of authentication mechanisms which include keystone # federation protocols and identity provider/federation protocol # mapping keys (WEBSSO_IDP_MAPPING). Current supported protocol # IDs are 'saml2' and 'oidc' which represent SAML 2.0, OpenID # Connect respectively. # Do not remove the mandatory credentials mechanism. # Note: The last two tuples are sample mapping keys to a identity provider # and federation protocol combination (WEBSSO_IDP_MAPPING). #WEBSSO_CHOICES = ( # (\"credentials\", _(\"Keystone Credentials\")), # (\"oidc\", _(\"OpenID Connect\")), # (\"saml2\", _(\"Security Assertion Markup Language\")), # (\"acme_oidc\", \"ACME - OpenID Connect\"), # (\"acme_saml2\", \"ACME - SAML2\"), #) # A dictionary of specific identity provider and federation protocol # combinations. From the selected authentication mechanism, the value # will be looked up as keys in the dictionary. If a match is found, # it will redirect the user to a identity provider and federation protocol # specific WebSSO endpoint in keystone, otherwise it will use the value # as the protocol_id when redirecting to the WebSSO by protocol endpoint. # NOTE: The value is expected to be a tuple formatted as: (, ). #WEBSSO_IDP_MAPPING = { # \"acme_oidc\": (\"acme\", \"oidc\"), # \"acme_saml2\": (\"acme\", \"saml2\"), #} # Disable SSL certificate checks (useful for self-signed certificates): #OPENSTACK_SSL_NO_VERIFY = True # The CA certificate to use to verify SSL connections #OPENSTACK_SSL_CACERT = '/path/to/cacert.pem' # The OPENSTACK_KEYSTONE_BACKEND settings can be used to identify the # capabilities of the auth backend for Keystone. # If Keystone has been configured to use LDAP as the auth backend then set # can_edit_user to False and name to 'ldap'. # # TODO(tres): Remove these once Keystone has an API to identify auth backend. OPENSTACK_KEYSTONE_BACKEND = { 'name': 'native', 'can_edit_user': True, 'can_edit_group': True, 'can_edit_project': True, 'can_edit_domain': True, 'can_edit_role': True, } # Setting this to True, will add a new \"Retrieve Password\" action on instance, # allowing Admin session password retrieval/decryption. #OPENSTACK_ENABLE_PASSWORD_RETRIEVE = False # The Launch Instance user experience has been significantly enhanced. # You can choose whether to enable the new launch instance experience, # the legacy experience, or both. The legacy experience will be removed # in a future release, but is available as a temporary backup setting to ensure # compatibility with existing deployments. Further development will not be # done on the legacy experience. Please report any problems with the new # experience via the Launchpad tracking system. # # Toggle LAUNCH_INSTANCE_LEGACY_ENABLED and LAUNCH_INSTANCE_NG_ENABLED to # determine the experience to enable. Set them both to true to enable # both. #LAUNCH_INSTANCE_LEGACY_ENABLED = True #LAUNCH_INSTANCE_NG_ENABLED = False # A dictionary of settings which can be used to provide the default values for # properties found in the Launch Instance modal. #LAUNCH_INSTANCE_DEFAULTS = { # 'config_drive': False, #} # The Xen Hypervisor has the ability to set the mount point for volumes # attached to instances (other Hypervisors currently do not). Setting # can_set_mount_point to True will add the option to set the mount point # from the UI. OPENSTACK_HYPERVISOR_FEATURES = { 'can_set_mount_point': False, 'can_set_password': False, 'requires_keypair': False, } # The OPENSTACK_CINDER_FEATURES settings can be used to enable optional # services provided by cinder that is not exposed by its extension API. OPENSTACK_CINDER_FEATURES = { 'enable_backup': False, } # The OPENSTACK_NEUTRON_NETWORK settings can be used to enable optional # services provided by neutron. Options currently available are load # balancer service, security groups, quotas, VPN service. OPENSTACK_NEUTRON_NETWORK = { 'enable_router': False, 'enable_quotas': False, 'enable_ipv6': False, 'enable_distributed_router': False, 'enable_ha_router': False, 'enable_lb': False, 'enable_firewall': False, 'enable_vpn': False, 'enable_fip_topology_check': False, # Neutron can be configured with a default Subnet Pool to be used for IPv4 # subnet-allocation. Specify the label you wish to display in the Address # pool selector on the create subnet step if you want to use this feature. 'default_ipv4_subnet_pool_label': None, # Neutron can be configured with a default Subnet Pool to be used for IPv6 # subnet-allocation. Specify the label you wish to display in the Address # pool selector on the create subnet step if you want to use this feature. # You must set this to enable IPv6 Prefix Delegation in a PD-capable # environment. 'default_ipv6_subnet_pool_label': None, # The profile_support option is used to detect if an external router can be # configured via the dashboard. When using specific plugins the # profile_support can be turned on if needed. 'profile_support': None, #'profile_support': 'cisco', # Set which provider network types are supported. Only the network types # in this list will be available to choose from when creating a network. # Network types include local, flat, vlan, gre, and vxlan. 'supported_provider_types': ['*'], # Set which VNIC types are supported for port binding. Only the VNIC # types in this list will be available to choose from when creating a # port. # VNIC types include 'normal', 'macvtap' and 'direct'. # Set to empty list or None to disable VNIC type selection. 'supported_vnic_types': ['*'], } # The OPENSTACK_HEAT_STACK settings can be used to disable password # field required while launching the stack. OPENSTACK_HEAT_STACK = { 'enable_user_pass': True, } # The OPENSTACK_IMAGE_BACKEND settings can be used to customize features # in the OpenStack Dashboard related to the Image service, such as the list # of supported image formats. #OPENSTACK_IMAGE_BACKEND = { # 'image_formats': [ # ('', _('Select format')), # ('aki', _('AKI - Amazon Kernel Image')), # ('ami', _('AMI - Amazon Machine Image')), # ('ari', _('ARI - Amazon Ramdisk Image')), # ('docker', _('Docker')), # ('iso', _('ISO - Optical Disk Image')), # ('ova', _('OVA - Open Virtual Appliance')), # ('qcow2', _('QCOW2 - QEMU Emulator')), # ('raw', _('Raw')), # ('vdi', _('VDI - Virtual Disk Image')), # ('vhd', _('VHD - Virtual Hard Disk')), # ('vmdk', _('VMDK - Virtual Machine Disk')), # ], #} # The IMAGE_CUSTOM_PROPERTY_TITLES settings is used to customize the titles for # image custom property attributes that appear on image detail pages. IMAGE_CUSTOM_PROPERTY_TITLES = { \"architecture\": _(\"Architecture\"), \"kernel_id\": _(\"Kernel ID\"), \"ramdisk_id\": _(\"Ramdisk ID\"), \"image_state\": _(\"Euca2ools state\"), \"project_id\": _(\"Project ID\"), \"image_type\": _(\"Image Type\"), } # The IMAGE_RESERVED_CUSTOM_PROPERTIES setting is used to specify which image # custom properties should not be displayed in the Image Custom Properties # table. IMAGE_RESERVED_CUSTOM_PROPERTIES = [] # OPENSTACK_ENDPOINT_TYPE specifies the endpoint type to use for the endpoints # in the Keystone service catalog. Use this setting when Horizon is running # external to the OpenStack environment. The default is 'publicURL'. #OPENSTACK_ENDPOINT_TYPE = \"publicURL\" # SECONDARY_ENDPOINT_TYPE specifies the fallback endpoint type to use in the # case that OPENSTACK_ENDPOINT_TYPE is not present in the endpoints # in the Keystone service catalog. Use this setting when Horizon is running # external to the OpenStack environment. The default is None. This # value should differ from OPENSTACK_ENDPOINT_TYPE if used. #SECONDARY_ENDPOINT_TYPE = \"publicURL\" # The number of objects (Swift containers/objects or images) to display # on a single page before providing a paging element (a \"more\" link) # to paginate results. API_RESULT_LIMIT = 1000 API_RESULT_PAGE_SIZE = 20 # The size of chunk in bytes for downloading objects from Swift SWIFT_FILE_TRANSFER_CHUNK_SIZE = 512 * 1024 # Specify a maximum number of items to display in a dropdown. DROPDOWN_MAX_ITEMS = 30 # The timezone of the server. This should correspond with the timezone # of your entire OpenStack installation, and hopefully be in UTC. TIME_ZONE = \"Asia/Shanghai\" # When launching an instance, the menu of available flavors is # sorted by RAM usage, ascending. If you would like a different sort order, # you can provide another flavor attribute as sorting key. Alternatively, you # can provide a custom callback method to use for sorting. You can also provide # a flag for reverse sort. For more info, see # http://docs.python.org/2/library/functions.html#sorted #CREATE_INSTANCE_FLAVOR_SORT = { # 'key': 'name', # # or # 'key': my_awesome_callback_method, # 'reverse': False, #} # Set this to True to display an 'Admin Password' field on the Change Password # form to verify that it is indeed the admin logged-in who wants to change # the password. #ENFORCE_PASSWORD_CHECK = False # Modules that provide /auth routes that can be used to handle different types # of user authentication. Add auth plugins that require extra route handling to # this list. #AUTHENTICATION_URLS = [ # 'openstack_auth.urls', #] # The Horizon Policy Enforcement engine uses these values to load per service # policy rule files. The content of these files should match the files the # OpenStack services are using to determine role based access control in the # target installation. # Path to directory containing policy.json files POLICY_FILES_PATH = '/etc/openstack-dashboard' # Map of local copy of service policy files. # Please insure that your identity policy file matches the one being used on # your keystone servers. There is an alternate policy file that may be used # in the Keystone v3 multi-domain case, policy.v3cloudsample.json. # This file is not included in the Horizon repository by default but can be # found at # http://git.openstack.org/cgit/openstack/keystone/tree/etc/ \\ # policy.v3cloudsample.json # Having matching policy files on the Horizon and Keystone servers is essential # for normal operation. This holds true for all services and their policy files. #POLICY_FILES = { # 'identity': 'keystone_policy.json', # 'compute': 'nova_policy.json', # 'volume': 'cinder_policy.json', # 'image': 'glance_policy.json', # 'orchestration': 'heat_policy.json', # 'network': 'neutron_policy.json', # 'telemetry': 'ceilometer_policy.json', #} # TODO: (david-lyle) remove when plugins support adding settings. # Note: Only used when trove-dashboard plugin is configured to be used by # Horizon. # Trove user and database extension support. By default support for # creating users and databases on database instances is turned on. # To disable these extensions set the permission here to something # unusable such as [\"!\"]. #TROVE_ADD_USER_PERMS = [] #TROVE_ADD_DATABASE_PERMS = [] # Change this patch to the appropriate list of tuples containing # a key, label and static directory containing two files: # _variables.scss and _styles.scss #AVAILABLE_THEMES = [ # ('default', 'Default', 'themes/default'), # ('material', 'Material', 'themes/material'), #] LOGGING = { 'version': 1, # When set to True this will disable all logging except # for loggers specified in this configuration dictionary. Note that # if nothing is specified here and disable_existing_loggers is True, # django.db.backends will still log unless it is disabled explicitly. 'disable_existing_loggers': False, 'handlers': { 'null': { 'level': 'DEBUG', 'class': 'logging.NullHandler', }, 'console': { # Set the level to \"DEBUG\" for verbose output logging. 'level': 'INFO', 'class': 'logging.StreamHandler', }, }, 'loggers': { # Logging from django.db.backends is VERY verbose, send to null # by default. 'django.db.backends': { 'handlers': ['null'], 'propagate': False, }, 'requests': { 'handlers': ['null'], 'propagate': False, }, 'horizon': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'openstack_dashboard': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'novaclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'cinderclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'keystoneclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'glanceclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'neutronclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'heatclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'ceilometerclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'swiftclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'openstack_auth': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'nose.plugins.manager': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'django': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'iso8601': { 'handlers': ['null'], 'propagate': False, }, 'scss': { 'handlers': ['null'], 'propagate': False, }, }, } # 'direction' should not be specified for all_tcp/udp/icmp. # It is specified in the form. SECURITY_GROUP_RULES = { 'all_tcp': { 'name': _('All TCP'), 'ip_protocol': 'tcp', 'from_port': '1', 'to_port': '65535', }, 'all_udp': { 'name': _('All UDP'), 'ip_protocol': 'udp', 'from_port': '1', 'to_port': '65535', }, 'all_icmp': { 'name': _('All ICMP'), 'ip_protocol': 'icmp', 'from_port': '-1', 'to_port': '-1', }, 'ssh': { 'name': 'SSH', 'ip_protocol': 'tcp', 'from_port': '22', 'to_port': '22', }, 'smtp': { 'name': 'SMTP', 'ip_protocol': 'tcp', 'from_port': '25', 'to_port': '25', }, 'dns': { 'name': 'DNS', 'ip_protocol': 'tcp', 'from_port': '53', 'to_port': '53', }, 'http': { 'name': 'HTTP', 'ip_protocol': 'tcp', 'from_port': '80', 'to_port': '80', }, 'pop3': { 'name': 'POP3', 'ip_protocol': 'tcp', 'from_port': '110', 'to_port': '110', }, 'imap': { 'name': 'IMAP', 'ip_protocol': 'tcp', 'from_port': '143', 'to_port': '143', }, 'ldap': { 'name': 'LDAP', 'ip_protocol': 'tcp', 'from_port': '389', 'to_port': '389', }, 'https': { 'name': 'HTTPS', 'ip_protocol': 'tcp', 'from_port': '443', 'to_port': '443', }, 'smtps': { 'name': 'SMTPS', 'ip_protocol': 'tcp', 'from_port': '465', 'to_port': '465', }, 'imaps': { 'name': 'IMAPS', 'ip_protocol': 'tcp', 'from_port': '993', 'to_port': '993', }, 'pop3s': { 'name': 'POP3S', 'ip_protocol': 'tcp', 'from_port': '995', 'to_port': '995', }, 'ms_sql': { 'name': 'MS SQL', 'ip_protocol': 'tcp', 'from_port': '1433', 'to_port': '1433', }, 'mysql': { 'name': 'MYSQL', 'ip_protocol': 'tcp', 'from_port': '3306', 'to_port': '3306', }, 'rdp': { 'name': 'RDP', 'ip_protocol': 'tcp', 'from_port': '3389', 'to_port': '3389', }, } # Deprecation Notice: # # The setting FLAVOR_EXTRA_KEYS has been deprecated. # Please load extra spec metadata into the Glance Metadata Definition Catalog. # # The sample quota definitions can be found in: # /etc/metadefs/compute-quota.json # # The metadata definition catalog supports CLI and API: # $glance --os-image-api-version 2 help md-namespace-import # $glance-manage db_load_metadefs # # See Metadata Definitions on: http://docs.openstack.org/developer/glance/ # TODO: (david-lyle) remove when plugins support settings natively # Note: This is only used when the Sahara plugin is configured and enabled # for use in Horizon. # Indicate to the Sahara data processing service whether or not # automatic floating IP allocation is in effect. If it is not # in effect, the user will be prompted to choose a floating IP # pool for use in their cluster. False by default. You would want # to set this to True if you were running Nova Networking with # auto_assign_floating_ip = True. #SAHARA_AUTO_IP_ALLOCATION_ENABLED = False # The hash algorithm to use for authentication tokens. This must # match the hash algorithm that the identity server and the # auth_token middleware are using. Allowed values are the # algorithms supported by Python's hashlib library. #OPENSTACK_TOKEN_HASH_ALGORITHM = 'md5' # Hashing tokens from Keystone keeps the Horizon session data smaller, but it # doesn't work in some cases when using PKI tokens. Uncomment this value and # set it to False if using PKI tokens and there are 401 errors due to token # hashing. #OPENSTACK_TOKEN_HASH_ENABLED = True # AngularJS requires some settings to be made available to # the client side. Some settings are required by in-tree / built-in horizon # features. These settings must be added to REST_API_REQUIRED_SETTINGS in the # form of ['SETTING_1','SETTING_2'], etc. # # You may remove settings from this list for security purposes, but do so at # the risk of breaking a built-in horizon feature. These settings are required # for horizon to function properly. Only remove them if you know what you # are doing. These settings may in the future be moved to be defined within # the enabled panel configuration. # You should not add settings to this list for out of tree extensions. # See: https://wiki.openstack.org/wiki/Horizon/RESTAPI REST_API_REQUIRED_SETTINGS = ['OPENSTACK_HYPERVISOR_FEATURES', 'LAUNCH_INSTANCE_DEFAULTS'] # Additional settings can be made available to the client side for # extensibility by specifying them in REST_API_ADDITIONAL_SETTINGS # !! Please use extreme caution as the settings are transferred via HTTP/S # and are not encrypted on the browser. This is an experimental API and # may be deprecated in the future without notice. #REST_API_ADDITIONAL_SETTINGS = [] # DISALLOW_IFRAME_EMBED can be used to prevent Horizon from being embedded # within an iframe. Legacy browsers are still vulnerable to a Cross-Frame # Scripting (XFS) vulnerability, so this option allows extra security hardening # where iframes are not used in deployment. Default setting is True. # For more information see: # http://tinyurl.com/anticlickjack #DISALLOW_IFRAME_EMBED = True 7.3 éªŒè¯æ“ä½œ 7.3.1 ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™åç»­è®¿é—®dashboardä¼šæŠ¥500é”™è¯¯ sed -i.bak '3aWSGIApplicationGroup %{GLOBAL}' \\ /etc/httpd/conf.d/openstack-dashboard.conf #é‡å¯httpd systemctl enable httpd && systemctl restart httpd 7.3.2 ç™»å½•dashboard 10.0.0.31/dashboard åŸŸï¼šdefault ç”¨æˆ·åï¼šadmin å¯†ç ï¼šADMIN_PASS ç™»é™†åé¦–ç•Œé¢ åˆ°æ­¤ï¼Œè®¡ç®—èŠ‚ç‚¹Dashboardå®‰è£…å®Œæˆï¼ï¼ï¼ å¦‚æœé‡åˆ°å¦‚ä¸‹é”™è¯¯ è§£å†³æ–¹æ³• å®‰è£…dashboardèŠ‚ç‚¹åšä»¥ä¸‹æ“ä½œ 1.ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/openstack-dashboard/local_settings ä¿®æ”¹ SESSION_ENGINE = 'django.contrib.sessions.backends.cache' ä¿®æ”¹ä¸º SESSION_ENGINE = 'django.contrib.sessions.backends.file' 2.é‡å¯httpd systemctl restart httpd æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/mitaka/2.Mitakaç‰ˆä½¿ç”¨å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå®ä¾‹.html":{"url":"linux/openstack/mitaka/2.Mitakaç‰ˆä½¿ç”¨å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå®ä¾‹.html","title":"Mitakaç‰ˆä½¿ç”¨å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå®ä¾‹","keywords":"","body":"Mitakaç‰ˆä½¿ç”¨å‘½ä»¤å¯åŠ¨ä¸€ä¸ªç¤ºä¾‹ 1.åˆ›å»ºç½‘ç»œï¼ˆç½‘ç»œå+å­ç½‘ï¼‰ åˆ›å»ºç½‘ç»œå neutron net-create --shared --provider:physical_network provider \\ --provider:network_type flat pptfz net-create åˆ›å»ºç½‘ç»œ --shared åˆ›å»ºå…±äº«ç½‘ç»œ --provider:physical_network æŒ‡å®šç‰©ç†ç½‘å¡åç§° providerç½‘ç»œæ ‡ç­¾ --provider:network_type æŒ‡å®šç½‘ç»œç±»å‹ flatæ¡¥æ¥ç½‘ç»œ pptfzç½‘ç»œåç§° åˆ›å»ºå­ç½‘ neutron subnet-create --name bxb \\ --allocation-pool start=10.0.0.101,end=10.0.0.250 \\ --dns-nameserver 223.5.5.5 --gateway 10.0.0.254 \\ pptfz 10.0.0.0/24 subnet-create åˆ›å»ºå­ç½‘ --name æŒ‡å®šåç§° bxbå­ç½‘åç§° --allocation-pool IPåœ°å€èŒƒå›´ pptfz åˆ›å»ºçš„å­ç½‘å…³è”åˆ°å“ªä¸ªç½‘ç»œ ä»¥ä¸‹ä¸ºæ“ä½œ #åˆ›å»ºç½‘ç»œ neutron net-create --shared --provider:physical_network provider \\ --provider:network_type flat pptfz Created a new network: +---------------------------+--------------------------------------+ | Field | Value | +---------------------------+--------------------------------------+ | admin_state_up | True | | availability_zone_hints | | | availability_zones | | | created_at | 2019-02-03T09:37:39 | | description | | | id | 9125ad48-6bbe-4baf-8d78-f91a7c0a8ea2 | | ipv4_address_scope | | | ipv6_address_scope | | | mtu | 1500 | | name | pptfz | | port_security_enabled | True | | provider:network_type | flat | | provider:physical_network | provider | | provider:segmentation_id | | | router:external | False | | shared | True | | status | ACTIVE | | subnets | | | tags | | | tenant_id | e33e3feaef784a5bb45bd9c766bc0f46 | | updated_at | 2019-02-03T09:37:39 | +---------------------------+--------------------------------------+ #åˆ›å»ºå­ç½‘ neutron subnet-create --name bxb \\ --allocation-pool start=10.0.0.101,end=10.0.0.250 \\ --dns-nameserver 223.5.5.5 --gateway 10.0.0.1 \\ pptfz 10.0.0.0/24 Created a new subnet: +-------------------+----------------------------------------------+ | Field | Value | +-------------------+----------------------------------------------+ | allocation_pools | {\"start\": \"10.0.0.101\", \"end\": \"10.0.0.250\"} | | cidr | 10.0.0.0/24 | | created_at | 2019-02-03T09:40:37 | | description | | | dns_nameservers | 223.5.5.5 | | enable_dhcp | True | | gateway_ip | 10.0.0.254 | | host_routes | | | id | ad21906e-166d-47e2-8634-18c907c6da3b | | ip_version | 4 | | ipv6_address_mode | | | ipv6_ra_mode | | | name | bxb | | network_id | 9125ad48-6bbe-4baf-8d78-f91a7c0a8ea2 | | subnetpool_id | | | tenant_id | e33e3feaef784a5bb45bd9c766bc0f46 | | updated_at | 2019-02-03T09:40:37 | +-------------------+----------------------------------------------+ 2.åˆ›å»ºäº‘ä¸»æœºçš„ç¡¬ä»¶é…ç½®æ–¹æ¡ˆ openstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano +----------------------------+---------+ | Field | Value | +----------------------------+---------+ | OS-FLV-DISABLED:disabled | False | | OS-FLV-EXT-DATA:ephemeral | 0 | | disk | 1 | | id | 0 | | name | m1.nano | | os-flavor-access:is_public | True | | ram | 64 | | rxtx_factor | 1.0 | | swap | | | vcpus | 1 | +----------------------------+---------+ //å‚æ•°è¯´æ˜ openstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano flavor ç¡¬ä»¶é…ç½®æ–¹æ¡ˆ --id æŒ‡å®šç¼–å· --vcpus cpuä¸ªæ•° --ram å†…å­˜ï¼ˆå•ä½ï¼šMï¼‰ --disk ç£ç›˜ï¼ˆå•ä½ï¼šGï¼‰ m1.nano æ–¹æ¡ˆåç§° 3.åˆ›å»ºå¯†é’¥å¯¹ ssh-keygen -q -N \"\" -f ~/.ssh/id_rsa openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey +-------------+-------------------------------------------------+ | Field | Value | +-------------+-------------------------------------------------+ | fingerprint | 0e:af:ab:c3:74:5f:56:1b:e8:46:7d:e5:65:4f:a8:9a | | name | mykey | | user_id | aaa8bfce5b5d451b956bb76dee235b9e | +-------------+-------------------------------------------------+ //å‚æ•°è¯´æ˜ ssh-keygen -q -N \"\" -f ~/.ssh/id_rsa éäº¤äº’å¼ç”Ÿæˆå¯†é’¥å¯¹ -q å®‰é™æ¨¡å¼ -N æŒ‡å®šåŠ å¯†å¯†ç  -f å¯†é’¥å¯¹å­˜æ”¾ä½ç½® openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey ä¸Šä¼ å¯†é’¥å¯¹ 4.åˆ›å»ºå®‰å…¨ç»„è§„åˆ™ openstack security group rule create --proto icmp default +-----------------------+--------------------------------------+ | Field | Value | +-----------------------+--------------------------------------+ | id | cb340772-4dd8-4d33-8ae0-2be3f43f26de | | ip_protocol | icmp | | ip_range | 0.0.0.0/0 | | parent_group_id | b6f5f95a-fd52-43c1-bb4c-0625750e4369 | | port_range | | | remote_security_group | | +-----------------------+--------------------------------------+ openstack security group rule create --proto tcp --dst-port 22 default +-----------------------+--------------------------------------+ | Field | Value | +-----------------------+--------------------------------------+ | id | 01c1cea4-76c0-4181-aca9-4b3148fb0397 | | ip_protocol | tcp | | ip_range | 0.0.0.0/0 | | parent_group_id | b6f5f95a-fd52-43c1-bb4c-0625750e4369 | | port_range | 22:22 | | remote_security_group | | +-----------------------+--------------------------------------+ #é»˜è®¤æ‰€æœ‰ç«¯å£å…¨éƒ¨ç¦æ­¢ï¼Œä¸Šè¾¹ä¸¤ä¸ªå‘½ä»¤ä¸ºå…è®¸pingå’Œssh openstack security group rule create --proto icmp default openstack security group rule create --proto tcp --dst-port 22 default 5.å¯åŠ¨ä¸€ä¸ªå®ä¾‹ openstack server create --flavor m1.nano --image cirros \\ --nic net-id=`neutron net-list|awk 'NR==4{print $2}'` --security-group default \\ --key-name mykey pptfz +--------------------------------------+-----------------------------------------------+ | Field | Value | +--------------------------------------+-----------------------------------------------+ | OS-DCF:diskConfig | MANUAL | | OS-EXT-AZ:availability_zone | | | OS-EXT-SRV-ATTR:host | None | | OS-EXT-SRV-ATTR:hypervisor_hostname | None | | OS-EXT-SRV-ATTR:instance_name | instance-00000001 | | OS-EXT-STS:power_state | 0 | | OS-EXT-STS:task_state | scheduling | | OS-EXT-STS:vm_state | building | | OS-SRV-USG:launched_at | None | | OS-SRV-USG:terminated_at | None | | accessIPv4 | | | accessIPv6 | | | addresses | | | adminPass | 8KcNG34aXwuK | | config_drive | | | created | 2019-02-03T12:10:10Z | | flavor | m1.nano (0) | | hostId | | | id | d5e07f54-c70e-4657-9ec5-778edc941e99 | | image | cirros (ac21b17b-e910-4ca4-b743-914b8fbd0e55) | | key_name | mykey | | name | pptfz | | os-extended-volumes:volumes_attached | [] | | progress | 0 | | project_id | e33e3feaef784a5bb45bd9c766bc0f46 | | properties | | | security_groups | [{u'name': u'default'}] | | status | BUILD | | updated | 2019-02-03T12:10:12Z | | user_id | aaa8bfce5b5d451b956bb76dee235b9e | +--------------------------------------+-----------------------------------------------+ #åˆ›å»ºå®ŒæˆåæŸ¥çœ‹ï¼ŒçŠ¶æ€ä¸ºACTIVEå³ä¸ºæ­£ç¡® openstack server list +--------------------------------------+-------+--------+------------------+ | ID | Name | Status | Networks | +--------------------------------------+-------+--------+------------------+ | d5e07f54-c70e-4657-9ec5-778edc941e99 | pptfz | ACTIVE | pptfz=10.0.0.102 | +--------------------------------------+-------+--------+------------------+ å¯åŠ¨å®ä¾‹åä¼šåœ¨webç•Œé¢æ˜¾ç¤º é¡¹ç›®-->è®¡ç®—-->ç¤ºä¾‹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/mitaka/3.Mitakaç‰ˆwebç•Œé¢å¯åŠ¨ä¸€ä¸ªå®ä¾‹.html":{"url":"linux/openstack/mitaka/3.Mitakaç‰ˆwebç•Œé¢å¯åŠ¨ä¸€ä¸ªå®ä¾‹.html","title":"Mitakaç‰ˆwebç•Œé¢å¯åŠ¨ä¸€ä¸ªå®ä¾‹","keywords":"","body":"Mitakaç‰ˆwebç•Œé¢å¯åŠ¨ä¸€ä¸ªå®ä¾‹ 1.é¡¹ç›®-->è®¡ç®—--å®ä¾‹-->å¯åŠ¨å®ä¾‹ 2.å¡«å†™å®ä¾‹åç§° 3.é€‰æ‹©é•œåƒï¼Œè¿™é‡Œåªæœ‰ä¸€ä¸ªï¼Œå¦‚æœæœ‰å¤šä¸ªå¯ä»¥ä»»æ„é€‰æ‹©ä¸åŒçš„é•œåƒ 4.é€‰æ‹©å®ä¾‹çš„é…ç½® 5.å¯åŠ¨å®ä¾‹ è¿™é‡Œå› ä¸ºåˆšåˆšå®‰è£…å®Œæˆï¼Œç½‘ç»œã€ç½‘ç»œç«¯å£ã€å®‰å…¨ç»„ã€å¯†é’¥å¯¹éƒ½åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ç³»ç»Ÿç›´æ¥é»˜è®¤é€‰æ‹©ï¼Œå¦‚æœåç»­åˆ›å»ºäº†è¿™äº›é…ç½®ï¼Œå¯ä»¥ä¾æ®å®é™…æƒ…å†µå…·ä½“é€‰æ‹©ï¼Œè¿™é‡Œç›´æ¥é»˜è®¤å³å¯ 6.å¯åŠ¨å®Œæˆ 7.è¿æ¥å®ä¾‹ï¼Œå³è¾¹ä¸‹ç®­å¤´-->æ§åˆ¶å° âš ï¸ç‚¹å‡»æ§åˆ¶å°åæç¤ºæ‰¾ä¸åˆ°controlleråœ°å€ï¼Œå› ä¸ºæ²¡æœ‰åšhostsè§£æï¼Œéœ€è¦å…ˆåšhostsè§£æ windows C:\\Windows\\System32\\drivers\\etc\\hosts 10.0.0.11 controller mac /etc/hosts 10.0.0.11 controller åšå®Œhostsè§£æååˆ·æ–°ï¼Œä½†æ˜¯æ­¤æ—¶åˆæœ‰é—®é¢˜ï¼Œä¼šä¸€ç›´å¡åœ¨è¿™ä¸ªç•Œé¢ä¸åŠ¨ è§£å†³æ–¹æ³•ï¼š 1.ä¿®æ”¹è®¡ç®—èŠ‚ç‚¹/etc/nova/nova.conf åœ¨[libvirt]ä¸‹æ·»åŠ å¦‚ä¸‹ä¸¤è¡Œ cpu_mode = none virt_type = qemu 2.é‡å¯nova-compute systemctl restart openstack-nova-compute ä¿®æ”¹å®Œopenstack-nova-computeåï¼Œç¡¬é‡å¯ï¼ˆç›¸å½“äºæ‹”ç”µæºï¼‰å®ä¾‹ ç¡¬é‡å¯å®ä¾‹åå°±å¯ä»¥ç™»å½•äº†ï¼ŒæŒ‰ç…§æç¤ºç™»å½•ç”¨æˆ·åæ˜¯cirrosï¼Œå¯†ç æ˜¯cubswin:) âš ï¸æ³¨æ„ï¼Œéœ€è¦å…ˆåœ¨å‘¨å›´é»‘æ¡†å¤„ç‚¹å‡»ä¸€ä¸‹æ‰èƒ½è¿›å…¥æ§åˆ¶å° ç™»é™†æˆåŠŸåï¼ŒæŸ¥çœ‹ipã€ä¸»æœºåã€èƒ½å¤Ÿä¸Šå¤–ç½‘å³ä¸ºæ­£ç¡® åˆ‡æ¢ä¸ºrootï¼Œç”¨é»˜è®¤ç”¨æˆ·ç™»å½•ç³»ç»Ÿåï¼Œæ‰§è¡Œsudo su - rootåˆ‡æ¢åˆ°rootç”¨æˆ·ï¼Œç„¶åå°±å¯ä»¥ä¿®æ”¹å¯†ç äº†ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥ç”¨xshellæˆ–è€…å…¶ä»–ç»ˆç«¯è¿æ¥ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/rocky/1.centos7.8æ­å»ºopenstack Rockyç‰ˆ.html":{"url":"linux/openstack/rocky/1.centos7.8æ­å»ºopenstack Rockyç‰ˆ.html","title":"centos7.8æ­å»ºopenstack Rockyç‰ˆ","keywords":"","body":"centos7.8æ­å»ºopenstack Rockyç‰ˆ å®˜æ–¹æ–‡æ¡£ rockyç‰ˆä¸­çš„å¯†ç è¯´æ˜ æ•°æ®åº“å¯†ç ï¼ˆæœªä½¿ç”¨å˜é‡ï¼‰ æ•°æ®åº“çš„æ ¹å¯†ç  ADMIN_PASS ç”¨æˆ·å¯†ç  admin CINDER_DBPASS å—å­˜å‚¨æœåŠ¡çš„æ•°æ®åº“å¯†ç  CINDER_PASS å—å­˜å‚¨æœåŠ¡ç”¨æˆ·å¯†ç  cinder DASH_DBPASS ä»ªè¡¨æ¿çš„æ•°æ®åº“å¯†ç  DEMO_PASS ç”¨æˆ·å¯†ç  demo GLANCE_DBPASS é•œåƒæœåŠ¡çš„æ•°æ®åº“å¯†ç  GLANCE_PASS å›¾ç‰‡æœåŠ¡ç”¨æˆ·å¯†ç  glance KEYSTONE_DBPASS èº«ä»½æœåŠ¡çš„æ•°æ®åº“å¯†ç  METADATA_SECRET å…ƒæ•°æ®ä»£ç†çš„ç§˜å¯† NEUTRON_DBPASS ç½‘ç»œæœåŠ¡çš„æ•°æ®åº“å¯†ç  NEUTRON_PASS ç½‘ç»œæœåŠ¡ç”¨æˆ·å¯†ç  neutron NOVA_DBPASS è®¡ç®—æœåŠ¡çš„æ•°æ®åº“å¯†ç  NOVA_PASS è®¡ç®—æœåŠ¡ç”¨æˆ·å¯†ç  nova PLACEMENT_PASS å±•ç¤ºä½ç½®æœåŠ¡ç”¨æˆ·çš„å¯†ç  placement RABBIT_PASS RabbitMQç”¨æˆ·å¯†ç  openstack å®éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå é»˜è®¤ç½‘å…³ ç¡¬ä»¶ç¯å¢ƒ è™šæ‹ŸåŒ– é˜²ç«å¢™ selinux æ§åˆ¶èŠ‚ç‚¹ 10.0.0.11/24 controller 10.0.0.1 4Gå†…å­˜ï¼Œ50Gç¡¬ç›˜ å¼€å¯ å…³é—­ å…³é—­ è®¡ç®—èŠ‚ç‚¹1 10.0.0.31/24 compute1 10.0.0.1 4Gå†…å­˜ï¼Œ50Gç¡¬ç›˜ å¼€å¯ å…³é—­ å…³é—­ å­˜å‚¨èŠ‚ç‚¹1 10.0.0.41/24 block1 10.0.0.1 2Gå†…å­˜ï¼Œ100Gç¡¬ç›˜ å¼€å¯ å…³é—­ å…³é—­ å¯¹è±¡èŠ‚ç‚¹1 10.0.0.51/24 object1 10.0.0.1 2Gå†…å­˜ï¼Œ100Gç¡¬ç›˜ å¼€å¯ å…³é—­ å…³é—­ å¯¹è±¡èŠ‚ç‚¹2 10.0.0.52/24 object2 10.0.0.1 2Gå†…å­˜ï¼Œ100Gç¡¬ç›˜ å¼€å¯ å…³é—­ å…³é—­ æŠŠrockyç‰ˆrpmåŒ…åšæˆæœ¬åœ°yumæº 1.ä¸‹è½½åŒ… yum -y install createrepo 2.åˆ¶ä½œä»“åº“ createrepo openstack-rocky 3.åœ¨10.0.0.51å®‰è£…nginxï¼Œå› ä¸ºæ˜¯é‡‡ç”¨httpæ–¹å¼ yum -y install nginx systemctl enable nginx && systemctl start nginx 4.ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ï¼Œyumå®‰è£…çš„nginxæ ¹ç›®å½•æ˜¯/usr/share/nginx/htmlï¼Œè¿™é‡Œä¸ªäººä¹ æƒ¯é€‰æ‹©å¯ç”¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œç›‘å¬88ç«¯å£ cat > /etc/nginx/conf.d/openstack-rocky.repo.conf /etc/yum.repos.d/openstack-rocky.repo >/etc/fstab 6.ç”Ÿæˆæœ¬åœ°ç¼“å­˜ yum makecache åŸºç¡€ç¯å¢ƒå®˜æ–¹æ–‡æ¡£ ä¸€ã€åŸºç¡€ç¯å¢ƒé…ç½® 1.1 å…³é—­é˜²ç«å¢™å’Œselinux //ç¦ç”¨é˜²ç«å¢™ systemctl stop firewalld && systemctl disable firewalld //ç¦ç”¨selinux #ä¸´æ—¶ä¿®æ”¹ setenforce 0 #æ°¸ä¹…ä¿®æ”¹ï¼Œé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆ sed -i '7s/enforcing/disabled/' /etc/selinux/config 1.2 é…ç½®hostsè§£æ #æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹ç›¸åŒæ“ä½œ cat >> /etc/hosts 1.3 é…ç½®NTPæœåŠ¡ï¼Œè¦ä¿è¯æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹æ—¶é—´ä¸€è‡´ æ§åˆ¶èŠ‚ç‚¹ 1.å®‰è£…chrony yum -y install chrony 2.ç¼–è¾‘chronyé…ç½®æ–‡ä»¶/etc/chrony.conf /åˆ é™¤ä»¥ä¸‹4è¡Œï¼Œä½¿ç”¨é˜¿é‡Œäº‘NTPæœåŠ¡å™¨ server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst ä¿®æ”¹ä¸º server ntp1.aliyun.com iburst /å…è®¸è¿æ¥æ§åˆ¶èŠ‚ç‚¹çš„ç½‘æ®µï¼Œ24è¡Œå¢åŠ ä»¥ä¸‹ä¸€è¡Œ allow 10.0.0.0/24 #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i '3,6d' /etc/chrony.conf && sed -i '3cserver ntp1.aliyun.com iburst' \\ /etc/chrony.conf && sed -i '23callow 10.0.0.0/24' /etc/chrony.conf 3.å¯åŠ¨NTPæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable chronyd && systemctl start chronyd 4.æ£€æŸ¥ç«¯å£ï¼Œç›‘å¬udp323ç«¯å£ $ netstat -nupl|grep chronyd udp 0 0 127.0.0.1:323 0.0.0.0:* 29356/chronyd udp 0 0 0.0.0.0:123 0.0.0.0:* 29356/chronyd udp6 0 0 ::1:323 :::* 29356/chronyd 5.éªŒè¯ $ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* 120.25.115.20 2 6 37 29 +43us[ -830us] +/- 22ms è®¡ç®—ã€å­˜å‚¨ã€å¯¹è±¡èŠ‚ç‚¹ 1.å®‰è£…chrony yum -y install chrony 2.ç¼–è¾‘chronyé…ç½®æ–‡ä»¶/etc/chrony.conf /åˆ é™¤ä»¥ä¸‹4è¡Œï¼ŒæŒ‡å®šæ§åˆ¶èŠ‚ç‚¹ä¸ºNTPæœåŠ¡å™¨ server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst ä¿®æ”¹ä¸º server controller iburst #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i '3,6d' /etc/chrony.conf && sed -i '3cserver controller iburst' /etc/chrony.conf 3.å¯åŠ¨NTPæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable chronyd && systemctl start chronyd 4.æ£€æŸ¥ç«¯å£ï¼Œç›‘å¬udp323ç«¯å£ $ netstat -nupl|grep chronyd udp 0 0 127.0.0.1:323 0.0.0.0:* 1327/chronyd udp6 0 0 ::1:323 :::* 1327/chronyd 5.éªŒè¯ï¼Œè®¡ç®—èŠ‚ç‚¹æ˜¾ç¤ºçš„æ˜¯æ§åˆ¶èŠ‚ç‚¹ $ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^? controller 3 6 200 50 +1319ms[+1319ms] +/- 14.4s 1.4 ä¸‹è½½openstackå®˜æ–¹yumæºå®‰è£…openstackå®¢æˆ·ç«¯ æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹ç›¸åŒæ“ä½œ yum -y install centos-release-openstack-rocky yum -y install python-openstackclient åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—ã€å­˜å‚¨ã€å¯¹è±¡èŠ‚ç‚¹æ“ä½œå®Œæˆï¼ï¼ï¼ äºŒã€æ§åˆ¶èŠ‚ç‚¹ç¯å¢ƒå®‰è£… 2.1 å®‰è£…mariadbæ•°æ®åº“ 2.1.1 å®‰è£…åŒ… yum -y install mariadb mariadb-server python2-PyMySQL 2.1.2 ç¼–è¾‘é…ç½®æ–‡ä»¶ cat > /etc/my.cnf.d/openstack.cnf 2.1.3 å¯åŠ¨mariadbå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable mariadb && systemctl start mariadb 2.1.4 è¿›è¡Œæ•°æ®åº“å®‰å…¨è®¾ç½® $ mysql_secure_installation Enter current password for root (enter for none): /æ²¡æœ‰å¯†ç ï¼Œç›´æ¥å›è½¦ Set root password? [Y/n] n /ä¸è®¾ç½®rootå¯†ç  Remove anonymous users? [Y/n] y /ç§»é™¤åŒ¿åç”¨æˆ· Disallow root login remotely? [Y/n] y /ç¦æ­¢rootè¿œç¨‹ç™»é™† Remove test database and access to it? [Y/n] y /ç§»é™¤testæ•°æ®åº“ Reload privilege tables now? [Y/n] y /åˆ·æ–°æƒé™è¡¨ 2.3 å®‰è£…æ¶ˆæ¯é˜Ÿåˆ—rabbitmq OpenStack ä½¿ç”¨ message queue åè°ƒæ“ä½œå’Œå„æœåŠ¡çš„çŠ¶æ€ä¿¡æ¯ã€‚æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ä¸€èˆ¬è¿è¡Œåœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Š rabbitmqä¼šå¯åŠ¨2ä¸ªç«¯å£ tcp/5672 rabbitmqæœåŠ¡ç«¯å£ tcp/25672 å¤šä¸ªrabbitmqé€šä¿¡ç”¨åˆ°çš„ç«¯å£ 2.3.1 å®‰è£…åŒ… yum -y install rabbitmq-server 2.3.2 å¯åŠ¨rabbitmqå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ systemctl enable rabbitmq-server && systemctl start rabbitmq-server 2.3.3 æ·»åŠ openstackç”¨æˆ· $ rabbitmqctl add_user openstack RABBIT_PASS Creating user \"openstack\" ... ...done. 2.3.4 ç»™openstackç”¨æˆ·è®¾ç½®è¯»å’Œå†™æƒé™ 3ä¸ª.*åˆ†åˆ«æ˜¯ å¯è¯»ã€å¯å†™ã€å¯é…ç½® $ rabbitmqctl set_permissions openstack \".*\" \".*\" \".*\" Setting permissions for user \"openstack\" in vhost \"/\" ... ...done. 2.3.5 å¯åŠ¨rabbitmqä¸€ä¸ªæ’ä»¶ï¼Œå¯åŠ¨ä¹‹åä¼šç›‘å¬tcp/15672ï¼Œæ˜¯ä¸€ä¸ªwebç®¡ç†ç•Œé¢ï¼Œé»˜è®¤ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯guest $ rabbitmq-plugins enable rabbitmq_management The following plugins have been enabled: mochiweb webmachine rabbitmq_web_dispatch amqp_client rabbitmq_management_agent rabbitmq_management Plugin configuration has changed. Restart RabbitMQ for changes to take effect. 2.4 å®‰è£…memcached è®¤è¯æœåŠ¡è®¤è¯ç¼“å­˜ä½¿ç”¨Memcachedç¼“å­˜ä»¤ç‰Œã€‚ç¼“å­˜æœåŠ¡memecachedè¿è¡Œåœ¨æ§åˆ¶èŠ‚ç‚¹ã€‚åœ¨ç”Ÿäº§éƒ¨ç½²ä¸­ï¼Œæˆ‘ä»¬æ¨èè”åˆå¯ç”¨é˜²ç«å¢™ã€è®¤è¯å’ŒåŠ å¯†ä¿è¯å®ƒçš„å®‰å…¨ã€‚ memcacheç›‘å¬ tcp/udp 11211ç«¯å£ 2.4.1 å®‰è£…åŒ… yum -y install memcached python-memcached 2.4.2 ä¿®æ”¹é…ç½®æ–‡ä»¶ é…ç½®æœåŠ¡ä»¥ä½¿ç”¨æ§åˆ¶å™¨èŠ‚ç‚¹çš„ç®¡ç†IPåœ°å€ã€‚è¿™æ˜¯ä¸ºäº†å…è®¸å…¶ä»–èŠ‚ç‚¹é€šè¿‡ç®¡ç†ç½‘ç»œè¿›è¡Œè®¿é—®ï¼š sed -i.bak '/OPTIONS/c OPTIONS=\"-l 127.0.0.1,::1,controller\"' /etc/sysconfig/memcached #ä¿®æ”¹å®Œçš„é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ cat /etc/sysconfig/memcached PORT=\"11211\" USER=\"memcached\" MAXCONN=\"1024\" CACHESIZE=\"64\" OPTIONS=\"-l 127.0.0.1,::1,controller\" 2.4.3 å¯åŠ¨memcachedå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ systemctl enable memcached && systemctl start memcached 2.5 å®‰è£…etcd OpenStackæœåŠ¡å¯ä»¥ä½¿ç”¨Etcdï¼ˆåˆ†å¸ƒå¼å¯é é”®å€¼å­˜å‚¨ï¼‰æ¥è¿›è¡Œåˆ†å¸ƒå¼é”®é”å®šï¼Œå­˜å‚¨é…ç½®ï¼Œè·Ÿè¸ªæœåŠ¡æ´»åŠ¨æ€§å’Œå…¶ä»–æƒ…å†µã€‚ etcdæœåŠ¡åœ¨æ§åˆ¶å™¨èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ etcdæœåŠ¡å¯åŠ¨åæä¾›ç»™å¤–éƒ¨å®¢æˆ·ç«¯é€šä¿¡çš„ç«¯å£æ˜¯2379ï¼Œè€ŒetcdæœåŠ¡ä¸­æˆå‘˜é—´çš„é€šä¿¡ç«¯å£æ˜¯2380 2.5.1 å®‰è£…åŒ… yum -y install etcd 2.5.2 ç¼–è¾‘é…ç½®æ–‡ä»¶ ç¼–è¾‘/etc/etcd/etcd.confæ–‡ä»¶ï¼Œå¹¶è®¾ç½®ETCD_INITIAL_CLUSTERï¼Œ ETCD_INITIAL_ADVERTISE_PEER_URLSï¼ŒETCD_ADVERTISE_CLIENT_URLSï¼Œ ETCD_LISTEN_CLIENT_URLSæ§åˆ¶å™¨èŠ‚ç‚¹ï¼Œä»¥ä½¿ç»ç”±ç®¡ç†ç½‘ç»œé€šè¿‡å…¶ä»–èŠ‚ç‚¹çš„è®¿é—®çš„ç®¡ç†IPåœ°å€ï¼š cat > /etc/etcd/etcd.conf 2.5.3 å¯åŠ¨etcdå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable etcd && systemctl restart etcd åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹ç¯å¢ƒå®‰è£…å®Œæˆï¼ï¼ï¼ rockyç‰ˆè®¤è¯æœåŠ¡keystoneå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ ä¸‰ã€æ§åˆ¶èŠ‚ç‚¹è®¤è¯æœåŠ¡keystoneå®‰è£… keystoneè®¤è¯æœåŠ¡åŠŸèƒ½ï¼šè®¤è¯ç®¡ç†ã€æˆæƒç®¡ç†ã€æœåŠ¡ç›®å½• è®¤è¯ï¼šç”¨æˆ·åå’Œå¯†ç  æˆæƒï¼šæˆæƒç®¡ç†ï¼Œä¾‹å¦‚ä¸€äº›æŠ€æœ¯ç½‘ç«™(æ˜é‡‘ã€csdn)å¯ä»¥æˆæƒå¾®ä¿¡ã€QQç™»é™† æœåŠ¡ç›®å½•ï¼šç›¸å½“äºé€šè®¯å½•ï¼Œå³è¦è®¿é—®openstackçš„é•œåƒã€ç½‘ç»œã€å­˜å‚¨ç­‰æœåŠ¡ï¼Œåªéœ€è¦æ‰¾åˆ°keystoneå³å¯ï¼Œè€Œä¸éœ€è¦å†å•ç‹¬è®°ä½å„ä¸ªæœåŠ¡çš„è®¿é—®åœ°å€ åç»­æ¯å®‰è£…ä¸€ä¸ªæœåŠ¡éƒ½éœ€è¦åœ¨keystoneä¸Šæ³¨å†Œ 3.1 åˆ›å»ºkeystoneæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤æ“ä½œ mysql -e \"CREATE DATABASE keystone;\" mysql -e \"GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \\ IDENTIFIED BY 'KEYSTONE_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \\ IDENTIFIED BY 'KEYSTONE_DBPASS';\" 3.2 å®‰è£…å’Œé…ç½®keystron keystoneå€ŸåŠ©apacheè®¿é—® mod_wsgiæ˜¯å¸®åŠ©apacheè¿æ¥pythonç¨‹åº ç›‘å¬ç«¯å£ 5000 3.2.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-keystone httpd mod_wsgi openstack-utils.noarch 3.2.2 ç¼–è¾‘æ–‡ä»¶/etc/keystone/keystone.conf å¹¶å®Œæˆå¦‚ä¸‹æ“ä½œ åœ¨ [database] éƒ¨åˆ†ï¼Œé…ç½®æ•°æ®åº“è®¿é—®ï¼š [root@controller ~]# vim /etc/keystone/keystone.conf [database] connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone åœ¨[token]éƒ¨åˆ†ï¼Œé…ç½®Fernet UUIDä»¤ç‰Œçš„æä¾›è€… [token] provider = fernet #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/keystone/keystone.conf{,.bak} grep -Ev '^$|#' /etc/keystone/keystone.conf.bak >/etc/keystone/keystone.conf openstack-config --set /etc/keystone/keystone.conf database connection mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone openstack-config --set /etc/keystone/keystone.conf token provider fernet MD5å€¼ md5sum /etc/keystone/keystone.conf 3fb8c44724c573eb69394a876cf7da56 /etc/keystone/keystone.conf 3.2.3 åˆå§‹åŒ–èº«ä»½è®¤è¯æœåŠ¡çš„æ•°æ®åº“ å‘½ä»¤çš„å«ä¹‰æ˜¯åˆ‡æ¢åˆ°keystoneç”¨æˆ·ï¼Œä½¿ç”¨çš„shellæ˜¯/bin/shï¼Œæ‰§è¡Œ -cåçš„å‘½ä»¤ su -s /bin/sh -c \"keystone-manage db_sync\" keystone #ä¸Šä¸€æ­¥æ“ä½œä¸ºå¯¼å…¥è¡¨ï¼Œä»¥ä¸‹å‘½ä»¤æ‰§è¡Œè¿”å›æœ‰è¡¨å³ä¸ºæ­£ç¡® mysql keystone -e \"show tables;\"|wc -l 45 3.2.4 åˆå§‹åŒ–Fernet key keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone keystone-manage credential_setup --keystone-user keystone --keystone-group keystone 3.2.5 å¼•å¯¼èº«ä»½æœåŠ¡ keystone-manage bootstrap --bootstrap-password ADMIN_PASS \\ --bootstrap-admin-url http://controller:5000/v3/ \\ --bootstrap-internal-url http://controller:5000/v3/ \\ --bootstrap-public-url http://controller:5000/v3/ \\ --bootstrap-region-id RegionOne 3.2.6 é…ç½®ApacheæœåŠ¡å™¨ ç¼–è¾‘/etc/httpd/conf/httpd.confæ–‡ä»¶ï¼Œé…ç½®ServerName é€‰é¡¹ä¸ºæ§åˆ¶èŠ‚ç‚¹ 1.96è¡Œä¸‹å…¥ä»¥ä¸‹ä¸€è¡Œ ServerName controller #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i.bak '96cServerName controller' /etc/httpd/conf/httpd.conf MD5å€¼ md5sum /etc/httpd/conf/httpd.conf eaf0e2ae3fea84bac3e5a842f64bdfdb /etc/httpd/conf/httpd.conf 2.åˆ›å»ºä¸€ä¸ªè½¯è¿æ¥ ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/ 3.2.7 å¯åŠ¨apacheå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ systemctl enable httpd && systemctl start httpd 3.2.8 é…ç½®ç®¡ç†è´¦æˆ· ä»¥ä¸‹ä¸ºåˆ›å»ºç®¡ç†å‘˜è´¦æˆ·adminï¼Œå¯†ç ä¸ºADMIN_PASS export OS_USERNAME=admin export OS_PASSWORD=ADMIN_PASS export OS_PROJECT_NAME=admin export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_DOMAIN_NAME=Default export OS_AUTH_URL=http://controller:5000/v3 export OS_IDENTITY_API_VERSION=3 3.3 åˆ›å»ºåŸŸã€é¡¹ç›®ã€ç”¨æˆ·å’Œè§’è‰² 3.3.1 åˆ›å»ºä¸€ä¸ªåŸŸ openstack domain create --description \"An Example Domain\" example +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | An Example Domain | | enabled | True | | id | ab6f853144384043a5dd648c154d0efe | | name | example | | tags | [] | +-------------+----------------------------------+ 3.3.2 åˆ›å»ºä¸€ä¸ªæœåŠ¡é¡¹ç›® #serviceï¼ŒåæœŸç”¨äºå…³è”openstackç³»ç»Ÿç”¨æˆ·glanceã€novaã€neutron openstack project create --domain default \\ --description \"Service Project\" service +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Service Project | | domain_id | default | | enabled | True | | id | f6696bc9511043ae9ec72d1c31a494f3 | | is_domain | False | | name | service | | parent_id | default | | tags | [] | +-------------+----------------------------------+ 3.3.3 å¸¸è§„ï¼ˆéç®¡ç†å‘˜ï¼‰ä»»åŠ¡åº”ä½¿ç”¨æ— ç‰¹æƒçš„é¡¹ç›®å’Œç”¨æˆ· ä¾‹å¦‚ï¼Œæœ¬æŒ‡å—åˆ›å»ºmyprojecté¡¹ç›®å’Œmyuser ç”¨æˆ· 1.åˆ›å»ºmyprojecté¡¹ç›® openstack project create --domain default \\ --description \"Demo Project\" myproject +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Demo Project | | domain_id | default | | enabled | True | | id | 5b9ccd294c364cc68747df85f9598c89 | | is_domain | False | | name | myproject | | parent_id | default | | tags | [] | +-------------+----------------------------------+ 2.åˆ›å»ºmyuserç”¨æˆ· //è¿™é‡Œäº¤äº’å¼å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default \\ --password MYUSER_PASS myuser +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | f7985ae93ad24f7784a5ea3e1f22109a | | name | myuser | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ #äº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default \\ --password-prompt myuser 3.åˆ›å»ºmyroleè§’è‰² openstack role create myrole +-----------+----------------------------------+ | Field | Value | +-----------+----------------------------------+ | domain_id | None | | id | 9cb289f07a6d4bd6898dd863d616b164 | | name | myrole | +-----------+----------------------------------+ 4.å°†myroleè§’è‰²æ·»åŠ åˆ°myprojecté¡¹ç›®å’Œmyuserç”¨æˆ· openstack role add --project myproject --user myuser myrole 3.3.4 éªŒè¯ 1.å–æ¶ˆè®¾ç½®ä¸´æ—¶ å˜é‡OS_AUTH_URLå’ŒOS_PASSWORDç¯å¢ƒå˜é‡ unset OS_AUTH_URL OS_PASSWORD 2.ä»¥adminç”¨æˆ·èº«ä»½è¯·æ±‚èº«ä»½éªŒè¯ä»¤ç‰Œ å¯†ç æ˜¯ADMIN_PASS openstack --os-auth-url http://controller:5000/v3 \\ --os-project-domain-name Default --os-user-domain-name Default \\ --os-project-name admin --os-username admin token issue Password: +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Field | Value | +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | expires | 2020-05-25T09:12:07+0000 | | id | gAAAAABey33Xe4qJjpsA6SSva-ciwawHI6MKrQSn8aP2t1Ja1FOLpBgo31TILIK0hOiC8aP7ql2MrDq6lO-OwwRn91DJGT0KIhfueV-mrEm1zXJfn8a_yL9c01QGi4E5qr6kPatZdsKIN1Q0McDvg5VaCf1S5cj7uB1amz0am2si8YIIpnkYiyU | | project_id | 108d3fecb61840e3818f694c69c3ec4a | | user_id | a0d3db84d1984a24ac6ba213525fe382 | +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ 3.ä½œä¸ºmyuserä¸Šä¸€èŠ‚ä¸­åˆ›å»ºçš„ç”¨æˆ·ï¼Œè¯·è¯·æ±‚è®¤è¯ä»¤ç‰Œ å¯†ç æ˜¯MYUSER_PASS openstack --os-auth-url http://controller:5000/v3 \\ --os-project-domain-name Default --os-user-domain-name Default \\ --os-project-name myproject --os-username myuser token issue +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Field | Value | +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | expires | 2020-05-25T09:15:01+0000 | | id | gAAAAABey36FhKplKdFCDOIszVcq_eGC-W3Eel33l7wS9-dGfEn4G9F19k9fAClAjiZ9hmQ8BdlglHPDDfxqq8uZkDIdlQK8DctC9kipXLfxuRI9J0lB9MTrsfEMiIMRW9J6DFvAQiVUPEuTmL7vRLyRNH7ORHEgS9ly043SNFzMW-ZZQHSiFUI | | project_id | 5b9ccd294c364cc68747df85f9598c89 | | user_id | be0d4d9c8c56450ea9fcc5c85f3b232b | +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ 3.4 åˆ›å»ºOpenStackå®¢æˆ·ç«¯ç¯å¢ƒè„šæœ¬ 3.4.1 åˆ›å»ºè„šæœ¬ åˆ›å»ºå’Œç¼–è¾‘admin-openrcæ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œè¿™é‡Œæ”¾åœ¨/optä¸‹ cat >/opt/admin-openrc åˆ›å»ºå’Œç¼–è¾‘demo-openrcæ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ cat >/opt/demo-openrc 3.4.2 ä½¿ç”¨è„šæœ¬ 1.åŠ è½½admin-openrcæ–‡ä»¶ä»¥ä½¿ç”¨èº«ä»½æœåŠ¡çš„ä½ç½®ä»¥åŠadminé¡¹ç›®å’Œç”¨æˆ·å‡­æ®å¡«å……ç¯å¢ƒå˜é‡ source /opt/admin-openrc 2.è¯·æ±‚èº«ä»½éªŒè¯ä»¤ç‰Œï¼ˆæ³¨æ„expiresä¸­æ˜¯UTCæ—¶é—´ï¼Œè½åä¸­å›½8ä¸ªå°æ—¶ï¼Œæˆ‘å›½æ˜¯ä¸œå…«åŒºï¼Œä½¿ç”¨timedatectlæŸ¥çœ‹æ—¶é—´åŠæ—¶åŒºï¼Œé»˜è®¤è¿‡æœŸæ—¶é—´1å°æ—¶ï¼‰ openstack token issue +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Field | Value | +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | expires | 2020-05-25T09:22:49+0000 | | id | gAAAAABey4BZ8Fmp0STtrCrdAMyjJ0lXWDavMSRTBHFmJ6aS5cYMhpMhE4wtJlm3dhUFGeCW7_g7BIu5o0f4z0KlmPi6IAya_eOC96ofqFPeYIDJL2O0qlSgzcALavYt6ZqP0thedY_69q-XMd4X9SC9UcptM4Hnn4RO9rWb9c0wymhsrKdXb7g | | project_id | 108d3fecb61840e3818f694c69c3ec4a | | user_id | a0d3db84d1984a24ac6ba213525fe382 | +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹è®¤è¯æœåŠ¡keystoneå®‰è£…å®Œæˆï¼ï¼ï¼ å››ã€æ§åˆ¶èŠ‚ç‚¹é•œåƒæœåŠ¡glanceå®‰è£… rockyç‰ˆé•œåƒæœåŠ¡glanceå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ OpenStacké•œåƒæœåŠ¡åŒ…æ‹¬ä»¥ä¸‹ç»„ä»¶ï¼š glance-api æ¥æ”¶é•œåƒAPIçš„è°ƒç”¨ï¼Œè¯¸å¦‚é•œåƒå‘ç°ã€æ¢å¤ã€å­˜å‚¨ glance-registry å­˜å‚¨ã€å¤„ç†å’Œæ¢å¤é•œåƒçš„å…ƒæ•°æ®(å±æ€§)ï¼Œå…ƒæ•°æ®åŒ…æ‹¬é¡¹è¯¸å¦‚å¤§å°å’Œç±»å‹ glanceæœåŠ¡ç›‘å¬ä¸¤ä¸ªç«¯å£ glance-api 9292 glance-registry 9191 4.1 åˆ›å»ºglanceæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ mysql -e \"CREATE DATABASE glance;\" mysql -e \"GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' \\ IDENTIFIED BY 'GLANCE_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \\ IDENTIFIED BY 'GLANCE_DBPASS';\" 4.2 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—® source /opt/admin-openrc 4.3 åˆ›å»ºæœåŠ¡å‡­æ® 4.3.1 åˆ›å»ºglanceç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸ºGLANCE_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default --password GLANCE_PASS glance +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | ed462c214a1d4cb485cc4dc5211c4dd4 | | name | glance | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ #äº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default --password-prompt glance 4.3.2 å°†adminè§’è‰²æ·»åŠ åˆ°glanceç”¨æˆ·å’Œ serviceé¡¹ç›® openstack role add --project service --user glance admin 4.3.3 åˆ›å»ºglanceæœåŠ¡å®ä½“ openstack service create --name glance \\ --description \"OpenStack Image\" image +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Image | | enabled | True | | id | ce5a424428d640c9adec06865d211916 | | name | glance | | type | image | +-------------+----------------------------------+ 4.3.4 åˆ›å»ºImageæœåŠ¡APIç«¯ç‚¹ openstack endpoint create --region RegionOne \\ image public http://controller:9292 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | bed29b8924114eee8b427f7a83f2cd64 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | ce5a424428d640c9adec06865d211916 | | service_name | glance | | service_type | image | | url | http://controller:9292 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ image internal http://controller:9292 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 94f84d946e6f4463af82041caf2877b5 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | ce5a424428d640c9adec06865d211916 | | service_name | glance | | service_type | image | | url | http://controller:9292 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ image admin http://controller:9292 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 16e947838d7948e6a0ec7feb7910b415 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | ce5a424428d640c9adec06865d211916 | | service_name | glance | | service_type | image | | url | http://controller:9292 | +--------------+----------------------------------+ åˆ é™¤APIç«¯ç‚¹ä½¿ç”¨å‘½ä»¤openstack endpoint delete ä½¿ç”¨å‘½ä»¤openstack endpoint listæŸ¥çœ‹endpoint-idç„¶åæ ¹æ®idåˆ é™¤ 4.4 å®‰è£…å’Œé…ç½®ç»„ä»¶ 4.4.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-glance 4.4.2 ç¼–è¾‘/etc/glance/glance-api.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨è¯¥[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—® [database] # ... connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance 2.åœ¨[keystone_authtoken]å’Œ[paste_deploy]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—® [keystone_authtoken] # ... www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = glance password = GLANCE_PASS [paste_deploy] # ... flavor = keystone 3.åœ¨è¯¥[glance_store]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨å’Œå›¾åƒæ–‡ä»¶çš„ä½ç½® [glance_store] # ... stores = file,http default_store = file filesystem_store_datadir = /var/lib/glance/images/ #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/glance/glance-api.conf{,.bak} grep '^[a-Z\\[]' /etc/glance/glance-api.conf.bak >/etc/glance/glance-api.conf openstack-config --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance openstack-config --set /etc/glance/glance-api.conf keystone_authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://controller:5000 openstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_type password openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name Default openstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name Default openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service openstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance openstack-config --set /etc/glance/glance-api.conf keystone_authtoken password GLANCE_PASS openstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone openstack-config --set /etc/glance/glance-api.conf glance_store stores file,http openstack-config --set /etc/glance/glance-api.conf glance_store default_store file openstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/ MD5å€¼ md5sum /etc/glance/glance-api.conf 53b17f4f4eeb358fbf0bac47a7eed6a6 /etc/glance/glance-api.conf 4.4.3 ç¼–è¾‘/etc/glance/glance-registry.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨è¯¥[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—® [database] # ... connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance 2.åœ¨[keystone_authtoken]å’Œ[paste_deploy]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—® [keystone_authtoken] # ... www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = glance password = GLANCE_PASS [paste_deploy] # ... flavor = keystone #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/glance/glance-registry.conf{,.bak} grep '^[a-Z\\[]' /etc/glance/glance-registry.conf.bak > /etc/glance/glance-registry.conf openstack-config --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://controller:5000 openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name Default openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name Default openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_name service openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken username glance openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken password GLANCE_PASS openstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone MD5å€¼ md5sum /etc/glance/glance-registry.conf 888d847475b8c7f6e2c790fed853fb61 /etc/glance/glance-registry.conf 4.4.4 åŒæ­¥æ•°æ®åº“ æ³¨æ„ï¼šå¿½ç•¥æ­¤è¾“å‡ºä¸­çš„ä»»ä½•å¼ƒç”¨æ¶ˆæ¯ $ su -s /bin/sh -c \"glance-manage db_sync\" glance /usr/lib/python2.7/site-packages/oslo_db/sqlalchemy/enginefacade.py:1352: OsloDBDeprecationWarning: EngineFacade is deprecated; please use oslo_db.sqlalchemy.enginefacade expire_on_commit=expire_on_commit, _conf=conf) INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Running upgrade -> liberty, liberty initial INFO [alembic.runtime.migration] Running upgrade liberty -> mitaka01, add index on created_at and updated_at columns of 'images' table INFO [alembic.runtime.migration] Running upgrade mitaka01 -> mitaka02, update metadef os_nova_server INFO [alembic.runtime.migration] Running upgrade mitaka02 -> ocata_expand01, add visibility to images INFO [alembic.runtime.migration] Running upgrade ocata_expand01 -> pike_expand01, empty expand for symmetry with pike_contract01 INFO [alembic.runtime.migration] Running upgrade pike_expand01 -> queens_expand01 INFO [alembic.runtime.migration] Running upgrade queens_expand01 -> rocky_expand01, add os_hidden column to images table INFO [alembic.runtime.migration] Running upgrade rocky_expand01 -> rocky_expand02, add os_hash_algo and os_hash_value columns to images table INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Upgraded database to: rocky_expand02, current revision(s): rocky_expand02 INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Database migration is up to date. No migration needed. INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. INFO [alembic.runtime.migration] Running upgrade mitaka02 -> ocata_contract01, remove is_public from images INFO [alembic.runtime.migration] Running upgrade ocata_contract01 -> pike_contract01, drop glare artifacts tables INFO [alembic.runtime.migration] Running upgrade pike_contract01 -> queens_contract01 INFO [alembic.runtime.migration] Running upgrade queens_contract01 -> rocky_contract01 INFO [alembic.runtime.migration] Running upgrade rocky_contract01 -> rocky_contract02 INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Upgraded database to: rocky_contract02, current revision(s): rocky_contract02 INFO [alembic.runtime.migration] Context impl MySQLImpl. INFO [alembic.runtime.migration] Will assume non-transactional DDL. Database is synced successfully. #æœ‰è¡¨å³ä¸ºæ­£ç¡® mysql glance -e \"show tables;\" | wc -l 16 4.4.5 å¯åŠ¨glanceæœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ï¼ˆglance-apiå’Œglance-registryï¼‰ systemctl enable openstack-glance-api openstack-glance-registry systemctl start openstack-glance-api openstack-glance-registry 4.4.6 éªŒè¯æ“ä½œ 1.è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 2.ä¸‹è½½æºé•œåƒ wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img 3.ä½¿ç”¨QCOW2ç£ç›˜æ ¼å¼ï¼Œè£¸å®¹å™¨æ ¼å¼å’Œå…¬å…±å¯è§æ€§å°†æ˜ åƒä¸Šè½½åˆ°æ˜ åƒæœåŠ¡ ï¼Œä»¥ä¾¿æ‰€æœ‰é¡¹ç›®éƒ½å¯ä»¥è®¿é—®å®ƒ æ³¨æ„ï¼šè¿™ä¸€æ­¥ä¸€å®šè¦çœ‹æ‰§è¡Œåè¾“å‡ºç»“æœä¸­sizeå¤§å°ï¼Œå¦‚æœä¸º0åˆ™è¯´æ˜é•œåƒä¸Šè½½æœ‰é—®é¢˜ openstack image create \"cirros\" \\ --file cirros-0.4.0-x86_64-disk.img \\ --disk-format qcow2 --container-format bare \\ --public +------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Field | Value | +------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | checksum | 443b7623e27ecf03dc9e01ee93f67afe | | container_format | bare | | created_at | 2020-05-25T10:49:34Z | | disk_format | qcow2 | | file | /v2/images/94c96aab-d0b3-4340-835c-9a97108d0554/file | | id | 94c96aab-d0b3-4340-835c-9a97108d0554 | | min_disk | 0 | | min_ram | 0 | | name | cirros | | owner | 108d3fecb61840e3818f694c69c3ec4a | | properties | os_hash_algo='sha512', os_hash_value='6513f21e44aa3da349f248188a44bc304a3653a04122d8fb4535423c8e1d14cd6a153f735bb0982e2161b5b5186106570c17a9e58b64dd39390617cd5a350f78', os_hidden='False' | | protected | False | | schema | /v2/schemas/image | | size | 12716032 | | status | active | | tags | | | updated_at | 2020-05-25T10:49:34Z | | virtual_size | None | | visibility | public | +------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ åˆ é™¤é•œåƒä½¿ç”¨å‘½ä»¤glance image-delete é•œåƒid 4.4.7 ç¡®è®¤ä¸Šä¼ å›¾åƒå¹¶éªŒè¯å±æ€§ openstack image list +--------------------------------------+--------+--------+ | ID | Name | Status | +--------------------------------------+--------+--------+ | 94c96aab-d0b3-4340-835c-9a97108d0554 | cirros | active | +--------------------------------------+--------+--------+ åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹é•œåƒæœåŠ¡glanceå®‰è£…å®Œæˆï¼ï¼ï¼ äº”ã€æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹è®¡ç®—æœåŠ¡novaå®‰è£… novaç›¸å…³æœåŠ¡ æœåŠ¡åç§° ä½œç”¨ nova-api æ¥å—å¹¶å“åº”æœ€ç»ˆç”¨æˆ·çš„è®¡ç®—APIè°ƒç”¨ã€‚è¯¥æœåŠ¡æ”¯æŒOpenStack Compute APIã€‚å®ƒæ‰§è¡Œä¸€äº›ç­–ç•¥å¹¶å¯åŠ¨å¤§å¤šæ•°ç¼–æ’æ´»åŠ¨ï¼Œä¾‹å¦‚è¿è¡Œå®ä¾‹ nova-api-metadata æ¥å—æ¥è‡ªå®ä¾‹çš„å…ƒæ•°æ®è¯·æ±‚ã€‚nova-api-metadataå½“æ‚¨åœ¨nova-network å®‰è£…æ—¶ä»¥å¤šä¸»æœºæ¨¡å¼è¿è¡Œæ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨è¯¥æœåŠ¡ nova-compute é€šè¿‡å®ˆæŠ¤ç¨‹åºAPIåˆ›å»ºå’Œç»ˆæ­¢è™šæ‹Ÿæœºå®ä¾‹çš„è¾…åŠ©ç¨‹åºå®ˆæŠ¤ç¨‹åº nova-placement-api è·Ÿè¸ªæ¯ä¸ªæä¾›å•†çš„åº“å­˜å’Œä½¿ç”¨æƒ…å†µ nova-scheduler ä»é˜Ÿåˆ—ä¸­è·å–è™šæ‹Ÿæœºå®ä¾‹è¯·æ±‚ï¼Œå¹¶ç¡®å®šå®ƒåœ¨å“ªå°è®¡ç®—æœåŠ¡å™¨ä¸»æœºä¸Šè¿è¡Œ nova-conductor è°ƒè§£novaè®¡ç®—æœåŠ¡å’Œæ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚å®ƒæ¶ˆé™¤äº†novaè®¡ç®—æœåŠ¡å¯¹äº‘æ•°æ®åº“çš„ç›´æ¥è®¿é—®ã€‚novaå¯¼ä½“æ¨¡å—æ°´å¹³ä¼¸ç¼©ã€‚ä½†æ˜¯ï¼Œä¸è¦åœ¨novaè®¡ç®—æœåŠ¡è¿è¡Œçš„èŠ‚ç‚¹ä¸Šéƒ¨ç½²å®ƒ nova-consoleauth ä¸ºæ§åˆ¶å°ä»£ç†æä¾›çš„ç”¨æˆ·æˆæƒä»¤ç‰Œã€‚è¯·å‚é˜… nova-novncproxyå’Œnova-xvpvncproxyã€‚è¯¥æœåŠ¡å¿…é¡»æ­£åœ¨è¿è¡Œï¼Œæ§åˆ¶å°ä»£ç†æ‰èƒ½èµ·ä½œç”¨ã€‚æ‚¨å¯ä»¥åœ¨é›†ç¾¤é…ç½®ä¸­é’ˆå¯¹å•ä¸ªnova-consoleauthæœåŠ¡è¿è¡Œè¿™ä¸¤ç§ç±»å‹çš„ä»£ç† rockyç‰ˆä¸æ¨èä½¿ç”¨ï¼Œå¹¶ä¸”ä»¥åä¼šåˆ é™¤ nova-novncproxy æä¾›ç”¨äºé€šè¿‡VNCè¿æ¥è®¿é—®æ­£åœ¨è¿è¡Œçš„å®ä¾‹çš„ä»£ç†ã€‚æ”¯æŒåŸºäºæµè§ˆå™¨çš„novncå®¢æˆ·ç«¯ã€‚ nova-spicehtml5proxy æä¾›ç”¨äºé€šè¿‡SPICEè¿æ¥è®¿é—®æ­£åœ¨è¿è¡Œçš„å®ä¾‹çš„ä»£ç†ã€‚æ”¯æŒåŸºäºæµè§ˆå™¨çš„HTML5å®¢æˆ·ç«¯ã€‚ nova-xvpvncproxy æä¾›ç”¨äºé€šè¿‡VNCè¿æ¥è®¿é—®æ­£åœ¨è¿è¡Œçš„å®ä¾‹çš„ä»£ç†ã€‚æ”¯æŒç‰¹å®šäºOpenStackçš„Javaå®¢æˆ·ç«¯ã€‚ å®‰è£…å’Œé…ç½®æ§åˆ¶èŠ‚ç‚¹ rockyç‰ˆæ§åˆ¶èŠ‚ç‚¹è®¡ç®—æœåŠ¡novaå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ 5.1 åˆ›å»ºnovaã€nova_apiã€nova_cell0ã€placementæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤ mysql -e \"CREATE DATABASE nova_api;\" mysql -e \"CREATE DATABASE nova;\" mysql -e \"CREATE DATABASE nova_cell0;\" mysql -e \"CREATE DATABASE placement;\" mysql -e \"GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'localhost' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'%' \\ IDENTIFIED BY 'NOVA_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON placement.* TO 'placement'@'localhost' \\ IDENTIFIED BY 'PLACEMENT_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON placement.* TO 'placement'@'%' \\ IDENTIFIED BY 'PLACEMENT_DBPASS';\" 5.2 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 5.3 åˆ›å»ºè®¡ç®—æœåŠ¡å‡­æ® 5.3.1 åˆ›å»ºnovaç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸ºNOVA_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default \\ --password NOVA_PASS nova +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | ebe9b1934a2e4c8ca9c177af647851b1 | | name | nova | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ #äº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default --password-prompt nova 5.3.2 å°†adminè§’è‰²æ·»åŠ åˆ°novaç”¨æˆ· openstack role add --project service --user nova admin 5.3.3 åˆ›å»ºnovaæœåŠ¡å®ä½“ openstack service create --name nova \\ --description \"OpenStack Compute\" compute +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Compute | | enabled | True | | id | 412f485718f44759b6c3cd46b1d624e6 | | name | nova | | type | compute | +-------------+----------------------------------+ 5.3.4 åˆ›å»ºCompute APIæœåŠ¡ç«¯ç‚¹ openstack endpoint create --region RegionOne \\ compute public http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | cc0a7c21acd0450998760841dd9a11c0 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 412f485718f44759b6c3cd46b1d624e6 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ compute internal http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 69acbdd4f0114a339f8b62d9118ce137 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 412f485718f44759b6c3cd46b1d624e6 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ compute admin http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 5382d617406a4dba8280dc375dd53329 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 412f485718f44759b6c3cd46b1d624e6 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ 5.3.5 åˆ›å»ºå±•ç¤ºä½ç½®æœåŠ¡ç”¨æˆ·PLACEMENTï¼Œå¯†ç è®¾ç½®ä¸ºPLACEMENT_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default --password PLACEMENT_PASS placement +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | 5ab24083149e4adf978c43439b87c982 | | name | placement | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ #äº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default --password-prompt placement 5.3.6 ä½¿ç”¨ç®¡ç†å‘˜è§’è‰²å°†Placementç”¨æˆ·æ·»åŠ åˆ°æœåŠ¡é¡¹ç›®ä¸­ openstack role add --project service --user placement admin 5.3.7 åœ¨æœåŠ¡ç›®å½•ä¸­åˆ›å»ºPlacement APIæ¡ç›® openstack service create --name placement \\ --description \"Placement API\" placement +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Placement API | | enabled | True | | id | 274104c9a16f4b728bd7f484d3c54d3e | | name | placement | | type | placement | +-------------+----------------------------------+ 5.3.8 åˆ›å»ºPlacement APIæœåŠ¡ç«¯ç‚¹ openstack endpoint create --region RegionOne \\ placement public http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | c3afd275f71a4406a701d16ad24aa325 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 274104c9a16f4b728bd7f484d3c54d3e | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ placement internal http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 2ddc86a3b46d45489ebbedbd54fc3c0c | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 274104c9a16f4b728bd7f484d3c54d3e | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ placement admin http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | d0714a417aa44c0180d59be843e1d40d | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 274104c9a16f4b728bd7f484d3c54d3e | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ 5.4 å®‰è£…å’Œé…ç½®ç»„ä»¶ 5.4.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-nova-api openstack-nova-conductor \\ openstack-nova-console openstack-nova-novncproxy \\ openstack-nova-scheduler openstack-nova-placement-api 5.4.2 ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æ­¤[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œä»…å¯ç”¨è®¡ç®—å’Œå…ƒæ•°æ®API [DEFAULT] # ... enabled_apis = osapi_compute,metadata 2.åœ¨[api_database]ï¼Œ[database]å’Œ[placement_database] éƒ¨åˆ†ï¼Œé…ç½®æ•°æ®åº“è®¿é—® [api_database] # ... connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api [database] # ... connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova [placement_database] # ... connection = mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement 3.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è®¿é—® [DEFAULT] # ... transport_url = rabbit://openstack:RABBIT_PASS@controller 4.åœ¨[api]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—® [api] # ... auth_strategy = keystone [keystone_authtoken] # ... auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = nova password = NOVA_PASS 5.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®my_ipé€‰é¡¹ä»¥ä½¿ç”¨æ§åˆ¶å™¨èŠ‚ç‚¹çš„ç®¡ç†æ¥å£IPåœ°å€ [DEFAULT] # ... my_ip = 10.0.0.11 6.åœ¨æœ¬[DEFAULT]èŠ‚ä¸­ï¼Œå¯ç”¨å¯¹ç½‘ç»œæœåŠ¡çš„æ”¯æŒ [DEFAULT] # ... use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver é»˜è®¤æƒ…å†µä¸‹ï¼ŒComputeä½¿ç”¨å†…éƒ¨é˜²ç«å¢™é©±åŠ¨ç¨‹åºã€‚ç”±äºç½‘ç»œæœåŠ¡åŒ…å«é˜²ç«å¢™é©±åŠ¨ç¨‹åºï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨nova.virt.firewall.NoopFirewallDriveré˜²ç«å¢™é©±åŠ¨ç¨‹åºç¦ç”¨è®¡ç®—é˜²ç«å¢™é©±åŠ¨ ç¨‹åº 7.åœ¨è¯¥[vnc]éƒ¨åˆ†ä¸­ï¼Œå°†VNCä»£ç†é…ç½®ä¸ºä½¿ç”¨æ§åˆ¶å™¨èŠ‚ç‚¹çš„ç®¡ç†æ¥å£IPåœ°å€ [vnc] enabled = true # ... server_listen = $my_ip server_proxyclient_address = $my_ip 8.åœ¨è¯¥[glance]éƒ¨åˆ†ä¸­ï¼Œé…ç½®å›¾åƒæœåŠ¡APIçš„ä½ç½® [glance] # ... api_servers = http://controller:9292 9.åœ¨è¯¥[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ [oslo_concurrency] # ... lock_path = /var/lib/nova/tmp 10.åœ¨è¯¥[placement]éƒ¨åˆ†ä¸­ï¼Œé…ç½®Placement API [placement] # ... region_name = RegionOne project_domain_name = Default project_name = service auth_type = password user_domain_name = Default auth_url = http://controller:5000/v3 username = placement password = PLACEMENT_PASS #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/nova/nova.conf{,.bak} grep '^[a-Z\\[]' /etc/nova/nova.conf.bak >/etc/nova/nova.conf openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata openstack-config --set /etc/nova/nova.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.11 openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron true openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver openstack-config --set /etc/nova/nova.conf api_database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api openstack-config --set /etc/nova/nova.conf database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova openstack-config --set /etc/nova/nova.conf placement_database connection mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement openstack-config --set /etc/nova/nova.conf api auth_strategy keystone openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:5000/v3 openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name Default openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name Default openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS openstack-config --set /etc/nova/nova.conf vnc enabled true openstack-config --set /etc/nova/nova.conf vnc server_listen '$my_ip' openstack-config --set /etc/nova/nova.conf vnc server_proxyclient_address '$my_ip' openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292 openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp openstack-config --set /etc/nova/nova.conf placement region_name RegionOne openstack-config --set /etc/nova/nova.conf placement project_domain_name Default openstack-config --set /etc/nova/nova.conf placement project_name service openstack-config --set /etc/nova/nova.conf placement auth_type password openstack-config --set /etc/nova/nova.conf placement user_domain_name Default openstack-config --set /etc/nova/nova.conf placement auth_url http://controller:5000/v3 openstack-config --set /etc/nova/nova.conf placement username placement openstack-config --set /etc/nova/nova.conf placement password PLACEMENT_PASS MD5å€¼ md5sum /etc/nova/nova.conf 6b2990f21ec6a41a4c33f2a25686a44e /etc/nova/nova.conf 5.4.3 ç”±äºåŒ…è£…é”™è¯¯ï¼Œæ‚¨å¿…é¡»é€šè¿‡å°†ä»¥ä¸‹é…ç½®æ·»åŠ åˆ°æ¥å¯ç”¨å¯¹Placement APIçš„è®¿é—® /etc/httpd/conf.d/00-nova-placement-api.conf 1.å¤‡ä»½æ–‡ä»¶å¹¶è¿½åŠ å†…å®¹ \\cp /etc/httpd/conf.d/00-nova-placement-api.conf{,.bak} 2.æ³¨æ„è¦æ·»åŠ ä¸€è¡Œç©ºè¡Œï¼Œå¦åˆ™æ ¼å¼ä¼šæœ‰é”™è¯¯(è¿™é‡Œæ·»åŠ äº†ä¸¤è¡Œç©ºè¡Œï¼Œå…¶ä¸­ç¬¬ä¸€è¡Œæ˜¯ä¸ºäº†æ ¼å¼æ­£ç¡®ï¼Œç¬¬äºŒè¡Œæ˜¯ä¸ºäº†æ ¼å¼è§„èŒƒï¼Œå³æ ‡ç­¾ä¸æ ‡ç­¾ä¹‹é—´æœ‰ä¸€è¡Œç©ºè¡Œ) cat >> /etc/httpd/conf.d/00-nova-placement-api.conf = 2.4> Require all granted Order allow,deny Allow from all EOF MD5å€¼ md5sum /etc/httpd/conf.d/00-nova-placement-api.conf 4b31341049e863449951b0c76fe17bde /etc/httpd/conf.d/00-nova-placement-api.conf 3.é‡å¯httpd systemctl restart httpd 5.4.3 åŒæ­¥æ•°æ®åº“ï¼Œå¿½ç•¥è¾“å‡º #åŒæ­¥nova-apiå’Œplacementæ•°æ®åº“ $ su -s /bin/sh -c \"nova-manage api_db sync\" nova #æ³¨å†Œcell0æ•°æ®åº“ $ su -s /bin/sh -c \"nova-manage cell_v2 map_cell0\" nova #åˆ›å»ºcell1å•å…ƒæ ¼ $ su -s /bin/sh -c \"nova-manage cell_v2 create_cell --name=cell1 --verbose\" nova 536383cb-03e4-48bb-bb77-4eeb1bfb9d80 #åŒæ­¥novaæ•°æ®åº“ $ su -s /bin/sh -c \"nova-manage db sync\" nova /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u'Duplicate index `block_device_mapping_instance_uuid_virtual_name_device_name_idx`. This is deprecated and will be disallowed in a future release.') result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u'Duplicate index `uniq_instances0uuid`. This is deprecated and will be disallowed in a future release.') result = self._query(query) #éªŒè¯nova cell0å’Œcell1æ˜¯å¦æ­£ç¡®æ³¨å†Œ $ su -s /bin/sh -c \"nova-manage cell_v2 list_cells\" nova +-------+--------------------------------------+------------------------------------+-------------------------------------------------+----------+ | Name | UUID | Transport URL | Database Connection | Disabled | +-------+--------------------------------------+------------------------------------+-------------------------------------------------+----------+ | cell0 | 00000000-0000-0000-0000-000000000000 | none:/ | mysql+pymysql://nova:****@controller/nova_cell0 | False | | cell1 | 536383cb-03e4-48bb-bb77-4eeb1bfb9d80 | rabbit://openstack:****@controller | mysql+pymysql://nova:****@controller/nova | False | +-------+--------------------------------------+------------------------------------+-------------------------------------------------+----------+ 5.4.4 å¯åŠ¨ComputeæœåŠ¡å¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ nova-consoleauthè‡ª18.0.0ï¼ˆRockyï¼‰èµ·ä¸æ¨èä½¿ç”¨ï¼Œå¹¶å°†åœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­åˆ é™¤ã€‚æ¯ä¸ªå•å…ƒåº”éƒ¨ç½²æ§åˆ¶å°ä»£ç†ã€‚å¦‚æœæ‰§è¡Œå…¨æ–°å®‰è£…ï¼ˆè€Œéå‡çº§ï¼‰ï¼Œåˆ™å¯èƒ½ä¸éœ€è¦å®‰è£…nova-consoleauth æœåŠ¡ã€‚æœ‰å…³workarounds.enable_consoleauthè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ ã€‚ systemctl enable openstack-nova-api.service \\ openstack-nova-consoleauth openstack-nova-scheduler.service \\ openstack-nova-conductor.service openstack-nova-novncproxy.service systemctl start openstack-nova-api.service \\ openstack-nova-consoleauth openstack-nova-scheduler.service \\ openstack-nova-conductor.service openstack-nova-novncproxy.service å®‰è£…å®Œæˆåä¼šæœ‰no VNC 10.0.0.11:6080 å®‰è£…å’Œé…ç½®è®¡ç®—èŠ‚ç‚¹ rockyç‰ˆè®¡ç®—èŠ‚ç‚¹è®¡ç®—æœåŠ¡novaå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ 5.5 å®‰è£…å’Œé…ç½®ç»„ä»¶ 5.5.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-nova-compute openstack-utils 5.5.2 ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æ­¤[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œä»…å¯ç”¨è®¡ç®—å’Œå…ƒæ•°æ®API [DEFAULT] # ... enabled_apis = osapi_compute,metadata 2.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®ï¼š [DEFAULT] # ... transport_url = rabbit://openstack:RABBIT_PASS@controller 3.åœ¨[api]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š [api] # ... auth_strategy = keystone [keystone_authtoken] # ... auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = nova password = NOVA_PASS 4.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®my_ipé€‰é¡¹ï¼šMANAGEMENT_INTERFACE_IP_ADDRESSä¸ºè®¡ç®—èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œæ¥å£çš„IPåœ°å€ my_ip = MANAGEMENT_INTERFACE_IP_ADDRESS [DEFAULT] # ... my_ip = 10.0.0.31 5.åœ¨æœ¬[DEFAULT]èŠ‚ä¸­ï¼Œå¯ç”¨å¯¹ç½‘ç»œæœåŠ¡çš„æ”¯æŒï¼š [DEFAULT] # ... use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver 6.åœ¨æœ¬[DEFAULT]èŠ‚ä¸­ï¼Œå¯ç”¨å¯¹ç½‘ç»œæœåŠ¡çš„æ”¯æŒï¼š [DEFAULT] # ... use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver 7.åœ¨è¯¥[vnc]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å’Œé…ç½®è¿œç¨‹æ§åˆ¶å°è®¿é—®ï¼š [vnc] # ... enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html 8.åœ¨è¯¥[glance]éƒ¨åˆ†ä¸­ï¼Œé…ç½®å›¾åƒæœåŠ¡APIçš„ä½ç½®ï¼š [glance] # ... api_servers = http://controller:9292 9.åœ¨è¯¥[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ï¼š [oslo_concurrency] # ... lock_path = /var/lib/nova/tmp 10.åœ¨è¯¥[placement]éƒ¨åˆ†ä¸­ï¼Œé…ç½®Placement APIï¼š [placement] # ... region_name = RegionOne project_domain_name = Default project_name = service auth_type = password user_domain_name = Default auth_url = http://controller:5000/v3 username = placement password = PLACEMENT_PASS #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/nova/nova.conf{,.bak} grep '^[a-Z\\[]' /etc/nova/nova.conf.bak >/etc/nova/nova.conf openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata openstack-config --set /etc/nova/nova.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.31 openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron true openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver openstack-config --set /etc/nova/nova.conf api auth_strategy keystone openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:5000/v3 openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name Default openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name Default openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS openstack-config --set /etc/nova/nova.conf vnc enabled true openstack-config --set /etc/nova/nova.conf vnc server_listen 0.0.0.0 openstack-config --set /etc/nova/nova.conf vnc server_proxyclient_address '$my_ip' openstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://controller:6080/vnc_auto.html openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292 openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp openstack-config --set /etc/nova/nova.conf placement region_name RegionOne openstack-config --set /etc/nova/nova.conf placement project_domain_name Default openstack-config --set /etc/nova/nova.conf placement project_name service openstack-config --set /etc/nova/nova.conf placement auth_type password openstack-config --set /etc/nova/nova.conf placement user_domain_name Default openstack-config --set /etc/nova/nova.conf placement auth_url http://controller:5000/v3 openstack-config --set /etc/nova/nova.conf placement username placement openstack-config --set /etc/nova/nova.conf placement password PLACEMENT_PASS MD5å€¼ md5sum /etc/nova/nova.conf ab7abb82433ee2a9f2381aa10018590a /etc/nova/nova.conf 5.5.3 ç¡®å®šæ‚¨çš„è®¡ç®—èŠ‚ç‚¹æ˜¯å¦æ”¯æŒè™šæ‹Ÿæœºçš„ç¡¬ä»¶åŠ é€Ÿ $ egrep -c '(vmx|svm)' /proc/cpuinfo 2 #è¯´æ˜ å¦‚æœæ­¤å‘½ä»¤è¿”å›å€¼1æˆ–æ›´å¤§ï¼Œåˆ™è®¡ç®—èŠ‚ç‚¹æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œé€šå¸¸ä¸éœ€è¦å…¶ä»–é…ç½®ã€‚ å¦‚æœæ­¤å‘½ä»¤è¿”å›é›¶å€¼ï¼Œåˆ™è®¡ç®—èŠ‚ç‚¹ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œæ‚¨å¿…é¡»å°†libvirté…ç½®ä¸ºä½¿ç”¨QEMUè€Œä¸æ˜¯KVMã€‚ ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶ä¸­çš„[libvirt]éƒ¨åˆ†ï¼Œ å¦‚ä¸‹æ‰€ç¤ºï¼š [libvirt] ...... virt_type = qemu 5.5.4 å¯åŠ¨ComputeæœåŠ¡åŠå…¶ä¾èµ–é¡¹ï¼Œå¹¶å°†å®ƒä»¬é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶è‡ªåŠ¨å¯åŠ¨ systemctl enable libvirtd.service openstack-nova-compute.service systemctl start libvirtd.service openstack-nova-compute.service éªŒè¯æ“ä½œï¼Œåœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ 5.6 éªŒè¯ComputeæœåŠ¡çš„è¿è¡Œ 5.6.1 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 5.6.2 åˆ—å‡ºæœåŠ¡ç»„ä»¶ä»¥éªŒè¯æ¯ä¸ªè¿›ç¨‹çš„æˆåŠŸå¯åŠ¨å’Œæ³¨å†Œ openstack compute service list --service nova-compute +----+--------------+----------+------+---------+-------+----------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | +----+--------------+----------+------+---------+-------+----------------------------+ | 9 | nova-compute | compute1 | nova | enabled | up | 2020-05-25T23:37:57.000000 | +----+--------------+----------+------+---------+-------+----------------------------+ 5.6.3 å‘ç°è®¡ç®—ä¸»æœº $ su -s /bin/sh -c \"nova-manage cell_v2 discover_hosts --verbose\" nova Found 2 cell mappings. Skipping cell0 since it does not contain hosts. Getting computes from cell 'cell1': 536383cb-03e4-48bb-bb77-4eeb1bfb9d80 Checking host mapping for compute host 'compute1': 83452da0-a693-4860-bcd8-028743169f0f Creating host mapping for compute host 'compute1': 83452da0-a693-4860-bcd8-028743169f0f Found 1 unmapped computes in cell: 536383cb-03e4-48bb-bb77-4eeb1bfb9d80 åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹è®¡ç®—æœåŠ¡novaå®‰è£…å®Œæˆï¼ï¼ï¼ å…­ã€æ§åˆ¶èŠ‚ç‚¹ã€è®¡ç®—èŠ‚ç‚¹ç½‘ç»œæœåŠ¡neutronå®‰è£… neutronç›¸å…³æœåŠ¡ æœåŠ¡å è¯´æ˜ neutron-server ç«¯å£(9696) api æ¥å—å’Œå“åº”å¤–éƒ¨çš„ç½‘ç»œç®¡ç†è¯·æ±‚ neutron-linuxbridge-agent è´Ÿè´£åˆ›å»ºæ¡¥æ¥ç½‘å¡ neutron-dhcp-agent è´Ÿè´£åˆ†é…IP neutron-metadata-agent é…åˆnova-metadata-apiå®ç°è™šæ‹Ÿæœºçš„å®šåˆ¶åŒ–æ“ä½œ L3-agent å®ç°ä¸‰å±‚ç½‘ç»œ(ç½‘ç»œå±‚) å®‰è£…å’Œé…ç½®æ§åˆ¶èŠ‚ç‚¹ rockyç‰ˆæ§åˆ¶èŠ‚ç‚¹ç½‘ç»œæœåŠ¡neutronå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ 6.1 åˆ›å»ºneutronæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤ mysql -e \"CREATE DATABASE neutron;\" mysql -e \"GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' \\ IDENTIFIED BY 'NEUTRON_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' \\ IDENTIFIED BY 'NEUTRON_DBPASS';\" 6.2 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—®æƒé™ source /opt/admin-openrc 6.3 åˆ›å»ºæœåŠ¡å‡­è¯ 6.3.1 åˆ›å»ºneutronç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸ºNEUTRON_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default --password NEUTRON_PASS neutron +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | 014a7629fb0548899be31c87494e1156 | | name | neutron | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ #äº¤äº’å¼åˆ›å»ºå¯†ç  openstack user create --domain default --password-prompt neutron 6.3.2 å°†adminè§’è‰²æ·»åŠ åˆ°neutronç”¨æˆ· openstack role add --project service --user neutron admin 6.3.3 åˆ›å»ºneutronæœåŠ¡å®ä½“ openstack service create --name neutron \\ --description \"OpenStack Networking\" network +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Networking | | enabled | True | | id | 9e74ccbdaa85421894cf61c97f355dc7 | | name | neutron | | type | network | +-------------+----------------------------------+ 6.4 åˆ›å»ºç½‘ç»œæœåŠ¡APIç«¯ç‚¹ openstack endpoint create --region RegionOne \\ network public http://controller:9696 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | abe8c37741934ade89308da46501ea03 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 9e74ccbdaa85421894cf61c97f355dc7 | | service_name | neutron | | service_type | network | | url | http://controller:9696 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ network internal http://controller:9696 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 0c32f6cb44a74ec5b653ba79153e3d68 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 9e74ccbdaa85421894cf61c97f355dc7 | | service_name | neutron | | service_type | network | | url | http://controller:9696 | +--------------+----------------------------------+ openstack endpoint create --region RegionOne \\ network admin http://controller:9696 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | d2c77ff079c94591bc8ea0b4e51be936 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 9e74ccbdaa85421894cf61c97f355dc7 | | service_name | neutron | | service_type | network | | url | http://controller:9696 | +--------------+----------------------------------+ 6.5 é…ç½®ç½‘ç»œé€‰é¡¹ï¼Œæ§åˆ¶èŠ‚ç‚¹æ“ä½œ å®˜ç½‘å…³äºä¸¤ç§ç½‘ç»œçš„è¯´æ˜ æ‚¨å¯ä»¥ä½¿ç”¨é€‰é¡¹1å’Œ2è¡¨ç¤ºçš„ä¸¤ç§ä½“ç³»ç»“æ„ä¹‹ä¸€æ¥éƒ¨ç½²ç½‘ç»œæœåŠ¡ã€‚ é€‰é¡¹1éƒ¨ç½²äº†æœ€ç®€å•çš„æ¶æ„ï¼Œè¯¥æ¶æ„ä»…æ”¯æŒå°†å®ä¾‹é™„åŠ åˆ°æä¾›ç¨‹åºï¼ˆå¤–éƒ¨ï¼‰ç½‘ç»œã€‚æ²¡æœ‰è‡ªåŠ©æœåŠ¡ï¼ˆä¸“ç”¨ï¼‰ç½‘ç»œï¼Œè·¯ç”±å™¨æˆ–æµ®åŠ¨IPåœ°å€ã€‚åªæœ‰adminæˆ–å…¶ä»–ç‰¹æƒç”¨æˆ·å¯ä»¥ç®¡ç†æä¾›å•†ç½‘ç»œã€‚ é€‰é¡¹2é€šè¿‡æ”¯æŒå°†å®ä¾‹é™„åŠ åˆ°è‡ªåŠ©æœåŠ¡ç½‘ç»œçš„ç¬¬3å±‚æœåŠ¡å¢å¼ºäº†é€‰é¡¹1ã€‚è¯¥demoéç‰¹æƒç”¨æˆ·æˆ–å…¶ä»–éç‰¹æƒç”¨æˆ·å¯ä»¥ç®¡ç†è‡ªåŠ©æœåŠ¡ç½‘ç»œï¼ŒåŒ…æ‹¬åœ¨è‡ªåŠ©æœåŠ¡ç½‘ç»œä¸æä¾›å•†ç½‘ç»œä¹‹é—´æä¾›è¿æ¥çš„è·¯ç”±å™¨ã€‚æ­¤å¤–ï¼Œæµ®åŠ¨IPåœ°å€ä½¿ç”¨è‡ªåŠ©æœåŠ¡ç½‘ç»œä»å¤–éƒ¨ç½‘ç»œï¼ˆä¾‹å¦‚Internetï¼‰æä¾›åˆ°å®ä¾‹çš„è¿æ¥ã€‚ è‡ªåŠ©æœåŠ¡ç½‘ç»œé€šå¸¸ä½¿ç”¨è¦†ç›–ç½‘ç»œã€‚è¯¸å¦‚VXLANä¹‹ç±»çš„è¦†ç›–ç½‘ç»œåè®®åŒ…æ‹¬å…¶ä»–æ ‡å¤´ï¼Œè¿™äº›æ ‡å¤´å¢åŠ äº†å¼€é”€å¹¶å‡å°‘äº†å¯ç”¨äºæœ‰æ•ˆè´Ÿè½½æˆ–ç”¨æˆ·æ•°æ®çš„ç©ºé—´ã€‚åœ¨ä¸äº†è§£è™šæ‹Ÿç½‘ç»œåŸºç¡€ç»“æ„çš„æƒ…å†µä¸‹ï¼Œå®ä¾‹å°è¯•ä½¿ç”¨é»˜è®¤çš„1500å­—èŠ‚ä»¥å¤ªç½‘æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼‰å‘é€æ•°æ®åŒ…ã€‚ç½‘ç»œæœåŠ¡ä¼šé€šè¿‡DHCPè‡ªåŠ¨ä¸ºå®ä¾‹æä¾›æ­£ç¡®çš„MTUå€¼ã€‚ä½†æ˜¯ï¼ŒæŸäº›äº‘æ˜ åƒä¸ä½¿ç”¨DHCPæˆ–å¿½ç•¥DHCP MTUé€‰é¡¹ï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨å…ƒæ•°æ®æˆ–è„šæœ¬è¿›è¡Œé…ç½®ã€‚ ç½‘ç»œé€‰é¡¹1:æä¾›å•†ç½‘ç»œ ç½‘ç»œé€‰é¡¹2:è‡ªåŠ©æœåŠ¡ç½‘ç»œ ä»¥ä¸Šä¸¤ç§ç½‘ç»œä»»é€‰ä¸€ç§å®Œæˆåè¿”å›è¿™é‡Œé…ç½®å…ƒæ•°æ®ä»£ç† è¿™é‡Œé€‰æ‹©ç½‘è·¯é€‰é¡¹1 6.5.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-neutron openstack-neutron-ml2 \\ openstack-neutron-linuxbridge ebtables 6.5.2 é…ç½®æœåŠ¡å™¨ç»„ä»¶ ç¼–è¾‘/etc/neutron/neutron.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨è¯¥[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—® [database] # ... connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron 2.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨æ¨¡å—åŒ–ç¬¬2å±‚ï¼ˆML2ï¼‰æ’ä»¶å¹¶ç¦ç”¨å…¶ä»–æ’ä»¶ï¼š [DEFAULT] # ... core_plugin = ml2 service_plugins = 3.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—è®¿é—®ï¼š [DEFAULT] # ... transport_url = rabbit://openstack:RABBIT_PASS@controller 4.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—® [DEFAULT] # ... auth_strategy = keystone [keystone_authtoken] # ... www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = neutron password = NEUTRON_PASS 5.åœ¨[DEFAULT]å’Œ[nova]éƒ¨åˆ†ä¸­ï¼Œå°†ç½‘ç»œé…ç½®ä¸ºé€šçŸ¥Computeç½‘ç»œæ‹“æ‰‘æ›´æ”¹ [DEFAULT] # ... notify_nova_on_port_status_changes = true notify_nova_on_port_data_changes = true [nova] # ... auth_url = http://controller:5000 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = nova password = NOVA_PASS 6.åœ¨è¯¥[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ [oslo_concurrency] # ... lock_path = /var/lib/neutron/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/neutron.conf{,.bak} grep '^[a-Z\\[]' /etc/neutron/neutron.conf.bak >/etc/neutron/neutron.conf openstack-config --set /etc/neutron/neutron.conf database connection mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2 openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins openstack-config --set /etc/neutron/neutron.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes true openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes true openstack-config --set /etc/neutron/neutron.conf keystone_authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS openstack-config --set /etc/neutron/neutron.conf nova auth_url http://controller:5000 openstack-config --set /etc/neutron/neutron.conf nova auth_type password openstack-config --set /etc/neutron/neutron.conf nova project_domain_name default openstack-config --set /etc/neutron/neutron.conf nova user_domain_name default openstack-config --set /etc/neutron/neutron.conf nova region_name RegionOne openstack-config --set /etc/neutron/neutron.conf nova project_name service openstack-config --set /etc/neutron/neutron.conf nova username nova openstack-config --set /etc/neutron/neutron.conf nova password NOVA_PASS openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp MD5å€¼ md5sum /etc/neutron/neutron.conf 1c4b4339f83596fa6bfdbec7a622a35e /etc/neutron/neutron.conf 6.6 é…ç½®æ¨¡å—åŒ–ç¬¬2å±‚ï¼ˆML2ï¼‰æ’ä»¶ ML2æ’ä»¶ä½¿ç”¨Linuxæ¡¥æ¥æœºåˆ¶ä¸ºå®ä¾‹æ„å»ºç¬¬2å±‚ï¼ˆæ¡¥æ¥å’Œäº¤æ¢ï¼‰è™šæ‹Ÿç½‘ç»œåŸºç¡€æ¶æ„ ç¼–è¾‘/etc/neutron/plugins/ml2/ml2_conf.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æœ¬[ml2]èŠ‚ä¸­ï¼Œå¯ç”¨å¹³é¢å’ŒVLANç½‘ç»œ [ml2] # ... type_drivers = flat,vlan 2.åœ¨è¯¥[ml2]éƒ¨åˆ†ä¸­ï¼Œç¦ç”¨è‡ªåŠ©æœåŠ¡ç½‘ç»œï¼š [ml2] # ... tenant_network_types = 3.åœ¨æœ¬[ml2]èŠ‚ä¸­ï¼Œå¯ç”¨Linuxæ¡¥æ¥æœºåˆ¶ï¼š [ml2] # ... mechanism_drivers = linuxbridge 4.åœ¨æ­¤[ml2]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨ç«¯å£å®‰å…¨æ‰©å±•é©±åŠ¨ç¨‹åºï¼š [ml2] # ... extension_drivers = port_security 5.åœ¨æœ¬[ml2_type_flat]èŠ‚ä¸­ï¼Œå°†æä¾›è€…è™šæ‹Ÿç½‘ç»œé…ç½®ä¸ºå¹³é¢ç½‘ç»œï¼š [ml2_type_flat] # ... flat_networks = provider 6.åœ¨æœ¬[securitygroup]èŠ‚ä¸­ï¼Œå¯ç”¨ipsetä»¥æé«˜å®‰å…¨ç»„è§„åˆ™çš„æ•ˆç‡ï¼š [securitygroup] # ... enable_ipset = true #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/plugins/ml2/ml2_conf.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/plugins/ml2/ml2_conf.ini.bak >/etc/neutron/plugins/ml2/ml2_conf.ini openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers linuxbridge openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks provider openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset true MD5å€¼ md5sum /etc/neutron/plugins/ml2/ml2_conf.ini eb38c10cfd26c1cc308a050c9a5d8aa1 /etc/neutron/plugins/ml2/ml2_conf.ini 6.7 é…ç½®linuxæ¡¥æ¥ä»£ç† Linuxç½‘æ¡¥ä»£ç†ä¸ºå®ä¾‹æ„å»ºç¬¬2å±‚ï¼ˆæ¡¥æ¥å’Œäº¤æ¢ï¼‰è™šæ‹Ÿç½‘ç»œåŸºç¡€æ¶æ„å¹¶å¤„ç†å®‰å…¨ç»„ ç¼–è¾‘/etc/neutron/plugins/ml2/linuxbridge_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æœ¬[linux_bridge]èŠ‚ä¸­ï¼Œå°†æä¾›è€…è™šæ‹Ÿç½‘ç»œæ˜ å°„åˆ°æä¾›è€…ç‰©ç†ç½‘ç»œæ¥å£ï¼š [linux_bridge] physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME æ›¿æ¢PROVIDER_INTERFACE_NAMEä¸ºåŸºç¡€æä¾›å•†ç‰©ç†ç½‘ç»œæ¥å£çš„åç§°ã€‚è¿™é‡Œæ˜¯eth0 2.åœ¨è¯¥[vxlan]éƒ¨åˆ†ä¸­ï¼Œç¦ç”¨VXLANè¦†ç›–ç½‘ç»œï¼š [vxlan] enable_vxlan = false 3.åœ¨è¯¥[securitygroup]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å®‰å…¨ç»„å¹¶é…ç½®Linuxç½‘æ¡¥iptablesé˜²ç«å¢™é©±åŠ¨ç¨‹åºï¼š [securitygroup] # ... enable_security_group = true firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver é€šè¿‡éªŒè¯ä»¥ä¸‹æ‰€æœ‰sysctlå€¼æ˜¯å¦è®¾ç½®ä¸ºç¡®ä¿Linuxæ“ä½œç³»ç»Ÿå†…æ ¸æ”¯æŒç½‘æ¡¥è¿‡æ»¤å™¨1ï¼š net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables è¦å¯ç”¨ç½‘ç»œæ¡¥æ¥å™¨æ”¯æŒï¼Œé€šå¸¸br_netfilteréœ€è¦åŠ è½½å†…æ ¸æ¨¡å—ã€‚æŸ¥çœ‹æ“ä½œç³»ç»Ÿçš„æ–‡æ¡£ï¼Œä»¥è·å–æœ‰å…³å¯ç”¨æ­¤æ¨¡å—çš„å…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚ #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak >/etc/neutron/plugins/ml2/linuxbridge_agent.ini openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth0 openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan false openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group true openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver MD5å€¼ md5sum /etc/neutron/plugins/ml2/linuxbridge_agent.ini 794b19995c83e2fc0c3fd42f506904f1 /etc/neutron/plugins/ml2/linuxbridge_agent.ini ä½¿Linuxæ“ä½œç³»ç»Ÿå†…æ ¸æ”¯æŒç½‘æ¡¥è¿‡æ»¤å™¨1 #å‘/etc/sysctl.d/openstack-rocky-bridge.confå†™å…¥ä»¥ä¸‹å†…å®¹ cat >> /etc/sysctl.d/openstack-rocky-bridge.conf 6.8 é…ç½®DHCPä»£ç† DHCPä»£ç†ä¸ºè™šæ‹Ÿç½‘ç»œæä¾›DHCPæœåŠ¡ ç¼–è¾‘/etc/neutron/dhcp_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ åœ¨æœ¬[DEFAULT]èŠ‚ä¸­ï¼Œé…ç½®Linuxæ¡¥æ¥å£é©±åŠ¨ç¨‹åºDnsmasq DHCPé©±åŠ¨ç¨‹åºï¼Œå¹¶å¯ç”¨éš”ç¦»çš„å…ƒæ•°æ®ï¼Œä»¥ä¾¿æä¾›å•†ç½‘ç»œä¸Šçš„å®ä¾‹å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®å…ƒæ•°æ® [DEFAULT] # ... interface_driver = linuxbridge dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq enable_isolated_metadata = true #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/dhcp_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/dhcp_agent.ini.bak >/etc/neutron/dhcp_agent.ini openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver linuxbridge openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dhcp_driver neutron.agent.linux.dhcp.Dnsmasq openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT enable_isolated_metadata true MD5å€¼ md5sum /etc/neutron/dhcp_agent.ini 33a1e93e1853796070d5da0773496665 /etc/neutron/dhcp_agent.ini 6.9 é…ç½®å…ƒæ•°æ®ä»£ç† æ‰€è¿°å…ƒæ•°æ®ä»£ç†æä¾›é…ç½®ä¿¡æ¯çš„è¯¸å¦‚å‡­æ®å®ä¾‹ã€‚ ç¼–è¾‘/etc/neutron/metadata_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®å…ƒæ•°æ®ä¸»æœºå’Œå…±äº«æœºå¯†ï¼š [DEFAULT] # ... nova_metadata_host = controller metadata_proxy_shared_secret = METADATA_SECRET æ›¿æ¢METADATA_SECRETä¸ºå…ƒæ•°æ®ä»£ç†çš„é€‚å½“æœºå¯† #ç”¨ä»¥ä¸‹é¢†å‘½ä¿®æ”¹ \\cp /etc/neutron/metadata_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/metadata_agent.ini.bak >/etc/neutron/metadata_agent.ini openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_host controller openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET MD5å€¼ md5sum /etc/neutron/metadata_agent.ini e8b90a011b94fece31d33edfd8bc72b6 /etc/neutron/metadata_agent.ini 6.10 é…ç½®è®¡ç®—ä»¥ä½¿ç”¨ç½‘ç»œ ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œ åœ¨è¯¥[neutron]éƒ¨åˆ†ä¸­ï¼Œé…ç½®è®¿é—®å‚æ•°ï¼Œå¯ç”¨å…ƒæ•°æ®ä»£ç†ï¼Œå¹¶é…ç½®æœºå¯†ï¼š [neutron] # ... url = http://controller:9696 auth_url = http://controller:5000 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = neutron password = NEUTRON_PASS service_metadata_proxy = true metadata_proxy_shared_secret = METADATA_SECRET #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ openstack-config --set /etc/nova/nova.conf neutron url http://controller:9696 openstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:5000 openstack-config --set /etc/nova/nova.conf neutron auth_type password openstack-config --set /etc/nova/nova.conf neutron project_domain_name default openstack-config --set /etc/nova/nova.conf neutron user_domain_name default openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne openstack-config --set /etc/nova/nova.conf neutron project_name service openstack-config --set /etc/nova/nova.conf neutron username neutron openstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS openstack-config --set /etc/nova/nova.conf neutron service_metadata_proxy true openstack-config --set /etc/nova/nova.conf neutron metadata_proxy_shared_secret METADATA_SECRET MD5å€¼ md5sum /etc/nova/nova.conf 81feca9d18ee91397cc973d455bfa271 /etc/nova/nova.conf 6.11 å®Œæˆå®‰è£… 6.11.1 ç½‘ç»œæœåŠ¡åˆå§‹åŒ–è„šæœ¬éœ€è¦/etc/neutron/plugin.iniæŒ‡å‘ML2æ’ä»¶é…ç½®æ–‡ä»¶çš„ç¬¦å·é“¾æ¥ /etc/neutron/plugins/ml2/ml2_conf.iniã€‚å¦‚æœæ­¤ç¬¦å·é“¾æ¥ä¸å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºå®ƒ ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini 6.11.2 åŒæ­¥æ•°æ®åº“ï¼Œæœ€åæç¤ºOKå³ä¸ºæ­£ç¡® su -s /bin/sh -c \"neutron-db-manage --config-file /etc/neutron/neutron.conf \\ --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head\" neutron 6.11.3 é‡æ–°å¯åŠ¨Compute APIæœåŠ¡ systemctl restart openstack-nova-api.service 6.11.4 å¯åŠ¨ç½‘ç»œæœåŠ¡å¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ å¯¹äºå®˜ç½‘ä¸­çš„ä¸¤ç§ç½‘ç»œï¼Œè¿™é‡Œé€‰æ‹©çš„æ˜¯ç¬¬ä¸€ç§ç½‘ç»œ #å¯åŠ¨ç½‘ç»œæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable neutron-server.service \\ neutron-linuxbridge-agent.service neutron-dhcp-agent.service \\ neutron-metadata-agent.service systemctl start neutron-server.service \\ neutron-linuxbridge-agent.service neutron-dhcp-agent.service \\ neutron-metadata-agent.service 6.11.5 éªŒè¯ #å¯åŠ¨æœåŠ¡åæç¤ºå¦‚ä¸‹å³ä¸ºæ­£ç¡®ï¼Œaliveå¤„éƒ½ä¸ºç¬‘è„¸ $ neutron agent-list neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead. +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ | id | agent_type | host | availability_zone | alive | admin_state_up | binary | +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ | beffcac6-745e-449f-bad8-7f2e4fa973f2 | Linux bridge agent | controller | | :-) | True | neutron-linuxbridge-agent | +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ å®‰è£…å’Œé…ç½®è®¡ç®—èŠ‚ç‚¹ rockyç‰ˆè®¡ç®—èŠ‚ç‚¹ç½‘ç»œæœåŠ¡neutronå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ 6.12 å®‰è£…åŒ… yum -y install openstack-neutron-linuxbridge ebtables ipset openstack-utils 6.13 é…ç½®å…¬å…±ç»„ä»¶ ç¼–è¾‘/etc/neutron/neutron.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—è®¿é—®ï¼š [DEFAULT] # ... transport_url = rabbit://openstack:RABBIT_PASS@controller 2.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š [DEFAULT] # ... auth_strategy = keystone [keystone_authtoken] # ... www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = neutron password = NEUTRON_PASS 3.åœ¨è¯¥[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ï¼š [oslo_concurrency] # ... lock_path = /var/lib/neutron/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/neutron.conf{,.bak} grep '^[a-Z\\[]' /etc/neutron/neutron.conf.bak >/etc/neutron/neutron.conf openstack-config --set /etc/neutron/neutron.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone openstack-config --set /etc/neutron/neutron.conf keystone_authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp MD5å€¼ md5sum /etc/neutron/neutron.conf 9c47ffb59b23516b59e7de84a39bcbe8 /etc/neutron/neutron.conf 6.14 é…ç½®ç½‘ç»œé€‰é¡¹ 6.14.1 é…ç½®æ¡¥æ¥ä»£ç† Linuxç½‘æ¡¥ä»£ç†ä¸ºå®ä¾‹æ„å»ºç¬¬2å±‚ï¼ˆæ¡¥æ¥å’Œäº¤æ¢ï¼‰è™šæ‹Ÿç½‘ç»œåŸºç¡€ç»“æ„å¹¶å¤„ç†å®‰å…¨ç»„ ç¼–è¾‘/etc/neutron/plugins/ml2/linuxbridge_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æœ¬[linux_bridge]èŠ‚ä¸­ï¼Œå°†æä¾›è€…è™šæ‹Ÿç½‘ç»œæ˜ å°„åˆ°æä¾›è€…ç‰©ç†ç½‘ç»œæ¥å£ï¼š [linux_bridge] physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME æ›¿æ¢PROVIDER_INTERFACE_NAMEä¸ºåŸºç¡€æä¾›å•†ç‰©ç†ç½‘ç»œæ¥å£çš„åç§°ã€‚è¿™é‡Œä¸ºeth0 2.åœ¨è¯¥[vxlan]éƒ¨åˆ†ä¸­ï¼Œç¦ç”¨VXLANè¦†ç›–ç½‘ç»œï¼š [vxlan] enable_vxlan = false 3.åœ¨è¯¥[securitygroup]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å®‰å…¨ç»„å¹¶é…ç½®Linuxç½‘æ¡¥iptablesé˜²ç«å¢™é©±åŠ¨ç¨‹åºï¼š [securitygroup] # ... enable_security_group = true firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak >/etc/neutron/plugins/ml2/linuxbridge_agent.ini openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth0 openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan false openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group true openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver MD5å€¼ md5sum /etc/neutron/plugins/ml2/linuxbridge_agent.ini 794b19995c83e2fc0c3fd42f506904f1 /etc/neutron/plugins/ml2/linuxbridge_agent.ini ä½¿Linuxæ“ä½œç³»ç»Ÿå†…æ ¸æ”¯æŒç½‘æ¡¥è¿‡æ»¤å™¨1 #å‘/etc/sysctl.d/openstack-rocky-bridge.confå†™å…¥ä»¥ä¸‹å†…å®¹ cat >> /etc/sysctl.d/openstack-rocky-bridge.conf 6.14.2 é…ç½®è®¡ç®—ä»¥ä½¿ç”¨ç½‘ç»œ ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ åœ¨è¯¥[neutron]éƒ¨åˆ†ä¸­ï¼Œé…ç½®è®¿é—®å‚æ•°ï¼š [neutron] # ... url = http://controller:9696 auth_url = http://controller:5000 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = neutron password = NEUTRON_PASS #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ openstack-config --set /etc/nova/nova.conf neutron url http://controller:9696 openstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:5000 openstack-config --set /etc/nova/nova.conf neutron auth_type password openstack-config --set /etc/nova/nova.conf neutron project_domain_name default openstack-config --set /etc/nova/nova.conf neutron user_domain_name default openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne openstack-config --set /etc/nova/nova.conf neutron project_name service openstack-config --set /etc/nova/nova.conf neutron username neutron openstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS MD5å€¼ md5sum /etc/nova/nova.conf 9b96b21ae709f89c96cc559018ba7058 /etc/nova/nova.conf 6.15 å®Œæˆå®‰è£… 6.15.1 é‡æ–°å¯åŠ¨ComputeæœåŠ¡ systemctl restart openstack-nova-compute.service 6.15.2 å¯åŠ¨Linuxç½‘æ¡¥ä»£ç†å¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ systemctl enable neutron-linuxbridge-agent.service systemctl start neutron-linuxbridge-agent.service 6.16 éªŒè¯ æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ è¾“å‡ºåº”æŒ‡ç¤ºæ§åˆ¶å™¨èŠ‚ç‚¹ä¸Šçš„ä¸‰ä¸ªä»£ç†ï¼Œæ¯ä¸ªè®¡ç®—èŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªä»£ç† openstack network agent list +--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+ | ID | Agent Type | Host | Availability Zone | Alive | State | Binary | +--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+ | 42cfe05b-0a9c-40ce-8f99-06ba76938c50 | Linux bridge agent | controller | None | :-) | UP | neutron-linuxbridge-agent | | 749cb43f-a5db-4918-a3f5-8765e92e851c | DHCP agent | controller | nova | :-) | UP | neutron-dhcp-agent | | 856ecf5f-6018-4ac4-a66b-f6f88784db0e | Metadata agent | controller | None | :-) | UP | neutron-metadata-agent | | b5c2309c-fefc-46d0-b98e-37b05861095c | Linux bridge agent | compute1 | None | :-) | UP | neutron-linuxbridge-agent | +--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+ åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹ã€è®¡ç®—èŠ‚ç‚¹ç½‘ç»œæœåŠ¡neutronå®‰è£…å®Œæˆï¼ï¼ï¼ ä¸ƒã€æ§åˆ¶èŠ‚ç‚¹horizon webç•Œé¢Dashboardå®‰è£… rockyç‰ˆæ§åˆ¶èŠ‚ç‚¹horizon webèŠ‚ç‚¹dashboardå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ horizonæ’ä»¶æ³¨å†Œè¡¨å®˜æ–¹æ–‡æ¡£ 7.1 å®‰è£…åŒ… yum -y install openstack-dashboard 7.2 ç¼–è¾‘/etc/openstack-dashboard/local_settingsæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ âš ï¸å› ä¸ºæœ‰ä¸€äº›å†…å®¹æ˜¯åˆ é™¤ä¹‹åç²˜è´´çš„ï¼Œæ‰€ä»¥ä¸€äº›è¡Œæ•°å¹¶ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œä½†æ˜¯è¡Œæ•°è¯¯å·®ä¸è¶…è¿‡3è¡Œ 1.é…ç½®ä»ªè¡¨æ¿ä»¥åœ¨controllerèŠ‚ç‚¹ä¸Šä½¿ç”¨OpenStackæœåŠ¡ ï¼š 184è¡Œ OPENSTACK_HOST = \"127.0.0.1\" ä¿®æ”¹ä¸º OPENSTACK_HOST = \"controller\" 2.å…è®¸ä¸»æœºè®¿é—®ä»ªè¡¨æ¿ï¼š ALLOWED_HOSTSä¹Ÿå¯ä»¥æ˜¯['*']ä»¥æ¥å—æ‰€æœ‰ä¸»æœºã€‚è¿™å¯¹äºå¼€å‘å·¥ä½œå¯èƒ½æœ‰ç”¨ï¼Œä½†æ˜¯å¯èƒ½ä¸å®‰å…¨ï¼Œå› æ­¤ä¸åº”åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚æœ‰å…³ æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ https://docs.djangoproject.com/en/dev/ref/settings/#allowed-hostsã€‚ 38è¡Œ ALLOWED_HOSTS = ['one.example.com', 'two.example.com'] ä¿®æ”¹ä¸º ALLOWED_HOSTS = ['*', ] 3.é…ç½®memcachedä¼šè¯å­˜å‚¨æœåŠ¡ï¼š 161è¡Œï¼ŒCACHESä¸ŠåŠ ä¸€è¡Œ SESSION_ENGINEï¼Œå¹¶ä¸”ä¿®æ”¹ä¸ºå¦‚ä¸‹å†…å®¹ SESSION_ENGINE = 'django.contrib.sessions.backends.cache' CACHES = { 'default': { 'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache', 'LOCATION': 'controller:11211', } } 4.å¯ç”¨èº«ä»½APIç‰ˆæœ¬3ï¼š 187è¡Œï¼Œä¸ç”¨ä¿®æ”¹ OPENSTACK_KEYSTONE_URL = \"http://%s:5000/v3\" % OPENSTACK_HOST 5.å¯ç”¨å¯¹åŸŸçš„æ”¯æŒï¼š 75è¡Œ #OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = False ä¿®æ”¹ä¸º OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True 6.é…ç½®APIç‰ˆæœ¬ï¼š 64è¡Œï¼ŒåŸå…ˆä¸ºæ³¨é‡Šï¼Œ #OPENSTACK_API_VERSIONS = { # \"data-processing\": 1.1, # \"identity\": 3, # \"image\": 2, # \"volume\": 2, # \"compute\": 2, #} ä¿®æ”¹ä¸ºå¦‚ä¸‹ OPENSTACK_API_VERSIONS = { \"identity\": 3, \"image\": 2, \"volume\": 2, } 7.é…ç½®Defaultä¸ºé€šè¿‡ä»ªè¡¨æ¿åˆ›å»ºçš„ç”¨æˆ·çš„é»˜è®¤åŸŸï¼š 95è¡Œ #OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = 'Default' ä¿®æ”¹ä¸º OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = \"Default\" 8.é…ç½®userä¸ºé€šè¿‡ä»ªè¡¨æ¿åˆ›å»ºçš„ç”¨æˆ·çš„é»˜è®¤è§’è‰²ï¼š 186è¡Œ OPENSTACK_KEYSTONE_DEFAULT_ROLE = \"_member_\" ä¿®æ”¹ä¸º OPENSTACK_KEYSTONE_DEFAULT_ROLE = \"user\" 9.å¦‚æœé€‰æ‹©ç½‘ç»œé€‰é¡¹1ï¼Œè¯·ç¦ç”¨å¯¹ç¬¬3å±‚ç½‘ç»œæœåŠ¡çš„æ”¯æŒï¼š 324è¡Œ OPENSTACK_NEUTRON_NETWORK = { 'enable_router': True, 'enable_quotas': True, 'enable_ipv6': True, 'enable_distributed_router': False, 'enable_ha_router': False, 'enable_fip_topology_check': True, ä¿®æ”¹ä¸ºå¦‚ä¸‹ OPENSTACK_NEUTRON_NETWORK = { 'enable_router': False, 'enable_quotas': False, 'enable_distributed_router': False, 'enable_ha_router': False, 'enable_lb': False, 'enable_firewall': False, 'enable_vpn': False, 'enable_fip_topology_check': False, 10.é…ç½®æ—¶åŒºï¼š 467è¡Œ TIME_ZONE = \"TIME_ZONE\" ä¿®æ”¹ä¸º TIME_ZONE = \"Asia/Shanghai\" å¤‡ä»½ä¸€ä¸‹æ–‡ä»¶ \\cp /etc/openstack-dashboard/local_settings{,.bak} é‡‡ç”¨cat EOFæ–¹å¼å¯èƒ½ä¼šæœ‰æ ¼å¼é—®é¢˜ï¼Œå› ä¸ºæ–‡ä»¶å†…å®¹å¤ªå¤šäº†ï¼Œè¿™é‡Œå¿…é¡»ä½¿ç”¨viæ‰“å¼€æ–‡ä»¶ç„¶åå¤åˆ¶ç²˜è´´å†…å®¹ï¼Œä¸èƒ½ä½¿ç”¨vimä¼šæœ‰æ ¼å¼é”™è¯¯ /etc/openstack-dashboard/local_settingsæ–‡ä»¶å†…å®¹ # -*- coding: utf-8 -*- import os from django.utils.translation import ugettext_lazy as _ from openstack_dashboard.settings import HORIZON_CONFIG DEBUG = False # This setting controls whether or not compression is enabled. Disabling # compression makes Horizon considerably slower, but makes it much easier # to debug JS and CSS changes #COMPRESS_ENABLED = not DEBUG # This setting controls whether compression happens on the fly, or offline # with `python manage.py compress` # See https://django-compressor.readthedocs.io/en/latest/usage/#offline-compression # for more information #COMPRESS_OFFLINE = not DEBUG # WEBROOT is the location relative to Webserver root # should end with a slash. WEBROOT = '/dashboard/' #LOGIN_URL = WEBROOT + 'auth/login/' #LOGOUT_URL = WEBROOT + 'auth/logout/' # # LOGIN_REDIRECT_URL can be used as an alternative for # HORIZON_CONFIG.user_home, if user_home is not set. # Do not set it to '/home/', as this will cause circular redirect loop #LOGIN_REDIRECT_URL = WEBROOT # If horizon is running in production (DEBUG is False), set this # with the list of host/domain names that the application can serve. # For more information see: # https://docs.djangoproject.com/en/dev/ref/settings/#allowed-hosts ALLOWED_HOSTS = ['*', ] # Set SSL proxy settings: # Pass this header from the proxy after terminating the SSL, # and don't forget to strip it from the client's request. # For more information see: # https://docs.djangoproject.com/en/dev/ref/settings/#secure-proxy-ssl-header #SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https') # If Horizon is being served through SSL, then uncomment the following two # settings to better secure the cookies from security exploits #CSRF_COOKIE_SECURE = True #SESSION_COOKIE_SECURE = True # The absolute path to the directory where message files are collected. # The message file must have a .json file extension. When the user logins to # horizon, the message files collected are processed and displayed to the user. #MESSAGES_PATH=None # Overrides for OpenStack API versions. Use this setting to force the # OpenStack dashboard to use a specific API version for a given service API. # Versions specified here should be integers or floats, not strings. # NOTE: The version should be formatted as it appears in the URL for the # service API. For example, The identity service APIs have inconsistent # use of the decimal point, so valid options would be 2.0 or 3. # Minimum compute version to get the instance locked status is 2.9. OPENSTACK_API_VERSIONS = { \"identity\": 3, \"image\": 2, \"volume\": 2, } # Set this to True if running on a multi-domain model. When this is enabled, it # will require the user to enter the Domain name in addition to the username # for login. OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True # Set this to True if you want available domains displayed as a dropdown menu # on the login screen. It is strongly advised NOT to enable this for public # clouds, as advertising enabled domains to unauthenticated customers # irresponsibly exposes private information. This should only be used for # private clouds where the dashboard sits behind a corporate firewall. #OPENSTACK_KEYSTONE_DOMAIN_DROPDOWN = False # If OPENSTACK_KEYSTONE_DOMAIN_DROPDOWN is enabled, this option can be used to # set the available domains to choose from. This is a list of pairs whose first # value is the domain name and the second is the display name. #OPENSTACK_KEYSTONE_DOMAIN_CHOICES = ( # ('Default', 'Default'), #) # Overrides the default domain used when running on single-domain model # with Keystone V3. All entities will be created in the default domain. # NOTE: This value must be the name of the default domain, NOT the ID. # Also, you will most likely have a value in the keystone policy file like this # \"cloud_admin\": \"rule:admin_required and domain_id:\" # This value must be the name of the domain whose ID is specified there. OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = 'Default' # Set this to True to enable panels that provide the ability for users to # manage Identity Providers (IdPs) and establish a set of rules to map # federation protocol attributes to Identity API attributes. # This extension requires v3.0+ of the Identity API. #OPENSTACK_KEYSTONE_FEDERATION_MANAGEMENT = False # Set Console type: # valid options are \"AUTO\"(default), \"VNC\", \"SPICE\", \"RDP\", \"SERIAL\", \"MKS\" # or None. Set to None explicitly if you want to deactivate the console. #CONSOLE_TYPE = \"AUTO\" # Toggle showing the openrc file for Keystone V2. # If set to false the link will be removed from the user dropdown menu # and the API Access page #SHOW_KEYSTONE_V2_RC = True # If provided, a \"Report Bug\" link will be displayed in the site header # which links to the value of this setting (ideally a URL containing # information on how to report issues). #HORIZON_CONFIG[\"bug_url\"] = \"http://bug-report.example.com\" # Show backdrop element outside the modal, do not close the modal # after clicking on backdrop. #HORIZON_CONFIG[\"modal_backdrop\"] = \"static\" # Specify a regular expression to validate user passwords. #HORIZON_CONFIG[\"password_validator\"] = { # \"regex\": '.*', # \"help_text\": _(\"Your password does not meet the requirements.\"), #} # Turn off browser autocompletion for forms including the login form and # the database creation workflow if so desired. #HORIZON_CONFIG[\"password_autocomplete\"] = \"off\" # Setting this to True will disable the reveal button for password fields, # including on the login form. #HORIZON_CONFIG[\"disable_password_reveal\"] = False LOCAL_PATH = '/tmp' # Set custom secret key: # You can either set it to a specific value or you can let horizon generate a # default secret key that is unique on this machine, e.i. regardless of the # amount of Python WSGI workers (if used behind Apache+mod_wsgi): However, # there may be situations where you would want to set this explicitly, e.g. # when multiple dashboard instances are distributed on different machines # (usually behind a load-balancer). Either you have to make sure that a session # gets all requests routed to the same dashboard instance or you set the same # SECRET_KEY for all of them. SECRET_KEY='f9ed41e34c2b04178998' # We recommend you use memcached for development; otherwise after every reload # of the django development server, you will have to login again. To use # memcached set CACHES to something like #CACHES = { # 'default': { # 'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache', # 'LOCATION': '127.0.0.1:11211', # }, #} SESSION_ENGINE = 'django.contrib.sessions.backends.cache' CACHES = { 'default': { 'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache', 'LOCATION': 'controller:11211', } } # Send email to the console by default EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend' # Or send them to /dev/null #EMAIL_BACKEND = 'django.core.mail.backends.dummy.EmailBackend' # Configure these for your outgoing email host #EMAIL_HOST = 'smtp.my-company.com' #EMAIL_PORT = 25 #EMAIL_HOST_USER = 'djangomail' #EMAIL_HOST_PASSWORD = 'top-secret!' # For multiple regions uncomment this configuration, and add (endpoint, title). #AVAILABLE_REGIONS = [ # ('http://cluster1.example.com:5000/v3', 'cluster1'), # ('http://cluster2.example.com:5000/v3', 'cluster2'), #] OPENSTACK_HOST = \"controller\" OPENSTACK_KEYSTONE_URL = \"http://%s:5000/v3\" % OPENSTACK_HOST OPENSTACK_KEYSTONE_DEFAULT_ROLE = \"user\" # For setting the default service region on a per-endpoint basis. Note that the # default value for this setting is {}, and below is just an example of how it # should be specified. # A key of '*' is an optional global default if no other key matches. #DEFAULT_SERVICE_REGIONS = { # '*': 'RegionOne' # OPENSTACK_KEYSTONE_URL: 'RegionTwo' #} # Enables keystone web single-sign-on if set to True. #WEBSSO_ENABLED = False # Authentication mechanism to be selected as default. # The value must be a key from WEBSSO_CHOICES. #WEBSSO_INITIAL_CHOICE = \"credentials\" # The list of authentication mechanisms which include keystone # federation protocols and identity provider/federation protocol # mapping keys (WEBSSO_IDP_MAPPING). Current supported protocol # IDs are 'saml2' and 'oidc' which represent SAML 2.0, OpenID # Connect respectively. # Do not remove the mandatory credentials mechanism. # Note: The last two tuples are sample mapping keys to a identity provider # and federation protocol combination (WEBSSO_IDP_MAPPING). #WEBSSO_CHOICES = ( # (\"credentials\", _(\"Keystone Credentials\")), # (\"oidc\", _(\"OpenID Connect\")), # (\"saml2\", _(\"Security Assertion Markup Language\")), # (\"acme_oidc\", \"ACME - OpenID Connect\"), # (\"acme_saml2\", \"ACME - SAML2\"), #) # A dictionary of specific identity provider and federation protocol # combinations. From the selected authentication mechanism, the value # will be looked up as keys in the dictionary. If a match is found, # it will redirect the user to a identity provider and federation protocol # specific WebSSO endpoint in keystone, otherwise it will use the value # as the protocol_id when redirecting to the WebSSO by protocol endpoint. # NOTE: The value is expected to be a tuple formatted as: (, ). #WEBSSO_IDP_MAPPING = { # \"acme_oidc\": (\"acme\", \"oidc\"), # \"acme_saml2\": (\"acme\", \"saml2\"), #} # If set this URL will be used for web single-sign-on authentication # instead of OPENSTACK_KEYSTONE_URL. This is needed in the deployment # scenarios where network segmentation is used per security requirement. # In this case, the controllers are not reachable from public network. # Therefore, user's browser will not be able to access OPENSTACK_KEYSTONE_URL # if it is set to the internal endpoint. #WEBSSO_KEYSTONE_URL = \"http://keystone-public.example.com/v3\" # The Keystone Provider drop down uses Keystone to Keystone federation # to switch between Keystone service providers. # Set display name for Identity Provider (dropdown display name) #KEYSTONE_PROVIDER_IDP_NAME = \"Local Keystone\" # This id is used for only for comparison with the service provider IDs. This ID # should not match any service provider IDs. #KEYSTONE_PROVIDER_IDP_ID = \"localkeystone\" # Disable SSL certificate checks (useful for self-signed certificates): #OPENSTACK_SSL_NO_VERIFY = True # The CA certificate to use to verify SSL connections #OPENSTACK_SSL_CACERT = '/path/to/cacert.pem' # The OPENSTACK_KEYSTONE_BACKEND settings can be used to identify the # capabilities of the auth backend for Keystone. # If Keystone has been configured to use LDAP as the auth backend then set # can_edit_user to False and name to 'ldap'. # # TODO(tres): Remove these once Keystone has an API to identify auth backend. OPENSTACK_KEYSTONE_BACKEND = { 'name': 'native', 'can_edit_user': True, 'can_edit_group': True, 'can_edit_project': True, 'can_edit_domain': True, 'can_edit_role': True, } # Setting this to True, will add a new \"Retrieve Password\" action on instance, # allowing Admin session password retrieval/decryption. #OPENSTACK_ENABLE_PASSWORD_RETRIEVE = False # The Launch Instance user experience has been significantly enhanced. # You can choose whether to enable the new launch instance experience, # the legacy experience, or both. The legacy experience will be removed # in a future release, but is available as a temporary backup setting to ensure # compatibility with existing deployments. Further development will not be # done on the legacy experience. Please report any problems with the new # experience via the Launchpad tracking system. # # Toggle LAUNCH_INSTANCE_LEGACY_ENABLED and LAUNCH_INSTANCE_NG_ENABLED to # determine the experience to enable. Set them both to true to enable # both. #LAUNCH_INSTANCE_LEGACY_ENABLED = True #LAUNCH_INSTANCE_NG_ENABLED = False # A dictionary of settings which can be used to provide the default values for # properties found in the Launch Instance modal. #LAUNCH_INSTANCE_DEFAULTS = { # 'config_drive': False, # 'enable_scheduler_hints': True, # 'disable_image': False, # 'disable_instance_snapshot': False, # 'disable_volume': False, # 'disable_volume_snapshot': False, # 'create_volume': True, #} # The Xen Hypervisor has the ability to set the mount point for volumes # attached to instances (other Hypervisors currently do not). Setting # can_set_mount_point to True will add the option to set the mount point # from the UI. OPENSTACK_HYPERVISOR_FEATURES = { 'can_set_mount_point': False, 'can_set_password': False, 'requires_keypair': False, 'enable_quotas': True } # This settings controls whether IP addresses of servers are retrieved from # neutron in the project instance table. Setting this to ``False`` may mitigate # a performance issue in the project instance table in large deployments. #OPENSTACK_INSTANCE_RETRIEVE_IP_ADDRESSES = True # The OPENSTACK_CINDER_FEATURES settings can be used to enable optional # services provided by cinder that is not exposed by its extension API. OPENSTACK_CINDER_FEATURES = { 'enable_backup': False, } # The OPENSTACK_NEUTRON_NETWORK settings can be used to enable optional # services provided by neutron. Options currently available are load # balancer service, security groups, quotas, VPN service. OPENSTACK_NEUTRON_NETWORK = { 'enable_router': False, 'enable_quotas': False, 'enable_distributed_router': False, 'enable_ha_router': False, 'enable_lb': False, 'enable_firewall': False, 'enable_vpn': False, 'enable_fip_topology_check': False, # Default dns servers you would like to use when a subnet is # created. This is only a default, users can still choose a different # list of dns servers when creating a new subnet. # The entries below are examples only, and are not appropriate for # real deployments # 'default_dns_nameservers': [\"8.8.8.8\", \"8.8.4.4\", \"208.67.222.222\"], # Set which provider network types are supported. Only the network types # in this list will be available to choose from when creating a network. # Network types include local, flat, vlan, gre, vxlan and geneve. # 'supported_provider_types': ['*'], # You can configure available segmentation ID range per network type # in your deployment. # 'segmentation_id_range': { # 'vlan': [1024, 2048], # 'vxlan': [4094, 65536], # }, # You can define additional provider network types here. # 'extra_provider_types': { # 'awesome_type': { # 'display_name': 'Awesome New Type', # 'require_physical_network': False, # 'require_segmentation_id': True, # } # }, # Set which VNIC types are supported for port binding. Only the VNIC # types in this list will be available to choose from when creating a # port. # VNIC types include 'normal', 'direct', 'direct-physical', 'macvtap', # 'baremetal' and 'virtio-forwarder' # Set to empty list or None to disable VNIC type selection. 'supported_vnic_types': ['*'], # Set list of available physical networks to be selected in the physical # network field on the admin create network modal. If it's set to an empty # list, the field will be a regular input field. # e.g. ['default', 'test'] 'physical_networks': [], } # The OPENSTACK_HEAT_STACK settings can be used to disable password # field required while launching the stack. OPENSTACK_HEAT_STACK = { 'enable_user_pass': True, } # The OPENSTACK_IMAGE_BACKEND settings can be used to customize features # in the OpenStack Dashboard related to the Image service, such as the list # of supported image formats. #OPENSTACK_IMAGE_BACKEND = { # 'image_formats': [ # ('', _('Select format')), # ('aki', _('AKI - Amazon Kernel Image')), # ('ami', _('AMI - Amazon Machine Image')), # ('ari', _('ARI - Amazon Ramdisk Image')), # ('docker', _('Docker')), # ('iso', _('ISO - Optical Disk Image')), # ('ova', _('OVA - Open Virtual Appliance')), # ('qcow2', _('QCOW2 - QEMU Emulator')), # ('raw', _('Raw')), # ('vdi', _('VDI - Virtual Disk Image')), # ('vhd', _('VHD - Virtual Hard Disk')), # ('vhdx', _('VHDX - Large Virtual Hard Disk')), # ('vmdk', _('VMDK - Virtual Machine Disk')), # ], #} # The IMAGE_CUSTOM_PROPERTY_TITLES settings is used to customize the titles for # image custom property attributes that appear on image detail pages. IMAGE_CUSTOM_PROPERTY_TITLES = { \"architecture\": _(\"Architecture\"), \"kernel_id\": _(\"Kernel ID\"), \"ramdisk_id\": _(\"Ramdisk ID\"), \"image_state\": _(\"Euca2ools state\"), \"project_id\": _(\"Project ID\"), \"image_type\": _(\"Image Type\"), } # The IMAGE_RESERVED_CUSTOM_PROPERTIES setting is used to specify which image # custom properties should not be displayed in the Image Custom Properties # table. IMAGE_RESERVED_CUSTOM_PROPERTIES = [] # Set to 'legacy' or 'direct' to allow users to upload images to glance via # Horizon server. When enabled, a file form field will appear on the create # image form. If set to 'off', there will be no file form field on the create # image form. See documentation for deployment considerations. #HORIZON_IMAGES_UPLOAD_MODE = 'legacy' # Allow a location to be set when creating or updating Glance images. # If using Glance V2, this value should be False unless the Glance # configuration and policies allow setting locations. #IMAGES_ALLOW_LOCATION = False # A dictionary of default settings for create image modal. #CREATE_IMAGE_DEFAULTS = { # 'image_visibility': \"public\", #} # OPENSTACK_ENDPOINT_TYPE specifies the endpoint type to use for the endpoints # in the Keystone service catalog. Use this setting when Horizon is running # external to the OpenStack environment. The default is 'publicURL'. #OPENSTACK_ENDPOINT_TYPE = \"publicURL\" # SECONDARY_ENDPOINT_TYPE specifies the fallback endpoint type to use in the # case that OPENSTACK_ENDPOINT_TYPE is not present in the endpoints # in the Keystone service catalog. Use this setting when Horizon is running # external to the OpenStack environment. The default is None. This # value should differ from OPENSTACK_ENDPOINT_TYPE if used. #SECONDARY_ENDPOINT_TYPE = None # The number of objects (Swift containers/objects or images) to display # on a single page before providing a paging element (a \"more\" link) # to paginate results. API_RESULT_LIMIT = 1000 API_RESULT_PAGE_SIZE = 20 # The size of chunk in bytes for downloading objects from Swift SWIFT_FILE_TRANSFER_CHUNK_SIZE = 512 * 1024 # The default number of lines displayed for instance console log. INSTANCE_LOG_LENGTH = 35 # Specify a maximum number of items to display in a dropdown. DROPDOWN_MAX_ITEMS = 30 # The timezone of the server. This should correspond with the timezone # of your entire OpenStack installation, and hopefully be in UTC. TIME_ZONE = \"Asia/Shanghai\" # When launching an instance, the menu of available flavors is # sorted by RAM usage, ascending. If you would like a different sort order, # you can provide another flavor attribute as sorting key. Alternatively, you # can provide a custom callback method to use for sorting. You can also provide # a flag for reverse sort. For more info, see # http://docs.python.org/2/library/functions.html#sorted #CREATE_INSTANCE_FLAVOR_SORT = { # 'key': 'name', # # or # 'key': my_awesome_callback_method, # 'reverse': False, #} # Set this to True to display an 'Admin Password' field on the Change Password # form to verify that it is indeed the admin logged-in who wants to change # the password. #ENFORCE_PASSWORD_CHECK = False # Modules that provide /auth routes that can be used to handle different types # of user authentication. Add auth plugins that require extra route handling to # this list. #AUTHENTICATION_URLS = [ # 'openstack_auth.urls', #] # The Horizon Policy Enforcement engine uses these values to load per service # policy rule files. The content of these files should match the files the # OpenStack services are using to determine role based access control in the # target installation. # Path to directory containing policy.json files POLICY_FILES_PATH = '/etc/openstack-dashboard' # Map of local copy of service policy files. # Please insure that your identity policy file matches the one being used on # your keystone servers. There is an alternate policy file that may be used # in the Keystone v3 multi-domain case, policy.v3cloudsample.json. # This file is not included in the Horizon repository by default but can be # found at # http://git.openstack.org/cgit/openstack/keystone/tree/etc/ \\ # policy.v3cloudsample.json # Having matching policy files on the Horizon and Keystone servers is essential # for normal operation. This holds true for all services and their policy files. #POLICY_FILES = { # 'identity': 'keystone_policy.json', # 'compute': 'nova_policy.json', # 'volume': 'cinder_policy.json', # 'image': 'glance_policy.json', # 'network': 'neutron_policy.json', #} # Change this patch to the appropriate list of tuples containing # a key, label and static directory containing two files: # _variables.scss and _styles.scss #AVAILABLE_THEMES = [ # ('default', 'Default', 'themes/default'), # ('material', 'Material', 'themes/material'), #] LOGGING = { 'version': 1, # When set to True this will disable all logging except # for loggers specified in this configuration dictionary. Note that # if nothing is specified here and disable_existing_loggers is True, # django.db.backends will still log unless it is disabled explicitly. 'disable_existing_loggers': False, # If apache2 mod_wsgi is used to deploy OpenStack dashboard # timestamp is output by mod_wsgi. If WSGI framework you use does not # output timestamp for logging, add %(asctime)s in the following # format definitions. 'formatters': { 'console': { 'format': '%(levelname)s %(name)s %(message)s' }, 'operation': { # The format of \"%(message)s\" is defined by # OPERATION_LOG_OPTIONS['format'] 'format': '%(message)s' }, }, 'handlers': { 'null': { 'level': 'DEBUG', 'class': 'logging.NullHandler', }, 'console': { # Set the level to \"DEBUG\" for verbose output logging. 'level': 'INFO', 'class': 'logging.StreamHandler', 'formatter': 'console', }, 'operation': { 'level': 'INFO', 'class': 'logging.StreamHandler', 'formatter': 'operation', }, }, 'loggers': { 'horizon': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'horizon.operation_log': { 'handlers': ['operation'], 'level': 'INFO', 'propagate': False, }, 'openstack_dashboard': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'novaclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'cinderclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'keystoneauth': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'keystoneclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'glanceclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'neutronclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'swiftclient': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'oslo_policy': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'openstack_auth': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, 'django': { 'handlers': ['console'], 'level': 'DEBUG', 'propagate': False, }, # Logging from django.db.backends is VERY verbose, send to null # by default. 'django.db.backends': { 'handlers': ['null'], 'propagate': False, }, 'requests': { 'handlers': ['null'], 'propagate': False, }, 'urllib3': { 'handlers': ['null'], 'propagate': False, }, 'chardet.charsetprober': { 'handlers': ['null'], 'propagate': False, }, 'iso8601': { 'handlers': ['null'], 'propagate': False, }, 'scss': { 'handlers': ['null'], 'propagate': False, }, }, } # 'direction' should not be specified for all_tcp/udp/icmp. # It is specified in the form. SECURITY_GROUP_RULES = { 'all_tcp': { 'name': _('All TCP'), 'ip_protocol': 'tcp', 'from_port': '1', 'to_port': '65535', }, 'all_udp': { 'name': _('All UDP'), 'ip_protocol': 'udp', 'from_port': '1', 'to_port': '65535', }, 'all_icmp': { 'name': _('All ICMP'), 'ip_protocol': 'icmp', 'from_port': '-1', 'to_port': '-1', }, 'ssh': { 'name': 'SSH', 'ip_protocol': 'tcp', 'from_port': '22', 'to_port': '22', }, 'smtp': { 'name': 'SMTP', 'ip_protocol': 'tcp', 'from_port': '25', 'to_port': '25', }, 'dns': { 'name': 'DNS', 'ip_protocol': 'tcp', 'from_port': '53', 'to_port': '53', }, 'http': { 'name': 'HTTP', 'ip_protocol': 'tcp', 'from_port': '80', 'to_port': '80', }, 'pop3': { 'name': 'POP3', 'ip_protocol': 'tcp', 'from_port': '110', 'to_port': '110', }, 'imap': { 'name': 'IMAP', 'ip_protocol': 'tcp', 'from_port': '143', 'to_port': '143', }, 'ldap': { 'name': 'LDAP', 'ip_protocol': 'tcp', 'from_port': '389', 'to_port': '389', }, 'https': { 'name': 'HTTPS', 'ip_protocol': 'tcp', 'from_port': '443', 'to_port': '443', }, 'smtps': { 'name': 'SMTPS', 'ip_protocol': 'tcp', 'from_port': '465', 'to_port': '465', }, 'imaps': { 'name': 'IMAPS', 'ip_protocol': 'tcp', 'from_port': '993', 'to_port': '993', }, 'pop3s': { 'name': 'POP3S', 'ip_protocol': 'tcp', 'from_port': '995', 'to_port': '995', }, 'ms_sql': { 'name': 'MS SQL', 'ip_protocol': 'tcp', 'from_port': '1433', 'to_port': '1433', }, 'mysql': { 'name': 'MYSQL', 'ip_protocol': 'tcp', 'from_port': '3306', 'to_port': '3306', }, 'rdp': { 'name': 'RDP', 'ip_protocol': 'tcp', 'from_port': '3389', 'to_port': '3389', }, } # Deprecation Notice: # # The setting FLAVOR_EXTRA_KEYS has been deprecated. # Please load extra spec metadata into the Glance Metadata Definition Catalog. # # The sample quota definitions can be found in: # /etc/metadefs/compute-quota.json # # The metadata definition catalog supports CLI and API: # $glance --os-image-api-version 2 help md-namespace-import # $glance-manage db_load_metadefs # # See Metadata Definitions on: # https://docs.openstack.org/glance/latest/user/glancemetadefcatalogapi.html # The hash algorithm to use for authentication tokens. This must # match the hash algorithm that the identity server and the # auth_token middleware are using. Allowed values are the # algorithms supported by Python's hashlib library. #OPENSTACK_TOKEN_HASH_ALGORITHM = 'md5' # AngularJS requires some settings to be made available to # the client side. Some settings are required by in-tree / built-in horizon # features. These settings must be added to REST_API_REQUIRED_SETTINGS in the # form of ['SETTING_1','SETTING_2'], etc. # # You may remove settings from this list for security purposes, but do so at # the risk of breaking a built-in horizon feature. These settings are required # for horizon to function properly. Only remove them if you know what you # are doing. These settings may in the future be moved to be defined within # the enabled panel configuration. # You should not add settings to this list for out of tree extensions. # See: https://wiki.openstack.org/wiki/Horizon/RESTAPI REST_API_REQUIRED_SETTINGS = ['OPENSTACK_HYPERVISOR_FEATURES', 'LAUNCH_INSTANCE_DEFAULTS', 'OPENSTACK_IMAGE_FORMATS', 'OPENSTACK_KEYSTONE_BACKEND', 'OPENSTACK_KEYSTONE_DEFAULT_DOMAIN', 'CREATE_IMAGE_DEFAULTS', 'ENFORCE_PASSWORD_CHECK'] # Additional settings can be made available to the client side for # extensibility by specifying them in REST_API_ADDITIONAL_SETTINGS # !! Please use extreme caution as the settings are transferred via HTTP/S # and are not encrypted on the browser. This is an experimental API and # may be deprecated in the future without notice. #REST_API_ADDITIONAL_SETTINGS = [] # DISALLOW_IFRAME_EMBED can be used to prevent Horizon from being embedded # within an iframe. Legacy browsers are still vulnerable to a Cross-Frame # Scripting (XFS) vulnerability, so this option allows extra security hardening # where iframes are not used in deployment. Default setting is True. # For more information see: # http://tinyurl.com/anticlickjack #DISALLOW_IFRAME_EMBED = True # Help URL can be made available for the client. To provide a help URL, edit the # following attribute to the URL of your choice. #HORIZON_CONFIG[\"help_url\"] = \"http://openstack.mycompany.org\" # Settings for OperationLogMiddleware # OPERATION_LOG_ENABLED is flag to use the function to log an operation on # Horizon. # mask_targets is arrangement for appointing a target to mask. # method_targets is arrangement of HTTP method to output log. # format is the log contents. #OPERATION_LOG_ENABLED = False #OPERATION_LOG_OPTIONS = { # 'mask_fields': ['password'], # 'target_methods': ['POST'], # 'ignored_urls': ['/js/', '/static/', '^/api/'], # 'format': (\"[%(client_ip)s] [%(domain_name)s]\" # \" [%(domain_id)s] [%(project_name)s]\" # \" [%(project_id)s] [%(user_name)s] [%(user_id)s] [%(request_scheme)s]\" # \" [%(referer_url)s] [%(request_url)s] [%(message)s] [%(method)s]\" # \" [%(http_status)s] [%(param)s]\"), #} # The default date range in the Overview panel meters - either minus N # days (if the value is integer N), or from the beginning of the current month # until today (if set to None). This setting should be used to limit the amount # of data fetched by default when rendering the Overview panel. #OVERVIEW_DAYS_RANGE = 1 # To allow operators to require users provide a search criteria first # before loading any data into the views, set the following dict # attributes to True in each one of the panels you want to enable this feature. # Follow the convention . #FILTER_DATA_FIRST = { # 'admin.instances': False, # 'admin.images': False, # 'admin.networks': False, # 'admin.routers': False, # 'admin.volumes': False, # 'identity.users': False, # 'identity.projects': False, # 'identity.groups': False, # 'identity.roles': False #} # Dict used to restrict user private subnet cidr range. # An empty list means that user input will not be restricted # for a corresponding IP version. By default, there is # no restriction for IPv4 or IPv6. To restrict # user private subnet cidr range set ALLOWED_PRIVATE_SUBNET_CIDR # to something like #ALLOWED_PRIVATE_SUBNET_CIDR = { # 'ipv4': ['10.0.0.0/8', '192.168.0.0/16'], # 'ipv6': ['fc00::/7'] #} ALLOWED_PRIVATE_SUBNET_CIDR = {'ipv4': [], 'ipv6': []} # Projects and users can have extra attributes as defined by keystone v3. # Horizon has the ability to display these extra attributes via this setting. # If you'd like to display extra data in the project or user tables, set the # corresponding dict key to the attribute name, followed by the display name. # For more information, see horizon's customization # (https://docs.openstack.org/horizon/latest/configuration/customizing.html#horizon-customization-module-overrides) #PROJECT_TABLE_EXTRA_INFO = { # 'phone_num': _('Phone Number'), #} #USER_TABLE_EXTRA_INFO = { # 'phone_num': _('Phone Number'), #} # Password will have an expiration date when using keystone v3 and enabling the # feature. # This setting allows you to set the number of days that the user will be alerted # prior to the password expiration. # Once the password expires keystone will deny the access and users must # contact an admin to change their password. #PASSWORD_EXPIRES_WARNING_THRESHOLD_DAYS = 0 md5sum /etc/openstack-dashboard/local_settings 0e53f197affdd94c9e25a4f6f7fdf14b /etc/openstack-dashboard/local_settings 7.3 ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™åç»­è®¿é—®dashboardä¼šæŠ¥500é”™è¯¯ /etc/httpd/conf.d/openstack-dashboard.confå¦‚æœä¸åŒ…å«ä»¥ä¸‹å†…å®¹ï¼Œè¯·æ·»åŠ ä»¥ä¸‹è¡Œ sed -i.bak '3aWSGIApplicationGroup %{GLOBAL}' \\ /etc/httpd/conf.d/openstack-dashboard.conf #é‡å¯httpdå’Œmemcache systemctl restart httpd.service memcached.service 7.4 ç™»é™†dashboard 10.0.0.11/dashboard åŸŸï¼šdefault ç”¨æˆ·åï¼šadmin å¯†ç ï¼šADMIN_PASS ç™»é™†åé¦–ç•Œé¢ å…«ã€æ§åˆ¶èŠ‚ç‚¹å’Œå­˜å‚¨èŠ‚ç‚¹å—å­˜å‚¨æœåŠ¡cinderå®‰è£… rockyç‰ˆå—å­˜å‚¨cinderå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ å®˜æ–¹å¯¹cidneræœåŠ¡çš„è¯´æ˜ æœ¬èŠ‚ä»‹ç»å¦‚ä½•ä¸ºå—å­˜å‚¨æœåŠ¡å®‰è£…å’Œé…ç½®å­˜å‚¨èŠ‚ç‚¹ã€‚ä¸ºç®€å•èµ·è§ï¼Œæ­¤é…ç½®å¼•ç”¨ä¸€ä¸ªå…·æœ‰ç©ºæœ¬åœ°å—å­˜å‚¨è®¾å¤‡çš„å­˜å‚¨èŠ‚ç‚¹ã€‚æŒ‡ä»¤ä½¿ç”¨/dev/sdbï¼Œä½†æ˜¯æ‚¨å¯ä»¥å°†ç‰¹å®šèŠ‚ç‚¹æ›¿æ¢ä¸ºå…¶ä»–å€¼ã€‚ è¯¥æœåŠ¡ä½¿ç”¨LVMé©±åŠ¨ç¨‹åºåœ¨è¯¥è®¾å¤‡ä¸Šç½®å¤‡é€»è¾‘å·ï¼Œ å¹¶é€šè¿‡iSCSIä¼ è¾“å°†å…¶æä¾›ç»™å®ä¾‹ã€‚æ‚¨å¯ä»¥å¯¹è¿™äº›è¯´æ˜è¿›è¡Œå°‘é‡ä¿®æ”¹ï¼Œä»¥é€šè¿‡å…¶ä»–å­˜å‚¨èŠ‚ç‚¹æ°´å¹³æ‰©å±•æ‚¨çš„ç¯å¢ƒã€‚ cinderç›¸å…³æœåŠ¡ æœåŠ¡å è¯´æ˜ cinder-volume æä¾›å­˜å‚¨ç©ºé—´ï¼ŒåŒ…æ‹¬lvmã€nfsã€glusterfsã€cephç­‰ç­‰å­˜å‚¨ cinder-api æ¥æ”¶å¤–éƒ¨çš„apiè¯·æ±‚ cinder-scheduler è°ƒåº¦å™¨ï¼Œå†³å®šç”±å“ªä¸€ä¸ªcinder-volumeæä¾›å­˜å‚¨ç©ºé—´ cinder-backup å¤‡ä»½åˆ›å»ºçš„å· å®‰è£…å’Œé…ç½®æ§åˆ¶èŠ‚ç‚¹ rockyç‰ˆæ§åˆ¶èŠ‚ç‚¹å—å­˜å‚¨æœåŠ¡cinderå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ 8.1 åˆ›å»ºcinderæ•°æ®åº“å¹¶æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ mysql -e \"CREATE DATABASE cinder;\" mysql -e \"GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'localhost' \\ IDENTIFIED BY 'CINDER_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'%' \\ IDENTIFIED BY 'CINDER_DBPASS';\" 8.2 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—® source /opt/admin-openrc 8.3 åˆ›å»ºæœåŠ¡å‡­è¯ 8.3.1 åˆ›å»ºcinderç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸ºCIDNER_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default --password CINDER_PASS cinder +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | 65b5343859e6409994d007f2de30570b | | name | cinder | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ #äº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default --password-prompt cinder 8.3.2 å°†adminè§’è‰²æ·»åŠ åˆ°cinderç”¨æˆ· openstack role add --project service --user cinder admin 8.3.3 åˆ›å»ºcinderv2å’Œcinderv3æœåŠ¡å®ä½“ âš ï¸å—å­˜å‚¨æœåŠ¡éœ€è¦ä¸¤ä¸ªæœåŠ¡å®ä½“ openstack service create --name cinderv2 \\ --description \"OpenStack Block Storage\" volumev2 +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Block Storage | | enabled | True | | id | efcdff53520142d2ac6b0953cf532340 | | name | cinderv2 | | type | volumev2 | +-------------+----------------------------------+ openstack service create --name cinderv3 \\ --description \"OpenStack Block Storage\" volumev3 +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Block Storage | | enabled | True | | id | 910b223e07244359ae0480d579a0231a | | name | cinderv3 | | type | volumev3 | +-------------+----------------------------------+ 8.4 åˆ›å»ºå—å­˜å‚¨æœåŠ¡APIç«¯ç‚¹ cinderv2 openstack endpoint create --region RegionOne \\ volumev2 public http://controller:8776/v2/%\\(project_id\\)s +--------------+------------------------------------------+ | Field | Value | +--------------+------------------------------------------+ | enabled | True | | id | dcd7a491205f4c8a8a1af94fbd95d452 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | efcdff53520142d2ac6b0953cf532340 | | service_name | cinderv2 | | service_type | volumev2 | | url | http://controller:8776/v2/%(project_id)s | +--------------+------------------------------------------+ openstack endpoint create --region RegionOne \\ volumev2 internal http://controller:8776/v2/%\\(project_id\\)s +--------------+------------------------------------------+ | Field | Value | +--------------+------------------------------------------+ | enabled | True | | id | e044f276dd624336b5c4bb51aa343a55 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | efcdff53520142d2ac6b0953cf532340 | | service_name | cinderv2 | | service_type | volumev2 | | url | http://controller:8776/v2/%(project_id)s | +--------------+------------------------------------------+ openstack endpoint create --region RegionOne \\ volumev2 admin http://controller:8776/v2/%\\(project_id\\)s +--------------+------------------------------------------+ | Field | Value | +--------------+------------------------------------------+ | enabled | True | | id | e9c888a00e354a2cab3035b70b9e6c30 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | efcdff53520142d2ac6b0953cf532340 | | service_name | cinderv2 | | service_type | volumev2 | | url | http://controller:8776/v2/%(project_id)s | +--------------+------------------------------------------+ cinderv3 openstack endpoint create --region RegionOne \\ volumev3 public http://controller:8776/v3/%\\(project_id\\)s +--------------+------------------------------------------+ | Field | Value | +--------------+------------------------------------------+ | enabled | True | | id | 4f818560bac745dfa493dc53b3106cc3 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 910b223e07244359ae0480d579a0231a | | service_name | cinderv3 | | service_type | volumev3 | | url | http://controller:8776/v3/%(project_id)s | +--------------+------------------------------------------+ openstack endpoint create --region RegionOne \\ volumev3 internal http://controller:8776/v3/%\\(project_id\\)s +--------------+------------------------------------------+ | Field | Value | +--------------+------------------------------------------+ | enabled | True | | id | e102e7b28f5f47409e4e231af0af4776 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 910b223e07244359ae0480d579a0231a | | service_name | cinderv3 | | service_type | volumev3 | | url | http://controller:8776/v3/%(project_id)s | +--------------+------------------------------------------+ openstack endpoint create --region RegionOne \\ volumev3 admin http://controller:8776/v3/%\\(project_id\\)s +--------------+------------------------------------------+ | Field | Value | +--------------+------------------------------------------+ | enabled | True | | id | 4585dc9397b041b7a1a45d063d515dcb | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 910b223e07244359ae0480d579a0231a | | service_name | cinderv3 | | service_type | volumev3 | | url | http://controller:8776/v3/%(project_id)s | +--------------+------------------------------------------+ 8.5 å®‰è£…å’Œé…ç½®ç»„ä»¶ 8.5.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-cinder 8.5.2 ç¼–è¾‘/etc/cinder/cinder.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨è¯¥[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—®ï¼š [database] # ... connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder 2.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—è®¿é—®ï¼š [DEFAULT] # ... transport_url = rabbit://openstack:RABBIT_PASS@controller 3.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š [DEFAULT] # ... auth_strategy = keystone [keystone_authtoken] # ... www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_id = default user_domain_id = default project_name = service username = cinder password = CINDER_PASS 4.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®my_ipé€‰é¡¹ä»¥ä½¿ç”¨æ§åˆ¶å™¨èŠ‚ç‚¹çš„ç®¡ç†æ¥å£IPåœ°å€ï¼š [DEFAULT] # ... my_ip = 10.0.0.11 5.åœ¨è¯¥[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ï¼š [oslo_concurrency] # ... lock_path = /var/lib/cinder/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/cinder/cinder.conf{,.bak} grep '^[a-Z\\[]' /etc/cinder/cinder.conf.bak > /etc/cinder/cinder.conf openstack-config --set /etc/cinder/cinder.conf database connection mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder openstack-config --set /etc/cinder/cinder.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller openstack-config --set /etc/cinder/cinder.conf DEFAULT auth_strategy keystone openstack-config --set /etc/cinder/cinder.conf DEFAULT my_ip 10.0.0.11 openstack-config --set /etc/cinder/cinder.conf keystone_authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_url http://controller:5000 openstack-config --set /etc/cinder/cinder.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_type password openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_domain_id default openstack-config --set /etc/cinder/cinder.conf keystone_authtoken user_domain_id default openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_name service openstack-config --set /etc/cinder/cinder.conf keystone_authtoken username cinder openstack-config --set /etc/cinder/cinder.conf keystone_authtoken password CINDER_PASS openstack-config --set /etc/cinder/cinder.conf oslo_concurrency lock_path /var/lib/cinder/tmp MD5å€¼ md5sum /etc/cinder/cinder.conf 7fd4cf1f205df40cb8f01a280110988e /etc/cinder/cinder.conf 8.5.3 åŒæ­¥æ•°æ®åº“ $ su -s /bin/sh -c \"cinder-manage db sync\" cinder Deprecated: Option \"logdir\" from group \"DEFAULT\" is deprecated. Use option \"log-dir\" from group \"DEFAULT\" #æœ‰è¡¨å³ä¸ºæ­£ç¡® mysql cinder -e \"show tables\"|wc -l 36 8.6 é…ç½®è®¡ç®—å·²ä½¿ç”¨å—å­˜å‚¨ ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å‘å…¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ openstack-config --set /etc/nova/nova.conf cinder os_region_name RegionOne MD5å€¼ md5sum /etc/nova/nova.conf a8f15dce52b4c6a2ae8f4768a20f66a5 /etc/nova/nova.conf 8.7 å®Œæˆå®‰è£… 8.7.1 é‡å¯Compute APIæœåŠ¡ systemctl restart openstack-nova-api.service 8.7.2 å¯åŠ¨å—å­˜å‚¨æœåŠ¡ï¼Œå¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨ systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service 8.8 éªŒè¯ è¿”å›çš„ç»“æœæ˜¯cinder-apiæä¾›çš„ï¼Œå¹¶ä¸”cinder-schedulerçš„çŠ¶æ€æ˜¯up cinder service-list +------------------+------------+------+---------+-------+----------------------------+-----------------+ | Binary | Host | Zone | Status | State | Updated_at | Disabled Reason | +------------------+------------+------+---------+-------+----------------------------+-----------------+ | cinder-scheduler | controller | nova | enabled | up | 2020-05-29T10:58:08.000000 | - | +------------------+------------+------+---------+-------+----------------------------+-----------------+ å®‰è£…å’Œé…ç½®å—å­˜å‚¨èŠ‚ç‚¹ rockyç‰ˆå—å­˜å‚¨èŠ‚ç‚¹å—å­˜å‚¨æœåŠ¡cinderå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ 8.8 å‰ææ¡ä»¶ 8.8.1 å®‰è£…åŒ… yum -y install lvm2 device-mapper-persistent-data openstack-utils.noarch 8.8.2 å¯åŠ¨LVMå…ƒæ•°æ®æœåŠ¡ï¼Œå¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ systemctl enable lvm2-lvmetad.service systemctl start lvm2-lvmetad.service 8.8.3 åˆ›å»ºLVMç‰©ç†å·/dev/sdb âš ï¸å¦‚æœæ˜¯åœ¨è™šæ‹Ÿæœºä¸­ï¼Œéœ€è¦æ·»åŠ ä¸€å—æ•°æ®ç›˜ï¼Œä½¿ç”¨å‘½ä»¤echo \"- - -\" >/sys/class/scsi_host/host0/scanå®ç°çƒ­åŠ è½½ï¼ˆä¸ä¸€å®šä¸ºhost0ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ•°å­—ï¼Œæ¯”å¦‚1ã€2ã€3ç­‰ï¼‰ æŸ¥çœ‹æ·»åŠ çš„ç£ç›˜ $ fdisk -l /dev/sdb Disk /dev/sdb: 5368 MB, 5368709120 bytes, 10485760 sectors Units = sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 4096 bytes I/O size (minimum/optimal): 4096 bytes / 4096 bytes åˆ›å»ºç‰©ç†å·pv $ pvcreate /dev/sdb Physical volume \"/dev/sdb\" successfully created 8.8.4 åˆ›å»ºLVMå·ç»„cinder-volumes $ vgcreate cinder-volumes /dev/sdb Volume group \"cinder-volumes\" successfully created 8.8.5 å…³äºlvmçš„é—®é¢˜ åªæœ‰å®ä¾‹å¯ä»¥è®¿é—®å—å­˜å‚¨å·ã€‚ä½†æ˜¯ï¼Œåº•å±‚æ“ä½œç³»ç»Ÿç®¡ç†ä¸å·å…³è”çš„è®¾å¤‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒLVMå·æ‰«æå·¥å…·ä¼šåœ¨/devç›®å½•ä¸­æ‰«æåŒ…å«å·çš„å—å­˜å‚¨è®¾å¤‡ã€‚å¦‚æœé¡¹ç›®åœ¨å…¶å·ä¸Šä½¿ç”¨LVMï¼Œåˆ™æ‰«æå·¥å…·ä¼šæ£€æµ‹åˆ°è¿™äº›å·å¹¶å°è¯•å¯¹å…¶è¿›è¡Œç¼“å­˜ï¼Œè¿™å¯èƒ½å¯¼è‡´åŸºç¡€æ“ä½œç³»ç»Ÿå·å’Œé¡¹ç›®å·å‡ºç°å„ç§é—®é¢˜ã€‚æ‚¨å¿…é¡»å°†LVMé‡æ–°é…ç½®ä¸ºä»…æ‰«æåŒ…å«cinder-volumeså·ç»„çš„è®¾å¤‡ âš ï¸âš ï¸âš ï¸ å¦‚æœå­˜å‚¨èŠ‚ç‚¹åœ¨æ“ä½œç³»ç»Ÿç£ç›˜ä¸Šä½¿ç”¨LVMï¼Œåˆ™è¿˜å¿…é¡»å°†å…³è”çš„è®¾å¤‡æ·»åŠ åˆ°è¿‡æ»¤å™¨ä¸­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ/dev/sdaè®¾å¤‡åŒ…å«æ“ä½œç³»ç»Ÿï¼š filter = [ \"a/sda/\", \"a/sdb/\", \"r/.*/\"] åŒæ ·ï¼Œå¦‚æœæ‚¨çš„è®¡ç®—èŠ‚ç‚¹åœ¨æ“ä½œç³»ç»Ÿç£ç›˜ä¸Šä½¿ç”¨LVMï¼Œåˆ™è¿˜å¿…é¡»/etc/lvm/lvm.confåœ¨è¿™äº›èŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶ä¸­ä¿®æ”¹è¿‡æ»¤å™¨ï¼Œ ä½¿å…¶ä»…åŒ…æ‹¬æ“ä½œç³»ç»Ÿç£ç›˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ/dev/sda è®¾å¤‡åŒ…å«æ“ä½œç³»ç»Ÿï¼š filter = [ \"a/sda/\", \"r/.*/\"] å› ä¸ºä½¿ç”¨çš„è™šæ‹Ÿæœºåœ¨å®‰è£…çš„æ—¶å€™æ˜¯é‡‡ç”¨çš„lvmï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶ä¸­åº”å½“æŠŠç³»ç»Ÿç›˜/dev/sdaä¹Ÿæ·»åŠ  ç¼–è¾‘ /etc/lvm/lvm.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ åœ¨è¯¥deviceséƒ¨åˆ†ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæ¥å—/dev/sdbè®¾å¤‡å¹¶æ‹’ç»æ‰€æœ‰å…¶ä»–è®¾å¤‡çš„è¿‡æ»¤ å™¨ï¼š devices { ... filter = [ \"a/sdb/\", \"r/.*/\"] #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/lvm/lvm.conf{,.bak} egrep -v '^$|#' /etc/lvm/lvm.conf.bak > /etc/lvm/lvm.conf sed -i '/^devices/a\\\\tfilter = [ \"a/sda/\", \"a/sdb/\", \"r/.*/\"]' /etc/lvm/lvm.conf MD5å€¼ md5sum /etc/lvm/lvm.conf f14b4b4075998bf20d1186089cfcdc40 /etc/lvm/lvm.conf æ»¤æ³¢å™¨é˜µåˆ—ä¸­çš„æ¯ä¸ªé¡¹ç›®å¼€å§‹äºaç”¨äºæ¥å—æˆ– rç”¨äºæ‹’ç»ï¼Œå¹¶ä¸”åŒ…æ‹¬ç”¨äºæ‰€è¿°è£…ç½®åç§°çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚è¯¥é˜µåˆ—å¿…é¡»r/.*/ä»¥æ‹’ç»ä»»ä½•å‰©ä½™çš„è®¾å¤‡ç»“å°¾ã€‚æ‚¨å¯ä»¥ä½¿ç”¨vgs -vvvvå‘½ä»¤æµ‹è¯•è¿‡æ»¤å™¨ 8.9 å®‰è£…å’Œé…ç½®ç»„ä»¶ 8.9.1 å®‰è£…è½¯ä»¶åŒ… targetcliæ˜¯iscsiçš„åŒ… yum -y install openstack-cinder targetcli python-keystone 8.9.2 ç¼–è¾‘/etc/cinder/cinder.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ âš ï¸åœ¨é…ç½®æ–‡ä»¶ä¸­çš„[DEFAULT]åŒºåŸŸï¼Œé»˜è®¤å®˜æ–¹å®šä¹‰çš„åç«¯lvmå·åç§°å°±æ˜¯lvmï¼Œè¿™ä¸ªåç§°æ˜¯ä»»æ„çš„ï¼Œå¹¶ä¸”DEFAULTåŒºåŸŸçš„enabled_backendså®šä¹‰çš„åç§°æ˜¯æœ‰å•ç‹¬çš„ä¸€ä¸ªåŒºåŸŸï¼Œä¾‹å¦‚ #defaultåŒºåŸŸå†…å®¹å¦‚ä¸‹ [DEFAULT] enabled_backends = lvm #åˆ™å¦‚ä¸‹åŒºåŸŸå†…å®¹å’ŒDEFAULTåŒºåŸŸå®šä¹‰çš„åç§°ä¸€ä¸€å¯¹åº”çš„ [lvm] volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver #é©±åŠ¨ volume_group = cinder-volumes #å·ç»„å iscsi_protocol = iscsi iscsi_helper = lioadm å¦‚æœæœ‰å¤šä¸ªlvmå·ï¼Œåˆ™DEFAULTåŒºåŸŸå¯ä»¥å†™æˆå¦‚ä¸‹ï¼Œå¹¶ä¸”æœ€åè¦å†™ä¸Šä¸€ä¸€å¯¹åº”çš„å†…å®¹ [DEFAULT] enabled_backends = lvm,lvm2,lvm3 #åæ®µåç§°ä»»æ„ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸ºæ™®é€šç£ç›˜sataï¼Œå›ºæ€ç¡¬ç›˜ssd [DEFAULT] enabled_backends = sata,ssd [sata] volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver volume_group = cinder-volumes iscsi_protocol = iscsi iscsi_helper = lioadm volume_backend_name = sata [ssd] volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver volume_group = cinder-ssd iscsi_protocol = iscsi iscsi_helper = lioadm volume_backend_name = ssd 1.åœ¨è¯¥[database]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ•°æ®åº“è®¿é—®ï¼š [database] # ... connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder 2.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—è®¿é—®ï¼š [DEFAULT] # ... transport_url = rabbit://openstack:RABBIT_PASS@controller 3.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š [DEFAULT] # ... auth_strategy = keystone [keystone_authtoken] # ... www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_id = default user_domain_id = default project_name = service username = cinder password = CINDER_PASS 4.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®my_ipé€‰é¡¹ï¼šæ›¿æ¢MANAGEMENT_INTERFACE_IP_ADDRESSä¸ºå­˜å‚¨èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œæ¥å£çš„IPåœ°å€ï¼Œå¯¹äºç¤ºä¾‹ä½“ç³»ç»“æ„ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šå¸¸ä¸º10.0.0.41 [DEFAULT] # ... my_ip = MANAGEMENT_INTERFACE_IP_ADDRESS 5.åœ¨è¯¥[lvm]éƒ¨åˆ†ä¸­ï¼Œä¸ºLVMåç«¯é…ç½®LVMé©±åŠ¨ç¨‹åºï¼Œcinder-volumeså·ç»„ï¼ŒiSCSIåè®®å’Œé€‚å½“çš„iSCSIæœåŠ¡ã€‚å¦‚æœè¯¥[lvm]éƒ¨åˆ†ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºå®ƒï¼š [lvm] volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver volume_group = cinder-volumes iscsi_protocol = iscsi iscsi_helper = lioadm 6.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨LVMåç«¯ï¼š åç«¯åç§°æ˜¯ä»»æ„çš„ã€‚ä¾‹å¦‚ï¼Œæœ¬æŒ‡å—ä½¿ç”¨é©±åŠ¨ç¨‹åºçš„åç§°ä½œä¸ºåç«¯çš„åç§°ã€‚ [DEFAULT] # ... enabled_backends = lvm 7.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®å›¾åƒæœåŠ¡APIçš„ä½ç½®ï¼š [DEFAULT] # ... glance_api_servers = http://controller:9292 8.åœ¨è¯¥[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ï¼š [oslo_concurrency] # ... lock_path = /var/lib/cinder/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/cinder/cinder.conf{,.bak} grep '^[a-Z\\[]' /etc/cinder/cinder.conf.bak > /etc/cinder/cinder.conf openstack-config --set /etc/cinder/cinder.conf database connection mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder openstack-config --set /etc/cinder/cinder.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller openstack-config --set /etc/cinder/cinder.conf DEFAULT auth_strategy keystone openstack-config --set /etc/cinder/cinder.conf DEFAULT my_ip 10.0.0.41 openstack-config --set /etc/cinder/cinder.conf DEFAULT enabled_backends lvm openstack-config --set /etc/cinder/cinder.conf DEFAULT glance_api_servers http://controller:9292 openstack-config --set /etc/cinder/cinder.conf keystone_authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_url http://controller:5000 openstack-config --set /etc/cinder/cinder.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_type password openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_domain_id default openstack-config --set /etc/cinder/cinder.conf keystone_authtoken user_domain_id default openstack-config --set /etc/cinder/cinder.conf keystone_authtoken project_name service openstack-config --set /etc/cinder/cinder.conf keystone_authtoken username cinder openstack-config --set /etc/cinder/cinder.conf keystone_authtoken password CINDER_PASS openstack-config --set /etc/cinder/cinder.conf lvm volume_driver cinder.volume.drivers.lvm.LVMVolumeDriver openstack-config --set /etc/cinder/cinder.conf lvm volume_group cinder-volumes openstack-config --set /etc/cinder/cinder.conf lvm iscsi_protocol iscsi openstack-config --set /etc/cinder/cinder.conf lvm iscsi_helper lioadm openstack-config --set /etc/cinder/cinder.conf oslo_concurrency lock_path /var/lib/cinder/tmp MD5å€¼ md5sum /etc/cinder/cinder.conf 07cc203c56289c1ed19d6f3daba7ec32 /etc/cinder/cinder.conf 8.9.3 å¯åŠ¨å—å­˜å‚¨å·æœåŠ¡åŠå…¶ç›¸å…³æ€§ï¼Œå¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨ systemctl enable openstack-cinder-volume.service target.service systemctl start openstack-cinder-volume.service target.service åˆ°æ­¤ï¼Œæ§åˆ¶èŠ‚ç‚¹å’Œå—å­˜å‚¨èŠ‚ç‚¹å—å­˜å‚¨æœåŠ¡cinderå®‰è£…å®Œæˆï¼ï¼ï¼ ä¹ã€æ§åˆ¶èŠ‚ç‚¹å’Œå¯¹è±¡èŠ‚ç‚¹å¯¹è±¡å­˜å‚¨æœåŠ¡swiftå®‰è£… OpenStackå¯¹è±¡å­˜å‚¨æ˜¯ä¸€ä¸ªå¤šç§Ÿæˆ·å¯¹è±¡å­˜å‚¨ç³»ç»Ÿã€‚å®ƒå…·æœ‰é«˜åº¦çš„å¯æ‰©å±•æ€§ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡RESTful HTTP APIä»¥ä½æˆæœ¬ç®¡ç†å¤§é‡éç»“æ„åŒ–æ•°æ®ã€‚ swiftç›¸å…³ç»„ä»¶ åç§° è¯´æ˜ ä»£ç†æœåŠ¡å™¨ï¼ˆswift-proxy-serverï¼‰ æ¥å—OpenStackå¯¹è±¡å­˜å‚¨APIå’ŒåŸå§‹HTTPè¯·æ±‚ï¼Œä»¥ä¸Šä¼ æ–‡ä»¶ï¼Œä¿®æ”¹å…ƒæ•°æ®å’Œåˆ›å»ºå®¹å™¨ã€‚å®ƒè¿˜å‘ç½‘ç»œæµè§ˆå™¨æä¾›æ–‡ä»¶æˆ–å®¹å™¨åˆ—è¡¨ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œä»£ç†æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨é€šå¸¸ä¸memcacheä¸€èµ·éƒ¨ç½²çš„å¯é€‰ç¼“å­˜ã€‚ å¸æˆ·æœåŠ¡å™¨ï¼ˆswift-account-serverï¼‰ ç®¡ç†ä½¿ç”¨å¯¹è±¡å­˜å‚¨å®šä¹‰çš„å¸æˆ· å®¹å™¨æœåŠ¡å™¨ï¼ˆswiftå®¹å™¨æœåŠ¡å™¨ï¼‰ åœ¨å¯¹è±¡å­˜å‚¨ä¸­ç®¡ç†å®¹å™¨æˆ–æ–‡ä»¶å¤¹çš„æ˜ å°„ å¯¹è±¡æœåŠ¡å™¨ï¼ˆswift-object-serverï¼‰ ç®¡ç†å­˜å‚¨èŠ‚ç‚¹ä¸Šçš„å®é™…å¯¹è±¡ï¼Œä¾‹å¦‚æ–‡ä»¶ å„ç§å‘¨æœŸæ€§è¿‡ç¨‹ åœ¨å¤§å‹æ•°æ®å­˜å‚¨ä¸Šæ‰§è¡Œå†…åŠ¡å¤„ç†ä»»åŠ¡ã€‚å¤åˆ¶æœåŠ¡å¯ç¡®ä¿æ•´ä¸ªç¾¤é›†çš„ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ã€‚å…¶ä»–å®šæœŸè¿‡ç¨‹åŒ…æ‹¬å®¡æ ¸å‘˜ï¼Œæ›´æ–°è€…å’Œæ”¶å‰²è€… WSGIä¸­é—´ä»¶ å¤„ç†èº«ä»½éªŒè¯ï¼Œé€šå¸¸æ˜¯OpenStackèº«ä»½ swift client ä½¿ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡æˆæƒä¸ºç®¡ç†å‘˜ç”¨æˆ·ï¼Œä»£ç†å•†ç”¨æˆ·æˆ–å¿«é€Ÿç”¨æˆ·çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯å°†å‘½ä»¤æäº¤åˆ°REST API swift-init è„šæœ¬åˆå§‹åŒ–ç¯æ–‡ä»¶çš„æ„å»ºï¼Œä»¥å®ˆæŠ¤ç¨‹åºåç§°ä½œä¸ºå‚æ•°å¹¶æä¾›å‘½ä»¤ã€‚è®°å½•åœ¨ https://docs.openstack.org/swift/latest/admin_guide.html#managing-servicesä¸­ swift-recon cliå·¥å…·ï¼Œç”¨äºæ£€ç´¢swift-reconä¸­é—´ä»¶å·²æ”¶é›†çš„æœ‰å…³ç¾¤é›†çš„å„ç§åº¦é‡å’Œé¥æµ‹ä¿¡æ¯ swift-ring-builder å­˜å‚¨ç¯æ„å»ºå’Œé‡æ–°å¹³è¡¡å®ç”¨ç¨‹åºã€‚åœ¨ https://docs.openstack.org/swift/latest/admin_guide.html#managing-the-ringsä¸­è®°å½• å®‰è£…å’Œé…ç½®æ§åˆ¶èŠ‚ç‚¹ rockyç‰ˆæ§åˆ¶èŠ‚ç‚¹å¯¹è±¡å­˜å‚¨æœåŠ¡swiftå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ 9.1 åˆ›å»ºèº«ä»½æœåŠ¡å‡­æ® 9.1.1 è·å–ç®¡ç†å‘˜å‡­æ®ä»¥è·å–å¯¹ä»…ç®¡ç†å‘˜CLIå‘½ä»¤çš„è®¿é—® source /opt/admin-openrc 9.1.2 åˆ›å»ºswiftç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸ºSWIFT_PASS //è¿™é‡Œäº¤äº’å¼åˆ›å»ºå¯†ç å’Œéäº¤äº’å¼é€‰æ‹©å…¶ä¸­ä¸€ç§ #éäº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default --password SWIFT_PASS swift +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | 312ab4f320434d30b76c9486463e2dea | | name | swift | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ #äº¤äº’å¼è®¾ç½®å¯†ç  openstack user create --domain default --password-prompt swift 9.1.3 å°†adminè§’è‰²æ·»åŠ åˆ°swiftç”¨æˆ· openstack role add --project service --user swift admin 9.1.4 åˆ›å»ºswiftæœåŠ¡å®ä½“ openstack service create --name swift \\ --description \"OpenStack Object Storage\" object-store +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Object Storage | | enabled | True | | id | a41ace8ca3bb42ec92e27a29503828e7 | | name | swift | | type | object-store | +-------------+----------------------------------+ 9.2 åˆ›å»ºå¯¹è±¡å­˜å‚¨æœåŠ¡APIç«¯ç‚¹ openstack endpoint create --region RegionOne \\ object-store public http://controller:8080/v1/AUTH_%\\(project_id\\)s +--------------+-----------------------------------------------+ | Field | Value | +--------------+-----------------------------------------------+ | enabled | True | | id | 25063822e1c947f38189af370d97a0c2 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | a41ace8ca3bb42ec92e27a29503828e7 | | service_name | swift | | service_type | object-store | | url | http://controller:8080/v1/AUTH_%(project_id)s | +--------------+-----------------------------------------------+ openstack endpoint create --region RegionOne \\ object-store internal http://controller:8080/v1/AUTH_%\\(project_id\\)s +--------------+-----------------------------------------------+ | Field | Value | +--------------+-----------------------------------------------+ | enabled | True | | id | 6f36da03e9344d84906f98a31a09ebe9 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | a41ace8ca3bb42ec92e27a29503828e7 | | service_name | swift | | service_type | object-store | | url | http://controller:8080/v1/AUTH_%(project_id)s | +--------------+-----------------------------------------------+ openstack endpoint create --region RegionOne \\ object-store admin http://controller:8080/v1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | ffe6a96aeb224d8abe3e0c3de6c9e072 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | a41ace8ca3bb42ec92e27a29503828e7 | | service_name | swift | | service_type | object-store | | url | http://controller:8080/v1 | +--------------+----------------------------------+ 9.3 å®‰è£…å’Œé…ç½®ç»„ä»¶ 9.3.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-swift-proxy python-swiftclient \\ python-keystoneclient python-keystonemiddleware memcached openstack-utils.noarch 9.3.2 ä»å¯¹è±¡å­˜å‚¨æºå­˜å‚¨åº“è·å–ä»£ç†æœåŠ¡é…ç½®æ–‡ä»¶ curl -o /etc/swift/proxy-server.conf https://opendev.org/openstack/swift/raw/branch/stable/rocky/etc/proxy-server.conf-sample 9.3.3 ç¼–è¾‘/etc/swift/proxy-server.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ âš ï¸âš ï¸âš ï¸è¿™é‡Œå®˜æ–¹æ–‡æ¡£æœ‰å‘ï¼Œqç‰ˆä¹‹åå°±ä¸ç”¨35357ç«¯å£äº†ï¼Œä½†æ˜¯æ–‡æ¡£ä¸­è¿˜æ˜¯å†™ç€auth_url = http://controller:35357ï¼Œè¿™é‡Œåº”è¯¥æ”¹æˆ5000ç«¯å£ï¼Œå¦åˆ™åç»­éªŒè¯swiftä¼šæŠ¥é”™500 1.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ç»‘å®šç«¯å£ï¼Œç”¨æˆ·å’Œé…ç½®ç›®å½•ï¼š [DEFAULT] ... bind_port = 8080 user = swift swift_dir = /etc/swift 2.åœ¨è¯¥[pipeline:main]éƒ¨åˆ†ä¸­ï¼Œåˆ é™¤tempurlå’Œ tempauthæ¨¡å—ï¼Œç„¶åæ·»åŠ authtokenå’Œkeystoneauth æ¨¡å— è¯·å‹¿æ›´æ”¹æ¨¡å—çš„é¡ºåºï¼ï¼ï¼ æœ‰å…³å¯ç”¨å…¶ä»–åŠŸèƒ½çš„å…¶ä»–æ¨¡å—çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒå¦‚ä¸‹åœ°å€ https://docs.openstack.org/swift/latest/deployment_guide.html [pipeline:main] pipeline = catch_errors gatekeeper healthcheck proxy-logging cache container_sync bulk ratelimit authtoken keystoneauth container-quotas account-quotas slo dlo versioned_writes proxy-logging proxy-server 3.åœ¨è¯¥[app:proxy-server]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨è‡ªåŠ¨å¸æˆ·åˆ›å»ºï¼š [app:proxy-server] use = egg:swift#proxy ... account_autocreate = True 4.åœ¨è¯¥[filter:keystoneauth]éƒ¨åˆ†ä¸­ï¼Œé…ç½®æ“ä½œå‘˜è§’è‰²ï¼š [filter:keystoneauth] use = egg:swift#keystoneauth ... operator_roles = admin,user 5.åœ¨è¯¥[filter:authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š [filter:authtoken] paste.filter_factory = keystonemiddleware.auth_token:filter_factory ... www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_id = default user_domain_id = default project_name = service username = swift password = SWIFT_PASS delay_auth_decision = True 6.åœ¨è¯¥[filter:cache]éƒ¨åˆ†ä¸­ï¼Œé…ç½®memcachedä½ç½®ï¼š [filter:cache] use = egg:swift#memcache ... memcache_servers = controller:11211 #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/swift/proxy-server.conf{,.bak} grep '^[a-Z\\[]' /etc/swift/proxy-server.conf.bak > /etc/swift/proxy-server.conf openstack-config --set /etc/swift/proxy-server.conf DEFAULT bind_port 8080 openstack-config --set /etc/swift/proxy-server.conf DEFAULT user swift openstack-config --set /etc/swift/proxy-server.conf DEFAULT swift_dir /etc/swift openstack-config --set /etc/swift/proxy-server.conf app:proxy-server use egg:swift#proxy openstack-config --set /etc/swift/proxy-server.conf app:proxy-server account_autocreate True openstack-config --set /etc/swift/proxy-server.conf filter:keystoneauth use egg:swift#keystoneauth openstack-config --set /etc/swift/proxy-server.conf filter:keystoneauth operator_roles admin,user openstack-config --set /etc/swift/proxy-server.conf filter:authtoken paste.filter_factory keystonemiddleware.auth_token:filter_factory openstack-config --set /etc/swift/proxy-server.conf filter:authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/swift/proxy-server.conf filter:authtoken auth_url http://controller:5000 openstack-config --set /etc/swift/proxy-server.conf filter:authtoken memcached_servers controller:11211 openstack-config --set /etc/swift/proxy-server.conf filter:authtoken auth_type password openstack-config --set /etc/swift/proxy-server.conf filter:authtoken project_domain_id default openstack-config --set /etc/swift/proxy-server.conf filter:authtoken user_domain_id default openstack-config --set /etc/swift/proxy-server.conf filter:authtoken project_name service openstack-config --set /etc/swift/proxy-server.conf filter:authtoken username swift openstack-config --set /etc/swift/proxy-server.conf filter:authtoken password SWIFT_PASS openstack-config --set /etc/swift/proxy-server.conf filter:authtoken delay_auth_decision True openstack-config --set /etc/swift/proxy-server.conf filter:cache use egg:swift#memcache openstack-config --set /etc/swift/proxy-server.conf filter:cache memcache_servers controller:11211 sed -i '/^pipeline/c pipeline = catch_errors gatekeeper healthcheck proxy-logging cache container_sync bulk ratelimit authtoken keystoneauth container-quotas account-quotas slo dlo versioned_writes proxy-logging proxy-server' /etc/swift/proxy-server.conf MD5å€¼ md5sum /etc/swift/proxy-server.conf 007b21d8dbe36156ff7fffff53e88f5a /etc/swift/proxy-server.conf å®‰è£…å’Œé…ç½®å¯¹è±¡èŠ‚ç‚¹(51,52) rockyç‰ˆå­˜å‚¨èŠ‚ç‚¹å¯¹è±¡å­˜å‚¨æœåŠ¡swiftå®‰è£…é…ç½®å®˜æ–¹æ–‡æ¡£ æœ¬èŠ‚ä»‹ç»å¦‚ä½•å®‰è£…å’Œé…ç½®ç”¨äºæ“ä½œå¸æˆ·ï¼Œå®¹å™¨å’Œå¯¹è±¡æœåŠ¡çš„å­˜å‚¨èŠ‚ç‚¹ã€‚ä¸ºç®€å•èµ·è§ï¼Œæ­¤é…ç½®å¼•ç”¨ä¸¤ä¸ªå­˜å‚¨èŠ‚ç‚¹ï¼Œæ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹åŒ…å«ä¸¤ä¸ªç©ºçš„æœ¬åœ°å—å­˜å‚¨è®¾å¤‡ã€‚æŒ‡ä»¤ä½¿ç”¨/dev/sdbå’Œ/dev/sdcï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä¸ºç‰¹å®šèŠ‚ç‚¹æ›¿æ¢ä¸åŒçš„å€¼ã€‚ å°½ç®¡å¯¹è±¡å­˜å‚¨æ”¯æŒå…·æœ‰æ‰©å±•å±æ€§ï¼ˆxattrï¼‰çš„ä»»ä½•æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•è¡¨æ˜XFSå…·æœ‰æœ€ä½³æ€§èƒ½å’Œå¯é æ€§ã€‚æœ‰å…³æ°´å¹³æ‰©å±•ç¯å¢ƒçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ã€Š éƒ¨ç½²æŒ‡å—ã€‹ã€‚ æœ¬éƒ¨åˆ†é€‚ç”¨äºRed Hat Enterprise Linux 7å’ŒCentOS 7 9.4 å‰ææ¡ä»¶ 9.4.1 å®‰è£…è½¯ä»¶åŒ… yum -y install xfsprogs rsync 9.4.2 å°†/dev/sdbå’Œ/dev/sdcè®¾å¤‡æ ¼å¼åŒ–ä¸ºXFS mkfs.xfs /dev/sdb mkfs.xfs /dev/sdc 9.4.3 åˆ›å»ºå®‰è£…ç‚¹ç›®å½•ç»“æ„ mkdir -p /srv/node/sdb mkdir -p /srv/node/sdc 9.4.4 ç¼–è¾‘/etc/fstabæ–‡ä»¶å¹¶å‘å…¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ cp /etc/fstab{,.bak} cat >> /etc/fstab 9.4.5 æŒ‚è½½ç›®å½• mount /srv/node/sdb mount /srv/node/sdc 9.4.6 åˆ›å»ºæˆ–ç¼–è¾‘/etc/rsyncd.confæ–‡ä»¶ä»¥åŒ…å«ä»¥ä¸‹å†…å®¹ è¯¥rsyncæœåŠ¡ä¸éœ€è¦èº«ä»½éªŒè¯ï¼Œå› æ­¤è¯·è€ƒè™‘åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¸“ç”¨ç½‘ç»œä¸Šè¿è¡Œå®ƒã€‚ æ›¿æ¢MANAGEMENT_INTERFACE_IP_ADDRESSä¸ºå­˜å‚¨èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œçš„IPåœ°å€ #10.0.0.51 \\cp /etc/rsyncd{,.bak} cat > /etc/rsyncd.conf /etc/rsyncd.conf 9.5 å®‰è£…å’Œé…ç½®ç»„ä»¶ âš ï¸åœ¨æ¯ä¸ªå¯¹è±¡èŠ‚ç‚¹(51,52)ä¸Šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ 9.5.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-swift-account openstack-swift-container \\ openstack-swift-object openstack-utils.noarch 9.5.2 ä»å¯¹è±¡å­˜å‚¨æºå­˜å‚¨åº“ä¸­è·å–è®¡è´¹ï¼Œå®¹å™¨å’Œå¯¹è±¡æœåŠ¡é…ç½®æ–‡ä»¶ curl -o /etc/swift/account-server.conf https://opendev.org/openstack/swift/raw/branch/stable/rocky/etc/account-server.conf-sample curl -o /etc/swift/container-server.conf https://opendev.org/openstack/swift/raw/branch/stable/rocky/etc/container-server.conf-sample curl -o /etc/swift/object-server.conf https://opendev.org/openstack/swift/raw/branch/stable/rocky/etc/object-server.conf-sample 9.5.3 ç¼–è¾‘/etc/swift/account-server.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æ­¤[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ç»‘å®šIPåœ°å€ï¼Œç»‘å®šç«¯å£ï¼Œç”¨æˆ·ï¼Œé…ç½®ç›®å½•å’Œå®‰è£…ç‚¹ç›®å½•ï¼šæ›¿æ¢MANAGEMENT_INTERFACE_IP_ADDRESSä¸ºå­˜å‚¨èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œçš„IPåœ°å€ã€‚ [DEFAULT] ... bind_ip = MANAGEMENT_INTERFACE_IP_ADDRESS bind_port = 6202 user = swift swift_dir = /etc/swift devices = /srv/node mount_check = True 2.åœ¨è¯¥[pipeline:main]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨é€‚å½“çš„æ¨¡å—ï¼š æœ‰å…³å¯ç”¨å…¶ä»–åŠŸèƒ½çš„å…¶ä»–æ¨¡å—çš„æ›´å¤šä¿¡æ¯ï¼Œå‚è€ƒå¦‚ä¸‹åœ°å€ https://docs.openstack.org/swift/latest/deployment_guide.html [pipeline:main] pipeline = healthcheck recon account-server 3.åœ¨è¯¥[filter:recon]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ä¾¦å¯Ÿï¼ˆè®¡é‡ï¼‰ç¼“å­˜ç›®å½•ï¼š [filter:recon] use = egg:swift#recon ... recon_cache_path = /var/cache/swift #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ #10.0.0.51 \\cp /etc/swift/account-server.conf{,.bak} grep '^[a-Z\\[]' /etc/swift/account-server.conf.bak > /etc/swift/account-server.conf openstack-config --set /etc/swift/account-server.conf DEFAULT bind_ip 10.0.0.51 openstack-config --set /etc/swift/account-server.conf DEFAULT bind_port 6202 openstack-config --set /etc/swift/account-server.conf DEFAULT user swift openstack-config --set /etc/swift/account-server.conf DEFAULT swift_dir /etc/swift openstack-config --set /etc/swift/account-server.conf DEFAULT devices /srv/node openstack-config --set /etc/swift/account-server.conf DEFAULT mount_check True openstack-config --set /etc/swift/account-server.conf filter:recon use egg:swift#recon openstack-config --set /etc/swift/account-server.conf filter:recon recon_cache_path /var/cache/swift MD5å€¼ md5sum /etc/swift/account-server.conf 201ae87b1a85fb5d27a493b08bad6aab /etc/swift/account-server.conf #10.0.0.52 \\cp /etc/swift/account-server.conf{,.bak} grep '^[a-Z\\[]' /etc/swift/account-server.conf.bak > /etc/swift/account-server.conf openstack-config --set /etc/swift/account-server.conf DEFAULT bind_ip 10.0.0.52 openstack-config --set /etc/swift/account-server.conf DEFAULT bind_port 6202 openstack-config --set /etc/swift/account-server.conf DEFAULT user swift openstack-config --set /etc/swift/account-server.conf DEFAULT swift_dir /etc/swift openstack-config --set /etc/swift/account-server.conf DEFAULT devices /srv/node openstack-config --set /etc/swift/account-server.conf DEFAULT mount_check True openstack-config --set /etc/swift/account-server.conf filter:recon use egg:swift#recon openstack-config --set /etc/swift/account-server.conf filter:recon recon_cache_path /var/cache/swift MD5å€¼ md5sum /etc/swift/account-server.conf 4896e265fa7f08cc0b3f71e9c0255647 /etc/swift/account-server.conf 9.5.4 ç¼–è¾‘/etc/swift/container-server.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æ­¤[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ç»‘å®šIPåœ°å€ï¼Œç»‘å®šç«¯å£ï¼Œç”¨æˆ·ï¼Œé…ç½®ç›®å½•å’Œå®‰è£…ç‚¹ç›®å½•ï¼š æ›¿æ¢MANAGEMENT_INTERFACE_IP_ADDRESSä¸ºå­˜å‚¨èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œçš„IPåœ°å€ã€‚ [DEFAULT] ... bind_ip = MANAGEMENT_INTERFACE_IP_ADDRESS bind_port = 6201 user = swift swift_dir = /etc/swift devices = /srv/node mount_check = True 2.åœ¨è¯¥[pipeline:main]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨é€‚å½“çš„æ¨¡å—ï¼š æœ‰å…³å¯ç”¨å…¶ä»–åŠŸèƒ½çš„å…¶ä»–æ¨¡å—çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒå¦‚ä¸‹åœ°å€ https://docs.openstack.org/swift/latest/deployment_guide.html [pipeline:main] pipeline = healthcheck recon container-server 3.åœ¨è¯¥[filter:recon]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ä¾¦å¯Ÿï¼ˆè®¡é‡ï¼‰ç¼“å­˜ç›®å½•ï¼š [filter:recon] use = egg:swift#recon ... recon_cache_path = /var/cache/swift #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ #10.0.0.51 \\cp /etc/swift/container-server.conf{,.bak} grep '^[a-Z\\[]' /etc/swift/container-server.conf.bak > /etc/swift/container-server.conf openstack-config --set /etc/swift/container-server.conf DEFAULT bind_ip 10.0.0.51 openstack-config --set /etc/swift/container-server.conf DEFAULT bind_port 6201 openstack-config --set /etc/swift/container-server.conf DEFAULT user swift openstack-config --set /etc/swift/container-server.conf DEFAULT swift_dir /etc/swift openstack-config --set /etc/swift/container-server.conf DEFAULT devices /srv/node openstack-config --set /etc/swift/container-server.conf DEFAULT mount_check True openstack-config --set /etc/swift/container-server.conf filter:recon use egg:swift#recon openstack-config --set /etc/swift/container-server.conf filter:recon recon_cache_path /var/cache/swift MD5å€¼ md5sum /etc/swift/container-server.conf 8da5dc93bb2b4dcaf34dddf6244c5a50 /etc/swift/container-server.conf #10.0.0.52 \\cp /etc/swift/container-server.conf{,.bak} grep '^[a-Z\\[]' /etc/swift/container-server.conf.bak > /etc/swift/container-server.conf openstack-config --set /etc/swift/container-server.conf DEFAULT bind_ip 10.0.0.52 openstack-config --set /etc/swift/container-server.conf DEFAULT bind_port 6201 openstack-config --set /etc/swift/container-server.conf DEFAULT user swift openstack-config --set /etc/swift/container-server.conf DEFAULT swift_dir /etc/swift openstack-config --set /etc/swift/container-server.conf DEFAULT devices /srv/node openstack-config --set /etc/swift/container-server.conf DEFAULT mount_check True openstack-config --set /etc/swift/container-server.conf filter:recon use egg:swift#recon openstack-config --set /etc/swift/container-server.conf filter:recon recon_cache_path /var/cache/swift MD5å€¼ md5sum /etc/swift/container-server.conf 027623ff6b9d87b218703efbdffe73ca /etc/swift/container-server.conf 9.5.5 ç¼–è¾‘/etc/swift/object-server.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æ­¤[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ç»‘å®šIPåœ°å€ï¼Œç»‘å®šç«¯å£ï¼Œç”¨æˆ·ï¼Œé…ç½®ç›®å½•å’Œå®‰è£…ç‚¹ç›®å½•ï¼š æ›¿æ¢MANAGEMENT_INTERFACE_IP_ADDRESSä¸ºå­˜å‚¨èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œçš„IPåœ°å€ã€‚ [DEFAULT] ... bind_ip = MANAGEMENT_INTERFACE_IP_ADDRESS bind_port = 6200 user = swift swift_dir = /etc/swift devices = /srv/node mount_check = True 2.åœ¨è¯¥[pipeline:main]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨é€‚å½“çš„æ¨¡å—ï¼š æœ‰å…³å¯ç”¨å…¶ä»–åŠŸèƒ½çš„å…¶ä»–æ¨¡å—çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒå¦‚ä¸‹åœ°å€ https://docs.openstack.org/swift/latest/deployment_guide.html [pipeline:main] pipeline = healthcheck recon object-server 3.åœ¨æ­¤[filter:recon]éƒ¨åˆ†ä¸­ï¼Œé…ç½®ä¾¦å¯Ÿï¼ˆä»ªè¡¨ï¼‰ç¼“å­˜å’Œé”å®šç›®å½•ï¼š [filter:recon] use = egg:swift#recon ... recon_cache_path = /var/cache/swift recon_lock_path = /var/lock #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ #10.0.0.51 \\cp /etc/swift/object-server.conf{,.bak} grep '^[a-Z\\[]' /etc/swift/object-server.conf.bak > /etc/swift/object-server.conf openstack-config --set /etc/swift/object-server.conf DEFAULT bind_ip 10.0.0.51 openstack-config --set /etc/swift/object-server.conf DEFAULT bind_port 6200 openstack-config --set /etc/swift/object-server.conf DEFAULT user swift openstack-config --set /etc/swift/object-server.conf DEFAULT swift_dir /etc/swift openstack-config --set /etc/swift/object-server.conf DEFAULT devices /srv/node openstack-config --set /etc/swift/object-server.conf DEFAULT mount_check True openstack-config --set /etc/swift/object-server.conf filter:recon use egg:swift#recon openstack-config --set /etc/swift/object-server.conf filter:recon recon_cache_path /var/cache/swift openstack-config --set /etc/swift/object-server.conf filter:recon recon_lock_path /var/lock MD5å€¼ md5sum /etc/swift/object-server.conf a3decd3b7143c7255f732d5b8872f449 /etc/swift/object-server.conf #10.0.0.52 \\cp /etc/swift/object-server.conf{,.bak} grep '^[a-Z\\[]' /etc/swift/object-server.conf.bak > /etc/swift/object-server.conf openstack-config --set /etc/swift/object-server.conf DEFAULT bind_ip 10.0.0.52 openstack-config --set /etc/swift/object-server.conf DEFAULT bind_port 6200 openstack-config --set /etc/swift/object-server.conf DEFAULT user swift openstack-config --set /etc/swift/object-server.conf DEFAULT swift_dir /etc/swift openstack-config --set /etc/swift/object-server.conf DEFAULT devices /srv/node openstack-config --set /etc/swift/object-server.conf DEFAULT mount_check True openstack-config --set /etc/swift/object-server.conf filter:recon use egg:swift#recon openstack-config --set /etc/swift/object-server.conf filter:recon recon_cache_path /var/cache/swift openstack-config --set /etc/swift/object-server.conf filter:recon recon_lock_path /var/lock MD5å€¼ md5sum /etc/swift/object-server.conf a8c6c63f0d34ea0b9edc1207f7326aa7 /etc/swift/object-server.conf 9.5.6 ç¡®ä¿å¯¹å®‰è£…ç‚¹ç›®å½•ç»“æ„æ‹¥æœ‰é€‚å½“çš„æ‰€æœ‰æƒ chown -R swift:swift /srv/node 9.5.7 åˆ›å»ºreconç›®å½•å¹¶ç¡®ä¿å¯¹å…¶æ‹¥æœ‰é€‚å½“çš„æ‰€æœ‰æƒ mkdir -p /var/cache/swift chown -R root:swift /var/cache/swift chmod -R 775 /var/cache/swift 9.6 åˆ›å»ºå’Œåˆ†å‘åˆå§‹ç¯ âš ï¸åœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ åœ¨å¯åŠ¨å¯¹è±¡å­˜å‚¨æœåŠ¡ä¹‹å‰ï¼Œå¿…é¡»åˆ›å»ºåˆå§‹å¸æˆ·ï¼Œå®¹å™¨å’Œå¯¹è±¡ç¯ã€‚ç¯å½¢æ„å»ºå™¨åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶æ¥ç¡®å®šå’Œéƒ¨ç½²å­˜å‚¨ä½“ç³»ç»“æ„ã€‚ä¸ºç®€å•èµ·è§ï¼Œæœ¬æŒ‡å—ä½¿ç”¨ä¸€ä¸ªåŒºåŸŸå’Œä¸¤ä¸ªåŒºåŸŸï¼Œæœ€å¤§åˆ†åŒºä¸º2 ^ 10ï¼ˆ1024ï¼‰ä¸ªï¼Œæ¯ä¸ªå¯¹è±¡3ä¸ªå‰¯æœ¬ï¼Œä¸¤æ¬¡ç§»åŠ¨ä¸€ä¸ªåˆ†åŒºä¹‹é—´çš„æœ€å°‘é—´éš”æ—¶é—´ä¸º1å°æ—¶ã€‚å¯¹äºå¯¹è±¡å­˜å‚¨ï¼Œåˆ†åŒºè¡¨ç¤ºå­˜å‚¨è®¾å¤‡ä¸Šçš„ç›®å½•ï¼Œè€Œä¸æ˜¯å¸¸è§„åˆ†åŒºè¡¨ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ã€Š éƒ¨ç½²æŒ‡å—ã€‹ã€‚ 9.7 åˆ›å»ºå¸æˆ·ç¯ å¸æˆ·æœåŠ¡å™¨ä½¿ç”¨å¸æˆ·ç¯ç»´æŠ¤å®¹å™¨åˆ—è¡¨ 9.7.1 âš ï¸è¦åˆ‡æ¢åˆ°/etc/swiftç›®å½• cd /etc/swift 9.7.2 åˆ›å»ºåŸºç¡€account.builderæ–‡ä»¶ swift-ring-builder account.builder create 10 3 1 9.7.3 å°†æ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹æ·»åŠ åˆ°ç¯ å®˜ç½‘ç¤ºä¾‹ swift-ring-builder account.builder \\ add --region 1 --zone 1 --ip STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS --port 6202 \\ --device DEVICE_NAME --weight DEVICE_WEIGHT æ›¿æ¢STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESSä¸ºå­˜å‚¨èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œçš„IPåœ°å€ã€‚ç”¨DEVICE_NAMEåŒä¸€å­˜å‚¨èŠ‚ç‚¹ä¸Šçš„å­˜å‚¨è®¾å¤‡åç§°æ›¿æ¢ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨â€œ å®‰è£…â€ä¸­çš„ç¬¬ä¸€ä¸ªå­˜å‚¨èŠ‚ç‚¹å¹¶ä½¿ç”¨/dev/sdbå­˜å‚¨è®¾å¤‡å’Œæƒé‡100 é…ç½®å­˜å‚¨èŠ‚ç‚¹ï¼š å¯¹æ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šçš„æ¯ä¸ªå­˜å‚¨è®¾å¤‡é‡å¤æ­¤å‘½ä»¤ã€‚åœ¨ç¤ºä¾‹ä½“ç³»ç»“æ„ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹å››ä¸ªå˜ä½“ä¸­çš„å‘½ä»¤ $ swift-ring-builder account.builder add \\ --region 1 --zone 1 --ip 10.0.0.51 --port 6202 --device sdb --weight 100 Device d0r1z1-10.0.0.51:6202R10.0.0.51:6202/sdb_\"\" with 100.0 weight got id 0 $ swift-ring-builder account.builder add \\ --region 1 --zone 1 --ip 10.0.0.51 --port 6202 --device sdc --weight 100 Device d1r1z2-10.0.0.51:6202R10.0.0.51:6202/sdc_\"\" with 100.0 weight got id 1 $ swift-ring-builder account.builder add \\ --region 1 --zone 2 --ip 10.0.0.52 --port 6202 --device sdb --weight 100 Device d2r1z3-10.0.0.52:6202R10.0.0.52:6202/sdb_\"\" with 100.0 weight got id 2 $ swift-ring-builder account.builder add \\ --region 1 --zone 2 --ip 10.0.0.52 --port 6202 --device sdc --weight 100 Device d3r1z4-10.0.0.52:6202R10.0.0.52:6202/sdc_\"\" with 100.0 weight got id 3 9.7.4 éªŒè¯ $ swift-ring-builder account.builder account.builder, build version 4, id 7fcd3aae59374c538cc6c368804c5102 1024 partitions, 3.000000 replicas, 1 regions, 2 zones, 4 devices, 100.00 balance, 0.00 dispersion The minimum number of hours before a partition can be reassigned is 1 (0:00:00 remaining) The overload factor is 0.00% (0.000000) Ring file account.ring.gz not found, probably it hasn't been written yet Devices: id region zone ip address:port replication ip:port name weight partitions balance flags meta 0 1 1 10.0.0.51:6202 10.0.0.51:6202 sdb 100.00 0 -100.00 1 1 1 10.0.0.51:6202 10.0.0.51:6202 sdc 100.00 0 -100.00 2 1 2 10.0.0.52:6202 10.0.0.52:6202 sdb 100.00 0 -100.00 3 1 2 10.0.0.52:6202 10.0.0.52:6202 sdc 100.00 0 -100.00 9.7.5 é‡æ–°å¹³è¡¡æƒé‡ $ swift-ring-builder account.builder rebalance Reassigned 3072 (300.00%) partitions. Balance is now 0.00. Dispersion is now 0.00 9.8 åˆ›å»ºå®¹å™¨ç¯ å®¹å™¨æœåŠ¡å™¨ä½¿ç”¨å®¹å™¨ç¯ç»´æŠ¤å¯¹è±¡åˆ—è¡¨ã€‚ä½†æ˜¯ï¼Œå®ƒä¸è·Ÿè¸ªå¯¹è±¡ä½ç½® 9.8.1 è½¬åˆ°/etc/swiftç›®å½• cd /etc/swift 9.8.2 åˆ›å»ºåŸºç¡€container.builderæ–‡ä»¶ swift-ring-builder container.builder create 10 3 1 9.8.3 å°†æ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹æ·»åŠ åˆ°ç¯ å®˜ç½‘ç¤ºä¾‹ swift-ring-builder container.builder \\ add --region 1 --zone 1 --ip STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS --port 6201 --device DEVICE_NAME --weight DEVICE_WEIGHT æ›¿æ¢STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESSä¸ºå­˜å‚¨èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œçš„IPåœ°å€ã€‚ç”¨DEVICE_NAMEåŒä¸€å­˜å‚¨èŠ‚ç‚¹ä¸Šçš„å­˜å‚¨è®¾å¤‡åç§°æ›¿æ¢ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨â€œ å®‰è£…â€ä¸­çš„ç¬¬ä¸€ä¸ªå­˜å‚¨èŠ‚ç‚¹å¹¶ä½¿ç”¨/dev/sdb å­˜å‚¨è®¾å¤‡å’Œæƒé‡100 é…ç½®å­˜å‚¨èŠ‚ç‚¹ å¯¹æ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šçš„æ¯ä¸ªå­˜å‚¨è®¾å¤‡é‡å¤æ­¤å‘½ä»¤ã€‚åœ¨ç¤ºä¾‹ä½“ç³»ç»“æ„ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹å››ä¸ªå˜ä½“ä¸­çš„å‘½ä»¤ $ swift-ring-builder container.builder add \\ --region 1 --zone 1 --ip 10.0.0.51 --port 6201 --device sdb --weight 100 Device d0r1z1-10.0.0.51:6201R10.0.0.51:6201/sdb_\"\" with 100.0 weight got id 0 $ swift-ring-builder container.builder add \\ --region 1 --zone 1 --ip 10.0.0.51 --port 6201 --device sdc --weight 100 Device d1r1z2-10.0.0.51:6201R10.0.0.51:6201/sdc_\"\" with 100.0 weight got id 1 $ swift-ring-builder container.builder add \\ --region 1 --zone 2 --ip 10.0.0.52 --port 6201 --device sdb --weight 100 Device d2r1z3-10.0.0.52:6201R10.0.0.52:6201/sdb_\"\" with 100.0 weight got id 2 $ swift-ring-builder container.builder add \\ --region 1 --zone 2 --ip 10.0.0.52 --port 6201 --device sdc --weight 100 Device d3r1z4-10.0.0.52:6201R10.0.0.52:6201/sdc_\"\" with 100.0 weight got id 3 9.8.4 éªŒè¯ $ swift-ring-builder container.builder container.builder, build version 4, id 72f47fcf245841f19ba211e19f3752f4 1024 partitions, 3.000000 replicas, 1 regions, 2 zones, 4 devices, 100.00 balance, 0.00 dispersion The minimum number of hours before a partition can be reassigned is 1 (0:00:00 remaining) The overload factor is 0.00% (0.000000) Ring file container.ring.gz not found, probably it hasn't been written yet Devices: id region zone ip address:port replication ip:port name weight partitions balance flags meta 0 1 1 10.0.0.51:6201 10.0.0.51:6201 sdb 100.00 0 -100.00 1 1 1 10.0.0.51:6201 10.0.0.51:6201 sdc 100.00 0 -100.00 2 1 2 10.0.0.52:6201 10.0.0.52:6201 sdb 100.00 0 -100.00 3 1 2 10.0.0.52:6201 10.0.0.52:6201 sdc 100.00 0 -100.00 9.8.5 é‡æ–°å¹³è¡¡æƒé‡ $ swift-ring-builder container.builder rebalance Reassigned 3072 (300.00%) partitions. Balance is now 0.00. Dispersion is now 0.00 9.9 åˆ›å»ºå¯¹è±¡ç¯ å¯¹è±¡æœåŠ¡å™¨ä½¿ç”¨å¯¹è±¡ç¯ç»´æŠ¤æœ¬åœ°è®¾å¤‡ä¸Šå¯¹è±¡ä½ç½®çš„åˆ—è¡¨ 9.9.1 è½¬åˆ°/etc/swiftç›®å½• cd /etc/dwift 9.9.2 åˆ›å»ºåŸºç¡€object.builderæ–‡ä»¶ swift-ring-builder object.builder create 10 3 1 9.9.3 å°†æ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹æ·»åŠ åˆ°ç¯ å®˜æ–¹ç¤ºä¾‹ swift-ring-builder object.builder \\ add --region 1 --zone 1 --ip STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS --port 6200 --device DEVICE_NAME --weight DEVICE_WEIGHT æ›¿æ¢STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESSä¸ºå­˜å‚¨èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œçš„IPåœ°å€ã€‚ç”¨DEVICE_NAMEåŒä¸€å­˜å‚¨èŠ‚ç‚¹ä¸Šçš„å­˜å‚¨è®¾å¤‡åç§°æ›¿æ¢ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨â€œ å®‰è£…â€ä¸­çš„ç¬¬ä¸€ä¸ªå­˜å‚¨èŠ‚ç‚¹å¹¶ä½¿ç”¨/dev/sdbå­˜å‚¨è®¾å¤‡å’Œæƒé‡100 é…ç½®å­˜å‚¨èŠ‚ç‚¹ å¯¹æ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šçš„æ¯ä¸ªå­˜å‚¨è®¾å¤‡é‡å¤æ­¤å‘½ä»¤ã€‚åœ¨ç¤ºä¾‹ä½“ç³»ç»“æ„ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹å››ä¸ªå˜ä½“ä¸­çš„å‘½ä»¤ $ swift-ring-builder object.builder add \\ --region 1 --zone 1 --ip 10.0.0.51 --port 6200 --device sdb --weight 100 Device d0r1z1-10.0.0.51:6200R10.0.0.51:6200/sdb_\"\" with 100.0 weight got id 0 $ swift-ring-builder object.builder add \\ --region 1 --zone 1 --ip 10.0.0.51 --port 6200 --device sdc --weight 100 Device d1r1z2-10.0.0.51:6200R10.0.0.51:6200/sdc_\"\" with 100.0 weight got id 1 $ swift-ring-builder object.builder add \\ --region 1 --zone 2 --ip 10.0.0.52 --port 6200 --device sdb --weight 100 Device d2r1z3-10.0.0.52:6200R10.0.0.52:6200/sdb_\"\" with 100.0 weight got id 2 $ swift-ring-builder object.builder add \\ --region 1 --zone 2 --ip 10.0.0.52 --port 6200 --device sdc --weight 100 Device d3r1z4-10.0.0.52:6200R10.0.0.52:6200/sdc_\"\" with 100.0 weight got id 3 9.9.4 éªŒè¯ $ swift-ring-builder object.builder object.builder, build version 4, id 58129d88cd59455ea3c53172d05a5399 1024 partitions, 3.000000 replicas, 1 regions, 2 zones, 4 devices, 100.00 balance, 0.00 dispersion The minimum number of hours before a partition can be reassigned is 1 (0:00:00 remaining) The overload factor is 0.00% (0.000000) Ring file object.ring.gz not found, probably it hasn't been written yet Devices: id region zone ip address:port replication ip:port name weight partitions balance flags meta 0 1 1 10.0.0.51:6200 10.0.0.51:6200 sdb 100.00 0 -100.00 1 1 1 10.0.0.51:6200 10.0.0.51:6200 sdc 100.00 0 -100.00 2 1 2 10.0.0.52:6200 10.0.0.52:6200 sdb 100.00 0 -100.00 3 1 2 10.0.0.52:6200 10.0.0.52:6200 sdc 100.00 0 -100.00 9.9.5 é‡æ–°å¹³è¡¡æƒé‡ $ swift-ring-builder object.builder rebalance Reassigned 3072 (300.00%) partitions. Balance is now 0.00. Dispersion is now 0.00 9.10 åˆ†å‘ç¯ç½‘é…ç½®æ–‡ä»¶ æ‹·è´account.ring.gzï¼Œcontainer.ring.gzä»¥åŠ object.ring.gzæ–‡ä»¶å¤åˆ¶åˆ°/etc/swiftæ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹å’Œè¿è¡Œä»£ç†æœåŠ¡çš„ä»»ä½•å…¶ä»–èŠ‚ç‚¹ä¸Šç›®å½• scp /etc/swift/{account.ring.gz,container.ring.gz,object.ring.gz} object1:/etc/swift scp /etc/swift/{account.ring.gz,container.ring.gz,object.ring.gz} object2:/etc/swift 9.11 å®Œæˆå®‰è£… rockyç‰ˆå¯¹è±¡å­˜å‚¨æœåŠ¡swiftå®Œæˆå®‰è£…å®˜æ–¹æ–‡æ¡£ 9.11.1 /etc/swift/swift.confä»å¯¹è±¡å­˜å‚¨æºå­˜å‚¨åº“ä¸­è·å–æ–‡ä»¶ âš ï¸è¿™ä¸€æ­¥åœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ #swiftæ–‡ä»¶åŸå…ˆå†…å®¹ $ cat /etc/swift/swift.conf [swift-hash] swift_hash_path_suffix = %SWIFT_HASH_PATH_SUFFIX% curl -o /etc/swift/swift.conf \\ https://opendev.org/openstack/swift/raw/branch/stable/rocky/etc/swift.conf-sample 9.11.2 ç¼–è¾‘/etc/swift/swift.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ âš ï¸è¿™ä¸€æ­¥åœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ 1.åœ¨è¯¥[swift-hash]éƒ¨åˆ†ä¸­ï¼Œä¸ºæ‚¨çš„ç¯å¢ƒé…ç½®å“ˆå¸Œè·¯å¾„å‰ç¼€å’Œåç¼€ã€‚ç”¨å”¯ä¸€å€¼æ›¿æ¢HASH_PATH_PREFIXå’ŒHASH_PATH_SUFFIXï¼Œè¯·å°†è¿™äº›å€¼ä¿å¯†ï¼Œä¸è¦æ›´æ”¹æˆ–ä¸¢å¤±å®ƒä»¬ [swift-hash] ... swift_hash_path_suffix = HASH_PATH_SUFFIX swift_hash_path_prefix = HASH_PATH_PREFIX 2.åœ¨è¯¥[storage-policy:0]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é»˜è®¤å­˜å‚¨ç­–ç•¥ï¼š [storage-policy:0] ... name = Policy-0 default = yes #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/swift/swift.conf{,.bak} grep '^[a-Z\\[]' /etc/swift/swift.conf.bak > /etc/swift/swift.conf openstack-config --set /etc/swift/swift.conf swift-hash swift_hash_path_suffix HASH_PATH_SUFFIX openstack-config --set /etc/swift/swift.conf swift-hash swift_hash_path_prefix HASH_PATH_PREFIX openstack-config --set /etc/swift/swift.conf storage-policy:0 name Policy-0 openstack-config --set /etc/swift/swift.conf storage-policy:0 default yes MD5å€¼ md5sum /etc/swift/swift.conf 7fdc00e448c50b77fc703debf654d906 /etc/swift/swift.conf 9.11.3 å°†swift.confæ–‡ä»¶å¤åˆ¶åˆ°/etc/swiftæ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹ä»¥åŠè¿è¡Œä»£ç†æœåŠ¡çš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ä¸Šçš„ç›®å½•ä¸­ âš ï¸è¿™ä¸€æ­¥åœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ scp /etc/swift/swift.conf object1:/etc/swift scp /etc/swift/swift.conf object2:/etc/swift 9.11.4 åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šï¼Œç¡®ä¿å¯¹é…ç½®ç›®å½•æ‹¥æœ‰é€‚å½“çš„æ‰€æœ‰æƒ åœ¨æ§åˆ¶èŠ‚ç‚¹å’Œä¸¤ä¸ªå¯¹è±¡å­˜å‚¨èŠ‚ç‚¹(51ã€52)æ‰§è¡Œ chown -R root:swift /etc/swift 9.11.5 åœ¨æ§åˆ¶å™¨èŠ‚ç‚¹å’Œè¿è¡Œä»£ç†æœåŠ¡çš„ä»»ä½•å…¶ä»–èŠ‚ç‚¹ä¸Šï¼Œå¯åŠ¨å¯¹è±¡å­˜å‚¨ä»£ç†æœåŠ¡åŠå…¶ç›¸å…³æ€§ï¼Œå¹¶å°†å®ƒä»¬é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨ âš ï¸è¿™ä¸€æ­¥åœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ systemctl enable openstack-swift-proxy.service memcached.service systemctl start openstack-swift-proxy.service memcached.service 9.11.6 åœ¨å­˜å‚¨èŠ‚ç‚¹ä¸Šï¼Œå¯åŠ¨å¯¹è±¡å­˜å‚¨æœåŠ¡å¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ ä¸¤ä¸ªå¯¹è±¡å­˜å‚¨èŠ‚ç‚¹(51ã€52)æ‰§è¡Œ systemctl enable openstack-swift-account \\ openstack-swift-account-auditor \\ openstack-swift-account-reaper \\ openstack-swift-account-replicator \\ openstack-swift-container \\ openstack-swift-container-auditor \\ openstack-swift-container-replicator \\ openstack-swift-container-updater \\ openstack-swift-object \\ openstack-swift-object-auditor \\ openstack-swift-object-replicator \\ openstack-swift-object-updater systemctl start openstack-swift-account \\ openstack-swift-account-auditor \\ openstack-swift-account-reaper \\ openstack-swift-account-replicator \\ openstack-swift-container \\ openstack-swift-container-auditor \\ openstack-swift-container-replicator \\ openstack-swift-container-updater \\ openstack-swift-object \\ openstack-swift-object-auditor \\ openstack-swift-object-replicator \\ openstack-swift-object-updater 9.12 éªŒè¯æ“ä½œ rockyç‰ˆå¯¹è±¡å­˜å‚¨æœåŠ¡swiftéªŒè¯æ“ä½œå®˜æ–¹æ–‡æ¡£ åœ¨æ§åˆ¶å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ âš ï¸âš ï¸âš ï¸ å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯Red Hat Enterprise Linux 7æˆ–CentOS 7ï¼Œå¹¶ä¸”å…¶ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªæ­¥éª¤ä¸èµ·ä½œç”¨ï¼Œè¯·æ£€æŸ¥è¯¥/var/log/audit/audit.logæ–‡ä»¶ä¸­æ˜¯å¦æœ‰SELinuxæ¶ˆæ¯ï¼Œè¡¨æ˜è¯¥swiftè¿›ç¨‹æ‹’ç»é‡‡å–æªæ–½ã€‚å¦‚æœå­˜åœ¨ï¼Œè¯·å°†/srv/nodeç›®å½•çš„å®‰å…¨ä¸Šä¸‹æ–‡æ›´æ”¹ä¸ºswift_data_tç±»å‹ï¼Œobject_r è§’è‰²å’Œsystem_uç”¨æˆ·çš„æœ€ä½å®‰å…¨çº§åˆ«ï¼ˆs0ï¼‰ï¼š chcon -R system_u:object_r:swift_data_t:s0 /srv/node 9.12.1 è·å–demoå‡­è¯ âš ï¸âš ï¸âš ï¸è¿™é‡Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› (ä¹Ÿè‚¯èƒ½æ˜¯æˆ‘è‡ªå·±å“ªé‡Œå‡ºé”™äº†)ï¼Œå¦‚æœæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ä¸­åŠ è½½demoå‡­è¯ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œswift statå‘½ä»¤æ—¶ä¼šæŠ¥é”™403æƒé™æ‹’ç»ï¼Œæ‰€ä»¥è¿™é‡ŒåŠ è½½äº†adminå‡­è¯ source /opt/demo-openrc 9.12.2 æ˜¾ç¤ºæœåŠ¡çŠ¶æ€ $ swift stat Account: AUTH_a8cb8e52e5a44288b2ac1a216195ee10 Containers: 0 Objects: 0 Bytes: 0 X-Put-Timestamp: 1590683616.82847 X-Timestamp: 1590683616.82847 X-Trans-Id: tx85844a798ed34d998b692-005ecfe7e0 Content-Type: text/plain; charset=utf-8 X-Openstack-Request-Id: tx85844a798ed34d998b692-005ecfe7e0 9.12.3 åˆ›å»ºcontainer1å®¹å™¨ openstack container create container1 +---------------------------------------+------------+------------------------------------+ | account | container | x-trans-id | +---------------------------------------+------------+------------------------------------+ | AUTH_a8cb8e52e5a44288b2ac1a216195ee10 | container1 | tx3e166ae00ded4264a0dbe-005ecfea29 | +---------------------------------------+------------+------------------------------------+ 9.12.4 å°†æµ‹è¯•æ–‡ä»¶ä¸Šä¼ åˆ°container1å®¹å™¨ #éœ€è¦åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ echo test >/tmp/test.txt $ openstack object create container1 /tmp/test.txt +---------------+------------+----------------------------------+ | object | container | etag | +---------------+------------+----------------------------------+ | /tmp/test.txt | container1 | d8e8fca2dc0f896fd7cb4cb0031ba249 | +---------------+------------+----------------------------------+ 9.12.5 åˆ—å‡ºcontainer1å®¹å™¨ä¸­çš„æ–‡ä»¶ openstack object list container1 +---------------+ | Name | +---------------+ | /tmp/test.txt | +---------------+ 9.12.6 ä»container1å®¹å™¨ä¸‹è½½æµ‹è¯•æ–‡ä»¶ #å…ˆæŠŠæœ¬åœ°çš„æµ‹è¯•æ–‡ä»¶/tmp/test.txtåˆ é™¤ rm /tmp/test.txt #ç„¶åä¸‹è½½æµ‹è¯•æ–‡ä»¶ï¼Œèƒ½ä¸‹è½½å¹¶ä¸”æ–‡ä»¶å†…å®¹ä¸å˜å³ä¸ºæ­£ç¡® openstack object save container1 /tmp/test.txt åˆ°æ­¤ï¼Œå¯¹è±¡å­˜å‚¨æœåŠ¡swiftå®‰è£…å®Œæˆ rockyç‰ˆæ›´å¤šæœåŠ¡å‚è€ƒè¿™ä¸ªå®˜æ–¹æ–‡æ¡£ åã€å®‰è£…å’Œé…ç½®å¤‡ä»½æœåŠ¡(å¯é€‰) å®‰è£…å’Œé…ç½®å¤‡ä»½æœåŠ¡ã€‚ä¸ºç®€å•èµ·è§ï¼Œæ­¤é…ç½®ä½¿ç”¨â€œå—å­˜å‚¨â€èŠ‚ç‚¹å’Œâ€œå¯¹è±¡å­˜å‚¨â€ï¼ˆé©±åŠ¨ç¨‹åºï¼‰é©±åŠ¨ç¨‹åºï¼Œå› æ­¤å–å†³äºâ€œ å¯¹è±¡å­˜å‚¨â€æœåŠ¡ã€‚ åœ¨å®‰è£…å’Œé…ç½®å¤‡ä»½æœåŠ¡ä¹‹å‰ï¼Œå¿…é¡»å…ˆå®‰è£…å’Œé…ç½®å­˜å‚¨èŠ‚ç‚¹ã€‚ åœ¨å—å­˜å‚¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ 10.1 å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-cinder 10.2 ç¼–è¾‘/etc/cinder/cinder.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®å¤‡ä»½é€‰é¡¹ï¼š [DEFAULT] # ... backup_driver = cinder.backup.drivers.swift backup_swift_url = SWIFT_URL #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ openstack-config --set /etc/cinder/cinder.conf DEFAULT backup_driver cinder.backup.drivers.swift openstack-config --set /etc/cinder/cinder.conf DEFAULT backup_swift_url http://controller:8080/v1/AUTH_ee435c972a7a476cadbd2c9ad782c6f0 publicçš„urlæ¯æ¬¡éƒ½æ˜¯ä¸ä¸€æ ·çš„ æ›¿æ¢SWIFT_URLä¸ºå¯¹è±¡å­˜å‚¨æœåŠ¡çš„URLã€‚å¯ä»¥é€šè¿‡æ˜¾ç¤ºå¯¹è±¡åº“APIç«¯ç‚¹æ¥æ‰¾åˆ°URLï¼Œåœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤openstack catalog show object-store openstack catalog show object-store +-----------+-----------------------------------------------------------------------------+ | Field | Value | +-----------+-----------------------------------------------------------------------------+ | endpoints | RegionOne | | | admin: http://controller:8080/v1 | | | RegionOne | | | public: http://controller:8080/v1/AUTH_a8cb8e52e5a44288b2ac1a216195ee10 | | | RegionOne | | | internal: http://controller:8080/v1/AUTH_a8cb8e52e5a44288b2ac1a216195ee10 | | | | | id | b5169189845a4fb1b80fe1ab06584ffc | | name | swift | | type | object-store | +-----------+-----------------------------------------------------------------------------+ 10.3 å¯åŠ¨å—å­˜å‚¨å¤‡ä»½æœåŠ¡ï¼Œå¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨ systemctl enable openstack-cinder-backup.service systemctl start openstack-cinder-backup.service åˆ°æ­¤å—å­˜å‚¨èŠ‚ç‚¹å—å­˜å‚¨å¤‡ä»½æœåŠ¡å®‰è£…å®Œæˆï¼ï¼ï¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/rocky/2.rockyç‰ˆä½¿ç”¨å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå®ä¾‹.html":{"url":"linux/openstack/rocky/2.rockyç‰ˆä½¿ç”¨å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå®ä¾‹.html","title":"rockyç‰ˆä½¿ç”¨å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå®ä¾‹","keywords":"","body":"rockyç‰ˆä½¿ç”¨å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå®ä¾‹ rockyç‰ˆå¯åŠ¨å®ä¾‹å®˜æ–¹æ–‡æ¡£ å› ä¸ºé€‰æ‹©çš„æ˜¯æä¾›å•†ç½‘ç»œï¼Œå³ç½‘ç»œ1ï¼Œæ‰€ä»¥å‚è€ƒè¿™ä¸ªå®˜æ–¹æ–‡æ¡£ 1.åˆ›å»ºç½‘ç»œ openstack network create åˆ›å»ºç½‘ç»œ --shared åˆ›å»ºå…±äº«ç½‘ç»œ --provider-physical-network æŒ‡å®šç‰©ç†ç½‘å¡åç§° providerç½‘ç»œæ ‡ç­¾ --provider-network-type æŒ‡å®šç½‘ç»œç±»å‹ flatæ˜¯æ¡¥æ¥ç½‘ç»œ pptfzæ˜¯ç½‘ç»œåç§° openstack network create --share --external \\ --provider-physical-network provider \\ --provider-network-type flat pptfz +---------------------------+--------------------------------------+ | Field | Value | +---------------------------+--------------------------------------+ | admin_state_up | UP | | availability_zone_hints | | | availability_zones | | | created_at | 2020-05-26T12:41:05Z | | description | | | dns_domain | None | | id | 26fa223a-231f-419a-a387-750d6eabf3fe | | ipv4_address_scope | None | | ipv6_address_scope | None | | is_default | None | | is_vlan_transparent | None | | mtu | 1500 | | name | pptfz | | port_security_enabled | True | | project_id | 108d3fecb61840e3818f694c69c3ec4a | | provider:network_type | flat | | provider:physical_network | provider | | provider:segmentation_id | None | | qos_policy_id | None | | revision_number | 1 | | router:external | External | | segments | None | | shared | True | | status | ACTIVE | | subnets | | | tags | | | updated_at | 2020-05-26T12:41:05Z | +---------------------------+--------------------------------------+ 2.åˆ›å»ºä¸€ä¸ªå­ç½‘ åˆ›å»ºä¸€ä¸ªåä¸ºpptfzçš„å­ç½‘ï¼Œä¾æ®çš„ç½‘ç»œæ˜¯ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„ç½‘ç»œpptfz openstack subnet create --network pptfz \\ --allocation-pool start=10.0.0.101,end=10.0.0.250 \\ --dns-nameserver 223.5.5.5 --gateway 10.0.0.1 \\ --subnet-range 10.0.0.0/24 pptfz +-------------------+--------------------------------------+ | Field | Value | +-------------------+--------------------------------------+ | allocation_pools | 10.0.0.101-10.0.0.250 | | cidr | 10.0.0.0/24 | | created_at | 2020-05-26T12:45:13Z | | description | | | dns_nameservers | 223.5.5.5 | | enable_dhcp | True | | gateway_ip | 10.0.0.1 | | host_routes | | | id | ad3d939a-866f-4b2b-9321-29e98fe64f26 | | ip_version | 4 | | ipv6_address_mode | None | | ipv6_ra_mode | None | | name | pptfz | | network_id | 26fa223a-231f-419a-a387-750d6eabf3fe | | project_id | 108d3fecb61840e3818f694c69c3ec4a | | revision_number | 0 | | segment_id | None | | service_types | | | subnetpool_id | None | | tags | | | updated_at | 2020-05-26T12:45:13Z | +-------------------+--------------------------------------+ 3.åˆ›å»ºäº‘ä¸»æœºçš„ç¡¬ä»¶é…ç½®æ–¹æ¡ˆ openstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano +----------------------------+---------+ | Field | Value | +----------------------------+---------+ | OS-FLV-DISABLED:disabled | False | | OS-FLV-EXT-DATA:ephemeral | 0 | | disk | 1 | | id | 0 | | name | m1.nano | | os-flavor-access:is_public | True | | properties | | | ram | 64 | | rxtx_factor | 1.0 | | swap | | | vcpus | 1 | +----------------------------+---------+ #å‚æ•°è¯´æ˜ flavor ç¡¬ä»¶é…ç½®æ–¹æ¡ˆ --id æŒ‡å®šç¼–å· --vcpus cpuä¸ªæ•° --ram å†…å­˜ï¼ˆå•ä½ï¼šMï¼‰ --disk ç£ç›˜ï¼ˆå•ä½ï¼šGï¼‰ m1.nano æ–¹æ¡ˆåç§° #åˆ›å»ºå…¶ä½™é…ç½® openstack flavor create --id 1 --vcpus 1 --ram 512 --disk 5 m1.tiny1 openstack flavor create --id 2 --vcpus 1 --ram 1024 --disk 5 m1.tiny2 openstack flavor create --id 3 --vcpus 1 --ram 2048 --disk 10 m1.small openstack flavor create --id 4 --vcpus 2 --ram 4096 --disk 20 m1.medium 4.åˆ›å»ºå¯†é’¥å¯¹ ssh-keygen -q -N \"\" -f ~/.ssh/id_rsa && \\ openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey +-------------+-------------------------------------------------+ | Field | Value | +-------------+-------------------------------------------------+ | fingerprint | 38:66:ea:65:c2:4d:50:3c:ee:b1:86:a2:2a:af:70:03 | | name | mykey | | user_id | a0d3db84d1984a24ac6ba213525fe382 | +-------------+-------------------------------------------------+ //å‚æ•°è¯´æ˜ ssh-keygen -q -N \"\" -f ~/.ssh/id_rsa éäº¤äº’å¼ç”Ÿæˆå¯†é’¥å¯¹ -q å®‰é™æ¨¡å¼ -N æŒ‡å®šåŠ å¯†å¯†ç  -f å¯†é’¥å¯¹å­˜æ”¾ä½ç½® openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey ä¸Šä¼ å¯†é’¥å¯¹ #éªŒè¯å¯†é’¥å¯¹çš„æ·»åŠ  openstack keypair list +-------+-------------------------------------------------+ | Name | Fingerprint | +-------+-------------------------------------------------+ | mykey | 38:66:ea:65:c2:4d:50:3c:ee:b1:86:a2:2a:af:70:03 | +-------+-------------------------------------------------+ 5.åˆ›å»ºå®‰å…¨ç»„è§„åˆ™ **é»˜è®¤æƒ…å†µä¸‹ï¼Œdefaultå®‰å…¨ç»„é€‚ç”¨äºæ‰€æœ‰å®ä¾‹ï¼Œå¹¶åŒ…æ‹¬æ‹’ç»å¯¹å®ä¾‹è¿›è¡Œè¿œç¨‹è®¿é—®çš„é˜²ç«å¢™è§„åˆ™ã€‚ è®¸å¯ICMPï¼ˆpingï¼‰ openstack security group rule create --proto icmp default +-------------------+--------------------------------------+ | Field | Value | +-------------------+--------------------------------------+ | created_at | 2020-05-26T12:53:35Z | | description | | | direction | ingress | | ether_type | IPv4 | | id | 838f15e5-7b23-42e3-aadc-a16887830efc | | name | None | | port_range_max | None | | port_range_min | None | | project_id | 108d3fecb61840e3818f694c69c3ec4a | | protocol | icmp | | remote_group_id | None | | remote_ip_prefix | 0.0.0.0/0 | | revision_number | 0 | | security_group_id | 04ea403e-40c7-4881-a8d7-e62825e6509c | | updated_at | 2020-05-26T12:53:35Z | +-------------------+--------------------------------------+ å…è®¸å®‰å…¨å¤–å£³ï¼ˆSSHï¼‰è®¿é—® openstack security group rule create --proto tcp --dst-port 22 default +-------------------+--------------------------------------+ | Field | Value | +-------------------+--------------------------------------+ | created_at | 2020-05-26T12:53:49Z | | description | | | direction | ingress | | ether_type | IPv4 | | id | 5e7a6e16-14c7-4204-9651-52e0559a2a92 | | name | None | | port_range_max | 22 | | port_range_min | 22 | | project_id | 108d3fecb61840e3818f694c69c3ec4a | | protocol | tcp | | remote_group_id | None | | remote_ip_prefix | 0.0.0.0/0 | | revision_number | 0 | | security_group_id | 04ea403e-40c7-4881-a8d7-e62825e6509c | | updated_at | 2020-05-26T12:53:49Z | +-------------------+--------------------------------------+ 6.å¯åŠ¨ä¸€ä¸ªå®ä¾‹ 6.1 ç¡®å®šå®ä¾‹çš„é€‰é¡¹ 6.1.1 åœ¨æ§åˆ¶å™¨èŠ‚ç‚¹ä¸Šï¼Œdemoè·å–å‡­æ®ä»¥è®¿é—®ä»…ç”¨æˆ·çš„CLIå‘½ä»¤ source /opt/demo-openrc 6.1.2 æŒ‡å®šè™šæ‹Ÿèµ„æºåˆ†é…é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬å¤„ç†å™¨ï¼Œå†…å­˜å’Œå­˜å‚¨ï¼Œåˆ—å‡ºå¯ç”¨çš„è§„æ ¼ openstack flavor list +----+-----------+------+------+-----------+-------+-----------+ | ID | Name | RAM | Disk | Ephemeral | VCPUs | Is Public | +----+-----------+------+------+-----------+-------+-----------+ | 0 | m1.nano | 64 | 1 | 0 | 1 | True | | 1 | m1.tiny1 | 512 | 5 | 0 | 1 | True | | 2 | m1.tiny2 | 1024 | 5 | 0 | 1 | True | | 3 | m1.small | 2048 | 10 | 0 | 1 | True | | 4 | m1.medium | 4096 | 20 | 0 | 2 | True | +----+-----------+------+------+-----------+-------+-----------+ 6.1.3 åˆ—å‡ºå¯ç”¨çš„é•œåƒ openstack image list +--------------------------------------+--------+--------+ | ID | Name | Status | +--------------------------------------+--------+--------+ | 94c96aab-d0b3-4340-835c-9a97108d0554 | cirros | active | +--------------------------------------+--------+--------+ 6.1.4 åˆ—å‡ºå¯ç”¨çš„ç½‘ç»œ openstack network list +--------------------------------------+-------+--------------------------------------+ | ID | Name | Subnets | +--------------------------------------+-------+--------------------------------------+ | 26fa223a-231f-419a-a387-750d6eabf3fe | pptfz | ad3d939a-866f-4b2b-9321-29e98fe64f26 | +--------------------------------------+-------+--------------------------------------+ 6.1.5 åˆ—å‡ºå¯ç”¨çš„å®‰å…¨ç»„ openstack security group list +--------------------------------------+---------+------------------------+----------------------------------+------+ | ID | Name | Description | Project | Tags | +--------------------------------------+---------+------------------------+----------------------------------+------+ | e65b8ec1-3544-414c-94d0-2c87dd6eadbf | default | Default security group | 5b9ccd294c364cc68747df85f9598c89 | [] | +--------------------------------------+---------+------------------------+----------------------------------+------+ 6.2 å¯åŠ¨ä¸€ä¸ªå®ä¾‹ å®˜ç½‘å¯åŠ¨ç¤ºä¾‹ openstack server create --flavor m1.nano --image cirros \\ --nic net-id=PROVIDER_NET_ID --security-group default \\ --key-name mykey provider-instance å¯åŠ¨å®ä¾‹è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°net-idï¼Œå› æ­¤ä½¿ç”¨neutron net-list|awk 'NR==4{print $2}'è·å– openstack server create --flavor m1.nano --image cirros \\ --nic net-id=`neutron net-list|awk 'NR==4{print $2}'` --security-group default \\ --key-name mykey pptfz neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead. +-----------------------------+-----------------------------------------------+ | Field | Value | +-----------------------------+-----------------------------------------------+ | OS-DCF:diskConfig | MANUAL | | OS-EXT-AZ:availability_zone | | | OS-EXT-STS:power_state | NOSTATE | | OS-EXT-STS:task_state | scheduling | | OS-EXT-STS:vm_state | building | | OS-SRV-USG:launched_at | None | | OS-SRV-USG:terminated_at | None | | accessIPv4 | | | accessIPv6 | | | addresses | | | adminPass | jVR6on2EN7AX | | config_drive | | | created | 2020-05-26T13:08:14Z | | flavor | m1.nano (0) | | hostId | | | id | da4a32c7-e51e-4de0-b8a9-c0533db7e6fd | | image | cirros (94c96aab-d0b3-4340-835c-9a97108d0554) | | key_name | mykey | | name | pptfz | | progress | 0 | | project_id | 5b9ccd294c364cc68747df85f9598c89 | | properties | | | security_groups | name='e65b8ec1-3544-414c-94d0-2c87dd6eadbf' | | status | BUILD | | updated | 2020-05-26T13:08:14Z | | user_id | 82d945a092b44988af8d6e02ba2cc15c | | volumes_attached | | +-----------------------------+-----------------------------------------------+ æŸ¥çœ‹ç¤ºä¾‹å¯åŠ¨çŠ¶æ€ openstack server list +--------------------------------------+-------+--------+------------------+--------+---------+ | ID | Name | Status | Networks | Image | Flavor | +--------------------------------------+-------+--------+------------------+--------+---------+ | 3191793e-055d-4417-bab5-df6c6574aaed | pptfz | ACTIVE | pptfz=10.0.0.113 | cirros | m1.nano | +--------------------------------------+-------+--------+------------------+--------+---------+ åˆ›å»ºæˆåŠŸåä¼šåœ¨webç•Œé¢å±•ç¤º ç‚¹å‡»æ§åˆ¶å°ç™»é™†è™šæ‹Ÿæœº âš ï¸ç‚¹å‡»æ§åˆ¶å°åæç¤ºæ‰¾ä¸åˆ°controlleråœ°å€ï¼Œå› ä¸ºæ²¡æœ‰åšhostsè§£æï¼Œéœ€è¦å…ˆåšhostsè§£æ windows C:\\Windows\\System32\\drivers\\etc\\hosts 10.0.0.11 controller mac /etc/hosts 10.0.0.11 controller è§£æå®Œååˆ·æ–°æµè§ˆå™¨ï¼Œä¼šçœ‹åˆ°é»˜è®¤ç”¨æˆ·æ˜¯cirrosï¼Œå¯†ç æ˜¯gocubsgo æŸ¥çœ‹ä¸»æœºåã€IPåœ°å€ã€æ£€æŸ¥æ˜¯å¦èƒ½è”ç½‘ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/rocky/3.openstack rockyç‰ˆæ‰‹åŠ¨å¢åŠ ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹.html":{"url":"linux/openstack/rocky/3.openstack rockyç‰ˆæ‰‹åŠ¨å¢åŠ ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹.html","title":"openstack rockyç‰ˆæ‰‹åŠ¨å¢åŠ ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹","keywords":"","body":"openstack rockyç‰ˆæ‰‹åŠ¨å¢åŠ ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹ 1.é…ç½®hostè§£æ cat /etc/hosts 2.é…ç½®yumæº yum -y install centos-release-openstack-rocky yum -y install python-openstackclient 3.æ—¶é—´åŒæ­¥ 1.å®‰è£…chrony yum -y install chrony 2.ç¼–è¾‘chronyé…ç½®æ–‡ä»¶/etc/chrony.conf /åˆ é™¤ä»¥ä¸‹4è¡Œï¼ŒæŒ‡å®šæ§åˆ¶èŠ‚ç‚¹ä¸ºNTPæœåŠ¡å™¨ server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst ä¿®æ”¹ä¸º server controller iburst #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i '3,6d' /etc/chrony.conf && sed -i '3cserver controller iburst' /etc/chrony.conf 3.å¯åŠ¨NTPæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable chronyd && systemctl start chronyd 4.æ£€æŸ¥ç«¯å£ï¼Œç›‘å¬udp323ç«¯å£ $ netstat -nupl|grep chronyd udp 0 0 127.0.0.1:323 0.0.0.0:* 1327/chronyd udp6 0 0 ::1:323 :::* 1327/chronyd 5.éªŒè¯ï¼Œè®¡ç®—èŠ‚ç‚¹æ˜¾ç¤ºçš„æ˜¯æ§åˆ¶èŠ‚ç‚¹ $ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^? controller 3 6 200 50 +1319ms[+1319ms] +/- 14.4s 4.å®‰è£…è½¯ä»¶åŒ… yum -y install openstack-nova-compute openstack-utils 5.é…ç½®è®¡ç®—æœåŠ¡nova 5.1 ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ âš ï¸compute2çš„IPåœ°å€ä¸º10.0.0.32 1.åœ¨æ­¤[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œä»…å¯ç”¨è®¡ç®—å’Œå…ƒæ•°æ®API [DEFAULT] # ... enabled_apis = osapi_compute,metadata 2.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®ï¼š [DEFAULT] # ... transport_url = rabbit://openstack:RABBIT_PASS@controller 3.åœ¨[api]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š [api] # ... auth_strategy = keystone [keystone_authtoken] # ... auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = nova password = NOVA_PASS 4.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®my_ipé€‰é¡¹ï¼šMANAGEMENT_INTERFACE_IP_ADDRESSä¸ºè®¡ç®—èŠ‚ç‚¹ä¸Šç®¡ç†ç½‘ç»œæ¥å£çš„IPåœ°å€ my_ip = MANAGEMENT_INTERFACE_IP_ADDRESS [DEFAULT] # ... my_ip = 10.0.0.32 5.åœ¨æœ¬[DEFAULT]èŠ‚ä¸­ï¼Œå¯ç”¨å¯¹ç½‘ç»œæœåŠ¡çš„æ”¯æŒï¼š [DEFAULT] # ... use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver 6.åœ¨æœ¬[DEFAULT]èŠ‚ä¸­ï¼Œå¯ç”¨å¯¹ç½‘ç»œæœåŠ¡çš„æ”¯æŒï¼š [DEFAULT] # ... use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver 7.åœ¨è¯¥[vnc]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å’Œé…ç½®è¿œç¨‹æ§åˆ¶å°è®¿é—®ï¼š [vnc] # ... enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html 8.åœ¨è¯¥[glance]éƒ¨åˆ†ä¸­ï¼Œé…ç½®å›¾åƒæœåŠ¡APIçš„ä½ç½®ï¼š [glance] # ... api_servers = http://controller:9292 9.åœ¨è¯¥[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ï¼š [oslo_concurrency] # ... lock_path = /var/lib/nova/tmp 10.åœ¨è¯¥[placement]éƒ¨åˆ†ä¸­ï¼Œé…ç½®Placement APIï¼š [placement] # ... region_name = RegionOne project_domain_name = Default project_name = service auth_type = password user_domain_name = Default auth_url = http://controller:5000/v3 username = placement password = PLACEMENT_PASS #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/nova/nova.conf{,.bak} grep '^[a-Z\\[]' /etc/nova/nova.conf.bak >/etc/nova/nova.conf openstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata openstack-config --set /etc/nova/nova.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.32 openstack-config --set /etc/nova/nova.conf DEFAULT use_neutron true openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver openstack-config --set /etc/nova/nova.conf api auth_strategy keystone openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:5000/v3 openstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password openstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name Default openstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name Default openstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service openstack-config --set /etc/nova/nova.conf keystone_authtoken username nova openstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS openstack-config --set /etc/nova/nova.conf vnc enabled true openstack-config --set /etc/nova/nova.conf vnc server_listen 0.0.0.0 openstack-config --set /etc/nova/nova.conf vnc server_proxyclient_address '$my_ip' openstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://controller:6080/vnc_auto.html openstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292 openstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp openstack-config --set /etc/nova/nova.conf placement region_name RegionOne openstack-config --set /etc/nova/nova.conf placement project_domain_name Default openstack-config --set /etc/nova/nova.conf placement project_name service openstack-config --set /etc/nova/nova.conf placement auth_type password openstack-config --set /etc/nova/nova.conf placement user_domain_name Default openstack-config --set /etc/nova/nova.conf placement auth_url http://controller:5000/v3 openstack-config --set /etc/nova/nova.conf placement username placement openstack-config --set /etc/nova/nova.conf placement password PLACEMENT_PASS MD5å€¼ md5sum /etc/nova/nova.conf c348d4b98cb5dc08fb329050ef592d86 /etc/nova/nova.conf 5.2 å¯åŠ¨ComputeæœåŠ¡åŠå…¶ä¾èµ–é¡¹ï¼Œå¹¶å°†å®ƒä»¬é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶è‡ªåŠ¨å¯åŠ¨ systemctl enable libvirtd.service openstack-nova-compute.service && \\ systemctl start libvirtd.service openstack-nova-compute.service 6.é…ç½®ç½‘ç»œæœåŠ¡neutron 6.1 å®‰è£…åŒ… yum -y install openstack-neutron-linuxbridge ebtables ipset openstack-utils 6.2 é…ç½®å…¬å…±ç»„ä»¶ ç¼–è¾‘/etc/neutron/neutron.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨è¯¥[DEFAULT]éƒ¨åˆ†ä¸­ï¼Œé…ç½®RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—è®¿é—®ï¼š [DEFAULT] # ... transport_url = rabbit://openstack:RABBIT_PASS@controller 2.åœ¨[DEFAULT]å’Œ[keystone_authtoken]éƒ¨åˆ†ä¸­ï¼Œé…ç½®èº«ä»½æœåŠ¡è®¿é—®ï¼š [DEFAULT] # ... auth_strategy = keystone [keystone_authtoken] # ... www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = neutron password = NEUTRON_PASS 3.åœ¨è¯¥[oslo_concurrency]éƒ¨åˆ†ä¸­ï¼Œé…ç½®é”å®šè·¯å¾„ï¼š [oslo_concurrency] # ... lock_path = /var/lib/neutron/tmp #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/neutron.conf{,.bak} grep '^[a-Z\\[]' /etc/neutron/neutron.conf.bak >/etc/neutron/neutron.conf openstack-config --set /etc/neutron/neutron.conf DEFAULT transport_url rabbit://openstack:RABBIT_PASS@controller openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone openstack-config --set /etc/neutron/neutron.conf keystone_authtoken www_authenticate_uri http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:5000 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211 openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp MD5å€¼ md5sum /etc/neutron/neutron.conf 9c47ffb59b23516b59e7de84a39bcbe8 /etc/neutron/neutron.conf 6.3 é…ç½®ç½‘ç»œé€‰é¡¹ 6.3.1 é…ç½®æ¡¥æ¥ä»£ç† Linuxç½‘æ¡¥ä»£ç†ä¸ºå®ä¾‹æ„å»ºç¬¬2å±‚ï¼ˆæ¡¥æ¥å’Œäº¤æ¢ï¼‰è™šæ‹Ÿç½‘ç»œåŸºç¡€ç»“æ„å¹¶å¤„ç†å®‰å…¨ç»„ ç¼–è¾‘/etc/neutron/plugins/ml2/linuxbridge_agent.iniæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ 1.åœ¨æœ¬[linux_bridge]èŠ‚ä¸­ï¼Œå°†æä¾›è€…è™šæ‹Ÿç½‘ç»œæ˜ å°„åˆ°æä¾›è€…ç‰©ç†ç½‘ç»œæ¥å£ï¼š [linux_bridge] physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME æ›¿æ¢PROVIDER_INTERFACE_NAMEä¸ºåŸºç¡€æä¾›å•†ç‰©ç†ç½‘ç»œæ¥å£çš„åç§°ã€‚è¿™é‡Œä¸ºeth0 2.åœ¨è¯¥[vxlan]éƒ¨åˆ†ä¸­ï¼Œç¦ç”¨VXLANè¦†ç›–ç½‘ç»œï¼š [vxlan] enable_vxlan = false 3.åœ¨è¯¥[securitygroup]éƒ¨åˆ†ä¸­ï¼Œå¯ç”¨å®‰å…¨ç»„å¹¶é…ç½®Linuxç½‘æ¡¥iptablesé˜²ç«å¢™é©±åŠ¨ç¨‹åºï¼š [securitygroup] # ... enable_security_group = true firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ \\cp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak} grep '^[a-Z\\[]' /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak >/etc/neutron/plugins/ml2/linuxbridge_agent.ini openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:eth0 openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan false openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group true openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver MD5å€¼ md5sum /etc/neutron/plugins/ml2/linuxbridge_agent.ini 794b19995c83e2fc0c3fd42f506904f1 /etc/neutron/plugins/ml2/linuxbridge_agent.ini ä½¿Linuxæ“ä½œç³»ç»Ÿå†…æ ¸æ”¯æŒç½‘æ¡¥è¿‡æ»¤å™¨1 #å‘/etc/sysctl.d/openstack-rocky-bridge.confå†™å…¥ä»¥ä¸‹å†…å®¹ cat >> /etc/sysctl.d/openstack-rocky-bridge.conf 6.4 é…ç½®è®¡ç®—ä»¥ä½¿ç”¨ç½‘ç»œ ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶å¹¶å®Œæˆä»¥ä¸‹æ“ä½œ åœ¨è¯¥[neutron]éƒ¨åˆ†ä¸­ï¼Œé…ç½®è®¿é—®å‚æ•°ï¼š [neutron] # ... url = http://controller:9696 auth_url = http://controller:5000 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = neutron password = NEUTRON_PASS #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ openstack-config --set /etc/nova/nova.conf neutron url http://controller:9696 openstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:5000 openstack-config --set /etc/nova/nova.conf neutron auth_type password openstack-config --set /etc/nova/nova.conf neutron project_domain_name default openstack-config --set /etc/nova/nova.conf neutron user_domain_name default openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne openstack-config --set /etc/nova/nova.conf neutron project_name service openstack-config --set /etc/nova/nova.conf neutron username neutron openstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS MD5å€¼ md5sum /etc/nova/nova.conf 6ba9c6b28eb8145e4bbec4d9942d1774 /etc/nova/nova.conf 6.5 å®Œæˆå®‰è£… 6.5.1 é‡æ–°å¯åŠ¨ComputeæœåŠ¡ systemctl restart openstack-nova-compute.service 6.5.2 å¯åŠ¨Linuxç½‘æ¡¥ä»£ç†å¹¶å°†å…¶é…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ systemctl enable neutron-linuxbridge-agent.service && \\ systemctl start neutron-linuxbridge-agent.service 6.6 éªŒè¯ æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ æœ‰compute2è¾“å‡ºå¹¶ä¸”çŠ¶æ€ä¸ºupå³ä¸ºæ­£ç¡® openstack network agent list +--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+ | ID | Agent Type | Host | Availability Zone | Alive | State | Binary | +--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+ | 6f3e4e38-0d60-4fd7-b545-b6accccc728e | Linux bridge agent | compute2 | None | :-) | UP | neutron-linuxbridge-agent | | b627a998-e6d2-4cea-b6f1-773f0a294823 | DHCP agent | controller | nova | :-) | UP | neutron-dhcp-agent | | d2999370-36db-43c1-9fa8-dbdf9afcd118 | Linux bridge agent | compute1 | None | :-) | UP | neutron-linuxbridge-agent | | f6e6488d-2be8-425d-99ea-97974450cedf | Linux bridge agent | controller | None | :-) | UP | neutron-linuxbridge-agent | | fc7271f1-f214-4a17-bda7-ba340a61e0f9 | Metadata agent | controller | None | :-) | UP | neutron-metadata-agent | +--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+ 7.éªŒè¯è®¡ç®—èŠ‚ç‚¹æ˜¯å¦å¯ç”¨ æ‰‹åŠ¨åˆ›å»ºè™šæ‹Ÿæœºå¹¶ä¸”æŒ‡å®šè°ƒåº¦åˆ°compute2 éœ€è¦å…ˆåˆ›å»ºåˆ†ç»„ï¼Œåˆ†ç»„åœ¨dashboardä¸­å«ä¸»æœºèšåˆ æŸ¥çœ‹ä¸»æœºèšåˆ ç®¡ç†å‘˜-->è®¡ç®—-->ä¸»æœºèšåˆ åˆ›å»ºä¸»æœºèšåˆ åˆ›å»ºä¸€ä¸ªåç§°ä¸ºcompute2çš„ä¸»æœºèšåˆï¼Œå¯ç”¨åŸŸä¹Ÿå®šä¹‰ä¸ºcompute2 ç‚¹å‡»ç®¡ç†èšåˆå†…çš„ä¸»æœºï¼Œé€‰æ‹©compute2ï¼Œç„¶ååˆ›å»ºä¸»æœºèšåˆ åˆ›å»ºå®Œæˆä¹‹åå¯ç”¨åŸŸä¸­å°±ä¼šå¤šå‡ºä¸€ä¸ªcompute2åŸŸ ç„¶åwebç•Œé¢åˆ›å»ºè™šæ‹Ÿæœº é¡¹ç›®-->è®¡ç®—-->å®ä¾‹-->åˆ›å»ºå®ä¾‹ å®ä¾‹åç§°ä¸ºcompute2ï¼Œå¯ç”¨åŸŸé€‰æ‹©compute2 é€‰æ‹©æµ‹è¯•é•œåƒciiros é€‰æ‹©å®ä¾‹è§„æ ¼ï¼Œç„¶åç‚¹å‡»åˆ›å»ºå®ä¾‹ æˆåŠŸåˆ›å»ºåçš„å®ä¾‹ è¿›å…¥å®ä¾‹æ§åˆ¶å°ï¼Œä½¿ç”¨ç”¨æˆ·cirrosã€å¯†ç gocubsgoç™»é™†ï¼Œç„¶åsudo su -åˆ‡æ¢åˆ°rootç”¨æˆ·ï¼Œè®¾ç½®rootç”¨æˆ·å¯†ç  æ¥ä¸‹æ¥å°±å¯ä»¥ä½¿ç”¨è¿œç¨‹è¿æ¥å·¥å…·è¿æ¥è™šæ‹Ÿæœºäº† æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/rocky/4.openstack åŸŸã€ç”¨æˆ·ã€é¡¹ç›®ã€è§’è‰²ä¹‹é—´çš„å…³ç³».html":{"url":"linux/openstack/rocky/4.openstack åŸŸã€ç”¨æˆ·ã€é¡¹ç›®ã€è§’è‰²ä¹‹é—´çš„å…³ç³».html","title":"openstack åŸŸã€ç”¨æˆ·ã€é¡¹ç›®ã€è§’è‰²ä¹‹é—´çš„å…³ç³»","keywords":"","body":"openstack åŸŸã€ç”¨æˆ·ã€é¡¹ç›®ã€è§’è‰²ä¹‹é—´çš„å…³ç³» åˆ›å»ºé»˜è®¤åŸŸ openstack domain create --description \"Default Domain\" default åˆ›å»ºç®¡ç†é¡¹ç›® openstack project create --domain default \\ --description \"Admin Project\" admin åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ· openstack user create --domain default \\ --password ADMIN_PASS admin åˆ›å»ºç®¡ç†å‘˜è§’è‰² openstack role create admin å°†adminè§’è‰²æ·»åŠ åˆ°adminé¡¹ç›®å’Œç”¨æˆ· openstack role add --project admin --user admin admin ç¤ºæ„å›¾ é¡¹ç›®ã€ç”¨æˆ·ã€è§’è‰²å…³è”å…³ç³» åœ¨xxé¡¹ç›®ä¸­ç»™xxç”¨æˆ·æˆäºˆxxè§’è‰² openstackä¸­ä¼šæœ‰ä¸€ä¸ªdefaulté»˜è®¤åŸŸï¼Œä¹Ÿå¯ä»¥åˆ›å»ºå…¶ä»–çš„åŸŸ defaultåŸŸä¸­ä¼šæœ‰adminé¡¹ç›®ã€serviceé¡¹ç›®ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰é¡¹ç›® defaultåŸŸä¸­ä¼šæœ‰adminç”¨æˆ·ã€æœåŠ¡ç”¨æˆ·ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰ç”¨æˆ· é»˜è®¤çš„è§’è‰²æ˜¯ç®¡ç†å‘˜adminè§’è‰²å’Œæ™®é€šè§’è‰²`userè§’è‰²` æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/rocky/5.glanceé•œåƒæœåŠ¡è¿ç§».html":{"url":"linux/openstack/rocky/5.glanceé•œåƒæœåŠ¡è¿ç§».html","title":"glanceé•œåƒæœåŠ¡è¿ç§»","keywords":"","body":"glanceé•œåƒæœåŠ¡è¿ç§» 1.è¿ç§»æ­¥éª¤ 1ã€glanceæ•°æ®åº“è¿ç§» 2ã€åœ¨æ–°æœºå™¨ä¸Šå®‰è£…glanceæœåŠ¡ 3ã€è¿ç§»ä¹‹å‰å·²æœ‰çš„é•œåƒ 4ã€åœ¨keystoneä¸Šï¼Œä¿®æ”¹glanceæœåŠ¡çš„apiåœ°å€ 5ã€ä¿®æ”¹æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹novaé…ç½®æ–‡ä»¶ä¸­glanceçš„apiåœ°å€ä»¥åŠå—å­˜å‚¨èŠ‚ç‚¹ä¸­cinderé…ç½®æ–‡ä»¶ä¸­glanceçš„apiåœ°å€ 6ã€ä¸Šä¼ æ–°çš„é•œåƒæµ‹è¯•glanceæœåŠ¡æ˜¯å¦æ­£å¸¸ 7ã€å¯åŠ¨ä¸€å°æ–°çš„è™šæ‹Ÿæœºå®Œæˆæµ‹è¯• 2.è¿ç§»è¿‡ç¨‹ 2.1 æ§åˆ¶èŠ‚ç‚¹å¯¼å‡ºglanceæ•°æ®åº“å¹¶æ‹·è´åˆ°æ–°æœºå™¨ æ–°æœºå™¨çš„IPåœ°å€æ˜¯10.0.0.10 #å¤‡ä»½glanceæ•°æ®åº“ mysqldump -B glance >glance-db.sql #æ‹·è´å¤‡ä»½æ–‡ä»¶åˆ°æ–°æœºå™¨ scp -p glance-db.sql 10.0.0.10:~ 2.2 æ–°æœºå™¨é…ç½®hostsè§£æ cat >> /etc/hosts 2.3 æ–°æœºå™¨å®‰è£…mariadbå¹¶è®¾ç½®å¼€å¯è‡ªå¯ yum -y install mariadb mariadb-server python2-PyMySQL systemctl enable mariadb && systemctl start mariadb 2.4 æ–°æœºå™¨å¯¼å…¥æ•°æ®åº“glance-db.sql mysql 2.5 æ–°æœºå™¨ç»™glanceæ•°æ®åº“æˆæƒ #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ mysql -e \"GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' \\ IDENTIFIED BY 'GLANCE_DBPASS';\" mysql -e \"GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \\ IDENTIFIED BY 'GLANCE_DBPASS';\" 2.6 æ§åˆ¶èŠ‚ç‚¹åœæ­¢glanceæœåŠ¡ systemctl stop openstack-glance-api openstack-glance-registry systemctl disable openstack-glance-api openstack-glance-registry 2.7 æ–°æœºå™¨å®‰è£…glance yum -y install openstack-glance openstack-utils 2.8 æ–°æœºå™¨æ‹·è´æ§åˆ¶èŠ‚ç‚¹glanceé…ç½®æ–‡ä»¶ scp -rp 10.0.0.11:/etc/glance/glance-api.conf /etc/glance scp -rp 10.0.0.11:/etc/glance/glance-registry.conf /etc/glance 2.9 æ–°æœºå™¨ç¼–è¾‘glanceé…ç½®æ–‡ä»¶/etc/glance/glance-api.confï¼Œä¿®æ”¹æ•°æ®åº“è¿æ¥ openstack-config --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@localhost/glance MD5å€¼ md5sum /etc/glance/glance-api.conf 76d2be813471725c008245a9d135ea92 /etc/glance/glance-api.conf 2.10 æ–°æœºå™¨ç¼–è¾‘glanceé…ç½®æ–‡ä»¶/etc/glance/glance-registry.conf openstack-config --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@localhost/glance md5sum /etc/glance/glance-registry.conf 7fefe761789d2d4d2afa3409b0e22bb0 /etc/glance/glance-registry.conf 2.11 æ–°æœºå™¨å¯åŠ¨glanceæœåŠ¡ glance-api ç›‘å¬tcp/9292 glance-registry ç›‘å¬tcp/9191 systemctl start openstack-glance-api openstack-glance-registry systemctl enable openstack-glance-api openstack-glance-registry 2.12 æ–°æœºå™¨æ‹·è´æ§åˆ¶èŠ‚ç‚¹/var/lib/glance/imagesä¸‹çš„é•œåƒåˆ°æœ¬åœ°çš„/var/lib/glance/imagesç›®å½•ä¸‹ #å¦‚æœä½¿ç”¨scpçš„è¯ï¼Œæ‹·è´è¿‡æ¥çš„é•œåƒè¿˜éœ€è¦æ‰‹åŠ¨ä¿®æ”¹é•œåƒæ–‡ä»¶æ‰€æœ‰è€…ä¸ºglanceï¼Œæ‹·è´è¿‡æ¥çš„æ–‡ä»¶é»˜è®¤æ‰€æœ‰è€…æ˜¯root rsync -avz 10.0.0.11:/var/lib/glance/images/* /var/lib/glance/images/ 2.13 æ§åˆ¶èŠ‚ç‚¹ä¸Šä¿®æ”¹keystoneä¸­glance apiçš„åœ°å€ keystoneæ•°æ®åº“ä¸­çš„endpointè¡¨è®°å½•äº†å„ä¸ªapiåœ°å€ 2.13.1 å¤‡ä»½keystoneæ•°æ®åº“ä¸­çš„endpointè¡¨ mysqldump keystone endpoint > keystone-endpoint.sql 2.13.2 keystoneæ•°æ®åº“ä¸­çš„endpointè¡¨è®°å½•äº†å„apiçš„åœ°å€ï¼Œå¯ä»¥å…ˆæŸ¥è¯¢ä¸€ä¸‹endpointè¡¨ä¸­æœ‰9292ç«¯å£çš„è®°å½• mysql keystone -e \"select * from endpoint where url like '%9292'\" +----------------------------------+--------------------+-----------+----------------------------------+------------------------+-------+---------+-----------+ | id | legacy_endpoint_id | interface | service_id | url | extra | enabled | region_id | +----------------------------------+--------------------+-----------+----------------------------------+------------------------+-------+---------+-----------+ | 0db3f8b44aff4501a3c866ba01bd546d | NULL | public | eb33b46815ba43a982fc39a9737efa7f | http://controller:9292 | {} | 1 | RegionOne | | 3119eb7c9e6e4bf98cf9b9738d53703d | NULL | admin | eb33b46815ba43a982fc39a9737efa7f | http://controller:9292 | {} | 1 | RegionOne | | 6382b60ec0a94472b6e68f8ecc1d13fe | NULL | internal | eb33b46815ba43a982fc39a9737efa7f | http://controller:9292 | {} | 1 | RegionOne | +----------------------------------+--------------------+-----------+----------------------------------+------------------------+-------+---------+-----------+ 2.13.3 ç„¶åä¿®æ”¹è¿™3æ¡è®°å½•ä¸­çš„url mysql keystone -e \"update endpoint set url='http://10.0.0.10:9292' where url like '%9292'\" 2.13.4 å†æ¬¡æŸ¥çœ‹9292ç›¸å…³è®°å½• urlä¸­çš„åœ°å€ä¿®æ”¹ä¸ºäº†10.0.0.10 mysql keystone -e \"select * from endpoint where url like '%9292'\" +----------------------------------+--------------------+-----------+----------------------------------+-----------------------+-------+---------+-----------+ | id | legacy_endpoint_id | interface | service_id | url | extra | enabled | region_id | +----------------------------------+--------------------+-----------+----------------------------------+-----------------------+-------+---------+-----------+ | 0db3f8b44aff4501a3c866ba01bd546d | NULL | public | eb33b46815ba43a982fc39a9737efa7f | http://10.0.0.10:9292 | {} | 1 | RegionOne | | 3119eb7c9e6e4bf98cf9b9738d53703d | NULL | admin | eb33b46815ba43a982fc39a9737efa7f | http://10.0.0.10:9292 | {} | 1 | RegionOne | | 6382b60ec0a94472b6e68f8ecc1d13fe | NULL | internal | eb33b46815ba43a982fc39a9737efa7f | http://10.0.0.10:9292 | {} | 1 | RegionOne | +----------------------------------+--------------------+-----------+----------------------------------+-----------------------+-------+---------+-----------+ 2.14 æ§åˆ¶èŠ‚ç‚¹éªŒè¯ä¿®æ”¹æ˜¯å¦æˆåŠŸ openstack endpoint list|grep glance | 0db3f8b44aff4501a3c866ba01bd546d | RegionOne | glance | image | True | public | http://10.0.0.10:9292 | | 3119eb7c9e6e4bf98cf9b9738d53703d | RegionOne | glance | image | True | admin | http://10.0.0.10:9292 | | 6382b60ec0a94472b6e68f8ecc1d13fe | RegionOne | glance | image | True | internal | http://10.0.0.10:9292 2.15 æ§åˆ¶èŠ‚ç‚¹ã€è®¡ç®—èŠ‚ç‚¹ä¿®æ”¹/etc/nova/nova.confä¸­glanceçš„åœ°å€ 1.ä¿®æ”¹novaé…ç½®æ–‡ä»¶ openstack-config --set /etc/nova/nova.conf glance api_servers http://10.0.0.10:9292 2.æ§åˆ¶èŠ‚ç‚¹é‡å¯nova-api systemctl restart openstack-nova-api 3.è®¡ç®—èŠ‚ç‚¹é‡å¯nova-compute systemctl restart openstack-nova-compute 2.16 å—å­˜å‚¨èŠ‚ç‚¹ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/cinder/cinder.confä¸­çš„glance apiçš„åœ°å€ 1.ä¿®æ”¹cinderé…ç½®æ–‡ä»¶ä¸­glance apiåœ°å€ openstack-config --set /etc/cinder/cinder.conf DEFAULT glance_api_servers http://10.0.0.10:9292 2.é‡å¯cinderæœåŠ¡ systemctl restart openstack-cinder-volume.service target.service 2.17 æœ€åwebç•Œé¢ä¸Šä¼ é•œåƒå¹¶å¯åŠ¨è™šæ‹Ÿæœºæµ‹è¯• èƒ½æˆåŠŸä¸Šä¼ é•œåƒå¹¶èƒ½æˆåŠŸå¯åŠ¨è™šæ‹Ÿæœºå³ä¸ºæˆåŠŸ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/rocky/6.openstackä¸­çš„å·.html":{"url":"linux/openstack/rocky/6.openstackä¸­çš„å·.html","title":"openstackä¸­çš„å·","keywords":"","body":"openstackä¸­çš„å· openstackä¸­å·å¯ä»¥è½¬æ¢æˆé•œåƒï¼Œé•œåƒä¹Ÿå¯ä»¥è½¬æ¢æˆå· åœ¨å—å­˜å‚¨èŠ‚ç‚¹ä¸Šçš„é…ç½®æ–‡ä»¶/etc/lvm/lvm.confä¸­å®šä¹‰äº†ä½¿ç”¨lvmä½œä¸ºåç«¯å­˜å‚¨ a/sdb/ä»£è¡¨ä¸€ä¸ªlvmï¼Œa/sdc/ä»£è¡¨å¦ä¸€ä¸ªlvmï¼Œå¯ä»¥æœ‰å¤šä¸ªç£ç›˜åšæˆlvm åœ¨è¯¥deviceséƒ¨åˆ†ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæ¥å—/dev/sdbè®¾å¤‡å¹¶æ‹’ç»æ‰€æœ‰å…¶ä»–è®¾å¤‡çš„è¿‡æ»¤ å™¨ï¼š devices { ... filter = [ \"a/sdb/\", \"a/sdc/\", \"r/.*/\"] /etc/cinder/cinder.confæ–‡ä»¶ä¸­å…³äºåç«¯å­˜å‚¨çš„å®šä¹‰ enabled_backends = sata,ssdè¡¨ç¤ºçš„æ˜¯åç«¯å­˜å‚¨çš„åç§°ï¼Œåç§°ä»»æ„ï¼Œè¿™é‡Œä½¿ç”¨/dev/sdbå’Œ/dev/sdcåšäº†ä¸¤ä¸ªlvmï¼Œåˆ†åˆ«æ¨¡æ‹Ÿæ™®é€šçš„sataç›˜å’Œè¾ƒå¿«é€Ÿçš„å›ºæ€ç¡¬ç›˜(ssd) enabled_backendsåè¾¹çš„ä»»æ„åç§°ä¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ä½œä¸ºå•ç‹¬çš„ä¸€ä¸ªåŒºåŸŸå­˜åœ¨ï¼Œè¿™ä¸ªåŒºåŸŸä¸­çš„volume_backend_nameä¼šåœ¨åç»­åˆ›å»ºå·çš„æ—¶å€™æŒ‡å®šç£ç›˜çš„ç±»å‹ï¼Œå…¶ä¸­volume_backend_nameæ˜¯é”®ï¼Œåè¾¹çš„sataå’Œssdæ˜¯å€¼ï¼Œè¿™æ ·çš„è¯å°±èƒ½æŠŠæ™®é€šç£ç›˜å’Œssdç£ç›˜åŒºåˆ†å¼€æ¥å¹¶ä¸”ç»™å®ä¾‹æŒ‚è½½ä¸åŒçš„ç£ç›˜ #åæ®µåç§°ä»»æ„ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸ºæ™®é€šç£ç›˜sataï¼Œå›ºæ€ç¡¬ç›˜ssd [DEFAULT] enabled_backends = sata,ssd [sata] volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver volume_group = cinder-volumes iscsi_protocol = iscsi iscsi_helper = lioadm volume_backend_name = sata [ssd] volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver volume_group = cinder-ssd iscsi_protocol = iscsi iscsi_helper = lioadm volume_backend_name = ssd åˆ›å»ºå·(æ²¡æœ‰å·) é¡¹ç›®-->å·-->å·-->åˆ›å»ºå· åˆ›å»ºä¸€ä¸ªåä¸ºsataçš„å· åˆ›å»ºä¸€ä¸ªåä¸ºssdçš„å· åˆ›å»ºåçš„å· åˆ›å»ºå· ç®¡ç†å‘˜-->å·-->å·-->åˆ›å»ºå· åˆ›å»ºsataå’Œssdå· åˆ›å»ºåçš„å· åˆ›å»ºå·æ‰©å±•è§„æ ¼ ç‚¹å‡»åˆ›å»ºåçš„å·-->æŸ¥çœ‹æ‰©å±•è§„æ ¼ ç‚¹å‡»å·²åˆ›å»º åˆ›å»ºå·æ‰©å±•è§„æ ¼ï¼Œå†™å…¥é…ç½®æ–‡ä»¶ä¸­çš„é”®å’Œå€¼ï¼Œè¿™é‡Œç¤ºä¾‹äº†ssdï¼Œsataæ˜¯åŒæ ·çš„æ“ä½œ é”®å°±æ˜¯/etc/cinder/cinder.confä¸­enabled_backendså¯¹åº”çš„åç«¯å­˜å‚¨åç§°å•ç‹¬åŒºåŸŸä¸­çš„volume_backend_name #åæ®µåç§°ä»»æ„ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸ºæ™®é€šç£ç›˜sataï¼Œå›ºæ€ç¡¬ç›˜ssd [DEFAULT] enabled_backends = sata,ssd [sata] volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver volume_group = cinder-volumes iscsi_protocol = iscsi iscsi_helper = lioadm volume_backend_name = sata [ssd] volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver volume_group = cinder-ssd iscsi_protocol = iscsi iscsi_helper = lioadm volume_backend_name = ssd åˆ›å»ºåçš„å·æ‰©å±•è§„æ ¼ ssd sata åˆ›å»ºå·(æœ‰å·) åˆ é™¤ä¹‹å‰åˆ›å»ºçš„æ²¡æœ‰å·çš„å· åˆ›å»ºsataç±»å‹çš„å·å’Œssdç±»å‹çš„å· åˆ›å»ºåçš„å· ç»™è™šæ‹Ÿæœºå…³è”å· è™šæ‹Ÿæœºä¸­çš„åˆå§‹ç£ç›˜ï¼Œé»˜è®¤æ˜¯1Gå¤§å° é€‰æ‹©è¦è¿æ¥å·çš„è™šæ‹Ÿæœºï¼Œç‚¹å‡»è¿æ¥å· é€‰æ‹©ä¸€ä¸ªå·è¿æ¥ è™šæ‹Ÿæœºä¸­æŸ¥çœ‹ç£ç›˜ï¼Œå‘ç°ä¼šå¤šäº†ä¸€ä¸ª10Gçš„ç£ç›˜ æ ¼å¼åŒ–åæŒ‚è½½ å…³äºå·çš„å®‰å…¨æ€§é—®é¢˜ ä¸Šä¸€æ­¥ä¸­æŠŠæ–°å…³è”çš„å·æŒ‚è½½åˆ°äº†/mntï¼Œç°åœ¨å‘æ–°å…³è”çš„å·å†™å…¥ä¸€äº›å†…å®¹ $ echo 'test ssd' > /mnt/test.txt $ cat /mnt/test.txt test ssd ç„¶ååœ¨webç•Œé¢æŸ¥çœ‹å·çš„ID é¡¹ç›®-->å·-->å·-->ç‚¹å‡»ssd åœ¨å—å­˜å‚¨èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹lvï¼Œå¯ä»¥çœ‹åˆ°volume-c1b20eb9-4e05-4fd6-816b-87d93c7cdcfbæ˜¯å¯¹åº”çš„ssdå· è¿™ä¸ªssdçš„å…·ä½“è·¯å¾„æ˜¯/dev/mapper/cinder--ssd-volume--c1b20eb9--4e05--4fd6--816b--87d93c7cdcfb å½“å°è¯•æŒ‚è½½è¿™ä¸ªssdæ—¶æ˜¯ä¸è¢«å…è®¸çš„ [root@block1 ~]# mount /dev/mapper/cinder--ssd-volume--c1b20eb9--4e05--4fd6--816b--87d93c7cdcfb /opt mount: /dev/mapper/cinder--ssd-volume--c1b20eb9--4e05--4fd6--816b--87d93c7cdcfb is already mounted or /opt busy å¯ä»¥é‡‡ç”¨å…ˆæ‹·è´è¿™ä¸ªæ–‡ä»¶ç„¶åå†æŒ‚è½½(cpã€ddéƒ½å¯ä»¥) #æ‹·è´ç›®å½• cp /dev/mapper/cinder--ssd-volume--c1b20eb9--4e05--4fd6--816b--87d93c7cdcfb /root #æŸ¥çœ‹å¤§å° [root@block1 ~]# ll -h total 10G -rw-r----- 1 root root 10G Jun 2 08:18 cinder--ssd-volume--c1b20eb9--4e05--4fd6--816b--87d93c7cdcfb #æŒ‚è½½ loopçš„æ„æ€æ˜¯ç”¨æ¥æŠŠä¸€ä¸ªæ–‡ä»¶å½“æˆç¡¬ç›˜åˆ†åŒºmountåˆ°ç›®å½• mount -o loop cinder--ssd-volume--c1b20eb9--4e05--4fd6--816b--87d93c7cdcfb /mnt #è¿›å…¥/mntç›®å½•ï¼ŒæŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼Œæ­¤æ—¶æ˜¯å¯ä»¥çœ‹è§çš„ [root@block1 ~]# cd /mnt [root@block1 mnt]# ls lost+found test.txt [root@block1 mnt]# cat test.txt test ssd è®¡ç®—èŠ‚ç‚¹ä¸Šè™šæ‹Ÿæœºä¸­çš„ç£ç›˜æ˜¯å¯ä»¥è¢«æ‹·è´åˆ°è®¡ç®—èŠ‚ç‚¹çš„ï¼Œå¹¶ä¸”å†…å®¹å¯è§ æŠŠè™šæ‹Ÿæœºå¯åŠ¨åœ¨å·ä¸Š openstackä¸­çš„è™šæ‹Ÿæœºé»˜è®¤æ˜¯å¯åŠ¨åœ¨è®¡ç®—èŠ‚ç‚¹ä¸Šçš„ ç‚¹å‡»å®ä¾‹åç§°ï¼ŒæŸ¥çœ‹ç¤ºä¾‹id è™šæ‹Ÿæœºçš„å­˜æ”¾ä½ç½®é»˜è®¤æ˜¯è®¡ç®—èŠ‚ç‚¹ä¸­çš„/var/lib/nova/instances é€‰æ‹©åˆ›å»ºæ–°å·ã€åˆ é™¤å®ä¾‹æ—¶åˆ é™¤å·ï¼Œå¹¶ä¸”æŒ‡å®šå·å¤§å° æºä¸­æŒ‡å®šäº†å·å¤§å°ä¸º5Gï¼Œæ‰€ä»¥è¿™é‡Œè¦é€‰æ‹©å’Œå·å¤§å°ç›¸åŒè§„æ ¼çš„æ ¹ç£ç›˜ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/openstack/rocky/7.å¢åŠ ä¸€ä¸ªflatç½‘ç»œ.html":{"url":"linux/openstack/rocky/7.å¢åŠ ä¸€ä¸ªflatç½‘ç»œ.html","title":"å¢åŠ flatç½‘ç»œ","keywords":"","body":"å¢åŠ ä¸€ä¸ªflatç½‘ç»œ æ§åˆ¶èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹å¢åŠ ä¸€å—ç½‘å¡ï¼Œé…ç½®å¦å¤–ä¸€ä¸ªç½‘æ®µ æ§åˆ¶èŠ‚ç‚¹ ç¼–è¾‘/etc/neutron/plugins/ml2/ml2_conf.ini #å®˜æ–¹æ–‡æ¡£ä¸­é»˜è®¤åªé…ç½®ä¸€ä¸ªç½‘æ®µ [ml2_type_flat] flat_networks = provider #ç°åœ¨å†å¢åŠ ä¸€ä¸ªç½‘æ®µï¼Œåç§°ä¸ºnet_172_16_1 [ml2_type_flat] flat_networks = provider,net_172_16_1 ç¼–è¾‘/etc/neutron/plugins/ml2/linuxbridge_agent.ini #åŸå…ˆé…ç½® [linux_bridge] physical_interface_mappings = provider:eth0 #ç°åœ¨å†å¢åŠ ä¸€ä¸ªç½‘æ®µ [linux_bridge] physical_interface_mappings = provider:eth0,net_172_16_1:eth1 é‡å¯æœåŠ¡ systemctl restart neutron-server.service neutron-linuxbridge-agent.service neutron-dhcp-agent.service è®¡ç®—èŠ‚ç‚¹ ç¼–è¾‘/etc/neutron/plugins/ml2/linuxbridge_agent.ini #åŸå…ˆé…ç½® [linux_bridge] physical_interface_mappings = provider:eth0 #æ”¹ä¸ºå¦‚ä¸‹ [linux_bridge] physical_interface_mappings = provider:eth0,net_172_16_1:eth1 é‡å¯æœåŠ¡ systemctl restart neutron-linuxbridge-agent.service æ§åˆ¶èŠ‚ç‚¹æ£€æŸ¥neutronæœåŠ¡æ˜¯å¦æ­£å¸¸ neutron agent-list neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead. +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ | id | agent_type | host | availability_zone | alive | admin_state_up | binary | +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ | b627a998-e6d2-4cea-b6f1-773f0a294823 | DHCP agent | controller | nova | :-) | True | neutron-dhcp-agent | | d2999370-36db-43c1-9fa8-dbdf9afcd118 | Linux bridge agent | compute1 | | :-) | True | neutron-linuxbridge-agent | | f6e6488d-2be8-425d-99ea-97974450cedf | Linux bridge agent | controller | | :-) | True | neutron-linuxbridge-agent | | fc7271f1-f214-4a17-bda7-ba340a61e0f9 | Metadata agent | controller | | :-) | True | neutron-metadata-agent | +--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+ åˆ›å»ºç½‘ç»œ openstack network create --share --external \\ --provider-physical-network net_172_16_1 \\ --provider-network-type flat net_172_16_1 åˆ›å»ºå­ç½‘ ä¸€ä¸ªç½‘ç»œå¯ä»¥å¯¹åº”å¤šä¸ªå­ç½‘ openstack subnet create --network net_172_16_1 \\ --allocation-pool start=172.16.1.10,end=172.16.1.250 \\ --dns-nameserver 223.5.5.5 --gateway 172.16.1.1 \\ --subnet-range 172.16.1.0/24 net_172_16_1 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/1.centos7å®‰è£…nginx.html":{"url":"linux/linuxæœåŠ¡/nginx/1.centos7å®‰è£…nginx.html","title":"nginxå®‰è£…","keywords":"","body":"centos7å®‰è£…nginx nginxå®˜ç½‘ nginx githubåœ°å€ ä¸€ã€æºç ç¼–è¯‘å®‰è£… nginxå®˜ç½‘æ€»ä¸‹è½½åœ°å€ nginxå®˜æ–¹æºç ä¸‹è½½åœ°å€ nginx githubä¸‹è½½åœ°å€ nginxå®˜æ–¹æºç å®‰è£…æ–‡æ¡£ 1.1 ä¸‹è½½nginxæºç åŒ… wget https://nginx.org/download/nginx-1.17.9.tar.gz 1.2 ç¼–è¯‘å®‰è£…nginx //åˆ›å»ºnginxç”¨æˆ· useradd nginx -s /sbin/nologin -M //å®‰è£…ä¾èµ–åŒ… yum -y install gcc gcc-c++ zlib zlib-devel openssl openssl-devel pcre-devel //è§£å‹ç¼©æºç åŒ… tar xf nginx-1.17.9.tar.gz && cd nginx-1.17.9 //ç¼–è¯‘å®‰è£… ./configure \\ --prefix=/etc/nginx \\ --user=nginx \\ --group=nginx \\ --sbin-path=/usr/sbin/nginx \\ --conf-path=/etc/nginx/nginx.conf \\ --pid-path=/var/run/nginx.pid \\ --lock-path=/var/run/nginx.lock \\ --error-log-path=/var/log/nginx/error.log \\ --http-log-path=/var/log/nginx/access.log \\ --with-http_gzip_static_module \\ --with-http_stub_status_module \\ --with-http_ssl_module \\ --with-pcre \\ --with-file-aio \\ --with-http_realip_module \\ --without-http_scgi_module \\ --without-http_uwsgi_module \\ --without-http_fastcgi_module make && make install ç¼–è¯‘å‚æ•°è¯´æ˜ æ›´å¤šå‚æ•°è¯·ä½¿ç”¨./configure --helpæŸ¥çœ‹æˆ–è€…æŸ¥çœ‹å®˜æ–¹ç¼–è¯‘å®‰è£…è¯´æ˜æ–‡æ¡£ å‚æ•° è¯´æ˜ --prefix nginxå®‰è£…è·¯å¾„ --user nginxè¿è¡Œç”¨æˆ· --group nginxè¿è¡Œç”¨æˆ·ç»„ --sbin-path nginxå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ --conf-path nginxé…ç½®æ–‡ä»¶è·¯å¾„ --pid-path nginx pidæ–‡ä»¶è·¯å¾„ --lock-path nginxé”æ–‡ä»¶è·¯å¾„ --error-log-path nginxé”™è¯¯æ—¥å¿—è·¯å¾„ --http-log-path nginxè®¿é—®æ—¥å¿—è·¯å¾„ --with-http_gzip_static_module æ”¯æŒ.gzå‹ç¼©æ–‡ä»¶ --with-http_stub_status_module æ”¯æŒnginxåŸºæœ¬çŠ¶æ€ä¿¡æ¯è®¿é—® --with-http_ssl_module æ”¯æŒnginx https --with-pcre å¼ºåˆ¶ä½¿ç”¨pcreåº“ --with-file-aio æ”¯æŒå¼‚æ­¥IO --with-http_realip_module å°†å®¢æˆ·ç«¯åœ°å€æ›´æ”¹ä¸ºåœ¨æŒ‡å®šçš„å¤´å­—æ®µä¸­å‘é€çš„åœ°å€ --without-http_scgi_module ç¦æ­¢å°†è¯·æ±‚ä¼ é€’åˆ°SCGIæœåŠ¡å™¨ --without-http_uwsgi_module ç¦æ­¢å°†è¯·æ±‚ä¼ é€’åˆ°uwsgiæœåŠ¡å™¨ --without-http_fastcgi_module ç¦æ­¢å°†è¯·æ±‚ä¼ é€’åˆ°FastCGIæœåŠ¡å™¨ äºŒã€é€šè¿‡yumæºå®‰è£… nginx yumæºå®˜æ–¹åœ°å€ nginx centos yumæºå®˜æ–¹åœ°å€ 2.1 æ·»åŠ nginxå®˜æ–¹yumæº cat > /etc/yum.repos.d/nginx.repo 2.2 å®‰è£…nginx 2.3.1 å®‰è£…æœ€æ–°ç‰ˆ yum -y install nginx 2.3.2 å®‰è£…æŒ‡å®šç‰ˆæœ¬ æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ yum list nginx --showduplicates|sort -r å®‰è£…æŒ‡å®šç‰ˆæœ¬ yum -y install nginx-1.12.2 ä¸‰ã€rpmåŒ…å®‰è£… 3.1 ä¸‹è½½rpmåŒ… nginx rpmåŒ…å®˜æ–¹ä¸‹è½½åœ°å€ nginx centos rpmåŒ…å®˜æ–¹ä¸‹è½½åœ°å€ wget https://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm 3.2 å®‰è£… yum -y localinstall nginx-1.18.0-1.el7.ngx.x86_64.rpm å››ã€nginxé…ç½®æ–‡ä»¶ä¸»è¦æ¨¡å— nginxä¸»é…ç½®æ–‡ä»¶/etc/nginx/nginx.confæ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬ç±»å‹çš„æ–‡ä»¶ï¼Œæ•´ä¸ªé…ç½®æ–‡ä»¶æ˜¯ä»¥åŒºå—çš„å½¢å¼ç»„ç»‡çš„ã€‚ä¸€èˆ¬ï¼Œæ¯ä¸ªåŒºå—ä»¥ä¸€å¯¹å¤§æ‹¬å·{}æ¥è¡¨ç¤ºå¼€å§‹ä¸ç»“æŸã€‚ æ¨¡å—åˆ†ç±» 1.CoreModule æ ¸å¿ƒæ¨¡å— 2.EventModule äº‹ä»¶é©±åŠ¨æ¨¡å— 3.HttpCoreModule httpå†…æ ¸æ¨¡å— CoreModuleå±‚ä¸‹å¯ä»¥æœ‰Eventã€HTTP HTTPæ¨¡å—å±‚å…è®¸æœ‰å¤šä¸ªServerå±‚, Serverä¸»è¦ç”¨äºé…ç½®å¤šä¸ªç½‘ç«™ Serverå±‚åˆå…è®¸æœ‰å¤šä¸ªLocation, Locationä¸»è¦ç”¨äºå®šä¹‰ç½‘ç«™è®¿é—®è·¯å¾„ CoreModuleæ ¸å¿ƒæ¨¡å— user www; #Nginxè¿›ç¨‹æ‰€ä½¿ç”¨çš„ç”¨æˆ· worker_processes 1; #å¯åŠ¨çš„workè¿›ç¨‹æ•°(CPUæ•°é‡ä¸€è‡´æˆ–auto) error_log /log/nginx/error.log #é”™è¯¯æ—¥å¿— pid /var/run/nginx.pid #NginxæœåŠ¡å¯åŠ¨åäº§ç”Ÿçš„pidè¿›ç¨‹å· eventsäº‹ä»¶æ¨¡å— events { worker_connections #æ¯ä¸ªworkerè¿›ç¨‹æ”¯æŒçš„æœ€å¤§è¿æ¥æ•° use #äº‹ä»¶é©±åŠ¨æ¨¡å‹, epollé»˜è®¤ } httpå†…æ ¸æ¨¡å— #å…¬å…±çš„é…ç½®å®šä¹‰åœ¨http{} http { #ä½¿ç”¨Serveré…ç½®ç½‘ç«™, æ¯ä¸ªServer{}ä»£è¡¨ä¸€ä¸ªç½‘ç«™(ç®€ç§°è™šæ‹Ÿä¸»æœº) server { listen 80; #ç›‘å¬ç«¯å£, é»˜è®¤80 server_name localhost; #æä¾›æœåŠ¡çš„åŸŸåæˆ–ä¸»æœºå access_log host.access.log; #è®¿é—®æ—¥å¿— #æ§åˆ¶ç½‘ç«™è®¿é—®è·¯å¾„ location / { root /usr/share/nginx/html; #å­˜æ”¾ç½‘ç«™ä»£ç è·¯å¾„ index index.html index.htm; #æœåŠ¡å™¨è¿”å›çš„é»˜è®¤é¡µé¢æ–‡ä»¶ } #æŒ‡å®šé”™è¯¯ä»£ç , ç»Ÿä¸€å®šä¹‰é”™è¯¯é¡µé¢, é”™è¯¯ä»£ç é‡å®šå‘åˆ°æ–°çš„Locaiton error_page 500 502 503 504 /50x.html; } #ç¬¬äºŒä¸ªè™šæ‹Ÿä¸»æœºé…ç½® server { } include /etc/nginx/conf.d/*.conf; #åŒ…å«/etc/nginx/conf.d/ç›®å½•ä¸‹æ‰€æœ‰ä»¥.confç»“å°¾çš„æ–‡ä»¶ } äº”ã€nginxå·¥ä½œåŸç†ç®€ä»‹ Nginx WEBæœåŠ¡å™¨æœ€ä¸»è¦å°±æ˜¯å„ç§æ¨¡å—çš„å·¥ä½œï¼Œæ¨¡å—ä»ç»“æ„ä¸Šåˆ†ä¸ºæ ¸å¿ƒæ¨¡å—ã€åŸºç¡€æ¨¡å—å’Œç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå…¶ä¸­ä¸‰ç±»æ¨¡å—åˆ†åˆ«å¦‚ä¸‹ï¼š æ ¸å¿ƒæ¨¡å—ï¼šHTTPæ¨¡å—ã€EVENTæ¨¡å—å’ŒMAILæ¨¡å—ç­‰ï¼› åŸºç¡€æ¨¡å—ï¼šHTTP Accessæ¨¡å—ã€HTTP FastCGIæ¨¡å—ã€HTTP Proxyæ¨¡å—å’ŒHTTP Rewriteæ¨¡å—ï¼› ç¬¬ä¸‰æ–¹æ¨¡å—ï¼šHTTP Upstream Request Hashæ¨¡å—ã€Noticeæ¨¡å—å’ŒHTTP Access Keyæ¨¡å—ã€Limit_reqæ¨¡å—ç­‰ï¼› Nginxçš„æ¨¡å—ä»åŠŸèƒ½ä¸Šåˆ†ä¸ºå¦‚ä¸‹ä¸‰ç±»ã€‚ Handlersï¼ˆå¤„ç†å™¨æ¨¡å—ï¼‰ï¼šæ­¤ç±»æ¨¡å—ç›´æ¥å¤„ç†è¯·æ±‚ï¼Œå¹¶è¿›è¡Œè¾“å‡ºå†…å®¹å’Œä¿®æ”¹headersä¿¡æ¯ç­‰æ“ä½œï¼ŒHandlerså¤„ç†å™¨æ¨¡å—ä¸€èˆ¬åªèƒ½æœ‰ä¸€ä¸ªï¼› Filters ï¼ˆè¿‡æ»¤å™¨æ¨¡å—ï¼‰ï¼šæ­¤ç±»æ¨¡å—ä¸»è¦å¯¹å…¶ä»–å¤„ç†å™¨æ¨¡å—è¾“å‡ºçš„å†…å®¹è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œæœ€åç”±Nginxè¾“å‡ºï¼› Proxies ï¼ˆä»£ç†ç±»æ¨¡å—ï¼‰ï¼šæ­¤ç±»æ¨¡å—æ˜¯Nginxçš„HTTP Upstreamä¹‹ç±»çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—ä¸»è¦ä¸åç«¯ä¸€äº›æœåŠ¡æ¯”å¦‚FastCGIç­‰è¿›è¡Œäº¤äº’ï¼Œå®ç°æœåŠ¡ä»£ç†å’Œè´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ã€‚ Nginxç”±å†…æ ¸å’Œæ¨¡å—ç»„æˆï¼Œå…¶ä¸­å†…æ ¸çš„è®¾è®¡éå¸¸å¾®å°å’Œç®€æ´ï¼Œå®Œæˆçš„å·¥ä½œä¹Ÿéå¸¸ç®€å•ï¼Œä»…ä»…é€šè¿‡æŸ¥æ‰¾é…ç½®æ–‡ä»¶å°†å®¢æˆ·ç«¯çš„è¯·æ±‚æ˜ å°„åˆ°ä¸€ä¸ªlocation blockï¼Œè€Œlocationæ˜¯Nginxé…ç½®ä¸­çš„ä¸€ä¸ªæŒ‡ä»¤ï¼Œç”¨äºè®¿é—®çš„URLåŒ¹é…ï¼Œè€Œåœ¨è¿™ä¸ªlocationä¸­æ‰€é…ç½®çš„æ¯ä¸ªæŒ‡ä»¤å°†ä¼šå¯åŠ¨ä¸åŒçš„æ¨¡å—å»å®Œæˆç›¸åº”çš„å·¥ä½œï¼Œå¦‚å›¾æ‰€ç¤ºï¼š Nginxçš„é«˜å¹¶å‘å¾—ç›Šäºå…¶é‡‡ç”¨äº†epollæ¨¡å‹ï¼Œä¸ä¼ ç»Ÿçš„æœåŠ¡å™¨ç¨‹åºæ¶æ„ä¸åŒï¼Œepollæ˜¯Linuxå†…æ ¸2.6ä»¥åæ‰å‡ºç°çš„ï¼ŒNginxé‡‡ç”¨epollæ¨¡å‹ï¼Œå¼‚æ­¥éé˜»å¡ï¼Œè€Œapacheé‡‡ç”¨çš„æ˜¯selectæ¨¡å‹ï¼š Selectç‰¹ç‚¹ï¼šselect é€‰æ‹©å¥æŸ„çš„æ—¶å€™ï¼Œæ˜¯éå†æ‰€æœ‰å¥æŸ„ï¼Œä¹Ÿå°±æ˜¯è¯´å¥æŸ„æœ‰äº‹ä»¶å“åº”æ—¶ï¼Œselectéœ€è¦éå†æ‰€æœ‰å¥æŸ„æ‰èƒ½è·å–åˆ°å“ªäº›å¥æŸ„æœ‰äº‹ä»¶é€šçŸ¥ï¼Œå› æ­¤æ•ˆç‡æ˜¯éå¸¸ä½ã€‚ epollçš„ç‰¹ç‚¹ï¼šepollå¯¹äºå¥æŸ„äº‹ä»¶çš„é€‰æ‹©ä¸æ˜¯éå†çš„ï¼Œæ˜¯äº‹ä»¶å“åº”çš„ï¼Œå°±æ˜¯å¥æŸ„ä¸Šäº‹ä»¶æ¥å°±é©¬ä¸Šé€‰æ‹©å‡ºæ¥ï¼Œä¸éœ€è¦éå†æ•´ä¸ªå¥æŸ„é“¾è¡¨ï¼Œå› æ­¤æ•ˆç‡éå¸¸é«˜ã€‚ Nginxé»˜è®¤ä»¥80ç«¯å£ç›‘å¬åœ¨æœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”å¯åŠ¨ä¸€ä¸ªmasterè¿›ç¨‹ï¼ŒåŒæ—¶æœ‰masterè¿›ç¨‹ç”Ÿæˆå¤šä¸ªå·¥ä½œè¿›ç¨‹ï¼Œå½“æµè§ˆå™¨å‘èµ·ä¸€ä¸ªHTTPè¿æ¥è¯·æ±‚ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å¯èƒ½å¤„ç†è¿™ä¸ªè¿æ¥ï¼Œæ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿæ€ä¹ˆä¿è¯åŒä¸€æ—¶åˆ»ä¸€ä¸ªHTTPè¯·æ±‚è¢«ä¸€ä¸ªå·¥ä½œè¿›ç¨‹å¤„ç†å‘¢ã€‚ é¦–å…ˆæ¯ä¸ªworkerè¿›ç¨‹éƒ½æ˜¯ä»Masterè¿›ç¨‹forkå‡ºæ¥ï¼Œåœ¨Masterè¿›ç¨‹é‡Œé¢ï¼Œå»ºç«‹å¥½éœ€è¦listençš„socketï¼ˆlistenfdï¼‰ä¹‹åï¼Œä¼šforkå‡ºå¤šä¸ªworkerè¿›ç¨‹ã€‚ æ‰€æœ‰workerè¿›ç¨‹çš„listenfdä¼šåœ¨æ–°è¿æ¥åˆ°æ¥æ—¶å˜å¾—å¯è¯»ï¼Œä¸ºä¿è¯åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¤„ç†è¯¥è¿æ¥ï¼Œæ‰€æœ‰workerè¿›ç¨‹åœ¨æ³¨å†Œlistenfdè¯»äº‹ä»¶å‰æŠ¢accept_mutexï¼ŒæŠ¢åˆ°äº’æ–¥é”çš„é‚£ä¸ªè¿›ç¨‹æ³¨å†Œlistenfdè¯»äº‹ä»¶ï¼Œåœ¨è¯»äº‹ä»¶é‡Œè°ƒç”¨acceptæ¥å—è¯¥è¿æ¥ã€‚ å½“ä¸€ä¸ªworkerè¿›ç¨‹åœ¨acceptè¿™ä¸ªè¿æ¥ä¹‹åï¼Œå°±å¼€å§‹è¯»å–è¯·æ±‚ã€è§£æè¯·æ±‚ã€å¤„ç†è¯·æ±‚ï¼Œäº§ç”Ÿæ•°æ®åï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæœ€åæ‰æ–­å¼€è¿æ¥ï¼Œè¿™æ ·å½¢æˆä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚æµç¨‹ã€‚ ç®¡ç†å‘˜---->å‘é€ä¿¡å·--->masterè¿›ç¨‹---->workerè¿›ç¨‹å®¢æˆ·ç«¯ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/2.httpç®€è¦è®°å½•.html":{"url":"linux/linuxæœåŠ¡/nginx/2.httpç®€è¦è®°å½•.html","title":"httpç®€è¦è®°å½•","keywords":"","body":"httpç®€è¦è®°å½• ä¸€ã€httpï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰ ç”±htmlæ–‡ä»¶ ->åŒ…å«å„ç§å„æ ·çš„å…ƒç´ ï¼ˆURLé“¾æ¥ï¼‰->webé¡µé¢ äºŒã€URLç»“æ„ http:// www.qq.com:80 /news/index.html åè®® åŸŸå: ç«¯å£ å…·ä½“çš„æ–‡ä»¶åä¸‹é¢çš„æŸä¸ªé¡µé¢ ä¸‰ã€httpçš„å·¥ä½œåŸç† 1.å®¢æˆ·ç«¯å‘èµ·dnsè¯·æ±‚ 2.è·å–åˆ°åŸŸåå¯¹åº”çš„IPåœ°å€ 3.æµè§ˆå™¨å‘èµ·TCPçš„è¿æ¥ 4.åŸºäºTCPçš„è¿æ¥ï¼Œä¼ è¾“httpçš„è¯·æ±‚ï¼ˆä¸€æ¬¡TCPçš„è¿æ¥ï¼Œå¯ä»¥å»ºç«‹å¤šæ¬¡çš„httpè¯·æ±‚ï¼‰ 5.æµè§ˆå™¨è¯·æ±‚/index.html 6.æœåŠ¡å™¨å“åº”/index.htmlè‡³æµè§ˆå™¨ 7.æµè§ˆå™¨ç¿»è¯‘index.htmlä¸­çš„å†…å®¹ä¸ºäººç±»å¯è¯» 8.æ–­å¼€TCPè¿æ¥-->å››æ¬¡æŒ¥æ‰‹ httpçš„çŸ­è¿æ¥ï¼šå»ºç«‹ä¸€æ¬¡tcpçš„è¿æ¥ï¼Œå‘èµ·ä¸€æ¬¡httpçš„è¯·æ±‚ï¼Œç»“æŸï¼Œtcpæ–­å¼€ httpçš„é•¿è¿æ¥ï¼šå»ºç«‹ä¸€æ¬¡tcpçš„è¿æ¥ï¼Œå‘èµ·å¤šæ¬¡httpçš„è¯·æ±‚ï¼Œç»“æŸï¼Œtcpæ–­å¼€ å››ã€httpçš„è¯·æ±‚æ–¹æ³• æ–¹æ³• æè¿° è¯·æ±‚ å“åº” GET ç”¨æ¥è¯·æ±‚è®¿é—®å·²è¢«URIè¯†åˆ«çš„èµ„æº æŒ‡å®šçš„èµ„æºç»æœåŠ¡å™¨ç«¯è§£æåè¿”å›å“åº”å†…å®¹ GET /index.html HTTP/1.1 Host: www.baidu.com è¿”å›index.htmlçš„é¡µé¢èµ„æº POST ç”¨æ¥ä¼ è¾“å®ä½“çš„ä¸»ä½“ è™½ç„¶ç”¨GETæ–¹æ³•ä¹Ÿå¯ä»¥ä¼ è¾“å®ä½“çš„ä¸»ä½“ï¼Œä½†ä¸€èˆ¬ä¸ç”¨GETæ–¹æ³•è¿›è¡Œä¼ è¾“ï¼Œè€Œæ˜¯ç”¨POSTæ–¹æ³• è™½è¯´POSTçš„åŠŸèƒ½ä¸GETç›¸ä¼¼ï¼Œä½†POSTçš„ä¸»è¦ç›®çš„å¹¶ä¸æ˜¯è·å–å“åº”çš„ä¸»ä½“å†…å®¹ POST /submit.cgi HTTP/1.1 Host: www.baidu.com Content-Length: 1500(1500å­—èŠ‚çš„æ•°æ®) è¿”å›submit.cgiæ¥æ”¶æ•°æ®çš„å¤„ç†ç»“æœ PUT ç”¨æ¥ä¼ è¾“æ–‡ä»¶ å°±åƒFTPåè®®çš„æ–‡ä»¶ä¸Šä¼ ä¸€æ ·ï¼Œè¦æ±‚åœ¨è¯·æ±‚æŠ¥æ–‡çš„ä¸»ä½“ä¸­åŒ…å«æ–‡ä»¶çš„å†…å®¹ï¼Œç„¶åä¿å­˜åˆ°è¯·æ±‚URIæŒ‡å®šçš„ä½ç½® PUT /example.html HTTP/1.1 Host: www.baidu.com Content-Type: text/html Content-Length: 1560(1560å­—èŠ‚çš„æ•°æ®) å“åº”è¿”å›çŠ¶æ€å— 204 No Content(æ¯”å¦‚ï¼šè¯¥htmlå·²å­˜åœ¨äºæœåŠ¡å™¨ä¸Š) HEAD ç”¨äºç¡®è®¤URIçš„æœ‰æ•ˆæ€§åŠèµ„æºæ›´æ–°çš„æ—¥æœŸæ—¶é—´ç­‰ï¼Œå’ŒGETæ–¹æ³•ä¸€æ ·ï¼Œåªæ˜¯ä¸è¿”å›æŠ¥æ–‡ä¸»ä½“éƒ¨åˆ† HEAD /index.html HTTP/1.1 Host: www.baidu.com è¿”å›index.htmlæœ‰å…³çš„å“åº”å¤´éƒ¨ DELETE ç”¨æ¥åˆ é™¤æ–‡ä»¶ï¼Œæ˜¯ä¸PUT ç›¸åçš„æ–¹æ³• æŒ‰è¯·æ±‚URIåˆ é™¤æŒ‡å®šçš„èµ„æº DELETE /example.html HTTP/1.1 Host: www.baidu.com å“åº”è¿”å›çŠ¶æ€å— 204 No Content(æ¯”å¦‚ï¼šè¯¥htmlå·²å­˜åœ¨äºæœåŠ¡å™¨ä¸Š) OPTIONS ç”¨æ¥æŸ¥è¯¢é’ˆå¯¹è¯·æ±‚URIæŒ‡å®šçš„èµ„æºæ”¯æŒçš„æ–¹æ³• OPTIONS * HTTP/1.1 Host: www.baidu.com HTTP/1.1 200 OK Allow: GET,POST,HEAD,OPTIONS(è¿”å›æœåŠ¡å™¨æ”¯æŒçš„æ–¹æ³•) TRACE è®©webæœåŠ¡å™¨ç«¯å°†ä¹‹å‰çš„è¯·æ±‚é€šä¿¡ç¯å›ç»™å®¢æˆ·ç«¯çš„æ–¹æ³• å‘é€è¯·æ±‚æ—¶ï¼Œåœ¨Max-Forwardsé¦–éƒ¨å­—æ®µä¸­å¡«å…¥æ•°å€¼ï¼Œæ¯ç»è¿‡ä¸€ä¸ªæœåŠ¡ç«¯å°±å°†è¯¥æ•°å­—å‡1ï¼Œå½“æ•°å€¼åˆšå¥½å‰‘åˆ°0æ—¶å°±åœæ­¢æŒç»­ä¼ è¾“ï¼Œæœ€åæ¥æ”¶åˆ°è¯·æ±‚çš„æœåŠ¡ç«¯åˆ™è¿”å›çŠ¶æ€ç  200 OK çš„å“åº” TRACE /HTTP/1.1 Host: www.baidu.com Max-Forwards: 2 HTTP/1.1 200 Ok Content-Type: message/http Content-Length: 1024 TRACE / HTTP/1.1 Host: www.baidu.com Max-Forwards: 2(è¿”å›å“åº”åŒ…å«è¯·æ±‚å†…å®¹) CONNECT è¦æ±‚åœ¨ä¸ä»£ç†æœåŠ¡å™¨é€šä¿¡æ—¶å»ºç«‹éš§é“ï¼Œå®ç°ç”¨éš§é“åè®®è¿›è¡ŒTCPé€šä¿¡ï¼Œä¸»è¦ä½¿ç”¨SSLå’ŒTLSåè®®æŠŠé€šä¿¡å†…å®¹åŠ å¯†åç»ç½‘ç»œéš§é“ä¼ è¾“ CONNECT proxy.sample.com:8000 HTTP/1.1 Host: proxy.sample.com HTTP/1.1 200 OK(ä¹‹åè¿›å…¥ç½‘ç»œéš§é“) äº”ã€å¸¸è§httpçš„å“åº”çŠ¶æ€ç ï¼ˆä»¥3ä½æ•°å­—ç»„æˆï¼‰ çŠ¶æ€ç  è¯´æ˜ 200 æˆåŠŸ 301 æ°¸ä¹…é‡å®šå‘ 302 ä¸´æ—¶é‡å®šå‘ 304 æµè§ˆå™¨ç¼“å­˜ 401 æƒé™è®¤è¯å¤±è´¥ 403 è¯·æ±‚ä¸åˆ°é¦–é¡µï¼Œæƒé™è¢«æ‹’ç» 404 èµ„æºæ‰¾ä¸åˆ° 500 æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ 502 é”™è¯¯çš„ç½‘å…³ï¼Œæ‰¾ä¸åˆ°åç«¯èµ„æº 504 è¯·æ±‚è¶…æ—¶ å…­ã€ç”¨æˆ·è®¿é—®ç½‘ç«™æºå¸¦çš„å‚æ•°ï¼Œä»¥åŠæœåŠ¡ç«¯è¿”å›çš„å‚æ•° æ¦‚å†µ å­—æ®µ è¯´æ˜ Request URL: http://www.abc.com/index.html è¯·æ±‚çš„URLåœ°å€ Request Method: GET è¯·æ±‚çš„æ–¹æ³•ï¼ˆè·å–ï¼‰ Status Code: 304 Not Modified è¿”å›çš„çŠ¶æ€ Remote Address: www.abc.com:80 è¯·æ±‚çš„åœ°å€ å®¢æˆ·ç«¯è¯·æ±‚çš„å¤´éƒ¨ä¿¡æ¯ å­—æ®µ è¯´æ˜ Accept: text/html è¯·æ±‚çš„ç±»å‹ Accept-Encoding: gzip, deflate æ˜¯å¦è¿›è¡Œå‹ç¼© Accept-Language: zh-CN,zh;q=0.9 è¯·æ±‚çš„è¯­è¨€ Cache-Control: max-age=0 ç¼“å­˜ Connection: keep-alive TCPé•¿è¿æ¥ Host: www.abc.com è¯·æ±‚çš„åŸŸå If-Modified-Since: Fri, 05 May 2019 09:33:22 GMT ä¿®æ”¹çš„æ—¶é—´ If-None-Match: \"a49-56b5ce607fe00\" æ ‡è®° Upgrade-Insecure-Requests:1 åœ¨httpå’Œhttpsä¹‹é—´èµ·çš„ä¸€ä¸ªè¿‡æ¸¡ä½œç”¨ User-Agent: Mozilla/5.0 ç”¨æˆ·çš„æµè§ˆå™¨ è¯·æ±‚ä¸€ä¸ªç©ºè¡Œ æœåŠ¡ç«¯å“åº”çš„å¤´éƒ¨ä¿¡æ¯ å­—æ®µ è¯´æ˜ HTTP/1.1 304 Not Modified è¿”å›æœåŠ¡å™¨çš„httpåè®®ï¼ŒçŠ¶æ€ç  Date: Fri, 15 Sep 2018 09:15:28 GMT è¿”å›æœåŠ¡å™¨çš„æ—¶é—´ Server: Apache/2.4.6 (CentOS) PHP/5.4.16 è¿”å›æœåŠ¡å™¨ä½¿ç”¨çš„è½¯ä»¶ï¼ˆApache phpï¼‰ Connection: Keep-Alive TCPé•¿è¿æ¥ Keep-Alive: timeout=5, max=100 é•¿è¿æ¥çš„è¶…æ—¶æ—¶é—´ ETag: \"a49-56b5ce607fe00\" éªŒè¯å®¢æˆ·ç«¯æ ‡è®° è¿”å›ä¸€ä¸ªç©ºè¡Œ xxx è¿”å›é¡µé¢å†…å®¹ ä¸ƒã€PVã€UVã€IP PVï¼šé¡µé¢æµè§ˆé‡ UVï¼šç‹¬ç«‹çš„å®¢æˆ· IPï¼šç‹¬ç«‹IP ç¤ºä¾‹è¯´æ˜ å…¬å¸æœ‰100äººï¼Œæ¯ä¸ªäººæœ‰ä¸€å°ç”µè„‘ä¸€ä¸ªæ‰‹æœºï¼Œä¸Šç½‘éƒ½æ˜¯é€šè¿‡natè½¬æ¢å‡ºå£ï¼Œæ¯ä¸ªäººç‚¹å‡»ç½‘ç«™2æ¬¡(å‡è®¾ç‚¹å‡»ä¸€æ¬¡è¿”å›çš„pvæ˜¯1) PVï¼š400 UVï¼š200 IPï¼š1ä¸ª å…«ã€ç”¨æˆ·è®¿é—®ç½‘ç«™çš„å¤§ä½“æµç¨‹ 1.å®¢æˆ·ç«¯è¾“å…¥åŸŸåä»¥åŠè¯·æ±‚çš„é¡µé¢ 2.è§£æåŸŸåå¯¹åº”çš„dns 3.æœ€ç»ˆå®¢æˆ·ç«¯æµè§ˆå™¨è·å–åˆ°dnsçš„IPåœ°å€ 4.å®¢æˆ·ç«¯ä¼šä¸æœåŠ¡ç«¯å‘èµ·TCPçš„ä¸‰æ¬¡æ¡æ‰‹ï¼ˆé•¿è¿æ¥ï¼‰ 5.å®¢æˆ·ç«¯å‘èµ·httpè¯·æ±‚ï¼Œè¯·æ±‚ä¼šå…ˆæŠµè¾¾å‰ç«¯çš„é˜²ç«å¢™ 6.é˜²ç«å¢™è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œæ­£å¸¸çš„è¯·æ±‚é€šè¿‡å†…éƒ¨äº¤æ¢æœºé€šè¿‡TCPè¿æ¥å‰ç«¯çš„è´Ÿè½½å‡è¡¡ï¼Œç„¶åä¼ é€’ç”¨æˆ·çš„httpè¯·æ±‚ 7.è´Ÿè½½æ¥æ”¶åˆ°è¯·æ±‚ï¼Œä¼šæ ¹æ®è¯·æ±‚çš„å†…å®¹è¿›è¡Œä¸‹å‘ä»»åŠ¡ï¼Œé€šè¿‡TCPè¿æ¥åç«¯çš„webï¼Œç„¶åä¸‹å‘ç”¨æˆ·çš„httpè¯·æ±‚ 8.webæ¥æ”¶åˆ°ç”¨æˆ·çš„httpè¯·æ±‚åï¼Œä¼šæ ¹æ®ç”¨æˆ·è¯·æ±‚çš„å†…å®¹è¿›è¡Œè§£æï¼Œè§£æåˆ†ä¸ºå¦‚ä¸‹ä¸¤æ­¥ï¼š â€‹ é™æ€è¯·æ±‚:ç”±webæœåŠ¡å™¨å‘nfså»ºç«‹TCPè¿æ¥ï¼Œè·å–å¯¹åº”çš„å›¾ç‰‡ï¼Œæœ€åè¿”å›ç»™è´Ÿè½½å‡è¡¡ï¼ˆè´Ÿè½½å‡è¡¡->é˜²ç«å¢™->ç”¨æˆ·ï¼‰ â€‹ åŠ¨æ€è¯·æ±‚:ç”±webå‘åç«¯çš„åŠ¨æ€ç¨‹åºå»ºç«‹TCPè¿æ¥ï¼Œå°†ç”¨æˆ·çš„åŠ¨æ€httpè¯·æ±‚ä¼ é€’ç»™åŠ¨æ€ç¨‹åº->ç”±åŠ¨æ€ç¨‹åºè¿›è¡Œè§£æ 9.åŠ¨æ€ç¨‹åºåœ¨è§£æçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç¢°åˆ°æŸ¥è¯¢æ•°æ®åº“çš„è¯·æ±‚ï¼Œåˆ™ä¼˜å…ˆå’Œç¼“å­˜å»ºç«‹TCPçš„è¿æ¥ï¼Œç„¶åç¼“å­˜æœåŠ¡å‘èµ·httpçš„æŸ¥è¯¢ 10.å¦‚æœç¼“å­˜æ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼ŒåŠ¨æ€ç¨‹åºå†æ¬¡å‘æ•°æ®åº“å»ºç«‹TCPçš„è¿æ¥ï¼Œç„¶åå‘èµ·æŸ¥è¯¢æ“ä½œ 11.ç”±æ•°æ®åº“è¿”å›->åŠ¨æ€ç¨‹åº->ç¼“å­˜->webæœåŠ¡->è´Ÿè½½å‡è¡¡->é˜²ç«å¢™->ç”¨æˆ· æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/3.nginxåŸºç¡€åº”ç”¨.html":{"url":"linux/linuxæœåŠ¡/nginx/3.nginxåŸºç¡€åº”ç”¨.html","title":"nginxåŸºç¡€åº”ç”¨","keywords":"","body":"nginxåŸºç¡€åº”ç”¨ ä¸€ã€nginxç›®å½•ç´¢å¼• åŠ å‚æ•°charset utf-8,gbk;è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ autoindex æ˜¯å¦åˆ—å‡ºç½‘ç«™æ ¹ç›®å½•(nginxé»˜è®¤æ˜¯ä¸å…è®¸åˆ—å‡ºæ•´ä¸ªç›®å½•æµè§ˆä¸‹è½½çš„ï¼Œå³autoindex off) é»˜è®¤ä¸ºoffï¼Œç¦æ­¢åˆ—å‡ºç½‘ç«™æ ¹ç›®å½•å†…å®¹ ä¿®æ”¹ä¸ºonï¼Œåˆ—å‡ºç½‘ç«™æ ¹ç›®å½•å†…å®¹ ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.d/www.abc.com æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx nginx -t nginx -s reload åˆ›å»ºç½‘ç«™æ ¹ç›®å½•å¹¶åˆ›å»ºæ–‡ä»¶ mkdir /website && cd /website touch {1..3}.txt æœ¬æœºhostsè§£æï¼Œç„¶åæµè§ˆå™¨è®¿é—®åŸŸåwww.abc.com windows c:\\windows\\system32\\drivers\\etc mac /etc/hosts å½“autoindexä¸ºoffçš„æ—¶å€™æ˜¯æ‹’ç»è®¿é—®ç½‘ç«™æ ¹ç›®å½•çš„ å½“autoindexä¸ºonçš„æ—¶å€™æ˜¯å¯ä»¥è®¿é—®ç½‘ç«™æ ¹ç›®å½•çš„ autoindex_exact_size æ˜¯å¦æ˜¾ç¤ºæ–‡ä»¶çš„ç¡®åˆ‡å¤§å° é»˜è®¤ä¸ºonï¼Œ æ˜¾ç¤ºå‡ºæ–‡ä»¶çš„ç¡®åˆ‡å¤§å°ï¼Œå•ä½æ˜¯bytesã€‚ ä¿®æ”¹ä¸ºoffï¼Œæ˜¾ç¤ºå‡ºæ–‡ä»¶çš„å¤§æ¦‚å¤§å°ï¼Œå•ä½æ˜¯kBæˆ–è€…MBæˆ–è€…GB å½“autoindex_exact_sizeä¸ºonçš„æ—¶å€™ï¼Œæ˜¾ç¤ºæ–‡ä»¶ç¡®åˆ‡å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ å½“autoindex_exact_sizeä¸ºoffçš„æ—¶å€™ï¼Œå¸çº³æ˜¯æ–‡ä»¶çš„å¤§æ¦‚å¸¦ä¸‹ï¼Œå•ä½æ˜¯KB/MB/GBï¼Œæ˜¾ç¤ºå¦‚ä¸‹ autoindex_localtime æ˜¾ç¤ºæ–‡ä»¶ä¿®æ”¹æ—¶é—´æˆ–æ–‡ä»¶æœåŠ¡å™¨æ—¶é—´ é»˜è®¤ä¸ºoffï¼Œæ˜¾ç¤ºçš„æ–‡ä»¶æ—¶é—´ä¸ºGMTæ—¶é—´ã€‚ ä¿®æ”¹ä¸ºonï¼Œ æ˜¾ç¤ºçš„æ–‡ä»¶æ—¶é—´ä¸ºæ–‡ä»¶çš„æœåŠ¡å™¨æ—¶é—´ã€‚ åŒ—äº¬æ—¶é—´=GMTæ—¶é—´+8å°æ—¶ å½“autoindex_localtimeä¸ºoffçš„æ—¶å€™ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ å½“autoindex_localtimeä¸ºonçš„æ—¶å€™ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ âš ï¸ä¸Šä¼ çš„æ–‡ä»¶æ˜¾ç¤ºçš„æ—¶é—´æ˜¯æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´ï¼Œä¸æœåŠ¡å™¨æ—¶é—´æ²¡æœ‰å…³ç³»ï¼Œåœ¨æœåŠ¡å™¨ä¸­åˆ›å»ºçš„æ–‡ä»¶æ‰æ˜¯æœåŠ¡å™¨çš„æ—¶é—´ é…ç½®ç«™ç‚¹ç›®å½•æµè§ˆåŠŸèƒ½ åœ¨nginxé…ç½®æ–‡ä»¶ä¸­å¼€å¯ä»¥ä¸‹å‚æ•°å³å¯ location / { root /xxx; autoindex on; #åˆ—å‡ºæ ¹ç›®å½•ï¼Œé»˜è®¤off autoindex_localtime on; #æ˜¾ç¤ºæ–‡ä»¶æ—¶é—´ä¸ºå½“å‰æœåŠ¡å™¨æ—¶é—´ï¼Œé»˜è®¤off autoindex_exact_size off; #æ˜¾ç¤ºæ–‡ä»¶ç¡®åˆ‡å¤§å°ï¼Œä»¥äººç±»æ˜“è¯»çš„æ–¹å¼æ˜¾ç¤ºï¼Œé»˜è®¤on } äºŒã€nginxçŠ¶æ€ç›‘æ§ nginxä¸­ngx_http_stub_status_moduleç”¨äºå±•ç¤ºnginxè¿æ¥çŠ¶æ€ä¿¡æ¯, éœ€è¦--with-http_stub_status_moduleæ¨¡å—æ”¯æŒ 2.1 æ£€æµ‹nginxæ˜¯å¦æ”¯æŒstub_statusæ¨¡å— ä½¿ç”¨å‘½ä»¤nginx -V &>nginx.txtæŠŠnginxæ”¯æŒçš„æ¨¡å—ä¿¡æ¯æ”¾å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨æ–‡ä»¶ä¸­è¿‡æ»¤--with-http_stub_statusæ¨¡å—(rpmåŒ…æˆ–è€…yumå®‰è£…çš„nginxéƒ½æ”¯æŒ)ï¼Œæ³¨æ„ä¸€å®šè¦å†™æˆ&>ï¼Œåªå†™>ä¸ä¼šæœ‰å†…å®¹ nginx -V &> nginx.txt 2.2 é…ç½®nginx status location /nginx_status { stub_status; access_log off; } 2.3 æµè§ˆå™¨è®¿é—®åŸŸå/nginx_status è¿”å›ç»“æœå¦‚ä¸‹ å„å‚æ•°å«ä¹‰ Active connections:1 #å½“å‰æ´»åŠ¨çš„è¿æ¥æ•° server accepts handled requests 21 21 27 21 #æ€»çš„tcpè¿æ¥æ•°connection 21 #æˆåŠŸtcpè¿æ¥æ•°connection(å¤±è´¥è¿æ¥=(æ€»è¿æ¥æ•°-æˆåŠŸè¿æ¥æ•°)) 27 #æ€»å…±å¤„ç†çš„httpè¯·æ±‚æ•°requests #keepalive_timeout 0; æ¯æ¬¡è¿æ¥éƒ½ä¼šäº§ç”Ÿä¸€æ¬¡è¯·æ±‚(çŸ­è¿æ¥) #keepalive_timeout 60; åœ¨60sä»¥å†…çš„è¯·æ±‚å»ºç«‹åœ¨ä¸€ä¸ªè¿æ¥åŸºç¡€ä¹‹ä¸Š(é•¿è¿æ¥) Reading:0 Writing:1 Waiting: 0 Reading #è¯·æ±‚ Writing #å“åº” Waiting #ç­‰å¾…çš„è¯·æ±‚æ•°ï¼Œå¼€å¯äº†keepalive æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/4.nginxè®¿é—®æ§åˆ¶.html":{"url":"linux/linuxæœåŠ¡/nginx/4.nginxè®¿é—®æ§åˆ¶.html","title":"nginxè®¿é—®æ§åˆ¶","keywords":"","body":"nginxè®¿é—®æ§åˆ¶ è®¿é—®æ§åˆ¶ç±»åˆ« åŸºäºIPçš„è®¿é—®æ§åˆ¶ http_access_module åŸºäºç”¨æˆ·ç™»é™†è®¤è¯çš„è®¿é—®æ§åˆ¶ http_auth_basic_module 1.1 åŸºäºIPçš„è®¿é—®æ§åˆ¶ è¯­æ³•ï¼š allow|deny address 1.1.1 è®¿é—®æ§åˆ¶é…ç½®ç¤ºä¾‹1ï¼Œ æ‹’ç»æŒ‡å®šçš„IPï¼Œå…¶ä»–å…¨éƒ¨å…è®¸ location /nginx_status { stub_status; access_log off; deny 10.0.0.51; allow all; } 10.0.0.51è®¿é—®ï¼Œæƒé™æ‹’ç» $ curl www.abc.com/nginx_status 403 Forbidden 403 Forbidden nginx/1.18.0 10.0.0.52è®¿é—®ï¼Œå¯ä»¥è®¿é—® $ curl www.abc.com/nginx_status Active connections: 1 server accepts handled requests 26 26 31 Reading: 0 Writing: 1 Waiting: 0 1.1.2 è®¿é—®æ§åˆ¶é…ç½®ç¤ºä¾‹2ï¼Œåªå…è®¸è°èƒ½è®¿é—®ï¼Œå…¶å®ƒå…¨éƒ¨æ‹’ç» location / { root /website; index index.php index.html index.htm; allow 192.168.9.0/24; allow 10.0.0.51; deny all; } 10.0.0.51è®¿é—®ï¼Œå¯ä»¥è®¿é—® $ curl www.abc.com www.abc.com çš„ç½‘ç«™æ ¹ç›®å½• 10.0.0.52è®¿é—®ï¼Œæƒé™æ‹’ç» $ curl www.abc.com 403 Forbidden 403 Forbidden nginx/1.18.0 http_access_moduleå±€é™æ€§ å½“å®¢æˆ·ç«¯é€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®çœŸå®çš„åç«¯æœåŠ¡å™¨æ—¶ï¼Œé€šè¿‡remote_addrèƒ½è·å–åˆ°ä»£ç†æœåŠ¡å™¨çš„IPåœ°å€ï¼Œä½†æ˜¯æ— æ³•è·å–å®¢æˆ·ç«¯çš„IPåœ°å€ åœ¨nginxä¸»é…ç½®æ–‡ä»¶/etc/nginx/nginx.confä¸­è®¿é—®æ—¥å¿—æ ¼å¼æœ‰å¦‚ä¸‹å®šä¹‰ log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; nginxè®¿é—®æ—¥å¿—/var/log/nginx/access.logä¸­å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨$remote_addrå¯ä»¥è·å–ç›´æ¥è®¿é—®åç«¯çœŸå®webçš„ä»£ç†æœåŠ¡å™¨çš„IPï¼Œä½†æ˜¯æœ€åè¾¹çš„\"-\"è¡¨æ˜æ— æ³•è·å–çœŸå®å®¢æˆ·ç«¯çš„IP 10.0.0.51 - - [16/Jun/2020:00:27:30 +0800] \"GET / HTTP/1.0\" 200 10 \"-\" \"curl/7.29.0\" \"-\" ç°åœ¨åœ¨ä»£ç†æœåŠ¡å™¨å’Œåç«¯çœŸå®webä¸­çš„nginxå¤´æ–‡ä»¶proxy_paramsä¸­åŠ ä¸Šå‚æ•°X-Forwarded-Forä»¥è·å–å®¢æˆ·ç«¯çœŸå®IPï¼Œç„¶åæ¨¡æ‹Ÿè®¿é—®è¿‡ç¨‹å¦‚ä¸‹ å®¢æˆ·ç«¯10.0.0.10-->é€šè¿‡ä»£ç†æœåŠ¡å™¨10.0.0.51-->è®¿é—®åç«¯çœŸå®web 10.0.0.52 ä»£ç†æœåŠ¡å™¨10.0.0.51 nginxé…ç½® #ç¼–è¾‘nginxåå‘ä»£ç†é…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.d/www.abc.com.conf /etc/nginx/proxy_params åç«¯çœŸå®web 10.0.0.52æ“ä½œ #ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.d/www.abc.com.conf /etc/nginx/proxy_params /website/index.html åŠ ä¸ŠX-Forwarded-Forå‚æ•°åï¼Œnginxçš„è®¿é—®æ—¥å¿—ä¸­å°±å¯ä»¥è·å–åˆ°å®¢æˆ·ç«¯çš„çœŸå®IPåœ°å€äº† 10.0.0.51 - - [16/Jun/2020:10:35:12 +0800] \"GET / HTTP/1.0\" 200 10 \"-\" \"curl/7.29.0\" \"10.0.0.10\" 1.2 åŸºäºç”¨æˆ·ç™»é™†è®¤è¯çš„è®¿é—®æ§åˆ¶ å¯åœ¨httpã€serverã€locationä¸‹æ·»åŠ å¦‚ä¸‹å†…å®¹å³å¯ auth_basic \"Auth access down Input your Passwd!\"; auth_basic_user_file /etc/nginx/auth_file; é…ç½®ç¤ºä¾‹ #å®‰è£…åŒ… yum -y install httpd-tools #åˆ›å»ºä¸€ä¸ªç”¨æˆ·åä¸ºtestå¯†ç ä¸º123çš„ç™»é™†è®¤è¯ç”¨æˆ·ï¼ŒåŒæ—¶å°†å¯†ç å­˜æ”¾äº/etc/nginx/auth_conf htpasswd -b -c /etc/nginx/auth_file test 123 #ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ location / { root /website; auth_basic \"Auth access down Input your Passwd!\"; auth_basic_user_file /etc/nginx/auth_file; autoindex on; autoindex_exact_size off; autoindex_localtime on; charset utf-8,gbk; index index.php index.html index.htm; } æµè§ˆå™¨è®¿é—®æç¤ºéœ€è¦è¾“å…¥ç”¨æˆ·åå’Œå¯†ç  1.3 åŸºäºé…ç½®å‚æ•°çš„è®¿é—®æ§åˆ¶ é™åˆ¶å¯¹httpèµ„æºè®¿é—®çš„å®˜æ–¹æ–‡æ¡£ ngx_http_limit_conn_moduleæ¨¡å—å¯ä»¥æ ¹æ®å®šä¹‰çš„keyæ¥é™åˆ¶æ¯ä¸ªé”®å€¼çš„è¿æ¥æ•° å› ä¸ºä¸€æ¬¡tcpè¿æ¥å¯ä»¥å»ºç«‹å¤šæ¬¡httpè¯·æ±‚è¿æ¥ï¼Œå› æ­¤httpè¯·æ±‚è¿æ¥è¦æ¯”tcpè¿æ¥é™åˆ¶æ›´å‡†ç¡® limit_conn_module è¿æ¥é¢‘ç‡é™åˆ¶ï¼ŒTCPè¿æ¥ limit_req_module è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œhttpè¯·æ±‚è¿æ¥ httpåè®®çš„è¿æ¥ä¸è¯·æ±‚ HTTPæ˜¯å»ºç«‹åœ¨TCPè¿æ¥ä¹‹ä¸Š, åœ¨å®ŒæˆHTTPè¯·æ±‚éœ€è¦å…ˆå»ºç«‹TCPä¸‰æ¬¡æ¡æ‰‹ï¼ˆç§°ä¸ºTCPè¿æ¥ï¼‰,åœ¨è¿æ¥çš„åŸºç¡€ä¸Šå†å‘èµ·HTTPè¯·æ±‚ã€‚ HTTPè¯·æ±‚å»ºç«‹åœ¨ä¸€æ¬¡TCPè¿æ¥åŸºç¡€ä¸Šï¼Œä¸€æ¬¡TCPè¯·æ±‚è‡³å°‘äº§ç”Ÿä¸€æ¬¡HTTPè¯·æ±‚ 1.3.1 nginxè¿æ¥é™åˆ¶é…ç½® limit_conn_module é…ç½®ç¤ºä¾‹ #åœ¨nginxä¸»é…ç½®æ–‡ä»¶/etc/nginx/nginx.conä¸­httpæ¨¡å—ä¸‹åŠ å…¥limit_conn_zone http { #httpæ®µé…ç½®è¿æ¥é™åˆ¶, åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªå®¢æˆ·ç«¯IPè¿æ¥ limit_conn_zone $binary_remote_addr zone=conn_zone:10m; } #åœ¨/etc/nginx.conf.d/xxx.confä¸­åŠ å…¥limit_conn server { location / { #åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªå®¢æˆ·ç«¯IPè¿æ¥ limit_conn conn_zone 1; } } 1.3.2 nginxè¯·æ±‚é™åˆ¶é…ç½® limit_req_module é…ç½®ç¤ºä¾‹ #åœ¨nginxä¸»é…ç½®æ–‡ä»¶/etc/nginx/nginx.conä¸­httpæ¨¡å—ä¸‹åŠ å…¥limit_req_module http { #httpæ®µé…ç½®è¿æ¥é™åˆ¶, 1r/såªæ¥æ”¶ä¸€ä¸ªè¯·æ±‚,å…¶ä½™è¯·æ±‚æ‹’ç»å¤„ç†å¹¶è¿”å›é”™è¯¯ç ç»™å®¢æˆ·ç«¯ limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s; } #åœ¨/etc/nginx.conf.d/xxx.confä¸­åŠ å…¥limit_req server { location / { #1r/såªæ¥æ”¶ä¸€ä¸ªè¯·æ±‚ï¼Œå…¶ä½™è¯·æ±‚æ‹’ç»å¤„ç†å¹¶è¿”å›é”™è¯¯ç ç»™å®¢æˆ·ç«¯ #limit_req zone=req_zone; #è¯·æ±‚è¶…è¿‡1r/sï¼Œå‰©ä¸‹çš„å°†è¢«å»¶è¿Ÿå¤„ç†ï¼Œè¯·æ±‚æ•°è¶…è¿‡burstå®šä¹‰çš„æ•°é‡ï¼Œå¤šä½™çš„è¯·æ±‚è¿”å›503 limit_req zone=req_zone burst=3 nodelay; } } åœ¨ç»ˆç«¯ä¸­å¿«é€Ÿé‡å¤è®¿é—®ï¼Œå°±å¯ä»¥çœ‹åˆ°æœ‰503çš„æŠ¥é”™ [root@test1 ~]# curl www.abc.com www.abc.com çš„ç½‘ç«™æ ¹ç›®å½• [root@test1 ~]# curl www.abc.com www.abc.com çš„ç½‘ç«™æ ¹ç›®å½• [root@test1 ~]# curl www.abc.com 503 Service Temporarily Unavailable 503 Service Temporarily Unavailable nginx/1.18.0 www.abc.com çš„ç½‘ç«™æ ¹ç›®å½• ä¹Ÿå¯ä»¥ç”¨abç®€å•å‹æµ‹ä¸€ä¸‹ -n æŒ‡å®šæ•°é‡ -c æŒ‡å®šå¹¶å‘æ•° å¯ä»¥çœ‹åˆ°è¯·æ±‚æ•°æ˜¯50ï¼Œå¤±è´¥çš„æ•°é‡æ˜¯46ï¼Œå› ä¸ºé…ç½®æ–‡ä»¶ä¸­è¯·æ±‚é™åˆ¶ä¸º1r/sï¼Œburst=3ï¼Œå› æ­¤æˆåŠŸæ•°é‡æ˜¯4 $ ab -n 50 -c 10 www.abc.com/index.html This is ApacheBench, Version 2.3 Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking www.abc.com (be patient).....done Server Software: nginx/1.18.0 Server Hostname: www.abc.com Server Port: 80 Document Path: /index.html Document Length: 31 bytes Concurrency Level: 10 Time taken for tests: 0.005 seconds Complete requests: 50 Failed requests: 46 (Connect: 0, Receive: 0, Length: 46, Exceptions: 0) Write errors: 0 Non-2xx responses: 46 Total transferred: 18972 bytes HTML transferred: 9186 bytes Requests per second: 10066.44 [#/sec] (mean) Time per request: 0.993 [ms] (mean) Time per request: 0.099 [ms] (mean, across all concurrent requests) Transfer rate: 3730.09 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 0 0.1 0 0 Processing: 0 1 0.1 1 1 Waiting: 0 0 0.1 0 1 Total: 1 1 0.1 1 1 Percentage of the requests served within a certain time (ms) 50% 1 66% 1 75% 1 80% 1 90% 1 95% 1 98% 1 99% 1 100% 1 (longest request) è¿æ¥é™åˆ¶æ²¡æœ‰è¯·æ±‚é™åˆ¶æœ‰æ•ˆ? httpå¤šä¸ªè¯·æ±‚å¯ä»¥å»ºç«‹åœ¨ä¸€æ¬¡TCPè¿æ¥ä¹‹ä¸Š, é‚£ä¹ˆæˆ‘ä»¬å¯¹è¯·æ±‚çš„ç²¾åº¦é™åˆ¶ï¼Œè¦æ¯”å¯¹ä¸€ä¸ªè¿æ¥çš„é™åˆ¶ä¼šæ›´åŠ çš„æœ‰æ•ˆã€‚ å› ä¸ºåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªè¿æ¥è¯·æ±‚è¿›å…¥ã€‚ ä½†æ˜¯åŒä¸€æ—¶åˆ»å¤šä¸ªè¯·æ±‚å¯ä»¥é€šè¿‡ä¸€ä¸ªè¿æ¥è¿›å…¥ã€‚ æ‰€ä»¥è¯·æ±‚é™åˆ¶æ‰æ˜¯æ¯”è¾ƒä¼˜çš„è§£å†³æ–¹æ¡ˆã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/5.nginxæ—¥å¿—.html":{"url":"linux/linuxæœåŠ¡/nginx/5.nginxæ—¥å¿—.html","title":"nginxæ—¥å¿—","keywords":"","body":"nginxæ—¥å¿— nginxæ—¥å¿—å®˜æ–¹æ–‡æ¡£ access_logæŒ‡ä»¤ Syntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];access_log off; Default: access_log logs/access.log combined; Context: http, server, location, if in location, limit_except è®¾ç½®ç¼“å†²æ—¥å¿—å†™å…¥çš„è·¯å¾„ã€æ ¼å¼å’Œé…ç½®ã€‚å¯ä»¥åœ¨åŒä¸€çº§åˆ«æŒ‡å®šå¤šä¸ªæ—¥å¿—ã€‚å¯ä»¥é€šè¿‡åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸­æŒ‡å®šâ€œsyslog:â€å‰ç¼€æ¥é…ç½®ç™»å½•åˆ°syslogã€‚ç‰¹æ®Šå€¼offå–æ¶ˆå½“å‰çº§åˆ«ä¸Šçš„æ‰€æœ‰access_logæŒ‡ä»¤ã€‚å¦‚æœæœªæŒ‡å®šæ ¼å¼ï¼Œåˆ™ä½¿ç”¨é¢„å®šä¹‰çš„â€œç»„åˆâ€æ ¼å¼ã€‚ å¦‚æœä½¿ç”¨bufferæˆ–gzip(1.3.10, 1.2.7)å‚æ•°ï¼Œå†™å…¥æ—¥å¿—å°†è¢«ç¼“å†²ã€‚ ç¼“å†²åŒºçš„å¤§å°ä¸èƒ½è¶…è¿‡å¯¹ç£ç›˜æ–‡ä»¶çš„åŸå­å†™å…¥çš„å¤§å°ã€‚å¯¹äºFreeBSDï¼Œè¿™ä¸ªå¤§å°æ˜¯æ— é™åˆ¶çš„ã€‚ å½“å¯ç”¨ç¼“å†²æ—¶ï¼Œæ•°æ®å°†å†™å…¥æ–‡ä»¶: å¦‚æœç¼“å†²åŒºæ— æ³•å®¹çº³ä¸‹ä¸€ä¸ªæ—¥å¿—è¡Œ; å¦‚æœç¼“å†²æ•°æ®æ¯”åˆ·æ–°å‚æ•°(1.3.10,1.2.7)æŒ‡å®šçš„æ—©; å·¥ä½œè¿›ç¨‹é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶æˆ–å…³é—­æ—¥å¿—æ–‡ä»¶æ—¶ã€‚ å¦‚æœä½¿ç”¨äº†gzipå‚æ•°ï¼Œé‚£ä¹ˆç¼“å†²æ•°æ®å°†åœ¨å†™å…¥æ–‡ä»¶ä¹‹å‰è¢«å‹ç¼©ã€‚å‹ç¼©çº§åˆ«å¯ä»¥è®¾ç½®åœ¨1(æœ€å¿«ï¼Œè¾ƒå°‘å‹ç¼©)å’Œ9(æœ€æ…¢ï¼Œæœ€å¥½å‹ç¼©)ä¹‹é—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼“å†²åŒºå¤§å°ä¸º64Kå­—èŠ‚ï¼Œå‹ç¼©çº§åˆ«è®¾ç½®ä¸º1ã€‚ç”±äºæ•°æ®æ˜¯åœ¨åŸå­å—ä¸­å‹ç¼©çš„ï¼Œæ‰€ä»¥â€œzcatâ€å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è§£å‹æˆ–è¯»å–æ—¥å¿—æ–‡ä»¶ã€‚ ç¤ºä¾‹: access_log /path/to/log.gz combined gzip flush=5m; ä¸ºäº†ä½¿gzipå‹ç¼©æ­£å¸¸å·¥ä½œï¼Œå¿…é¡»ä½¿ç”¨zlibåº“æ„å»ºnginxã€‚ æ–‡ä»¶è·¯å¾„å¯ä»¥åŒ…å«å˜é‡(0.7.6+)ï¼Œä½†æ˜¯è¿™æ ·çš„æ—¥å¿—æœ‰ä¸€äº›çº¦æŸ: å·¥ä½œè¿›ç¨‹ä½¿ç”¨å…¶å‡­è¯çš„ç”¨æˆ·åº”è¯¥æœ‰æƒé™åœ¨å…·æœ‰æ­¤ç±»æ—¥å¿—çš„ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶; ç¼“å†²å†™ä¸å·¥ä½œ; æ¯æ¬¡å†™æ—¥å¿—æ—¶ï¼Œéƒ½ä¼šæ‰“å¼€å’Œå…³é—­è¯¥æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œç”±äºå¸¸ç”¨æ–‡ä»¶çš„æè¿°ç¬¦å¯ä»¥å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œæ‰€ä»¥å¯ä»¥åœ¨open_log_file_cacheæŒ‡ä»¤çš„æœ‰æ•ˆå‚æ•°æŒ‡å®šçš„æ—¶é—´å†…ç»§ç»­å†™å…¥æ—§æ–‡ä»¶ åœ¨æ¯ä¸ªæ—¥å¿—å†™æœŸé—´ï¼Œä¼šæ£€æŸ¥è¯·æ±‚çš„æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå®ƒä¸å­˜åœ¨ï¼Œå°±ä¸ä¼šåˆ›å»ºæ—¥å¿—ã€‚å› æ­¤ï¼Œåœ¨åŒä¸€ä¸ªçº§åˆ«ä¸ŠåŒæ—¶æŒ‡å®š root å’Œaccess_logæ˜¯ä¸€ä¸ªå¥½ä¸»æ„: server { root /spool/vhost/data/$host; access_log /spool/vhost/logs/$host; ... } ifå‚æ•°(1.7.0)æ”¯æŒæ¡ä»¶æ—¥å¿—è®°å½•ã€‚å¦‚æœæ¡ä»¶çš„è®¡ç®—ç»“æœä¸ºâ€œ0â€æˆ–ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™ä¸ä¼šè®°å½•è¯·æ±‚ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå“åº”ç ä¸º2xxå’Œ3xxçš„è¯·æ±‚å°†ä¸è¢«è®°å½•: map $status $loggable { ~^[23] 0; default 1; } access_log /path/to/access.log combined if=$loggable; log_formatæŒ‡ä»¤ Syntax: log_format name [escape=default Default: log_format combined \"...\"; Context: http æŒ‡å®šæ—¥å¿—æ ¼å¼ã€‚ è½¬ä¹‰å‚æ•°(1.11.8)å…è®¸åœ¨å˜é‡ä¸­è®¾ç½®jsonæˆ–é»˜è®¤è½¬ä¹‰å­—ç¬¦ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨é»˜è®¤è½¬ä¹‰ã€‚noneå€¼(1.13.10)ç¦æ­¢è½¬ä¹‰ã€‚ å¯¹äºé»˜è®¤è½¬ä¹‰ï¼Œå­—ç¬¦\" \" \" \"ï¼Œ\" \\ \"å’Œå€¼å°äº32(0.7.0)æˆ–å¤§äº126(1.1.6)çš„å­—ç¬¦è¢«è½¬ä¹‰ä¸º\" \\xXX \"ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°å˜é‡å€¼ï¼Œå°†è®°å½•ä¸€ä¸ªè¿å­—ç¬¦(\" - \")ã€‚ å¯¹äºjsonè½¬ä¹‰ï¼Œjsonå­—ç¬¦ä¸²ä¸­ä¸å…è®¸çš„æ‰€æœ‰å­—ç¬¦éƒ½å°†è¿›è¡Œè½¬ä¹‰:å­—ç¬¦â€œâ€å’Œâ€œ\\â€å°†è½¬ä¹‰ä¸ºâ€œ\\â€å’Œâ€œ\\â€ï¼Œå€¼å°äº32çš„å­—ç¬¦å°†è½¬ä¹‰ä¸ºâ€œ\\nâ€ã€â€œ\\râ€ã€â€œ\\tâ€ã€â€œ\\bâ€ã€â€œ\\fâ€æˆ–â€œ\\u00XXâ€ã€‚ æ—¥å¿—æ ¼å¼å¯ä»¥åŒ…å«å¸¸è§çš„å˜é‡ï¼Œä»¥åŠåªåœ¨å†™æ—¥å¿—æ—¶å­˜åœ¨çš„å˜é‡: #ç›¸å…³å­—æ®µå«ä¹‰ $bytes_sent #å‘é€ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•° $connection #è¿æ¥åºåˆ—å· $connection_requests #å½“å‰é€šè¿‡è¿æ¥å‘å‡ºçš„è¯·æ±‚æ•°ï¼ˆ1.1.18ï¼‰ $mse #æ—¥å¿—å†™å…¥æ—¶çš„æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ $pipe #â€œ pâ€ï¼ˆå¦‚æœè¯·æ±‚å·²ä¼ é€’ï¼‰ï¼Œ.å¦åˆ™ä¸ºâ€œ â€ $request_length #è¯·æ±‚é•¿åº¦ï¼ˆåŒ…æ‹¬è¯·æ±‚è¡Œï¼Œæ ‡å¤´å’Œè¯·æ±‚æ­£æ–‡ï¼‰ $request_time #ä»¥æ¯«ç§’ä¸ºå•ä½è¯·æ±‚å¤„ç†æ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ï¼›ä»å®¢æˆ·ç«¯è¯»å–ç¬¬ä¸€ä¸ªå­—èŠ‚åˆ°å°†æœ€åä¸€ä¸ªå­—èŠ‚å‘é€åˆ°å®¢æˆ·ç«¯åçš„æ—¥å¿—å†™å…¥ä¹‹é—´ç»è¿‡çš„æ—¶é—´ $status #ååº”çŠ¶æ€ $time_iso8601 #ISO 8601æ ‡å‡†æ ¼å¼çš„å½“åœ°æ—¶é—´ $time_local #é€šç”¨æ—¥å¿—æ ¼å¼çš„æœ¬åœ°æ—¶é—´ å‘é€ç»™å®¢æˆ·ç«¯çš„å¤´è¡Œå…·æœ‰â€œsenthttpâ€å‰ç¼€ï¼Œä¾‹å¦‚$sent_http_content_rangeã€‚ é…ç½®æ€»æ˜¯åŒ…æ‹¬é¢„å®šä¹‰çš„â€œç»„åˆâ€æ ¼å¼: log_format combined '$remote_addr - $remote_user [$time_local] ' '\"$request\" $status $body_bytes_sent ' '\"$http_referer\" \"$http_user_agent\"'; open_log_file_cacheæŒ‡ä»¤ Syntax: open_log_file_cache max=N [inactive=time] [min_uses=N] [valid=time];open_log_file_cache off; Default: open_log_file_cache off; Context: http, server, location å®šä¹‰ä¸€ä¸ªç¼“å­˜ï¼Œç”¨äºå­˜å‚¨åç§°ä¸­åŒ…å«å˜é‡çš„å¸¸ç”¨æ—¥å¿—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚æŒ‡ä»¤æœ‰ä»¥ä¸‹å‚æ•°: max #è®¾ç½®ç¼“å­˜ä¸­æè¿°ç¬¦çš„æœ€å¤§æ•°é‡ï¼›å¦‚æœç¼“å­˜å·²æ»¡ï¼Œåˆ™å…³é—­æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆLRUï¼‰æè¿°ç¬¦ inactive #è®¾ç½®åœ¨æ­¤æœŸé—´å¦‚æœæ²¡æœ‰è®¿é—®æƒé™åˆ™å…³é—­ç¼“å­˜çš„æè¿°ç¬¦çš„æ—¶é—´ï¼›é»˜è®¤æƒ…å†µä¸‹ä¸º10ç§’ min_uses #è®¾ç½®åœ¨inactiveå‚æ•°å®šä¹‰çš„æ—¶é—´å†…æ–‡ä»¶çš„æœ€å°ä½¿ç”¨é‡ï¼Œä»¥ä½¿æè¿°ç¬¦åœ¨ç¼“å­˜ä¸­ä¿æŒæ‰“å¼€çŠ¶æ€ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œ1 valid #è®¾ç½®æ—¶é—´ï¼Œåœ¨è¯¥æ—¶é—´ååº”æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä»ç„¶å…·æœ‰ç›¸åŒåç§°ï¼›é»˜è®¤æƒ…å†µä¸‹ä¸º60ç§’ off #ç¦ç”¨ç¼“å­˜ ç”¨æ³•ç¤ºä¾‹ open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2; nginxé»˜è®¤æ—¥å¿—æ ¼å¼ log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; å„å­—æ®µå«ä¹‰ å­—æ®µ è¯´æ˜ å¯¹åº”çœŸå®æ—¥å¿—å†…å®¹ $remote_addr è®°å½•å®¢æˆ·ç«¯IPåœ°å€ 10.0.0.51 $remote_user è®°å½•å®¢æˆ·ç«¯ç”¨æˆ·åç§° - - $time_local é€šç”¨æ—¥å¿—æ ¼å¼ä¸‹çš„æœ¬åœ°æ—¶é—´ [16/Jun/2020:10:35:12 +0800] $request è®°å½•è¯·æ±‚çš„URLå’ŒHTTPåè®® \"GET / HTTP/1.0\" $status è®°å½•è¯·æ±‚çŠ¶æ€ç  200 $body_bytes_sent å‘é€ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œä¸åŒ…æ‹¬å“åº”å¤´çš„å¤§å° 10 $http_referer è®°å½•ä»å“ªä¸ªé¡µé¢é“¾æ¥è®¿é—®è¿‡æ¥çš„ \"-\" $http_user_agent è®°å½•å®¢æˆ·ç«¯æµè§ˆå™¨ç›¸å…³ä¿¡æ¯ \"curl/7.29.0\" $http_x_forwarded_for è®°å½•å®¢æˆ·ç«¯çœŸå®IPåœ°å€ \"10.0.0.10\" çœŸå®æ—¥å¿—å†…å®¹ 10.0.0.51 - - [16/Jun/2020:10:35:12 +0800] \"GET / HTTP/1.0\" 200 10 \"-\" \"curl/7.29.0\" \"10.0.0.10\" æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/6.nginxä»£ç†.html":{"url":"linux/linuxæœåŠ¡/nginx/6.nginxä»£ç†.html","title":"nginxä»£ç†","keywords":"","body":"nginxä»£ç† nginxåå‘ä»£ç†å®˜æ–¹æ–‡æ¡£ ä¸€ã€ä»£ç†åˆ†ç±» nginxä»£ç†åˆ†ä¸ºæ­£å‘ä»£ç†å’Œåå‘ä»£ç† æ­£å‘ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯å®¢æˆ·ç«¯ åå‘ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯æœåŠ¡ç«¯ æ­£å‘ä»£ç† æ¦‚å¿µ åœ¨å¦‚ä»Šçš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¦‚æœç”±äºæŠ€æœ¯éœ€è¦è¦å»è®¿é—®å›½å¤–çš„æŸäº›ç½‘ç«™ï¼Œæ­¤æ—¶ä½ ä¼šå‘ç°ä½äºå›½å¤–çš„æŸç½‘ç«™æˆ‘ä»¬é€šè¿‡æµè§ˆå™¨æ˜¯æ²¡æœ‰åŠæ³•è®¿é—®çš„ï¼Œæ­¤æ—¶å¤§å®¶å¯èƒ½éƒ½ä¼šç”¨ä¸€ä¸ªæ“ä½œFQè¿›è¡Œè®¿é—®ï¼ŒFQçš„æ–¹å¼ä¸»è¦æ˜¯æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥è®¿é—®å›½å¤–ç½‘ç«™çš„ä»£ç†æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°†è¯·æ±‚å‘é€ç»™ä»£ç†æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å»è®¿é—®å›½å¤–çš„ç½‘ç«™ï¼Œç„¶åå°†è®¿é—®åˆ°çš„æ•°æ®ä¼ é€’ç»™æˆ‘ä»¬ï¼ ä¸Šè¿°è¿™æ ·çš„ä»£ç†æ¨¡å¼ç§°ä¸ºæ­£å‘ä»£ç†ï¼Œæ­£å‘ä»£ç†æœ€å¤§çš„ç‰¹ç‚¹æ˜¯å®¢æˆ·ç«¯éå¸¸æ˜ç¡®è¦è®¿é—®çš„æœåŠ¡å™¨åœ°å€ï¼›æœåŠ¡å™¨åªæ¸…æ¥šè¯·æ±‚æ¥è‡ªå“ªä¸ªä»£ç†æœåŠ¡å™¨ï¼Œè€Œä¸æ¸…æ¥šæ¥è‡ªå“ªä¸ªå…·ä½“çš„å®¢æˆ·ç«¯ï¼›æ­£å‘ä»£ç†æ¨¡å¼å±è”½æˆ–è€…éšè—äº†çœŸå®å®¢æˆ·ç«¯ä¿¡æ¯ã€‚ ç¤ºæ„å›¾ åå‘ä»£ç† æ¦‚å¿µ å¤šä¸ªå®¢æˆ·ç«¯ç»™nginxæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒnginxæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™åˆ†å‘ç»™äº†åç«¯çš„ä¸šåŠ¡å¤„ç†æœåŠ¡å™¨è¿›è¡Œå¤„ç†ã€‚æ­¤æ—¶è¯·æ±‚çš„æ¥æºä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æ˜¯æ˜ç¡®çš„ï¼Œä½†æ˜¯è¯·æ±‚å…·ä½“ç”±å“ªå°æœåŠ¡å™¨å¤„ç†çš„å°±ä¸æ˜ç¡®äº†ï¼Œnginxæ‰®æ¼”çš„å°±æ˜¯ä¸€ä¸ªåå‘ä»£ç†è§’è‰² åå‘ä»£ç†ï¼Œä¸»è¦ç”¨äºæœåŠ¡å™¨é›†ç¾¤åˆ†å¸ƒå¼éƒ¨ç½²çš„æƒ…å†µä¸‹ï¼Œåå‘ä»£ç†éšè—äº†æœåŠ¡å™¨çš„ä¿¡æ¯ï¼ ç¤ºæ„å›¾ é¡¹ç›®åœºæ™¯ é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨å®é™…é¡¹ç›®æ“ä½œæ—¶ï¼Œæ­£å‘ä»£ç†å’Œåå‘ä»£ç†å¾ˆæœ‰å¯èƒ½ä¼šå­˜åœ¨åœ¨ä¸€ä¸ªåº”ç”¨åœºæ™¯ä¸­ï¼Œæ­£å‘ä»£ç†ä»£ç†å®¢æˆ·ç«¯çš„è¯·æ±‚å»è®¿é—®ç›®æ ‡æœåŠ¡å™¨ï¼Œç›®æ ‡æœåŠ¡å™¨æ˜¯ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ï¼Œåå‘ä»£ç†äº†å¤šå°çœŸå®çš„ä¸šåŠ¡å¤„ç†æœåŠ¡å™¨ã€‚å…¬å¸çš„ç”Ÿäº§ç¯å¢ƒå°±æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¬å¸çš„æ ¸å¿ƒä¸šåŠ¡SASSå¹³å°æ˜¯è¿™æ ·çš„æµç¨‹ åŸŸåè§£æåˆ°äº†é˜¿é‡Œäº‘çš„SLBï¼Œé€šè¿‡SLBæŠŠè¯·æ±‚åˆ†å‘åˆ°å…¬å¸å…¬å…±nginx(ä¸¤å°ECS)ï¼Œç„¶ååˆåœ¨å…¬å…±nginxä¸Šé…ç½®äº†å…·ä½“çš„è½¬å‘è§„åˆ™(locationçš„åŒ¹é…ï¼Œupstreamç­‰)ï¼Œæœ€åæŠŠè¯·æ±‚çš„æµé‡è½¬å‘åˆ°ECSä¸­ï¼Œä¸‹å›¾ä¸­çš„æ­£å‘ä»£ç†å°±ç›¸å½“äºæˆ‘ä»¬çš„SLBï¼Œåå‘ä»£ç†å°±ç›¸å½“äºæˆ‘ä»¬çš„å…¬å…±nginxï¼Œä¸šåŠ¡æœåŠ¡å™¨å°±ç›¸å½“äºåç«¯çš„çœŸå®webæœåŠ¡ECS å…·ä½“çš„æ‹“æ‰‘å›¾å¦‚ä¸‹ äºŒã€nginxä»£ç†é…ç½®ç›¸å…³ è¯­æ³• Syntax: proxy_pass URL; Default: â€” Context: location, if in location, limit_except 2.1 å°†è¯·æ±‚ä¼ é€’åˆ°ä»£ç†æœåŠ¡å™¨ å½“NGINXä»£ç†è¯·æ±‚æ—¶ï¼Œå®ƒå°†è¯·æ±‚å‘é€åˆ°æŒ‡å®šçš„ä»£ç†æœåŠ¡å™¨ï¼Œè·å–å“åº”ï¼Œç„¶åå°†å…¶å‘é€å›å®¢æˆ·ç«¯ã€‚å¯ä»¥ä½¿ç”¨æŒ‡å®šåè®®å°†è¯·æ±‚ä»£ç†åˆ°HTTPæœåŠ¡å™¨ï¼ˆå¦ä¸€ä¸ªNGINXæœåŠ¡å™¨æˆ–ä»»ä½•å…¶ä»–æœåŠ¡å™¨ï¼‰æˆ–éHTTPæœåŠ¡å™¨ï¼ˆå¯ä»¥è¿è¡Œä½¿ç”¨ç‰¹å®šæ¡†æ¶å¼€å‘çš„åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚PHPæˆ–Pythonï¼‰ã€‚æ”¯æŒçš„åè®®åŒ…æ‹¬FastCGIï¼Œuwsgiï¼ŒSCGIå’Œmemcachedã€‚ è¦å°†è¯·æ±‚ä¼ é€’åˆ°HTTPä»£ç†æœåŠ¡å™¨ï¼Œè¯·åœ¨proxy_passä¸­æŒ‡å®šæŒ‡ä»¤locationã€‚ä¾‹å¦‚ï¼š location /some/path/ { proxy_pass http://www.example.com/link/; } æ­¤ç¤ºä¾‹é…ç½®ç»“æœå°†åœ¨æ­¤ä½ç½®å¤„ç†çš„æ‰€æœ‰è¯·æ±‚ä¼ é€’åˆ°æŒ‡å®šåœ°å€çš„ä»£ç†æœåŠ¡å™¨ã€‚æ­¤åœ°å€å¯ä»¥æŒ‡å®šä¸ºåŸŸåæˆ–IPåœ°å€ã€‚åœ°å€è¿˜å¯ä»¥åŒ…æ‹¬ä¸€ä¸ªç«¯å£: location ~ \\.php { proxy_pass http://127.0.0.1:8000; } æ³¨æ„ï¼Œåœ¨ä¸Šé¢çš„ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œä»£ç†æœåŠ¡å™¨çš„åœ°å€åè·ŸURI /link/ã€‚å¦‚æœURIä¸åœ°å€ä¸€èµ·æŒ‡å®šï¼Œå®ƒå°†æ›¿æ¢ä¸ä½ç½®å‚æ•°åŒ¹é…çš„è¯·æ±‚URIéƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œå¸¦æœ‰/some/path/page.html URIçš„è¯·æ±‚å°†è¢«ä»£ç†åˆ°http://www.example.com/link/page.htmlã€‚å¦‚æœæŒ‡å®šçš„åœ°å€æ²¡æœ‰URIï¼Œæˆ–è€…æ— æ³•ç¡®å®šè¦æ›¿æ¢çš„URIéƒ¨åˆ†ï¼Œåˆ™ä¼ é€’(å¯èƒ½æ˜¯ä¿®æ”¹)å®Œæ•´çš„è¯·æ±‚URIã€‚ è¦å°†è¯·æ±‚ä¼ é€’åˆ°éHTTPä»£ç†æœåŠ¡å™¨ï¼Œ**_passåº”ä½¿ç”¨é€‚å½“çš„æŒ‡ä»¤ fastcgi_pass å°†è¯·æ±‚ä¼ é€’ç»™FastCGIæœåŠ¡å™¨ uwsgi_pass å°†è¯·æ±‚ä¼ é€’ç»™uwsgiæœåŠ¡å™¨ scgi_pass å°†è¯·æ±‚ä¼ é€’ç»™SCGIæœåŠ¡å™¨ memcached_pass å°†è¯·æ±‚ä¼ é€’åˆ°å†…å­˜ç¼“å­˜æœåŠ¡å™¨ è¯·æ³¨æ„ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œç”¨äºæŒ‡å®šåœ°å€çš„è§„åˆ™å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚æ‚¨å¯èƒ½è¿˜éœ€è¦å°†å…¶ä»–å‚æ•°ä¼ é€’ç»™æœåŠ¡å™¨ï¼ˆæœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§å‚è€ƒæ–‡æ¡£ï¼‰ã€‚ è¯¥proxy_passæŒ‡ä»¤è¿˜å¯ä»¥æŒ‡å‘æœåŠ¡å™¨çš„å‘½åç»„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†æ ¹æ®æŒ‡å®šçš„æ–¹æ³•åœ¨ç»„ä¸­çš„æœåŠ¡å™¨ä¹‹é—´åˆ†é…è¯·æ±‚ã€‚ ä»£ç†åˆ°åç«¯çš„TCPè¿æ¥ã€å“åº”ã€è¿”å›ç­‰è¶…æ—¶æ—¶é—´ #nginxä»£ç†ä¸åç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶) Syntax: proxy_connect_timeout time; Default: proxy_connect_timeout 60s; Context: http, server, location #nginxä»£ç†ç­‰å¾…åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´ Syntax: proxy_read_timeout time; Default: proxy_read_timeout 60s; Context: http, server, location #åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ ç»™nginxä»£ç†è¶…æ—¶æ—¶é—´ Syntax: proxy_send_timeout time; Default: proxy_send_timeout 60s; Context: http, server, location 2.2 ä¼ é€’è¯·æ±‚å¤´ é»˜è®¤æƒ…å†µä¸‹ï¼ŒNGINXåœ¨ä»£ç†è¯·æ±‚ä¸­é‡æ–°å®šä¹‰ä¸¤ä¸ªå¤´å­—æ®µâ€œ Hostâ€å’Œâ€œ Connectionâ€ï¼Œå¹¶æ¶ˆé™¤å…¶å€¼ä¸ºç©ºå­—ç¬¦ä¸²çš„æ ‡å¤´å­—æ®µã€‚â€œä¸»æœºâ€è®¾ç½®ä¸º$proxy_hostå˜é‡ï¼Œâ€œè¿æ¥â€è®¾ç½®ä¸ºcloseã€‚ è¦æ›´æ”¹è¿™äº›è®¾ç½®ä»¥åŠä¿®æ”¹å…¶ä»–æ ‡é¢˜å­—æ®µï¼Œè¯·ä½¿ç”¨proxy_set_headerä¼ªæŒ‡ä»¤ã€‚å¯ä»¥åœ¨locationæˆ–æ›´é«˜ç‰ˆæœ¬ä¸­æŒ‡å®šæ­¤æŒ‡ä»¤ã€‚ä¹Ÿå¯ä»¥åœ¨ç‰¹å®šserverä¸Šä¸‹æ–‡æˆ–httpå—ä¸­æŒ‡å®šã€‚ä¾‹å¦‚ï¼š location /some/path/ { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_pass http://localhost:8000; } åœ¨æ­¤é…ç½®ä¸­ï¼Œâ€œä¸»æœºâ€å­—æ®µè®¾ç½®ä¸º$hostå˜é‡ã€‚ ä¸ºäº†é˜²æ­¢å°†å¤´å­—æ®µä¼ é€’ç»™ä»£ç†æœåŠ¡å™¨ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å°†å…¶è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼š location /some/path/ { proxy_set_header Accept-Encoding \"\"; proxy_pass http://localhost:8000; } æ·»åŠ å‘å¾€åç«¯æœåŠ¡å™¨çš„è¯·æ±‚å¤´ä¿¡æ¯ #ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™HOSTçš„å€¼æ˜¯www.abc.com, é‚£ä¹ˆä»£ç†æœåŠ¡ä¼šåƒåç«¯ä¼ é€’è¯·æ±‚çš„è¿˜æ˜¯www.abc.com proxy_set_header Host $http_host; #å°†$remote_addrçš„å€¼æ”¾è¿›å˜é‡X-Real-IPä¸­ï¼Œ$remote_addrçš„å€¼ä¸ºå®¢æˆ·ç«¯çš„ip proxy_set_header X-Real-IP $remote_addr; #å®¢æˆ·ç«¯é€šè¿‡ä»£ç†æœåŠ¡è®¿é—®åç«¯æœåŠ¡, åç«¯æœåŠ¡é€šè¿‡è¯¥å˜é‡ä¼šè®°å½•çœŸå®å®¢æˆ·ç«¯åœ°å€ proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 2.3 é…ç½®ç¼“å†²åŒº é»˜è®¤æƒ…å†µä¸‹ï¼ŒNGINXç¼“å†²æ¥è‡ªä»£ç†æœåŠ¡å™¨çš„å“åº”ã€‚å“åº”å­˜å‚¨åœ¨å†…éƒ¨ç¼“å†²åŒºä¸­ï¼Œç›´åˆ°æ¥æ”¶åˆ°æ•´ä¸ªå“åº”åæ‰å‘é€ç»™å®¢æˆ·ç«¯ã€‚ç¼“å†²æœ‰åŠ©äºä¼˜åŒ–æ…¢é€Ÿå®¢æˆ·ç«¯çš„æ€§èƒ½ï¼Œå¦‚æœå“åº”ä»NGINXåŒæ­¥ä¼ é€’åˆ°å®¢æˆ·ç«¯ï¼Œåˆ™è¿™å¯èƒ½ä¼šæµªè´¹ä»£ç†æœåŠ¡å™¨çš„æ—¶é—´ã€‚ä½†æ˜¯ï¼Œå¯ç”¨ç¼“å†²åï¼ŒNGINXå…è®¸ä»£ç†æœåŠ¡å™¨å¿«é€Ÿå¤„ç†å“åº”ï¼Œè€ŒNGINXå°†å“åº”å­˜å‚¨çš„æ—¶é—´ä¸å®¢æˆ·ç«¯ä¸‹è½½å“åº”æ‰€éœ€çš„æ—¶é—´ä¸€æ ·é•¿ã€‚ è´Ÿè´£å¯ç”¨å’Œç¦ç”¨ç¼“å†²çš„æŒ‡ä»¤æ˜¯proxy_bufferingã€‚é»˜è®¤æƒ…å†µä¸‹å°†å…¶è®¾ç½®ä¸ºonå¹¶å¯ç”¨ç¼“å†²ã€‚ è¯¥proxy_buffersæŒ‡ä»¤æ§åˆ¶è§„æ¨¡å’Œåˆ†é…çš„è¯·æ±‚ç¼“å†²åŒºçš„æ•°ç›®ã€‚æ¥è‡ªä»£ç†æœåŠ¡å™¨çš„å“åº”çš„ç¬¬ä¸€éƒ¨åˆ†å­˜å‚¨åœ¨å•ç‹¬çš„ç¼“å†²åŒºä¸­ï¼Œç¼“å†²åŒºçš„å¤§å°ç”±proxy_buffer_sizeä¼ªæŒ‡ä»¤è®¾ç½®ã€‚è¿™éƒ¨åˆ†é€šå¸¸åŒ…å«ä¸€ä¸ªç›¸å¯¹è¾ƒå°çš„å“åº”å¤´ï¼Œå¹¶ä¸”å¯ä»¥ä½¿å…¶å°äºå…¶ä½™å“åº”çš„ç¼“å†²åŒºã€‚ åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå¢åŠ äº†é»˜è®¤ç¼“å†²åŒºæ•°ï¼Œå¹¶ä½¿å“åº”ç¬¬ä¸€éƒ¨åˆ†çš„ç¼“å†²åŒºå¤§å°å°äºé»˜è®¤å€¼ã€‚ location /some/path/ { proxy_buffers 16 4k; proxy_buffer_size 2k; proxy_pass http://localhost:8000; } å¦‚æœç¦ç”¨äº†ç¼“å†²ï¼Œåˆ™å“åº”å°†ä»å®¢æˆ·ç«¯æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å“åº”åŒæ­¥å‘é€åˆ°å®¢æˆ·ç«¯ã€‚å¯¹äºéœ€è¦å°½å¿«å¼€å§‹æ¥æ”¶å“åº”çš„å¿«é€Ÿäº¤äº’å®¢æˆ·ç«¯ï¼Œæ­¤è¡Œä¸ºå¯èƒ½æ˜¯ç†æƒ³çš„ã€‚ è¦åœ¨ç‰¹å®šä½ç½®ç¦ç”¨ç¼“å†²ï¼Œè¯·å°†proxy_bufferingä¼ªæŒ‡ä»¤locationä¸offå‚æ•°ä¸€èµ·æ”¾ç½®åœ¨ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š location /some/path/ { proxy_buffering off; proxy_pass http://localhost:8000; } åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒNGINXä»…ä½¿ç”¨é…ç½®çš„ç¼“å†²åŒºproxy_buffer_sizeæ¥å­˜å‚¨å“åº”çš„å½“å‰éƒ¨åˆ†ã€‚ åå‘ä»£ç†çš„å¸¸è§ç”¨æ³•æ˜¯æä¾›è´Ÿè½½å¹³è¡¡ã€‚åœ¨å…è´¹çš„ã€Šé€‰æ‹©è½¯ä»¶è´Ÿè½½å¹³è¡¡å™¨çš„äº”ä¸ªç†ç”±ã€‹ç”µå­ä¹¦ä¸­ï¼Œäº†è§£å¦‚ä½•æé«˜æ€§èƒ½ï¼Œæ€§èƒ½å¹¶é€šè¿‡å¿«é€Ÿéƒ¨ç½²ä¸“æ³¨äºæ‚¨çš„åº”ç”¨ç¨‹åºã€‚ proxy_bufferä»£ç†ç¼“å†²åŒº #nignxä¼šæŠŠåç«¯è¿”å›çš„å†…å®¹å…ˆæ”¾åˆ°ç¼“å†²åŒºå½“ä¸­ï¼Œç„¶åå†è¿”å›ç»™å®¢æˆ·ç«¯,è¾¹æ”¶è¾¹ä¼ , ä¸æ˜¯å…¨éƒ¨æ¥æ”¶å®Œå†ä¼ ç»™å®¢æˆ·ç«¯ Syntax: proxy_buffering on | off; Default: proxy_buffering on; Context: http, server, location #è®¾ç½®nginxä»£ç†ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å° Syntax: proxy_buffer_size size; Default: proxy_buffer_size 4k|8k; Context: http, server, location #proxy_buffers ç¼“å†²åŒº Syntax: proxy_buffers number size; Default: proxy_buffers 8 4k|8k; Context: http, server, location 2.4 é€‰æ‹©è½¬å‘IPåœ°å€ å¦‚æœä»£ç†æœåŠ¡å™¨å…·æœ‰å¤šä¸ªç½‘ç»œæ¥å£ï¼Œæœ‰æ—¶æ‚¨å¯èƒ½éœ€è¦é€‰æ‹©ç‰¹å®šçš„æºIPåœ°å€ä»¥è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨æˆ–ä¸Šæ¸¸æœåŠ¡å™¨ã€‚å¦‚æœå°†NGINXä¹‹åçš„ä»£ç†æœåŠ¡å™¨é…ç½®ä¸ºæ¥å—æ¥è‡ªç‰¹å®šIPç½‘ç»œæˆ–IPåœ°å€èŒƒå›´çš„è¿æ¥ï¼Œè¿™å¯èƒ½å¾ˆæœ‰ç”¨ã€‚ æŒ‡å®šproxy_bindæŒ‡ä»¤å’Œå¿…è¦çš„ç½‘ç»œæ¥å£çš„IPåœ°å€ï¼š location /app1/ { proxy_bind 127.0.0.1; proxy_pass http://example.com/app1/; } location /app2/ { proxy_bind 127.0.0.2; proxy_pass http://example.com/app2/; } IPåœ°å€ä¹Ÿå¯ä»¥ç”¨å˜é‡æŒ‡å®šã€‚ä¾‹å¦‚ï¼Œ$server_addrå˜é‡ä¼ é€’æ¥å—è¯·æ±‚çš„ç½‘ç»œæ¥å£çš„IPåœ°å€ï¼š location /app3/ { proxy_bind $server_addr; proxy_pass http://example.com/app3/; } ä¸‰ã€é…ç½®nginxåå‘ä»£ç† åœ¨ä»£ç†æœåŠ¡å™¨å’Œåç«¯çœŸå®webä¸­çš„nginxå¤´æ–‡ä»¶proxy_paramsä¸­åŠ ä¸Šå‚æ•°X-Forwarded-Forä»¥è·å–å®¢æˆ·ç«¯çœŸå®IPï¼Œç„¶åæ¨¡æ‹Ÿè®¿é—®è¿‡ç¨‹å¦‚ä¸‹ å®¢æˆ·ç«¯10.0.0.10-->é€šè¿‡ä»£ç†æœåŠ¡å™¨10.0.0.51-->è®¿é—®åç«¯çœŸå®web 10.0.0.52 ä»£ç†æœåŠ¡å™¨10.0.0.51 nginxé…ç½® #ç¼–è¾‘nginxåå‘ä»£ç†é…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.d/www.abc.com.conf /etc/nginx/proxy_params åç«¯çœŸå®web 10.0.0.52æ“ä½œ #ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.d/www.abc.com.conf /etc/nginx/proxy_params /website/index.html å®¢æˆ·ç«¯10.0.0.10åšæœ¬åœ°hostsè§£æ 10.0.0.51 www.abc.com å®¢æˆ·ç«¯10.0.0.10è®¿é—®www.abc.comï¼Œç»è¿‡nginxä»£ç†æœåŠ¡å™¨10.0.0.51å°†è¯·æ±‚è½¬å‘è‡³åç«¯çœŸå®web 10.0.0.52ï¼Œæœ€ç»ˆè®¿é—®åˆ°çš„å†…å®¹å¦‚ä¸‹ $ curl www.abc.com 10.0.0.52 åŠ ä¸ŠX-Forwarded-Forå‚æ•°åï¼Œnginxçš„è®¿é—®æ—¥å¿—(çœŸå®webæœåŠ¡å™¨10.0.0.52æŸ¥çœ‹)ä¸­å°±å¯ä»¥è·å–åˆ°å®¢æˆ·ç«¯çš„çœŸå®IPåœ°å€äº† 10.0.0.51 - - [16/Jun/2020:10:35:12 +0800] \"GET / HTTP/1.0\" 200 10 \"-\" \"curl/7.29.0\" \"10.0.0.10\" æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/7.nginx location.html":{"url":"linux/linuxæœåŠ¡/nginx/7.nginx location.html","title":"nginx location","keywords":"","body":"nginx location nginx locationå®˜æ–¹æ–‡æ¡£ åŒ¹é…è¯­æ³• location [ = | ~ | ~* | ^~ ] uri { ... } location @name { ... } location [åŒ¹é…æ¨¡å¼] uri { ... } locationåŒ¹é…è§„åˆ™ åŒ¹é…è§„åˆ™æ€»è§ˆ åŒ¹é…æ¨¡å¼ åŒ¹é…ç¬¦ ä¼˜å…ˆçº§ ç²¾ç¡®åŒ¹é… = 1 å‰ç¼€åŒ¹é… ^~ 2 æ­£åˆ™åŒ¹é… ~ 3 æ­£å¸¸åŒ¹é… uri 4 å…¨åŒ¹é…(é€šç”¨åŒ¹é…) / 5 åŒ¹é…è§„åˆ™ç»†åˆ† åŒ¹é…ç¬¦ åŒ¹é…è§„åˆ™ ä¼˜å…ˆçº§ = ç²¾ç¡®åŒ¹é… 1 ^~ ä»¥æŸä¸ªå­—ç¬¦ä¸²å¼€å¤´ 2 ~ åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é… 3 ~* ä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é… 4 !~ åŒºåˆ†å¤§å°å†™ä¸åŒ¹é…çš„æ­£åˆ™ 5 !~* ä¸åŒºåˆ†å¤§å°å†™ä¸åŒ¹é…çš„æ­£åˆ™ 6 / é€šç”¨åŒ¹é…ï¼Œä»»ä½•è¯·æ±‚éƒ½ä¼šåŒ¹é…åˆ° 7 locationåŒ¹é…ä¼˜å…ˆçº§ è·¯å¾„åŒ¹é…ä¼˜å…ˆçº§ ç²¾ç¡®åŒ¹é… > å‰ç¼€åŒ¹é… > æ­£åˆ™åŒ¹é… > æ­£å¸¸åŒ¹é… > å…¨åŒ¹é… åŒ¹é…ç¤ºä¾‹ ç²¾ç¡®åŒ¹é… âš ï¸server_name _ ä¸­çš„_åªæ˜¯ä¸€ä¸ªæ— æ•ˆåŸŸåçš„è¡¨ç¤ºæ–¹æ³• ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; # ç¬¬1æ®µ location /nginx { #return 200 \"aaa\"; root /data/nginx/html4/; index index.html; } # ç¬¬2æ®µ location = /nginx { #return 200 \"bbb\"; root /data/nginx/html3/; index index.html; } } åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir -p /data/nginx/html{3,4}/nginx echo 'html3' >/data/nginx/html3/nginx/index.html echo 'html4' >/data/nginx/html4/nginx/index.html è®¿é—®æµ‹è¯• $ curl 127.0.0.1/nginx 301 Moved Permanently 301 Moved Permanently nginx/1.18.0 $ curl 127.0.0.1/nginx/ html4 ç²¾ç¡®åŒ¹é…ä¸­ '/nginx/'ä¸­ä¼˜å…ˆåŒ¹é…åˆ°ç¬¬2æ®µï¼Œå†è®¿é—®'/nginx/index.html'ï¼Œæ­¤æ¬¡å†…éƒ¨è·³è½¬uriå·²ç»æ˜¯/nginx/index.htmlï¼Œè€Œé=çš„ï¼›æœ€ç»ˆè®¿é—®ç»“æœæ˜¯ç¬¬1æ®µä¸­çš„index.htmlã€‚ ç»“è®ºï¼šç²¾ç¡®åŒ¹é…åŒºåˆ†å¤§å°å†™ï¼Œä¸èƒ½ä½¿ç”¨æ­£åˆ™ï¼Œè®¿é—®çš„URIå¿…é¡»å®Œå…¨ä¸=åé¢çš„ä¸€è‡´ï¼Œå¤šä¸€ä¸ª\"/\"æˆ–è€…å°‘ä¸€ä¸ª\"/\"ï¼Œéƒ½æ˜¯ä¸å¯ä»¥çš„ã€‚ å‰ç¼€åŒ¹é… ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; location ^~ /nginx/ { rewrite ^ https://www.163.com break; } location ^~ /nginx/bcd/ { rewrite ^ https://www.qq.com break; } location ^~ /Abc/ { rewrite ^ https://www.sina.com.cn break; } } è®¿é—®æµ‹è¯• è®¿é—®127.0.0.1/nginx/ï¼Œåœ¨ç»ˆç«¯ä¸­ä¼šè¿”å›302ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¼šè·³è½¬åˆ°www.163.com $ curl 127.0.0.1/nginx/ 302 Found 302 Found nginx/1.18.0 è®¿é—®127.0.0.1/nginx/bcd/ï¼Œåœ¨ç»ˆç«¯ä¸­ä¼šè¿”å›302ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¼šè·³è½¬åˆ°www.qq.com âš ï¸å¦‚æœbcdåè¾¹ä¸åŠ /ï¼Œè·³è½¬é¡µé¢æ˜¯www.163.comï¼Œå³åªåŒ¹é…å‰ç¼€/nginx $ curl 127.0.0.1/nginx/bcd/ 302 Found 302 Found nginx/1.18.0 è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢127.0.0.1/nginx/abcd/ï¼Œåœ¨ç»ˆç«¯ä¸­ä¼šè¿”å›302ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¼šè·³è½¬åˆ°www.163.com $ curl 127.0.0.1/nginx/abcd/ 302 Found 302 Found nginx/1.18.0 è®¿é—®127.0.0.1/Abc/ï¼Œåœ¨ç»ˆç«¯ä¸­ä¼šè¿”å›302ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¼šè·³è½¬åˆ°www.sina.com.cn $ curl 127.0.0.1/nginx/abc/ 302 Found 302 Found nginx/1.18.0 ç»“è®ºï¼šå‰ç¼€åŒ¹é…ä¸èƒ½ä½¿ç”¨æ­£åˆ™ï¼ŒåŒºåˆ†å¤§å°å†™ï¼Œåªè¦å‰ç¼€ç›¸åŒï¼Œéƒ½å¯ä»¥åŒ¹é…æˆåŠŸï¼Œä¸ç®¡åé¢æœ‰æ²¡æœ‰å­—ç¬¦ï¼Œä¿è¯å‰ç¼€ç›¸åŒå³å¯ã€‚ æ­£åˆ™åŒ¹é… ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; location ~ /[a-z]nginx/ { rewrite ^ https://www.baidu.com break; } location ~* /[a-z]nginx/ { rewrite ^ https://www.163.com break; } } è®¿é—®æµ‹è¯• è®¿é—®127.0.0.1/anginx/ï¼Œåœ¨ç»ˆç«¯ä¸­ä¼šè¿”å›302ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¼šè·³è½¬åˆ°www.baidu.com $ curl 127.0.0.1/anginx/ 302 Found 302 Found nginx/1.18.0 è®¿é—®127.0.0.1/anginx/abcåœ¨ç»ˆç«¯ä¸­ä¼šè¿”å›302ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¼šè·³è½¬åˆ°www.baidu.com $ curl 127.0.0.1/anginx/abc/ 302 Found 302 Found nginx/1.18.0 è®¿é—®127.0.0.1/Anginx/ï¼Œåœ¨ç»ˆç«¯ä¸­ä¼šè¿”å›302ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¼šè·³è½¬åˆ°www.163.com $ curl 127.0.0.1/Anginx/ 302 Found 302 Found nginx/1.18.0 ç»“è®ºï¼šæ­£åˆ™åŒ¹é… ~ åŒºåˆ†å¤§å°å†™ï¼Œ~* ä¸åŒºåˆ†å¤§å°å†™, å¹¶ä¸”ä¸å‰ç¼€åŒ¹é…æ¯”è¾ƒç±»ä¼¼ï¼Œåªéœ€è¦åŒ¹é…æ¨¡å¼å¼€å¤´éƒ¨åˆ†ï¼Œè¿™ä¸¤ç§åŒæ—¶å­˜åœ¨æ—¶ï¼Œä¼˜å…ˆåŒ¹é…åŒºåˆ†å¤§å°å†™çš„ã€‚ æ­£å¸¸åŒ¹é… æ­£å¸¸åŒ¹é…å°±æ˜¯åŒ¹é…æ¨¡å¼ä¸ºç©ºçš„åŒ¹é…è§„åˆ™ ç¼–è¾‘ nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; # ç¬¬1æ®µ location /nginx/ { rewrite ^ https://www.baidu.com break; } # ç¬¬2æ®µ location /[0-9]nginx/ { rewrite ^ https://www.qq.com break; } } è®¿é—®æµ‹è¯• è®¿é—®127.0.0.1/nginx/ï¼Œåœ¨ç»ˆç«¯ä¸­ä¼šè¿”å›302ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¼šè·³è½¬åˆ°www.baidu.com $ curl 127.0.0.1/nginx/ 302 Found 302 Found nginx/1.18.0 ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ç¬¬2æ®µè®¿é—®ä¸ç”Ÿæ•ˆï¼Œ404 âš ï¸location ^~ /nginx/ä¸location /nginx/ä¸èƒ½åŒæ—¶å‡ºç° ç»“è®ºï¼šæ­£å¸¸åŒ¹é…ä¸å‰ç¼€åŒ¹é…çš„å·®åˆ«ï¼Œåªåœ¨äºä¼˜å…ˆçº§ã€‚ å…¨åŒ¹é…(é€šç”¨åŒ¹é…) ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; location / { root /data/nginx/html; index index.html index.htm; } } å…¨åŒ¹é…æ²¡æœ‰åŒ¹é…æ¨¡å¼ï¼Œå¹¶ä¸”åŒ¹é…çš„uriä»…æ˜¯ä¸€ä¸ªæ–œæ /ï¼Œé€šå¸¸ç”¨åœ¨ä¸€ä¸ªé»˜è®¤é¡µé¢çš„åœ°æ–¹ å‘½ååŒ¹é… å‘½ååŒ¹é…ä¸€èˆ¬ç”¨äºé™æ€é¡µé¢æˆ–è€…é”™è¯¯é¡µé¢(404ï¼Œ500ç­‰)ï¼Œå¹¶ä¸”è¿™ä¸ªå‘½ååŒ¹é…ä¸­ï¼Œä¸å…è®¸æœ‰aliasã€‚ error_page 404 = @notfound; location @notfound { rewrite ^ https://www.baidu.com break; } ä¼˜å…ˆçº§éªŒè¯ç»¼åˆå®éªŒ ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ âš ï¸å‰ç¼€åŒ¹é…å’Œæ­£å¸¸åŒ¹é…ä¸èƒ½åŒæ—¶å­˜åœ¨ server { listen 80; server_name _; # å…¨åŒ¹é…ï¼Œè¿™é‡Œ/data/nginx/html/ä¸‹é¢æœ‰ä¸€ä¸ªnginxæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æœ‰index.htmlï¼Œå†…å®¹æ˜¯nginx location test location / { root /data/nginx/html; index index.html; } # æ­£å¸¸åŒ¹é… location /nginx/ { rewrite ^/nginx/$ https://www.sina.com.cn/ break; } # æ­£åˆ™åŒ¹é… location ~ /[a-z]ginx/ { rewrite ^/nginx/$ https://www.163.com/ break; } # å‰ç¼€åŒ¹é… location ^~ /nginx/ { rewrite ^/nginx/$ https://www.baidu.com/ break; } # ç²¾ç¡®åŒ¹é… location = /nginx/ { rewrite ^/nginx/$ https://www.qq.com/ break; } } åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir -p /data/nginx/html/nginx echo 'nginx location test' > /data/nginx/html/nginx/index.html ç¬¬ä¸€æ­¥ã€æŠŠæ­£å¸¸åŒ¹é…æ³¨é‡Šæ‰ï¼Œç•™ä¸‹å‰ç¼€åŒ¹é…ï¼Œç„¶åæµè§ˆå™¨è®¿é—®IP/nginx/ï¼Œç¬¬ä¸€æ¬¡è¿”å›çš„ç»“æœæ˜¯è·³è½¬åˆ°äº†www.qq.comï¼Œè¯æ˜äº†=ç²¾ç¡®åŒ¹é…ä¼˜å…ˆçº§æ˜¯æœ€å¤§çš„ ç¬¬äºŒæ­¥ã€æŠŠç²¾ç¡®åŒ¹é…æ³¨é‡Šæ‰ï¼Œç„¶åæµè§ˆå™¨è®¿é—®IP/nginx/ï¼Œç»“æœæ˜¯è·³è½¬åˆ°äº†www.baidu.comï¼Œè¯æ˜äº†^~å‰ç¼€åŒ¹é…ä¼˜å…ˆçº§æ˜¯ä»…æ¬¡äºç²¾ç¡®åŒ¹é… ç¬¬ä¸‰æ­¥ã€å› ä¸ºå‰ç¼€åŒ¹é…å’Œæ­£å¸¸åŒ¹é…ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ¯”è¾ƒç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥ï¼Œè¿˜æ˜¯æŠŠç²¾ç¡®åŒ¹é…æ³¨é‡Šæ‰ï¼Œè¿™æ¬¡æŠŠå‰ç¼€åŒ¹é…æ³¨é‡Šæ‰ï¼ŒæŠŠæ­£å¸¸åŒ¹é…æ³¨é‡Šæ‰“å¼€ï¼Œç»“æœæ˜¯è·³è½¬åˆ°äº†www.163.comï¼Œè¯´æ˜æ­£åˆ™åŒ¹é…çš„ä¼˜å…ˆçº§æ˜¯å¤§äºæ­£å¸¸åŒ¹é…çš„ï¼ŒåŒæ—¶ä¹ŸéªŒè¯äº†å‰ç¼€åŒ¹é…ä¼˜å…ˆçº§ç¬¬2ï¼Œæ­£åˆ™åŒ¹é…ä¼˜å…ˆçº§ç¬¬3ï¼Œæ­£å¸¸åŒ¹é…ä¼˜å…ˆçº§ç¬¬4 ç¬¬å››æ­¥ã€ç°åœ¨åªå‰©ä¸‹å…¨åŒ¹é…äº†ï¼Œæ‰€ä»¥å…¨åŒ¹é…çš„ä¼˜å…ˆçº§æœ€ä½ ç»“è®ºï¼šå„åŒ¹é…ä¼˜å…ˆçº§å¦‚ä¸‹ ç²¾ç¡®åŒ¹é… > å‰ç¼€åŒ¹é… > æ­£åˆ™åŒ¹é… > æ­£å¸¸åŒ¹é… > å…¨åŒ¹é… åŒ¹é…åŸåˆ™é™¤äº†è¿™ä¸ªä¼˜å…ˆçº§å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯åœ¨ç›¸åŒæŒ‡ä»¤æ¨¡å¼åŒ¹é…ä¸­ï¼ŒåŒ¹é…åº¦æœ€å¤§çš„URIä¼˜å…ˆ rootä¸alias nginxé…ç½® locationè§„åˆ™ä¸­çš„ uri å¾€å¾€éƒ½æ˜¯åŒ¹é…ä¸€ä¸ªç›®å½•ã€‚ root ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; location /nginx/ { root /data/nginx/html/; index index.html index.htm; } } ä½¿ç”¨rootå…³é”®å­—æŒ‡å®šç½‘ç«™æ ¹ç›®å½• å½“è®¿é—®127.0.0.1/nginx/index.htmlæ—¶ï¼Œå¦‚æœ/data/nginx/html/è¿™ä¸ªç›®å½•ä¸‹æ²¡æœ‰nginx/index.htmlæˆ–è€…æ²¡æœ‰nginxç›®å½•ï¼Œåˆ™ä¼šæŠ¥é”™404 åŸå› æ˜¯ä½¿ç”¨rootæŒ‡å®šç›®å½•æ—¶ï¼Œç›®å½•ä¸‹è¾¹è¦åŒ…æ‹¬locationåé¢çš„uriï¼Œå¦åˆ™å°±ä¼šæŠ¥é”™ ä½¿ç”¨rootæŒ‡å®šç›®å½•æ—¶ï¼Œä¸ä¼šå°†location urié…ç½®çš„è·¯å¾„å»æ‰ï¼Œå³è®¿é—®çš„è·¯å¾„æ˜¯/data/nginx/html/nginx è®¿é—®æµ‹è¯• #ä¸åˆ›å»ºç›®å½•nginx mkdir -p /data/nginx/html/ echo 'abc' >/data/nginx.html/index.html #è®¿é—®æŠ¥é”™404 $ curl 127.0.0.1/nginx/ 404 Not Found 404 Not Found nginx/1.18.0 alias ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; location /nginx/ { alias /data/nginx/html/; index index.html index.htm; } } ä½¿ç”¨aliaså…³é”®å­—æŒ‡å®šç½‘ç«™æ ¹ç›®å½• å½“è®¿é—®127.0.0.1/nginx/index.htmlæ—¶ï¼Œåªè¦ä¿è¯aliasæŒ‡å®šçš„ç›®å½•ä¸­æœ‰index.htmlå³å¯ï¼Œå³ä½¿æ²¡æœ‰ç›®å½•nginxï¼Œå®ƒä¼šå°†location urié…ç½®çš„è·¯å¾„å»æ‰ï¼Œå®é™…è®¿é—®çš„å°±æ˜¯/data/nginx/html/index.html è®¿é—®æµ‹è¯• #ä¸åˆ›å»ºç›®å½•nginx mkdir -p /data/nginx/html/ echo 'abc' >/data/nginx.html/index.html $ curl 127.0.0.1/nginx/ abc ç»“è®ºï¼šroot æŒ‡å®šçš„ç›®å½•ä¸­ï¼Œéœ€è¦locationä¸­çš„ uri è·¯å¾„ç›®å½•ç¡®å®å­˜åœ¨ï¼Œalias æŒ‡å®šçš„ç›®å½•ä¸­ä¸éœ€è¦ locationä¸­çš„uri è·¯å¾„ç›®å½•å­˜åœ¨ã€‚ ä»£ç†æœåŠ¡å™¨ proxy_pass ä¸­æœ‰æ—  / å®éªŒç¯å¢ƒ è§’è‰² ä¸»æœºå IP çœŸå®web web01 10.0.0.10 nginxä»£ç† nginx-proxy 10.0.0.51 åç«¯çœŸå®webæœåŠ¡é…ç½® åç«¯çœŸå®webæœåŠ¡nginx 10.0.0.10é…ç½® server { listen 80; server_name _; location /nginx/ { root /data/nginx/html/; index index.html index.htm; } location /ng/ { root /data/nginx/html/; index index.html index.htm; } location /k8s/ { root /data/nginx/html/; index index.html index.htm; } } åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir -p /data/nginx/html/{nginx,ng,k8s} echo 'nginx' >/data/nginx/html/nginx/index.html echo 'ng' >/data/nginx/html/ng/index.html echo 'k8s' >/data/nginx/html/k8s/index.html è®¿é—®æµ‹è¯• $ curl 127.0.0.1/nginx/ nginx $ curl 127.0.0.1/ng/ ng $ curl 127.0.0.1/k8s/ k8s proxy_passæ— ç›®å½•æ— / ä»£ç†æœåŠ¡å™¨nginx 10.0.0.51é…ç½®ä¸­ proxy_pass æ— '/'éªŒè¯ server { listen 80; server_name _; location /nginx { #æ²¡æœ‰/æŒ‡çš„æ˜¯proxy_passåè¾¹çš„urlæ²¡æœ‰/åç¼€ proxy_pass http://10.0.0.10; } } è®¿é—®æµ‹è¯• $ curl 10.0.0.51/nginx/ nginx $ curl -L 10.0.0.51/nginx nginx çœŸå®webæœåŠ¡10.0.0.10nginxè®¿é—®æ—¥å¿—å¦‚ä¸‹ 10.0.0.51 - - [18/Jun/2020:17:46:53 +0800] \"GET /nginx/ HTTP/1.0\" 200 6 \"-\" \"curl/7.29.0\" \"-\" ç»“è®ºï¼šå¦‚æœproxy_pass åå‘ä»£ç†ä¸­ï¼Œåœ¨serveråé¢æ²¡æœ‰ \"/\" åæ–œæ çš„è¯ï¼Œè®¿é—®çš„æ˜¯ http://10.0.0.10/nginx/index.htmlï¼Œå®ƒä¼šå»ä¸Šæ¸¸çœŸå®æœåŠ¡å™¨å»åŒ¹é…ä»£ç†æœåŠ¡å™¨ä¸Šé¢location URIã€‚ proxy_passæ— ç›®å½•æœ‰/ ä»£ç†æœåŠ¡å™¨nginx 10.0.0.51é…ç½®ä¸­ proxy_pass '/'éªŒè¯ server { listen 80; server_name _; location /nginx { #æœ‰/æŒ‡çš„æ˜¯proxy_passåè¾¹çš„urlæœ‰/åç¼€ proxy_pass http://10.0.0.10/; } } è®¿é—®æµ‹è¯• å› ä¸ºè®¿é—®çš„æ˜¯çœŸå®æœåŠ¡å™¨çš„/ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨çœŸå®æœåŠ¡å™¨æ ¹ä¸­å†™å…¥è®¿é—®é¡µé¢ $ curl 10.0.0.51/nginx/ 404 Not Found 404 Not Found nginx/1.18.0 çœŸå®webæœåŠ¡10.0.0.10nginxè®¿é—®æ—¥å¿—å¦‚ä¸‹ 10.0.0.51 - - [18/Jun/2020:17:51:32 +0800] \"GET / HTTP/1.0\" 404 153 \"-\" \"curl/7.29.0\" \"-\" ç»“è®ºï¼šå¦‚æœproxy_pass åå‘ä»£ç†ä¸­ï¼Œåœ¨serveråé¢æœ‰ \"/\" åæ–œæ çš„è¯ï¼Œè®¿é—®çš„æ˜¯ http://10.0.0.10/index.htmlï¼Œå®ƒä¼šå¿½ç•¥æ‰ä»£ç†æœåŠ¡å™¨ä¸Šé¢locationä¸­çš„URIï¼Œç›´æ¥è®¿é—®ä»£ç†æœåŠ¡å™¨ä¸Šé¢çš„\"/\"ã€‚ proxy_passæœ‰ç›®å½•æ— / ä»£ç†æœåŠ¡å™¨10.0.0.51proxy_passåé¢å¢åŠ ç›®å½•ï¼Œä½†ä¸åŠ \"/\" server { listen 80; server_name _; location /nginx/ { proxy_pass http://10.0.0.10/nginx; } } è®¿é—®æµ‹è¯• å› ä¸ºè®¿é—®çš„æ˜¯çœŸå®æœåŠ¡å™¨çš„/ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨çœŸå®æœåŠ¡å™¨æ ¹ä¸­å†™å…¥è®¿é—®é¡µé¢ $ curl 10.0.0.51/nginx/ 404 Not Found 404 Not Found nginx/1.18.0 çœŸå®webæœåŠ¡10.0.0.10nginxè®¿é—®æ—¥å¿—å¦‚ä¸‹ 10.0.0.51 - - [18/Jun/2020:18:04:40 +0800] \"GET /nginx HTTP/1.0\" 404 153 \"-\" \"curl/7.29.0\" \"-\" ç»“è®ºï¼šå¦‚æœproxy_pass åå‘ä»£ç†ä¸­ï¼Œåœ¨serveråé¢æœ‰URIï¼Œ ä½†æ²¡æœ‰ \"/\" åæ–œæ çš„è¯ï¼Œè®¿é—®çš„æ˜¯ http://10.0.0.10/nginxï¼Œå®ƒä¼šå»ä¸Šæ¸¸çœŸå®æœåŠ¡å™¨å»åŒ¹é…ä»£ç†æœåŠ¡å™¨ä¸Šé¢çš„URIã€‚ proxy_passæœ‰ç›®å½•æœ‰/ ä»£ç†æœåŠ¡å™¨10.0.0.51proxy_passåé¢å¢åŠ ç›®å½•å¹¶ä¸”åŠ \"/\" server { listen 80; server_name _; location /nginx/ { proxy_pass http://10.0.0.10/nginx/; } } è®¿é—®æµ‹è¯• $ curl 10.0.0.51/nginx/ nginx çœŸå®webæœåŠ¡10.0.0.10nginxè®¿é—®æ—¥å¿—å¦‚ä¸‹ 10.0.0.51 - - [18/Jun/2020:17:58:47 +0800] \"GET /nginx/ HTTP/1.0\" 200 6 \"-\" \"curl/7.29.0\" \"-\" ç»“è®ºï¼šå¦‚æœproxy_passåå‘ä»£ç†ä¸­æœ‰ç›®å½•ï¼Œå¹¶ä¸”æœ‰\"/\"åæ–œæ çš„è¯ï¼Œè®¿é—®çš„æ˜¯http://10.0.0.10/nginx/index.htmlï¼Œå®ƒä¼šå¿½ç•¥æ‰ä»£ç†æœåŠ¡å™¨ä¸Šé¢locationä¸­çš„URIï¼Œç›´æ¥è®¿é—®ä»£ç†æœåŠ¡å™¨ä¸Šé¢çš„ç›®å½•+\"/\"çš„å½¢å¼ã€‚ æµ‹è¯•ç»“æœæœ€ç»ˆå¯¹æ¯” æƒ…å†µ proxy_passé…ç½® è®¿é—®ç»“æœ æ—¥å¿—ä¸­çš„è®¿é—®è·¯å¾„ proxy_passä¸­æ— ç›®å½•æ— / location /nginx { proxy_pass http://10.0.0.10; } è®¿é—®çš„æ˜¯ http://10.0.0.10/nginx/index.htmlï¼Œå®ƒä¼šå»ä¸Šæ¸¸çœŸå®æœåŠ¡å™¨å»åŒ¹é…ä»£ç†æœåŠ¡å™¨ä¸Šé¢location URIã€‚ /nginx/ proxy_passä¸­æ— ç›®å½•æœ‰/ location /nginx { proxy_pass http://10.0.0.10/; } è®¿é—®çš„æ˜¯ http://10.0.0.10/index.htmlï¼Œå®ƒä¼šå¿½ç•¥æ‰ä»£ç†æœåŠ¡å™¨ä¸Šé¢locationä¸­çš„URIï¼Œç›´æ¥è®¿é—®ä»£ç†æœåŠ¡å™¨ä¸Šé¢çš„\"/\"ã€‚ / proxy_passä¸­æœ‰ç›®å½•æ— / location /nginx/ { proxy_pass http://10.0.0.10/nginx; } è®¿é—®çš„æ˜¯ http://10.0.0.10/nginxï¼Œå®ƒä¼šå»ä¸Šæ¸¸çœŸå®æœåŠ¡å™¨å»åŒ¹é…ä»£ç†æœåŠ¡å™¨ä¸Šé¢çš„URIã€‚ /nginx proxy_passä¸­æœ‰ç›®å½•æœ‰/ location /nginx/ { proxy_pass http://10.0.0.10/nginx/; } è®¿é—®çš„æ˜¯ http://10.0.0.10/nginx/index.htmlï¼Œå®ƒä¼šå¿½ç•¥æ‰ä»£ç†æœåŠ¡å™¨ä¸Šé¢locationä¸­çš„URIï¼Œç›´æ¥è®¿é—®ä»£ç†æœåŠ¡å™¨ä¸Šé¢çš„ç›®å½•+\"/\"çš„å½¢å¼ã€‚ /nginx/ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/8.nginxè™šæ‹Ÿä¸»æœº.html":{"url":"linux/linuxæœåŠ¡/nginx/8.nginxè™šæ‹Ÿä¸»æœº.html","title":"nginxè™šæ‹Ÿä¸»æœº","keywords":"","body":"nginxè™šæ‹Ÿä¸»æœº è™šæ‹Ÿæœºä¸»æœºæ¦‚å¿µ è™šæ‹Ÿä¸»æœºå°±æ˜¯åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šé…ç½®å¤šä¸ªç½‘ç«™ è™šæ‹Ÿä¸»æœºåˆ†ç±» åŸºäºIPçš„è™šæ‹Ÿä¸»æœº(æµªè´¹IPï¼Œæ²¡ç”¨) åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº é…ç½®nginxè™šæ‹Ÿä¸»æœº åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº ç¼–è¾‘aaa.com.confæ–‡ä»¶ cat > /etc/nginx/conf.d/aaa.com.conf ç¼–è¾‘bbb.com.confæ–‡ä»¶ cat > /etc/nginx/conf.d/bbb.com.conf æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful $ nginx -s reload åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir /website/{aaa,bbb} echo \"aaa.com\" > /website/aaa/index.html echo \"bbb.com\" > /website/bbb/index.html ç»‘å®šhosts cat >> /etc/hosts æµ‹è¯•è®¿é—® $ curl aaa.com aaa.com $ curl bbb.com bbb.com åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº è™šæ‹Ÿä¸»æœºç›‘å¬ä¸åŒç«¯å£ï¼Œä¸ä¸ç³»ç»Ÿç«¯å£å†²çªå³å¯ ç¼–è¾‘aaa.com.confæ–‡ä»¶ cat > /etc/nginx/conf.d/aaa.com.conf æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful $ nginx -s reload æµ‹è¯•è®¿é—® $ curl aaa.com:8001 aaa.com $ curl aaa.com:8002 bbb.com é…ç½®è™šæ‹Ÿä¸»æœºåˆ«å è™šæ‹Ÿä¸»æœºåˆ«åï¼Œå°±æ˜¯è™šæ‹Ÿä¸»æœºè®¾ç½®é™¤äº†ä¸»åŸŸåä»¥å¤–çš„ä¸€ä¸ªåŸŸåï¼Œå®ç°ç”¨æˆ·è®¿é—®çš„å¤šä¸ªåŸŸåå¯¹åº”åŒä¸€ä¸ªè™šæ‹Ÿä¸»æœºç½‘ç«™çš„åŠŸèƒ½ã€‚ ç¼–è¾‘aaa.com.confæ–‡ä»¶ cat > /etc/nginx/conf.d/aaa.com.conf æµ‹è¯•è®¿é—®ï¼Œaaa.comã€bbb.comã€ccc.comè®¿é—®åˆ°çš„æ˜¯åŒä¸€ä¸ªç½‘ç«™çš„åŒä¸€èµ„æº $ curl aaa.com aaa.com $ curl bbb.com aaa.com $ curl ccc.com aaa.com æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/9.1nginxä¸ƒå±‚è´Ÿè½½å‡è¡¡.html":{"url":"linux/linuxæœåŠ¡/nginx/9.1nginxä¸ƒå±‚è´Ÿè½½å‡è¡¡.html","title":"nginxä¸ƒå±‚è´Ÿè½½å‡è¡¡","keywords":"","body":"nginxä¸ƒå±‚è´Ÿè½½å‡è¡¡æ¦‚è¿° nginxä¸ƒå±‚è´Ÿè½½å‡è¡¡å®˜æ–¹æ–‡æ¡£ç®€ä»‹ç‰ˆ nginxä¸ƒå±‚è´Ÿè½½å‡è¡¡å®˜æ–¹æ–‡æ¡£è¯¦ç»†ç‰ˆ ä¸€ã€nginxè´Ÿè½½å‡è¡¡æ¦‚å¿µ åç«¯webæœåŠ¡å¾€å¾€è¦æ‰¿è½½å¤§é‡å¹¶å‘è¯·æ±‚ï¼Œå•å°æœåŠ¡å™¨éš¾ä»¥è´Ÿè·ï¼Œåç«¯ä½¿ç”¨å¤šå°webæœåŠ¡å™¨ç»„æˆé›†ç¾¤ï¼Œå‰ç«¯ä½¿ç”¨nginxä½œä¸ºè´Ÿè½½å‡è¡¡ï¼Œå°†è¯·æ±‚åˆ†æ•£çš„æ‰“åˆ°åç«¯æœåŠ¡å™¨é›†ç¾¤ä¸­ï¼Œå®ç°è´Ÿè½½çš„åˆ†å‘ã€‚è¿™æ ·ä¼šå¤§å¤§æå‡ç³»ç»Ÿçš„ååç‡ã€è¯·æ±‚æ€§èƒ½ã€é«˜å®¹ç¾ç­‰ç­‰ã€‚ ç¤ºæ„å›¾ äºŒã€nginxè´Ÿè½½å‡è¡¡upstream 2.1 è¯­æ³• Syntax: upstream name { ... } Default: - Context: http 2.2 è´Ÿè½½å‡è¡¡æ–¹æ³• æ€»æ½ å¼€æºnginxè°ƒåº¦ç®—æ³• è°ƒåº¦ç®—æ³• æ¦‚è¿° Round Robin è½®è¯¢(rr)ï¼ŒæŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨(é»˜è®¤) Weight Round Robin åŠ æƒè½®è¯¢(wrr)ï¼Œweightå€¼è¶Šå¤§ï¼Œåˆ†é…åˆ°çš„è®¿é—®å‡ ç‡è¶Šé«˜ IP Hash æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®IPçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¥è‡ªåŒä¸€IPçš„è¯·æ±‚å›ºå®šè®¿é—®åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ Generic Hash(url_hash) æŒ‰ç…§è®¿é—®URLçš„hashç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œæ¯ä¸ªURLå®šå‘åˆ°åŒä¸€ä¸ªåç«¯ Least Connections æœ€å°‘é“¾æ¥æ•°ï¼Œå“ªä¸ªæœºå™¨é“¾æ¥æ•°å°‘å°±åˆ†å‘ 2.2.1 Round Robin è½®è¯¢ è¯·æ±‚åœ¨æœåŠ¡å™¨ä¹‹é—´å¹³å‡åˆ†é…ï¼ŒåŒæ—¶è€ƒè™‘äº†æœåŠ¡å™¨æƒé‡ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æ­¤æ–¹æ³•ï¼ˆæ²¡æœ‰å¯ç”¨å®ƒçš„æŒ‡ä»¤ï¼‰ upstream backend { # æ²¡æœ‰é…ç½®å°±æ˜¯Round Robin è½®è¯¢ server backend1.example.com; server backend2.example.com; } 2.2.2 Weight Round Robin åŠ æƒè½®è¯¢ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œbackend1.example.comå…·æœ‰weight 5ï¼›å…¶ä»–ä¸¤å°æœåŠ¡å™¨çš„é»˜è®¤æƒé‡ï¼ˆ1ï¼‰ï¼Œä½†æ˜¯å…·æœ‰IPåœ°å€çš„192.0.0.1ä¸€å°backupæœåŠ¡å™¨è¢«æ ‡è®°ä¸ºæœåŠ¡å™¨ï¼Œé™¤éå…¶ä»–ä¸¤å°æœåŠ¡å™¨å‡ä¸å¯ç”¨ï¼Œå¦åˆ™ä¸ä¼šæ¥æ”¶è¯·æ±‚ã€‚éšç€æƒé‡çš„è¿™ç§é…ç½®ï¼Œæ¯çš„6è¯·æ±‚ï¼Œ5å‘é€åˆ°backend1.example.comå’Œ1å¯¹backend2.example.com upstream backend { server backend1.example.com weight=5; server backend2.example.com; server 192.0.0.1 backup; } 2.2.3 Least Connections æœ€å°‘è¿æ¥ å°†æ´»åŠ¨è¿æ¥æœ€å°‘çš„è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ï¼Œå†æ¬¡è€ƒè™‘æœåŠ¡å™¨æƒé‡ upstream backend { least_conn; server backend1.example.com; server backend2.example.com; } 2.2.4 IP Hash ä»å®¢æˆ·ç«¯IPåœ°å€ç¡®å®šå‘å…¶å‘é€è¯·æ±‚çš„æœåŠ¡å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨IPv4åœ°å€çš„å‰ä¸‰ä¸ªå…«ä½ä½ç»„æˆ–æ•´ä¸ªIPv6åœ°å€æ¥è®¡ç®—å“ˆå¸Œå€¼ã€‚è¯¥æ–¹æ³•ä¿è¯äº†æ¥è‡ªåŒä¸€åœ°å€çš„è¯·æ±‚å°†åˆ°è¾¾åŒä¸€æœåŠ¡å™¨ï¼Œé™¤éè¯¥è¯·æ±‚ä¸å¯ç”¨ upstream backend { ip_hash; server backend1.example.com; server backend2.example.com; } å¦‚æœå…¶ä¸­ä¸€å°æœåŠ¡å™¨éœ€è¦æš‚æ—¶ä»è´Ÿè½½å¹³è¡¡å¾ªç¯ä¸­åˆ é™¤ï¼Œåˆ™å¯ä»¥ä½¿ç”¨downå‚æ•°å¯¹å…¶è¿›è¡Œæ ‡è®°ï¼Œä»¥ä¿ç•™å®¢æˆ·ç«¯IPåœ°å€çš„å½“å‰å“ˆå¸Œå€¼ã€‚è¯¥æœåŠ¡å™¨è¦å¤„ç†çš„è¯·æ±‚å°†è‡ªåŠ¨å‘é€åˆ°ç»„ä¸­çš„ä¸‹ä¸€ä¸ªæœåŠ¡å™¨ upstream backend { server backend1.example.com; server backend2.example.com; server backend3.example.com down; } 2.2.5 Generic Hash (url_hash) å‘é€è¯·æ±‚åˆ°çš„æœåŠ¡å™¨ç”±ç”¨æˆ·å®šä¹‰çš„é”®å†³å®šï¼Œè¯¥é”®å¯ä»¥æ˜¯æ–‡æœ¬å­—ç¬¦ä¸²ã€å˜é‡æˆ–ç»„åˆã€‚ä¾‹å¦‚ï¼Œé”®å¯ä»¥æ˜¯æˆå¯¹çš„æºIPåœ°å€å’Œç«¯å£ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªURIï¼Œå¦‚æœ¬ä¾‹æ‰€ç¤º upstream backend { hash $request_uri consistent; server backend1.example.com; server backend2.example.com; } å“ˆå¸ŒæŒ‡ä»¤çš„å¯é€‰consistentå‚æ•°æ”¯æŒketamaä¸€è‡´å“ˆå¸Œè´Ÿè½½å¹³è¡¡ã€‚è¯·æ±‚æ ¹æ®ç”¨æˆ·å®šä¹‰çš„æ•£åˆ—é”®å€¼å‡åŒ€åœ°åˆ†å¸ƒåœ¨æ‰€æœ‰ä¸Šæ¸¸æœåŠ¡å™¨ä¸Šã€‚å¦‚æœä¸Šæ¸¸æœåŠ¡å™¨è¢«æ·»åŠ åˆ°æˆ–ä»ä¸Šæ¸¸ç»„ç§»é™¤ï¼Œåªæœ‰å‡ ä¸ªé”®è¢«é‡æ–°æ˜ å°„ï¼Œåœ¨è´Ÿè½½å¹³è¡¡çš„ç¼“å­˜æœåŠ¡å™¨æˆ–å…¶ä»–ç§¯ç´¯çŠ¶æ€çš„åº”ç”¨ç¨‹åºçš„æƒ…å†µä¸‹æœ€å°åŒ–ç¼“å­˜ä¸¢å¤±ã€‚ åº”ç”¨åœºæ™¯ æœ‰ä¸€ä¸ªæœåŠ¡å™¨é›†ç¾¤Aï¼Œéœ€è¦å¯¹å¤–æä¾›æ–‡ä»¶ä¸‹è½½ï¼Œç”±äºæ–‡ä»¶ä¸Šä¼ é‡å·¨å¤§ï¼Œæ²¡æ³•å­˜å‚¨åˆ°æœåŠ¡å™¨ç£ç›˜ä¸­ï¼Œæ‰€ä»¥ç”¨åˆ°äº†ç¬¬ä¸‰æ–¹äº‘å­˜å‚¨æ¥åšæ–‡ä»¶å­˜å‚¨ã€‚æœåŠ¡å™¨é›†ç¾¤Aæ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚ä¹‹åï¼Œéœ€è¦ä»äº‘å­˜å‚¨ä¸­ä¸‹è½½æ–‡ä»¶ç„¶åè¿”å›ï¼Œä¸ºäº†çœå»ä¸å¿…è¦çš„ç½‘ç»œå¸¦å®½å’Œä¸‹è½½è€—æ—¶ï¼Œåœ¨æœåŠ¡å™¨é›†ç¾¤Aä¸Šåšäº†ä¸€å±‚ä¸´æ—¶ç¼“å­˜ï¼ˆç¼“å­˜ä¸€ä¸ªæœˆï¼‰ã€‚ç”±äºæ˜¯æœåŠ¡å™¨é›†ç¾¤ï¼Œæ‰€ä»¥åŒä¸€ä¸ªèµ„æºå¤šæ¬¡è¯·æ±‚ï¼Œå¯èƒ½ä¼šåˆ°è¾¾ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå¯¼è‡´ä¸å¿…è¦çš„å¤šæ¬¡ä¸‹è½½ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¸é«˜ï¼Œä»¥åŠä¸€äº›èµ„æºæ—¶é—´çš„æµªè´¹ã€‚åœ¨æ­¤ç±»åœºæ™¯ä¸‹ï¼Œä¸ºäº†ä½¿å¾—ç¼“å­˜å‘½ä¸­ç‡æé«˜ï¼Œå¾ˆé€‚åˆä½¿ç”¨url_hashç­–ç•¥ï¼ŒåŒä¸€ä¸ªurlï¼ˆä¹Ÿå°±æ˜¯åŒä¸€ä¸ªèµ„æºè¯·æ±‚ï¼‰ä¼šåˆ°è¾¾åŒä¸€å°æœºå™¨ï¼Œä¸€æ—¦ç¼“å­˜ä½äº†èµ„æºï¼Œå†æ­¤æ”¶åˆ°è¯·æ±‚ï¼Œå°±å¯ä»¥ä»ç¼“å­˜ä¸­è¯»å–ï¼Œæ—¢å‡å°‘äº†å¸¦å®½ï¼Œä¹Ÿå‡å°‘çš„ä¸‹è½½æ—¶é—´ã€‚ upstream somestream { hash $request_uri; server 192.168.1.1:8080; server 192.168.1.2:8080; server 192.168.1.3:8080; } server { listen 80 default; server_name test.cdn.com; charset utf-8; location /get { proxy_pass http://somestream; } } 2.2.6 random æ¯ä¸ªè¯·æ±‚å°†ä¼ é€’åˆ°éšæœºé€‰æ‹©çš„æœåŠ¡å™¨ï¼Œå¦‚æœtwoæŒ‡å®šäº†å‚æ•°ï¼Œé¦–å…ˆï¼ŒNGINXè€ƒè™‘æœåŠ¡å™¨æƒé‡éšæœºé€‰æ‹©ä¸¤ä¸ªæœåŠ¡å™¨ï¼Œç„¶åä½¿ç”¨æŒ‡å®šçš„æ–¹æ³•é€‰æ‹©è¿™äº›æœåŠ¡å™¨ä¹‹ä¸€ least_conn â€“æ´»åŠ¨è¿æ¥æœ€å°‘ least_time=headerï¼ˆNGINX Plusï¼‰â€“ä»æœåŠ¡å™¨æ¥æ”¶å“åº”æ ‡å¤´çš„æœ€çŸ­å¹³å‡æ—¶é—´ï¼ˆ$upstream_header_timeï¼‰ least_time=last_byteï¼ˆNGINX Plusï¼‰â€“ä»æœåŠ¡å™¨æ¥æ”¶å®Œæ•´å“åº”çš„æœ€çŸ­å¹³å‡æ—¶é—´ï¼ˆ$upstream_response_timeï¼‰ upstream backend { random two least_time=last_byte; server backend1.example.com; server backend2.example.com; server backend3.example.com; server backend4.example.com; } éšæœºè´Ÿè½½å¹³è¡¡æ–¹æ³•åº”è¯¥ç”¨äºåˆ†å¸ƒå¼ç¯å¢ƒï¼Œå…¶ä¸­å¤šä¸ªè´Ÿè½½å¹³è¡¡å™¨å°†è¯·æ±‚ä¼ é€’ç»™åŒä¸€ç»„åç«¯ã€‚å¯¹äºè´Ÿè½½å¹³è¡¡å™¨å¯¹æ‰€æœ‰è¯·æ±‚éƒ½æœ‰å®Œæ•´è§†å›¾çš„ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨å…¶ä»–è´Ÿè½½å¹³è¡¡æ–¹æ³•ï¼Œæ¯”å¦‚è½®è¯¢ã€æœ€å°‘è¿æ¥å’Œæœ€å°‘æ—¶é—´ã€‚ nginx pluså¢åŠ çš„è°ƒåº¦ç®—æ³• è°ƒåº¦ç®—æ³• æ¦‚è¿° Least Time é€‰æ‹©å…·æœ‰æœ€ä½å¹³å‡å»¶è¿Ÿå’Œæœ€ä½æ•°é‡çš„æ´»åŠ¨è¿æ¥ ç¬¬ä¸‰æ–¹è°ƒåº¦ç®—æ³• è°ƒåº¦ç®—æ³• æ¦‚è¿° fair æŒ‰ç…§æœåŠ¡å™¨ç«¯çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é… 2.2.7 fair æŒ‰ç…§æœåŠ¡å™¨ç«¯çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚ upstream dynamic_zuoyu { fair; #å®ç°å“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é… server localhost:8080; #tomcat 7.0 server localhost:8081; #tomcat 8.0 server localhost:8082; #tomcat 8.5 server localhost:8083; #tomcat 9.0 } 2.3 åç«¯webæœåŠ¡å™¨åœ¨å‰ç«¯nginxè´Ÿè½½å‡è¡¡è°ƒåº¦ä¸­çš„çŠ¶æ€ âš ï¸ip_hashå’Œbakcupä¸èƒ½ä¸€èµ·å†™ï¼Œå¦åˆ™è¯­æ³•æ£€æµ‹ä¼šæœ‰æŠ¥é”™ çŠ¶æ€ æ¦‚è¿° down å½“å‰çš„serveræš‚æ—¶ä¸å‚ä¸è´Ÿè½½å‡è¡¡ backup é¢„ç•™çš„å¤‡ä»½æœåŠ¡å™¨ max_fails å…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•° fail_timeout ç»è¿‡max_failså¤±è´¥å, æœåŠ¡æš‚åœæ—¶é—´ max_conns é™åˆ¶æœ€å¤§çš„æ¥æ”¶è¿æ¥æ•° é…ç½®ç¤ºä¾‹ upstream www { server 10.0.0.50:80 down; server 10.0.0.51:80 backup; server 10.0.0.52:80 max_fails=1 fail_timeout=10s; } location / { proxy_pass http://www; include proxy_params; } 2.4 é…ç½®ç¤ºä¾‹ #upstreamä¾‹å­ upstream backend { server backend1.example.com weight=5; server backend2.example.com:8080; server unix:/tmp/backend3; server backup1.example.com:8080 backup; } server { location / { proxy_pass http://backend; } } ä¸‰ã€é…ç½®å¥åº·æ£€æŸ¥ httpå¥åº·æ£€æŸ¥å®˜æ–¹æ–‡æ¡£ 3.1 è¢«åŠ¨å¥åº·æ£€æŸ¥ å¯¹äºè¢«åŠ¨è¿è¡ŒçŠ¶å†µæ£€æŸ¥ï¼ŒNGINXä¼šç›‘è§†å‘ç”Ÿçš„äº‹åŠ¡ï¼Œå¹¶å°è¯•æ¢å¤å¤±è´¥çš„è¿æ¥ã€‚å¦‚æœä»ç„¶æ— æ³•æ¢å¤äº¤æ˜“ï¼Œåˆ™NGINXä¼šå°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨ï¼Œå¹¶æš‚æ—¶åœæ­¢å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œç›´åˆ°å†æ¬¡å°†å…¶æ ‡è®°ä¸ºæ´»åŠ¨ã€‚ ä½¿ç”¨å—ä¸­serveræŒ‡ä»¤çš„å‚æ•°ä¸ºæ¯ä¸ªä¸Šæ¸¸æœåŠ¡å™¨å®šä¹‰äº†å°†ä¸Šæ¸¸æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨çš„æ¡ä»¶upstreamï¼š fail_timeout â€“è®¾ç½®å¿…é¡»å¤šæ¬¡å°è¯•å¤±è´¥æ‰èƒ½å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨çš„æ—¶é—´ï¼Œä»¥åŠå°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨çš„æ—¶é—´ï¼ˆé»˜è®¤ä¸º10ç§’ï¼‰ã€‚ max_fails â€“è®¾ç½®åœ¨fail_timeoutæœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨çš„æ—¶é—´æ®µå†…å¿…é¡»å‘ç”Ÿçš„å¤±è´¥å°è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ä¸º1æ¬¡å°è¯•ï¼‰ã€‚ åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå¦‚æœNGINXæ— æ³•åœ¨30ç§’å†…å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æˆ–æ²¡æœ‰æ”¶åˆ°3æ¬¡å“åº”ï¼Œåˆ™å®ƒå°†æœåŠ¡å™¨æ ‡è®°ä¸º30ç§’é’Ÿä¸å¯ç”¨ï¼š upstream backend { server backend1.example.com; server backend2.example.com max_fails=3 fail_timeout=30s; } å››ã€nginxè´Ÿè½½å‡è¡¡é…ç½®ç¤ºä¾‹ å®éªŒç¯å¢ƒ æœåŠ¡å™¨è§’è‰² ip ä¸»æœºå lb 10.0.0.10 lb01 web01 10.0.0.51 web01 web02 10.0.0.52 web02 4.1 è´Ÿè½½å‡è¡¡lbé…ç½® ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ upstream www { server 10.0.0.51; server 10.0.0.52; } server { listen 80; server_name _; location / { proxy_pass http://www; } } 4.2 web01é…ç½® ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; root /code; index index.html; } åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir /code cat > /code/index.html Code1 Code1 EOF 4.3 web02é…ç½® ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; root /code; index index.html; } åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir /code cat > /code/index.html Code1 Code2 EOF 4.4 æµè§ˆå™¨è®¿é—®lb IPåœ°å€ ç¬¬ä¸€æ¬¡è®¿é—® ç¬¬äºŒæ¬¡è®¿é—® å› ä¸ºæ˜¯ä½¿ç”¨é»˜è®¤çš„rrè½®è¯¢ç®—æ³•ï¼Œå› æ­¤è¯·æ±‚ä¼šä¾æ¬¡è½¬å‘åˆ°web01å’Œweb02 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/9.2nginxå››å±‚è´Ÿè½½å‡è¡¡.html":{"url":"linux/linuxæœåŠ¡/nginx/9.2nginxå››å±‚è´Ÿè½½å‡è¡¡.html","title":"nginxå››å±‚è´Ÿè½½å‡è¡¡","keywords":"","body":"nginxå››å±‚è´Ÿè½½å‡è¡¡ nginxå››å±‚è´Ÿè½½å‡è¡¡å®˜æ–¹æ–‡æ¡£ ä¸€ã€nginxå››å±‚è´Ÿè½½å‡è¡¡ç®€ä»‹ nginxå®˜ç½‘å¯¹äº--with-streamæ¨¡å—çš„ç®€ä»‹ nginxä»1.9.0ç‰ˆæœ¬å¼€å§‹ï¼Œæ–°å¢äº†ngx_stream_core_module æ¨¡å—ï¼Œä½¿nginxæ”¯æŒå››å±‚è´Ÿè½½å‡è¡¡ã€‚é»˜è®¤ç¼–è¯‘çš„æ—¶å€™è¯¥æ¨¡å—å¹¶æœªç¼–è¯‘è¿›å»ï¼Œéœ€è¦ç¼–è¯‘çš„æ—¶å€™æ·»åŠ  --with-streamï¼Œä½¿å…¶æ”¯æŒstreamä»£ç†ã€‚ è´Ÿè½½å¹³è¡¡æ˜¯æŒ‡åœ¨å¤šä¸ªåç«¯æœåŠ¡å™¨ä¹‹é—´æœ‰æ•ˆåœ°åˆ†é…ç½‘ç»œæµé‡ã€‚ nginxå¯ä»¥ä»£ç†å’Œè´Ÿè½½å¹³è¡¡ä¼ è¾“æ§åˆ¶åè®®ï¼ˆTCPï¼‰é€šä¿¡ã€‚TCPæ˜¯è®¸å¤šæµè¡Œçš„åº”ç”¨ç¨‹åºå’ŒæœåŠ¡çš„åè®®ï¼Œä¾‹å¦‚LDAPï¼ŒMySQLå’ŒRTMPã€‚ nginxå¯ä»¥ä»£ç†å’Œè´Ÿè½½å‡è¡¡UDPæµé‡ã€‚UDPï¼ˆç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼‰æ˜¯è®¸å¤šæµè¡Œçš„éäº‹åŠ¡æ€§åº”ç”¨ç¨‹åºçš„åè®®ï¼Œä¾‹å¦‚DNSï¼Œsyslogå’ŒRADIUSã€‚ äºŒã€å…ˆå†³æ¡ä»¶ éœ€è¦æ¨¡å—--with-streamçš„æ”¯æŒ é€šè¿‡TCPæˆ–UDPè¿›è¡Œé€šä¿¡çš„åº”ç”¨ç¨‹åºï¼Œæ•°æ®åº“æˆ–æœåŠ¡ ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œæ¯ä¸ªæœåŠ¡å™¨è¿è¡Œåº”ç”¨ç¨‹åºï¼Œæ•°æ®åº“æˆ–æœåŠ¡çš„ç›¸åŒå®ä¾‹ ä¸‰ã€å®˜æ–¹é…ç½®ç¤ºä¾‹ 3.1 é…ç½®åå‘ä»£ç† é¦–å…ˆï¼Œéœ€è¦é…ç½®åå‘ä»£ç†ï¼Œä»¥ä¾¿NGINXå¯ä»¥å°†TCPè¿æ¥æˆ–UDPæ•°æ®æŠ¥ä»å®¢æˆ·ç«¯è½¬å‘åˆ°ä¸Šæ¸¸ç»„æˆ–ä»£ç†æœåŠ¡å™¨ã€‚ 3.1.1 åˆ›å»ºä¸€ä¸ªé¡¶çº§stream{}å—ï¼š stream { # ... } server {}åœ¨é¡¶çº§stream {}ä¸Šä¸‹æ–‡ä¸­ä¸ºæ¯ä¸ªè™šæ‹ŸæœåŠ¡å™¨å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªé…ç½®å—ã€‚ 3.1.2 åœ¨server {}æ¯ä¸ªæœåŠ¡å™¨çš„é…ç½®å—ä¸­ï¼ŒåŒ…æ‹¬listenç”¨äºå®šä¹‰æœåŠ¡å™¨ä¾¦å¬çš„IPåœ°å€æˆ–ç«¯å£çš„æŒ‡ä»¤ã€‚ å¯¹äºUDPé€šä¿¡ï¼Œè¿˜åŒ…æ‹¬udpå‚æ•°ã€‚ç”±äºTCPæ˜¯streamä¸Šä¸‹æ–‡çš„é»˜è®¤åè®®ï¼Œå› æ­¤tcpè¯¥listenæŒ‡ä»¤æ²¡æœ‰å‚æ•°ï¼š stream { server { listen 12345; # ... } server { listen 53 udp; # ... } # ... } 3.1.3 é…ç½®proxy_passæŒ‡ä»¤ä»¥å®šä¹‰ä»£ç†æœåŠ¡å™¨æˆ–æœåŠ¡å™¨å°†æµé‡è½¬å‘åˆ°çš„ä¸Šæ¸¸ç»„ stream { server { listen 12345; #TCPæµé‡å°†è½¬å‘åˆ°\"stream_backend\"ä¸Šæ¸¸ç»„ proxy_pass stream_backend; } server { listen 12346; #TCPæµé‡å°†è¢«è½¬å‘åˆ°æŒ‡å®šçš„æœåŠ¡å™¨ proxy_pass backend.example.com:12346; } server { listen 53 udp; #UDPæµé‡å°†è½¬å‘åˆ°\"dns_servers\"ä¸Šæ¸¸ç»„ proxy_pass dns_servers; } # ... } 3.1.4 é…ç½®ä»£ç†ç»‘å®š å¦‚æœä»£ç†æœåŠ¡å™¨å…·æœ‰å¤šä¸ªç½‘ç»œæ¥å£ï¼Œåˆ™å¯ä»¥é€‰æ‹©å°†NGINXé…ç½®ä¸ºåœ¨è¿æ¥åˆ°ä¸Šæ¸¸æœåŠ¡å™¨æ—¶ä½¿ç”¨ç‰¹å®šçš„æºIPåœ°å€ã€‚å¦‚æœå°†NGINXä¹‹åçš„ä»£ç†æœåŠ¡å™¨é…ç½®ä¸ºæ¥å—æ¥è‡ªç‰¹å®šIPç½‘ç»œæˆ–IPåœ°å€èŒƒå›´çš„è¿æ¥ï¼Œè¿™å¯èƒ½å¾ˆæœ‰ç”¨ åŒ…æ‹¬proxy_bindæŒ‡ä»¤å’Œç›¸åº”ç½‘ç»œæ¥å£çš„IPåœ°å€ stream { # ... server { listen 127.0.0.1:12345; proxy_pass backend.example.com:12345; proxy_bind 127.0.0.1:12345; } } 3.1.5 é…ç½®ç¼“å†² å¯ä»¥è°ƒæ•´ä¸¤ä¸ªå†…å­˜ç¼“å†²åŒºçš„å¤§å°ï¼ŒNGINXå¯ä»¥åœ¨å…¶ä¸­æ”¾ç½®æ¥è‡ªå®¢æˆ·ç«¯å’Œä¸Šæ¸¸è¿æ¥çš„æ•°æ®ã€‚å¦‚æœæ•°æ®é‡å¾ˆå°ï¼Œåˆ™å¯ä»¥å‡å°‘ç¼“å†²åŒºï¼Œè¿™å¯ä»¥èŠ‚çœå†…å­˜èµ„æºã€‚å¦‚æœæœ‰å¤§é‡æ•°æ®ï¼Œåˆ™å¯ä»¥å¢åŠ ç¼“å†²åŒºå¤§å°ä»¥å‡å°‘å¥—æ¥å­—è¯»/å†™æ“ä½œçš„æ•°é‡ã€‚åœ¨ä¸€ä¸ªè¿æ¥ä¸Šæ¥æ”¶åˆ°æ•°æ®åï¼ŒNGINXå°†è¯»å–è¯¥æ•°æ®å¹¶é€šè¿‡å¦ä¸€è¿æ¥è½¬å‘è¯¥æ•°æ®ã€‚ç¼“å†²åŒºç”±proxy_buffer_sizeä¼ªæŒ‡ä»¤æ§åˆ¶ï¼š stream { # ... server { listen 127.0.0.1:12345; proxy_pass backend.example.com:12345; proxy_buffer_size 16k; } } 3.2 é…ç½®TCPæˆ–UDPè´Ÿè½½å¹³è¡¡ 3.2.1 åˆ›å»ºä¸€ç»„æœåŠ¡å™¨ upstream{}åœ¨é¡¶çº§stream {}ä¸Šä¸‹æ–‡ä¸­å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªé…ç½®å—ï¼Œå¹¶ä¸ºä¸Šæ¸¸ç»„ï¼ˆä¾‹å¦‚ï¼Œstream_backendTCPæœåŠ¡å™¨å’Œdns_serversUDPæœåŠ¡å™¨ï¼‰è®¾ç½®åç§°ï¼š ç¡®ä¿ä¸Šæ¸¸ç»„çš„åç§°ç”±proxy_passæŒ‡ä»¤å¼•ç”¨ï¼Œå°±åƒä¸Šé¢ä¸ºåå‘ä»£ç†é…ç½®çš„æŒ‡ä»¤ä¸€æ ·ã€‚ stream { upstream stream_backend { # ... } upstream dns_servers { # ... } # ... } 3.2.2 åœ¨æœåŠ¡å™¨ç»„ä¸­æ·»åŠ åç«¯çœŸå®æœåŠ¡å™¨(ä¸Šæ¸¸æœåŠ¡å™¨) åœ¨è¯¥upstream {}å—å†…ï¼Œserverä¸ºæ¯ä¸ªä¸Šæ¸¸æœåŠ¡å™¨æ·»åŠ ä¸€ä¸ªæŒ‡ä»¤ï¼ŒæŒ‡å®šå…¶IPåœ°å€æˆ–ä¸»æœºåï¼ˆå¯ä»¥è§£æä¸ºå¤šä¸ªIPåœ°å€ï¼‰å’Œä¸€ä¸ªå¿…éœ€çš„ç«¯å£å·ã€‚è¯·æ³¨æ„ï¼Œå¹¶æœªä¸ºæ¯ä¸ªæœåŠ¡å™¨å®šä¹‰åè®®ï¼Œå› ä¸ºè¯¥åè®®æ˜¯ç”±åœ¨å‰é¢åˆ›å»ºlistençš„serverå—ä¸­çš„æŒ‡ä»¤ä¸­åŒ…å«çš„å‚æ•°ä¸ºæ•´ä¸ªä¸Šæ¸¸ç»„å®šä¹‰çš„ã€‚ stream { upstream stream_backend { server backend1.example.com:12345; server backend2.example.com:12345; server backend3.example.com:12346; # ... } upstream dns_servers { server 192.168.136.130:53; server 192.168.136.131:53; # ... } # ... } 3.2.3 é…ç½®ä¸Šæ¸¸æœåŠ¡å™¨ç»„çš„è´Ÿè½½å‡è¡¡ç®—æ³• 3.2.3.1 è½®è¯¢ Round Robin é»˜è®¤æƒ…å†µä¸‹ï¼ŒNGINXä½¿ç”¨Round Robinç®—æ³•æ¥è´Ÿè½½å‡è¡¡æµé‡ï¼Œå°†å…¶é¡ºåºåœ°å®šå‘åˆ°å·²é…ç½®çš„ä¸Šæ¸¸ç»„ä¸­çš„æœåŠ¡å™¨ã€‚å› ä¸ºå®ƒæ˜¯é»˜è®¤æ–¹æ³•ï¼Œæ‰€ä»¥æ²¡æœ‰roundâ€‘robinæŒ‡ä»¤ã€‚åªéœ€åœ¨é¡¶çº§ä¸Šä¸‹æ–‡ä¸­åˆ›å»ºé…ç½®å—å¹¶æ·»åŠ ä¸Šä¸€æ­¥ä¸­æ‰€è¿°çš„æŒ‡ä»¤ã€‚upstream {} stream {} server 3.2.3.2 æœ€å°‘è¿æ¥ NGINXé€‰æ‹©å½“å‰æ´»åŠ¨è¿æ¥æ•°é‡è¾ƒå°‘çš„æœåŠ¡å™¨ã€‚ 3.2.3.3 å“ˆå¸Œ hash NGINXæ ¹æ®ç”¨æˆ·å®šä¹‰çš„å¯†é’¥ï¼ˆä¾‹å¦‚ï¼ŒæºIPåœ°å€ï¼ˆ$remote_addrï¼‰ï¼‰é€‰æ‹©æœåŠ¡å™¨ï¼š upstream stream_backend { hash $remote_addr; server backend1.example.com:12345; server backend2.example.com:12345; server backend3.example.com:12346; } è¯¥Hashè´Ÿè½½å¹³è¡¡æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥é…ç½®ä¼šè¯æŒä¹…æ€§ã€‚ç”±äºå“ˆå¸Œå‡½æ•°åŸºäºå®¢æˆ·ç«¯IPåœ°å€ï¼Œå› æ­¤é™¤éæœåŠ¡å™¨å…³é—­æˆ–ä¸å¯ç”¨ï¼Œå¦åˆ™æ¥è‡ªç»™å®šå®¢æˆ·ç«¯çš„è¿æ¥å°†å§‹ç»ˆä¼ é€’åˆ°åŒä¸€æœåŠ¡å™¨ã€‚æŒ‡å®šä¸€ä¸ªå¯é€‰consistentå‚æ•°ä»¥åº”ç”¨ketamaä¸€è‡´æ€§å“ˆå¸Œæ–¹æ³•ï¼š hash $remote_addr consistent; 3.2.4 ä¸ºæ¯ä¸ªä¸Šæ¸¸æœåŠ¡å™¨æŒ‡å®šæœåŠ¡å™¨ç‰¹å®šçš„å‚æ•°ï¼ŒåŒ…æ‹¬æœ€å¤§è¿æ¥æ•°ï¼ŒæœåŠ¡å™¨æƒé‡ç­‰(å¯é€‰) upstream stream_backend { hash $remote_addr consistent; server backend1.example.com:12345 weight=5; server backend2.example.com:12345; server backend3.example.com:12346 max_conns=3; } upstream dns_servers { least_conn; server 192.168.136.130:53; server 192.168.136.131:53; # ... } å¦ä¸€ç§æ–¹æ³•æ˜¯å°†æµé‡ä»£ç†åˆ°å•ä¸ªæœåŠ¡å™¨è€Œä¸æ˜¯ä¸Šæ¸¸ç»„ã€‚å¦‚æœæ‚¨é€šè¿‡ä¸»æœºåæ ‡è¯†æœåŠ¡å™¨ï¼Œå¹¶é…ç½®ä¸»æœºåä»¥è§£æä¸ºå¤šä¸ªIPåœ°å€ï¼Œåˆ™NGINXä½¿ç”¨è¯¥Round Robinç®—æ³•å¯¹IPåœ°å€ä¹‹é—´çš„æµé‡è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¿…é¡»åœ¨proxy_passæŒ‡ä»¤ä¸­æŒ‡å®šæœåŠ¡å™¨çš„ç«¯å£å·ï¼Œå¹¶ä¸”ä¸å¾—åœ¨IPåœ°å€æˆ–ä¸»æœºåä¹‹å‰æŒ‡å®šåè®® stream { # ... server { listen 12345; proxy_pass backend.example.com:12345; } } 3.3 é…ç½®TCPå¥åº·æ£€æŸ¥ nginx TCPå¥åº·æ£€æŸ¥å®˜æ–¹æ–‡æ¡£ 3.3.1 ç®€ä»‹ nginx TCPå¥åº·æ£€æŸ¥å¯ä»¥æŒç»­æµ‹è¯•TCPä¸Šæ¸¸æœåŠ¡å™¨ï¼Œé¿å…å‡ºç°æ•…éšœçš„æœåŠ¡å™¨ï¼Œå¹¶å¯ä»¥å°†æ¢å¤çš„æœåŠ¡å™¨æ­£å¸¸åœ°æ·»åŠ åˆ°è´Ÿè½½å¹³è¡¡ç»„ä¸­ 3.3.2 å‰ææ¡ä»¶ å·²åœ¨streamä¸Šä¸‹æ–‡ä¸­é…ç½®äº†TCPæœåŠ¡å™¨çš„ä¸Šæ¸¸ç»„** stream { #... upstream stream_backend { server backend1.example.com:12345; server backend2.example.com:12345; server backend3.example.com:12345; } #... } å·²ç»é…ç½®äº†å°†TCPè¿æ¥ä¼ é€’åˆ°æœåŠ¡å™¨ç»„çš„æœåŠ¡å™¨ stream { #... server { listen 12345; proxy_pass stream_backend; } #... } 3.3.3 è¢«åŠ¨TCPè¿è¡ŒçŠ¶å†µæ£€æŸ¥ å¦‚æœè¿æ¥ä¸Šæ¸¸æœåŠ¡å™¨çš„å°è¯•è¶…æ—¶æˆ–å¯¼è‡´é”™è¯¯ï¼ŒNGINXå¯ä»¥å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨ï¼Œå¹¶åœ¨æŒ‡å®šçš„æ—¶é—´å†…åœæ­¢å‘å…¶å‘é€è¯·æ±‚ã€‚è¦å®šä¹‰NGINXè®¤ä¸ºä¸Šæ¸¸æœåŠ¡å™¨ä¸å¯ç”¨çš„æ¡ä»¶ï¼Œè¯·åœ¨serveræŒ‡ä»¤ä¸­åŒ…å«ä»¥ä¸‹å‚æ•° fail_timeout â€“åœ¨æŒ‡å®šçš„è¿æ¥å°è¯•æ¬¡æ•°å†…å¿…é¡»å¤±è´¥çš„æ—¶é—´ï¼Œæ‰èƒ½å°†æœåŠ¡å™¨è§†ä¸ºä¸å¯ç”¨ã€‚åŒæ ·ï¼ŒNGINXå°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨åçš„æ—¶é—´ã€‚ max_fails â€“åœ¨æŒ‡å®šæ—¶é—´å†…NGINXè®¤ä¸ºæœåŠ¡å™¨ä¸å¯ç”¨çš„å¤±è´¥å°è¯•æ¬¡æ•°ã€‚ é»˜è®¤å€¼ä¸º10ç§’æ•°å’Œ1å°è¯•æ¬¡æ•°ã€‚å› æ­¤ï¼Œå¦‚æœè¿æ¥å°è¯•è¶…æ—¶æˆ–åœ¨10ç§’é’Ÿå†…è‡³å°‘å¤±è´¥ä¸€æ¬¡ï¼ŒNGINXä¼šå°†æœåŠ¡å™¨æ ‡è®°ä¸º10ç§’é’Ÿä¸å¯ç”¨ã€‚è¯¥ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•åœ¨30ç§’å†…å°†è¿™äº›å‚æ•°è®¾ç½®ä¸º2ä¸ªå¤±è´¥ upstream stream_backend { server backend1.example.com:12345 weight=5; server backend2.example.com:12345 max_fails=2 fail_timeout=30s; server backend3.example.com:12346 max_conns=3; } 3.3.3.1 æœåŠ¡å™¨ç¼“æ…¢å¯åŠ¨(åªæœ‰nginx pluså¯ä»¥ä½¿ç”¨) æœ€è¿‘æ¢å¤çš„ä¸Šæ¸¸æœåŠ¡å™¨å¾ˆå®¹æ˜“è¢«è¿æ¥æ·¹æ²¡ï¼Œè¿™å¯èƒ½å¯¼è‡´æœåŠ¡å™¨å†æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨ã€‚æ…¢é€Ÿå¯åŠ¨å…è®¸ä¸Šæ¸¸æœåŠ¡å™¨åœ¨æ¢å¤æˆ–å¯ç”¨åå°†å…¶æƒé‡ä»é›¶é€æ¸æ¢å¤åˆ°å…¶æ ‡ç§°å€¼ã€‚è¿™å¯ä»¥é€šè¿‡slow_startä¸Šæ¸¸serveræŒ‡ä»¤çš„å‚æ•°æ¥å®Œæˆ upstream backend { server backend1.example.com:12345 slow_start=30s; server backend2.example.com; server 192.0.0.1 backup; } âš ï¸è¯·æ³¨æ„ï¼Œå¦‚æœç»„ä¸­åªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œåˆ™å°†slow_startå¿½ç•¥è¯¥å‚æ•°ï¼Œå¹¶ä¸”æ°¸è¿œä¸ä¼šå°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨ã€‚æ…¢é€Ÿå¯åŠ¨æ˜¯NGINX Plusç‹¬æœ‰çš„ 3.4 é…ç½®UDPå¥åº·æ£€æŸ¥ nginx UDPå¥åº·æ£€æŸ¥å®˜æ–¹æ–‡æ¡£ 3.4.1 å‰ææ¡ä»¶ å·²é…ç½®ä¸Šä¸‹æ–‡ä¸­çš„ä¸Šæ¸¸æœåŠ¡å™¨ç»„æ¥å¤„ç†UDPç½‘ç»œæµé‡ï¼ˆDNSï¼ŒRADIUSï¼Œç³»ç»Ÿæ—¥å¿—ï¼‰ï¼Œä¾‹å¦‚ï¼šstream {} stream { #... upstream dns_upstream { server 192.168.136.130:53; server 192.168.136.131:53; server 192.168.136.132:53; } #... } å·²ç»é…ç½®äº†å°†UDPæ•°æ®æŠ¥ä¼ é€’åˆ°ä¸Šæ¸¸æœåŠ¡å™¨ç»„çš„æœåŠ¡å™¨ stream { #... server { listen 53 udp; proxy_pass dns_upstream; proxy_timeout 1s; proxy_responses 1; error_log logs/dns.log; } #... } 3.4.2 è¢«åŠ¨UDPå¥åº·æ£€æŸ¥ å¦‚æœæœåŠ¡å™¨å›å¤é”™è¯¯æˆ–è¶…æ—¶ï¼Œåˆ™NGINXå¯ä»¥å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨ï¼Œå¹¶åœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢å‘å…¶å‘é€UDPæ•°æ®æŠ¥ã€‚ max_failsä½¿ç”¨ä¸Šæ¸¸æœåŠ¡å™¨çš„å‚æ•°è®¾ç½®åœ¨ç‰¹å®šæ—¶é—´æ®µå†…è¿ç»­å¤±è´¥çš„è¿æ¥å°è¯•æ¬¡æ•°ï¼ˆé»˜è®¤å€¼ä¸º1ï¼‰ã€‚ æ—¶é—´æ®µç”±fail_timeoutå‚æ•°è®¾ç½®ï¼ˆé»˜è®¤å€¼ä¸º10ç§’ï¼‰ã€‚è¯¥å‚æ•°è¿˜è®¾ç½®äº†NGINXæ ‡è®°æœåŠ¡å™¨åè®¤ä¸ºæœåŠ¡å™¨ä¸å¯ç”¨çš„æ—¶é—´ã€‚ å› æ­¤ï¼Œå¦‚æœè¿æ¥å°è¯•è¶…æ—¶æˆ–åœ¨10ç§’å†…è‡³å°‘å¤±è´¥ä¸€æ¬¡ï¼ŒNGINXä¼šå°†æœåŠ¡å™¨æ ‡è®°ä¸º10ç§’é’Ÿä¸å¯ç”¨ã€‚è¯¥ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•åœ¨60ç§’å†…å°†è¿™äº›å‚æ•°è®¾ç½®ä¸º2ä¸ªå¤±è´¥ï¼š upstream dns_upstream { server 192.168.136.130:53 fail_timeout=60s; server 192.168.136.131:53 fail_timeout=60s; } å››ã€TCPå’ŒUDPè´Ÿè½½å¹³è¡¡é…ç½®å®˜æ–¹æ€»ç¤ºä¾‹ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ‰€æœ‰ä¸TCPå’ŒUDPä»£ç†ç›¸å…³çš„åŠŸèƒ½éƒ½åœ¨streamå—å†…è¿›è¡Œé…ç½®ï¼Œå°±åƒåœ¨httpå—ä¸­é…ç½®äº†HTTPè¯·æ±‚çš„è®¾ç½®ä¸€æ ·ã€‚ æœ‰ä¸¤ä¸ªå‘½åçš„upstreamå—ï¼Œæ¯ä¸ªå—åŒ…å«ä¸‰ä¸ªæ‰˜ç®¡å½¼æ­¤ç›¸åŒå†…å®¹çš„æœåŠ¡å™¨ã€‚åœ¨serverfor eadchæœåŠ¡å™¨ä¸­ï¼ŒæœåŠ¡å™¨åç§°åè·Ÿå¿…éœ€çš„ç«¯å£å·ã€‚æ ¹æ®â€œ æœ€å°‘è¿æ¥â€è´Ÿè½½å¹³è¡¡æ–¹æ³•ï¼Œè¿æ¥åœ¨æœåŠ¡å™¨ä¹‹é—´åˆ†é…ï¼šè¿æ¥åˆ°æ´»åŠ¨è¿æ¥æœ€å°‘çš„æœåŠ¡å™¨ã€‚ è¿™ä¸‰ä¸ªserverå—å®šä¹‰äº†ä¸‰ä¸ªè™šæ‹ŸæœåŠ¡å™¨ï¼š ç¬¬ä¸€å°æœåŠ¡å™¨ä¾¦å¬ç«¯å£12345ï¼Œå¹¶å°†æ‰€æœ‰TCPè¿æ¥ä»£ç†åˆ°ä¸Šæ¸¸æœåŠ¡å™¨çš„stream_backendç»„ã€‚è¯·æ³¨æ„ï¼Œåœ¨æ¨¡å—proxy_passä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„æŒ‡ä»¤streamä¸å¾—åŒ…å«åè®®ã€‚ æŒ‡å®šäº†ä¸¤ä¸ªå¯é€‰çš„è¶…æ—¶å‚æ•°ï¼šproxy_connect_timeoutä¼ªæŒ‡ä»¤è®¾ç½®ä¸stream_backendç»„ä¸­çš„æœåŠ¡å™¨å»ºç«‹è¿æ¥æ‰€éœ€çš„è¶…æ—¶ã€‚è¯¥proxy_timeoutæŒ‡ä»¤è®¾ç½®åœ¨ä»£ç†åˆ°stream_backendç»„ä¸­çš„ä¸€å°æœåŠ¡å™¨å·²å¯åŠ¨ä¹‹åä½¿ç”¨çš„è¶…æ—¶ã€‚ ç¬¬äºŒå°æœåŠ¡å™¨ä¾¦å¬ç«¯å£53ï¼Œå¹¶å°†æ‰€æœ‰UDPæ•°æ®æŠ¥ï¼ˆæŒ‡ä»¤çš„udpå‚æ•°listenï¼‰ä»£ç†åˆ°ç§°ä¸ºdns_serversçš„ä¸Šæ¸¸ç»„ã€‚å¦‚æœudpæœªæŒ‡å®šè¯¥å‚æ•°ï¼Œåˆ™å¥—æ¥å­—ç›‘å¬TCPè¿æ¥ã€‚ ç¬¬ä¸‰å°è™šæ‹ŸæœåŠ¡å™¨ä¾¦å¬ç«¯å£12346ï¼Œå¹¶ä»£ç†åˆ°backend4.example.comçš„ TCPè¿æ¥ï¼Œåè€…å¯ä»¥è§£æä¸ºä½¿ç”¨Round Robinæ–¹æ³•å®ç°è´Ÿè½½å¹³è¡¡çš„å¤šä¸ªIPåœ°å€ã€‚ stream { upstream stream_backend { least_conn; server backend1.example.com:12345 weight=5; server backend2.example.com:12345 max_fails=2 fail_timeout=30s; server backend3.example.com:12345 max_conns=3; } upstream dns_servers { least_conn; server 192.168.136.130:53; server 192.168.136.131:53; server 192.168.136.132:53; } server { listen 12345; proxy_pass stream_backend; proxy_timeout 3s; proxy_connect_timeout 1s; } server { listen 53 udp; proxy_pass dns_servers; } server { listen 12346; proxy_pass backend4.example.com:12346; } } äº”ã€å®é™…é…ç½®ç¤ºä¾‹ 5.1 å®éªŒè¯´æ˜ å®˜æ–¹å¯¹äºTCPè´Ÿè½½å‡è¡¡çš„è¯´æ˜ï¼Œåº”è¯¥é€‰æ‹©ä½¿ç”¨TCPåè®®çš„æœåŠ¡å»éªŒè¯ nginxå¯ä»¥ä»£ç†å’Œè´Ÿè½½å¹³è¡¡ä¼ è¾“æ§åˆ¶åè®®ï¼ˆTCPï¼‰é€šä¿¡ã€‚TCPæ˜¯è®¸å¤šæµè¡Œçš„åº”ç”¨ç¨‹åºå’ŒæœåŠ¡çš„åè®®ï¼Œä¾‹å¦‚LDAPï¼ŒMySQLå’ŒRTMPã€‚ è¿™é‡Œé€‰æ‹©ä½¿ç”¨TCPåè®®çš„mysqlå’ŒsshæœåŠ¡ä½œä¸ºå®éªŒå¯¹è±¡ï¼Œä¾¿äºéªŒè¯ 1.è®¿é—®è´Ÿè½½å‡è¡¡çš„12345ç«¯å£ï¼Œè¿æ¥è‡³åç«¯webçš„22ç«¯å£ 2.è®¿é—®è´Ÿè½½å‡è¡¡çš„12346ç«¯å£ï¼Œè¿æ¥è‡³åç«¯mysqlçš„3306ç«¯å£ å®éªŒç¯å¢ƒ æœåŠ¡å™¨è§’è‰² å¤–ç½‘ip** ä¸»æœºå lb 10.0.0.10 lb web01 10.0.0.51 web mysql 10.0.0.52 mysql 5.2 è´Ÿè½½å‡è¡¡lbæ“ä½œ âš ï¸stream {} å¿…é¡»ä¸ http {}åœ¨åŒä¸€çº§ï¼Œè€Œnginxä¸»é…ç½®æ–‡ä»¶/etc/nginx/nginx.confä¸­include /etc/nginx/conf.d/*.conf;æ˜¯åœ¨httpä¸­çš„ï¼Œå› æ­¤åœ¨/etc/nginx/conf.d/ä¸‹ç¼–è¾‘å«æœ‰stream {}çš„é…ç½®æ–‡ä»¶æ˜¯ä¼šæŠ¥é”™çš„ ç¼–è¾‘nginxä¸»é…ç½®æ–‡ä»¶/etc/nginx/nginx.conf #åœ¨eventsä¸‹æ–¹ httpä¸Šæ–¹åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼Œä»¥è§£å†³streamå¿…é¡»ä¸httpåŒçº§çš„é—®é¢˜ include /etc/nginx/conf.e/*.conf; åˆ›å»ºç›®å½• mkdir /etc/nginx/conf.e ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.e/tcp.conf æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful $ nginx -s reload 5.3 æµ‹è¯• 5.3.1 sshè¿æ¥æµ‹è¯• è¿æ¥lbçš„12345ç«¯å£ï¼Œå› ä¸ºé»˜è®¤ç®—æ³•æ˜¯rrï¼Œå› æ­¤ä¼šè½®æµè¿æ¥åˆ°webå’Œmysqlæœºå™¨ 5.3.2 mysqlè¿æ¥æµ‹è¯• æµ‹è¯•å‰åœ¨mysqlæœºå™¨ä¸Šè¿›è¡Œä¸€ä¸ªæˆæƒ mysql> grant all on *.* to test@'%' identified by 'test'; Query OK, 0 rows affected, 1 warning (0.00 sec) åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œä¾¿äºç¡®è®¤ mysql> create database tcp_test; Query OK, 1 row affected (0.00 sec) è¿æ¥æˆåŠŸï¼Œé€šè¿‡lbçš„å››å±‚è´Ÿè½½å‡è¡¡è¿›è¡Œçš„ç«¯å£è½¬å‘è¿æ¥åˆ°äº†mysqlæœºå™¨ä¸Šçš„3306ç«¯å£ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/9.3nginxè´Ÿè½½å‡è¡¡ä¹‹åŸºäºä¸åŒå®¢æˆ·ç«¯.html":{"url":"linux/linuxæœåŠ¡/nginx/9.3nginxè´Ÿè½½å‡è¡¡ä¹‹åŸºäºä¸åŒå®¢æˆ·ç«¯.html","title":"nginxè´Ÿè½½å‡è¡¡ä¹‹åŸºäºä¸åŒå®¢æˆ·ç«¯","keywords":"","body":"nginxè´Ÿè½½å‡è¡¡ä¹‹åŸºäºä¸åŒå®¢æˆ·ç«¯ è´Ÿè½½å‡è¡¡è¿˜å¯ä»¥æ ¹æ®ä¸åŒå®¢æˆ·ç«¯è¿›è¡Œç›¸åº”çš„è½¬å‘ ä»¥ä¸‹ç¤ºä¾‹ä¸ºåŸºäºä¸åŒæ‰‹æœºç«¯åŠæµè§ˆå™¨è¿›è¡Œè½¬å‘ å®éªŒç¯å¢ƒ è§’è‰² IPåœ°å€ ä¸»æœºå è´Ÿè½½å‡è¡¡ lb 10.0.0.10 lb çœŸå®åç«¯æœåŠ¡ web01 10.0.0.51 web01 çœŸå®åç«¯æœåŠ¡ web02 10.0.0.52 web02 è®©æ‰‹æœºç«¯çš„è®¿é—®è½¬å‘åˆ°web01ï¼Œè®©æµè§ˆå™¨çš„è®¿é—®å’Œé»˜è®¤è®¿é—®è½¬å‘åˆ°web02 è´Ÿè½½å‡è¡¡æ“ä½œ upstream iphone { server 10.0.0.51; } upstream android { server 10.0.0.51:8080; } upstream chrom { server 10.0.0.52; } upstream firefox { server 10.0.0.52:8080; } upstream defaults { server 10.0.0.52; } server { listen 80; server_name _; location / { #åŒ¹é…iPhoneæ‰‹æœºè®¿é—® if ($http_user_agent ~* \"iphone\") { proxy_pass http://iphone; } #åŒ¹é…Androidæ‰‹æœºè®¿é—® if ($http_user_agent ~* \"android\") { proxy_pass http://android; } #åŒ¹é…è°·æ­Œæµè§ˆå™¨è®¿é—® if ($http_user_agent ~* \"chrom\") { proxy_pass http://chrom; } #åŒ¹é…firefoxæµè§ˆå™¨è®¿é—® if ($http_user_agent ~* \"firefox\") { proxy_pass http://Firefox; } #å…¶ä»–æµè§ˆå™¨è®¿é—®é»˜è®¤è§„åˆ™ proxy_pass http://defaults; } } web01æ“ä½œ ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; root /data/iphone; index index.html; } server { listen 8080; server_name _; root /data/android; index index.html; } åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir -p /data/{iphone,android} echo 'iphone' >/data/iphone/index.html echo 'android' >/data/android/index.html web02æ“ä½œ ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; root /data/chrom; index index.html; } server { listen 8080; server_name _; root /data/firefox; index index.html; } åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir -p /data/{chrom,firefox} echo 'chrom' >/data/chrom/index.html echo 'firefox' >/data/firefox/index.html æµè§ˆå™¨è®¿é—®éªŒè¯ æ¨¡æ‹Ÿiphone nginxè®¿é—®æ—¥å¿— 10.0.0.2 - - [20/Jun/2020:19:22:50 +0800] \"GET / HTTP/1.1\" 200 7 \"-\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1\" \"-\" æ¨¡æ‹Ÿå®‰å“æ‰‹æœº nginxè®¿é—®æ—¥å¿— 10.0.0.2 - - [20/Jun/2020:19:21:29 +0800] \"GET / HTTP/1.1\" 304 0 \"-\" \"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Mobile Safari/537.36\" \"-\" è°·æ­Œæµè§ˆå™¨è®¿é—® nginxè®¿é—®æ—¥å¿— 10.0.0.2 - - [20/Jun/2020:19:26:17 +0800] \"GET / HTTP/1.1\" 304 0 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36\" \"-\" ç«ç‹æµè§ˆå™¨è®¿é—® nginxè®¿é—®æ—¥å¿— 10.0.0.2 - - [20/Jun/2020:19:22:05 +0800] \"GET / HTTP/1.1\" 304 0 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:77.0) Gecko/20100101 Firefox/77.0\" \"-\" æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/10.lnmpå¹³å°.html":{"url":"linux/linuxæœåŠ¡/nginx/10.lnmpå¹³å°.html","title":"lnmpå¹³å°","keywords":"","body":"lnmpå¹³å° ä¸€ã€lnmpç®€ä»‹ LNMPå°±æ˜¯Linux+Nginx+MySQL+PHPï¼ŒLinuxä½œä¸ºæœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿï¼ŒNginxä½œä¸ºWebæœåŠ¡å™¨ã€PHPä½œä¸ºè§£æåŠ¨æ€è„šæœ¬è¯­è¨€ã€MySQLå³ä¸ºæ•°æ®åº“ã€‚ Linuxä½œä¸ºæœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿã€‚ Nginxä½œä¸ºWebServeræœåŠ¡å™¨ã€‚ PHP ä½œä¸ºåŠ¨æ€è§£ææœåŠ¡(php)ã€‚ MySQLä½œä¸ºåç«¯å­˜å‚¨æ•°æ®åº“æœåŠ¡ã€‚ äºŒã€fastcgiåè®® NginxæœåŠ¡æœ¬èº«ä¸èƒ½å¤„ç†PHPçš„è¯·æ±‚ï¼Œç”¨æˆ·å‘èµ·PHPåŠ¨æ€è¯·æ±‚, Nginxå¤„ç†è¿‡ç¨‹å¦‚ä¸‹ ç”¨æˆ·-->httpåè®®-->Nginx-->fastcgiåè®®-->php-fpm fastcgiæ˜¯nginxè¿æ¥php-fpmä¹‹é—´çš„åè®® nginxç»“åˆPHP FastCGIè¿è¡ŒåŸç†å›¾ 1.ç”¨æˆ·å‘èµ·çš„æ‰€æœ‰è¯·æ±‚ä¼šå…ˆæŠµè¾¾LNMPæ¶æ„ä¸­çš„Nginx 2.å¦‚æœç”¨æˆ·è¯·æ±‚çš„æ˜¯é™æ€å†…å®¹ï¼Œåˆ™Nginxç›´æ¥å“åº”å¹¶å¤„ç† 3.å¦‚æœç”¨æˆ·è¯·æ±‚çš„æ˜¯åŠ¨æ€å†…å®¹ï¼Œåˆ™é€šè¿‡fastcgiåè®®å‘é€è‡³php-fpmç®¡ç†è¿›ç¨‹ 4.php-fpmæ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ´¾ç”Ÿå¯¹åº”çš„wrapperçº¿ç¨‹ï¼Œæ¥è§£æç”¨æˆ·è¯·æ±‚çš„åŠ¨æ€å†…å®¹ 5.å¦‚æœæ¶‰åŠåˆ°æŸ¥è¯¢æ•°æ®åº“æ“ä½œï¼Œåˆ™éœ€è¦phpå…ˆè¿æ¥æ•°æ®åº“ï¼Œç„¶åè¿›è¡ŒæŸ¥è¯¢æ“ä½œ(php-mysql) 6.æœ€ç»ˆç”±mysql-->php-fpm->fastcgi->nginx->client ä¸‰ã€æ­å»ºlnmpå¹³å° 3.1 å®‰è£…nginx nginx centos rpmåŒ…å®˜æ–¹ä¸‹è½½åœ°å€ 3.1.1 ä¸‹è½½å®‰è£…åŒ…å¹¶å®‰è£… wget https://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm yum -y localinstall nginx-1.18.0-1.el7.ngx.x86_64.rpm 3.1.2 åˆ›å»ºwwwç”¨æˆ·å¹¶æŠŠnginxè¿è¡Œç”¨æˆ·ä¿®æ”¹ä¸ºwww useradd -u www -M -s /sbin/nologin sed -i.bak '/user nginx;/cuser www;' /etc/nginx/nginx.conf 3.1.3 å¯åŠ¨nginxå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable nginx && systemctl start nginx 3.2 å®‰è£…mysql mysqlå®˜æ–¹ä¸‹è½½åœ°å€ 3.2.1 ä¸‹è½½å®‰è£…åŒ…å¹¶å®‰è£… wget https://cdn.mysql.com//Downloads/MySQL-8.0/mysql-8.0.20-1.el7.x86_64.rpm-bundle.tar yum -y localinstall *.rpm 3.2.2 å¯åŠ¨mysqlå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable mysqld && systemctl start mysqld 3.2.3 ä»/var/log/mysqld.logä¸­æ‰¾åˆ°mysql8çš„é»˜è®¤rooå¯†ç  $ grep 'root@localhost' /var/log/mysqld.log 2020-06-21T00:46:49.942011Z 6 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: jB6wzV 3.2.4 ä¿®æ”¹rootå¯†ç  mysql8ä¸­å¯†ç è¦æ±‚ä¸ºè¦åŒ…å«å¤§å†™å­—æ¯ï¼Œå°å†™å­—æ¯ï¼Œæ•°å­—ï¼Œç‰¹æ®Šç¬¦å· åœ¨MySQL 8.04å‰ï¼Œæ‰§è¡Œï¼šSET PASSWORD=PASSWORD('[æ–°å¯†ç ]');ä¿®æ”¹å¯†ç  ä½†æ˜¯MySQL8.0.4å¼€å§‹ï¼Œè¿™æ ·é»˜è®¤æ˜¯ä¸è¡Œçš„ã€‚å› ä¸ºä¹‹å‰ï¼ŒMySQLçš„å¯†ç è®¤è¯æ’ä»¶æ˜¯mysql_native_passwordï¼Œè€Œç°åœ¨ä½¿ç”¨çš„æ˜¯caching_sha2_passwordã€‚ âš ï¸mysql8.0.20åˆæ¬¡ä¿®æ”¹rootå¯†ç éœ€è¦ç”¨å¦‚ä¸‹å‘½ä»¤ mysql> alter user user() identified by 'Bxb123.com'; Query OK, 0 rows affected (0.00 sec) æŸ¥çœ‹mysql8.0.20å¯†ç ç­–ç•¥ mysql> show variables like 'validate_password%'; +--------------------------------------+--------+ | Variable_name | Value | +--------------------------------------+--------+ | validate_password.check_user_name | ON | | validate_password.dictionary_file | | | validate_password.length | 8 | | validate_password.mixed_case_count | 1 | | validate_password.number_count | 1 | | validate_password.policy | MEDIUM | | validate_password.special_char_count | 1 | +--------------------------------------+--------+ validate_password.length å›ºå®šå¯†ç çš„æ€»é•¿åº¦ï¼› validate_password.dictionary_file æŒ‡å®šå¯†ç éªŒè¯çš„æ–‡ä»¶è·¯å¾„ï¼› validate_password.mixed_case_count æ•´ä¸ªå¯†ç ä¸­è‡³å°‘è¦åŒ…å«å¤§/å°å†™å­—æ¯çš„æ€»ä¸ªæ•°ï¼› validate_password.number_count æ•´ä¸ªå¯†ç ä¸­è‡³å°‘è¦åŒ…å«é˜¿æ‹‰ä¼¯æ•°å­—çš„ä¸ªæ•°ï¼› validate_password.policy æŒ‡å®šå¯†ç çš„å¼ºåº¦éªŒè¯ç­‰çº§ï¼Œé»˜è®¤ä¸º MEDIUMï¼› å…³äº validate_password.policy çš„å–å€¼ï¼š 0/LOWï¼šåªéªŒè¯é•¿åº¦ï¼› 1/MEDIUMï¼šéªŒè¯é•¿åº¦ã€æ•°å­—ã€å¤§å°å†™ã€ç‰¹æ®Šå­—ç¬¦ï¼› 2/STRONGï¼šéªŒè¯é•¿åº¦ã€æ•°å­—ã€å¤§å°å†™ã€ç‰¹æ®Šå­—ç¬¦ã€å­—å…¸æ–‡ä»¶ï¼› å¦‚æœéœ€è¦è®¾ç½®ç©ºå¯†ç æˆ–è€…ç®€å•å¯†ç  è®¾ç½®ç©ºå¯†ç  mysql> UNINSTALL COMPONENT \"file://component_validate_password\"; Query OK, 0 rows affected (0.00 sec) mysql> set password=''; Query OK, 0 rows affected (0.00 sec) è®¾ç½®ç®€å•å¯†ç  #è®¾ç½®å¯†ç çš„éªŒè¯å¼ºåº¦ç­‰çº§ï¼ŒLOWè¡¨ç¤ºåªéªŒè¯å¯†ç é•¿ set global validate_password.policy=LOW; #è®¾ç½®å¯†ç å›ºå®šå¯†ç æ€»é•¿åº¦ set global validate_password.length=4; 3.3 å®‰è£…php 3.3.1 æ·»åŠ ç¬¬ä¸‰æ–¹yumæº å®‰è£…epelæºå¹¶æ·»åŠ ç¬¬ä¸‰æ–¹yumæº yum -y install epel-release && \\ yum -y install https://rpms.remirepo.net/enterprise/remi-release-7.rpm é€‰æ‹©è¦å®‰è£…çš„phpç‰ˆæœ¬ export phpversion=php73 yum -y install $phpversion-php-fpm $phpversion-php-cli $phpversion-php-bcmath $phpversion-php-gd $phpversion-php-json $phpversion-php-mbstring $phpversion-php-mcrypt $phpversion-php-mysqlnd $phpversion-php-opcache $phpversion-php-pdo $phpversion-php-pecl-crypto $phpversion-php-pecl-mcrypt $phpversion-php-pecl-geoip $phpversion-php-recode $phpversion-php-snmp $phpversion-php-soap $phpversion-php-xml é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥è·å–æ›´å¤šå®‰è£…ä¿¡æ¯ yum search php73 å®‰è£…åçš„phpé…ç½®æ–‡ä»¶è·¯å¾„ /etc/opt/remi/php73 3.3.2 ä¿®æ”¹phpé…ç½®æ–‡ä»¶ ç¼–è¾‘æ–‡ä»¶/etc/opt/remi/php73/php-fpm.d/www.confä¿®æ”¹phpè¿è¡Œç”¨æˆ·å’Œç»„ä¸ºwww sed -i.bak '/^user/c user = www' /etc/opt/remi/php73/php-fpm.d/www.conf && \\ sed -i '/^group/c group = www' /etc/opt/remi/php73/php-fpm.d/www.conf 3.3.3 å¯åŠ¨phpå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable php73-php-fpm && systemctl start php73-php-fpm å››ã€åŸºäºlnmpå¹³å°æ­å»ºwordpress wordpressä¸­æ–‡å®˜ç½‘ wordpressä¸‹è½½åœ°å€ 4.1 nginxé…ç½® ç¼–è¾‘wordpressçš„nginxé…ç½®æ–‡ä»¶/etc/nginx.conf.d/blog.conf âš ï¸server_nameä¸‹çš„indexåè¾¹å¿…é¡»æ˜¯index.phpï¼Œå¦åˆ™ä¼šæŠ¥é”™403 cat > /etc/nginx/conf.d/blog.conf wordpress httpsé…ç½®æ–‡ä»¶ server { listen 80; server_name blog.nginx.com; rewrite (.*) https://$server_name$request_uri redirect; } server { server_name _; listen 443; client_max_body_size 20m; ssl on; ssl_certificate ssl_key/server.crt; ssl_certificate_key ssl_key/server.key; location / { root /website/wordpress; index index.php index.html; } location ~ \\.php$ { root /website/wordpress; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; } } æ–‡ä»¶fastcgi_params fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;#è„šæœ¬æ–‡ä»¶è¯·æ±‚çš„è·¯å¾„ #ä»¥ä¸‹ä¸ºé»˜è®¤å†…å®¹ fastcgi_param QUERY_STRING $query_string; #è¯·æ±‚çš„å‚æ•°;å¦‚?app=123 fastcgi_param REQUEST_METHOD $request_method; #è¯·æ±‚çš„åŠ¨ä½œ(GET,POST) fastcgi_param CONTENT_TYPE $content_type; #è¯·æ±‚å¤´ä¸­çš„Content-Typeå­—æ®µ fastcgi_param CONTENT_LENGTH $content_length; #è¯·æ±‚å¤´ä¸­çš„Content-lengthå­—æ®µã€‚ fastcgi_param SCRIPT_NAME $fastcgi_script_name; #è„šæœ¬åç§° fastcgi_param REQUEST_URI $request_uri; #è¯·æ±‚çš„åœ°å€ä¸å¸¦å‚æ•° fastcgi_param DOCUMENT_URI document_uri; #ä¸document_uri; #ä¸uriç›¸åŒã€‚ fastcgi_param DOCUMENT_ROOT $document_root; #ç½‘ç«™çš„æ ¹ç›®å½•ã€‚åœ¨serveré…ç½®ä¸­rootæŒ‡ä»¤ä¸­æŒ‡å®šçš„å€¼ fastcgi_param SERVER_PROTOCOL $server_protocol; #è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼Œé€šå¸¸æ˜¯HTTP/1.0æˆ–HTTP/1.1ã€‚ fastcgi_param GATEWAY_INTERFACE CGI/1.1;#cgi ç‰ˆæœ¬ fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;#nginx ç‰ˆæœ¬å·ï¼Œå¯ä¿®æ”¹ã€éšè— fastcgi_param REMOTE_ADDR $remote_addr; #å®¢æˆ·ç«¯IP fastcgi_param REMOTE_PORT $remote_port; #å®¢æˆ·ç«¯ç«¯å£ fastcgi_param SERVER_ADDR $server_addr; #æœåŠ¡å™¨IPåœ°å€ fastcgi_param SERVER_PORT $server_port; #æœåŠ¡å™¨ç«¯å£ fastcgi_param SERVER_NAME $server_name; #æœåŠ¡å™¨åï¼ŒåŸŸååœ¨serveré…ç½®ä¸­æŒ‡å®šçš„server_name #fastcgi_param PATH_INFO $path_info;#å¯è‡ªå®šä¹‰å˜é‡ # PHP only, required if PHP was built with --enable-force-cgi-redirect #fastcgi_param REDIRECT_STATUS 200; åœ¨phpå¯æ‰“å°å‡ºä¸Šé¢çš„æœåŠ¡ç¯å¢ƒå˜é‡ å¦‚ï¼šecho $_SERVER['REMOTE_ADDR'] åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir /website ç¼–è¾‘phpæµ‹è¯•é…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.d/test.conf åˆ›å»ºinfo.phpæµ‹è¯•phpæ˜¯å¦æ­£å¸¸è§£æ cat > /tmp/info.php EOF æ³¨æ„ç«¯å£æ˜¯88 åˆ›å»ºmysql.phpæµ‹è¯•phpæ˜¯å¦èƒ½è¿æ¥mysqlæ•°æ®åº“æœåŠ¡ cat > /tmp/mysql.php EOF æœ¬æœºæµ‹è¯•å³å¯ $ curl 127.0.0.1:88/mysql.php Connection successful 4.2 ä¸‹è½½wordpresså®‰è£…åŒ…å¹¶è§£å‹è‡³nginxç½‘ç«™æ ¹ç›®å½• wget https://cn.wordpress.org/latest-zh_CN.tar.gz tar xf latest-zh_CN.tar.gz -C /website cd /website && chown -R www.www wordpress/ 4.3 åˆ›å»ºæ•°æ®åº“å¹¶æˆæƒ mysql> create database wordpress; Query OK, 1 row affected (0.00 sec) #mysql8ä¸èƒ½ç›´æ¥åˆ›å»ºç”¨æˆ·æˆæƒï¼Œéœ€è¦å…ˆåˆ›å»ºç”¨æˆ·ï¼Œç„¶åæˆæƒ mysql> create user wordpress@'localhost' identified by 'wordpress'; Query OK, 0 rows affected (0.01 sec) mysql> grant all on wordpress.* to wordpress@'localhost'; Query OK, 0 rows affected (0.00 sec) 4.4 æµè§ˆå™¨è®¿é—®IPå¼€å§‹å®‰è£… ç¬¬ä¸€æ­¥ã€æµè§ˆå™¨è®¿é—®IPå¼€å§‹å®‰è£… ç‚¹å‡»ç°åœ¨å°±å¼€å§‹ ç¬¬äºŒæ­¥ã€å¡«å†™æ•°æ®åº“ä¿¡æ¯ ç¬¬ä¸‰æ­¥ã€å¼€å§‹å®‰è£… ç¬¬å››æ­¥ã€é…ç½®ç«™ç‚¹æ ‡é¢˜ã€ç”¨æˆ·åå¯†ç ã€é‚®ç®± ç¬¬äº”æ­¥ã€å®Œæˆå®‰è£… ç¬¬å…­æ­¥ã€ç™»é™†wordpress ç™»é™†åé¦–ç•Œé¢ äº”ã€æ–‡ä»¶ä¸Šä¼ é™åˆ¶é—®é¢˜ ä¿®æ”¹phpé…ç½®æ–‡ä»¶php.ini upload_max_filesize = 20M post_max_size = 20M ä¿®æ”¹nginxé…ç½®æ–‡ä»¶ client_max_body_size 300M; php.ini é…ç½®å¯¹phpä¸Šä¼ æ–‡ä»¶å¤§å°çš„å½±å“å‚æ•°æœ‰ï¼š é…ç½®é¡¹ å€¼ åŠŸèƒ½ file_uploads ON ç¡®å®šæœåŠ¡å™¨ä¸Šçš„PHPè„šæœ¬æ˜¯å¦å¯ä»¥æ¥å—HTTPæ–‡ä»¶ä¸Šä¼  memory_limit 8M è®¾ç½®è„šæœ¬å¯ä»¥åˆ†é…çš„æœ€å¤§å†…å­˜é‡ï¼Œé˜²æ­¢å¤±æ§çš„è„šæœ¬ç‹¬å æœåŠ¡å™¨å†…å­˜ post_max_size 8M é™åˆ¶é€šè¿‡POSTæ–¹æ³•å¯ä»¥æ¥å—çš„ä¿¡æ¯æœ€å¤§é‡ upload_max_filesize 2M é™åˆ¶PHPå¤„ç†ä¸Šä¼ æ–‡ä»¶æœ€å¤§å€¼ï¼Œæ­¤å€¼å¿…é¡»å°äºpost_max_sizeå€¼ âš ï¸å½“post_max_sizeå€¼å°äºupload_max_filesizeçš„å€¼ï¼Œä»¥post_max_sizeçš„å€¼ä¸ºå‡† è€Œå¯¹åº”çš„$_FILES ä¸­errorå¯¹åº”çš„é”™è¯¯æç¤ºæœ‰ï¼š æ–‡ä»¶ä¸Šä¼ æ—¶äº§ç”Ÿçš„é”™è¯¯ 0ï¼šè¡¨ç¤ºæ²¡æœ‰å‘ç”Ÿä»»ä½•é”™è¯¯ï¼Œæ–‡ä»¶ä¸Šä¼ æˆåŠŸ 1ï¼šè¡¨ç¤ºä¸Šä¼ æ–‡ä»¶çš„å¤§å°è¶…å‡ºäº†å†PHPé…ç½®æ–‡ä»¶ä¸­upload_max_filesizeé€‰é¡¹é™åˆ¶çš„å€¼ 2ï¼šè¡¨ç¤ºä¸Šä¼ æ–‡ä»¶å¤§å°è¶…å‡ºäº†HTMLè¡¨å•ä¸­MAX_FILE_SIZEé€‰é¡¹æ‰€æŒ‡å®šçš„å€¼ 3ï¼šè¡¨ç¤ºæ–‡ä»¶åªè¢«éƒ¨åˆ†ä¸Šä¼  4ï¼šè¡¨ç¤ºæ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/11.nginx https.html":{"url":"linux/linuxæœåŠ¡/nginx/11.nginx https.html","title":"nginx https","keywords":"","body":"nginx https opensslå®˜ç½‘ ä¸€ã€æ£€æŸ¥ç¯å¢ƒå¹¶åˆ›å»ºå­˜æ”¾è¯ä¹¦ç›®å½• 1.1 opensslç‰ˆæœ¬1.0.2ä»¥ä¸Š $ openssl version OpenSSL 1.0.2k-fips 26 Jan 2017 1.2 nginxå¿…é¡»æ”¯æŒ--with-http_ssl_moduleæ¨¡å— #å…ˆæŠŠè¾“å‡ºæ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åä»æ–‡ä»¶ä¸­è¿‡æ»¤ nginx -V &> nginx.txt 1.3 åˆ›å»ºå­˜æ”¾nginxè¯ä¹¦çš„ç›®å½• mkdir /etc/nginx/ssl_key && cd /etc/nginx/ssl_key äºŒã€ç”Ÿæˆè¯ä¹¦ 2.1 ç”Ÿæˆç§é’¥ ä½¿ç”¨opensslå……å½“CAæƒå¨æœºæ„åˆ›å»ºç§é’¥(ç”Ÿäº§ä¸å¯èƒ½ä½¿ç”¨æ­¤æ–¹å¼ç”Ÿæˆè¯ä¹¦ï¼Œä¸è¢«äº’è”ç½‘CAæƒå¨æ‰¿è®¤çš„é»‘æˆ·è¯ä¹¦) åŠ -ideaå‚æ•°å°±ä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œæœ€å°‘4ä½ openssl genrsa -out ca.key 2048 2.2 ç”Ÿæˆè‡ªç­¾è¯ä¹¦ äº¤äº’å¼ openssl req -x509 -new -nodes -sha256 -days 36500 -key ca.key -out ca.crt å‚æ•°è¯´æ˜ å‚æ•° è¯´æ˜ req è¯·æ±‚å­å‘½ä»¤ -x509 è¯ä¹¦æ ¼å¼ -new ç”Ÿæˆè¯ä¹¦è¯·æ±‚ -nodes ç§é’¥ä¸åŠ å¯† -days è¯ä¹¦æœ‰æ•ˆæœŸ -key æŒ‡å®šç§é’¥æ–‡ä»¶ -out è¾“å…¥è¯ä¹¦æ–‡ä»¶ å…äº¤äº’å¼ openssl req -x509 -new -nodes -sha256 -days 36500 \\ -subj \"/C=CN/ST=Beijing/L=Beijing/O=dev/OU=devops/CN=www.yzbpdcnm.com\" \\ -key ca.key \\ -out ca.crt å…äº¤äº’å¼-subjå‚æ•° ç®€å†™ å®Œæ•´å•è¯ å«ä¹‰ C Country Name å›½å®¶ ST State or Province Name çœ L Locality Name åŸå¸‚ O Organization Name ç»„ç»‡åç§° OU Organization Unit Name ç»„ç»‡å•ä½åç§° CN Common Name åŸŸå ä¸‰ã€é…ç½®nginxä»¥httpsæ–¹å¼è®¿é—® 3.1 ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.d/https-test.conf 3.2 åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir /code && echo 'https test' >/code/index.html 3.3 æœ¬åœ°ç»‘å®šhostsæµè§ˆå™¨è®¿é—® æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/12.nginx rewrite.html":{"url":"linux/linuxæœåŠ¡/nginx/12.nginx rewrite.html","title":"nginx rewrite","keywords":"","body":"nginx rewrite æœ¬æ–‡éƒ¨åˆ†æŠ„è¢­äºæ­¤ nginx rewriteå®˜æ–¹æ–‡æ¡£ ä¸€ã€rewriteåŸºæœ¬æ¦‚è¿° 1.1 ä»€ä¹ˆæ˜¯rewrite rewriteå³URLé‡å†™ï¼Œ ä¸»è¦å®ç°urlåœ°å€é‡å†™ä»¥åŠé‡å®šå‘, å°±æ˜¯æŠŠä¼ å…¥Webçš„è¯·æ±‚é‡å®šå‘åˆ°å…¶ä»–URLçš„è¿‡ç¨‹ã€‚ 1.2 rewriteä½¿ç”¨åœºæ™¯ 1.URLåœ°å€è·³è½¬ï¼Œä¾‹å¦‚ç”¨æˆ·è®¿é—®aaa.comå°†å…¶è·³è½¬åˆ°bbb.com , æˆ–è€…å½“ç”¨æˆ·é€šè¿‡httpçš„æ–¹å¼è®¿é—®aaa.comæ—¶ï¼Œå°†å…¶è·³è½¬è‡³httpsçš„æ–¹å¼è®¿é—®bbb.com 2.URLä¼ªé™æ€, å°†åŠ¨æ€é¡µé¢æ˜¾ç¤ºä¸ºé™æ€é¡µé¢æ–¹å¼çš„ä¸€ç§æŠ€æœ¯, ä¾¿äºæœç´¢å¼•æ“çš„å½•å…¥, åŒæ—¶å‡å°‘åŠ¨æ€URLåœ°å€å¯¹å¤–æš´éœ²è¿‡å¤šçš„å‚æ•°, æå‡æ›´é«˜çš„å®‰å…¨æ€§ã€‚ 3.æœç´¢å¼•æ“SEOä¼˜åŒ–ä¾èµ–äºurlè·¯å¾„, ä»¥ä¾¿æ”¯æŒæœç´¢å¼•æ“å½•å…¥ äºŒã€rewriteé…ç½®è¯­æ³• Syntax: rewrite regex replacement [flag]; Default: â€” Context: server, location, if åœ¨åŒ¹é…è¿‡ç¨‹ä¸­å¯ä»¥å¼•ç”¨ä¸€äº›Nginxçš„å…¨å±€å˜é‡ å˜é‡ è¯´æ˜ $document_root é’ˆå¯¹å½“å‰è¯·æ±‚çš„æ ¹è·¯å¾„è®¾ç½®å€¼ $host è¯·æ±‚ä¿¡æ¯ä¸­çš„\"Host\"ï¼Œå¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰Hostè¡Œï¼Œåˆ™ç­‰äºè®¾ç½®çš„æœåŠ¡å™¨å $request_filename å½“å‰è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„åï¼ˆå¸¦ç½‘ç«™çš„ä¸»ç›®å½•/code/images/test.jpgï¼‰ $request_uri å½“å‰è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„åï¼ˆä¸å¸¦ç½‘ç«™çš„ä¸»ç›®å½•/images/test.jpgï¼‰ $scheme è¯·æ±‚ç”¨çš„åè®®ï¼Œæ¯”å¦‚httpæˆ–è€…https rewriteåŒ¹é…ä¼˜å…ˆçº§ 1.æ‰§è¡Œserverå—çš„rewriteæŒ‡ä»¤ 2.æ‰§è¡ŒlocationåŒ¹é… 3.æ‰§è¡Œé€‰å®šçš„locationä¸­çš„rewrite ä¸‰ã€flag rewriteæŒ‡ä»¤æ ¹æ®è¡¨è¾¾å¼æ¥é‡å®šå‘URI, æˆ–è€…ä¿®æ”¹å­—ç¬¦ä¸²ã€‚ å¯ä»¥åº”ç”¨äºserverã€locationã€ifç¯å¢ƒä¸‹ï¼Œæ¯è¡ŒrewriteæŒ‡ä»¤æœ€åè·Ÿä¸€ä¸ªflagæ ‡è®°ï¼Œæ”¯æŒçš„flagæ ‡è®°æœ‰å¦‚ä¸‹è¡¨æ ¼æ‰€ç¤º flag è¯´æ˜ last æœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆåï¼Œåœæ­¢åŒ¹é…ï¼Œä¸åœ¨åŒ¹é…åé¢çš„è§„åˆ™ break æœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆåï¼Œåœæ­¢åŒ¹é…ï¼Œä¸åœ¨åŒ¹é…åé¢çš„è§„åˆ™ redirect è¿”å›302ä¸´æ—¶é‡å®šå‘ï¼Œ åœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€ permanent è¿”å›301æ°¸ä¹…é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€ last å®˜æ–¹è§£é‡Š åœæ­¢å¤„ç†å½“å‰ngx_http_rewrite_moduleæŒ‡ä»¤é›†ï¼Œ å¹¶å¼€å§‹æœç´¢ä¸æ›´æ”¹åçš„URIç›¸åŒ¹é…çš„æ–°ä½ç½® å¦‚æœåŒ¹é…çš„URIï¼Œrewriteåœ¨serverå—ä¸­ï¼Œå¹¶ä¸”laståšä¸ºflagï¼ŒåŒ¹é…åˆ°æ­¤rewrite URIæ—¶ï¼Œä¸å†å‘ä¸‹åŒ¹é…serverå—ä¸­çš„rewriteï¼Œè¿›è€Œç»§ç»­ä¸‹é¢location URIçš„æŸ¥æ‰¾åŒ¹é…ï¼› å¦‚æœåŒ¹é…çš„URIï¼Œrewriteåœ¨locationå—ä¸­ï¼Œlaståšä¸ºflagï¼ŒåŒ¹é…åˆ°æ­¤rewrite URIæ—¶ï¼Œä¼šè·³å‡ºæ­¤locationå—ï¼Œç»§ç»­ä»ä¸Šåˆ°ä¸‹æŸ¥æ‰¾å…¶å®ƒçš„locationå—URIï¼Œä½†ä¸ä¼šå†åŒ¹é…serverå—ä¸­çš„rewriteä¸­çš„URI break å®˜æ–¹è§£é‡Š ngx_http_rewrite_moduleä¸breakæŒ‡ä»¤ä¸€æ ·ï¼Œ åœæ­¢å¤„ç†å½“å‰çš„æŒ‡ä»¤é›† å¦‚æœåŒ¹é…çš„URIï¼Œrewriteåœ¨serverå—ä¸­ï¼Œå¹¶ä¸”breakåšä¸ºflagï¼ŒåŒ¹é…åˆ°æ­¤rewrite URIæ—¶ï¼Œä¸å†å‘ä¸‹åŒ¹é…serverå—ä¸­çš„rewriteï¼Œè¿›è€Œç»§ç»­ä¸‹é¢location URIçš„æŸ¥æ‰¾åŒ¹é…ï¼› å¦‚æœåŒ¹é…çš„URIï¼Œrewriteåœ¨locationå—ä¸­ï¼Œbreakåšä¸ºflagï¼ŒåŒ¹é…åˆ°æ­¤rewriteæ—¶ï¼Œä¸ä¼šè·³å‡ºæ­¤locationå—ï¼Œè€Œæ˜¯ç»§ç»­å¯¹locationå—ä¸‹é¢çš„è¯­å¥ç»§ç»­è¿è¡Œï¼Œä¸ä¼šè·³å‡ºæ­¤locationå—ï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šåŒ¹é…location å—ä¸‹é¢çš„å…¶å®ƒrewriteè§„åˆ™ï¼› å®Œæˆè¯¥rewriteè§„åˆ™çš„æ‰§è¡Œåï¼Œåœæ­¢å¤„ç†åç»­rewriteæŒ‡ä»¤é›†ï¼Œå¹¶ä¸å†é‡æ–°æŸ¥æ‰¾ï¼›ä½†æ˜¯å½“å‰locationå†…å‰©ä½™érewriteè¯­å¥å’Œlocationå¤–çš„çš„érewriteè¯­å¥å¯ä»¥æ‰§è¡Œ redirect å®˜æ–¹è§£é‡Š è¿”å›å¸¦æœ‰302ä»£ç çš„ä¸´æ—¶é‡å®šå‘ï¼›å¦‚æœæ›¿æ¢å­—ç¬¦ä¸²ä¸æ˜¯ä»¥ \"http://\"ï¼Œ\" https://\"æˆ–\" $scheme\" å¼€å¤´ï¼Œåˆ™ä½¿ç”¨è¯¥å­—ç¬¦ä¸² permanent å®˜æ–¹è§£é‡Š è¿”å›301æ°¸ä¹…é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€ï¼Œå³è¡¨ç¤ºå¦‚æœå®¢æˆ·ç«¯ä¸æ¸…ç†æµè§ˆå™¨ç¼“å­˜ï¼Œé‚£ä¹ˆè¿”å›çš„ç»“æœå°†æ°¸ä¹…ä¿å­˜åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸­äº† å››ã€nginxå¤„ç†httpè¯·æ±‚çš„11ä¸ªé˜¶æ®µ ngx_http_post_read_phase è¯»å–è¯·æ±‚å¤´ï¼Œæ¥æ”¶åˆ°httpå¤´éƒ¨åå¤„ç†é˜¶æ®µ ngx_http_server_rewrite_phase æ‰§è¡Œserverå—ä¸­rewriteï¼Œç‹¬ç«‹httpé˜¶æ®µ ngx_http_find_config_phase æ ¹æ®uriæŸ¥æ‰¾æ›¿æ¢locationï¼Œuriå¯»æ‰¾åŒ¹é…çš„locationé˜¶æ®µ ngx_http_rewrite_phase æ ¹æ®æ›¿æ¢ç»“æœï¼Œç»§ç»­æ‰§è¡Œrewriteï¼Œå¯»æ‰¾åˆ°åŒ¹é…çš„locationä¹‹åå†ä¿®æ”¹è¯·æ±‚çš„uri ngx_http_post_rewrite_phase æ‰§è¡Œrewriteåå¤„ç†ï¼Œåœ¨rewriteé‡å†™urlåï¼Œé˜²æ­¢é”™è¯¯çš„nginx.confé…ç½®å¯¼è‡´æ­»å¾ªç¯(é€’å½’çš„ä¿®æ”¹uri) ngx_http_preaccess_phase è®¤è¯é¢„å¤„ç†ï¼Œè¯·æ±‚é™åˆ¶ï¼Œè¿æ¥é™åˆ¶ï¼Œè¡¨ç¤ºåœ¨å¤„ç†ngx_http_access_phaseé˜¶æ®µè¯·æ±‚è®¿é—®é™åˆ¶å‰ï¼Œhttpæ¨¡å—å¯ä»¥ä»‹å…¥å¤„ç†çš„é˜¶æ®µ ngx_http_access_phase è®¤è¯å¤„ç†ï¼Œç”¨äºè®©httpæ¨¡å—åˆ¤æ–­æ˜¯å¦å…è®¸è¿™ä¸ªè¯·æ±‚è®¿é—®nginxæœåŠ¡ ngx_http_post_access_phase è®¤è¯åå¤„ç†ï¼Œè®¤è¯ä¸é€šè¿‡ï¼Œä¸¢åŒ…ï¼Œåœ¨ngx_http_access_phaseé˜¶æ®µä¸­ï¼Œå½“httpæ¨¡å—çš„handlerå¤„ç†å‡½æ•°è¿”å›ä¸å…è®¸è®¿é—®çš„é”™è¯¯ç æ—¶(ngx_htp_forbiddenæˆ–è€…ngx_http_unauhorized)ï¼Œè¿™é‡Œå°†è´Ÿè´£å‘ç”¨æˆ·å‘é€æ‹’ç»æœåŠ¡çš„é”™è¯¯ç›¸åº” ngx_http_try_files_phase å°è¯•tryæ ‡ç­¾ï¼Œæ­¤é˜¶æ®µä¸“é—¨ä¸ºtry_filesé…ç½®é¢„è®¾ç«‹ï¼Œå½“httpè¯·æ±‚è®¿é—®é™æ€èµ„æºæ—¶ï¼Œtry_filesé…ç½®é¡¹å¯ä»¥ä½¿è¿™ä¸ªé…ç½®é¡ºåºçš„è®¿é—®å¤šä¸ªé™æ€èµ„æº ngx_http_content_phase å†…å®¹å¤„ç†ï¼Œç”¨äºå¤„ç†httpè¯·æ±‚å†…å®¹çš„é˜¶æ®µï¼Œè¿™æ˜¯å¤§éƒ¨åˆ†httpæ¨¡å—æœ€æ„¿æ„ä»‹å…¥çš„é˜¶æ®µ ngx_http_log_phase æ—¥å¿—å¤„ç†ï¼Œå¤„ç†å®Œè¯·æ±‚åè®°å½•æ—¥å¿—çš„é˜¶æ®µ äº”ã€rewriteé…ç½®å®ä¾‹ 5.1 æ— flagæµ‹è¯• åœ¨nginxä¸­å¼•å…¥echoã€sleepã€timeç­‰åŠŸèƒ½ githubåœ°å€ æ— flagæµ‹è¯•ç”¨ä¾‹1 server { listen 80; rewrite ^/(.*)$ /nginx_one/$1; rewrite ^/nginx_one/(.*)$ /nginx_two/$1; location / { echo \"This is default location\"; echo \"uri: ${uri}\"; } location /nginx_one/ { echo \"This is nginx_one location\"; echo \"uri: ${uri}\"; } location /nginx_two/ { echo \"This is nginx_two location\"; echo \"uri: ${uri}\"; } } æµ‹è¯•ç»“æœ $ curl 127.0.0.1/abc This is nginx_two location uri: /nginx_two/abc æ—  flag æ—¶ï¼Œrewrite ä¼šä¾æ¬¡å‘ä¸‹åŒ¹é…ï¼Œæ ¹æ®nginxåœ¨httpè¯·æ±‚å¤„ç†çš„é˜¶æ®µä¸­ï¼Œæˆ‘ä»¬ ä¼šå…ˆåŒ¹é…serverå—ä¸­çš„rewriteè§„åˆ™ï¼› ç¬¬ä¸€æ¬¡åŒ¹é…rewrite ^/(.*)$ /nginx_one/$1; URIå˜æˆ:/nginx_one/abcï¼Œæ— flagç»§ç»­å‘ä¸‹åŒ¹é…ï¼› ç¬¬äºŒæ¬¡åŒ¹é…rewrite ^/nginx_one/(.*)$ /nginx_two/$1; URIå˜æˆ/nginx_two/abcï¼› å†å‘ä¸‹FIND_CONFIGé˜¶æ®µï¼ŒæŸ¥æ‰¾locationè¿›è¡ŒåŒ¹é…ï¼Œæ­£å¥½æ‰¾åˆ°location /nginx_two/ æ‰€ä»¥ response å¦‚ä¸Šï¼› æ— flagæµ‹è¯•ç”¨ä¾‹2 server { listen 80; rewrite ^/(.*)$ /nginx_one/$1; location / { echo \"This is default location\"; echo \"uri: ${uri}\"; } location /nginx_one/ { rewrite ^/nginx_one/(.*)$ /nginx_two/$1; echo \"This is nginx_one location\"; echo \"uri: ${uri}\"; } location /nginx_two/ { echo \"This is nginx_two location\"; echo \"uri: ${uri}\"; } } æµ‹è¯•ç»“æœ $ curl 127.0.0.1/abc This is nginx_two location uri: /nginx_two/abc æ— flagï¼Œå¤„ç†serverå—é˜¶æ®µï¼ŒåŒ¹é…rewrite ^/(.*)$ /nginx_one/$1 ï¼ŒURIä¸ºï¼š/nginx_one/abc; åˆ°FIND_CONFIGé˜¶æ®µï¼ŒåŒ¹é…location, location /nginx_one/ ,è¿™ä¸ªlocationå—ä¸­æœ‰rewriteå†æ¬¡åŒ¹é…^/nginx_one/(.*)$ /nginx_two/$1; URIå˜ä¸ºï¼š/nginx_two/abcï¼Œè¿™é‡Œæ²¡æœ‰flagï¼Œä¼šè·³å‡ºç»§ç»­FIND_CONFIGé˜¶æ®µï¼Œè€Œä¸ä¼šåˆ° SERVER_REWRITE é˜¶æ®µï¼›è€Œæ˜¯åŒ¹é…location /nginx_two/ ï¼Œæ‰€ä»¥responseå¦‚ä¸Šã€‚ 5.2 æœ‰flagæµ‹è¯• redirectå’Œpermanentçš„åŒºåˆ«å°±æ˜¯redirectæ˜¯ä¸´æ—¶é‡å®šå‘302ï¼Œè€Œpermanentæ˜¯æ°¸ä¹…é‡å®šå‘301 5.2.1 flag redirectæµ‹è¯•ç”¨ä¾‹1 server { listen 80; #rewrite ^/(.*)$ /nginx_one/$1 redirect; rewrite ^/(.*)$ https://www.baidu.com/ redirect; rewrite ^/nginx_one/(.*)$ /nginx_two/$1; rewrite ^/nginx_two/(.*)$ /nginx_three/$1; location / { echo \"This is default location\"; echo \"uri: ${uri}\"; } location /nginx_one/ { echo \"This is nginx_one location\"; echo \"uri: ${uri}\"; } location /nginx_two/ { echo \"This is nginx_two location\"; echo \"uri: ${uri}\"; } location /nginx_three/ { echo \"This is nginx_three location\"; echo \"uri: ${uri}\"; } } æµ‹è¯•ç»“æœ æµè§ˆå™¨è®¿é—® è™šæ‹ŸæœºIPåœ°å€/abc ä¼šè·³è½¬åˆ°ç™¾åº¦é¦–é¡µ çŠ¶æ€ç ä¸ºä¸´æ—¶é‡å®šå‘302 è¿™é‡Œçš„flagæ˜¯redirectï¼Œè¯´æ˜éœ€è¦é‡å®šå‘åˆ°replacementï¼Œæ­£å¥½è¿™é‡Œçš„replacementæœ‰\"https://\"ï¼Œæ­¤æ—¶ä¼šç›´æ¥è·³è½¬å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ï¼› å¦‚æœæ‰“å¼€#rewrite ^/(.*)$ /nginx_one/$1 redirect;çš„æ³¨é‡Šï¼Œæµè§ˆå™¨ä¸­è®¿é—®ä¼šæç¤ºé‡å®šå‘æ¬¡æ•°è¿‡å¤š 5.2.2 flag redirectæµ‹è¯•ç”¨ä¾‹2 server { listen 80; rewrite_log on; rewrite ^/nginx_one/(.*)$ /nginx_two/$1; rewrite ^/nginx_two/(.*)$ /nginx_three/$1 redirect; rewrite ^/(.*)$ /nginx_one/$1; location / { echo \"This is default location\"; echo \"uri: ${uri}\"; } location /nginx_one/ { echo \"This is nginx_one location\"; echo \"uri: ${uri}\"; } location /nginx_two/ { echo \"This is nginx_two location\"; echo \"uri: ${uri}\"; } location /nginx_three/ { echo \"This is nginx_three location\"; echo \"uri: ${uri}\"; } } æµ‹è¯•ç»“æœ $ curl -I 127.0.0.1/nginx_one/abc HTTP/1.1 302 Moved Temporarily Server: nginx/1.16.1 Date: Mon, 22 Jun 2020 12:05:16 GMT Content-Type: text/html Content-Length: 145 Location: http://127.0.0.1/nginx_three/abc Connection: keep-alive 1.åŒ¹é…rewrite ^/nginx_one/(.*)$ /nginx_two/$1; åï¼ŒURIå˜ä¸ºï¼š/nginx_two/abc ; æ— flagï¼Œç»§ç»­å‘ä¸‹ï¼› 2.ç»§ç»­åŒ¹é… rewrite ^/nginx_two/(.*)$ /nginx_three/$1 redirect; 302ä¸´æ—¶ é‡å®šå‘ï¼ŒURI: http://127.0.0.1/nginx_three/abc, 3.å†æ¬¡è®¿é—®ï¼Œæ­¤æ—¶ä¼šä»SERVER_REWRITEè¿™ä¸ªé˜¶æ®µå¼€å§‹ï¼Œæ­¤æ—¶åŒ¹é…çš„æ˜¯ rewrite ^/(.*)$ /nginx_one/$1; URIå˜ä¸ºï¼š/nginx_one/nginx_three/abc ï¼Œæ— flagï¼Œå‘ > ä¸‹FIND_CONFIGé˜¶æ®µï¼› 4.æœ€åæŸ¥çœ‹location åŒ¹é…location /nginx_one/ ,æ‰€ä»¥å›æ˜¾å¦‚ä¸Šï¼› 5.2.3 flag lastæµ‹è¯•ç”¨ä¾‹1 server { listen 80; rewrite_log on; rewrite ^/nginx_one/(.*)$ /nginx_two/$1 last; rewrite ^/nginx_two/(.*)$ /nginx_three/$1; location / { echo \"This is default location\"; echo \"uri: ${uri}\"; } location /nginx_one/ { echo \"This is nginx_one location\"; echo \"uri: ${uri}\"; } location /nginx_two/ { echo \"This is nginx_two location\"; echo \"uri: ${uri}\"; } location /nginx_three/ { echo \"This is nginx_three location\"; echo \"uri: ${uri}\"; } } æµ‹è¯•ç»“æœ $ curl 127.0.0.1/nginx_one/abc This is nginx_two location uri: /nginx_two/abc 1.åŒ¹é… rewrite ^/k8svip_one/(.*)$ /k8svip_two/$1 last;é‡åˆ°lastï¼Œåœæ­¢åŒçº§æ®µçš„åŒ¹é…ï¼Œè¿™é‡Œçš„æ„æ€æ˜¯ï¼Œä¸­æ­¢serveræ®µå‘ä¸‹çš„åŒ¹é…ï¼Œè¿›è¡ŒFIND_CONFIGé˜¶æ®µï¼ŒURIå˜ä¸ºï¼š/k8svip_two/abc; è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœlastæ²¡æœ‰ä¸­æ­¢serveræ®µå‘ä¸‹çš„åŒ¹é…ï¼Œä¼šåŒ¹é…rewrite ^/k8svip_two/(.*)$ /k8svip_three/$1ï¼Œå®é™…ç»“æœæ˜¯æ²¡æœ‰åŒ¹é…çš„ï¼› 2.ç”±ä¸Šé¢æ­¥éª¤ä¹‹åï¼ŒåŒ¹é…location /k8svip_two/ï¼Œ æ‰€ä»¥ä¼šå‡ºç°ä¸Šé¢çš„responseç»“æœ; 5.2.4 flag lastæµ‹è¯•ç”¨ä¾‹2 server { listen 80; rewrite_log on; rewrite ^/(.*)$ /nginx_one/$1; rewrite ^/nginx_three/(.*)$ /nginx_four/$1; location / { echo \"This is default location\"; echo \"uri: ${uri}\"; } location /nginx_one/ { rewrite ^/(.*)$ /nginx_three/$1 last; rewrite ^/nginx_three/(.*)$ /; echo \"This is nginx_one location\"; echo \"uri: ${uri}\"; } location /nginx_two/ { echo \"This is nginx_two location\"; echo \"uri: ${uri}\"; } location /nginx_three/ { echo \"This is nginx_three location\"; echo \"uri: ${uri}\"; } location /nginx_four/ { echo \"This is nginx_four location\"; echo \"uri: ${uri}\"; } } æµ‹è¯•ç»“æœ $ curl 127.0.0.1/abc This is nginx_three location uri: /nginx_three/nginx_one/abc 1.åŒ¹é…rewrite ^/(.*)$ /k8svip_one/$1; URIå˜ä¸ºï¼š/nginx_one/abc; 2.åŒ¹é…location /nginx_one/ è¿›è€ŒåŒ¹é…locationå—ä¸­çš„rewrite ^/(.*)$ /nginx_three/$1 last; å› ä¸ºæ˜¯lastï¼Œä¼šè·³å‡ºlocationç»§ç»­FIND_CONFIGé˜¶æ®µ 3.URIä¸ºï¼š/nginx_three/nginx_one/abcï¼›è€Œä¸ä¼šåˆ°SERVER_WRITEé˜¶æ®µï¼› åŒ¹é… location /nginx_three/ ,æ‰€ä»¥çœ‹åˆ°ä¸Šé¢çš„responseï¼› 5.2.5 flag breakæµ‹è¯•ç”¨ä¾‹1 server { listen 80; rewrite_log on; rewrite ^/nginx_one/(.*)$ /nginx_two/$1 break; rewrite ^/nginx_two/(.*)$ /nginx_three/$1; location / { echo \"This is default location\"; echo \"uri: ${uri}\"; } location /nginx_one/ { echo \"This is nginx_one location\"; echo \"uri: ${uri}\"; } location /nginx_two/ { echo \"This is nginx_two location\"; echo \"uri: ${uri}\"; } location /nginx_three/ { echo \"This is nginx_three location\"; echo \"uri: ${uri}\"; } } æµ‹è¯•ç»“æœ $ curl 127.0.0.1/nginx_one/abc This is nginx_two location uri: /nginx_two/abc 1.åŒ¹é…rewrite ^/nginx_one/(.*)$ /nginx_two/$1 break; flagä¸ºbreakï¼Œç»“æŸæœ¬å±‚çº§çš„rewirteåŒ¹é…ï¼ŒURIå˜ä¸ºï¼š/nginx_two/abc 2.ç»§ç»­FIND_CONFIGé˜¶æ®µï¼ŒåŒ¹é…location /nginx_two/; æ‰€ä»¥response å¦‚ä¸Šï¼› 5.2.6 flag breakæµ‹è¯•ç”¨ä¾‹2 server { listen 80; rewrite_log on; rewrite ^/(.*)$ /nginx_one/$1; location / { echo \"This is default location\"; echo \"uri: ${uri}\"; } location /nginx_one/ { rewrite ^/(.*)$ /nginx_three/$1 break; rewrite ^/nginx_two/(.*)$ /; echo \"This is nginx_one location\"; echo \"uri: ${uri}\"; } location /nginx_two/ { echo \"This is nginx_two location\"; echo \"uri: ${uri}\"; } location /nginx_three/ { echo \"This is nginx_three location\"; echo \"uri: ${uri}\"; } } æµ‹è¯•ç»“æœ $ curl 127.0.0.1/abc This is nginx_one location uri: /nginx_three/nginx_one/abc 1.åŒ¹é…rewrite ^/(.*)$ /nginx_one/$1; URIå˜ä¸ºï¼š/nginx_one/abc 2.åŒ¹é…location /nginx_one/ï¼Œç„¶åç»§ç»­ rewrite ^/(.)$ /nginx_three/$1 break; flagä¸ºbreakï¼Œç»“æŸæœ¬å±‚çº§çš„rewrite ^/(.)$ /nginx_three/$1 break;ï¼Œå¹¶ä¸”ç»§ç»­è¿›è¡Œæœ¬å±‚çº§çš„å…¶å®ƒæ“ä½œï¼› 3.æ­¤æ—¶çš„URIï¼š/nginx_three/nginx_one/abc,æ‰€ä»¥responseå¦‚ä¸Šï¼› æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/13.nginxåŠ¨é™åˆ†ç¦».html":{"url":"linux/linuxæœåŠ¡/nginx/13.nginxåŠ¨é™åˆ†ç¦».html","title":"nginxåŠ¨é™åˆ†ç¦»","keywords":"","body":"nginxåŠ¨é™åˆ†ç¦» ä¸€ã€åŠ¨é™åˆ†ç¦»ç®€ä»‹ åŠ¨é™åˆ†ç¦»ï¼Œé€šè¿‡ä¸­é—´ä»¶å°†åŠ¨æ€è¯·æ±‚å’Œé™æ€è¯·æ±‚è¿›è¡Œåˆ†ç¦», åˆ†ç¦»èµ„æº, å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚æ¶ˆè€—, å‡å°‘è¯·æ±‚å»¶æ—¶ã€‚ å¥½å¤„ åŠ¨é™åˆ†ç¦»å, å³ä½¿åŠ¨æ€æœåŠ¡ä¸å¯ç”¨, ä½†é™æ€èµ„æºä¸ä¼šå—åˆ°å½±å“ å®éªŒç¯å¢ƒ è§’è‰² æœåŠ¡ IPåœ°å€ ä¸»æœºå è´Ÿè½½å‡è¡¡ Nginx Proxy 10.0.0.10 lb01 é™æ€èµ„æº Nginx Static 10.0.0.51 web01 åŠ¨æ€èµ„æº Tomcat Server 10.0.0.52 tomcat äºŒã€é…ç½®è¿‡ç¨‹ 2.1 è´Ÿè½½å‡è¡¡é…ç½® ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ upstream static { server 10.0.0.51:80; } upstream tomcat { server 10.0.0.52:8080; } server { listen 80; server_name _; location / { root /website; index index.html; } location ~* .*\\.(png|jpg|gif)$ { proxy_pass http://static; } location ~* .*\\.jsp$ { proxy_pass http://tomcat; } } 2.2 web01é…ç½®é™æ€èµ„æº ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ server { listen 80; server_name _; location ~* .*\\.(png|jpg|gif)$ { root /website/images; } } åˆ›å»ºç½‘ç«™æ ¹ç›®å½• #åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir -p /website/images && cd /website/images #ä¸‹è½½ä¸€ä¸ªå›¾ç‰‡ wget -O /website/images/nginx.png https://nginx.org/nginx.png 2.3 tomcaté…ç½®åŠ¨æ€èµ„æº ç¼–è¾‘jspæµ‹è¯•æ–‡ä»¶ âš ï¸è¿™é‡Œå·²ç»äºŒè¿›åˆ¶å®‰è£…tomcat8.5 cat > /usr/local/tomcat-8.5.56/webapps/ROOT/tomcat_test.jsp JSP Test Page Random number:\"); out.println(rand.nextInt(99)+100); %> EOF ä¸‰ã€è®¿é—®æµ‹è¯• è®¿é—®é™æ€èµ„æº è®¿é—®åŠ¨æ€èµ„æº æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/nginxå¢åŠ æ–°æ¨¡å—.html":{"url":"linux/linuxæœåŠ¡/nginx/nginxå¢åŠ æ–°æ¨¡å—.html","title":"nginxå¢åŠ æ–°æ¨¡å—","keywords":"","body":"nginxå¢åŠ æ–°æ¨¡å— åœºæ™¯ï¼šç¼–è¯‘å®‰è£…çš„nginxåç»­å¯èƒ½ä¼šå¢åŠ ä¸€äº›ç¬¬ä¸‰æ–¹æ¨¡å—æˆ–è€…æœªç¼–è¯‘çš„nginxæ¨¡å— ä¸€ã€ç¼–è¯‘å®‰è£…çš„nginxå¢åŠ æ–°æ¨¡å— 1.1 æŸ¥çœ‹nginxç¼–è¯‘å®‰è£…å‚æ•° $ nginx -V nginx version: nginx/1.16.1 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/etc/nginx --user=nginx --group=nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --with-http_gzip_static_module --with-http_stub_status_module --with-http_ssl_module --with-pcre --with-file-aio --with-http_realip_module --without-http_scgi_module --without-http_uwsgi_module --without-http_fastcgi_module 1.2 ä¸‹è½½ç¬¬ä¸‰æ–¹æ¨¡å— echo-nginx-module githubåœ°å€ ngx_echo ä¸ºNginxé…ç½®æ–‡ä»¶å¸¦æ¥\"echo\"ï¼Œ\"sleep\"ï¼Œ\"time\"ï¼Œ\"exec\"å’Œæ›´å¤šshellæ ·å¼çš„ä¸œè¥¿ wget https://github.com/openresty/echo-nginx-module/archive/v0.61.tar.gz è§£å‹ç¼©è‡³/usr/local tar xf v0.61.tar.gz -C /usr/local ä½¿ç”¨é€‰é¡¹--add-module=/path/to/echo-nginx-moduleæ·»åŠ æ¨¡å— 1.3 é‡æ–°ç¼–è¯‘nginx âš ï¸makeä¹‹åä¸è¦æ‰§è¡Œmake install ï¼ï¼ï¼ #è¿›å…¥nginxæºç ç›®å½• cd nginx-1.16.1 #é‡æ–°./configure ./configure --prefix=/etc/nginx --user=nginx --group=nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --with-http_gzip_static_module --with-http_stub_status_module --with-http_ssl_module --with-pcre --with-file-aio --with-http_realip_module --without-http_scgi_module --without-http_uwsgi_module --without-http_fastcgi_module --add-module=/usr/local/echo-nginx-module-0.61 #ç¼–è¯‘ï¼Œä¸èƒ½æ‰§è¡Œmake install make å®‰è£…å®ŒæˆåæŸ¥çœ‹ï¼Œæœ€åå°±æ˜¯æ·»åŠ çš„ç¬¬ä¸‰æ–¹æ¨¡å— $ nginx -V nginx version: nginx/1.16.1 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/etc/nginx --user=nginx --group=nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --with-http_gzip_static_module --with-http_stub_status_module --with-http_ssl_module --with-pcre --with-file-aio --with-http_realip_module --without-http_scgi_module --without-http_uwsgi_module --without-http_fastcgi_module --add-module=/usr/local/echo-nginx-module-0.61 1.4 nginxäºŒè¿›åˆ¶æ–‡ä»¶æ“ä½œ å¤‡ä»½åŸæœ‰æ–‡ä»¶ mv /usr/sbin/nginx{,.bak} æ‹·è´æ–°æ–‡ä»¶ cp nginx-1.16.1/objs/nginx /usr/sbin 1.5 ç¼–è¯‘nginxé…ç½®æ–‡ä»¶ä»¥æµ‹è¯•æ¨¡å—å®‰è£…æ˜¯å¦æˆåŠŸ server { listen 88; server_name _; location /test { echo \"This is default location\"; echo \"uri: ${uri}\"; } } æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx è¿™é‡Œè¯­æ³•ä¸æŠ¥é”™å°±è¯æ˜ç¬¬ä¸‰æ–¹æ¨¡å—echoå®‰è£…æˆåŠŸäº† $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful $ nginx -s reload æœ¬æœºè®¿é—®æµ‹è¯• $ curl 127.0.0.1:88/test This is default location uri: /test äºŒã€rpmåŒ…å®‰è£…çš„nginxå¢åŠ æ–°æ¨¡å— nginxæ˜¯ä½¿ç”¨rpmåŒ…å®‰è£…çš„ï¼Œå¦‚æœæƒ³è¦å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—çš„è§£å†³æ–¹æ³• 2.1 æŸ¥çœ‹nginxå®‰è£…çš„æ¨¡å— $ nginx -V nginx version: nginx/1.16.1 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' å®‰è£…å®ŒæˆåæŸ¥çœ‹ï¼Œæœ€åå°±æ˜¯æ·»åŠ çš„ç¬¬ä¸‰æ–¹æ¨¡å— $ nginx -V nginx version: nginx/1.16.1 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' --add-module=/usr/local/echo-nginx-module-0.61 2.2 ä¸‹è½½ä¸€ä¸ªç›¸åŒç‰ˆæœ¬çš„nginxæºç åŒ… nginxå®˜æ–¹æºç ä¸‹è½½åœ°å€ wget https://nginx.org/download/nginx-1.16.1.tar.gz 2.3 é‡æ–°ç¼–è¯‘nginx è§£å‹ç¼©æºç åŒ…å¹¶è¿›å…¥ç›®å½• tar xf nginx-1.16.1.tar.gz cd cd nginx-1.16.1/ âš ï¸makeä¹‹åä¸è¦æ‰§è¡Œmake install ï¼ï¼ï¼ #é‡æ–°./configure ./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' --add-module=/usr/local/echo-nginx-module-0.61 #ç¼–è¯‘ make 2.4 nginxäºŒè¿›åˆ¶æ–‡ä»¶æ“ä½œ å¤‡ä»½åŸæœ‰æ–‡ä»¶ mv /usr/sbin/nginx{,.bak} æ‹·è´æ–°æ–‡ä»¶ cp nginx-1.16.1/objs/nginx /usr/sbin 2.5 ç¼–è¯‘nginxé…ç½®æ–‡ä»¶ä»¥æµ‹è¯•æ¨¡å—å®‰è£…æ˜¯å¦æˆåŠŸ server { listen 88; server_name _; location /test { echo \"This is default location\"; echo \"uri: ${uri}\"; } } âš ï¸å› ä¸ºæ˜¯rpmåŒ…å®‰è£…çš„nginxï¼Œå› æ­¤éœ€è¦ä½¿ç”¨systemctlå‘½åé‡å¯ä¸€ä¸‹nginx systemctl restart nginx æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx è¿™é‡Œè¯­æ³•ä¸æŠ¥é”™å°±è¯æ˜ç¬¬ä¸‰æ–¹æ¨¡å—echoå®‰è£…æˆåŠŸäº† $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful $ nginx -s reload æœ¬æœºè®¿é—®æµ‹è¯• $ curl 127.0.0.1:88/test This is default location uri: /test æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/nginxè§£å†³é80ç«¯å£httpsé—®é¢˜.html":{"url":"linux/linuxæœåŠ¡/nginx/nginxè§£å†³é80ç«¯å£httpsé—®é¢˜.html","title":"nginxè§£å†³é80ç«¯å£httpsé—®é¢˜","keywords":"","body":"nginxè§£å†³é80ç«¯å£httpsé—®é¢˜ è§£å†³æ€è·¯ï¼š ç›‘å¬80ç«¯å£ï¼Œ80é‡å®šå‘åˆ°https443ç«¯å£ï¼Œ443ç«¯å£ä»£ç†åˆ«çš„ç«¯å£ server { listen 80; server_name pan.pptfz.top; return 301 https://$server_name$request_uri; } server { listen 443 ssl; server_name pan.pptfz.top; if ($host != 'pan.pptfz.top') { rewrite ^(.*)$ https://pan.pptfz.top/$1 permanent; } if ($request_uri ~ \"^[^?]*//\") { rewrite \"(.*)\" $scheme://$host$1 permanent; } location / { try_files /_not_exists_ @backend; } location @backend { proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header Host $http_host; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://127.0.0.1:5212; } access_log /var/log/nginx/pan.pptfz.top.access.log main; error_log /var/log/nginx/pan.pptfz.top.error.log; ssl_certificate /etc/nginx/ssl_key/pan/3356127_pan.pptfz.top.pem; ssl_certificate_key /etc/nginx/ssl_key/pan/3356127_pan.pptfz.top.key; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; } æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nginx/14.nginx+keepalivedå®ç°è´Ÿè½½å‡è¡¡é«˜å¯ç”¨.html":{"url":"linux/linuxæœåŠ¡/nginx/14.nginx+keepalivedå®ç°è´Ÿè½½å‡è¡¡é«˜å¯ç”¨.html","title":"nginx+keepalivedå®ç°è´Ÿè½½å‡è¡¡é«˜å¯ç”¨","keywords":"","body":"nginx+keepalivedå®ç°è´Ÿè½½å‡è¡¡é«˜å¯ç”¨ keepalivedå®˜ç½‘ keepalived githubåœ°å€ keepalivedå®˜æ–¹æ–‡æ¡£ keepalivedæºç åŒ…å®˜æ–¹ä¸‹è½½åœ°å€ ä¸€ã€keepalivedç®€ä»‹ Keepalivedæ˜¯ç”¨Cè¯­è¨€ç¼–å†™çš„è·¯ç”±è½¯ä»¶ã€‚è¯¥é¡¹ç›®çš„ä¸»è¦ç›®æ ‡æ˜¯ä¸ºLinuxç³»ç»Ÿå’ŒåŸºäºLinuxçš„åŸºç¡€æ¶æ„æä¾›è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨æ€§çš„ç®€å•è€Œå¼ºå¤§çš„åŠŸèƒ½ã€‚ è´Ÿè½½å¹³è¡¡æ¡†æ¶ä¾èµ–äºæä¾›ç¬¬4å±‚è´Ÿè½½å¹³è¡¡çš„è‘—åä¸”å¹¿æ³›ä½¿ç”¨çš„Linuxè™šæ‹ŸæœåŠ¡å™¨ï¼ˆIPVSï¼‰å†…æ ¸æ¨¡å—ã€‚Keepalivedå®ç°äº†ä¸€ç»„æ£€æŸ¥å™¨ï¼Œä»¥æ ¹æ®å…¶è¿è¡ŒçŠ¶å†µåŠ¨æ€ï¼Œè‡ªé€‚åº”åœ°ç»´æŠ¤å’Œç®¡ç†è´Ÿè½½å¹³è¡¡çš„æœåŠ¡å™¨æ± ã€‚å¦ä¸€æ–¹é¢ï¼ŒVRRPå®ç°äº†é«˜å¯ç”¨æ€§åè®®ã€‚VRRPæ˜¯è·¯ç”±å™¨æ•…éšœè½¬ç§»çš„åŸºç¡€ã€‚æ­¤å¤–ï¼ŒKeepalivedè¿˜å®ç°äº†ä¸€ç»„VRRPæœ‰é™çŠ¶æ€æœºçš„é’©ï¼Œä»è€Œæä¾›äº†ä½çº§å’Œé«˜é€Ÿåè®®äº¤äº’ã€‚ä¸ºäº†æä¾›æœ€å¿«çš„ç½‘ç»œæ•…éšœæ£€æµ‹ï¼ŒKeepalivedå®æ–½BFDåè®®ã€‚VRRPçŠ¶æ€è½¬æ¢å¯ä»¥è€ƒè™‘BFDæç¤ºæ¥é©±åŠ¨å¿«é€ŸçŠ¶æ€è½¬æ¢ã€‚Keepalivedæ¡†æ¶å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä¸€èµ·ä½¿ç”¨ä»¥æä¾›å¼¹æ€§åŸºç¡€æ¶æ„ã€‚ äºŒã€keepalivedè´Ÿè½½å‡è¡¡é«˜å¯ç”¨é…ç½®è¿‡ç¨‹ å®éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå keepalived-master 10.0.0.10 keepalived01 keepalived-slave 10.0.0.11 keepalived02 web01 10.0.0.51 nginx01 web02 10.0.0.52 nginx02 2.1 è´Ÿè½½å‡è¡¡ç«¯é…ç½® 2.1.1 å®‰è£…keepalived yum -y install keepalived centos7.7ä¸­é»˜è®¤çš„keepaliveç‰ˆæœ¬æ˜¯1.3.5ï¼Œå¦‚æœéœ€è¦é«˜ç‰ˆæœ¬è¯·åˆ°keepalived githubåœ°å€æˆ–è€…keepalivedå®˜ç½‘ä¸‹è½½ï¼Œè¿™é‡Œä»…åšå®éªŒç›´æ¥yumå®‰è£… $ keepalived -version Keepalived v1.3.5 (03/19,2017), git commit v1.3.5-6-g6fa32f2 2.1.2 lb01(keepalived master)ç¼–è¾‘é…ç½®æ–‡ä»¶ lb01ç¼–è¾‘keepalivedé…ç½®æ–‡ä»¶/etc/keepalived/keepalived.conf #å¤‡ä»½åŸæœ‰æ–‡ä»¶ mv /etc/keepalived/keepalived.conf{,.bak} #é‡æ–°ç¼–è¾‘æ–‡ä»¶ cat > /etc/keepalived/keepalived.conf é…ç½®æ–‡ä»¶å‚æ•°å«ä¹‰ #é…ç½®å«ä¹‰ global_defs { router_id lb01 #è¡¨ç¤ºidèº«ä»½ï¼Œåç§°éšæ„ } vrrp_instance VI_1 { state MASTER #çŠ¶æ€ï¼Œè§’è‰²ä¸ºmaster interface eth0 #VIPç»‘å®šçš„ç½‘å¡ virtual_router_id 50 #ä¸»å’Œå¤‡çš„è™šæ‹Ÿidå·è¦ç›¸åŒï¼Œè¡¨æ˜åœ¨ä¸€ä¸ªç»„å½“ä¸­ï¼Œåç§°éšæ„ï¼Œä¸è¦è¶…è¿‡255 priority 150 #ä¼˜å…ˆçº§ï¼Œè¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ advert_int 1 #å¿ƒè·³æ£€æµ‹ï¼Œå•ä½ç§’ï¼Œå¤‡æœºæ¯éš”1ç§’æ£€æµ‹ä¸€æ¬¡ä¸»çš„å­˜æ´»çŠ¶æ€ authentication { #è®¤è¯ä¿¡æ¯ auth_type PASS auth_pass 123456 } virtual_ipaddress { 10.0.0.100 #è™šæ‹ŸIP } } 2.1.3 lb02(keepalived backup)ç¼–è¾‘é…ç½®æ–‡ä»¶ #å¤‡ä»½åŸæœ‰æ–‡ä»¶ mv /etc/keepalived/keepalived.conf{,.bak} #é‡æ–°ç¼–è¾‘æ–‡ä»¶ cat > /etc/keepalived/keepalived.conf é…ç½®æ–‡ä»¶å‚æ•°å«ä¹‰ global_defs { router_id lb02 #è¡¨ç¤ºidèº«ä»½ï¼Œåç§°éšæ„ } vrrp_instance VI_1 { state BACKUP #çŠ¶æ€ï¼Œå› ä¸ºæ˜¯slaveï¼Œæ‰€ä»¥æ˜¯BACKUP interface eth0 #VIPç»‘å®šçš„ç½‘å¡ virtual_router_id 50 #ä¸»å’Œå¤‡çš„è™šæ‹Ÿidå·è¦ç›¸åŒï¼Œè¡¨æ˜åœ¨ä¸€ä¸ªç»„å½“ä¸­ï¼Œåç§°éšæ„ï¼Œä¸è¦ è¶…è¿‡255 priority 100 #ä¼˜å…ˆçº§ï¼Œè¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ advert_int 1 #å¿ƒè·³æ£€æµ‹ï¼Œå•ä½ç§’ï¼Œå¤‡æœºæ¯éš”1ç§’æ£€æµ‹ä¸€æ¬¡ä¸»çš„å­˜æ´»çŠ¶æ€ authentication { #è®¤è¯ä¿¡æ¯ auth_type PASS auth_pass 123456 } virtual_ipaddress { 10.0.0.100 #è™šæ‹ŸIP } } å¯¹æ¯”keepalivedçš„masterä¸backupé…ç½®çš„åŒºåˆ« Keepalivedé…ç½®åŒºåˆ« Masteré…ç½® BackupèŠ‚é…ç½® route_id(å”¯ä¸€æ ‡è¯†) route_id lb01 route_id lb02 state(è§’è‰²çŠ¶æ€) state Master state Backup priority(ç«é€‰ä¼˜å…ˆçº§) priority 150 priority 100 2.1.4 å¯åŠ¨keepalived lb01å’Œlb02ç›¸åŒæ“ä½œ systemctl start keepalived && systemctl enable keepalived 2.1.5 æ£€æµ‹lb01æ˜¯å¦æœ‰vip å¯ä»¥çœ‹åˆ°ï¼Œå¯åŠ¨keepalivedåï¼Œlb01 eth0ç½‘å¡å°±æœ‰äº†VIP 10.0.0.100 $ ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:f3:3c:78 brd ff:ff:ff:ff:ff:ff inet 10.0.0.10/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet 10.0.0.100/32 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fef3:3c78/64 scope link valid_lft forever preferred_lft forever 2.1.6 éªŒè¯VIPæ˜¯å¦èƒ½å¤Ÿæ­£å¸¸æ¼‚ç§» VIPé¦–å…ˆåœ¨masterä¸Šï¼Œå½“masterå®•æœºåï¼ŒVIPä¼šæ¼‚ç§»è‡³backupï¼Œå½“masteræ¢å¤æ—¶VIPä¼šè‡ªåŠ¨æ¼‚ç§»å›æ¥ï¼ï¼ï¼ å…ˆåœæ­¢lb01ä¸Šçš„keepalived systemctl stop keepalived æŸ¥çœ‹lb01ä¸Šæ˜¯å¦æœ‰VIP å¯ä»¥çœ‹åˆ°ï¼ŒVIPæ­¤æ—¶å·²ç»æ²¡æœ‰äº† $ ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:f3:3c:78 brd ff:ff:ff:ff:ff:ff inet 10.0.0.10/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fef3:3c78/64 scope link valid_lft forever preferred_lft forever æŸ¥çœ‹lb02ä¸Šæ˜¯å¦æœ‰VIP å½“keepalived masterå®•æœºåï¼ŒVIPå°±ä¼šæ¼‚ç§»åˆ°lb02 $ ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:c1:0b:16 brd ff:ff:ff:ff:ff:ff inet 10.0.0.11/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet 10.0.0.100/32 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fec1:b16/64 scope link valid_lft forever preferred_lft forever é‡æ–°å¯åŠ¨lb01ä¸Šçš„keepalived systemctl start keepalived #æŸ¥çœ‹VIP $ ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:f3:3c:78 brd ff:ff:ff:ff:ff:ff inet 10.0.0.10/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet 10.0.0.100/32 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fef3:3c78/64 scope link valid_lft forever preferred_lft forever 2.1.7 ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ lb01å’Œlb02ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat > /etc/nginx/conf.d/kd.test.conf æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful $ nginx -s reload 2.2 åç«¯çœŸå®æœåŠ¡webé…ç½® web01æ“ä½œ 2.2.1 ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat >> /etc/nginx/conf.d/kd.test.conf 2.2.2 åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir /code && echo \"web01 web01 web01\" > /code/index.html 2.2.3 æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful $ nginx -s reload web02æ“ä½œ 2.2.4 ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat >> /etc/nginx/conf.d/kd.test.conf 2.2.5 åˆ›å»ºç½‘ç«™æ ¹ç›®å½• mkdir /code && echo \"web02 web02 web02\" > /code/index.html 2.2.6 æ£€æµ‹nginxè¯­æ³•å¹¶é‡è½½nginx $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful $ nginx -s reload 2.3 æµè§ˆå™¨éªŒè¯è´Ÿè½½å‡è¡¡æ˜¯å¦æ­£å¸¸å·¥ä½œ æµè§ˆå™¨è®¿é—®VIP 10.0.0.100 ä¸‰ã€nginxå®•æœºé—®é¢˜ å¦‚æœNginxå®•æœºï¼Œä¼šå¯¼è‡´ç”¨æˆ·è¯·æ±‚å¤±è´¥ï¼Œ ä½†Keepalivedå¹¶ä¸ä¼šè¿›è¡Œåˆ‡æ¢ï¼Œæ‰€ä»¥ç¼–å†™nginxæ£€æµ‹è„šæœ¬ï¼Œæ£€æµ‹nginxå­˜æ´»çŠ¶æ€ï¼Œä¸å­˜æ´»åˆ™killæ‰nginxå’Œkeepalivedï¼Œç„¶åVIPè¿›è¡Œæ¼‚ç§» 3.1 ç¼–è¾‘è„šæœ¬ lb01æ“ä½œ #åˆ›å»ºå­˜æ”¾è„šæœ¬çš„ç›®å½• mkdir -p /server/scripts #ç¼–è¾‘è„šæœ¬å†…å®¹ cat >> /server/scripts/check_web.sh 3.2 éªŒè¯è„šæœ¬æ˜¯å¦ç”Ÿæ•ˆ æ•…æ„æŠŠnginxé…ç½®æ–‡ä»¶ä¿®æ”¹é”™è¯¯(æ¯”å¦‚åˆ é™¤ä¸€ä¸ªæ‹¬å·æˆ–è€…åˆ†å·)ï¼Œç„¶ååœæ­¢lb01ä¸Šçš„nginxï¼Œå› ä¸ºä¸Šè¾¹çš„è„šæœ¬ä¸­ä¼šåˆ¤æ–­nginxå¦‚æœä¸å­˜æ´»å°±å¯åŠ¨nginxï¼ŒæŠŠnginxé…ç½®æ–‡ä»¶æ”¹é”™äº†nginxå°±æ— æ³•æ­£å¸¸å¯åŠ¨è¿‡äº† systemctl stop nginx åå°è„šæœ¬æ£€æµ‹åˆ°nginxä¸å­˜æ´»ä¼škillæ‰keepalivedï¼Œæ­¤æ—¶æµè§ˆå™¨è®¿é—®ä¼šæŠ¥é”™ï¼Œéš”å‡ ç§’å°±æ¢å¤äº†ï¼Œå› ä¸ºVIPå·²ç»æ¼‚ç§»è‡³lb02ä¸Š 3.3 åœ¨keepalivedä¸­è°ƒç”¨æ£€æµ‹è„šæœ¬ âš ï¸nohup sh /server/scripts/check_web.sh &æ‰§è¡Œè„šæœ¬å±äºæ‰‹åŠ¨æ‰§è¡Œï¼Œè¿˜å¯ä»¥åœ¨keepalivedé…ç½®æ–‡ä»¶ä¸­é…ç½®è°ƒç”¨ç›‘æ§è„šæœ¬ lb01ã€lb02éƒ½éœ€è¦æ“ä½œ ç¼–è¾‘keepalivedé…ç½®æ–‡ä»¶/etc/keepalived/keepalived.conf #åœ¨global_defsæ ‡ç­¾ä¸‹å¢åŠ å¦‚ä¸‹å†…å®¹ vrrp_script check_web { script \"/server/scripts/check_web.sh\" interval 10 weight 50 } #track_scriptæ ‡ç­¾è¦å†™åœ¨vrrp_instance VI_1{}ä¸­ track_script { check_web } âš ï¸âš ï¸âš ï¸vrrp_script{}ä¸­çš„intervalæ—¶é—´éœ€å¤§äºè„šæœ¬ä¸­çš„sleepæ—¶é—´ å¦åˆ™ä¼šæŠ¥é”™Keepalived_vrrp[2612]: /server/scripts/check_web.sh exited due to signal 15 è¿™æ ·å°±èƒ½å¤Ÿä½¿keepalivedè‡ªåŠ¨è°ƒç”¨ç›‘æ§è„šæœ¬äº†ï¼Œkeepalivedä¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­vrrp_script {}ä¸­çš„intervalå‚æ•°æ¥å†³å®šæ¯éš”å‡ ç§’æ‰§è¡Œè„šæœ¬ï¼Œintervalåé¢çš„æ•°å­—å°±è¡¨æ˜æ‰§è¡Œè„šæœ¬çš„é—´éš”æ—¶é—´ åœ¨è„šæœ¬ä¸­æˆ‘ä»¬å®šä¹‰äº†ï¼Œkeepalived masterä¸Šæ£€æµ‹nginxæ˜¯å¦å­˜æ´»ï¼Œä¸å­˜æ´»å°è¯•å¯åŠ¨nginxï¼Œå½“æ— æ³•æˆåŠŸå¯åŠ¨nginxçš„æ—¶å€™åœæ­¢masterä¸Šçš„keepalivedï¼Œç„¶åè®©VIPæ¼‚ç§»ï¼Œè¿™æ ·çš„è¯å°±å®ç°äº†å½“nginxæœåŠ¡æŒ‚æ‰æ—¶keepalived VIPèƒ½å¤Ÿæ¼‚ç§»ä»è€Œä¸å½±å“å®¢æˆ·ç«¯è®¿é—® å››ã€keepalivedé«˜å¯ç”¨è„‘è£‚ æ¦‚å¿µ è„‘è£‚å°±æ˜¯ç”±äºæŸäº›åŸå› ï¼Œå¯¼è‡´ä¸¤å°keepalivedé«˜å¯ç”¨æœåŠ¡å™¨åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œæ— æ³•æ£€æµ‹åˆ°å¯¹æ–¹çš„å¿ƒè·³æ¶ˆæ¯ï¼Œå„è‡ªå–å¾—èµ„æºåŠæœåŠ¡çš„æ‰€æœ‰æƒï¼Œè€Œæ­¤æ—¶çš„ä¸¤å°é«˜å¯ç”¨æœåŠ¡å™¨åˆéƒ½è¿˜æ´»ç€ï¼Œäº§ç”Ÿè£‚è„‘çš„æƒ…å†µä¸‹ï¼Œmasterå’Œbackupä¸Šéƒ½ä¼šæœ‰VIP äº§ç”Ÿè„‘è£‚çš„åŸå›  1.æœåŠ¡å™¨ç½‘ç»œæ•…éšœ 2.æœåŠ¡å™¨ç¡¬ä»¶æ•…éšœå‘ç”ŸæŸåç°è±¡è€Œå´©æºƒ 3.ä¸»å¤‡éƒ½å¼€å¯firewalldé˜²ç«å¢™ 4.1 æ¨¡æ‹Ÿè„‘è£‚ lb01å’Œlb02å¼€å¯firewalldé˜²ç«å¢™ systemctl start firewalld å¼€å¯é˜²ç«å¢™åäº§ç”Ÿè£‚è„‘åŸå›  lb01å’Œlb02éƒ½å¼€å¯é˜²ç«å¢™åï¼Œå› ä¸ºæ²¡æœ‰å…è®¸vrrpï¼Œå½“backupå»æ£€æµ‹masterçš„æ—¶å€™æ— æ³•æ£€æµ‹åˆ°ï¼Œæ­¤æ—¶backupè®¤ä¸ºmasterå·²ç»å®•æœºï¼Œæ‰€ä»¥å°†VIPæŠ¢å ï¼›è€Œmasterå®é™…ä¸Šå¹¶æ²¡æœ‰å®•æœºï¼Œæ‰€ä»¥VIPä¸ä¼šæ¼‚ç§»ï¼Œè¿™æ ·å°±é€ æˆäº†masterå’Œbackupéƒ½åœ¨æŠ¢å VIPã€‚æ­¤æ—¶å°±å‡ºç°äº†è£‚è„‘çš„æƒ…å†µ 4.2 æµ‹è¯•è„‘è£‚é—®é¢˜ åœ¨keepalivedå¤‡ä¸Šç¼–å†™æ£€æµ‹è„šæœ¬, æµ‹è¯•å¦‚æœèƒ½pingé€šä¸»keepalivedå¹¶ä¸”å¤‡èŠ‚ç‚¹è¿˜æœ‰VIPçš„è¯åˆ™è®¤ä¸ºäº§ç”Ÿäº†è„‘è£‚ lb02æ“ä½œ #åˆ›å»ºå­˜æ”¾è„šæœ¬çš„ç›®å½• mkdir -p /server/scripts #ç¼–è¾‘è„šæœ¬å†…å®¹ cat >/server/scripts/check_split_brain.sh /dev/null if [ $? -eq 0 -a `ip add|grep \"$lb01_vip\"|wc -l` -eq 1 ];then echo \"keepalivedå‡ºç°äº†è„‘è£‚ï¼ï¼ï¼\" else echo \"keepalivedå®Œå…¨objk\" fi sleep 5 done EOF è¿è¡Œè„šæœ¬ï¼Œå› ä¸ºæ­¤æ—¶æ˜¯è„‘è£‚çš„ï¼Œkeepalivedä¸»å¤‡ä¸Šéƒ½æœ‰VIPï¼Œå› ä¸ºå‰æœŸä¼šæŠ¥å‡ºç°è„‘è£‚ï¼Œå½“æŠŠä¸»å¤‡ä¸Šçš„firewalldå…³æ‰æ—¶å°±æ²¡æœ‰é—®é¢˜äº† #è„šæœ¬ä¼šä¸€ç›´è¿è¡Œï¼Œctrl+cåœæ­¢ $ sh /server/scripts/check_split_brain.sh keepalivedå‡ºç°äº†è„‘è£‚ï¼ï¼ï¼ keepalivedå‡ºç°äº†è„‘è£‚ï¼ï¼ï¼ keepalivedå‡ºç°äº†è„‘è£‚ï¼ï¼ï¼ keepalivedå‡ºç°äº†è„‘è£‚ï¼ï¼ï¼ keepalivedå‡ºç°äº†è„‘è£‚ï¼ï¼ï¼ keepalivedå‡ºç°äº†è„‘è£‚ï¼ï¼ï¼ keepalivedå‡ºç°äº†è„‘è£‚ï¼ï¼ï¼ keepalivedå®Œå…¨objk keepalivedå®Œå…¨objk äº”ã€æºç å®‰è£…keepalived keepalivedæºç åŒ…å®˜æ–¹ä¸‹è½½åœ°å€ 5.1 ä¸‹è½½åŒ… wget https://www.keepalived.org/software/keepalived-2.1.2.tar.gz 5.2 ç¼–è¯‘å®‰è£… å®‰è£…ä¾èµ–åŒ… yum -y install openssl openssl-devel libnl3-devel pcre-devel è§£å‹ç¼©åŒ… tar xf keepalived-2.1.2.tar.gz && cd keepalived-2.1.2 ç¼–è¯‘å®‰è£… ./configure --prefix=/usr/local/keepalived make && make install 5.3 é…ç½®keepalived 5.3.1 è½¯è¿æ¥keepalivedå‘½ä»¤ ln -s /usr/local/keepalived/sbin/keepalived /usr/sbin éªŒè¯ $ keepalived -v Keepalived v2.1.2 (06/14,2020) Copyright(C) 2001-2020 Alexandre Cassen, Built with kernel headers for Linux 3.10.0 Running on Linux 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020 configure options: --prefix=/etc/keepalived --sysconfdir=/etc/keepalived Config options: LVS VRRP VRRP_AUTH OLD_CHKSUM_COMPAT FIB_ROUTING System options: PIPE2 SIGNALFD INOTIFY_INIT1 VSYSLOG EPOLL_CREATE1 IPV6_ADVANCED_API RTA_ENCAP RTA_EXPIRES RTA_PREF FRA_SUPPRESS_PREFIXLEN FRA_TUN_ID RTAX_CC_ALGO RTAX_QUICKACK RTA_VIA FRA_OIFNAME IFA_FLAGS IP_MULTICAST_ALL NET_LINUX_IF_H_COLLISION LIBIPTC_LINUX_NET_IF_H_COLLISION VRRP_VMAC IFLA_LINK_NETNSID CN_PROC SOCK_NONBLOCK SOCK_CLOEXEC O_PATH GLOB_BRACE INET6_ADDR_GEN_MODE SO_MARK SCHED_RESET_ON_FORK 5.3.2 keepalived.serviceæ–‡ä»¶ âš ï¸keepalivedç¼–è¯‘å®‰è£…å®Œæˆåä¼šè‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶/usr/lib/systemd/system/keepalived.service 5.3.3 æ‹·è´å®‰è£…ç›®å½•ä¸‹keepalivedé…ç½®æ–‡ä»¶ å¦åˆ™ä¼šæŠ¥é”™Unable to find configuration file /etc/keepalived/keepalived.conf (glob returned 3) mkdir /etc/keepalived cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/ 5.3.4 æ‹·è´å¯åŠ¨æ–‡ä»¶(å¯é€‰) cp /root/keepalived-2.1.2/keepalived/etc/init.d/keepalived /etc/init.d 5.3.5 å¯åŠ¨keepalivedå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl daemon-reload && systemctl enable keepalived && systemctl start keepalived æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/ssh/1.sshæœåŠ¡.html":{"url":"linux/linuxæœåŠ¡/ssh/1.sshæœåŠ¡.html","title":"ç¦æ­¢rootè¿œç¨‹ç™»é™†","keywords":"","body":"ä¸€ã€sshç¦æ­¢rootè¿œç¨‹ç™»é™† 1.ç¼–è¾‘æ–‡ä»¶/etc/ssh/sshd_config #ç¦æ­¢rootè¿œç¨‹ç™»é™† PermitRootLogin no #ç¦ç”¨å¯†ç éªŒè¯ PasswordAuthentication no #å¯ç”¨å¯†é’¥éªŒè¯ RSAAuthentication yes //centos7æ²¡æœ‰è¿™ä¸€é¡¹ PubkeyAuthentication yes 2.sudoå…å¯†é…ç½®ç­‰rootæƒé™ç”¨æˆ· visudoæˆ–è€…ç¼–è¾‘æ–‡ä»¶/etc/sudoers //åˆ›å»ºä¸€ä¸ªç”¨æˆ· useradd lcc //visudoç¼–è¾‘,101è¡Œå†™å…¥ä»¥ä¸‹å†…å®¹ lcc ALL=NOPASSWD :ALL 3.é…ç½®sshå¯†é’¥ //åˆ‡æ¢åˆ°lccç”¨æˆ· su - lcc //ç”Ÿæˆå¯†é’¥ $ ssh-keygen Generating public/private rsa key pair. Enter file in which to save the key (/home/lcc/.ssh/id_rsa): Created directory '/home/lcc/.ssh'. Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /home/lcc/.ssh/id_rsa. Your public key has been saved in /home/lcc/.ssh/id_rsa.pub. The key fingerprint is: SHA256:nSW5jEvQwr8zPZok5CfK+fnrhPJfk2motWOgx1/eNZ4 lcc@experiment The key's randomart image is: +---[RSA 2048]----+ | | | . . . | | + . o . | | + + = | | . S = | | o.o = o | | .o=.@ X o | | ..=oXo@ + o o | | +o=*Xo. . E | +----[SHA256]-----+ //å‘authorized_keysæ–‡ä»¶å†™å…¥å…¬é’¥ cd .ssh && cat id_rsa.pub >authorized_keys //ä¿®æ”¹authorized_keysæ–‡ä»¶æƒé™è‡³å°‘ä¸º644ï¼Œé»˜è®¤ä¸º664ï¼Œæ— æ³•ä½¿ç”¨å¯†é’¥ç™»é™† chmod 644 authorized_keys âš ï¸sshæœåŠ¡é…ç½®æ–‡ä»¶/etc/ssh/sshd_configä¸­æœ‰ä¸€é¡¹é…ç½®æ˜¯AuthorizedKeysFile .ssh/authorized_keysï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ç§é’¥å…å¯†ç™»é™†ï¼Œåˆ™å…¬é’¥å¿…é¡»å†™å…¥åˆ°æ–‡ä»¶.ssh/authorized_keysä¸­ï¼Œå³æ³¨å†Œç§é’¥ï¼Œå¦åˆ™å…å¯†ä¼šå¤±è´¥ï¼ï¼ï¼ 4.é…ç½®å®ŒåéªŒè¯ //rootæ— æ³•è¿œç¨‹ç™»é™† baixuebingdeMacBook-Pro:~ baixuebing$ ssh root@10.0.0.13 root@10.0.0.13: Permission denied (publickey,gssapi-keyex,gssapi-with-mic). //æ— æ³•ä½¿ç”¨å¯†ç ç™»é™†ï¼Œåªèƒ½ä½¿ç”¨å¯†é’¥ç™»é™† baixuebingdeMacBook-Pro:~ baixuebing$ ssh lcc@10.0.0.13 lcc@10.0.0.13: Permission denied (publickey,gssapi-keyex,gssapi-with-mic). äºŒã€sshå…äº¤äº’é…ç½® ssh-keygenå…äº¤äº’ç”Ÿæˆå¯†é’¥ #å…äº¤äº’ç”Ÿæˆå¯†é’¥ ssh-keygen -t rsa -f /root/.ssh/id_dsa -P \"\" -q -f filename #æŒ‡å®šå¯†é’¥æ–‡ä»¶çš„æ–‡ä»¶å -P passphrase #æä¾›æ—§å¯†é’¥å£ä»¤ -q Silence ssh-keygen #é™é»˜è¾“å‡º -t key type #å¯†é’¥ç±»å‹ dsa ecdsa ed25519 rsa(é»˜è®¤) rsa1 âš ï¸sshæœåŠ¡é…ç½®æ–‡ä»¶/etc/ssh/sshd_configä¸­æœ‰ä¸€é¡¹é…ç½®æ˜¯AuthorizedKeysFile .ssh/authorized_keysï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ç§é’¥å…å¯†ç™»é™†ï¼Œåˆ™å…¬é’¥å¿…é¡»å†™å…¥åˆ°æ–‡ä»¶.ssh/authorized_keysä¸­ï¼Œå³æ³¨å†Œç§é’¥ï¼Œå¦åˆ™å…å¯†ä¼šå¤±è´¥ï¼ï¼ï¼ ssh-copyå…äº¤äº’æ¨é€å¯†é’¥ sshpass -p1 ssh-copy-id -i ~/.ssh/id_rsa.pub -o StrictHostKeyChecking=no root@IP æ‰¹é‡åˆ†å‘å¯†é’¥è„šæœ¬ #!/bin/bash #ç”Ÿæˆå¯†é’¥ \\rm -f /root/.ssh/id_* ssh-keygen -t rsa -f /root/.ssh/id_rsa -P \"\" -q #åˆ†å‘å¯†é’¥ for ip in IP do echo \"=== åˆ†å‘ä¸»æœº 10.0.0.$ip ===\" sshpass -p1 ssh-copy-id -i ~/.ssh/id_rsa.pub -o StrictHostKeyChecking=no root@10.0.0.$ip echo \"=== åˆ†å‘ojbk ===\" echo \"\" done ä¸‰ã€sshè‡ªåŠ¨æ–­å¼€è¿œç¨‹æœåŠ¡å™¨é—®é¢˜ ç¼–è¾‘sshæœåŠ¡é…ç½®æ–‡ä»¶/etc/ssh/sshd_configä¿®æ”¹ä»¥ä¸‹ä¸¤é¡¹ #å‘å®¢æˆ·ç«¯æ¯30ç§’å‘ä¸€æ¬¡ä¿æŒè¿æ¥çš„ä¿¡å· ClientAliveInterval 30 #å¦‚æœå®¢æˆ·ç«¯30æ¬¡æœªå“åº”å°±æ–­å¼€è¿æ¥ ClientAliveCountMax 30 é‡å¯æœåŠ¡ systemctl restart sshd æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/ssh/sshå¯†é’¥.html":{"url":"linux/linuxæœåŠ¡/ssh/sshå¯†é’¥.html","title":"sshå¯†é’¥","keywords":"","body":"ä½¿ç”¨ ssh-keygen å‘½ä»¤ç”Ÿæˆå¯†é’¥ ssh-keygen -t rsa -P '' -q -f ~/.ssh/id_rsa å‚æ•°è¯´æ˜ -t å¯†é’¥ç±»å‹ï¼Œå¯ä»¥é€‰æ‹© dsa | ecdsa | ed25519 | rsa; çœç•¥çš„æƒ…å†µä¸‹é»˜è®¤æ˜¯rsa -f å¯†é’¥ç›®å½•ä½ç½®ï¼ŒæŒ‡å®šç”Ÿæˆå¯†é’¥çš„ä¿å­˜è·¯å¾„å’Œæ–‡ä»¶åã€‚çœç•¥çš„æƒ…å†µä¸‹ï¼Œ é»˜è®¤ä¸ºå½“å‰ç”¨æˆ· home è·¯å¾„ä¸‹çš„ .ssh éšè—ç›®å½•, ä¹Ÿå°±æ˜¯ ~/.ssh/ ï¼Œ åŒæ—¶é»˜è®¤å¯†é’¥æ–‡ä»¶åä»¥ id_rsa å¼€å¤´. ã€€ã€€ -fçœç•¥çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ç›®å½•å°±æ˜¯ ~/.ssh/ï¼Œä¸ä¼šå†æ¬¡æé†’è¾“å…¥ã€‚ä½†æ˜¯ä¼šå†æ¬¡ææ˜¯ä½ è¾“å…¥æ–‡ä»¶åï¼Œå¦‚æœä¸è¾“å…¥ç›´æ¥å›è½¦ï¼Œåˆ™é»˜è®¤çš„å¯†é’¥æ–‡ä»¶åå°±æ˜¯ id_rsa -N -N: æŒ‡å®šæ­¤å¯†é’¥å¯¹çš„å¯†ç ï¼Œå¦‚æœæŒ‡å®šæ­¤å‚æ•°ï¼Œåˆ™å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­å°±ä¸ä¼šå‡ºç°äº¤äº’ç¡®è®¤å¯†ç çš„ä¿¡æ¯äº†ï¼Œå¦‚æœçœç•¥æ­¤å‚æ•°ï¼Œä¼šæç¤ºä½ è¾“å…¥å¯†ç å’Œå¯†ç ç¡®è®¤ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸ç”¨è¾“å…¥ï¼Œç›´æ¥å›è½¦å°±è¡Œã€‚ ã€€ã€€ å¦‚æœè¾“å…¥å¯†ç ä¹‹åï¼Œä»¥åæ¯æ¬¡éƒ½è¦è¾“å…¥å¯†ç ã€‚è¿™é‡Œè¯·æ ¹æ®ä½ çš„å®‰å…¨éœ€è¦å†³å®šæ˜¯å¦éœ€è¦å¯†ç ï¼Œå¦‚æœä¸éœ€è¦ï¼Œç›´æ¥å›è½¦ã€‚ -P -P(å¤§å†™)ï¼š æä¾›æ—§å¯†ç  -p -p(å°å†™)ï¼šè¦æ±‚æ”¹å˜æŸç§é’¥æ–‡ä»¶çš„å¯†ç è€Œä¸é‡å»ºç§é’¥ã€‚ç¨‹åºå°†æç¤ºè¾“å…¥ç§é’¥æ–‡ä»¶åã€åŸæ¥çš„å¯†ç ã€ä»¥åŠä¸¤æ¬¡è¾“å…¥æ–°å¯†ç  -C æŒ‡å®šæ­¤å¯†é’¥çš„å¤‡æ³¨ä¿¡æ¯ï¼Œéœ€è¦é…ç½®å¤šä¸ªå…å¯†ç™»å½•æ—¶ï¼Œå»ºè®®æºå¸¦ï¼›ç”Ÿæˆçš„å…¬é’¥ä¼šåœ¨æœ€åé¢æ˜¾ç¤ºæ­¤å¤‡æ³¨ä¿¡æ¯ -q é™é»˜æ¨¡å¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/nfs/centos7.7æ­å»ºNFS.html":{"url":"linux/linuxæœåŠ¡/nfs/centos7.7æ­å»ºNFS.html","title":"nfs","keywords":"","body":"centos7.7æ­å»ºNFS ä¸€ã€NFSåŸºæœ¬æ¦‚è¿° åŸºæœ¬æ¦‚å¿µ NFSæ˜¯Network File Systemçš„ç¼©å†™åŠç½‘ç»œæ–‡ä»¶ç³»ç»Ÿã€‚ ä¸»è¦åŠŸèƒ½ é€šè¿‡å±€åŸŸç½‘ç»œè®©ä¸åŒçš„ä¸»æœºç³»ç»Ÿä¹‹é—´å¯ä»¥å…±äº«æ–‡ä»¶æˆ–ç›®å½•ã€‚ ç”¨å¤„ NFSç³»ç»Ÿå’ŒWindowsç½‘ç»œå…±äº«ã€ç½‘ç»œé©±åŠ¨å™¨ç±»ä¼¼, åªä¸è¿‡windowsç”¨äºå±€åŸŸç½‘, NFSç”¨äºä¼ä¸šé›†ç¾¤æ¶æ„ä¸­, å¦‚æœæ˜¯å¤§å‹ç½‘ç«™, ä¼šç”¨åˆ°æ›´å¤æ‚çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ å°æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼š(Moosefs,FastDFS) å¤§æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼š(glusterfs,HDFS) ä¸ºä»€ä¹ˆè¦ç”¨NFSæœåŠ¡è¿›è¡Œæ•°æ®å­˜å‚¨ 1.å®ç°æ•°æ®ä¿¡æ¯å…±äº« 2.å®ç°æ•°æ®ä¿¡æ¯ä¸€è‡´ äºŒã€NFSå®ç°åŸç† ç›¸å…³è¿›ç¨‹ rpc.nfsd åŸºæœ¬çš„nfså®ˆæŠ¤è¿›ç¨‹ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ç®¡ç†å®¢æˆ·ç«¯æ˜¯å¦èƒ½å¤Ÿç™»é™†æœåŠ¡å™¨ rpc.mount ç®¡ç†nfsçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå½“å®¢æˆ·ç«¯é¡ºåˆ©é€šè¿‡nfsdç™»é™†nfsæœåŠ¡å™¨åï¼Œåœ¨ä½¿ç”¨nfs æœåŠ¡æ‰€æä¾›çš„æ–‡ä»¶å‰ï¼Œè¿˜å¿…é¡»é€šè¿‡æ–‡ä»¶ä½¿ç”¨æƒé™çš„éªŒè¯ï¼Œå®ƒä¼šè¯»å–nfsçš„é…ç½®æ–‡ä»¶/etc/exportsæ¥å¯¹æ¯”å®¢æˆ·ç«¯æƒé™ portmap è¿›è¡Œç«¯å£æ˜ å°„ æœ¬åœ°æ–‡ä»¶æ“ä½œæ–¹å¼ å½“ç”¨æˆ·è¿›ç¨‹å‘èµ·æœ¬åœ°æ–‡ä»¶è®¿é—®æˆ–ä¿®æ”¹ï¼Œè¯¥ç”¨æˆ·è¯·æ±‚ä¼ é€’è‡³å†…æ ¸ï¼Œç”±å†…æ ¸é©±åŠ¨ç¡¬ä»¶å®Œæˆæ“ä½œ NFSè®¿é—®æ–¹å¼ 1.ç”¨æˆ·è¿›ç¨‹è®¿é—®NFSå®¢æˆ·ç«¯ï¼Œä½¿ç”¨ä¸åŒçš„å‡½æ•°å¯¹æ•°æ®è¿›è¡Œå¤„ç† 2.è¯·æ±‚ä¼šé€šè¿‡TCP/IPçš„æ–¹å¼ä¼ é€’ç»™NFSæœåŠ¡ç«¯ 3.NFSæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šè°ƒç”¨portmapè¿›ç¨‹è¿›è¡Œç«¯å£æ˜ å°„ 4.nfsdè¿›ç¨‹ç”¨äºåˆ¤æ–­NFSå®¢æˆ·ç«¯æ˜¯å¦æ‹¥æœ‰æƒé™è¿æ¥NFSæœåŠ¡ç«¯ 5.Rpc.mountç”¨äºåˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦æœ‰å¯¹åº”çš„æƒé™è¿›è¡ŒéªŒè¯ 6.idmapè¿›ç¨‹å®ç°ç”¨æˆ·æ˜ å°„å’Œå‹ç¼© 7.æœ€åNFSæœåŠ¡ç«¯ä¼šå°†å¯¹åº”è¯·æ±‚çš„å‡½æ•°è½¬æ¢ä¸ºæœ¬åœ°èƒ½è¯†åˆ«çš„å‘½ä»¤ï¼Œä¼ é€’è‡³å†…æ ¸ï¼Œç”±å†…æ ¸é©±åŠ¨ç¡¬ä»¶ ä¸‰ã€NFSæœåŠ¡æ­å»ºè¿‡ç¨‹ å®éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå nfsæœåŠ¡ç«¯ 10.0.0.10 nfs-server nfså®¢æˆ·ç«¯ 10.0.0.11 nfs-client nfsæœåŠ¡ç«¯æ“ä½œ 1.å®‰è£…nfs-utils yum -y install nfs-utils 2.ç¼–è¾‘nfsé…ç½®æ–‡ä»¶/etc/exportsï¼Œæ–‡ä»¶é»˜è®¤æ²¡æœ‰å†…å®¹ nfsé…ç½®æ–‡ä»¶æ ¼å¼ NFSå…±äº«ç›®å½• NFSå®¢æˆ·ç«¯åœ°å€1(å‚æ•°1,å‚æ•°2,...) å®¢æˆ·ç«¯åœ°å€2(å‚æ•°1,å‚æ•°2,...) NFSå…±äº«ç›®å½• NFSå®¢æˆ·ç«¯åœ°å€(å‚æ•°1,å‚æ•°2,...) æ‰§è¡Œman exportså‘½ä»¤å¯ä»¥æŸ¥çœ‹å¸®åŠ©ï¼Œå¦‚ä¸‹ä¸ºnfså‚æ•° nfså…±äº«å‚æ•° å‚æ•°ä½œç”¨ rw è¯»å†™æƒé™ ro åªè¯»æƒé™ root_squash å½“NFSå®¢æˆ·ç«¯ä»¥rootç®¡ç†å‘˜è®¿é—®æ—¶ï¼Œæ˜ å°„ä¸ºNFSæœåŠ¡å™¨çš„åŒ¿åç”¨æˆ· no_root_squash å½“NFSå®¢æˆ·ç«¯ä»¥rootç®¡ç†å‘˜è®¿é—®æ—¶ï¼Œæ˜ å°„ä¸ºNFSæœåŠ¡å™¨çš„rootç®¡ç†å‘˜ all_squash æ— è®ºNFSå®¢æˆ·ç«¯ä½¿ç”¨ä»€ä¹ˆè´¦æˆ·è®¿é—®ï¼Œå‡æ˜ å°„ä¸ºNFSæœåŠ¡å™¨çš„åŒ¿åç”¨æˆ· no_all_squash æ— è®ºNFSå®¢æˆ·ç«¯ä½¿ç”¨ä»€ä¹ˆè´¦æˆ·è®¿é—®ï¼Œéƒ½ä¸è¿›è¡Œå‹ç¼© sync åŒæ—¶å°†æ•°æ®å†™å…¥åˆ°å†…å­˜ä¸ç¡¬ç›˜ä¸­ï¼Œä¿è¯ä¸ä¸¢å¤±æ•°æ® async ä¼˜å…ˆå°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ï¼Œç„¶åå†å†™å…¥ç¡¬ç›˜ï¼›è¿™æ ·æ•ˆç‡æ›´é«˜ï¼Œä½†å¯èƒ½ä¼šä¸¢å¤±æ•°æ® anonuid é…ç½®all_squashä½¿ç”¨,æŒ‡å®šNFSçš„ç”¨æˆ·UID,å¿…é¡»å­˜åœ¨ç³»ç»Ÿ anongid é…ç½®all_squashä½¿ç”¨,æŒ‡å®šNFSçš„ç”¨æˆ·UID,å¿…é¡»å­˜åœ¨ç³»ç»Ÿ ç¼–è¾‘nfsé…ç½®æ–‡ä»¶ cat >/etc/exports 3.åˆ›å»ºå…±äº«ç›®å½•å¹¶ä¿®æ”¹ç›®å½•æ‰€æœ‰è€…ä¸ºnfsnobody mkdir /data chown -R nfsnobody.nfsnobody /data 4.å¯åŠ¨nfså¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl start rpcbind nfs-server && systemctl enable rpcbind nfs-server 5.éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ $ exportfs /data 10.0.0.0/24 6.æ£€æŸ¥nfså…±äº«è®°å½• nfså¯åŠ¨åä¼šåœ¨/var/lib/nfs/etabæ–‡ä»¶ä¸­è®°å½•å…±äº«å†…å®¹ $ cat /var/lib/nfs/etab /data 10.0.0.0/24(rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid=65534,anongid=65534,sec=sys,rw,secure,root_squash,all_squash) nfså®¢æˆ·ç«¯æ“ä½œ 1.å®‰è£…nfs-utils yum -y install nfs-utils 2.å¯åŠ¨rpcbindå¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl start rpcbind && systemctl enable rpcbind 3.åˆ›å»ºæŒ‚è½½ç‚¹å¹¶ä¿®æ”¹æŒ‚è½½ç‚¹æ‰€æœ‰è€…ä¸ºnfsnobody mkdir /data && chown -R nfsnobody.nfsnobody /data 4.æŸ¥è¯¢nfsæœåŠ¡ç«¯å…±äº«ä¿¡æ¯ $ showmount -e 10.0.0.10 Export list for 10.0.0.10: /data 10.0.0.0/24 showmountå‘½ä»¤ å‚æ•° ä½œç”¨ -e æ˜¾ç¤ºNFSæœåŠ¡å™¨çš„å…±äº«åˆ—è¡¨ -a æ˜¾ç¤ºæœ¬æœºæŒ‚è½½çš„æ–‡ä»¶èµ„æºçš„æƒ…å†µNFSèµ„æºçš„æƒ…å†µ -v æ˜¾ç¤ºç‰ˆæœ¬å· 5.å®¢æˆ·ç«¯æŒ‚è½½nfs mount -t æ–‡ä»¶ç³»ç»Ÿ æœåŠ¡å™¨IP:å…±äº«ç›®å½• æŒ‚è½½ç‚¹ mount -t nfs 10.0.0.10:/data /data âš ï¸åœ¨ä¼ä¸šå·¥ä½œåœºæ™¯ï¼Œé€šå¸¸æƒ…å†µNFSæœåŠ¡å™¨å…±äº«çš„åªæ˜¯æ™®é€šé™æ€æ•°æ®ï¼ˆå›¾ç‰‡ã€é™„ä»¶ã€è§†é¢‘ï¼‰ï¼Œä¸éœ€è¦æ‰§è¡Œsuidã€execç­‰æƒé™ï¼ŒæŒ‚è½½çš„è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿåªèƒ½ä½œä¸ºæ•°æ®å­˜å–ä¹‹ç”¨ï¼Œæ— æ³•æ‰§è¡Œç¨‹åºï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è®²å¢åŠ äº†å®‰å…¨æ€§ã€‚ä¾‹å¦‚: å¾ˆå¤šæœ¨é©¬ç¯¡æ”¹ç«™ç‚¹æ–‡ä»¶éƒ½æ˜¯ç”±ä¸Šä¼ å…¥å£ä¸Šä¼ çš„ç¨‹åºåˆ°å­˜å‚¨ç›®å½•ç„¶åæ‰§è¡Œçš„ é€šè¿‡mount -oæŒ‡å®šæŒ‚è½½å‚æ•°ï¼Œç¦æ­¢ä½¿ç”¨suidã€execï¼Œå¢åŠ å®‰å…¨æ€§èƒ½ mount -t nfs -o nosuid,noexec,nodev 10.0.0.10:/data /mnt 6.æŸ¥çœ‹æŒ‚è½½ä¿¡æ¯ df -h 10.0.0.10:/data 17G 4.4G 13G 26% /data 7.è®¾ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½ cat >> /etc/fstab 8.å¦‚æœä¸éœ€è¦ä½¿ç”¨nfså…±äº«ï¼Œå¯ä»¥å¸è½½ umount /data æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/åŒæ­¥æœåŠ¡/centos7.7æ­å»ºrsync.html":{"url":"linux/linuxæœåŠ¡/åŒæ­¥æœåŠ¡/centos7.7æ­å»ºrsync.html","title":"rsync","keywords":"","body":"centos7.7æ­å»ºrsync rsyncåŸºæœ¬æ¦‚è¿° rsyncæ˜¯ä¸€æ¬¾å¼€æºçš„å¤‡ä»½å·¥å…·ï¼Œå¯ä»¥åœ¨ä¸åŒä¸»æœºä¹‹é—´è¿›è¡ŒåŒæ­¥ï¼Œå¯å®ç°å…¨é‡å¤‡ä»½ä¸å¢é‡å¤‡ä»½ï¼Œä¿æŒé“¾æ¥å’Œæƒé™ï¼Œä¸”é‡‡ç”¨ä¼˜åŒ–çš„åŒæ­¥ç®—æ³•ï¼Œä¼ è¾“å‰æ‰§è¡Œå‹ç¼©ï¼Œå› æ­¤éå¸¸é€‚åˆç”¨äºæ¶æ„é›†ä¸­å¼å¤‡ä»½æˆ–å¼‚åœ°å¤‡ä»½ç­‰åº”ç”¨ã€‚ rsyncå®˜ç½‘ rsyncç›‘å¬ç«¯å£ï¼štcp/873 rsyncè¿è¡Œæ¨¡å¼ï¼šC/S rsyncå¤‡ä»½æ–¹å¼ 1.å®Œå…¨å¤‡ä»½(æ•ˆç‡ä½ã€å ç”¨ç©ºé—´) 2.å¢é‡å¤‡ä»½(æé«˜å¤‡ä»½æ•ˆç‡,èŠ‚çœç©ºé—´, é€‚åˆå¼‚åœ°å¤‡ä»½) 3.å·®å¼‚å¤‡ä»½ rsyncå…³äºæ•°æ®åŒæ­¥çš„ä¸¤ç§æ–¹å¼ æ¨ï¼šä¸€å°ä¸»æœºè´Ÿè´£æŠŠæ•°æ®æ¨é€è‡³å…¶ä»–ä¸»æœºï¼ŒæœåŠ¡å™¨å¼€é”€å¤§(é€‚åˆæ¨é€å°‘é‡ä¸»æœº) æ‹‰ï¼šæ‰€æœ‰ä¸»æœºå®šæ—¶å»æ‰¾ä¸€ä¸»æœºæ‹‰æ•°æ®ã€‚å¯èƒ½ä¼šå¯¼è‡´æ•°æ®åŒæ­¥ç¼“æ…¢ rsyncä¼ è¾“æ¨¡å¼ æœ¬åœ°æ–¹å¼ è¿œç¨‹æ–¹å¼ å®ˆæŠ¤è¿›ç¨‹æ–¹å¼ rsyncå‘½ä»¤é€‰é¡¹ -a å½’æ¡£æ¨¡å¼ä¼ è¾“, ç­‰äº-tropgDl -v è¯¦ç»†æ¨¡å¼è¾“å‡º, æ‰“å°é€Ÿç‡, æ–‡ä»¶æ•°é‡ç­‰ -z ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©ä»¥æé«˜æ•ˆç‡ -r é€’å½’ä¼ è¾“ç›®å½•åŠå­ç›®å½•ï¼Œå³ç›®å½•ä¸‹çš„æ‰€æœ‰ç›®å½•éƒ½åŒæ ·ä¼ è¾“ -t ä¿æŒæ–‡ä»¶æ—¶é—´ä¿¡æ¯ -o ä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯ -p ä¿æŒæ–‡ä»¶æƒé™ -g ä¿æŒæ–‡ä»¶å±ç»„ä¿¡æ¯ -l ä¿ç•™è½¯è¿æ¥ -P æ˜¾ç¤ºåŒæ­¥çš„è¿‡ç¨‹åŠä¼ è¾“æ—¶çš„è¿›åº¦ç­‰ä¿¡æ¯ -D ä¿æŒè®¾å¤‡æ–‡ä»¶ä¿¡æ¯ -L ä¿ç•™è½¯è¿æ¥æŒ‡å‘çš„ç›®æ ‡æ–‡ä»¶ -e ä½¿ç”¨çš„ä¿¡é“åè®®,æŒ‡å®šæ›¿ä»£rshçš„shellç¨‹åº --exclude=PATTERN æŒ‡å®šæ’é™¤ä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼ --exclude-from=file æ–‡ä»¶åæ‰€åœ¨çš„ç›®å½•æ–‡ä»¶ --bwlimit=100 é™é€Ÿä¼ è¾“ --partial æ–­ç‚¹ç»­ä¼  --delete è®©ç›®æ ‡ç›®å½•å’Œæºç›®å½•æ•°æ®ä¿æŒä¸€è‡´ rsyncä¼ è¾“ç¤ºä¾‹ æœ¬åœ°ä¼ è¾“ rsync é€‰é¡¹ æºæ–‡ä»¶æˆ–ç›®å½• ç›®æ ‡è·¯å¾„ ä¾‹ï¼šå°†/etc/passwdæ–‡ä»¶åŒæ­¥åˆ°/opt rsync -avz /etc/passwd /opt è¿œç¨‹ä¼ è¾“ ```python æ¨ä¼ è¾“ rsync é€‰é¡¹ æºæ–‡ä»¶æˆ–ç›®å½• è¿œç¨‹ä¸»æœºç›®æ ‡è·¯å¾„ ä¾‹ï¼šå°†æœ¬æœº/etc/passwdåŒæ­¥åˆ°å¦ä¸€å°ä¸»æœºçš„/opt rsync -zav /etc/passwd root@10.0.0.10:/opt æ‹‰ä¼ è¾“ rsync é€‰é¡¹ è¿œç¨‹ä¸»æœºæºæ–‡ä»¶æˆ–ç›®å½• æœ¬åœ°è·¯å¾„ ä¾‹ï¼šå°†è¿œç¨‹ä¸»æœºçš„/etc/passwdåŒæ­¥åˆ°æœ¬åœ°/opt rsync -avz root@10.0.0.10:/etc/passwd /opt --- **è¯•éªŒç¯å¢ƒ** | è§’è‰² | IP | ä¸»æœºå | | ------------ | --------- | ------------ | | rsync server | 10.0.0.10 | rsync-server | | rsync client | 10.0.0.11 | rsync-client | **å®éªŒè¿‡ç¨‹** # rsyncæœåŠ¡ç«¯æ“ä½œ ## 1.å®‰è£…rsync ```python yum -y install rsync 2.ç¼–è¾‘rsyncé…ç½®æ–‡ä»¶ #å¤‡ä»½åŸæœ‰æ–‡ä»¶ cp /etc/rsyncd.conf{,.bak} #ç¼–è¾‘rsyncé…ç½®æ–‡ä»¶ cat >/etc/rsyncd.conf 3.å»ºç«‹rsyncç”¨æˆ·åŠç›¸å…³ç›®å½• #åˆ›å»ºrsyncç”¨æˆ· useradd -M -s /sbin/nologin rsync #åˆ›å»ºçœŸæ­£çš„å…±äº«ç›®å½•å¹¶ä¿®æ”¹ç›®å½•æ‰€æœ‰è€…ä¸ºrsync mkdir /backup && chown rsync.rsync /backup 4.åˆ›å»ºç”¨æˆ·å¯†ç æ–‡ä»¶ âš ï¸ç”¨æˆ·å¯†ç æ–‡ä»¶æƒé™å¿…é¡»ä¸º600ï¼ï¼ï¼ #åˆ›å»ºå¯†ç æ–‡ä»¶ï¼Œå¯†ç æ–‡ä»¶è¦ä¸/etc/rsyncd.confä¸­\"secrets file = /etc/rsync.passwor\"ç›¸åŒ echo \"rsync_backup:1\" > /etc/rsync.password #ä¿®æ”¹å¯†ç æ–‡ä»¶æƒé™ï¼Œå¿…é¡»ä¸º600ï¼ï¼ï¼ chmod 600 /etc/rsync.password 5.å¯åŠ¨rsyncå¹¶åŠ å…¥å¼€æœºè‡ªå¯ systemctl start rsyncd && systemctl enable rsyncd rsyncå®¢æˆ·ç«¯æ“ä½œ å®‰è£…rsyncã€å¯åŠ¨ yum -y install rsync systemctl start rsyncd && systemctl enable rsyncd æµ‹è¯•ä¸€ã€å®¢æˆ·ç«¯æ¨é€åŠæ‹‰å–ä¸éœ€è¦è¾“å…¥å¯†ç  âš ï¸å®¢æˆ·ç«¯ä½¿ç”¨--password-file=é€‰é¡¹æ—¶ï¼Œå¯†ç æ–‡ä»¶çš„æƒé™å¿…é¡»ä¸º600ï¼ï¼ï¼ #æ‹‰å–è¯­æ³• rsync -avz ç”¨æˆ·@IP::å…±äº«åç§° æœ¬æœºæ–‡ä»¶|ç›®å½• #æ¨é€è¯­æ³• rsync -avz æœ¬æœºæ–‡ä»¶|ç›®å½• ç”¨æˆ·@IP::å…±äº«åç§° æ–¹æ³•ä¸€ï¼š åœ¨å®¢æˆ·ç«¯/etc/rsync.password(æ–‡ä»¶éšæ„)ä¸­å†™å…¥æœåŠ¡ç«¯å¯†ç æ–‡ä»¶/etc/rsync.passwordä¸­çš„å¯†ç  rsyncæ‹‰å–æˆ–æ¨é€æ—¶åŠ é€‰é¡¹--password-file= âš ï¸è¿™é‡Œçš„å¯†ç æ–‡ä»¶æƒé™å¿…é¡»ä¸º600ï¼ï¼ï¼ $ echo 1 > /etc/rsync.password && chmod 600 /etc/rsync.password $ rsync -avz rsync_backup@10.0.0.10::backup . --password-file=/etc/rsync.password receiving incremental file list ./ 1.txt 2.txt 3.txt 4.txt 5.txt sent 126 bytes received 317 bytes 295.33 bytes/sec total size is 0 speedup is 0.00 ############################################################### æ–¹æ³•äºŒï¼š åœ¨å®¢æˆ·ç«¯ä¸­å¯¼å‡ºå˜é‡ï¼Œå˜é‡åå¿…é¡»ä¸ºRSYNC_PASSWORD $ export RSYNC_PASSWORD=1 $ rsync -avz rsync_backup@10.0.0.10::backup . receiving incremental file list ./ 1.txt 2.txt 3.txt 4.txt 5.txt sent 126 bytes received 317 bytes 80.55 bytes/sec total size is 0 speedup is 0.00 æµ‹è¯•äºŒã€å®ç°æ•°æ®æ— å·®å¼‚åŒæ­¥ --deleteé€‰é¡¹ æ­¤é€‰é¡¹éå¸¸å±é™©ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨ï¼ï¼ï¼ âš ï¸ç”Ÿäº§ç¯å¢ƒåƒä¸‡ä¸è¦ä½¿ç”¨--deleteé€‰é¡¹ æœåŠ¡ç«¯ 10.0.0.10 å®¢æˆ·ç«¯ 10.0.0.11 1.æŸ¥çœ‹æ–‡ä»¶ æœåŠ¡ç«¯æ–‡ä»¶ [root@rsync-server backup]# ls 1.txt 2.txt 3.txt 4.txt 5.txt å®¢æˆ·ç«¯æ–‡ä»¶ [root@rsync-client backup]# ls 1.txt 2.txt 3.txt 4.txt 5.txt 2.åˆ é™¤æœåŠ¡ç«¯1.txt [root@rsync-server backup]# rm -rf 1.txt [root@rsync-server backup]# ls 2.txt 3.txt 4.txt 5.txt 3.ä¸åŠ --deleteå‚æ•°å†æ¬¡åŒæ­¥ï¼Œå¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯æ–‡ä»¶æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯æœåŠ¡ç«¯æ²¡æœ‰1.txt [root@rsync-client backup]# rsync -avz rsync_backup@10.0.0.10::backup . receiving incremental file list ./ sent 27 bytes received 127 bytes 308.00 bytes/sec total size is 0 speedup is 0.00 [root@rsync-client backup]# ls 1.txt 2.txt 3.txt 4.txt 5.txt 4.åŠ --deleteå‚æ•°å†æ¬¡åŒæ­¥ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®¢æˆ·ç«¯åŒæ­¥æœåŠ¡ç«¯å…¨éƒ¨æ–‡ä»¶ï¼Œåˆ é™¤1.txt [root@rsync-client backup]# rsync -avz --delete rsync_backup@10.0.0.10::backup . receiving incremental file list deleting 1.txt sent 24 bytes received 120 bytes 96.00 bytes/sec total size is 0 speedup is 0.00 [root@test1 backup]# ls 2.txt 3.txt 4.txt 5.txt æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/åŒæ­¥æœåŠ¡/centos7.7æ­å»ºsersync.html":{"url":"linux/linuxæœåŠ¡/åŒæ­¥æœåŠ¡/centos7.7æ­å»ºsersync.html","title":"sersync","keywords":"","body":"centos7.7æ­å»ºsersync sersyncå·²äº2015å¹´8æœˆåœæ­¢æ›´æ–°ï¼Œä½œè€…æ¨èä½¿ç”¨lsyncd lsyncd githubåœ°å€ sersyncå®˜ç½‘ sersync githubåœ°å€ ä¸€ã€sersyncç®€ä»‹ sersyncä¸»è¦ç”¨äºæœåŠ¡å™¨åŒæ­¥ï¼Œwebé•œåƒç­‰åŠŸèƒ½ã€‚åŸºäºboost1.41.0,inotify api,rsync command.å¼€å‘ã€‚ç›®å‰ä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„åŒæ­¥è§£å†³æ–¹æ¡ˆæ˜¯inotify-tools+rsync ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯googleå¼€æºé¡¹ç›®Openduckbillï¼ˆä¾èµ–äºinotify- toolsï¼‰ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯åŸºäºè„šæœ¬è¯­è¨€ç¼–å†™çš„ã€‚ç›¸æ¯”è¾ƒä¸Šé¢ä¸¤ä¸ªé¡¹ç›®ï¼Œæœ¬é¡¹ç›®ä¼˜ç‚¹æ˜¯ï¼š 1.sersyncæ˜¯ä½¿ç”¨c++ç¼–å†™ï¼Œè€Œä¸”å¯¹linuxç³»ç»Ÿæ–‡ä»¶ç³»ç»Ÿäº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶å’Œé‡å¤çš„æ–‡ä»¶æ“ä½œè¿›è¡Œè¿‡æ»¤ï¼ˆè¯¦ç»†è§é™„å½•ï¼Œè¿™ä¸ªè¿‡æ»¤è„šæœ¬ç¨‹åºæ²¡æœ‰å®ç°ï¼‰ï¼Œæ‰€ä»¥åœ¨ç»“åˆrsyncåŒæ­¥çš„æ—¶å€™ï¼ŒèŠ‚çœäº†è¿è¡Œæ—¶è€—å’Œç½‘ç»œèµ„æºã€‚ å› æ­¤æ›´å¿«ã€‚ 2.ç›¸æ¯”è¾ƒä¸Šé¢ä¸¤ä¸ªé¡¹ç›®ï¼Œsersyncé…ç½®èµ·æ¥å¾ˆç®€å•ï¼Œå…¶ä¸­binç›®å½•ä¸‹ å·²ç»æœ‰åŸºæœ¬ä¸Šé™æ€ç¼–è¯‘çš„2è¿›åˆ¶æ–‡ä»¶ï¼Œé…åˆbinç›®å½•ä¸‹çš„xmlé…ç½®æ–‡ä»¶ç›´æ¥ä½¿ç”¨å³å¯ã€‚ 3.å¦å¤–æœ¬é¡¹ç›®ç›¸æ¯”è¾ƒå…¶ä»–è„šæœ¬å¼€æºé¡¹ç›®ï¼Œä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œå°¤å…¶åœ¨åŒæ­¥è¾ƒå¤§æ–‡ä»¶æ—¶ï¼Œèƒ½å¤Ÿä¿è¯å¤šä¸ªæœåŠ¡å™¨å®æ—¶ä¿æŒåŒæ­¥çŠ¶æ€ã€‚ 4.æœ¬é¡¹ç›®æœ‰å‡ºé”™å¤„ç†æœºåˆ¶ï¼Œé€šè¿‡å¤±è´¥é˜Ÿåˆ—å¯¹å‡ºé”™çš„æ–‡ä»¶é‡æ–°åŒæ­¥ï¼Œå¦‚æœä»æ—§å¤±è´¥ï¼Œåˆ™ æ¯10ä¸ªå°æ—¶å¯¹åŒæ­¥å¤±è´¥çš„æ–‡ä»¶é‡æ–°åŒæ­¥ã€‚ 5.æœ¬é¡¹ç›®è‡ªå¸¦crontabåŠŸèƒ½ï¼Œåªéœ€åœ¨xmlé…ç½®æ–‡ä»¶ä¸­å¼€å¯ï¼Œå³å¯æŒ‰æ‚¨çš„è¦æ±‚ï¼Œéš”ä¸€æ®µæ—¶é—´æ•´ä½“åŒæ­¥ä¸€æ¬¡ã€‚æ— éœ€å†é¢å¤–é…ç½®crontabåŠŸèƒ½ã€‚ 6.æœ¬é¡¹ç›®socketä¸httpæ’ä»¶æ‰©å±•ï¼Œæ»¡è¶³æ‚¨äºŒæ¬¡å¼€å‘çš„éœ€è¦ã€‚ åŒæ­¥åŸç†å›¾ äºŒã€sersyncæ­å»ºè¿‡ç¨‹ sersyncæµç¨‹ å®‰è£…sersyncçš„æœåŠ¡å™¨è§’è‰²ä¸ºå®¢æˆ·ç«¯ï¼Œå®æ—¶æ£€æµ‹åœ¨sersyncä¸­é…ç½®çš„å…±äº«ç›®å½•æ–‡ä»¶å˜åŒ–ï¼Œé‡‡ç”¨å®¢æˆ·ç«¯ä¸»åŠ¨æ¨é€çš„æ–¹å¼å°†å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶ä¼ è¾“åˆ°æœåŠ¡ç«¯ sersyncè´Ÿè´£æ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼ŒçœŸæ­£åŒæ­¥æ–‡ä»¶è¿˜æ˜¯rsync è¯•éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå å®‰è£…æœåŠ¡ rsync server 10.0.0.10 rsync-server rsync rsync client 10.0.0.11 rsync-client sersyncã€rsyncã€inotify-tools æœåŠ¡ç«¯æ“ä½œ 1.å®‰è£…rsync yum -y install rsync 2.ç¼–è¾‘rsyncé…ç½®æ–‡ä»¶ #å¤‡ä»½åŸæœ‰æ–‡ä»¶ cp /etc/rsyncd.conf{,.bak} #ç¼–è¾‘rsyncé…ç½®æ–‡ä»¶ cat >/etc/rsyncd.conf 3.å»ºç«‹rsyncç”¨æˆ·åŠå…±äº«ç›®å½• #åˆ›å»ºrsyncç”¨æˆ· useradd -M -s /sbin/nologin rsync #åˆ›å»ºçœŸæ­£çš„å…±äº«ç›®å½•å¹¶ä¿®æ”¹ç›®å½•æ‰€æœ‰è€…ä¸ºrsync mkdir /backup && chown rsync.rsync /backup 4.åˆ›å»ºç”¨æˆ·å¯†ç æ–‡ä»¶ âš ï¸ç”¨æˆ·å¯†ç æ–‡ä»¶æƒé™å¿…é¡»ä¸º600ï¼ï¼ï¼ #åˆ›å»ºå¯†ç æ–‡ä»¶ï¼Œå¯†ç æ–‡ä»¶è¦ä¸/etc/rsyncd.confä¸­\"secrets file = /etc/rsync.password\"ç›¸åŒ echo \"rsync_backup:1\" > /etc/rsync.password #ä¿®æ”¹å¯†ç æ–‡ä»¶æƒé™ï¼Œå¿…é¡»ä¸º600ï¼ï¼ï¼ chmod 600 /etc/rsync.password 5.å¯åŠ¨rsyncå¹¶åŠ å…¥å¼€æœºè‡ªå¯ systemctl start rsyncd && systemctl enable rsyncd å®¢æˆ·ç«¯æ“ä½œ 1.å®‰è£…inotify-tools yum -y install inotify-tools 2.ä¸‹è½½sersync #ä¸‹è½½sersync git clone https://github.com.cnpmjs.org/wsgzao/sersync.git #è§£å‹ç¼©åŒ…å¹¶é‡å‘½å tar xf sersync/sersync2.5.4_64bit_binary_stable_final.tar.gz mv GNU-Linux-x86/ /usr/local/sersync 3.é…ç½®sersync âš ï¸13è¡Œè¿™ä¸ªé€‰é¡¹æ˜¯å¦å¼€å¯å®Œå…¨åŒæ­¥ï¼Œæ¯”è¾ƒå±é™©ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºfalse #æŸ¥çœ‹sersyncç›®å½•å†…å®¹ï¼ŒåŒ…å«é…ç½®æ–‡ä»¶confxml.xmlå’Œå¯åŠ¨æ–‡ä»¶sersync2 $ cd /usr/local/sersync $ pwd /usr/local/sersync $ ls confxml.xml sersync2 #é…ç½®confxmlï¼Œç²¾ç®€ç‰ˆä¿®æ”¹ 13è¡Œï¼Œæ˜¯å¦å¼€å¯å®Œå…¨åŒæ­¥ï¼Œæ¯”è¾ƒå±é™©ï¼Œä¸€èˆ¬ä¸ºfalse 24è¡Œï¼Œé…ç½®æœ¬æœºå…±äº«ç›®å½• 25è¡Œï¼Œè¿œç¨‹ä¸»æœºIPåŠrsyncå…±äº«åç§° 30è¡Œï¼ŒrsyncåŒæ­¥æ—¶å‘½ä»¤çš„é€‰é¡¹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯ 31è¡Œï¼ŒæŒ‡å®šæœåŠ¡ç«¯rsyncé…ç½®ä¸­çš„è®¤è¯ç”¨æˆ·åŠå¯†ç æ–‡ä»¶ #å‚æ•°è¯´æ˜ -a //å½’æ¡£æ¨¡å¼ä¼ è¾“, ç­‰äº-tropgDl -v //è¯¦ç»†æ¨¡å¼è¾“å‡º, æ‰“å°é€Ÿç‡, æ–‡ä»¶æ•°é‡ç­‰ -z //ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©ä»¥æé«˜æ•ˆç‡ -r //é€’å½’ä¼ è¾“ç›®å½•åŠå­ç›®å½•ï¼Œå³ç›®å½•ä¸‹çš„æ‰€æœ‰ç›®å½•éƒ½åŒæ ·ä¼ è¾“ -t //ä¿æŒæ–‡ä»¶æ—¶é—´ä¿¡æ¯ -o //ä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯ -p //ä¿æŒæ–‡ä»¶æƒé™ -g //ä¿æŒæ–‡ä»¶å±ç»„ä¿¡æ¯ -l //ä¿ç•™è½¯è¿æ¥ -P //æ˜¾ç¤ºåŒæ­¥çš„è¿‡ç¨‹åŠä¼ è¾“æ—¶çš„è¿›åº¦ç­‰ä¿¡æ¯ -D //ä¿æŒè®¾å¤‡æ–‡ä»¶ä¿¡æ¯ -L //ä¿ç•™è½¯è¿æ¥æŒ‡å‘çš„ç›®æ ‡æ–‡ä»¶ -e //ä½¿ç”¨çš„ä¿¡é“åè®®,æŒ‡å®šæ›¿ä»£rshçš„shellç¨‹åº --exclude=PATTERN //æŒ‡å®šæ’é™¤ä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼ --exclude-from=file //æ–‡ä»¶åæ‰€åœ¨çš„ç›®å½•æ–‡ä»¶ --bwlimit=100 //é™é€Ÿä¼ è¾“ --partial //æ–­ç‚¹ç»­ä¼  --delete //è®©ç›®æ ‡ç›®å½•å’Œæºç›®å½•æ•°æ®ä¿æŒä¸€è‡´ 31è¡Œï¼Œå¼€å¯ç”¨æˆ·è®¤è¯ï¼Œç”¨æˆ·åï¼Œå¯†ç æ–‡ä»¶ 4.åˆ›å»ºç”¨æˆ·è®¤è¯å¯†ç æ–‡ä»¶åŠå…±äº«ç›®å½• âš ï¸å¯†ç æ–‡ä»¶æƒé™å¿…é¡»ä¸º600ï¼ï¼ï¼ #åˆ›å»ºç”¨æˆ·è®¤è¯å¯†ç æ–‡ä»¶ echo 1 > /etc/rsync.password #ä¿®æ”¹æ–‡ä»¶æƒé™ï¼Œå¿…é¡»ä¸º600ï¼ï¼ï¼ chmod 600 /etc/rsync.password #åˆ›å»ºrsyncç”¨æˆ· useradd -M -s /sbin/nologin rsync #åˆ›å»ºå…±äº«ç›®å½• mkdir /backup && chown rsync.rsync /backup 5.å¯åŠ¨sersync #å¯åŠ¨sersync /usr/local/sersync/sersync2 -dro /usr/local/sersync/confxml.xml set the system param executeï¼šecho 50000000 > /proc/sys/fs/inotify/max_user_watches executeï¼šecho 327679 > /proc/sys/fs/inotify/max_queued_events parse the command param option: -d run as a daemon option: -r rsync all the local files to the remote servers before the sersync work option: -o config xml nameï¼š /usr/local/sersync/confxml.xml daemon thread num: 10 parse xml config file host ip : localhost host port: 8008 daemon startï¼Œsersync run behind the console config xml parse success please set /etc/rsyncd.conf max connections=0 Manually sersync working thread 12 = 1(primary thread) + 1(fail retry thread) + 10(daemon sub threads) Max threads numbers is: 22 = 12(Thread pool nums) + 10(Sub threads) please according your cpu ï¼Œuse -n param to adjust the cpu rate ------------------------------------------ rsync the directory recursivly to the remote servers once working please wait... execute command: cd /backup && rsync -artuz -R --delete ./ 10.0.0.12::backup >/dev/null 2>&1 #æŸ¥çœ‹sersyncè¿›ç¨‹ $ ps aux|grep sersyn[c] root 2213 0.0 0.1 92324 704 ? Ssl 15:05 0:00 /usr/local/sersync/sersync2 -dro /usr/local/sersync/confxml.xml #å¯åŠ¨å‚æ•°è¯´æ˜ -d å¯ç”¨å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ -r åœ¨ç›‘æ§å‰ï¼Œå°†ç›‘æ§ç›®å½•ä¸è¿œç¨‹ä¸»æœºç”¨rsyncå‘½ä»¤æ¨é€ä¸€é -n æŒ‡å®šå¼€å¯å®ˆæŠ¤çº¿ç¨‹çš„æ•°é‡ï¼Œé»˜è®¤ä¸º10ä¸ª -o æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨confxml.xmlæ–‡ä»¶ -m å•ç‹¬å¯ç”¨å…¶ä»–æ¨¡å—ï¼Œä½¿ç”¨ -m refreshCDN å¼€å¯åˆ·æ–°CDNæ¨¡å— -m å•ç‹¬å¯ç”¨å…¶ä»–æ¨¡å—ï¼Œä½¿ç”¨ -m socket å¼€å¯socketæ¨¡å— -m å•ç‹¬å¯ç”¨å…¶ä»–æ¨¡å—ï¼Œä½¿ç”¨ -m http å¼€å¯httpæ¨¡å— ä¸åŠ -må‚æ•°ï¼Œåˆ™é»˜è®¤æ‰§è¡ŒåŒæ­¥ç¨‹åº 6.éªŒè¯åŒæ­¥ #æ–‡ä»¶ã€ç›®å½•åŒæ­¥éªŒè¯ 1.è¿›å…¥å®¢æˆ·ç«¯10.0.0.10 /backupç›®å½•åˆ›å»ºæ–‡ä»¶ã€ç›®å½• $ touch {1..5}.txt && mkdir dir{1..3} $ ls 1.txt 2.txt 3.txt 4.txt 5.txt dir1 dir2 dir3 2.æœåŠ¡ç«¯10.0.0.11éªŒè¯ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶å·²ç»åŒæ­¥ $ cd /backup $ ls 1.txt 2.txt 3.txt 4.txt 5.txt dir1 dir2 dir3 #æ–‡ä»¶å†…å®¹åŒæ­¥éªŒè¯ 1.å®¢æˆ·ç«¯10.0.0.10 /backupä¸­å‘1.txtå†™å…¥å†…å®¹ $ cd /backup && echo 'test sersync' >1.txt 2.æœåŠ¡ç«¯10.0.0.11 /backupä¸­æŸ¥çœ‹1.txtæ–‡ä»¶å†…å®¹ $ cd /backup && cat 1.txt test sersync 7.åŒæ­¥è¿‡ç¨‹æ€»ç»“ sersyncåŒæ­¥è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„ç‚¹ sersyncç«¯éœ€è¦ç”¨åˆ°rsyncdæœåŠ¡ç«¯é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„è®¤è¯ç”¨æˆ·çš„å¯†ç ï¼Œå¹¶ä¸”å¯†ç æ–‡ä»¶æƒé™å¿…é¡»ä¸º600 sersyncçš„ä½œç”¨å…¶å®å°±æ˜¯å®æ—¶æ£€æµ‹æœ¬åœ°æ–‡ä»¶ï¼Œä¸€æ—¦æœ‰å˜åŒ–å°±æŠŠæ–‡ä»¶æ¨é€åˆ°é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ä¸»æœº sersyncç«¯æ¨é€æ–‡ä»¶å®é™…ä¸Šè¿˜æ˜¯åˆ©ç”¨äº†rsync æœ‰å…³å¯†ç æ–‡ä»¶çš„è¯´æ˜ rsyncè®¤è¯ç”¨æˆ·:å¯†ç  ä¸€å®šæ˜¯å†™åœ¨rsyncdæœåŠ¡ç«¯çš„ åªæœ‰å•çº¯çš„å¯†ç  ä¸€å®šæ˜¯å†™åœ¨æ¨é€ç«¯çš„ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/åŒæ­¥æœåŠ¡/centos7.7æ­å»ºlsyncd.html":{"url":"linux/linuxæœåŠ¡/åŒæ­¥æœåŠ¡/centos7.7æ­å»ºlsyncd.html","title":"lsyncd","keywords":"","body":"centos7.7æ­å»ºlsyncd lsyncdå®˜ç½‘ lsyncd githubåœ°å€ lsyncdç®€ä»‹ Lsyncdä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶æ¥å£ï¼ˆinotifyæˆ–fseventsï¼‰æ¥ç›‘è§†æœ¬åœ°æ–‡ä»¶å’Œç›®å½•çš„æ›´æ”¹ã€‚Lsyncdæ•´ç†è¿™äº›äº‹ä»¶å‡ ç§’é’Ÿï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ä»¥å°†æ›´æ”¹åŒæ­¥åˆ°è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿã€‚é»˜è®¤çš„åŒæ­¥æ–¹æ³•æ˜¯rsyncã€‚å› æ­¤ï¼ŒLsyncdæ˜¯ä¸€ç§è½»å‹çš„å®æ—¶é•œåƒè§£å†³æ–¹æ¡ˆã€‚Lsyncdç›¸å¯¹æ˜“äºå®‰è£…ï¼Œå¹¶ä¸”ä¸éœ€è¦æ–°çš„æ–‡ä»¶ç³»ç»Ÿæˆ–å—è®¾å¤‡ã€‚Lysncdä¸ä¼šå¦¨ç¢æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„æ€§èƒ½ã€‚ ä½œä¸ºrsyncçš„æ›¿ä»£æ–¹æ³•ï¼ŒLsyncdè¿˜å¯ä»¥é€šè¿‡rsync + sshæ¨é€æ›´æ”¹ã€‚å½“æ–‡ä»¶æˆ–ç›®å½•è¢«é‡å‘½åæˆ–ç§»åŠ¨åˆ°æœ¬åœ°æ ‘ä¸­çš„æ–°ä½ç½®æ—¶ï¼ŒRsync + sshå…è®¸æ›´é«˜æ•ˆçš„åŒæ­¥ã€‚ï¼ˆç›¸åï¼Œæ™®é€šrsyncé€šè¿‡åˆ é™¤æ—§æ–‡ä»¶ç„¶åé‡æ–°ä¼ è¾“æ•´ä¸ªæ–‡ä»¶æ¥æ‰§è¡Œç§»åŠ¨ã€‚ï¼‰ ç»†ç²’åº¦çš„å®šåˆ¶å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥å®ç°ã€‚è‡ªå®šä¹‰æ“ä½œé…ç½®ç”šè‡³å¯ä»¥ä»å¤´å¼€å§‹å†™åœ¨å±‚å çš„å±‚æ¬¡ä¸Šï¼Œä»å¤–å£³è„šæœ¬åˆ°ç”¨Luaè¯­è¨€ç¼–å†™çš„ä»£ç ã€‚å› æ­¤ï¼Œç®€å•ï¼Œå¼ºå¤§å’Œçµæ´»çš„é…ç½®æ˜¯å¯èƒ½çš„ã€‚ Lsyncd 2.2.1åœ¨æ‰€æœ‰æºè®¡ç®—æœºå’Œç›®æ ‡è®¡ç®—æœºä¸Šéƒ½è¦æ±‚rsync> = 3.1ã€‚ lsyncdåŒæ­¥æµç¨‹ æœåŠ¡å™¨Aä¸­éƒ¨ç½²rsyncå®¢æˆ·ç«¯+lsyncdï¼Œlsyncdé€šè¿‡å†…æ ¸çš„inotifyè§¦å‘æœºåˆ¶ç›‘æ§æ–‡ä»¶çš„åŠ¨å‘ï¼Œå¹¶å°†æ”¹åŠ¨å‘é€ç»™rsyncï¼Œç”±rsyncåŒæ­¥åˆ°æœåŠ¡å™¨Bï¼›æœåŠ¡å™¨Bä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼éƒ¨ç½²rsyncæœåŠ¡ç«¯ï¼Œæ¥æ”¶Aå‘æ¥çš„æ–‡ä»¶åŒæ­¥è¯·æ±‚ï¼Œå¹¶å°†æ–‡ä»¶åŒæ­¥ï¼ éƒ¨ç½²lsyncdç«¯çš„æœåŠ¡å™¨çš„è§’è‰²ä¸ºå®¢æˆ·ç«¯ è¯•éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå å®‰è£…æœåŠ¡ lsyncd server 10.0.0.10 lsyncd-server rsync lsyncd client 10.0.0.11 lsyncd-client rsyncã€lsyncd æœåŠ¡ç«¯æ“ä½œ 1.å®‰è£…rsync yum -y install rsync 2.ç¼–è¾‘rsyncé…ç½®æ–‡ä»¶ #å¤‡ä»½åŸæœ‰æ–‡ä»¶ cp /etc/rsyncd.conf{,.bak} #ç¼–è¾‘rsyncé…ç½®æ–‡ä»¶ cat >/etc/rsyncd.conf 3.å»ºç«‹rsyncç”¨æˆ·åŠå…±äº«ç›®å½• #åˆ›å»ºrsyncç”¨æˆ· useradd -M -s /sbin/nologin rsync #åˆ›å»ºçœŸæ­£çš„å…±äº«ç›®å½•å¹¶ä¿®æ”¹ç›®å½•æ‰€æœ‰è€…ä¸ºrsync mkdir /backup && chown rsync.rsync /backup 4.åˆ›å»ºç”¨æˆ·å¯†ç æ–‡ä»¶ âš ï¸ç”¨æˆ·å¯†ç æ–‡ä»¶æƒé™å¿…é¡»ä¸º600ï¼ï¼ï¼ #åˆ›å»ºå¯†ç æ–‡ä»¶ï¼Œå¯†ç æ–‡ä»¶è¦ä¸/etc/rsyncd.confä¸­\"secrets file = /etc/rsync.password\"ç›¸åŒ echo \"rsync_backup:1\" > /etc/rsync.password #ä¿®æ”¹å¯†ç æ–‡ä»¶æƒé™ï¼Œå¿…é¡»ä¸º600ï¼ï¼ï¼ chmod 600 /etc/rsync.password 5.å¯åŠ¨rsyncå¹¶åŠ å…¥å¼€æœºè‡ªå¯ systemctl start rsyncd && systemctl enable rsyncd å®¢æˆ·ç«¯æ“ä½œ 1.å®‰è£…lsyncdã€rsync #å®‰è£…lsyncdéœ€è¦epelä»“åº“ yum install -y epel-release #å®‰è£…lsyncdã€rsync yum -y install lsyncd rsync #æŸ¥çœ‹ç‰ˆæœ¬ $ rpm -qa lsyncd lsyncd-2.2.2-1.el7.x86_64 $ rpm -qa rsync rsync-3.1.2-6.el7_6.1.x86_64 2.é…ç½®lsyncd lsyncdé…ç½®æ–‡ä»¶/etc/lsyncd.confåŸå…ˆå†…å®¹å¦‚ä¸‹ï¼Œ--æ ‡ç¤ºæ³¨é‡Š ---- -- User configuration file for lsyncd. -- -- Simple example for default rsync, but executing moves through on the target. -- -- For more examples, see /usr/share/doc/lsyncd*/examples/ -- sync{default.rsyncssh, source=\"/var/www/html\", host=\"localhost\", targetdir=\"/tmp/htmlcopy/\"} åŒæ­¥ä¸€å°æœºå™¨(å¯†ç æ–‡ä»¶æ–¹å¼) ç¼–è¾‘/etc/lsyncd.conf âš ï¸--delete = trueè¿™ä¸ªé€‰é¡¹åƒä¸‡ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼ï¼ï¼ #å¤‡ä»½æ–‡ä»¶ cp /etc/lsyncd.conf{,.bak} #ç¼–è¾‘æ–‡ä»¶ cat >/etc/lsyncd.conf åŒæ­¥å¤šå°æœºå™¨(å¯†ç æ–‡ä»¶æ–¹å¼) ä»¥ä¸Šä¸ºä»…åŒæ­¥ä¸€å°æœºå™¨ï¼Œå¦‚æœéœ€è¦åŒæ­¥åˆ°å¤šå°æœºå™¨ï¼Œåªéœ€è¦åœ¨åŠ å‡ ä¸ªsync{xxx}é…ç½®å³å¯ï¼ŒåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœé‡‡ç”¨å¯†ç æ–‡ä»¶çš„æ–¹å¼ï¼Œåˆ™æ¯ä¸€ä¸ªsyncæ ‡ç­¾ä¸­éƒ½å¿…é¡»åŒ…å«rsyncæ ‡ç­¾ï¼Œç”¨æ¥æŒ‡å®šå¯†ç æ–‡ä»¶ å®˜æ–¹è¯´æ˜ #åœ¨/etc/lsyncd.confé…ç½®æ–‡ä»¶ä¸­å¤šåŠ å‡ ä¸ªsyncæ ‡ç­¾å³ä¸ºåŒæ­¥åˆ°å¤šå°æœºå™¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœé‡‡ç”¨å¯†ç æ–‡ä»¶çš„æ–¹å¼ï¼Œåˆ™æ¯ä¸€ä¸ªsyncæ ‡ç­¾ä¸­éƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªrsyncæ ‡ç­¾ï¼Œç”¨æ¥æŒ‡å®šå¯†ç æ–‡ä»¶ sync { default.rsync, source = \"/backup\", --ç›‘æ§ç›®å½• target = \"rsync_backup@10.0.0.134::backup\", rsync = { binary = \"/usr/bin/rsync\", --rsyncå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œ å¿…é¡»ä¸ºç»å¯¹è·¯å¾„ password_file = \"/etc/rsync.password\",--å¯†ç è®¤è¯æ–‡ä»¶ archive = true, compress = false, verbose = false, _extra = { \"--bwlimit=200\", \"--omit-link-times\" } } } sync { default.rsync, source = \"/backup\", --ç›‘æ§ç›®å½• target = \"rsync_backup@10.0.0.130::backup\", --rsyncçš„è®¤è¯ç”¨æˆ·åã€IPã€æ¨¡å— --delete = true, exclude = { '.**', '.git/**', '*.bak', '*.tmp', 'runtime/**', 'cache/**' }, rsync = { binary = \"/usr/bin/rsync\", --rsyncå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œ å¿…é¡»ä¸ºç»å¯¹è·¯å¾„ password_file = \"/etc/rsync.password\",--å¯†ç è®¤è¯æ–‡ä»¶ archive = true, compress = false, verbose = false, _extra = { \"--bwlimit=200\", \"--omit-link-times\" } } } å®˜æ–¹è¯´æ˜æ–‡æ¡£(åŒæ­¥åˆ°å¤šå°æœºå™¨) ä½¿ç”¨sshå…å¯†æ–¹å¼åŒæ­¥(éå¯†ç æ–‡ä»¶æ–¹å¼) å®˜æ–¹é…ç½®æ–‡ä»¶ç¤ºæ„å›¾ ä¸»æœºä¹‹é—´å…ˆåšsshå…å¯†ç™»é™† #ç”Ÿæˆå¯†é’¥ï¼Œé»˜è®¤rsaåŠ å¯†ç±»å‹ï¼Œé•¿åº¦2048 -bæŒ‡å®šé•¿åº¦ -tæŒ‡å®šåŠ å¯†ç±»å‹ $ ssh-keygen Generating public/private rsa key pair. Enter file in which to save the key (/root/.ssh/id_rsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /root/.ssh/id_rsa. Your public key has been saved in /root/.ssh/id_rsa.pub. The key fingerprint is: SHA256:hV+uhg4hRTGHy3U3891ANGojAeAYmu2rA9E316XaBkc root@k8s-node1 The key's randomart image is: +---[RSA 2048]----+ | . =+o.. o+ | | + =.oE.o.+... | | .o o.o=.+o.=+ o.| |. ..o.= +o = .. o| | . .oo.=S . . | |. o..o. . | | . . ... o | | .. o . | | .. . | +----[SHA256]-----+ #æ‹·è´å…¬é’¥åˆ°å…¶ä»–éœ€è¦åŒæ­¥åˆ°ä¸»æœº ssh-copy-id -i ~/.ssh/id_rsa.pub root@10.0.0.11 ä½¿ç”¨sshå…å¯†æ–¹å¼çš„lsyncdé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼Œå¦‚éœ€åŒæ­¥åˆ°å¤šå°ä¸»æœºï¼Œåˆ™å’Œä¹‹å‰ä½¿ç”¨å¯†ç æ–‡ä»¶åŒæ­¥æ–¹å¼éƒ½ç›¸åŒï¼Œéƒ½æ˜¯å¢åŠ å¤šä¸ªsyncæ ‡ç­¾ settings { logfile = \"/var/log/lsyncd/lsyncd.log\", statusFile = \"/var/log/lsyncd/lsyncd.status\", inotifyMode = \"CloseWrite\", maxProcesses = 1, maxDelays = 1, nodaemon = false, } sync { default.rsyncssh, source = \"/backup\", --ç›‘æ§ç›®å½• host = \"10.0.0.130\", --åŒæ­¥è¿œç¨‹ä¸»æœºIP targetdir = \"/backup\", --åŒæ­¥è¿œç¨‹ä¸»æœºç›®å½• rsync = { archive = true, compress = false, verbose = false, _extra = { \"--bwlimit=200\", \"--omit-link-times\" } }, ssh = { port = 22 } } sync { default.rsyncssh, source = \"/backup\", --ç›‘æ§ç›®å½• host = \"10.0.0.134\", --åŒæ­¥è¿œç¨‹ä¸»æœºIP targetdir = \"/backup\", --åŒæ­¥è¿œç¨‹ä¸»æœºç›®å½• --delete = true, exclude = { '.**', '.git/**', '*.bak', '*.tmp', 'runtime/**', 'cache/**' }, rsync = { archive = true, compress = false, verbose = false, _extra = { \"--bwlimit=200\", \"--omit-link-times\" } }, ssh = { port = 22 } } è¿˜æ˜¯ä½¿ç”¨lsyncd --nodaemon /etc/lsyncd.confå¯åŠ¨æŸ¥çœ‹æ˜¯å¦æŠ¥é”™ï¼Œå¦‚æœä¸æŠ¥é”™åˆ™ä½¿ç”¨systemctlå¯åŠ¨lsyncdå³å¯ 3.åˆ›å»ºç”¨æˆ·è®¤è¯å¯†ç æ–‡ä»¶åŠå…±äº«ç›®å½• âš ï¸å¯†ç æ–‡ä»¶æƒé™å¿…é¡»ä¸º600ï¼ï¼ï¼ #åˆ›å»ºç”¨æˆ·è®¤è¯å¯†ç æ–‡ä»¶ echo 1 > /etc/rsync.password #ä¿®æ”¹æ–‡ä»¶æƒé™ï¼Œå¿…é¡»ä¸º600ï¼ï¼ï¼ chmod 600 /etc/rsync.password #åˆ›å»ºrsyncç”¨æˆ·ï¼Œä¸rsyncæœåŠ¡ç«¯å…±äº«ç›®å½•æƒé™ç›¸åŒ useradd -M -s /sbin/nologin rsync #åˆ›å»ºå…±äº«ç›®å½• mkdir /backup && chown rsync.rsync /backup 4.å¯åŠ¨lsyncd #å…ˆä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨çœ‹æ˜¯å¦æŠ¥é”™ï¼Œå¦‚æœä¸æŠ¥é”™åˆ™ctrl+cåœæ­¢ç„¶åç”¨systemctlå¯åŠ¨lsyncd $ lsyncd -nodaemon /etc/lsyncd.conf 16:31:18 Normal: --- Startup --- 16:31:18 Normal: recursive startup rsync: /backup/ -> rsync_backup@10.0.0.10::backup/ excluding .git/** runtime/** .** *.tmp cache/** *.bak 16:31:18 Normal: Startup of /backup/ -> rsync_backup@10.0.0.10::backup/ finished. #systemctlå¯åŠ¨ systemcl start lsyncd && systemctl enable lsyncd 5.éªŒè¯ å¯åŠ¨lsyncdæœåŠ¡åï¼Œåœ¨lsyncdæœ¬åœ°åˆ›å»ºæ–‡ä»¶ï¼Œç„¶ååˆ°å¦å¤–åŒæ­¥çš„æœºå™¨ç›®å½•æŸ¥çœ‹æ˜¯å¦åŒæ­¥æ–‡ä»¶å³å¯ lsyncdå¯†ç æ–‡ä»¶æ–¹å¼ä¸sshå…å¯†æ–¹å¼é…ç½®æ–‡ä»¶éœ€è¦æ³¨æ„çš„åœ°æ–¹ å¯†ç æ–‡ä»¶æ–¹å¼ sync { default.rsync, source = \"/backup\", --ç›‘æ§ç›®å½• target = \"rsync_backup@10.0.0.10::backup\", --rsyncçš„è®¤è¯ç”¨æˆ·åã€IPã€æ¨¡å— rsync = { binary = \"/usr/bin/rsync\", --rsyncå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œ å¿…é¡»ä¸ºç»å¯¹è·¯å¾„ password_file = \"/etc/rsync.password\", --å¯†ç è®¤è¯æ–‡ä»¶ } } sshå…å¯†æ–¹å¼ sync { default.rsyncssh, source = \"/backup\", --ç›‘æ§ç›®å½• host = \"10.0.0.134\", --åŒæ­¥è¿œç¨‹ä¸»æœºIP targetdir = \"/backup\", --åŒæ­¥è¿œç¨‹ä¸»æœºç›®å½• rsync = { archive = true, compress = false, verbose = false }, ssh = { port = 22 } } ä¸åŒç‚¹ä¸€ å¯†ç æ–‡ä»¶æ–¹å¼ä¸­syncæ ‡ç­¾ä¸­æ˜¯default.rsync sshå…å¯†æ–¹å¼ä¸­syncæ ‡ç­¾ä¸­æ˜¯default.rsyncssh ä¸åŒç‚¹äºŒ å¯†ç æ–‡ä»¶æ–¹å¼ä¸­syncæ ‡ç­¾ä¸­çš„targetç”¨äºæŒ‡å®šrsyncçš„è®¤è¯ç”¨æˆ·åã€IPã€æ¨¡å— sshå…å¯†æ–¹å¼ä¸­syncæ ‡ç­¾ä¸­åˆ™ç”¨åˆ°äº†host(æŒ‡å®šåŒæ­¥è¿œç¨‹ä¸»æœºIP)å’Œtargetdir(æŒ‡å®šåŒæ­¥è¿œç¨‹ä¸»æœºç›®å½•) ä¸åŒç‚¹ä¸‰ å¯†ç æ–‡ä»¶æ–¹å¼ä¸­syncæ ‡ç­¾ä¸­çš„rsyncæ ‡ç­¾ä¸‹ç”¨åˆ°äº†binary(æŒ‡å®šrsyncå‘½ä»¤ç»å¯¹è·¯å¾„)å’Œpassword_file(å¯†ç è®¤è¯æ–‡ä»¶) sshå…å¯†æ–¹å¼ä¸­syncæ ‡ç­¾ä¸­çš„rsyncæ ‡ç­¾ä¸‹ä¸éœ€è¦æŒ‡å®šå…¶ä»–æ ‡æ³¨ä¿¡æ¯ è¯¦ç»†é…ç½®çœ‹å®˜ç½‘å§ï¼Œå†™çš„éå¸¸æ¸…æ¥š æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/php/1.centos7ç¼–è¯‘å®‰è£…php7.3.html":{"url":"linux/linuxæœåŠ¡/php/1.centos7ç¼–è¯‘å®‰è£…php7.3.html","title":"centos7ç¼–è¯‘å®‰è£…php","keywords":"","body":"centos7ç¼–è¯‘å®‰è£…php7.3 phpå®˜ç½‘ phpå®˜æ–¹ä¸‹è½½åœ°å€ phpå†å²ç‰ˆæœ¬å®˜æ–¹ä¸‹è½½åœ°å€ phpå®˜æ–¹ä¸­æ–‡æ–‡æ¡£ php githubåœ°å€ 1.ä¸‹è½½æºç åŒ… wget https://www.php.net/distributions/php-7.3.19.tar.xz 2.å®‰è£…ä¾èµ–åŒ… #å®‰è£…å¼€å‘è€…å·¥å…·åŒ… yum -y group install \"Development Tools\" #å®‰è£…ä¾èµ–åŒ… yum -y install systemd-devel libacl libacl-devel libxml2 libxml2-devel curl curl-devel libjpeg libjpeg-devel libpng libpng-devel gmp-devel libxslt libxslt-devel openssl openssl-devel zlib zlib-devel pcre pcre-devel glib2 glib2-devel bzip2 bzip2-devel glibc glibc-devel liblzf liblzf-devel libzstd libzstd-devel 3.è§£å‹ç¼©åŒ…å¹¶ç¼–è¯‘å®‰è£… 3.1 ç¼–è¯‘å®‰è£…libzip è§£å†³æŠ¥é”™configure: error: Please reinstall the libzip distribution 3.1.1 ç¼–è¯‘å®‰è£…libzipéœ€è¦å®‰è£…é«˜ç‰ˆæœ¬çš„cmake cmake githubä¸‹è½½åœ°å€ #ä¸‹è½½æºç åŒ… wget https://github.com/Kitware/CMake/releases/download/v3.16.8/cmake-3.16.8.tar.gz #è§£å‹ç¼©æºç åŒ… tar xf cmake-3.16.8.tar.gz #è¿›å…¥è§£å‹ç¼©ç›®å½•å¹¶ç¼–è¯‘å®‰è£… cd cmake-3.16.8/ ./configure --prefix=/usr/local/cmake gmake && make install #å¯¼å‡ºPATHç¯å¢ƒå˜é‡å¹¶ä½¿é…ç½®ç”Ÿæ•ˆ echo 'export PATH=/usr/local/cmake/bin:$PATH' >/etc/profile.d/cmake.sh source /etc/profile #éªŒè¯ $ cmake --version cmake version 3.16.8 3.1.2 ç¼–è¯‘å®‰è£…libzip libzipå®˜ç½‘ #ä¸‹è½½æºç åŒ… wget https://libzip.org/download/libzip-1.7.1.tar.xz #è§£å‹ç¼©æºç åŒ… tar xf libzip-1.7.1.tar.xz #è¿›å…¥è§£å‹ç¼©ç›®å½•å¹¶ç¼–è¯‘å®‰è£… cd libzip-1.7.1 mkdir build && cd build && cmake .. && make && make install 3.2 ç¼–è¾‘é…ç½®æ–‡ä»¶/etc/ld.so.confå†…å®¹ è§£å†³æŠ¥é”™configure: error: off_t undefined; check your library configuration #å¤‡ä»½é…ç½®æ–‡ä»¶ cp /etc/ld.so.conf{,.bak} #å‘é…ç½®æ–‡ä»¶å†™å…¥ä»¥ä¸‹å†…å®¹ cat >/etc/ld.so.conf 3.3 è§£å‹ç¼©åŒ…ç¼–è¯‘å®‰è£… #è§£å‹ç¼©åŒ… tar xf php-7.3.19.tar.xz #è¿›å…¥è§£å‹åçš„ç›®å½• cd php-7.3.19 #ç¼–è¯‘å®‰è£… ./configure --prefix=/usr/local/php7-3-19 \\ --with-config-file-path=/usr/local/php7-3-19/etc \\ --with-fpm-user=www \\ --with-fpm-group=www \\ --with-fpm-systemd \\ --with-fpm-acl \\ --with-mysql-sock \\ --with-mysqli \\ --with-libxml-dir \\ --with-openssl \\ --with-mhash \\ --with-pcre-regex \\ --with-zlib \\ --with-iconv \\ --with-bz2 \\ --with-curl \\ --with-cdb \\ --with-pcre-dir \\ --with-gd \\ --with-openssl-dir \\ --with-jpeg-dir \\ --with-png-dir \\ --with-zlib-dir \\ --with-freetype-dir \\ --with-gettext \\ --with-gmp \\ --with-mhash \\ --with-onig \\ --with-pdo-mysql \\ --with-zlib-dir \\ --with-readline \\ --with-libxml-dir \\ --with-xsl \\ --with-pear \\ --enable-fpm \\ --enable-soap \\ --enable-bcmath \\ --enable-calendar \\ --enable-dom \\ --enable-exif \\ --enable-fileinfo \\ --enable-filter \\ --enable-ftp \\ --enable-json \\ --enable-mbstring \\ --enable-mbregex \\ --enable-mbregex-backtrack \\ --enable-pdo \\ --enable-session \\ --enable-shmop \\ --enable-simplexml \\ --enable-sockets \\ --enable-sysvmsg \\ --enable-sysvsem \\ --enable-sysvshm \\ --enable-zip \\ --enable-mysqlnd-compression-support make && make install 3.4 æ‹·è´ç›¸å…³æ–‡ä»¶ 3.4.1 åˆ›å»ºphpå®‰è£…ç›®å½•è½¯è¿æ¥ ln -s /usr/local/php7-3-19/ /usr/local/php 3.4.2 å¯¼å‡ºPATHç¯å¢ƒå˜é‡ echo 'export PATH=/usr/local/php/bin:$PATH' >/etc/profile.d/php.sh source /etc/profile 3.4.3 æ‹·è´php.iniæ–‡ä»¶ cp /opt/php-7.3.19/php.ini-development /usr/local/php/etc/php.ini 3.4.4 æ‹·è´php-fpmé…ç½®æ–‡ä»¶ cp /usr/local/php/etc/php-fpm.d/www.conf.default /usr/local/php/etc/php-fpm.conf 3.4.5 æ‹·è´php-fpmæœåŠ¡æ–‡ä»¶ cp /opt/php-7.3.19/sapi/fpm/php-fpm.service /usr/lib/systemd/system/php-fpm.service 3.4.6 å¯åŠ¨php-fpm systemctl daemon-reload && systemctl enable php-fpm && systemctl start php-fpm 3.4.7 æ£€æŸ¥php-fpmå¯åŠ¨ #phpé»˜è®¤ç›‘å¬tcp/9000ç«¯å£ $ netstat -ntpl|grep 9000 tcp 0 0 127.0.0.1:9000 0.0.0.0:* LISTEN 12392/php-fpm: mast 4.ç»“åˆnginxæµ‹è¯•php-fpmåŠŸèƒ½æ˜¯å¦æ­£å¸¸ 4.1 å®‰è£…nginxå¹¶å¯åŠ¨ #å®‰è£…nginx yum -y install nginx #é…ç½®nginxä»¥wwwç”¨æˆ·è¿è¡Œ sed -i.bak '/^user/c user www;' /etc/nginx/nginx.conf #å¯åŠ¨nginx systemctl start nginx 4.2 ç¼–è¾‘nginxé…ç½®æ–‡ä»¶ cat >/etc/nginx/conf.d/php-test.conf 4.3 é‡è½½nginx #æ£€æµ‹nginxè¯­æ³• $ nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful #é‡è½½nginx nginx -s reload 4.4 ç¼–è¾‘phpæµ‹è¯•é¡µé¢ cat >/opt/index.php EOF æœ¬æœºåšhostsè§£æï¼Œç„¶åæµè§ˆå™¨ç›´æ¥è®¿é—®åŸŸåå³å¯ï¼Œå› ä¸ºè¿™é‡Œé…ç½®çš„nginxæ ¹ç›®å½•ä¸‹åªæœ‰ä¸€ä¸ªindex.phpæ–‡ä»¶ï¼Œè¿”å›ç»“æœå¦‚ä¸‹å³ä¸ºæˆåŠŸ 5.å®‰è£…æ‰©å±•(å¯é€‰) 5.1 å®‰è£…redisæ‰©å±• 5.1.1 å®‰è£…æ–¹æ³•ä¸€ peclå®‰è£… pecl install redis echo \"extension=redis.so\" >> /usr/local/php/etc/php.ini 5.1.2 å®‰è£…æ–¹æ³•äºŒ æºç å®‰è£… ä»å®˜ç½‘ä¸­è·å–æœ€æ–°ç¨³å®šå‘è¡Œç‰ˆ github phpredisåœ°å€ 5.1.2.1 ä¸‹è½½åŒ… wget https://github.com/phpredis/phpredis/archive/5.2.2.tar.gz github phprediså®‰è£…è¯´æ˜ 5.1.2.2 è§£å‹ç¼©åŒ…å¹¶ç¼–è¯‘å®‰è£… #è§£å‹ç¼©åŒ… tar xf 5.2.2.tar.gz cd phpredis-5.2.2/ #ç”Ÿæˆconfigureæ–‡ä»¶ phpize ./configure --enable-redis-igbinary --enable-redis-msgpack --enable-redis-lzf --with-liblzf=/opt/phpredis-5.2.2 --enable-redis-zstd --with-php-config=/usr/local/php/bin/php-config #ç¼–è¯‘å®‰è£… make && make install #é…ç½®æ–‡ä»¶ä¸­å¯ç”¨redisæ¨¡å— echo \"extension=redis.so\" >> /usr/local/php/etc/php.ini æŠ¥é”™1 checking for igbinary includes... configure: error: Cannot find igbinary.h è§£å†³æ–¹æ³• pecl install igbinary echo \"extension=igbinary.so\" >> /usr/local/php/etc/php.ini æŠ¥é”™2 checking for msgpack includes... configure: error: Cannot find php_msgpack.h è§£å†³æ–¹æ³• pecl install msgpack echo \"extension=msgpack.so\" >> /usr/local/php/etc/php.ini 5.2 å®‰è£…mongoæ‰©å±• 5.2.1 å®‰è£…æ–¹æ³•ä¸€ peclå®‰è£… pecl install mongodb echo \"extension=mongodb.so\" >> /usr/local/php/etc/php.ini 5.2.2 å®‰è£…æ–¹æ³•äºŒ æºç å®‰è£… ä»å®˜ç½‘ä¸­è·å–æœ€æ–°ç¨³å®šå‘è¡Œç‰ˆ php mongodbé©±åŠ¨ç¨‹åºå®˜æ–¹è¯´æ˜ 5.2.2.1 ä¸‹è½½åŒ… wget https://pecl.php.net/get/mongodb-1.7.3.tgz 5.2.2.2 è§£å‹ç¼©åŒ…å¹¶ç¼–è¯‘å®‰è£… #è§£å‹ç¼©åŒ… tar xf mongodb-1.7.3.tgz cd mongodb-1.7.3 #ç”Ÿæˆconfigureæ–‡ä»¶ phpize ./configure --with-php-config=/usr/local/php/bin/php-config #ç¼–è¯‘å®‰è£… make && make install #é…ç½®æ–‡ä»¶ä¸­å¯ç”¨mongoæ¨¡å— echo \"extension=mongodb.so\" >> /usr/local/php/etc/php.ini phpæ ¸å¿ƒé…ç½®å‚æ•°åˆ—è¡¨ phpå®˜æ–¹æ ¸å¿ƒé…ç½®é€‰é¡¹åˆ—è¡¨ æ‚é¡¹é€‰é¡¹ å‚æ•° è¯´æ˜ --enable-debug ç¼–è¯‘æ—¶åŠ å…¥è°ƒè¯•ç¬¦å· --with-layout=TYPE è®¾ç½®è¢«å®‰è£…æ–‡ä»¶çš„å¸ƒå±€ã€‚TYPE æ˜¯ PHPï¼ˆé»˜è®¤ï¼‰æˆ– GNU --with-pear=DIR åœ¨ DIRï¼ˆé»˜è®¤ä¸º PREFIX/lib/phpï¼‰ä¸­å®‰è£… PEAR --without-pear ä¸å®‰è£… PEAR --enable-sigchild ä½¿ç”¨ PHP è‡ªå¸¦çš„ SIGCHLD å¤„ç†å™¨ --disable-rpath ç¦ç”¨åœ¨æœç´¢è·¯å¾„ä¸­ä¼ é€’å…¶ä»–è¿è¡Œåº“ --enable-libgcc å¯ç”¨ libgcc çš„ç²¾ç¡®é“¾æ¥ --enable-php-streams åŒ…å«è¯•éªŒæ€§çš„ PHP æµã€‚ä¸è¦ä½¿ç”¨æ­¤é€‰é¡¹ï¼Œé™¤éæ˜¯è¦æµ‹è¯•ä»£ç  --with-zlib-dir[=DIR] å®šä¹‰ zlib çš„å®‰è£…ç›®å½• --with-tsrm-pthreads ä½¿ç”¨ POSIX çº¿ç¨‹ï¼ˆé»˜è®¤ï¼‰ --enable-shared[=PKGS] ç¼–è¯‘å…±äº«åº“ [default=yes] --enable-static[=PKGS] ç¼–è¯‘é™æ€åº“ [default=yes] --enable-fast-install[=PKGS] ä¸ºå¿«é€Ÿå®‰è£…ä¼˜åŒ– [default=yes] --with-gnu-ld å‡è®¾ C ç¼–è¯‘å™¨ä½¿ç”¨ GNU ld [default=no] --disable-libtool-lock é¿å…é”æ­»ï¼ˆå¯èƒ½ç ´åå¹¶è”çš„ç¼–è¯‘ï¼‰ --with-pic å°è¯•ä»…ä½¿ç”¨ PIC/é PIC å¯¹è±¡ [default=use both] --enable-memory-limit ç¼–è¯‘å†…å­˜é™åˆ¶æ”¯æŒåŠŸèƒ½ã€‚(è‡ªPHP 5.2.1å¼€å§‹ä¸å¯ç”¨ï¼Œé»˜è®¤enable) --disable-url-fopen-wrapper ç¦ç”¨ URL å½¢å¼çš„ fopen å°è£…åè®®ã€‚è¯¥åè®®å…è®¸é€šè¿‡ HTTP æˆ–è€… FTP è®¿é—®æ–‡ä»¶ã€‚ ï¼ˆè‡ªPHP5.2.5å¼€å§‹ä¸å¯ç”¨ï¼‰ --enable-versioning ä»…å¯¼å‡ºå¿…é¡»çš„ç¬¦å·ã€‚æŸ¥çœ‹ INSTALL æ–‡ä»¶ä»¥è·å¾—æ›´å¤šä¿¡æ¯ phpé€‰é¡¹ å‚æ•° è¯´æ˜ --enable-maintainer-mode å¯¹å¶ç„¶å®‰è£…ä¸€ä¸‹çš„æƒ…å½¢å¯ç”¨æ­¤é€‰é¡¹ï¼Œä½¿å¾—ä¸æ£€æŸ¥ç¼–è¯‘è§„åˆ™å’Œä¾èµ–å…³ç³» --with-config-file-path=PATH è®¾ç½® php.ini çš„æœç´¢è·¯å¾„ã€‚é»˜è®¤ä¸º PREFIX/lib --disable-short-tags é»˜è®¤ç¦ç”¨çŸ­å½¢å¼çš„å¼€å§‹æ ‡ç­¾ --with-libdir æŒ‡å®šUxinç³»ç»Ÿåº“æ–‡ä»¶ç›®å½•ç”¨äºæ„å»º PHPã€‚ å¯¹äº64ä½ç³»ç»Ÿ, éœ€è¦æŒ‡å®š lib64 ç›®å½•,æ¯”å¦‚--with-libdir=lib64 SAPIé€‰é¡¹ ä¸‹é¢çš„åˆ—è¡¨åŒ…å« PHP å¯ç”¨çš„SAPIï¼ˆæœåŠ¡å™¨åº”ç”¨ç¼–ç¨‹æ¥å£ï¼‰ å‚æ•° è¯´æ˜ --with-aolserver=DIR æŒ‡å®š AOLserver çš„å®‰è£…è·¯å¾„ --with-apxs[=FILE] ç¼–è¯‘å…±äº«çš„ Apache æ¨¡å—ã€‚FILE æ˜¯å¯é€‰çš„ Apache apxs å·¥å…·çš„è·¯å¾„ï¼Œé»˜è®¤æŒ‡å‘ apxsã€‚è¯·ç¡®è®¤æŒ‡å®šçš„ apxs å·²ç»å®‰è£…åœ¨æœåŠ¡å™¨ä¸­ï¼Œå¹¶ä¸”å®ƒä¸æ˜¯ Apache æºç åŒ…ä¸­çš„é‚£ä¸ª apxs --with-apache[=DIR] ç¼–è¯‘é™æ€ Apache æ¨¡å—ã€‚DIR æ˜¯ Apache ç¼–è¯‘ç›®å½•çš„é¡¶å±‚ï¼Œé»˜è®¤ä¸º /usr/local/apache --with-mod_charset å¯ç”¨ mod_charset çš„è½¬æ¢è¡¨ï¼ˆä¿„æ–‡çš„ Apache ä½¿ç”¨ï¼‰ --with-apxs2[=FILE] ç¼–è¯‘å…±äº«çš„ Apache 2.0 æ¨¡å—ã€‚FILE æ˜¯å¯é€‰çš„ Apache apxs å·¥å…·çš„è·¯å¾„ï¼Œé»˜è®¤æŒ‡å‘ apxs --with-caudium=DIR ä¸ºä½¿ç”¨ Caudium ç¼–è¯‘ PHP ä¸ºä¸€ä¸ª Pike æ¨¡å—ã€‚DIR æ˜¯ Caudium æœåŠ¡å™¨ç›®å½•ï¼Œé»˜è®¤ä¸º /usr/local/caudium/server --disable-cli PHP 4.3.0 ä¹‹åçš„ç‰ˆæœ¬æœ‰æ•ˆã€‚ç¦æ­¢ç¼–è¯‘ PHP çš„ CLI ç‰ˆæœ¬ï¼ˆä½¿ç”¨å®ƒå°†åŒæ—¶å¼ºåˆ¶ä½¿ç”¨ --without-pear é€‰é¡¹ï¼‰ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥è€ƒ PHP çš„å‘½ä»¤è¡Œæ¨¡å¼ --enable-embed[=TYPE] å¯ç”¨ç¼–è¯‘åµŒå…¥çš„ SAPI åº“ã€‚TYPE æˆ–è€…ä¸º shared æˆ–è€…ä¸º staticï¼Œé»˜è®¤ä¸º sharedã€‚PHP 4.3.0 ä¹‹åçš„ç‰ˆæœ¬æœ‰æ•ˆ --with-fhttpd[=DIR] ç¼–è¯‘ fhttpd æ¨¡å—ã€‚DIR æ˜¯ fhttpd æºä»£ç ç›®å½•ï¼Œé»˜è®¤ä¸º /usr/local/src/fhttpdã€‚PHP 4.3.0 åŠä»¥åçš„ç‰ˆæœ¬æ­¤é€‰é¡¹ä¸å†æœ‰æ•ˆ --with-isapi=DIR ä¸º Zeus æœåŠ¡å™¨ä»¥ ISAPI æ¨¡å—æ–¹å¼ç¼–è¯‘ PHP --with-nsapi=DIR æŒ‡å®š Netscape/iPlanet/SunONE çš„å®‰è£…ç›®å½• --with-phttpd=DIR ç¼–è¯‘PHPä¸ºphttpdæ¨¡å— --with-pi3web=DIR ä¸º Pi3Web æœåŠ¡å™¨ç¼–è¯‘ PHP æ¨¡å— --with-roxen=DIR ä»¥ Pike æ¨¡å—æ–¹å¼ç¼–è¯‘ PHPã€‚DIR æ˜¯ Roxen çš„æ ¹ç›®å½•ï¼Œé»˜è®¤ä¸º /usr/local/roxen/server --enable-roxen-zts ä½¿ç”¨ Zend çº¿ç¨‹å®‰å…¨ï¼ˆZTSï¼‰ç¼–è¯‘ Roxen æ¨¡å— --with-servlet[=DIR] åŒ…å« servlet æ”¯æŒã€‚DIR æ˜¯ JSDK çš„å®‰è£…ç›®å½•ã€‚æ­¤ SAPI è¦æ±‚ java æ‰©å±•å¿…é¡»ä½œä¸ºå…±äº«æ¨¡å—ç¼–è¯‘åˆ° PHP ä¸­ --with-thttpd=SRCDIR ç¼–è¯‘ PHP ä¸º thttpd æ¨¡å— --with-tux=MODULEDIR ç¼–è¯‘ PHP ä¸º TUX æ¨¡å—ï¼ˆä»…åœ¨ Linux ä¸‹æœ‰æ•ˆï¼‰ --with-webjames=SRCDIR ç¼–è¯‘ PHP ä¸º WebJames æ¨¡å—ï¼ˆä»…åœ¨ RISC æ“ä½œç³»ç»Ÿä¸­æœ‰æ•ˆï¼‰ --disable-cgi ç¦æ­¢ç¼–è¯‘ CGI ç‰ˆæœ¬çš„ PHPã€‚PHP 4.3.0 ä¹‹åçš„ç‰ˆæœ¬æœ‰æ•ˆï¼ŒPHP5.3.0èµ·ï¼Œè¿™ä¸ªé€‰é¡¹ä¼šå¯ç”¨FastCGIï¼Œè€Œåœ¨ä»¥å‰ï¼Œå¿…é¡»ä½¿ç”¨--enable-fastcgiå¯ç”¨FastCGI --enable-force-cgi-redirect å¯ç”¨å†…éƒ¨æœåŠ¡å™¨é‡å®šå‘çš„å®‰å…¨æ£€æµ‹ã€‚å¦‚æœåœ¨ Apache ä¸‹ä½¿ç”¨ CGI ç‰ˆæœ¬çš„ PHPï¼Œè¯·å¯ç”¨è¯¥é€‰é¡¹ï¼ŒPHP 5.3.0èµ·ï¼Œé»˜è®¤æœ‰æ•ˆå¹¶ä¸å†å­˜åœ¨ã€‚è¦ç¦ç”¨æ­¤åŠŸèƒ½,è®¾ç½®cgi.force_redirect iniæŒ‡ä»¤ä¸º 0 --enable-discard-path å¦‚æœå¯ç”¨è¯¥é€‰é¡¹ï¼ŒPHP CGI ç›®å½•å¯ä»¥å®‰å…¨çš„æ”¾åœ¨ web ç›®å½•æ ‘çš„å¤–é¢ï¼Œäººä»¬æ— æ³•é¿å¼€ .htaccess çš„å®‰å…¨é™åˆ¶ï¼ŒPHP 5.3.0èµ·ï¼Œé»˜è®¤ç¦ç”¨å¹¶ä¸åœ¨å­˜åœ¨ã€‚è¦å¯ç”¨æ­¤åŠŸèƒ½ï¼Œè®¾ç½® cgi-redirect iniæŒ‡ä»¤ä¸º1 --enable-fastcgi å¦‚æœå¯ç”¨ï¼ŒCGI æ¨¡å—å°†è¢«ç¼–è¯‘ä¸ºæ”¯æŒ FastCGIã€‚PHP 4.3.0 ä¹‹åçš„ç‰ˆæœ¬æœ‰æ•ˆï¼ŒPHP 5.3.0èµ·ï¼Œæ­¤å‚æ•°ä¸å†å­˜åœ¨ï¼Œå¹¶ä½¿ç”¨ --enable-cgiæ›¿ä»£ --disable-path-info-check å¦‚æœè¯¥é€‰é¡¹è¢«ç¦ç”¨ï¼Œä¾‹å¦‚ /info.php/test?a=b å½¢å¼çš„è·¯å¾„å°†ä¸èƒ½å·¥ä½œã€‚PHP 4.3.0 ä¹‹åçš„ç‰ˆæœ¬æœ‰æ•ˆã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ Â» Apache æ‰‹å†Œ fpmé€‰é¡¹ å‚æ•° è¯´æ˜ --with-fpm-user è®¾ç½® FPM è¿è¡Œçš„ç”¨æˆ·èº«ä»½ï¼ˆé»˜è®¤ - nobodyï¼‰ --with-fpm-group è®¾ç½® FPM è¿è¡Œæ—¶çš„ç”¨æˆ·ç»„ï¼ˆé»˜è®¤ - nobodyï¼‰ --with-fpm-systemd å¯ç”¨ systemd é›†æˆ (é»˜è®¤ - no) --with-fpm-acl ä½¿ç”¨POSIX è®¿é—®æ§åˆ¶åˆ—è¡¨ (é»˜è®¤ - no) 5.6.5ç‰ˆæœ¬èµ·æœ‰æ•ˆ phpéƒ¨åˆ†ç¼–è¯‘å‚æ•°è¯´æ˜ï¼Œæ›´å¤šå‚æ•°ä½¿ç”¨å‘½ä»¤./configure --helpæŸ¥çœ‹ phpå®˜æ–¹å‡½æ•°å‚è€ƒè¯´æ˜åœ°å€ å‚æ•° è¯´æ˜ --prefix phpå®‰è£…çš„è·¯å¾„ --with-config-file-path phpé…ç½®æ–‡ä»¶è·¯å¾„ --with-fpm-user è®¾ç½® FPM è¿è¡Œçš„ç”¨æˆ·èº«ä»½ï¼ˆé»˜è®¤ - nobodyï¼‰ --with-fpm-group è®¾ç½® FPM è¿è¡Œæ—¶çš„ç”¨æˆ·ç»„ï¼ˆé»˜è®¤ - nobodyï¼‰ --with-fpm-systemd å¯ç”¨systemdé›†æˆï¼Œé»˜è®¤ä¸ºno --with-fpm-acl ä½¿ç”¨POSIX è®¿é—®æ§åˆ¶åˆ—è¡¨ (é»˜è®¤ - no) 5.6.5ç‰ˆæœ¬èµ·æœ‰æ•ˆ --with-mysql-sock è®¾ç½®ä¸ºæ‰€æœ‰MySQLæ‰©å±•ï¼ˆåŒ…æ‹¬PDO_MYSQLï¼‰çš„MySQL unixå¥—æ¥å­—æŒ‡é’ˆçš„ä½ç½® --with-mysqli æ”¯æŒmysqlæ‰©å±• --with-libxml-dir æ‰“å¼€libxml2åº“çš„æ”¯æŒ --with-openssl opensslçš„æ”¯æŒï¼ŒåŠ å¯†ä¼ è¾“æ—¶ç”¨åˆ°çš„ --with-mhash mhashç®—æ³•çš„æ‰©å±• --with-pcre-regex æ”¯æŒperlæ­£åˆ™è¡¨è¾¾å¼ --with-zlib æ”¯æŒzlibåº“ --with-iconv æ”¯æŒiconvå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å­—ç¬¦ç¼–ç å¼ºåˆ¶è½¬æ¢ --with-bz2 æ”¯æŒbz2æ–‡ä»¶ --with-curl æ”¯æŒcurlæµè§ˆå·¥å…· --with-cdb cdbåº“æ·»åŠ äº†cdb_makeå¤„ç†ç¨‹åºï¼Œè¯¥å¤„ç†ç¨‹åºå…è®¸åˆ›å»ºcdbæ–‡ä»¶å¹¶å…è®¸ä½¿ç”¨PHPçš„æµè®¿é—®ç½‘ç»œä¸Šçš„cdbæ–‡ä»¶ã€‚ --with-pcre-dir perlçš„æ­£åˆ™åº“æ¡ˆå®‰è£…ä½ç½® --with-gd æ”¯æŒgdåº“ --with-openssl-dir opensslå®‰è£…ä½ç½® --with-jpeg-dir æ”¯æŒjpegå›¾ç‰‡ --with-png-dir æ”¯æŒpngå›¾ç‰‡ --with-zlib-dir æ”¯æŒzlibåº“ --with-freetype-dir æ”¯æŒfreetypeå­—ä½“åº“ --with-gettext æ”¯æŒgnuçš„gettextï¼Œç¼–ç åº“ç”¨åˆ° --with-gmp æ”¯æŒgnuçš„mp --with-mhash æ”¯æŒmhashç®—æ³• --with-onig ä½¿ç”¨å¤–éƒ¨oniguruma --with-pdo-mysql PDO_MYSQLæ˜¯ä¸€ä¸ªé©±åŠ¨ç¨‹åºï¼Œè¯¥é©±åŠ¨ç¨‹åºå®ç°PHPæ•°æ®å¯¹è±¡ï¼ˆPDOï¼‰æ¥å£ ä»¥å…è®¸ä»PHPè®¿é—®MySQLæ•°æ®åº“ --with-zlib-dir zlibå®‰è£…ä½ç½® --with-readline æ”¯æŒreadlineåº“ --with-libxml-dir libxml2å®‰è£…ä½ç½® --with-xsl æ”¯æŒxsl --with-pear æ”¯æŒpear --enable-fpm å…è®¸fpm --enable-soap æ”¯æŒsoapï¼ŒSOAPæ‰©å±•å¯ç”¨äºç¼–å†™SOAPæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ --enable-bcmath æ”¯æŒç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„ä»»æ„å¤§å°å’Œç²¾åº¦çš„æ•°å­—çš„äºŒè¿›åˆ¶è®¡ç®— --enable-calendar æ”¯æŒæ—¥å†è½¬æ¢ --enable-dom æ”¯æŒdomæ‰©å±•ï¼ŒDOMæ‰©å±•ä½¿æ‚¨å¯ä»¥é€šè¿‡å¸¦æœ‰PHPçš„DOM APIå¯¹XMLæ–‡æ¡£è¿›è¡Œæ“ä½œ --enable-exif æ”¯æŒexifæ‰©å±•ï¼Œæ“ä½œå›¾åƒå…ƒæ•°æ® --enable-fileinfo æ”¯æŒfileinfoï¼Œæ–‡ä»¶ç»™å®šä½ç½®æŸ¥æ‰¾ç‰¹å®šé­”æœ¯å­—èŠ‚çŒœæµ‹æ–‡ä»¶çš„å†…å®¹ç±»å‹ä»¥åŠç¼–ç  --enable-filter æ”¯æŒfilterï¼Œé€šè¿‡éªŒè¯æˆ–æ¸…é™¤æ•°æ®æ¥è¿‡æ»¤æ•°æ® --enable-ftp æ”¯æŒftp --enable-json æ”¯æŒjson --enable-mbstring æ”¯æŒå¤šå­—èŠ‚å­—ç¬¦ä¸² --enable-mbregex æ”¯æŒå¤šå­—èŠ‚æ­£åˆ™è¡¨è¾¾å¼ --enable-pdo æ”¯æŒphpæ•°æ®å¯¹è±¡ --enable-session æ”¯æŒ session --enable-shmop æ”¯æŒshmopï¼Œå…è®¸PHPè¯»å–ã€å†™å…¥ã€åˆ›å»ºå’Œåˆ é™¤Unixå…±äº«å†…å­˜æ®µçš„å‡½æ•°é›† --enable-simplexml æ”¯æŒsimplexmlï¼Œå°†XMLè½¬æ¢æˆä¸€ä¸ªå¸¦æœ‰ä¸€èˆ¬å±æ€§é€‰æ‹©å™¨å’Œæ•°ç»„è¿­ä»£å™¨çš„å¯¹è±¡ --enable-sockets æ”¯æŒsocket --enable-sysvmsg æ”¯æŒsysvmsgæ¶ˆæ¯é˜Ÿåˆ— --enable-sysvsem æ”¯æŒç³»ç»ŸVä¿¡å·é‡ --enable-sysvshm æ”¯æŒsysvshmï¼Œå®ç°è¿›ç¨‹é—´é€šä¿¡å…±äº«å†…å­˜çš„æ“ä½œ --enable-zip æ”¯æŒzipå‹ç¼© --enable-mysqlnd-compression-support æ”¯æŒmysqlå‹ç¼© æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/tomcat/centos7äºŒè¿›åˆ¶å®‰è£…tomcat8.html":{"url":"linux/linuxæœåŠ¡/tomcat/centos7äºŒè¿›åˆ¶å®‰è£…tomcat8.html","title":"centos7äºŒè¿›åˆ¶å®‰è£…tomcat","keywords":"","body":"centos7äºŒè¿›åˆ¶å®‰è£…tomcat8 tomcatå®˜ç½‘ tomcatå®˜æ–¹å®‰è£…æ–‡æ¡£ 1.ä¸‹è½½å®‰è£…åŒ… wget https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.56/bin/apache-tomcat-8.5.56.tar.gz 2.è§£å‹ç¼©åŒ… tar xf apache-tomcat-8.5.56.tar.gz -C /usr/local/ 3.åšè½¯è¿æ¥ ln -s /usr/local/apache-tomcat-8.5.56/ /usr/local/tomcat-8.5.56 4.å®‰è£…jdk oracle jdkå®˜æ–¹ä¸‹è½½åœ°å€ è¿™é‡Œé€‰æ‹©ä¸‹è½½taråŒ…ï¼Œå› ä¸ºä¸‹è½½jdkéœ€è¦ç™»é™†oracleè´¦å·ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨wget $ ls jdk-8u251-linux-x64.tar.gz è§£å‹ç¼©åŒ… tar xf jdk-8u251-linux-x64.tar.gz -C /usr/local å¯¼å‡ºç¯å¢ƒå˜é‡ #å¯¼å‡ºjdkç¯å¢ƒå˜é‡ cat >/etc/profile.d/jdk8.sh 5.ä½¿ç”¨systemdç®¡ç†tomcat 5.1 ä¸ºTomcatæ·»åŠ å¯åŠ¨å‚æ•° catalina.shåœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šè°ƒç”¨åŒçº§è·¯å¾„ä¸‹çš„setenv.shæ¥è®¾ç½®é¢å¤–çš„ç¯å¢ƒå˜é‡ï¼Œå› æ­¤åœ¨/usr/local/tomcat-8.5.56/binè·¯å¾„ä¸‹åˆ›å»ºsetenv.shæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ cat >/usr/local/tomcat-8.5.56/bin/setenv.sh JVMé€‰é¡¹è¯´æ˜ JAVA_OPTS='-Xmsã€åˆå§‹åŒ–å†…å­˜å¤§å°ã€‘ -Xmxã€å¯ä»¥ä½¿ç”¨çš„æœ€å¤§å†…å­˜ã€‘' 5.2 ç¼–å†™tomcat.serviceæ–‡ä»¶ åœ¨/usr/lib/systemd/systemè·¯å¾„ä¸‹æ·»åŠ tomcat.serviceæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š cat >/usr/lib/systemd/system/tomcat.service å‚æ•°è¯´æ˜ [unit] é…ç½®äº†æœåŠ¡çš„æè¿°ï¼Œè§„å®šäº†åœ¨networkå¯åŠ¨ä¹‹åæ‰§è¡Œ [service] é…ç½®æœåŠ¡çš„pidï¼ŒæœåŠ¡çš„å¯åŠ¨ï¼Œåœæ­¢ï¼Œé‡å¯ [install] é…ç½®äº†ä½¿ç”¨ç”¨æˆ· 5.3 ä¿®æ”¹tomcat binç›®å½•ä¸‹çš„catalina.sh åœ¨catalina.shæ–‡ä»¶ä¸­ç¬¬2è¡Œå¼€å§‹æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œå¯¼å‡ºJAVA_HOMEå’ŒJRE_HOMEç¯å¢ƒå˜é‡ sed -i.bak '2cexport JAVA_HOME=/usr/local/jdk1.8.0_251\\nexport JRE_HOME=/usr/local/jdk1.8.0_251/jre' /usr/local/tomcat-8.5.56/bin/catalina.sh 6.å¯åŠ¨tomcat systemctl daemon-reload systemctl start tomcat && systemctl enable tomcat æµè§ˆå™¨è®¿é—®8080ç«¯å£ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/supervisor/1.supervisorå®‰è£….html":{"url":"linux/linuxæœåŠ¡/supervisor/1.supervisorå®‰è£….html","title":"supervisorå®‰è£…","keywords":"","body":"supervisorå®‰è£… ä¸€ã€Supervisorç®€ä»‹ Supervisor githubåœ°å€ Supervisorå®˜ç½‘ 1.1 å®˜ç½‘å¯¹äºSupervisorçš„ä»‹ç» 1.1.1 æ€»è§ˆ Supervisoræ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯/æœåŠ¡å™¨ç³»ç»Ÿï¼Œå…è®¸å…¶ç”¨æˆ·æ§åˆ¶ç±»ä¼¼UNIXçš„æ“ä½œç³»ç»Ÿä¸Šçš„è®¸å¤šè¿›ç¨‹ã€‚å®ƒå—åˆ°ä»¥ä¸‹æ–¹é¢çš„å¯å‘ æ–¹ä¾¿ éœ€è¦ä¸ºæ¯ä¸ªå•ä¸ªæµç¨‹å®ä¾‹ç¼–å†™rc.dè„šæœ¬é€šå¸¸å¾ˆä¸æ–¹ä¾¿ã€‚ rc.dè„šæœ¬æ˜¯è¿›ç¨‹åˆå§‹åŒ–/è‡ªåŠ¨å¯åŠ¨/ç®¡ç†çš„ä¸€ä¸ªå¾ˆå¥½çš„æœ€ä½å…¬åˆ†æ¯å½¢å¼ï¼Œä½†æ˜¯ç¼–å†™å’Œç»´æŠ¤å®ƒä»¬å¯èƒ½å¾ˆéº»çƒ¦ã€‚æ­¤å¤–ï¼Œrc.dè„šæœ¬æ— æ³•è‡ªåŠ¨é‡æ–°å¯åŠ¨å´©æºƒçš„è¿›ç¨‹ï¼Œå¹¶ä¸”è®¸å¤šç¨‹åºåœ¨å´©æºƒæ—¶æ— æ³•æ­£ç¡®åœ°è‡ªè¡Œé‡å¯ã€‚Supervisordå°†è¿›ç¨‹ä½œä¸ºå…¶å­è¿›ç¨‹å¯åŠ¨ï¼Œå¹¶ä¸”å¯ä»¥é…ç½®ä¸ºåœ¨å´©æºƒæ—¶è‡ªåŠ¨é‡æ–°å¯åŠ¨å®ƒä»¬ã€‚ä¹Ÿå¯ä»¥å°†å…¶è‡ªåŠ¨é…ç½®ä¸ºè‡ªè¡Œè°ƒç”¨å¯åŠ¨è¿›ç¨‹ã€‚ å‡†ç¡®æ€§ åœ¨UNIXä¸Šï¼Œé€šå¸¸å¾ˆéš¾è·å¾—å‡†ç¡®çš„å¯åŠ¨/å…³é—­çŠ¶æ€ä¿¡æ¯ã€‚Pidfileç»å¸¸è¯´è°ã€‚Supervisordå°†æµç¨‹ä½œä¸ºå­æµç¨‹å¯åŠ¨ï¼Œå› æ­¤å®ƒå§‹ç»ˆçŸ¥é“å…¶å­çº§çš„çœŸå®ä¸Š/ä¸‹çŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥æ–¹ä¾¿åœ°æŸ¥è¯¢è¯¥æ•°æ®ã€‚ æˆæƒ éœ€è¦æ§åˆ¶æµç¨‹çŠ¶æ€çš„ç”¨æˆ·é€šå¸¸åªéœ€è¦è¿™æ ·åšã€‚ä»–ä»¬ä¸å¸Œæœ›æˆ–ä¸éœ€è¦å®Œå…¨çš„Shellè®¿é—®è¿è¡Œè¿™äº›è¿›ç¨‹çš„è®¡ç®—æœºã€‚ä¾¦å¬\"ä½\" TCPç«¯å£çš„è¿›ç¨‹é€šå¸¸éœ€è¦ä»¥rootç”¨æˆ·èº«ä»½å¯åŠ¨å’Œé‡æ–°å¯åŠ¨ï¼ˆUNIXåŠŸèƒ½ä¸å…¨ï¼‰ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå…è®¸\"æ­£å¸¸\"äººå‘˜åœæ­¢æˆ–é‡æ–°å¯åŠ¨è¿™æ ·çš„è¿‡ç¨‹æ˜¯å®Œå…¨å¯ä»¥çš„ï¼Œä½†æ˜¯ä¸ºä»–ä»¬æä¾›shellè®¿é—®é€šå¸¸æ˜¯ä¸åˆ‡å®é™…çš„ï¼Œå¹¶ä¸”ä¸ºä»–ä»¬æä¾›rootè®¿é—®æˆ–sudoè®¿é—®é€šå¸¸æ˜¯ä¸å¯èƒ½çš„ã€‚ï¼ˆæ­£ç¡®ï¼‰ä¹Ÿå¾ˆéš¾å‘ä»–ä»¬è§£é‡Šä¸ºä»€ä¹ˆå­˜åœ¨æ­¤é—®é¢˜ã€‚å¦‚æœè¶…çº§ç”¨æˆ·ä»¥rootç”¨æˆ·èº«ä»½å¯åŠ¨ï¼Œåˆ™å¯ä»¥å…è®¸\"æ™®é€š\"ç”¨æˆ·æ§åˆ¶æ­¤ç±»è¿‡ç¨‹ï¼Œè€Œæ— éœ€å‘ä»–ä»¬è§£é‡Šé—®é¢˜çš„å¤æ‚æ€§ã€‚Supervisorctlå…è®¸ä»¥éå¸¸æœ‰é™çš„å½¢å¼è®¿é—®è®¡ç®—æœºï¼Œ è¿›ç¨‹ç»„ æµç¨‹é€šå¸¸éœ€è¦æˆç»„åœ°å¯åŠ¨å’Œåœæ­¢ï¼Œæœ‰æ—¶ç”šè‡³éœ€è¦æŒ‰ç…§\"ä¼˜å…ˆçº§é¡ºåº\"è¿›è¡Œã€‚é€šå¸¸å¾ˆéš¾å‘äººä»¬è§£é‡Šå¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œã€‚Supervisorå…è®¸æ‚¨ä¸ºè¿›ç¨‹åˆ†é…ä¼˜å…ˆçº§ï¼Œå¹¶å…è®¸ç”¨æˆ·é€šè¿‡Supervisorctlå®¢æˆ·ç«¯å‘å‡ºå‘½ä»¤ï¼Œå¦‚\"å…¨éƒ¨å¯åŠ¨\"å’Œ\"å…¨éƒ¨é‡æ–°å¯åŠ¨\"ï¼Œè¿™å°†æŒ‰é¢„å…ˆåˆ†é…çš„ä¼˜å…ˆçº§é¡ºåºå¯åŠ¨å®ƒä»¬ã€‚æ­¤å¤–ï¼Œå¯ä»¥å°†è¿›ç¨‹åˆ†ä¸º\"è¿›ç¨‹ç»„\"ï¼Œå¹¶ä¸”å¯ä»¥å°†ä¸€ç»„é€»è¾‘ç›¸å…³çš„è¿›ç¨‹ä½œä¸ºä¸€ä¸ªå•å…ƒåœæ­¢å’Œå¯åŠ¨ã€‚ 1.1.2 ç‰¹å¾ ç®€å• é€šè¿‡ç®€å•æ˜“æ‡‚çš„INIæ ·å¼é…ç½®æ–‡ä»¶é…ç½®Supervisorã€‚å®ƒæä¾›äº†è®¸å¤šæŒ‰è¿›ç¨‹é€‰æ‹©çš„é€‰é¡¹ï¼Œä½¿æ‚¨çš„ç”Ÿæ´»æ›´åŠ è½»æ¾ï¼Œä¾‹å¦‚é‡æ–°å¯åŠ¨å¤±è´¥çš„è¿›ç¨‹å’Œè‡ªåŠ¨æ—¥å¿—è½®æ¢ã€‚ é›†ä¸­ Supervisorä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªå¼€å§‹ï¼Œåœæ­¢å’Œç›‘è§†è¿‡ç¨‹çš„åœ°æ–¹ã€‚å¯ä»¥å•ç‹¬æˆ–æˆç»„æ§åˆ¶è¿‡ç¨‹ã€‚æ‚¨å¯ä»¥é…ç½®Supervisorä»¥æä¾›æœ¬åœ°æˆ–è¿œç¨‹å‘½ä»¤è¡Œå’ŒWebç•Œé¢ã€‚ é«˜æ•ˆçš„ Supervisoré€šè¿‡fork / execå¯åŠ¨å…¶å­è¿›ç¨‹ï¼Œå¹¶ä¸”å­è¿›ç¨‹ä¸å®ˆæŠ¤ã€‚è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šç«‹å³å‘Supervisorå‘é€ä¿¡å·ï¼Œè¿™ä¸æŸäº›ä¾èµ–éº»çƒ¦çš„PIDæ–‡ä»¶å’Œå®šæœŸè½®è¯¢ä»¥é‡æ–°å¯åŠ¨å¤±è´¥çš„è¿›ç¨‹çš„è§£å†³æ–¹æ¡ˆä¸åŒã€‚ å¯æ‰©å±•çš„ Supervisorå…·æœ‰ä¸€ä¸ªç®€å•çš„äº‹ä»¶é€šçŸ¥åè®®ï¼Œè¯¥åè®®å¯ä»¥ä½¿ç”¨ä»»ä½•è¯­è¨€ç¼–å†™çš„ç¨‹åºå¯¹å…¶è¿›è¡Œç›‘è§†ï¼Œå¹¶ä¸”å…·æœ‰ç”¨äºæ§åˆ¶çš„XML-RPCæ¥å£ã€‚å®ƒè¿˜ä½¿ç”¨æ‰©å±•ç‚¹æ„å»ºï¼ŒPythonå¼€å‘äººå‘˜å¯ä»¥åˆ©ç”¨è¿™äº›æ‰©å±•ç‚¹ã€‚ å…¼å®¹ é™¤Windowså¤–ï¼ŒSupervisorå‡ ä¹é€‚ç”¨äºæ‰€æœ‰å…¶ä»–æ–¹é¢ã€‚å®ƒå·²åœ¨Linuxï¼ŒMac OS Xï¼ŒSolariså’ŒFreeBSDä¸Šç»è¿‡æµ‹è¯•å’Œæ”¯æŒã€‚å®ƒå®Œå…¨ç”¨Pythonç¼–å†™ï¼Œå› æ­¤å®‰è£…ä¸éœ€è¦Cç¼–è¯‘å™¨ã€‚ ä¹…ç»è€ƒéªŒ å°½ç®¡Supervisorå¦‚ä»Šéå¸¸æ´»è·ƒï¼Œä½†å®ƒä¸æ˜¯æ–°è½¯ä»¶ã€‚Supervisorå·²ç»å­˜åœ¨äº†å¾ˆå¤šå¹´ï¼Œå¹¶ä¸”å·²ç»åœ¨è®¸å¤šæœåŠ¡å™¨ä¸Šä½¿ç”¨ã€‚ 1.1.3 Supervisorç»„ä»¶ supervisord æœåŠ¡å™¨Supervisorçš„åç§°ä¸ºsupervisorã€‚å®ƒè´Ÿè´£è‡ªè¡Œè°ƒç”¨å¯åŠ¨å­ç¨‹åºï¼Œå“åº”æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œé‡æ–°å¯åŠ¨å´©æºƒæˆ–é€€å‡ºçš„å­è¿›ç¨‹ï¼Œè®°å½•å…¶å­è¿›ç¨‹stdoutå’Œstderr è¾“å‡ºä»¥åŠç”Ÿæˆå’Œå¤„ç†ä¸å­è¿›ç¨‹ç”Ÿå­˜æœŸä¸­çš„ç‚¹ç›¸å¯¹åº”çš„\"äº‹ä»¶\"ã€‚ æœåŠ¡å™¨è¿›ç¨‹ä½¿ç”¨é…ç½®æ–‡ä»¶ã€‚å®ƒé€šå¸¸ä½äº/etc/supervisord.confä¸­ã€‚æ­¤é…ç½®æ–‡ä»¶æ˜¯\" Windows-INI\"æ ·å¼çš„é…ç½®æ–‡ä»¶ã€‚é€šè¿‡é€‚å½“çš„æ–‡ä»¶ç³»ç»Ÿæƒé™æ¥ç¡®ä¿æ­¤æ–‡ä»¶çš„å®‰å…¨å¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒå¯èƒ½åŒ…å«æœªåŠ å¯†çš„ç”¨æˆ·åå’Œå¯†ç ã€‚ supervisorctl Supervisorçš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯åä¸º supervisorctlã€‚å®ƒæä¾›äº†ç±»ä¼¼äºshellçš„ç•Œé¢ï¼Œå¯ä¸supervisoræä¾›çš„åŠŸèƒ½ç»“åˆä½¿ç”¨ã€‚ä» supervisorctlï¼Œç”¨æˆ·å¯ä»¥è¿æ¥åˆ°ä¸åŒçš„ supervisordè¿›ç¨‹ï¼ˆä¸€æ¬¡ä¸€ä¸ªï¼‰ï¼Œå¯¹ï¼Œåœæ­¢æ§åˆ¶çš„å­æµç¨‹è·å¾—åœ°ä½å’Œå¯åŠ¨çš„å­è¿›ç¨‹ï¼Œå¹¶è·å¾—è¿è¡Œçš„è¿›ç¨‹çš„åˆ—è¡¨supervisordã€‚ å‘½ä»¤è¡Œå®¢æˆ·ç«¯é€šè¿‡UNIXåŸŸå¥—æ¥å­—æˆ–Internetï¼ˆTCPï¼‰å¥—æ¥å­—ä¸æœåŠ¡å™¨å¯¹è¯ã€‚æœåŠ¡å™¨å¯ä»¥æ–­è¨€å®¢æˆ·ç«¯çš„ç”¨æˆ·åº”è¯¥åœ¨å…è®¸å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤ä¹‹å‰å‡ºç¤ºèº«ä»½éªŒè¯å‡­æ®ã€‚å®¢æˆ·ç«¯è¿›ç¨‹é€šå¸¸ä½¿ç”¨ä¸æœåŠ¡å™¨ç›¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯ä»»ä½•å¸¦æœ‰[supervisorctl]èŠ‚çš„é…ç½®æ–‡ä»¶éƒ½å¯ä»¥ä½¿ç”¨ã€‚ Web Server ä¸åŠŸèƒ½åª²ç¾Aï¼ˆç¨€ç–ï¼‰çš„Webç”¨æˆ·ç•Œé¢ supervisorctlå¯ä»¥é€šè¿‡æµè§ˆå™¨ï¼Œå¦‚æœä½ å¼€å§‹è®¿é—® supervisordå¯¹äº’è”ç½‘æ’åº§ã€‚æ¿€æ´»é…ç½®æ–‡ä»¶çš„[inet_http_server]éƒ¨åˆ†åï¼Œè¯·è®¿é—®æœåŠ¡å™¨URLï¼ˆä¾‹å¦‚http://localhost:9001/ï¼‰ä»¥é€šè¿‡Webç•Œé¢æŸ¥çœ‹å’Œæ§åˆ¶è¿›ç¨‹çŠ¶æ€ã€‚ XML-RPC Interface æœåŠ¡äºWeb UIçš„åŒä¸€HTTPæœåŠ¡å™¨æä¾›XML-RPCæ¥å£ï¼Œè¯¥æ¥å£å¯ç”¨äºè¯¢é—®å’Œæ§åˆ¶ç®¡ç†ç¨‹åºåŠå…¶è¿è¡Œçš„ç¨‹åºã€‚è¯·å‚é˜…XML-RPC APIæ–‡æ¡£ã€‚ äºŒã€å®‰è£…supervisor 2.1 ç³»ç»Ÿpythonç¯å¢ƒ $ python -V Python 2.7.5 2.2 å®‰è£…suprvisor é…ç½®å›½å†…pipæº mkdir ~/.pip cat > .pip/pip.conf å®‰è£…æœ€æ–°ç‰ˆ #æ–¹æ³•ä¸€ pip install supervisor #æ–¹æ³•äºŒ yum -y install python-setuptools easy_install supervisor #æŸ¥çœ‹ç‰ˆæœ¬ $ supervisord -v 4.2.0 å®‰è£…æŒ‡å®šç‰ˆæœ¬ pip install supervisor==3.3.5 ä¸‰ã€é…ç½®supervisor 3.1 è¿è¡Œecho_supervisord_confå‘½ä»¤ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶ è¿è¡Œecho_supervisord_confå‘½ä»¤ï¼Œä¼šåœ¨å½“å‰ç»ˆç«¯çš„æ ‡å‡†è¾“å‡ºä¸­æ‰“å°ä¸€ä¸ªæ ·æœ¬Supervisoré…ç½®æ–‡ä»¶ $ echo_supervisord_conf ; Sample supervisor config file. ; ; For more information on the config file, please see: ; http://supervisord.org/configuration.html ; ; Notes: ; - Shell expansion (\"~\" or \"$HOME\") is not supported. Environment ; variables can be expanded using this syntax: \"%(ENV_HOME)s\". ; - Quotes around values are not supported, except in the case of ; the environment= options as shown below. ; - Comments must have a leading space: \"a=b ;comment\" not \"a=b;comment\". ; - Command will be truncated if it looks like a config file comment, e.g. ; \"command=bash -c 'foo ; bar'\" will truncate to \"command=bash -c 'foo \". ; ; Warning: ; Paths throughout this example file use /tmp because it is available on most ; systems. You will likely need to change these to locations more appropriate ; for your system. Some systems periodically delete older files in /tmp. ; Notably, if the socket file defined in the [unix_http_server] section below ; is deleted, supervisorctl will be unable to connect to supervisord. [unix_http_server] file=/tmp/supervisor.sock ; the path to the socket file ;chmod=0700 ; socket file mode (default 0700) ;chown=nobody:nogroup ; socket file uid:gid owner ;username=user ; default is no username (open server) ;password=123 ; default is no password (open server) ; Security Warning: ; The inet HTTP server is not enabled by default. The inet HTTP server is ; enabled by uncommenting the [inet_http_server] section below. The inet ; HTTP server is intended for use within a trusted environment only. It ; should only be bound to localhost or only accessible from within an ; isolated, trusted network. The inet HTTP server does not support any ; form of encryption. The inet HTTP server does not use authentication ; by default (see the username= and password= options to add authentication). ; Never expose the inet HTTP server to the public internet. ;[inet_http_server] ; inet (TCP) server disabled by default ;port=127.0.0.1:9001 ; ip_address:port specifier, *:port for all iface ;username=user ; default is no username (open server) ;password=123 ; default is no password (open server) [supervisord] logfile=/tmp/supervisord.log ; main log file; default $CWD/supervisord.log logfile_maxbytes=50MB ; max main logfile bytes b4 rotation; default 50MB logfile_backups=10 ; # of main logfile backups; 0 means none, default 10 loglevel=info ; log level; default info; others: debug,warn,trace pidfile=/tmp/supervisord.pid ; supervisord pidfile; default supervisord.pid nodaemon=false ; start in foreground if true; default false silent=false ; no logs to stdout if true; default false minfds=1024 ; min. avail startup file descriptors; default 1024 minprocs=200 ; min. avail process descriptors;default 200 ;umask=022 ; process file creation umask; default 022 ;user=supervisord ; setuid to this UNIX account at startup; recommended if root ;identifier=supervisor ; supervisord identifier, default is 'supervisor' ;directory=/tmp ; default is not to cd during start ;nocleanup=true ; don't clean up tempfiles at start; default false ;childlogdir=/tmp ; 'AUTO' child log dir, default $TEMP ;environment=KEY=\"value\" ; key value pairs to add to environment ;strip_ansi=false ; strip ansi escape codes in logs; def. false ; The rpcinterface:supervisor section must remain in the config file for ; RPC (supervisorctl/web interface) to work. Additional interfaces may be ; added by defining them in separate [rpcinterface:x] sections. [rpcinterface:supervisor] supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface ; The supervisorctl section configures how supervisorctl will connect to ; supervisord. configure it match the settings in either the unix_http_server ; or inet_http_server section. [supervisorctl] serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL for a unix socket ;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket ;username=chris ; should be same as in [*_http_server] if set ;password=123 ; should be same as in [*_http_server] if set ;prompt=mysupervisor ; cmd line prompt (default \"supervisor\") ;history_file=~/.sc_history ; use readline history if available ; The sample program section below shows all possible program subsection values. ; Create one or more 'real' program: sections to be able to control them under ; supervisor. ;[program:theprogramname] ;command=/bin/cat ; the program (relative uses PATH, can take args) ;process_name=%(program_name)s ; process_name expr (default %(program_name)s) ;numprocs=1 ; number of processes copies to start (def 1) ;directory=/tmp ; directory to cwd to before exec (def no cwd) ;umask=022 ; umask for process (default None) ;priority=999 ; the relative start priority (default 999) ;autostart=true ; start at supervisord start (default: true) ;startsecs=1 ; # of secs prog must stay up to be running (def. 1) ;startretries=3 ; max # of serial start failures when starting (default 3) ;autorestart=unexpected ; when to restart if exited after running (def: unexpected) ;exitcodes=0 ; 'expected' exit codes used with autorestart (default 0) ;stopsignal=QUIT ; signal used to kill process (default TERM) ;stopwaitsecs=10 ; max num secs to wait b4 SIGKILL (default 10) ;stopasgroup=false ; send stop signal to the UNIX process group (default false) ;killasgroup=false ; SIGKILL the UNIX process group (def false) ;user=chrism ; setuid to this UNIX account to run the program ;redirect_stderr=true ; redirect proc stderr to stdout (default false) ;stdout_logfile=/a/path ; stdout log path, NONE for none; default AUTO ;stdout_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) ;stdout_logfile_backups=10 ; # of stdout logfile backups (0 means none, default 10) ;stdout_capture_maxbytes=1MB ; number of bytes in 'capturemode' (default 0) ;stdout_events_enabled=false ; emit events on stdout writes (default false) ;stdout_syslog=false ; send stdout to syslog with process name (default false) ;stderr_logfile=/a/path ; stderr log path, NONE for none; default AUTO ;stderr_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) ;stderr_logfile_backups=10 ; # of stderr logfile backups (0 means none, default 10) ;stderr_capture_maxbytes=1MB ; number of bytes in 'capturemode' (default 0) ;stderr_events_enabled=false ; emit events on stderr writes (default false) ;stderr_syslog=false ; send stderr to syslog with process name (default false) ;environment=A=\"1\",B=\"2\" ; process environment additions (def no adds) ;serverurl=AUTO ; override serverurl computation (childutils) ; The sample eventlistener section below shows all possible eventlistener ; subsection values. Create one or more 'real' eventlistener: sections to be ; able to handle event notifications sent by supervisord. ;[eventlistener:theeventlistenername] ;command=/bin/eventlistener ; the program (relative uses PATH, can take args) ;process_name=%(program_name)s ; process_name expr (default %(program_name)s) ;numprocs=1 ; number of processes copies to start (def 1) ;events=EVENT ; event notif. types to subscribe to (req'd) ;buffer_size=10 ; event buffer queue size (default 10) ;directory=/tmp ; directory to cwd to before exec (def no cwd) ;umask=022 ; umask for process (default None) ;priority=-1 ; the relative start priority (default -1) ;autostart=true ; start at supervisord start (default: true) ;startsecs=1 ; # of secs prog must stay up to be running (def. 1) ;startretries=3 ; max # of serial start failures when starting (default 3) ;autorestart=unexpected ; autorestart if exited after running (def: unexpected) ;exitcodes=0 ; 'expected' exit codes used with autorestart (default 0) ;stopsignal=QUIT ; signal used to kill process (default TERM) ;stopwaitsecs=10 ; max num secs to wait b4 SIGKILL (default 10) ;stopasgroup=false ; send stop signal to the UNIX process group (default false) ;killasgroup=false ; SIGKILL the UNIX process group (def false) ;user=chrism ; setuid to this UNIX account to run the program ;redirect_stderr=false ; redirect_stderr=true is not allowed for eventlisteners ;stdout_logfile=/a/path ; stdout log path, NONE for none; default AUTO ;stdout_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) ;stdout_logfile_backups=10 ; # of stdout logfile backups (0 means none, default 10) ;stdout_events_enabled=false ; emit events on stdout writes (default false) ;stdout_syslog=false ; send stdout to syslog with process name (default false) ;stderr_logfile=/a/path ; stderr log path, NONE for none; default AUTO ;stderr_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) ;stderr_logfile_backups=10 ; # of stderr logfile backups (0 means none, default 10) ;stderr_events_enabled=false ; emit events on stderr writes (default false) ;stderr_syslog=false ; send stderr to syslog with process name (default false) ;environment=A=\"1\",B=\"2\" ; process environment additions ;serverurl=AUTO ; override serverurl computation (childutils) ; The sample group section below shows all possible group values. Create one ; or more 'real' group: sections to create \"heterogeneous\" process groups. ;[group:thegroupname] ;programs=progname1,progname2 ; each refers to 'x' in [program:x] definitions ;priority=999 ; the relative start priority (default 999) ; The [include] section can just contain the \"files\" setting. This ; setting can list multiple files (separated by whitespace or ; newlines). It can also contain wildcards. The filenames are ; interpreted as relative to this file. Included files *cannot* ; include files themselves. ;[include] ;files = relative/directory/*.ini å»æ‰æ³¨é‡Šåçš„å†…å®¹å¦‚ä¸‹ $ echo_supervisord_conf > hehe $ egrep -v '^$|^;' hehe [unix_http_server] file=/tmp/supervisor.sock ; the path to the socket file [supervisord] logfile=/tmp/supervisord.log ; main log file; default $CWD/supervisord.log logfile_maxbytes=50MB ; max main logfile bytes b4 rotation; default 50MB logfile_backups=10 ; # of main logfile backups; 0 means none, default 10 loglevel=info ; log level; default info; others: debug,warn,trace pidfile=/tmp/supervisord.pid ; supervisord pidfile; default supervisord.pid nodaemon=false ; start in foreground if true; default false silent=false ; no logs to stdout if true; default false minfds=1024 ; min. avail startup file descriptors; default 1024 minprocs=200 ; min. avail process descriptors;default 200 [rpcinterface:supervisor] supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface [supervisorctl] serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL for a unix socket ä»¥ä¸Šå°±æ˜¯supervisorçš„é»˜è®¤é…ç½®æ–‡ä»¶ 3.2 supervisoræŸ¥æ‰¾é…ç½®æ–‡ä»¶çš„é¡ºåº supervisoré…ç½®æ–‡ä»¶é€šå¸¸è¢«å‘½åä¸ºsupervisor.confï¼Œsupervisorå’Œsupervisorctléƒ½ä½¿ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¦‚æœåœ¨æ²¡æœ‰-cé€‰é¡¹çš„æƒ…å†µä¸‹å¯åŠ¨äº†ä»»ä¸€åº”ç”¨ç¨‹åºï¼ˆè¯¥é€‰é¡¹ç”¨äºæ˜¾å¼å‘ŠçŸ¥åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶åï¼‰ï¼Œåˆ™è¯¥åº”ç”¨ç¨‹åºå°†åœ¨ä»¥ä¸‹ä½ç½®æŒ‰æŒ‡å®šé¡ºåºæŸ¥æ‰¾åä¸ºsupervisord.confçš„æ–‡ä»¶ã€‚å®ƒå°†ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ã€‚ ../etc/supervisord.conf (ç›¸å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶) ../supervisord.conf (ç›¸å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶) $CWD/supervisord.conf $CWD/etc/supervisord.conf /etc/supervisord.conf /etc/supervisor/supervisord.conf (è‡ªSupervisor 3.3.0ç‰ˆæœ¬å¼€å§‹) 3.3 æ‰‹åŠ¨ç¼–è¾‘supervisoré…ç½®æ–‡ä»¶ åˆ›å»ºé…ç½®æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶ç›®å½• mkdir -p /etc/supervisor/config.d mkdir /var/log/supervisor åˆ›å»ºsupervisorè¿è¡Œç”¨æˆ·supervisor useradd supervisor -s /sbin/nologin -M æ‰‹åŠ¨ç¼–è¾‘supervisoré…ç½®æ–‡ä»¶ cat >> /etc/supervisor/supervisord.conf å½“æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œsupervisorè¿˜æä¾›äº†ä¸€ä¸ªwebç•Œé¢ [inet_http_server] port=10.0.0.10:9001 username=test password=test æµè§ˆå™¨è®¿é—®IP:9001ï¼Œç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯test 3.4 è®¾ç½®supervisoræ—¥å¿—æ»šåŠ¨ cat >/etc/logrotate.d/supervisor 3.5 è®¾ç½®Tmpfilesé˜²æ­¢sockæ–‡ä»¶è¢«æ¸…ç† cat >> /usr/lib/tmpfiles.d/tmp.conf 3.6 ä½¿ç”¨systemdç®¡ç†supervisor å¯¹å„æ“ä½œç³»ç»Ÿæä¾›supervisorè„šæœ¬çš„githubåœ°å€ å…‹éš†é¡¹ç›® $ git clone https://github.com/Supervisor/initscripts.git $ cd initscripts $ ls centos-systemd-etcs gentoo-matagus redhat-init-equeffelec redhat-sysconfig-equeffelec ubuntu debian-norrgard opensuse-garymonson redhat-init-jkoppe redhat-sysconfig-jkoppe fedora-bmbouter README.md redhat-init-mingalevme slackware #å°†centos-systemd-etcsä¸­çš„å†…å®¹æ‹·è´åˆ°/usr/lib/systemd/system/supervisord.service cat centos-systemd-etcs >/usr/lib/systemd/system/supervisord.service centos-systemd-etcsæ–‡ä»¶å†…å®¹ #centos-systemd-etcsæ–‡ä»¶å†…å®¹ cat >> /usr/lib/systemd/system/supervisord.service å¯åŠ¨supervisordå¹¶åŠ å…¥å¼€æœºè‡ªå¯ systemctl daemon-reload systemctl start supervisord && systemctl enable supervisord å››ã€supervisorç›¸å…³å‘½ä»¤ 4.1 supervisordå‘½ä»¤é€‰é¡¹ supervisordå‘½ä»¤ é€‰é¡¹ è¯´æ˜ -c FILE, --configuration=FILE æŒ‡å®šsupervisoré…ç½®æ–‡ä»¶ -n, --nodaemon åœ¨å‰å°è¿è¡Œsupervisord -h, --help æŸ¥çœ‹å¸®åŠ© -u USER, --user=USER UNIXç”¨æˆ·åæˆ–æ•°å­—ç”¨æˆ·æ ‡è¯†ã€‚å¦‚æœä»¥rootç”¨æˆ·èº«ä»½å¯åŠ¨supervisordï¼Œè¯·åœ¨å¯åŠ¨æœŸé—´å°½å¿«setuidç»™è¯¥ç”¨æˆ· -m OCTAL, --umask=OCTAL è¡¨ç¤ºsupervisordå¯åŠ¨ååº”è¯¥ä½¿ç”¨çš„ umask å…«è¿›åˆ¶æ•°ï¼ˆä¾‹å¦‚022ï¼‰ -d PATH, --directory=PATH å½“supervisordä½œä¸ºå®ˆæŠ¤è¿›ç¨‹è¿è¡Œæ—¶ï¼Œåœ¨å®ˆæŠ¤è¿›ç¨‹ä¹‹å‰cdåˆ°æ­¤ç›®å½• -l FILE, --logfile=FILE ç”¨ä½œsupervisordæ´»åŠ¨æ—¥å¿—çš„æ–‡ä»¶åè·¯å¾„ -y BYTES, --logfile_maxbytes=BYTES æ—‹è½¬å‘ç”Ÿå‰ï¼Œsupervisordæ´»åŠ¨æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ã€‚è¯¥å€¼æ˜¯åç¼€å€å¢çš„ï¼Œä¾‹å¦‚â€œ1â€æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œâ€œ1MBâ€æ˜¯1å…†å­—èŠ‚ï¼Œâ€œ1GBâ€æ˜¯1åƒå…†å­—èŠ‚ -z NUM, --logfile_backups=NUM è¦ä¿æŒçš„supervisordæ´»åŠ¨æ—¥å¿—çš„å¤‡ä»½å‰¯æœ¬æ•°ã€‚æ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å°ä¸ºlogfile_maxbytes -e LEVEL, --loglevel=LEVEL supervisoråº”è¯¥å†™å…¥æ´»åŠ¨æ—¥å¿—çš„æ—¥å¿—è®°å½•çº§åˆ«ã€‚æœ‰æ•ˆçº§åˆ«åŒ…æ‹¬trace(è¿½è¸ª), debug(è°ƒè¯•), info(ä¿¡æ¯), warn(è­¦å‘Š), error(é”™è¯¯),critical(ä¸¥é‡) -j FILE, --pidfile=FILE supervisordåº”è¯¥å°†å…¶pidæ–‡ä»¶å†™å…¥çš„æ–‡ä»¶å -i STRING, --identifier=STRING ç”±supervisorå®ä¾‹çš„å„ç§å®¢æˆ·ç«¯UIå…¬å¼€çš„ä»»æ„å­—ç¬¦ä¸²æ ‡è¯†ç¬¦ -q PATH, --childlogdir=PATH ç›®å½•çš„è·¯å¾„ï¼ˆå®ƒå¿…é¡»å·²ç»å­˜åœ¨ï¼‰ï¼Œå…¶ä¸­supervisorå°†å†™å…¥å…¶AUTO -modeå­è¿›ç¨‹æ—¥å¿— -k, --nocleanup é˜²æ­¢supervisordåœ¨å¯åŠ¨æ—¶æ‰§è¡Œæ¸…ç†ï¼ˆåˆ é™¤æ—§çš„AUTOè¿›ç¨‹æ—¥å¿—æ–‡ä»¶ï¼‰ -a NUM, --minfds=NUM åœ¨æˆåŠŸå¯åŠ¨ä¹‹å‰ï¼Œsupervisordè¿›ç¨‹å¿…é¡»å¯ç”¨çš„æœ€å°æ–‡ä»¶æè¿°ç¬¦æ•° -t, --strip_ansi ä»æ‰€æœ‰å­æ—¥å¿—è¿›ç¨‹ä¸­å‰¥ç¦»ANSIè½¬ä¹‰åºåˆ— -v, --version æŸ¥çœ‹ç‰ˆæœ¬ --profile_options=LIST ç”¨äºåˆ†æçš„é€—å·åˆ†éš”é€‰é¡¹åˆ—è¡¨ã€‚å¯¼è‡´ supervisordåœ¨æ¢æŸ¥å™¨ä¸‹è¿è¡Œï¼Œå¹¶æ ¹æ®é€‰é¡¹è¾“å‡ºç»“æœï¼Œè¿™äº›é€‰é¡¹æ˜¯ä»¥é€—å·åˆ†éš”çš„ä»¥ä¸‹åˆ—è¡¨ï¼šç´¯ç§¯ï¼Œå‘¼å«ï¼Œå‘¼å«è€…ã€‚ä¾‹å¦‚ç´¯è®¡ï¼Œæ¥ç”µè€… --minprocs=NUM åœ¨æˆåŠŸå¯åŠ¨ä¹‹å‰ï¼Œsupervisordè¿›ç¨‹å¿…é¡»å¯ç”¨çš„æœ€å°OSè¿›ç¨‹æ§½æ•° 4.2 supervisorctlå‘½ä»¤é€‰é¡¹åŠåŠ¨ä½œ supervisorctlå‘½ä»¤é€‰é¡¹ é€‰é¡¹ è¯´æ˜ -c, --configuration é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ä¸º/etc/supervisord.confï¼‰ -h, --help æŸ¥çœ‹å¸®åŠ© -i, --interactive æ‰§è¡Œå‘½ä»¤åå¯åŠ¨äº¤äº’å¼shell -s, --serverurl URL supervisordæœåŠ¡å™¨æ­£åœ¨ä¾¦å¬çš„URL(default â€œhttp://localhost:9001â€) -u, --username ç”¨äºä¸æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯çš„ç”¨æˆ·å -p, --password ç”¨äºä¸æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯çš„å¯†ç  -r, --history-file ä¿ç•™readlineå†å²è®°å½•ï¼ˆå¦‚æœreadlineå¯ç”¨ï¼‰ supervisorctlå‘½ä»¤åŠ¨ä½œ åŠ¨ä½œ è¯´æ˜ help æ‰“å°å¯ç”¨æ“ä½œåˆ—è¡¨ help æ‰“å°çš„å¸®åŠ© add [...] æ¿€æ´»è¿›ç¨‹/ç»„çš„é…ç½®ä¸­çš„ä»»ä½•æ›´æ–° remove [...] ä»æ´»åŠ¨é…ç½®ä¸­åˆ é™¤è¿›ç¨‹/ç»„ update é‡æ–°åŠ è½½é…ç½®å¹¶æ ¹æ®éœ€è¦æ·»åŠ /åˆ é™¤ï¼Œå¹¶å°†é‡æ–°å¯åŠ¨å—å½±å“çš„ç¨‹åº update all é‡æ–°åŠ è½½é…ç½®å¹¶æ ¹æ®éœ€è¦æ·»åŠ /åˆ é™¤ï¼Œå¹¶å°†é‡æ–°å¯åŠ¨å—å½±å“çš„ç¨‹åº update [...] æ›´æ–°ç‰¹å®šç»„ï¼Œå¹¶å°†é‡æ–°å¯åŠ¨å—å½±å“çš„ç¨‹åº clear æ¸…é™¤è¿›ç¨‹çš„æ—¥å¿—æ–‡ä»¶ clear æ¸…é™¤å¤šä¸ªè¿›ç¨‹çš„æ—¥å¿—æ–‡ä»¶ clear all æ¸…é™¤æ‰€æœ‰è¿›ç¨‹çš„æ—¥å¿—æ–‡ä»¶ fg è¿æ¥åˆ°å‰å°æ¨¡å¼çš„è¿›ç¨‹æŒ‰Ctrl + Cé€€å‡ºå‰å° pid è·å¾—supervisordçš„PID pid æŒ‰åç§°è·å–å•ä¸ªå­è¿›ç¨‹çš„PID pid all è·å–æ¯ä¸ªå­è¿›ç¨‹çš„PIDï¼Œæ¯è¡Œä¸€ä¸ª reload é‡æ–°å¯åŠ¨è¿œç¨‹ç›‘æ§ reread é‡æ–°åŠ è½½å®ˆæŠ¤è¿›ç¨‹çš„é…ç½®æ–‡ä»¶ï¼Œæ— éœ€æ·»åŠ /åˆ é™¤ï¼ˆæ— é‡å¯ï¼‰ restart é‡æ–°å¯åŠ¨è¿›ç¨‹ æ³¨æ„ï¼šé‡æ–°å¯åŠ¨ä¸ä¼šé‡æ–°è¯»å–é…ç½®æ–‡ä»¶ã€‚ä¸ºæ­¤ï¼Œè¯·å‚é˜…é‡è¯»å’Œæ›´æ–° restart :* é‡æ–°å¯åŠ¨ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹ æ³¨æ„ï¼šrestartä¸ä¼šé‡æ–°è¯»å–é…ç½®æ–‡ä»¶ã€‚ä¸ºæ­¤ï¼Œè¯·å‚é˜…é‡è¯»å’Œæ›´æ–° restart é‡æ–°å¯åŠ¨å¤šä¸ªè¿›ç¨‹æˆ–ç»„ æ³¨æ„ï¼šrestartä¸ä¼šé‡æ–°è¯»å–é…ç½®æ–‡ä»¶ã€‚ä¸ºæ­¤ï¼Œè¯·å‚é˜…é‡è¯»å’Œæ›´æ–° restart all é‡å¯æ‰€æœ‰è¿›ç¨‹ æ³¨æ„ï¼šrestartä¸ä¼šé‡æ–°è¯»å–é…ç½®æ–‡ä»¶ã€‚ä¸ºæ­¤ï¼Œè¯·å‚é˜…é‡è¯»å’Œæ›´æ–° signal æ²¡æœ‰ä¿¡å·å¸®åŠ© start å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ start :* å¯åŠ¨ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹ start å¯åŠ¨å¤šä¸ªè¿›ç¨‹æˆ–ç»„ start all å¯åŠ¨æ‰€æœ‰è¿›ç¨‹ status è·å–æ‰€æœ‰è¿›ç¨‹çŠ¶æ€ä¿¡æ¯ status æŒ‰åç§°è·å–å•ä¸ªè¿›ç¨‹çš„çŠ¶æ€ status è·å–å¤šä¸ªè¿›ç¨‹çš„çŠ¶æ€ stop åœæ­¢ä¸€ä¸ªè¿›ç¨‹ stop :* åœæ­¢ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹ stop åœæ­¢å¤šä¸ªè¿›ç¨‹æˆ–ç»„ stop all åœæ­¢æ‰€æœ‰è¿›ç¨‹ **tail [-f] [stdout\\ stderr] (default stdout)** è¾“å‡ºè¿‡ç¨‹æ—¥å¿—çš„æœ€åä¸€éƒ¨åˆ†ä¾‹å¦‚ï¼štail -f å®æ—¶è¾“å‡ºæ ‡å‡†è¾“å‡º Ctrl-Cé€€å‡ºã€‚tail -100 è¾“å‡ºè¿›ç¨‹çš„æœ€å100 ä¸ªå­—èŠ‚ï¼Œæ ‡å‡†é”™è¯¯è¾“å‡ºæœ€å1600 ä¸ªå­—èŠ‚å®˜æ–¹åŸæ–‡ï¼Œçœ‹ä¸æ‡‚åˆ°åº•è¯´çš„æ˜¯ä»€ä¹ˆ Output the last part of process logs Ex: tail -f Continuous tail of named process stdout Ctrl-C to exit. tail -100 last 100 bytes of process stdout tail stderr last 1600 bytes of process stderr äº”ã€supervisorä¿¡å· supervisorç¨‹åºå¯èƒ½ä¼šè¢«å‘é€ä¿¡å·ï¼Œä½¿å…¶åœ¨è¿è¡Œæ—¶æ‰§è¡ŒæŸäº›æ“ä½œã€‚ ä½ å¯ä»¥å°†è¿™äº›ä¿¡å·ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘é€åˆ°å•ä¸ªsupervisordè¿›ç¨‹idï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶çš„[supervisord]éƒ¨åˆ†çš„pidfileå‚æ•°è¡¨ç¤ºçš„æ–‡ä»¶ä¸­æ‰¾åˆ°æ­¤è¿›ç¨‹ID ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸º$CWD/supervisord.pidï¼‰ SIGTERM supervisordçš„æ‰€æœ‰å­è¿›ç¨‹éƒ½å°†å…³é—­ã€‚è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚ SIGINT supervisordçš„æ‰€æœ‰å­è¿›ç¨‹éƒ½å°†å…³é—­ã€‚è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚ SIGQUIT supervisordçš„æ‰€æœ‰å­è¿›ç¨‹éƒ½å°†å…³é—­ã€‚è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚ SIGHUP supervisordå°†åœæ­¢æ‰€æœ‰è¿›ç¨‹ï¼Œä»å®ƒæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶é‡æ–°åŠ è½½é…ç½®ï¼Œç„¶åå¯åŠ¨æ‰€æœ‰è¿›ç¨‹ã€‚ SIGUSR2 supervisordå°†å…³é—­å¹¶é‡æ–°æ‰“å¼€ä¸»æ´»åŠ¨æ—¥å¿—å’Œæ‰€æœ‰å­æ—¥å¿—æ–‡ä»¶ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/supervisor/2.supervisorç®¡ç†mysql.html":{"url":"linux/linuxæœåŠ¡/supervisor/2.supervisorç®¡ç†mysql.html","title":"supervisorç®¡ç†mysql","keywords":"","body":"supervisorç®¡ç†mysql supervisoré…ç½®æ–‡ä»¶/etc/supervisor/supervisord.confä¸­å®šä¹‰äº†includeï¼Œå› æ­¤å¦‚æœæƒ³è¦ç®¡ç†æœåŠ¡ï¼Œå°±éœ€è¦ç¼–è¾‘/etc/supervisor/config.d/*.iniæ–‡ä»¶ [include] files = /etc/supervisor/config.d/*.ini ç¼–è¾‘mysqlæœåŠ¡é…ç½®æ–‡ä»¶/etc/supervisor/config.d/mysql.ini âš ï¸ç¤ºä¾‹ä¸­çš„mysqlæ˜¯äºŒè¿›åˆ¶å®‰è£…åœ¨äº†/usr/local/mysqlï¼Œä¾‹å¦‚æ•°æ®ç›®å½•æ˜¯/usr/local/mysql/dataï¼Œå…¶ä½™æ’ä»¶ç›®å½•ã€é”™è¯¯æ—¥å¿—ç›®å½•ã€pidç›®å½•ç­‰è¿˜éœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ cat >/etc/supervisor/config.d/mysql.ini åˆ›å»ºå­˜æ”¾æ—¥å¿—ç›®å½• mkdir -p /var/log/supervisor å°†mysqlåŠ å…¥supervisor æ–¹æ³•ä¸€ ä½¿ç”¨supervisorctl update ç¨‹åºåæŠŠç›¸åº”æœåŠ¡åŠ å…¥supervisor $ supervisorctl update mysql mysql: added process group æ–¹æ³•äºŒ ä½¿ç”¨supervisorctlå‘½ä»¤è¿›å…¥äº¤äº’æ“ä½œç•Œé¢ï¼Œç„¶åå†æ·»åŠ æœåŠ¡ $ supervisorctl $ update mysql æŸ¥çœ‹æœåŠ¡è¿è¡Œ $ supervisorctl status mysql mysql RUNNING pid 4415, uptime 0:00:36 è¯¦ç»†é…ç½® [program:mysql] command=/usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/data/db/mysql/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=/data/db/mysql/logs/mysqld.log --pid-file=/data/db/mysql/mysqld/mysqld.pid --socket=/data/db/mysql/sock/mysqld.sock priority=1 numprocs=1 autostart=true autorestart=true startretries=10 exitcodes=0 stopsignal=KILL stopwaitsecs=10 redirect_stderr=true stdout_logfile_maxbytes = 1024MB stdout_logfile_backups = 10 stdout_logfile = /var/log/supervisord/mysql.log mysqlé…ç½®æ–‡ä»¶ [client] port = 3306 socket = /data/db/mysql/sock/mysql.sock [mysqld] port = 3306 socket = /data/db/mysql/sock/mysql.sock pid-file = /data/db/mysql/sock/mysqld.pid log-error = /data/db/mysql/logs/mysql-err.log log = /data/db/mysql/logs/mysqld.log tmpdir = /data/db/mysql/tmp/ slow_query_log = ON long_query_time = 5 slow_query_log_file = /data/db/mysql/logs/slow_query.log log_queries_not_using_indexes = ON skip-external-locking key_buffer_size = 256M max_allowed_packet = 64M table_open_cache = 256 sort_buffer_size = 1M read_buffer_size = 1M read_rnd_buffer_size = 4M myisam_sort_buffer_size = 64M thread_cache_size = 8 query_cache_size= 16M thread_concurrency = 8 max_connections = 20000 max_connect_errors = 20000 log-bin=/data/db/mysql/log-bin/mysql-bin expire_logs_days=4 relay-log =/data/db/mysql/relay-log log_slave_updates =1 relay_log_purge =1 relay_log_space_limit = 10G binlog_format=mixed server-id = 21 innodb_data_home_dir = /data/db/mysql/data innodb_data_file_path = ibdata1:20G;ibdata2:20G;ibdata3:20G;ibdataext:10M:autoextend innodb_log_group_home_dir = /data/db/mysql/data innodb_buffer_pool_size = 4800M innodb_additional_mem_pool_size = 20M innodb_log_file_size = 64M innodb_log_buffer_size = 8M innodb_lock_wait_timeout = 50 [mysqldump] quick max_allowed_packet = 16M [mysql] no-auto-rehash [myisamchk] key_buffer_size = 128M sort_buffer_size = 128M read_buffer = 2M write_buffer = 2M [mysqlhotcopy] interactive-timeout æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/supervisor/3.supervisorç®¡ç†nginx.html":{"url":"linux/linuxæœåŠ¡/supervisor/3.supervisorç®¡ç†nginx.html","title":"supervisorç®¡ç†nginx","keywords":"","body":"supervisorç®¡ç†nginx supervisoré…ç½®æ–‡ä»¶/etc/supervisor/supervisord.confä¸­å®šä¹‰äº†includeï¼Œå› æ­¤å¦‚æœæƒ³è¦ç®¡ç†æœåŠ¡ï¼Œå°±éœ€è¦ç¼–è¾‘/etc/supervisor/config.d/*.iniæ–‡ä»¶ [include] files = /etc/supervisor/config.d/*.ini ç¼–è¾‘nginxæœåŠ¡é…ç½®æ–‡ä»¶/etc/supervisor/config.d/nginx.ini âš ï¸éœ€è¦æ³¨æ„çš„æ˜¯/usr/sbin/nginxè¡¨ç¤ºåœ¨åå°è¿è¡Œï¼Œä½†æ˜¯supervisorä¸èƒ½ç›‘æ§åå°ç¨‹åºï¼Œ æ‰€ä»¥supervisorå°±ä¸€ç›´æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ ï¼Œå› æ­¤ä¼šæŠ¥é”™ /usr/sbin/nginxåå¿…é¡»åŠ å‚æ•° -g 'daemon off;' è¡¨ç¤ºåœ¨å‰å°è¿è¡Œ cat >/etc/supervisor/config.d/nginx.ini å°†nginxåŠ å…¥supervisor $ supervisorctl update nginx nginx: added process group æŸ¥çœ‹çŠ¶æ€ $ supervisorctl status nginx nginx RUNNING pid 9464, uptime 0:00:03 è¯¦ç»†é…ç½® [program:nginx] # use default nginx config file and dir command = /usr/local/nginx/sbin/nginx -g 'daemon off;' stdout_logfile = /var/log/supervisord/nginx.log redirect_stderr = true autorestart = true nginxé…ç½®æ–‡ä»¶ #user www www; worker_processes auto; # worker_cpu_affinity auto; # openresty-1.9.15 worker_rlimit_nofile 65535; error_log logs/error.log; pid /var/run/nginx.pid; events { use epoll; worker_connections 65565; } http { server_tokens off; sendfile on; tcp_nodelay on; tcp_nopush on; keepalive_timeout 0; charset utf-8; include mime.types; default_type application/json; log_format main ' $http_X_Forwarded_Proto - $http_SLB_IP - $upstream_addr - $http_X_Forwarded_For - ' '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status [$upstream_response_time] ' '[$request_time] $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\"'; client_header_buffer_size 16k; large_client_header_buffers 8 16k; server_names_hash_bucket_size 128; client_max_body_size 4096m; client_header_timeout 30s; client_body_timeout 30s; send_timeout 30s; lingering_close off; gzip on; gzip_vary on; gzip_min_length 1000; gzip_comp_level 6; gzip_types text/plain text/xml text/css application/javascript application/json; gzip_http_version 1.0; #index index.html index.shtml index.php; include upstream.conf; include default.conf; include vhosts/*.conf; include vhosts/jr/*.conf; include vhosts/yg/*.conf; include vhosts/yjk/*.conf; include vhosts/ys/*.conf; include vhosts/sec/*.conf; include vhosts/saas/*.conf; include vhosts/bd/*.conf; include vhosts/autom/*.conf; lua_code_cache on; lua_package_path \"../?.lua;../lib/?.lua;../lib/lua-resty-core/lib/?.lua;;\"; lua_need_request_body on; } æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/supervisor/4.supervisorç®¡ç†tomcat.html":{"url":"linux/linuxæœåŠ¡/supervisor/4.supervisorç®¡ç†tomcat.html","title":"supervisorç®¡ç†tomcat","keywords":"","body":"supervisorç®¡ç†tomcat âš ï¸åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯ä¸å…è®¸ä»¥rootç”¨æˆ·è¿è¡Œtomcatçš„ï¼Œæˆ‘ä»¬æ˜¯ä»¥ä¸€ä¸ªæœ‰rootæƒé™çš„è¿ç»´ä¸“ç”¨ç”¨æˆ·æ¥è¿è¡Œsupervisorå’Œtomcatçš„ supervisoré…ç½®æ–‡ä»¶/etc/supervisor/supervisord.confä¸­å®šä¹‰äº†includeï¼Œå› æ­¤å¦‚æœæƒ³è¦ç®¡ç†æœåŠ¡ï¼Œå°±éœ€è¦ç¼–è¾‘/etc/supervisor/config.d/*.iniæ–‡ä»¶ [include] files = /etc/supervisor/config.d/*.ini ç¼–è¾‘tomcatæœåŠ¡é…ç½®æ–‡ä»¶/etc/supervisor/config.d/tomcat.ini tomcatå®‰è£…ç›®å½•/usr/local/tomcat-8.5.56/ jdk1.8å®‰è£…ç›®å½•/usr/local/jdk1.8.0_251/ cat >/etc/supervisor/config.d/tomcat.ini ä¿®æ”¹tomcatå¯åŠ¨è„šæœ¬æ–‡ä»¶startup.sh æœ¬æ–‡ç¤ºä¾‹æ˜¯/usr/local/tomcat-8.5.56/bin/startup.sh æœ€åä¸€è¡Œï¼Œå°†startä¿®æ”¹ä¸ºrun #exec \"$PRGDIR\"/\"$EXECUTABLE\" start \"$@\" exec \"$PRGDIR\"/\"$EXECUTABLE\" run \"$@\" #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i.bak '$s/start/run/' startup.sh å°†tomcatåŠ å…¥supervisor $ supervisorctl update tomcat tomcat: added process group æŸ¥çœ‹çŠ¶æ€ $ supervisorctl status tomcat nginx RUNNING pid 9464, uptime 0:00:03 è¯¦ç»†é…ç½® [program:webServer] command=/data/webapp/webServer/bin/startup.sh environment=JAVA_HOME=\"/usr/local/jdk1.8.0/\",JAVA_BIN=\"/usr/local/jdk1.8.0/bin\" autostart = true autorestart=true redirect_stderr=true stdout_logfile=/data/logs/webServer/catalina.out æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/supervisor/5.supervisorç®¡ç†redis.html":{"url":"linux/linuxæœåŠ¡/supervisor/5.supervisorç®¡ç†redis.html","title":"supervisorç®¡ç†redis","keywords":"","body":"supervisorç®¡ç†redis supervisoré…ç½®æ–‡ä»¶/etc/supervisor/supervisord.confä¸­å®šä¹‰äº†includeï¼Œå› æ­¤å¦‚æœæƒ³è¦ç®¡ç†æœåŠ¡ï¼Œå°±éœ€è¦ç¼–è¾‘/etc/supervisor/config.d/*.iniæ–‡ä»¶ [include] files = /etc/supervisor/config.d/*.ini supervisorç®¡ç†redisæœ‰ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ redisé…ç½®æ–‡ä»¶ä¸­å¦‚æœé…ç½®äº†daemonize yesç”¨supervisorç®¡ç†çš„æ—¶å€™æ˜¯ä¼šæŠ¥é”™å¦‚ä¸‹redis FATAL Exited too quickly (process log may have details)ï¼Œè™½ç„¶æœ‰æŠ¥é”™ä½†æ˜¯redisè¿›ç¨‹å´æ˜¯æ­£å¸¸è¿è¡Œçš„ï¼Œè¿›ç¨‹åœ¨ç«¯å£ä¹Ÿèƒ½å¯åŠ¨ï¼ï¼ï¼ å¦‚æœæŠŠdaemonizeæ”¹æˆnoåˆ™æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯è¿™æ ·å°±ä¸èƒ½æŠŠredisä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œäº† daemonizeè®¾ç½®yesæˆ–è€…noåŒºåˆ« yes redisé‡‡ç”¨çš„æ˜¯å•è¿›ç¨‹å¤šçº¿ç¨‹çš„æ¨¡å¼ã€‚å½“redis.confä¸­é€‰é¡¹daemonizeè®¾ç½®æˆyesæ—¶ï¼Œä»£è¡¨å¼€å¯å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œredisä¼šåœ¨åå°è¿è¡Œï¼Œå¹¶å°†è¿›ç¨‹pidå·å†™å…¥è‡³redis.confé€‰é¡¹pidfileè®¾ç½®çš„æ–‡ä»¶ä¸­ï¼Œæ­¤æ—¶rediså°†ä¸€ç›´è¿è¡Œï¼Œé™¤éæ‰‹åŠ¨killè¯¥è¿›ç¨‹ã€‚ no å½“daemonizeé€‰é¡¹è®¾ç½®æˆnoæ—¶ï¼Œå½“å‰ç•Œé¢å°†è¿›å…¥redisçš„å‘½ä»¤è¡Œç•Œé¢ï¼Œexitå¼ºåˆ¶é€€å‡ºæˆ–è€…å…³é—­è¿æ¥å·¥å…·(putty,xshellç­‰)éƒ½ä¼šå¯¼è‡´redisè¿›ç¨‹é€€å‡ºã€‚ ç¼–è¾‘redisæœåŠ¡é…ç½®æ–‡ä»¶/etc/supervisor/config.d/redis.ini cat > /etc/supervisor/config.d/redis.ini å°†redisåŠ å…¥supervisor $ supervisorctl update redis redis: added process group æŸ¥çœ‹çŠ¶æ€ $ supervisorctl status redis redis RUNNING pid 15430, uptime 0:00:06 è¯¦ç»†é…ç½® [program:redis] command=/usr/local/bin/redis-server /data/db/redis/cfg/redis.conf directory=/usr/local/redis/src/ autostart=true stdout_logfile=/var/log/supervisord/redis.log redisé…ç½®æ–‡ä»¶ daemonize yes pidfile /data/db/redis/pid/redis_6379.pid port 6379 tcp-backlog 511 timeout 300 tcp-keepalive 0 loglevel notice logfile \"/data/db/redis/logs/redis_6379.log\" databases 16 save 7200 1 stop-writes-on-bgsave-error yes rdbcompression yes rdbchecksum yes dbfilename dump_6379.rdb dir /data/db/redis/data slave-serve-stale-data yes slave-read-only yes repl-diskless-sync yes repl-diskless-sync-delay 5 repl-disable-tcp-nodelay no slave-priority 100 protected-mode no maxmemory 4gb appendonly no appendfilename \"appendonly_6379.aof\" no-appendfsync-on-rewrite no auto-aof-rewrite-percentage 50 auto-aof-rewrite-min-size 64mb aof-load-truncated yes lua-time-limit 5000 slowlog-log-slower-than 50000 slowlog-max-len 1024 latency-monitor-threshold 0 notify-keyspace-events \"\" hash-max-ziplist-entries 512 hash-max-ziplist-value 64 list-max-ziplist-entries 512 list-max-ziplist-value 64 set-max-intset-entries 512 zset-max-ziplist-entries 128 zset-max-ziplist-value 64 hll-sparse-max-bytes 3000 activerehashing yes client-output-buffer-limit normal 0 0 0 client-output-buffer-limit slave 256mb 64mb 60 client-output-buffer-limit pubsub 32mb 8mb 60 hz 10 aof-rewrite-incremental-fsync yes æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/supervisor/6.supervisorç®¡ç†mongodb.html":{"url":"linux/linuxæœåŠ¡/supervisor/6.supervisorç®¡ç†mongodb.html","title":"supervisorç®¡ç†mongodb","keywords":"","body":"supervisorç®¡ç†mongodb supervisoré…ç½®æ–‡ä»¶/etc/supervisor/supervisord.confä¸­å®šä¹‰äº†includeï¼Œå› æ­¤å¦‚æœæƒ³è¦ç®¡ç†æœåŠ¡ï¼Œå°±éœ€è¦ç¼–è¾‘/etc/supervisor/config.d/*.iniæ–‡ä»¶ [include] files = /etc/supervisor/config.d/*.ini ç¼–è¾‘mongodbæœåŠ¡é…ç½®æ–‡ä»¶/etc/supervisor/config.d/mongodb.ini mongodbé…ç½®æ–‡ä»¶ä¸­è¦è®¾ç½®è¿™ä¸€é¡¹fork = falseï¼Œå³ä¸ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œmongodb cat >/etc/supervisor/config.d/mongodb.ini å°†mongodbåŠ å…¥supervisor $ supervisorctl update mongodb mongodb: added process group æŸ¥çœ‹çŠ¶æ€ $ supervisorctl status mongodb mongodb RUNNING pid 30352, uptime 0:10:26 è¯¦ç»†é…ç½® [program:mongodb] command=/usr/local/mongodb/bin/mongod -f /data/db/mongodb/cfg/mongod.conf directory=/usr/local/mongodb autostart=true user=testinadmin mongodbé…ç½®æ–‡ä»¶ bind_ip = 172.20.1.40 logpath = /data/db/mongodb/logs/mongod.log logappend = true pidfilepath = /data/db/mongodb/pid/mongod.pid dbpath = /data/db/mongodb/data storageEngine = wiredTiger directoryperdb = true #replSet = replset #rest = true oplogSize = 61440 #fork = true auth = false shardsvr = true port = 27010 journal = true maxConns = 30000 master = true #slave = true #source = 10.31.133.145:27010 #source = 10.47.125.99:27010 autoresync=true æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxæœåŠ¡/supervisor/7.supervisorè‡ªå®šä¹‰æœåŠ¡æ–‡ä»¶å‚æ•°.html":{"url":"linux/linuxæœåŠ¡/supervisor/7.supervisorè‡ªå®šä¹‰æœåŠ¡æ–‡ä»¶å‚æ•°.html","title":"supervisorè‡ªå®šä¹‰æœåŠ¡æ–‡ä»¶å‚æ•°","keywords":"","body":"supervisorè‡ªå®šä¹‰æœåŠ¡æ–‡ä»¶å‚æ•° supervisoré…ç½®æ–‡ä»¶/etc/supervisor/supervisord.confä¸­å®šä¹‰äº†includeï¼Œå› æ­¤å¦‚æœæƒ³è¦ç®¡ç†æœåŠ¡ï¼Œå°±éœ€è¦ç¼–è¾‘/etc/supervisor/config.d/*.iniæ–‡ä»¶ï¼Œä»¥ä¸‹ä¸º/etc/supervisor/config.d/*.iniæ–‡ä»¶ä¸­ç”¨åˆ°çš„å‚æ•° å‚æ•° è¯´æ˜ command å¯åŠ¨ç¨‹åºä½¿ç”¨çš„å‘½ä»¤ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–è€…ç›¸å¯¹è·¯å¾„ process_name ä¸€ä¸ªpythonå­—ç¬¦ä¸²è¡¨è¾¾å¼ï¼Œç”¨æ¥è¡¨ç¤ºsupervisorè¿›ç¨‹å¯åŠ¨çš„è¿™ä¸ªçš„åç§°ï¼Œé»˜è®¤å€¼æ˜¯%(program_name)s numprocs Supervisorå¯åŠ¨è¿™ä¸ªç¨‹åºçš„å¤šä¸ªå®ä¾‹ï¼Œå¦‚æœnumprocs>1ï¼Œåˆ™process_nameçš„è¡¨è¾¾å¼å¿…é¡»åŒ…å«%(process_num)sï¼Œé»˜è®¤æ˜¯1 numprocs_start ä¸€ä¸ªintåç§»å€¼ï¼Œå½“å¯åŠ¨å®ä¾‹çš„æ—¶å€™ç”¨æ¥è®¡ç®—numprocsçš„å€¼ priority æƒé‡ï¼Œå¯ä»¥æ§åˆ¶ç¨‹åºå¯åŠ¨å’Œå…³é—­æ—¶çš„é¡ºåºï¼Œæƒé‡è¶Šä½ï¼šè¶Šæ—©å¯åŠ¨ï¼Œè¶Šæ™šå…³é—­ã€‚é»˜è®¤å€¼æ˜¯999 autostart å¦‚æœè®¾ç½®ä¸ºtrueï¼Œå½“supervisordå¯åŠ¨çš„æ—¶å€™ï¼Œè¿›ç¨‹ä¼šè‡ªåŠ¨é‡å¯ autorestart å€¼å¯ä»¥æ˜¯falseã€trueã€unexpectedã€‚falseï¼šè¿›ç¨‹ä¸ä¼šè‡ªåŠ¨é‡å¯ï¼Œunexpectedï¼šå½“ç¨‹åºé€€å‡ºæ—¶çš„é€€å‡ºç ä¸æ˜¯exitcodesä¸­å®šä¹‰çš„æ—¶ï¼Œè¿›ç¨‹ä¼šé‡å¯ï¼Œtrueï¼šè¿›ç¨‹ä¼šæ— æ¡ä»¶é‡å¯å½“é€€å‡ºçš„æ—¶å€™ startsecs ç¨‹åºå¯åŠ¨åç­‰å¾…å¤šé•¿æ—¶é—´åæ‰è®¤ä¸ºç¨‹åºå¯åŠ¨æˆåŠŸ startretries supervisordå°è¯•å¯åŠ¨ä¸€ä¸ªç¨‹åºæ—¶å°è¯•çš„æ¬¡æ•°ã€‚é»˜è®¤æ˜¯3 exitcodes ä¸€ä¸ªé¢„æœŸçš„é€€å‡ºè¿”å›ç ï¼Œé»˜è®¤æ˜¯0,2 stopsignal å½“æ”¶åˆ°stopè¯·æ±‚çš„æ—¶å€™ï¼Œå‘é€ä¿¡å·ç»™ç¨‹åºï¼Œé»˜è®¤æ˜¯TERMä¿¡å·ï¼Œä¹Ÿå¯ä»¥æ˜¯ HUP, INT, QUIT, KILL, USR1, or USR2 stopwaitsecs åœ¨æ“ä½œç³»ç»Ÿç»™supervisordå‘é€SIGCHILDä¿¡å·æ—¶ç­‰å¾…çš„æ—¶é—´ stopasgroup å¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™ä¼šä½¿supervisorå‘é€åœæ­¢ä¿¡å·åˆ°æ•´ä¸ªè¿›ç¨‹ç»„ killasgroup å¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™åœ¨ç»™ç¨‹åºå‘é€SIGKILLä¿¡å·çš„æ—¶å€™ï¼Œä¼šå‘é€åˆ°æ•´ä¸ªè¿›ç¨‹ç»„ï¼Œå®ƒçš„å­è¿›ç¨‹ä¹Ÿä¼šå—åˆ°å½±å“ user å¦‚æœsupervisordä»¥rootè¿è¡Œï¼Œåˆ™ä¼šä½¿ç”¨è¿™ä¸ªè®¾ç½®ç”¨æˆ·å¯åŠ¨å­ç¨‹åº redirect_stderr å¦‚æœè®¾ç½®ä¸ºtrueï¼Œè¿›ç¨‹åˆ™ä¼šæŠŠæ ‡å‡†é”™è¯¯è¾“å‡ºåˆ°supervisordåå°çš„æ ‡å‡†è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ stdout_logfile æŠŠè¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºå†™å…¥æ–‡ä»¶ä¸­ï¼Œå¦‚æœstdout_logfileæ²¡æœ‰è®¾ç½®æˆ–è€…è®¾ç½®ä¸ºAUTOï¼Œåˆ™supervisorä¼šè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ä½ç½® stdout_logfile_maxbytes æ ‡å‡†è¾“å‡ºlogæ–‡ä»¶è¾¾åˆ°å¤šå°‘åè‡ªåŠ¨è¿›è¡Œè½®è½¬ï¼Œå•ä½æ˜¯KBã€MBã€GBã€‚å¦‚æœè®¾ç½®ä¸º0åˆ™è¡¨ç¤ºä¸é™åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å° stdout_logfile_backups æ ‡å‡†è¾“å‡ºæ—¥å¿—è½®è½¬å¤‡ä»½çš„æ•°é‡ï¼Œé»˜è®¤æ˜¯10ï¼Œå¦‚æœè®¾ç½®ä¸º0ï¼Œåˆ™ä¸å¤‡ä»½ stdout_capture_maxbytes å½“è¿›ç¨‹å¤„äºstderr capture modeæ¨¡å¼çš„æ—¶å€™ï¼Œå†™å…¥FIFOé˜Ÿåˆ—çš„æœ€å¤§byteså€¼ï¼Œå•ä½å¯ä»¥æ˜¯KBã€MBã€GB stdout_events_enabled å¦‚æœè®¾ç½®ä¸ºtrueï¼Œå½“è¿›ç¨‹åœ¨å†™å®ƒçš„stderråˆ°æ–‡ä»¶æè¿°ç¬¦çš„æ—¶å€™ï¼ŒPROCESS_LOG_STDERRäº‹ä»¶ä¼šè¢«è§¦å‘ stderr_logfile æŠŠè¿›ç¨‹çš„é”™è¯¯æ—¥å¿—è¾“å‡ºä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œé™¤éredirect_stderrå‚æ•°è¢«è®¾ç½®ä¸ºtrue stderr_logfile_maxbytes é”™è¯¯logæ–‡ä»¶è¾¾åˆ°å¤šå°‘åè‡ªåŠ¨è¿›è¡Œè½®è½¬ï¼Œå•ä½æ˜¯KBã€MBã€GBã€‚å¦‚æœè®¾ç½®ä¸º0åˆ™è¡¨ç¤ºä¸é™åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å° stderr_logfile_backups é”™è¯¯æ—¥å¿—è½®è½¬å¤‡ä»½çš„æ•°é‡ï¼Œé»˜è®¤æ˜¯10ï¼Œå¦‚æœè®¾ç½®ä¸º0ï¼Œåˆ™ä¸å¤‡ä»½ stderr_capture_maxbytes å½“è¿›ç¨‹å¤„äºstderr capture modeæ¨¡å¼çš„æ—¶å€™ï¼Œå†™å…¥FIFOé˜Ÿåˆ—çš„æœ€å¤§byteså€¼ï¼Œå•ä½å¯ä»¥æ˜¯KBã€MBã€GB stderr_events_enabled å¦‚æœè®¾ç½®ä¸ºtrueï¼Œå½“è¿›ç¨‹åœ¨å†™å®ƒçš„stderråˆ°æ–‡ä»¶æè¿°ç¬¦çš„æ—¶å€™ï¼ŒPROCESS_LOG_STDERRäº‹ä»¶ä¼šè¢«è§¦å‘ environment ä¸€ä¸ªk/vå¯¹çš„liståˆ—è¡¨ directory supervisordåœ¨ç”Ÿæˆå­è¿›ç¨‹çš„æ—¶å€™ä¼šåˆ‡æ¢åˆ°è¯¥ç›®å½• umask è®¾ç½®è¿›ç¨‹çš„umask serverurl æ˜¯å¦å…è®¸å­è¿›ç¨‹å’Œå†…éƒ¨çš„HTTPæœåŠ¡é€šè®¯ï¼Œå¦‚æœè®¾ç½®ä¸ºAUTOï¼Œsupervisorä¼šè‡ªåŠ¨çš„æ„é€ ä¸€ä¸ªurl é‡è¦å‚æ•° æœåŠ¡è‡ªåŠ¨é‡å¯è®¾ç½®ï¼Œsupervisoræä¾›äº†å½“æœåŠ¡æŒ‚æ‰æ—¶è‡ªåŠ¨é‡å¯æœåŠ¡çš„åŠŸèƒ½autorestart autorestartå¯ä»¥å†™åœ¨supervisoré…ç½®æ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥å†™åœ¨æœåŠ¡è‡ªå®šä¹‰æ–‡ä»¶ä¸­ï¼ˆsupervisoré…ç½®æ–‡ä»¶ä¸­includeæŒ‡å®šçš„ç›®å½•ä¸‹çš„æ–‡ä»¶/etc/supervisor/config.d/*.iniï¼‰ autorestartå€¼å¯ä»¥æ˜¯falseã€trueã€unexpected å€¼ è¯´æ˜ false è¿›ç¨‹ä¸ä¼šè‡ªåŠ¨é‡å¯ unexpected å½“ç¨‹åºé€€å‡ºæ—¶çš„é€€å‡ºç ä¸æ˜¯exitcodesä¸­å®šä¹‰çš„æ—¶ä¾¯ï¼Œè¿›ç¨‹ä¼šé‡å¯ true å½“æœåŠ¡é€€å‡ºçš„æ—¶å€™è¿›ç¨‹ä¼šæ— æ¡ä»¶é‡å¯ ç¤ºä¾‹ï¼š [program:nginx] command = /usr/sbin/nginx -g 'daemon off;' stdout_logfile = /var/log/nginx/nginx.log redirect_stderr = true autorestart = unexpected æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/walle/CentOS7.5å®‰è£…walle1.2.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/walle/CentOS7.5å®‰è£…walle1.2.html","title":"walle1.2","keywords":"","body":"CentOS7.5å®‰è£…walle1.2 walle1.0æ˜¯åŸºäºphpå¼€å‘çš„ï¼Œéœ€è¦php5.4ä»¥ä¸Šç‰ˆæœ¬ ç“¦åŠ›å®˜æ–¹æ–‡æ¡£ ç“¦åŠ›ä¸Šçº¿æµç¨‹ ä¸€ã€ä¾èµ– Bash(gitã€ssh) æ„å‘³ç€ä¸æ”¯æŒwinã€macçš„zsh LNMP/LAMP(php5.4+) phpéœ€è¦å¼€å¯pdo_mysqlï¼Œexecå‡½æ•°æ‰§è¡Œ Composer å¦‚æœå›½å†…ç¯å¢ƒå®‰è£…ææ…¢ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½vendorè§£å‹åˆ°é¡¹ç›®æ ¹ç›®å½• ansible äºŒã€ç³»ç»Ÿç¯å¢ƒ 2.1ç³»ç»Ÿç‰ˆæœ¬ $ cat /etc/redhat-release CentOS Linux release 7.5.1804 (Core) 2.2phpç‰ˆæœ¬ $ php -v PHP 7.2.16 (cli) (built: Mar 10 2019 21:22:49) ( NTS ) Copyright (c) 1997-2018 The PHP Group Zend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies with Zend OPcache v7.2.16, Copyright (c) 1999-2018, by Zend Technologies ä¸‰ã€å®‰è£…æ­¥éª¤ 3.1æ›´æ¢ç³»ç»Ÿyumæºä¸ºé˜¿é‡Œäº‘yumæºåŠæ·»åŠ epelæº //å¤‡ä»½åŸæœ‰baseæº mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup //ä¸‹è½½é˜¿é‡Œäº‘yumæº wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo //ä¸‹è½½epelæº wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo //æ¸…ç©ºç¼“å­˜ã€ç”Ÿæˆyumç¼“å­˜ yum clean all yum makecache 3.2å®‰è£…php-7.2 1.ä¸‹è½½php7.2yumæº éœ€è¦å…ˆå®‰è£…epel-release yum -y install https://mirror.webtatic.com/yum/el7/webtatic-release.rpm 2.å®‰è£…php7.2 yum -y install php72w php72w-cli php72w-common php72w-curl php72w-gd \\ php72w-mbstring php72w-mysqlnd php72w-process php72w-xml php72w-zip \\ php72w-opcache php72w-pecl-apcu php72w-intl php72w-pecl-redis php72w-fpm 3.å¯åŠ¨php-fpmå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ systemctl start php-fpm && systemctl enable php-fpm 3.3å®‰è£…mysql-5.7.22 gitbooké“¾æ¥-å®‰è£…msql-5.7.22 æœ‰é“äº‘é“¾æ¥-å®‰è£…mysql-5.7.22 3.4å®‰è£…nginx-1.14å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ //æ·»åŠ nginxå®˜æ–¹yumæº cat >/etc/yum.repos.d/nginx.repo /etc/nginx/conf.d/my.walle1.com.conf 3.5å®‰è£…ansible yum -y install ansible 3.6ä»£ç æ£€å‡º //åˆ›å»ºç›®å½• mkdir -p /data/www/walle-web && cd /data/www/walle-web //å…‹éš†ä»£ç  git clone https://github.com/meolu/walle-web-v1.x.git . 3.7è®¾ç½®mysql [root@walle walle-web]# pwd /data/www/walle-web [root@walle walle-web]# vim config/local.php ä¿®æ”¹24è¡Œï¼Œ25è¡Œï¼Œå†™å…¥mysqlç”¨æˆ·åå’Œå¯†ç  'username' => isset($_ENV['WALLE_DB_USER']) ? $_ENV['WALLE_DB_USER'] : 'root', 'password' => isset($_ENV['WALLE_DB_PASS']) ? $_ENV['WALLE_DB_PASS'] : '123456', //åˆ›å»ºæ•°æ®åº“walle mysql -uroot -p -e \"create database walle\" 3.8å®‰è£…composerï¼ŒComposer æ˜¯ PHP5.3ä»¥ä¸Š çš„ä¸€ä¸ªä¾èµ–ç®¡ç†å·¥å…· //ä¸‹è½½å®‰è£…è„šæœ¬composer-setup.phpåˆ°å½“å‰ç›®å½• php -r \"copy('https://install.phpcomposer.com/installer', 'composer-setup.php');\" //æ‰§è¡Œå®‰è£…è¿‡ç¨‹ php composer-setup.php //åˆ é™¤å®‰è£…è„šæœ¬ php -r \"unlink('composer-setup.php');\" //å°†composer.pharç§»åŠ¨è‡³/usr/local/bin,ä»¥ä¾¿èƒ½ç›´æ¥æ‰§è¡Œcomposerå‘½ä»¤ mv composer.phar /usr/local/bin/composer 3.9å®‰è£…vendor omposer install --prefer-dist --no-dev --optimize-autoloader -vvvv 3.10åˆå§‹åŒ–é¡¹ç›® ./yii walle/setup 3.11ç»‘å®šhostsæ–‡ä»¶ //windows C:\\Windows\\System32\\drivers\\etc 10.0.0.51 my.walle1.com //mac /etc/hosts 3.12æµè§ˆå™¨è®¿é—®my.walle1.com åˆå§‹åŒ–ç®¡ç†å‘˜è´¦å·å¯†ç ä¸ºï¼šadmin/admin åˆå§‹åŒ–å¼€å‘è€…è´¦å·å¯†ç ä¸ºï¼šdemo/demo ç™»é™†åé¦–ç•Œé¢ åˆ°æ­¤ï¼Œç“¦åŠ›1.2å®‰è£…å®Œæˆï¼ï¼ï¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/walle/CentOS7.5å®‰è£…walle2.0.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/walle/CentOS7.5å®‰è£…walle2.0.html","title":"walle2.0","keywords":"","body":"CentOS7.5å®‰è£…walle2.0 æ ‡å‡†å®‰è£… walle2.0æ˜¯åŸºäºpythonå¼€å‘çš„ï¼Œéœ€è¦python2.7+ï¼Œmysql5.6.5ä»¥ä¸Šç‰ˆæœ¬ å®˜æ–¹æ–‡æ¡£ ç“¦åŠ›ä¸Šçº¿æµç¨‹ ä¸€ã€ç³»ç»Ÿç¯å¢ƒ 1.1Linuxç³»ç»Ÿç‰ˆæœ¬ [root@walle ~]# cat /etc/redhat-release CentOS Linux release 7.5.1804 (Core) 1.2pythonç‰ˆæœ¬ [root@walle ~]# python --version Python 2.7.5 äºŒã€å®‰è£…æ­¥éª¤ 2.1æ›´æ¢é˜¿é‡Œäº‘yumæºåŠæ·»åŠ epelæº #å¤‡ä»½åŸæœ‰baseæº [root@walle ~]# mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup #ä¸‹è½½é˜¿é‡Œäº‘yumæº [root@walle ~]# wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo #ä¸‹è½½epelæº [root@walle ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo #æ¸…ç©ºç¼“å­˜ã€ç”Ÿæˆyumç¼“å­˜ [root@walle ~]# yum clean all && yum makecache 2.2å®‰è£…ä¾èµ–åŒ… [root@walle ~]# yum -y install python2-pip python-virtualenv 2.3å®‰è£…mysql-5.7.22 gitbooké“¾æ¥-å®‰è£…msql-5.7.22 æœ‰é“äº‘é“¾æ¥-å®‰è£…mysql-5.7.22 2.4å®‰è£…nginx1.14å¹¶é…ç½® #æ·»åŠ nginxå®˜æ–¹yumæº [root@walle ~]# cat >/etc/yum.repos.d/nginx.repo /etc/nginx/conf.d/my.walle.com.conf 2.5å…‹éš†ç“¦åŠ› #å…‹éš†ç“¦åŠ›é¡¹ç›® [root@walle ~]# git clone https://github.com/meolu/walle-web.git #å°†ç“¦åˆ©é¡¹ç›®ç§»è‡³æ ¹ä¸‹ [root@walle ~]# mv walle-web / 2.6ç¼–è¾‘hostsæ–‡ä»¶ #åŸŸåè¦ä¸nginxé…ç½®æ–‡ä»¶ä¸­ä¸€æ · [root@walle ~]# echo \"127.0.0.1 my.walle2.com\" >>/etc/hosts 2.7å®‰è£…python2.7+pip [root@walle ~]# cd /walle-web [root@walle walle-web]# sh admin.sh init å®‰è£…åæç¤ºå¦‚ä¸‹å³ä¸ºæˆåŠŸ init walle success welcome to walle 2.0 # æ³¨æ„ï¼šå®‰è£…mysqlclientå¤±è´¥ï¼Œéœ€è¦å…ˆå®‰è£…libmysqlclient-dev(ubuntu) # æ³¨æ„ï¼šå®‰è£…å¤±è´¥è¯·æŒ‡å®špythonè·¯å¾„. mac å¯èƒ½ä¼šæœ‰ç”¨anacondaçš„pythonï¼Œæ‰¾åˆ°è‡ªå·±ç³»ç»Ÿçš„python 2.7è¿½åŠ å‚æ•°æŒ‡å®š -p /usr/bin/python2.7 å³å¯ vim admin.sh +20 virtualenv --no-site-packages -p /usr/local/bin/python2.7 venv 2.8ç¼–è¾‘pythoné…ç½®æ–‡ä»¶/walle-web/walle/config/settings_prod.py #ç¼–è¾‘é…ç½®æ–‡ä»¶ [root@walle walle-web]# pwd /walle-web [root@walle walle-web]# vim walle/config/settings_prod.py ä¿®æ”¹ä»¥ä¸‹å‡ é¡¹ 25è¡Œï¼ŒåŸŸåè®¾ç½®ï¼Œè¦ä¸nginxé…ç½®æ–‡ä»¶ä¸­çš„åŸŸåç›¸åŒ HOST = 'my.walle2.com' 31è¡Œï¼Œæ•°æ®åº“è®¾ç½®ï¼Œä¿®æ”¹userå’Œpasswordï¼Œè¿™é‡Œä¸ºrootç”¨æˆ·ï¼Œå¯†ç 123456ï¼Œç«¯å£ä¸º3306 SQLALCHEMY_DATABASE_URI = 'mysql://user:password@localhost:3306/walle?charset=utf8' 34è¡Œï¼ŒæŒ‡å®šæœ¬åœ°ä»£ç æ£€å‡ºè·¯å¾„ï¼ˆç”¨æˆ·æŸ¥è¯¢åˆ†æ”¯, ç¼–è¯‘, æ‰“åŒ…ï¼‰ CODE_BASE = '/data/walle/codebase/' 45è¡Œä»¥ä¸‹ä¸ºé‚®ç®±è®¾ç½® MAIL_SERVER = 'smtp.163.com' MAIL_PORT = 465 MAIL_USE_SSL = True MAIL_USE_TLS = False MAIL_DEFAULT_SENDER = 'xxx@163.com' MAIL_USERNAME = 'xxx' MAIL_PASSWORD = '123456' #åˆ›å»ºæœ¬åœ°ä»£ç æ£€å‡ºè·¯å¾„ [root@walle walle-web]# mkdir -p /data/walle/codebase 2.9åˆ›å»ºwalleæ•°æ®åº“å¹¶è¿›è¡Œæ•°æ®è¿ç§» #åˆ›å»ºwalleæ•°æ®åº“ [root@walle walle-web]# mysql -uroot -p -e \"create database walle\" #åˆ›å»ºè½¯è¿æ¥ï¼Œå¦åˆ™åç»­æ‰§è¡Œè¿ç§»è„šæœ¬ä¼šå‡ºé”™ å…ˆæ‰¾åˆ°libmysqlclient.so.20ä½ç½®ï¼Œè¿™é‡Œä¸º/usr/local/mysql-5.7.22/lib/libmysqlclient.so.20ï¼Œ å› ä¸ºåšäº†/usr/local/mysqlè½¯è¿æ¥ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨/usr/local/mysql/lib/è·¯å¾„ [root@walle walle-web]# find / -name \"libmysqlclient.so.20\" /usr/local/mysql-5.7.22/lib/libmysqlclient.so.20 [root@walle walle-web]# ln -s /usr/local/mysql/lib/libmysqlclient.so.20 /usr/lib64/libmysqlclient.so.20 [root@walle walle-web]# sh admin.sh migration æœ€åæç¤ºOKå³ä¸ºæˆåŠŸ 2.10å¯åŠ¨ç“¦åŠ›å¹¶åŠ å…¥å¼€æœºè‡ªå¯ [root@walle walle-web]# sh admin.sh start [root@walle walle-web]# echo \"cd /walle-web/ && sh admin.sh start\" >>/etc/rc.local [root@walle ~]# chmod +x /etc/rc.d/rc.local 2.11ç»‘å®šhostsæ–‡ä»¶ //windows C:\\Windows\\System32\\drivers\\etc 10.0.0.11 my.walle2.com //mac /etc/hosts 2.12ç™»é™†ç“¦åŠ› åˆå§‹ç™»é™†è´¦å· è¶…ç®¡ï¼šsuper@walle-web.io \\ Walle123 æ‰€æœ‰è€…ï¼šowner@walle-web.io \\ Walle123 è´Ÿè´£äººï¼šmaster@walle-web.io \\ Walle123 å¼€å‘è€…ï¼šdeveloper@walle-web.io \\ Walle123 è®¿å®¢ï¼šreporter@walle-web.io \\ Walle123 ç“¦åŠ›é‡å¯ã€å‡çº§ã€æ•°æ®è¿ç§» sh admin.sh restart # é‡å¯ sh admin.sh upgrade # å‡çº§walleï¼Œå‡çº§å®Œéœ€è¦é‡å¯walleæœåŠ¡ã€‚ å‡çº§å‰æœ€å¥½ git stash æš‚å­˜æœ¬åœ°ä¿®æ”¹ï¼Œå‡çº§ågit stash popå¼¹å‡ºæš‚å­˜ï¼Œ ç„¶åé‡å¯æœåŠ¡ã€‚ sh admin.sh migration # Migrationï¼Œæ•°æ®è¿ç§» ç™»é™†ç•Œé¢ ç™»é™†åé¦–ç•Œé¢ åˆ°æ­¤ï¼Œç“¦åŠ›2.0æ ‡å‡†å®‰è£…å®Œæˆï¼ï¼ï¼ dockerå®‰è£… ä¸€ã€å®‰è£…docker 1.1ä¸‹è½½å®˜æ–¹yumæº #æ·»åŠ yumæº [root@docker01 ~]# curl -o /etc/yum.repos.d/docker-ce.repo \\ https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo #æ·»åŠ å®˜æ–¹yumæº [root@docker01 ~]# yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo 1.2.ä¿®æ”¹dockerå®˜æ–¹yumæºåœ°å€ä¸ºæ¸…åæº [root@docker01 ~]# sed -i 's#download.docker.com#mirrors.tuna.tsinghua.edu.cn/docker-ce#g' \\ /etc/yum.repos.d/docker-ce.repo 1.3å®‰è£…docker docker-ce ç¤¾åŒºç‰ˆ [root@docker01 ~]# yum -y install docker-ce 1.4.å¯åŠ¨docker [root@docker01 ~]# systemctl start docker && systemctl enable docker 1.5æŸ¥çœ‹dockerç‰ˆæœ¬ [root@docker01 ~]# docker version Client: Version: 18.09.1 API version: 1.39 Go version: go1.10.6 Git commit: 4c52b90 Built: Wed Jan 9 19:35:01 2019 OS/Arch: linux/amd64 Experimental: false Server: Docker Engine - Community Engine: Version: 18.09.1 API version: 1.39 (minimum version 1.12) Go version: go1.10.6 Git commit: 4c52b90 Built: Wed Jan 9 19:06:30 2019 OS/Arch: linux/amd64 Experimental: false 1.6é…ç½®dockeré•œåƒåŠ é€Ÿ #é…ç½®dockerå®˜æ–¹é•œåƒåŠ é€Ÿåœ°å€ [root@docker01 ~]# cat > /etc/docker/daemon.json /etc/docker/daemon.json äºŒã€å®‰è£…docker-compose 2.1ä¸‹è½½å®‰è£…åŒ… [root@docker01 ~]# curl -L \"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose 2.2ç»™äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ å¯æ‰§è¡Œæƒé™ [root@docker01 ~]# chmod +x /usr/local/bin/docker-compose 2.3å®Œæˆå®‰è£…ï¼ŒæŸ¥çœ‹ç‰ˆæœ¬ [root@docker01 ~]# docker-compose -v docker-compose version 1.24.1, build 4667896b ä¸‰ã€ç¼–è¾‘walle2.0 docker-composeæ–‡ä»¶å¹¶å¯åŠ¨walle2.0å®¹å™¨ 3.1åˆ›å»ºå­˜æ”¾æ–‡ä»¶ç›®å½• [root@docker01 ~]# mkdir /usr/local/walle2.0 && cd /usr/local/walle2.0 3.2æ–°å»ºwalle.envï¼Œè¿æ¥æ•°æ®åº“MYSQL_USERé»˜è®¤ä½¿ç”¨root,å¦‚éœ€ä½¿ç”¨å…¶ä»–ç”¨æˆ·ï¼Œéœ€è‡ªå»ºç”¨æˆ·æ›´æ”¹walle.envæ–‡ä»¶ cat >walle.env 3.3åˆ›å»ºdocker-composeæ–‡ä»¶ cat >docker-compose.yml =1024) # 0.0.0.0:è¦ç»‘å®šçš„å®¿ä¸»æœºç«¯å£:dockerå®¹å™¨å†…ç«¯å£80 - \"80:80\" depends_on: - python networks: - walle-net restart: always python: image: alenx/walle-python:2.1 container_name: walle-python hostname: walle-python env_file: # walle.envéœ€å’Œdocker-composeåœ¨åŒçº§ç›®å½• - ./walle.env command: bash -c \"cd /opt/walle_home/ && /bin/bash admin.sh migration && python waller.py\" expose: - \"5000\" volumes: - /opt/walle_home/plugins/:/opt/walle_home/plugins/ - /opt/walle_home/codebase/:/opt/walle_home/codebase/ - /opt/walle_home/logs/:/opt/walle_home/logs/ - /root/.ssh:/root/.ssh/ depends_on: - db networks: - walle-net restart: always db: image: mysql container_name: walle-mysql hostname: walle-mysql env_file: - ./walle.env command: [ '--default-authentication-plugin=mysql_native_password', '--character-set-server=utf8mb4', '--collation-server=utf8mb4_unicode_ci'] ports: - \"3306:3306\" expose: - \"3306\" volumes: - /data/walle/mysql:/var/lib/mysql networks: - walle-net restart: always networks: walle-net: driver: bridge EOF 3.4å¯åŠ¨å®¹å™¨ docker-compose up -d å¯åŠ¨å®Œæˆåæµè§ˆå™¨è®¿é—®å®¿ä¸»æœºIPåœ°å€80ç«¯å£å®Œæˆç™»é™† 3.5åˆå§‹è´¦å·åŠå¸¸ç”¨æ“ä½œ //åˆå§‹è´¦å· è¶…ç®¡ï¼šsuper@walle-web.io \\ Walle123 æ‰€æœ‰è€…ï¼šowner@walle-web.io \\ Walle123 è´Ÿè´£äººï¼šmaster@walle-web.io \\ Walle123 å¼€å‘è€…ï¼šdeveloper@walle-web.io \\ Walle123 è®¿å®¢ï¼šreporter@walle-web.io \\ Walle123 //å¸¸ç”¨æ“ä½œ # æ„å»ºæœåŠ¡ docker-compose build # å¯åŠ¨æœåŠ¡,å¯åŠ¨è¿‡ç¨‹ä¸­å¯ä»¥ç›´æ¥æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—ï¼Œè§‚å¯Ÿå¯åŠ¨æ˜¯å¦æˆåŠŸ docker-compose up # å¯åŠ¨æœåŠ¡åœ¨åå°ï¼Œå¦‚æœç¡®è®¤éƒ¨ç½²æˆåŠŸï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ­¤å‘½ä»¤ï¼Œå°†åº”ç”¨è·‘åœ¨åå°ï¼Œä½œç”¨ç±»ä¼¼ nohup python waller.py & docker-compose up -d # æŸ¥çœ‹æ—¥å¿—,æ•ˆæœç±»ä¼¼ tail -f waller.log docker-compose logs -f # åœæ­¢æœåŠ¡,ä¼šåœæ­¢æœåŠ¡çš„è¿è¡Œï¼Œä½†æ˜¯ä¸ä¼šåˆ é™¤æœåŠ¡æ‰€æ‰€ä¾é™„çš„ç½‘ç»œï¼Œä»¥åŠå­˜å‚¨ç­‰ docker-compose stop # åˆ é™¤æœåŠ¡ï¼Œå¹¶åˆ é™¤æœåŠ¡äº§ç”Ÿçš„ç½‘ç»œï¼Œå­˜å‚¨ç­‰ï¼Œå¹¶ä¸”ä¼šå…³é—­æœåŠ¡çš„å®ˆæŠ¤ docker-compose down æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/walle/walle1.2 ä¸Šçº¿ç¤ºä¾‹.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/walle/walle1.2 ä¸Šçº¿ç¤ºä¾‹.html","title":"walle1.2ä¸Šçº¿ç¤ºä¾‹","keywords":"","body":"walle1.2 ä¸Šçº¿ç¤ºä¾‹ ä¸€ã€ç“¦åŠ›ä¸Šçº¿æµç¨‹ç¤ºæ„å›¾ 1.1 ä¸ªäººæ€»ç»“ç‰ˆ ç“¦åŠ›ä¸Šçº¿æµç¨‹ç¤ºæ„å›¾ è¿‡ç¨‹è¯´æ˜ 1.å¼€å‘æäº¤æœ¬åœ°ä»£ç åˆ°gitlab(githubã€giteaç­‰)ä»“åº“ 2.ç“¦åŠ›ä»gitlabæ‹‰å–æœ€æ–°ä»£ç åˆ°æœ¬æœº æ³¨æ„éœ€è¦æŠŠè¿›ç¨‹ç”¨æˆ·çš„å¯†é’¥æ”¾åˆ°gitlabçš„ssh-keysåˆ—è¡¨ï¼Œè¿™é‡Œçš„è¿›ç¨‹ç”¨æˆ·æŒ‡çš„æ˜¯ä¸€ä¸ªç¨‹åºçš„è¿è¡Œç”¨æˆ·ï¼Œä¾‹å¦‚nginxçš„è¿è¡Œç”¨æˆ·æ˜¯www å¦‚æœæ˜¯javaé¡¹ç›®ï¼Œåˆ™ä¼šåœ¨ç“¦åŠ›æœºå™¨ä¸Šè¿›è¡Œç¼–è¯‘æ‰“åŒ…ï¼Œå› æ­¤mavenä»“åº“æ˜¯éƒ¨ç½²åœ¨ç“¦åŠ›æœºå™¨ä¸Šçš„ 3.ç“¦åŠ›æ¨é€æœ€æ–°ä»£ç åˆ°çº¿ä¸Šwebæœºå™¨çš„å‘å¸ƒç‰ˆæœ¬åº“(ç“¦åŠ›ä¸­é…ç½®ï¼Œå°±æ˜¯webæœºå™¨ä¸Šçš„ä¸€ä¸ªç›®å½•) æ—¢ç„¶æ˜¯ç“¦åŠ›ä¸»åŠ¨æ¨é€ä»£ç åˆ°çº¿ä¸Šwebæœºå™¨ï¼Œå› æ­¤éœ€è¦æŠŠè¿›ç¨‹ç”¨æˆ·çš„å…¬é’¥æ·»åŠ åˆ°çº¿ä¸Šwebæœºå™¨çš„ç”¨æˆ·ssh-keyä¿¡ä»»åˆ—è¡¨ï¼Œå³åšç“¦åŠ›æœºå™¨--->çº¿ä¸Šwebæœºå™¨çš„å…å¯†ç™»é™† 4.ç¨‹åºwebæ ¹ç›®å½•è½¯è¿æ¥åˆ°å‘å¸ƒç‰ˆæœ¬åº“ åœ¨ç“¦åŠ›ä¸­ä¼šé…ç½®å‘å¸ƒç‰ˆæœ¬åº“ï¼Œè¿™ä¸ªå‘å¸ƒç‰ˆæœ¬åº“å°±æ˜¯æ¯ä¸€æ¬¡ç“¦åŠ›æ¨é€çš„ä»£ç å­˜æ”¾åœ°å€ï¼Œç„¶åç¨‹åºçš„webæ ¹ç›®å½•è½¯è¿æ¥åˆ°å‘å¸ƒç‰ˆæœ¬åº“ï¼Œå¦‚æœè¦åšå‡çº§æˆ–è€…å›æ»šçš„è¯å°±æ˜¯æ”¹å˜è½¯è¿æ¥çš„ä½ç½® 1.2 å®˜æ–¹è¯´æ˜ç‰ˆ ç“¦åŠ›åŸç†ç¤ºæ„å›¾ å®¿ä¸»æœºã€ç›®æ ‡æœºç¾¤ã€æ“ä½œç”¨æˆ·å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®¿ä¸»æœºï¼ˆwalleæ‰€åœ¨çš„æœºå™¨ï¼‰ï¼Œæ˜¯ä¸€ä¸ªä¸­é—´æœºå™¨ï¼Œæ˜¯ä»£ç æ‰˜ç®¡ä¸è¿œç¨‹ç›®æ ‡æœºç¾¤çš„çº½å¸¦ã€‚æ‰€ä»¥å®¿ä¸»æœºéœ€è¦ä¸ä»£ç æ‰˜ç®¡(github/gitlab)å’Œè¿œç¨‹ç›®æ ‡æœºç¾¤éƒ½å»ºç«‹ssh-keyä¿¡ä»»ã€‚ ä¸Šçº¿æµç¨‹ç¤ºæ„å›¾ äºŒã€ç“¦åŠ›ä¸Šçº¿é¡¹ç›®é…ç½®é¡¹è¯´æ˜ 2.1 é¡¹ç›®é…ç½®è¯´æ˜ 2.1.1 é¡¹ç›®é…ç½® é¡¹ç›®åç§° éœ€è¦ä¸Šçº¿çš„é¡¹ç›®åç§°ï¼Œæœ€å¥½ä¸é¡¹ç›®ç±»å‹åç›¸åŒï¼Œä¾‹å¦‚é¡¹ç›®æ˜¯å…¼å®¹æµ‹è¯•ç±»ï¼Œåˆ™åç§°å°±å‘½åä¸ºå…¼å®¹-æµ‹è¯•-1.0 é¡¹ç›®ç¯å¢ƒ æµ‹è¯•ç¯å¢ƒã€é¢„å‘å¸ƒç¯å¢ƒã€çº¿ä¸Šç¯å¢ƒ è¿œç¨‹ä»“åº“åœ°å€ ä¸€èˆ¬ä¸ºgitå±…å¤š 2.1.2 å®¿ä¸»æœºé…ç½®(ç“¦åŠ›æœºå™¨æœ¬èº«) ä»£ç æ£€å‡ºä»“åº“ ç“¦åŠ›ä»gitlabæ‹‰å–ä»£ç çš„å­˜æ”¾è·¯å¾„ï¼Œç›®å½•è‡ªå®šä¹‰è®¾ç½®ï¼Œâš ï¸è¦ä¿è¯ç¨‹åºè¿è¡Œç”¨æˆ·å¯¹æ­¤ç›®å½•æœ‰å†™æƒé™ æ’é™¤æ–‡ä»¶ å¯ä»¥å¡«å†™è¦æ’é™¤çš„æ–‡ä»¶ï¼Œè‡ªå®šä¹‰ 2.1.3 ç›®æ ‡æœºå™¨é…ç½® ç”¨æˆ· ç›®æ ‡æœºå™¨å°±æ˜¯çº¿ä¸Šçš„webæœºå™¨ï¼Œè¿™é‡Œå¡«å†™ç¨‹åºçš„è¿è¡Œç”¨æˆ·ï¼Œä¾‹å¦‚tomcatçš„è¿è¡Œç”¨æˆ·æ˜¯www webroot ä»£ç çš„æœ€ç»ˆéƒ¨ç½²è·¯å¾„ï¼Œâš ï¸æ³¨æ„ä¸è¦åˆ›å»ºæ­¤ç›®å½•ï¼Œç“¦åŠ›ä¼šè‡ªåŠ¨ç”Ÿæˆè½¯è¿æ¥åˆ°æ­¤ï¼Œæ­£ç¡®è®¾ç½®çˆ¶çº§ç›®å½•å³å¯ å‘å¸ƒç‰ˆæœ¬åº“ ä»£ç å‘å¸ƒçš„ç‰ˆæœ¬åº“ï¼Œæ¯æ¬¡å‘å¸ƒæ›´æ–°webrootçš„è½¯é“¾åˆ°å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼Œæ ¼å¼æ˜¯/data/releases/é¡¹ç›®å/æ—¶é—´ç›®å½•ï¼Œå›æ»šåªéœ€è¦ä¿®æ”¹è½¯è¿æ¥å³å¯ï¼Œç›®å½•è‡ªå®šä¹‰ ç‰ˆæœ¬ä¿ç•™æ•° è¿‡å¤šçš„å†å²ç‰ˆæœ¬å°†è¢«åˆ é™¤ï¼Œåªå¯å›æ»šä¿ç•™çš„ç‰ˆæœ¬ æœºå™¨åˆ—è¡¨ è¦å‘å¸ƒçš„æœºå™¨åˆ—è¡¨ï¼Œä¸€è¡Œä¸€ä¸ªï¼Œé22ç«¯å£å¯ip:port 2.1.3 é«˜çº§ä»»åŠ¡(ç›®æ ‡æœºå™¨æ“ä½œ) pre_deploy åœ¨éƒ¨ç½²ä»£ç ä¹‹å‰çš„å‡†å¤‡å·¥ä½œï¼Œå¦‚gitçš„ä¸€äº›å‰ç½®æ£€æŸ¥ã€vendorçš„å®‰è£…ï¼ˆæ›´æ–°ï¼‰ï¼Œä¸€è¡Œä¸€æ¡ post_deploy gitä»£ç æ£€å‡ºä¹‹åï¼Œå¯èƒ½åšä¸€äº›è°ƒæ•´å¤„ç†ï¼Œ å¦‚vendoræ‹·è´ï¼Œ ç¯å¢ƒé€‚é…ï¼ˆmv configä¸€test.phpconfig.phpï¼‰ä¸€è¡Œä¸€æ¡ pre_release åŒæ­¥å®Œæ‰€æœ‰ç›®æ ‡æœºå™¨ä¹‹åï¼Œæ›´æ”¹ç‰ˆæœ¬è½¯é“¾ä¹‹å‰è§¦å‘ä»»åŠ¡ã€‚javaå¯èƒ½è¦åšä¸€äº›æš‚åœ æœåŠ¡çš„æ“ä½œï¼ˆåŒå¼•å·å°†ä¼šè¢«è½¬ä¹‰ä¸º\\\"ï¼‰ post_release æ‰€æœ‰ç›®æ ‡æœºå™¨éƒ½éƒ¨ç½²å®Œæ¯•ä¹‹åï¼Œåšä¸€äº›æ¸…ç†å·¥ä½œï¼Œ å¦‚åˆ é™¤ç¼“å­˜ã€å¹³æ»‘é‡è½½/é‡å¯æœåŠ¡ï¼ˆnginxã€phpã€taskï¼‰ ï¼Œä¸€è¡Œä¸€æ¡ï¼ˆåŒå¼•å·å°†ä¼šè¢«è½¬ä¹‰ä¸º\\\"ï¼‰ post_release_delay æŒ‰é¡ºåºåœ¨æ¯å°ç›®æ ‡æœºæ‰§è¡Œé«˜çº§ä»»åŠ¡ï¼Œæ¯å°æœåŠ¡å™¨æ‰§è¡Œå®Œæ¯•åæš‚åœxç§’ã€‚é»˜è®¤è®¾ç½®ä¸º0ï¼Œåº”ç”¨æœåŠ¡ä½¿ç”¨å¹³æ»‘é‡è½½ï¼Œä»…å½“åº”ç”¨æœåŠ¡æ— æ³•æ”¯æŒå¹³æ»‘é‡è½½å¿…é¡»é‡å¯æ—¶æ‰é…ç½®æ­¤å‚æ•°ã€‚è®¾ç½®ä¸ºå¤§äº0çš„å€¼ä¼šå‡ºç°ä»£ç å‘å¸ƒé˜¶æ®µå„ä¸ªæœåŠ¡å™¨ä¸šåŠ¡ä»£ç é€»è¾‘ä¸ä¸€è‡´çš„æƒ…å†µï¼Œè¯·è°¨æ…é…ç½® ä¸‰ã€é¡¹ç›®é…ç½®ç¤ºä¾‹ 3.1 å‰ææ¡ä»¶ ç”Ÿäº§ç¯å¢ƒç¨‹åºè¿è¡Œç¯å¢ƒåŠç”¨æˆ·è¯´æ˜ ç”Ÿäº§ç¯å¢ƒä¸­ä¸€èˆ¬ä¼šä»¥ä¸€ä¸ªérootç”¨æˆ·è¿è¡Œç¨‹åºï¼Œè¿™é‡Œå‡è®¾ä»¥wwwç”¨æˆ·è¿è¡Œç¨‹åºï¼Œç”Ÿäº§ä¸­wwwç”¨æˆ·æ˜¯æ‰€æœ‰å¼€å‘ç™»é™†ç³»ç»Ÿæ‰€ç”¨çš„ç”¨æˆ·(éœ€è¦cmdbæˆæƒç™»é™†æœºå™¨)ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯è¿ç»´ä¸“ç”¨ç”¨æˆ·ï¼Œé™¤ç‰¹æ®Šæƒ…å†µå¤–ï¼Œæ‰€æœ‰æœºå™¨ä¸­çš„æœåŠ¡åŠç›¸å…³ç›®å½•æƒé™éƒ½æ˜¯wwwç”¨æˆ· ç“¦åŠ›æœºå™¨è¯´æ˜ ç“¦åŠ›æœºå™¨ä¸­ä»£ç æ£€å‡ºä»“åº“çš„æƒé™åº”è¯¥è®¾ç½®wwwç”¨æˆ·å¯å†™ï¼Œç”Ÿäº§ä¸­æˆ‘ä»¬ç›´æ¥è®¾ç½®ä¸ºwwwç”¨æˆ·æ‰€æœ‰ ç¦æ­¢rootè¿œç¨‹ç™»é™†ï¼Œç™»é™†ç”¨æˆ·æ˜¯wwwï¼Œç™»é™†æ–¹å¼æ˜¯å¯†é’¥ç™»é™† ç›®æ ‡æœºå™¨è¯´æ˜ ç›®æ ‡æœºå™¨çš„å‘å¸ƒç‰ˆæœ¬åº“æƒé™æ‰€æœ‰è€…æ˜¯wwwç”¨æˆ· ç›®æ ‡æœºå™¨ä¸­çš„æœåŠ¡ä»¥supervisorç®¡ç†ï¼Œå¹¶ä¸”supervisorè¿è¡Œç”¨æˆ·æ˜¯www ç¦æ­¢rootè¿œç¨‹ç™»é™†ï¼Œç™»é™†ç”¨æˆ·æ˜¯wwwï¼Œç™»é™†æ–¹å¼æ˜¯å¯†é’¥ç™»é™† ssh-keyè¯´æ˜ ç“¦åŠ›æœºå™¨éœ€è¦ä¸ä»£ç æ‰˜ç®¡(github/gitlab)å’Œè¿œç¨‹ç›®æ ‡æœºç¾¤éƒ½å»ºç«‹ssh-keyä¿¡ä»»ï¼Œå³ç“¦åŠ›æœºå™¨è¦æŠŠè‡ªèº«çš„å…¬é’¥æ”¾åˆ°ä»£ç æ‰˜ç®¡ã€ç›®æ ‡æœºå™¨çš„ssh-keyåˆ—è¡¨ä¸­ 3.2 é…ç½®ç¤ºä¾‹ ç”Ÿäº§ç¯å¢ƒä¸­æœ‰javaã€phpã€pythoné¡¹ç›®ï¼Œå…¶ä¸­è¿˜æ˜¯ä»¥javaé¡¹ç›®å±…å¤šï¼Œæœ¬ç¤ºä¾‹ä¸­ä»¥æ›´æ–°nginxé¦–é¡µé¢æ¨¡æ‹Ÿé¡¹ç›® ç¤ºä¾‹ç¯å¢ƒ è§’è‰² æœºå™¨IP ä¸»æœºå walle 10.0.0.10 walle gitlab 10.0.0.12 gitlab web 10.0.0.13 webserver 3.2.1 ç”¨æˆ·ã€ç›®å½•æƒé™é…ç½® 3.2.1.1 ç“¦åŠ›ã€ç›®æ ‡webæœºå…±åŒé…ç½® ç“¦åŠ›æœºå™¨ã€ç›®æ ‡webæœºå™¨ç¦æ­¢rootè¿œç¨‹ç™»é™†ï¼Œé…ç½®sudoç”¨æˆ·æ˜¯wwwï¼Œå¹¶ä¸”wwwç”¨æˆ·ç™»é™†æ–¹å¼æ˜¯å¯†é’¥ç™»é™† ç¦æ­¢rootè¿œç¨‹ç™»é™†ï¼Œç¼–è¾‘æ–‡ä»¶/etc/ssh/sshd_configï¼Œç¼–è¾‘å®Œæˆåé‡å¯sshæœåŠ¡ #ç¦æ­¢rootè¿œç¨‹ç™»é™† PermitRootLogin no #ç¦ç”¨å¯†ç éªŒè¯ PasswordAuthentication no wwwç”¨æˆ·ç”Ÿæˆå¯†é’¥ su - www && ssh-keygen -t rsa -f /root/.ssh/id_dsa -P \"\" -q 3.2.1.2 ç“¦åŠ›æœºå™¨å•ç‹¬é…ç½® åˆ›å»ºä»£ç æ£€å‡ºä»“åº“å¹¶è®¾ç½®ç›®å½•æ‰€æœ‰è€…ä¸ºwww mkdir -p /data/walle/WebServer && chown www.www /data/walle/WebServer æ¨é€æœ¬æœºwwwç”¨æˆ·çš„å…¬é’¥åˆ°ç›®æ ‡webæœºå™¨çš„wwwç”¨æˆ· æŠŠç“¦åŠ›æœºå™¨wwwç”¨æˆ·~/.ssh/id_rsa.pubæ–‡ä»¶ä¸­çš„å†…å®¹å¤åˆ¶åˆ°ç›®æ ‡æœºå™¨wwwç”¨æˆ·ä¸‹çš„~/.ssh/authorized_keysä¸­ï¼Œå¹¶ä¸”authorized_keysæ–‡ä»¶æƒè®¾ç½®ä¸º644æˆ–600ï¼Œç›®å‰åªèƒ½æ‰‹åŠ¨å¤åˆ¶å†…å®¹ï¼Œæ²¡æœ‰æ‰¾åˆ°å‘½ä»¤è§£å†³æ–¹æ³• æŠŠæœ¬æœº.ssh/id_rsa.pubæ”¾åˆ°åç»­åˆ›å»ºçš„gitlabé¡¹ç›®ä¸­ï¼Œæ³¨æ„ä»¥ä¸‹é—®é¢˜ âš ï¸sshæœåŠ¡é…ç½®æ–‡ä»¶/etc/ssh/sshd_configä¸­æœ‰ä¸€é¡¹é…ç½®æ˜¯AuthorizedKeysFile .ssh/authorized_keysï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ç§é’¥å…å¯†ç™»é™†ï¼Œåˆ™å…¬é’¥å¿…é¡»å†™å…¥åˆ°æ–‡ä»¶.ssh/authorized_keysä¸­ï¼Œå³æ³¨å†Œç§é’¥ï¼Œå¦åˆ™å…å¯†ä¼šå¤±è´¥ï¼ï¼ï¼ 3.2.1.3 ç›®æ ‡webæœºå™¨å•ç‹¬é…ç½® å·²ç»rpmåŒ…å®‰è£…å¥½nginx1.16.1ï¼Œå¹¶ä¸”nginxä»¥wwwç”¨æˆ·è¿è¡Œ ç¼–è¾‘nginxè™šæ‹Ÿä¸»æœºé…ç½®æµ‹è¯•æ–‡ä»¶ cat > /etc/nginx/conf.d/walle-test.conf åœ¨ç“¦åŠ›ä¸­æˆ‘ä»¬é…ç½®äº†webrootæ˜¯/data/nginx/websiteï¼Œä½†æ˜¯ç“¦åŠ›ä¼šè‡ªåŠ¨ç”Ÿæˆæ­¤è½¯è¿æ¥ï¼Œå› æ­¤åªéœ€è¦åˆ›å»º/data/nginxå³å¯ mkdir -p /data/nginx && chown www.www /data/nginx åˆ›å»ºå‘å¸ƒç‰ˆæœ¬åº“å¹¶è®¾ç½®ç›®å½•æ‰€æœ‰è€…ä¸ºwww mkdir -p /data/release && chown www.www /data/release è¿™é‡Œçš„æµç¨‹å°±æ˜¯ï¼Œå¼€å‘å†™å¥½äº†index.htmlæ–‡ä»¶å†…å®¹å¹¶æäº¤åˆ°gitlabï¼Œç“¦åŠ›ä»gitlabæ‹‰å–index.htmlæ–‡ä»¶åˆ°æœ¬æœºçš„/data/walle/WebServer(è‡ªå®šä¹‰çš„ä»£ç æ£€å‡ºä»“åº“)ï¼Œç„¶åç“¦åŠ›åˆ©ç”¨rsyncæ¨é€ä»£ç è‡³/data/release/é¡¹ç›®å/æ—¶é—´ç›®å½•ï¼Œç„¶åç“¦åŠ›ä¸­é…ç½®çš„ç¨‹åºæ ¹ç›®å½•(webrootä¸­æŒ‡å®š)ä¼šè½¯é“¾æ¥åˆ°/data/release/é¡¹ç›®å/æ—¶é—´ç›®å½•ï¼Œè¿™æ ·å°±å¯ä»¥è®¿é—®webæœåŠ¡äº† 3.2.1.4 gitlabé…ç½® å¦‚æœæ˜¯åˆæ¬¡ä½¿ç”¨gitlabçš„è¯ï¼Œè¿˜éœ€è¦æŠŠgitlabæœºå™¨çš„rootç”¨æˆ·çš„å¯†é’¥æ·»åŠ åˆ°gitlabçš„ssh-keyåˆ—è¡¨ä¸­ åˆ›å»ºç»„ åˆ›å»ºç”¨æˆ· é…ç½®ä¸ªäººé€‰é¡¹ä¿¡æ¯ è®¾ç½®ç”¨æˆ·å¯†ç  âš ï¸æœªç™»é™†çš„ç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»é™†åéœ€è¦é‡æ–°è®¾ç½®å¯†ç ï¼Œç”Ÿäº§ä¸­æˆ‘ä»¬ç»™å¼€å‘åˆ›å»ºå®Œç”¨æˆ·åè®¾ç½®ä¸€ä¸ªåˆå§‹å¯†ç ï¼Œç„¶åç”±å¼€å‘è‡ªè¡Œä¿®æ”¹å¯†ç  å°†ç”¨æˆ·æ·»åŠ åˆ°ç»„ä¸­ gitlabç”¨æˆ·åœ¨ç»„é‡Œé¢æœ‰5ç§ä¸åŒæƒé™ï¼š Guestï¼šå¯ä»¥åˆ›å»ºissueã€å‘è¡¨è¯„è®ºï¼Œä¸èƒ½è¯»å†™ç‰ˆæœ¬åº“ Reporterï¼šå¯ä»¥å…‹éš†ä»£ç ï¼Œä¸èƒ½æäº¤ï¼ŒQAã€PM å¯ä»¥èµ‹äºˆè¿™ä¸ªæƒé™ Developerï¼šå¯ä»¥å…‹éš†ä»£ç ã€å¼€å‘ã€æäº¤ã€pushï¼Œæ™®é€šå¼€å‘å¯ä»¥èµ‹äºˆè¿™ä¸ªæƒé™ Maintainerï¼šå¯ä»¥åˆ›å»ºé¡¹ç›®ã€æ·»åŠ tagã€ä¿æŠ¤åˆ†æ”¯ã€æ·»åŠ é¡¹ç›®æˆå‘˜ã€ç¼–è¾‘é¡¹ç›®ï¼Œæ ¸å¿ƒå¼€å‘å¯ä»¥èµ‹äºˆè¿™ä¸ªæƒé™ Ownerï¼šå¯ä»¥è®¾ç½®é¡¹ç›®è®¿é—®æƒé™ - Visibility Levelã€åˆ é™¤é¡¹ç›®ã€è¿ç§»é¡¹ç›®ã€ç®¡ç†ç»„æˆå‘˜ï¼Œå¼€å‘ç»„ç»„é•¿å¯ä»¥èµ‹äºˆè¿™ä¸ªæƒé™ åœ¨ç”¨æˆ·ç»„ä¸­åˆ›å»ºé¡¹ç›® ä»¥åˆšæ‰åˆ›å»ºçš„æ–°ç”¨æˆ·èº«ä»½ç™»å½•åˆ°gitlabï¼Œç„¶ååœ¨ç”¨æˆ·ç»„ä¸­åˆ›å»ºæ–°çš„é¡¹ç›® æ·»åŠ å¯†é’¥ï¼Œå› ä¸ºè´¦å·æ˜¯ç»™å¼€å‘åˆ›å»ºçš„ï¼Œå› æ­¤éœ€è¦å¼€å‘æŠŠæœ¬æœºçš„sshå¯†é’¥æ·»åŠ  æŠŠç¨‹åºè¿è¡Œç”¨æˆ·wwwçš„å¯†é’¥æ·»åŠ åˆ°gitlabçš„é¡¹ç›®ä»“åº“ä¸­ï¼Œç“¦åŠ›æœºå™¨æ“ä½œ âš ï¸è¦æŠŠç“¦åŠ›æœºå™¨.ssh/id_rsa.pubå†™å…¥åˆ°.ssh/authorized_keysæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”æƒé™æ˜¯600ï¼Œå¦åˆ™ç“¦åŠ›æ£€æµ‹ä¼šæŠ¥é”™ 3.2.2 ç“¦åŠ›webé¡µé¢é¡¹ç›®å…·ä½“é…ç½®åŠä¸Šçº¿daemoæ¼”ç¤º 3.2.2.1 è¿™é‡Œä»…ä»…åšä¸€ä¸ªç®€å•çš„æ›´æ–°nginxæœåŠ¡çš„index.htmlæ–‡ä»¶æ¨¡æ‹Ÿä¸Šçº¿è¿‡ç¨‹ é…ç½®é¡¹ç›® 3.2.2.2 é…ç½®å®Œæˆåæ£€æµ‹ 3.2.2.3 åˆ›å»ºä¸Šçº¿å• 3.2.2.4 å¡«å†™ä¸Šçº¿å•ä¿¡æ¯ 3.2.2.5 ä¸Šçº¿å‰æäº¤æµ‹è¯•ä»£ç ï¼Œè¿™ä¸€æ­¥åº”è¯¥æ˜¯å¼€å‘æœ¬æœºæ“ä½œ ç¼–è¾‘æµ‹è¯•ä»£ç ï¼Œæäº¤åˆ°WebServerä»“åº“ Title ç¬¬ä¸€æ¬¡æµ‹è¯• 3.2.2.6 å¼€å§‹ä¸Šçº¿ ç‚¹å‡»éƒ¨ç½²å¼€å§‹ä¸Šçº¿ï¼Œå¦‚æœæŠ¥é”™æ ¹æ®æŠ¥é”™å†…å®¹è§£å†³ 3.2.2.7 æµè§ˆå™¨è®¿é—® ç›®æ ‡webæœºå™¨IP åœ°å€å³å¯ 3.2.3 webæœºå™¨é¡¹ç›®ç›®å½•è¯´æ˜ æˆ‘ä»¬åœ¨nginxé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†rootæ ¹ç›®å½•æ˜¯/data/nginx/websiteï¼Œä½†æ˜¯ä¸éœ€è¦åˆ›å»ºwebsiteå­ç›®å½•ï¼Œå› ä¸ºç“¦åŠ›ä¼šè‡ªåŠ¨è®¾ç½®è½¯è¿æ¥ï¼Œåªéœ€è¦åˆ›å»ºçˆ¶ç›®å½•å³å¯ï¼Œnginxçš„rootæ ¹ç›®å½•ä¼šè‡ªåŠ¨è½¯è¿æ¥è‡³/data/release/é¡¹ç›®å/æ—¶é—´ç›®å½• âš ï¸è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœåœ¨ç“¦åŠ›é…ç½®ç•Œé¢ä¸­å¯¹äºç›®æ ‡æœºå™¨çš„å‘å¸ƒç‰ˆæœ¬åº“åªæŒ‡å®š/data/releaseçš„è¯ï¼Œä¼šé»˜è®¤åœ¨è¿™ä¸ªç›®å½•ä¸‹é¢ç”Ÿæˆä¸€ä¸ªåä¸º1çš„ç›®å½•ï¼Œè™½ç„¶ä¸å½±å“è®¿é—®ï¼Œä½†æ˜¯ä¸å¤ªå¥½è§åçŸ¥æ„ï¼Œå› æ­¤æœ€å¥½è®¾ç½®ä¸º/data/release/é¡¹ç›®å ä¿®æ”¹ç›®æ ‡æœºå™¨çš„å‘å¸ƒç‰ˆåº“ä¸º/data/release/é¡¹ç›®åï¼Œè¿™æ ·çš„è¯å°±æ¯”è¾ƒå®¹æ˜“åŒºåˆ†äº† 3.2.4 é¡¹ç›®å›æ»šæ“ä½œ æœ‰çš„æ—¶å€™å‡çº§å®Œæˆåå¯èƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œå¹¶ä¸æ˜¯bugä¸Šçš„é—®é¢˜ï¼Œä¾‹å¦‚å¼€å‘å¿˜è®°æ‰“å¼€æŸä¸€ä¸ªåŠŸèƒ½æŒ‰é’®(ä¹‹å‰ç”Ÿäº§ç¯å¢ƒä¸­å‡ºç°è¿‡è¿™ç§æƒ…å†µï¼Œè™½ç„¶ä¸æ˜¯bugé—®é¢˜ï¼Œä½†æ˜¯æœåŠ¡åŠŸèƒ½ä¸Šæœ‰å½±å“)ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½éœ€è¦åšå›æ»šæ“ä½œ å›æ»šæ“ä½œå…¶å®å°±æ˜¯æ”¹å˜webæœºå™¨ä¸Šçš„è½¯é“¾æ¥ï¼Œwebæœºå™¨çš„ç¨‹åºæ ¹ç›®å½•é“¾æ¥åˆ°ä¸åŒçš„å‘å¸ƒç‰ˆæœ¬åº“ä¸‹å·²å®ç°ä¸åŒçš„åŠŸèƒ½ 3.2.4.1 è¿›è¡Œç¬¬äºŒæ¬¡ä¸Šçº¿ æ¨¡æ‹Ÿé—®é¢˜ ä¹‹å‰å·²ç»æœ‰è¿‡ç¬¬ä¸€æ¬¡ä¸Šçº¿äº†ï¼Œç°åœ¨è¿›è¡Œç¬¬äºŒæ¬¡ä¸Šçº¿ï¼Œç¼–è¾‘ä»£ç å¹¶æäº¤è‡³WebServerä»“åº“ Title å¢åŠ ä¸€ä¸ªå¾ˆç‰›é€¼çš„åŠŸèƒ½ ç“¦åŠ›ä¸Šçº¿ è®¿é—® webæœºå™¨IP ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶å†…å®¹å·²æ›´æ–° æ­¤æ—¶webæœºå™¨çš„ç›®å½•é“¾æ¥æƒ…å†µå¦‚ä¸‹ é“¾æ¥çš„ç›®å½•æ˜¯20200720-201541ï¼Œå¦‚æœè¦å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„è¯ï¼Œé“¾æ¥åº”è¯¥ä¼šæ”¹ä¸º20200720-195809 3.2.4.2 å‘ç°é—®é¢˜ï¼Œå¼€å§‹å›æ»š æ‰¾åˆ°ä¸Šä¸€æ¬¡å‡çº§çš„ä¸Šçº¿å•ï¼Œå¯ä»¥æ ¹æ®ä¸Šçº¿å•æ ‡é¢˜å’Œä¸Šçº¿cimmitå·(æ¨è)ï¼Œç‚¹å‡»å›æ»š å¼€å§‹å›æ»š æµè§ˆå™¨è®¿é—® webæœºå™¨IPï¼Œå¯ä»¥çœ‹åˆ°å·²ç»å›æ»šåˆ°ä¸Šä¸€æ¬¡æäº¤çš„å†…å®¹ æ­¤æ—¶webæœºå™¨çš„ç›®å½•é“¾æ¥æƒ…å†µå¦‚ä¸‹ é“¾æ¥çš„ç›®å½•æ˜¯20200720-201541ï¼Œå¦‚æœè¦å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„è¯ï¼Œé“¾æ¥åº”è¯¥ä¼šæ”¹ä¸º20200720-195809 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitea/giteaå®‰è£….html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitea/giteaå®‰è£….html","title":"giteaå®‰è£…","keywords":"","body":"giteaå®‰è£… ä¸€ã€giteaç®€ä»‹ Giteaæ˜¯ç”¨Goç¼–å†™çš„ç”±ç¤¾åŒºç®¡ç†çš„è½»é‡çº§ä»£ç æ‰˜ç®¡è§£å†³æ–¹æ¡ˆï¼Œç±»ä¼¼gitlabï¼Œä½†æ˜¯æ¯”gitlabå ç”¨èµ„æºå°å¤ªå¤šäº†ï¼Œgitlabèµ·ç 2G+å†…å­˜ï¼Œè€ŒgiteaæŒ¤éœ€è¦90Må°±èƒ½è·‘èµ·æ¥ï¼ï¼ï¼ æŒ¤éœ€ä½“éªŒä¸‰ç¿»é’Ÿï¼Œé‡Œé€ ä¼šå¹²æˆ‘ä¸€æ ·ï¼Œçˆ±ä¸Šä»‹æ¬¾è½¯ä»¶ï¼ï¼ï¼ â€‹ --- æ¸£æ¸£ç° giteaå®˜ç½‘ giteaè‹±æ–‡æ–‡æ¡£ giteaä¸­æ–‡æ–‡æ¡£ äºŒã€giteaå®‰è£… giteaå®‰è£…æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œè¯¦æƒ…çœ‹å®˜ç½‘ï¼Œè¿™é‡Œé€‰æ‹©dockerå®‰è£…ï¼Œdockerå®‰è£…ä¸­çš„æ•°æ®åº“æœ‰3ç§ï¼Œsqlite3ã€mysqlã€pg 2.1ä¸‹è½½giteaé•œåƒ å¯ä»¥é€šè¿‡dockerhubä¸‹è½½å¯¹åº”çš„giteaé•œåƒ docker pull gitea/gitea:1.11.1 2.2ä¸‹è½½dcoker-compose docker-composeå›½å†…åœ°å€ docker-composeå®˜æ–¹åœ°å€ curl -L https://get.daocloud.io/docker/compose/releases/download/1.12.0/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose 2.3ç¼–è¾‘gitea docker-composeæ–‡ä»¶ 1.åˆ›å»ºç›®å½• mkdir /usr/local/gitea && cd /usr/local/gitea 2.ç¼–è¾‘giteaæ–‡ä»¶ cat >docker-compose.yaml 3000/tcp, 0.0.0.0:222->22/tcp gitea_server_1 b8f0be18fe78 postgres:9.6 \"docker-entrypoint.sâ€¦\" 27 seconds ago Up 26 seconds 5432/tcp gitea_db_1 2.4giteaæ•°æ®åº“è®¾ç½® æµè§ˆå™¨è®¿é—®IP:3000 åˆå§‹ç•Œé¢å¦‚ä¸‹ï¼Œç¬¬ä¸€ä¸ªæ³¨å†Œçš„ç”¨æˆ·å°±æ˜¯ç®¡ç†å‘˜ï¼Œåç»­å¯ä»¥è®¾ç½®åªæœ‰ç®¡ç†å‘˜èƒ½æ³¨å†Œè´¦å·ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨å¯é€‰è®¾ç½®ä¸­è®¾ç½® æ•°æ®åº“è®¾ç½® ä¸€èˆ¬è®¾ç½® å¯ä»¥è‡ªå®šä¹‰ä»“åº“æ ¹ç›®å½•å’Œæ—¥å¿—ç›®å½• å¯é€‰è®¾ç½® âš ï¸å¦‚æœè¿™é‡Œå‹¾é€‰äº†ç¦æ­¢ç”¨æˆ·è‡ªä¸»æ³¨å†Œå°±å¿…é¡»è®¾ç½®ç®¡ç†å‘˜ä¿¡æ¯ï¼Œå¦åˆ™ä½ ä¸å…è®¸æ³¨å†Œåˆæ²¡è®¾ç½®ç®¡ç†å‘˜ä¿¡æ¯é‚£ä¼ä¸æ˜¯ğŸ”ğŸ”æ–¯å¯†è¾¾äº†ï¼Ÿ ç™»é™†åé¦–ç•Œé¢ å‰©ä¸‹çš„æ“ä½œå°±ä¸ç”¨å¤šè¯´äº†ï¼Œåˆ›å»ºä»“åº“ã€ç»„ç»‡ã€ç”¨æˆ·ï¼Œä¸Šä¼ ä»£ç ã€æ‹‰å–ä»£ç ç­‰ç­‰ 2.5é…ç½®æ–‡ä»¶ä¿®æ”¹é¡¹ å…³äºæœåŠ¡çš„ä¸€äº›ä¿®æ”¹ï¼Œé…ç½®æ–‡ä»¶æ˜¯gitea/gitea/conf/app.ini ä¾‹å¦‚ï¼Œæ‰‹åŠ¨å…³é—­é¡µé¢æ³¨å†ŒæŒ‰é’®ï¼Œä¿®æ”¹app.iniæ–‡ä»¶ä¸­çš„SHOW_REGISTRATION_BUTTONä¸€é¡¹ å…¶ä»–çš„é…ç½®ä¸Šå®˜ç½‘çœ‹ æˆ‘å–œæ¬¢è¿™ä¸ªè½¯ä»¶æœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯è¿™ä¸ªè½¯ä»¶æ”¯æŒä¸­æ–‡ï¼ï¼ï¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabå®‰è£…/CentOS7.5å®‰è£…gitlab-ce11.8.3.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabå®‰è£…/CentOS7.5å®‰è£…gitlab-ce11.8.3.html","title":"CentOS7.5å®‰è£…gitlab-11.8.3","keywords":"","body":"CentOS7.5å®‰è£…gitlab-ce11.8.3 gitlabå®˜æ–¹å®‰è£…æ–‡æ¡£ gitlabå®˜æ–¹ä¸‹è½½åœ°å€ ä¸€ã€ç³»ç»Ÿç¯å¢ƒ 1.1ç³»ç»Ÿç‰ˆæœ¬ [root@gitlab ~]# cat /etc/redhat-release CentOS Linux release 7.5.1804 (Core) 1.2å†…å­˜ [root@gitlab ~]# free -m total used free shared buff/cache available Mem: 3934 107 3696 11 130 3625 Swap: 1023 0 1023 1.3IP [root@gitlab ~]# ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:0c:29:60:5b:13 brd ff:ff:ff:ff:ff:ff inet 10.0.0.70/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::20c:29ff:fe60:5b13/64 scope link valid_lft forever preferred_lft forever äºŒã€å®‰è£…æ­¥éª¤ 2.1å®‰è£…ä¾èµ–åŒ… //å®‰è£…ä¾èµ–åŒ… [root@gitlab ~]# yum -y install curl openssh-server openssh-clients postfix cronie policycoreutils-python //å¯åŠ¨postfix [root@gitlab ~]# systemctl start postfix && systemctl enable postfix 2.2ä¸‹è½½gitlabå®‰è£…åŒ…å¹¶å®‰è£… //ä»æ¸…åå¤§å­¦é•œåƒæºä¸‹è½½ [root@gitlab ~]# wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.8.3-ce.0.el7.x86_64.rpm //å®‰è£…bitlab [root@gitlab ~]# yum -y localinstall gitlab-ce-11.8.3-ce.0.el7.x86_64.rpm 2.3ä¸‹è½½git [root@gitlab ~]# yum -y install git 2.4ä¿®æ”¹gitlabé…ç½®æ–‡ä»¶ [root@gitlab ~]# vim /etc/gitlab/gitlab.rb ä¿®æ”¹13è¡Œ xternal_url 'http://gitlab.example.com' ä¿®æ”¹ä¸ºæœ¬æœºIPåœ°å€ external_url 'http://10.0.0.70' //è¯´æ˜ /opt/gitlab #gitlabçš„ç¨‹åºå®‰è£…ç›®å½• /var/opt/gitlab #gitlabç›®å½•æ•°æ®ç›®å½• /var/opt/gitlab/git-dfata #å­˜æ”¾ä»“åº“æ•°æ® 2.5å¯åŠ¨gitlab //å¯åŠ¨gitlab [root@gitlab ~]# gitlab-ctl start //é‡è½½gitlabé…ç½®æ–‡ä»¶ [root@gitlab ~]# gitlab-ctl reconfigure é‡è½½å®Œæˆåä¼šæç¤ºå¦‚ä¸‹ Running handlers: Running handlers complete Chef Client finished, 473/1265 resources updated in 03 minutes 25 seconds gitlab Reconfigured! //gitlabå¯åŠ¨çš„ç«¯å£ [root@gitlab ~]# netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:8060 0.0.0.0:* LISTEN 3456/nginx: master tcp 0 0 127.0.0.1:9121 0.0.0.0:* LISTEN 3901/redis_exporter tcp 0 0 127.0.0.1:9090 0.0.0.0:* LISTEN 3913/prometheus tcp 0 0 127.0.0.1:9187 0.0.0.0:* LISTEN 3960/postgres_expor tcp 0 0 127.0.0.1:9093 0.0.0.0:* LISTEN 3946/alertmanager tcp 0 0 127.0.0.1:9100 0.0.0.0:* LISTEN 3881/node_exporter tcp 0 0 127.0.0.1:9229 0.0.0.0:* LISTEN 3858/gitlab-workhor tcp 0 0 127.0.0.1:9168 0.0.0.0:* LISTEN 3891/puma 3.12.0 (t tcp 0 0 127.0.0.1:8080 0.0.0.0:* LISTEN 3360/unicorn master tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 3456/nginx: master tcp 0 0 127.0.0.1:8082 0.0.0.0:* LISTEN 3397/sidekiq 5.2.5 tcp 0 0 127.0.0.1:9236 0.0.0.0:* LISTEN 3841/gitaly tcp6 0 0 :::9094 :::* LISTEN 3946/alertmanager tcp6 0 0 ::1:9168 :::* LISTEN 3891/puma 3.12.0 (t //gitlabç›¸å…³å‘½ä»¤ gitlab-ctl status #æŸ¥çœ‹ç›®å‰gitlabæ‰€æœ‰æœåŠ¡è¿ç»´çŠ¶æ€ gitlab-ctl stop #åœæ­¢gitlabæœåŠ¡ gitlab-ctl stop nginx #å•ç‹¬åœæ­¢æŸä¸ªæœåŠ¡ gitlab-ctl tail #æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çš„æ—¥å¿— 2.6gitlabæ±‰åŒ– //ä¸‹è½½æœ€æ–°æ±‰åŒ–åŒ… [root@gitlab ~]# git clone https://gitlab.com/xhang/gitlab.git //ä¸‹è½½gitlabå¯¹åº”ç‰ˆæœ¬æ±‰åŒ–åŒ…ï¼Œä¸‹è½½åæ˜¯ä¸€ä¸ªgitlabåç§°çš„ç›®å½• [root@gitlab ~]# git clone https://gitlab.com/xhang/gitlab.git -b v11.8.3-zh [root@gitlab ~]# ls //åˆ‡æ¢åˆ°æ±‰åŒ–åŒ…ç›®å½•ï¼Œæ¯”è¾ƒæ±‰åŒ–æ ‡ç­¾å’ŒåŸæ ‡ç­¾ï¼Œå¯¼å‡ºpatchç”¨çš„diffæ–‡ä»¶åˆ°/rootä¸‹ [root@gitlab ~]# cd gitlab [root@gitlab gitlab]# git diff v11.8.3 v11.8.3-zh > ../11.8.3-zh.diff [root@gitlab ~]# ls 11.8.3-zh.diff //å°†11.8.3-zh.diffä½œä¸ºè¡¥ä¸æ›´æ–°åˆ°gitlabä¸­ [root@gitlab ~]# yum -y install patch [root@gitlab ~]# patch -d /opt/gitlab/embedded/service/gitlab-rails -p1 2.7æµè§ˆå™¨è®¿é—®gitlab å¦‚æœæµè§ˆå™¨è®¿é—®å‡ºç°502 éœ€è¦ç¨ç­‰ä¸€ä¼š gitlabè¿˜æ²¡æœ‰å®Œå…¨å¯åŠ¨ è®¾ç½®å¯†ç ï¼Œæœ€å°‘8ä½æ•° ç™»é™†gitlabï¼Œç”¨æˆ·åä¸ºrootï¼Œå¯†ç ä¸ºè‡ªå·±è®¾ç½®çš„å¯†ç  ç™»é™†åé¦–ç•Œé¢ï¼Œæœ‰ä¸€éƒ¨åˆ†æ²¡æœ‰æ±‰åŒ–ï¼Œæ±‰åŒ–åŒ…çš„åŸå›  æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabå®‰è£…/gitlabå®‰è£…æœ€æ–°ç‰ˆ.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabå®‰è£…/gitlabå®‰è£…æœ€æ–°ç‰ˆ.html","title":"gitlabæœ€æ–°ç‰ˆå®‰è£…","keywords":"","body":"å®‰è£…gitlabæœ€æ–°ç‰ˆ ä¸€ã€dockerå®‰è£…gitlabæœ€æ–°ç‰ˆ dockerå®‰è£…gitlabå®˜æ–¹æ–‡æ¡£ 1.å®‰è£…docker-compose docker-compose githubåœ°å€ 1.ä¸‹è½½å®‰è£…åŒ… curl -L \"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose 2.ç»™äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ å¯æ‰§è¡Œæƒé™ chmod +x /usr/local/bin/docker-compose 3.å®Œæˆå®‰è£…ï¼ŒæŸ¥çœ‹ç‰ˆæœ¬ $ docker-compose -v docker-compose version 1.24.1, build 4667896b 2.åˆ›å»ºå­˜æ”¾docker-composeæ–‡ä»¶ç›®å½• mkdir /usr/local/gitlab cd /usr/local/gitlab 3.ç¼–è¾‘docker-compose.ymlæ–‡ä»¶ #éœ€è¦ä¿®æ”¹ç›¸å¯¹åº”çš„åŸŸååŠæ˜ å°„çš„ç«¯å£ cat >docker-compose.yml 4.å¯åŠ¨å®¹å™¨ docker-compose up -d 5.æŸ¥çœ‹å¯åŠ¨çš„å®¹å™¨ [root@docker1 gitlab]# docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 146a96210725 gitlab/gitlab-ce:latest \"/assets/wrapper\" 2 minutes ago Up 2 minutes (health: starting) 0.0.0.0:443->443/tcp, 0.0.0.0:22->22/tcp, 0.0.0.0:80->80/tcp gitlab_web_1 äºŒã€yumå®‰è£…gitlabæœ€æ–°ç‰ˆ curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash yum -y install gitlab-ce æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabé—®é¢˜/gitlabä¸€äº›é—®é¢˜æ±‡æ€».html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabé—®é¢˜/gitlabä¸€äº›é—®é¢˜æ±‡æ€».html","title":"gitlabä¸€äº›é—®é¢˜æ±‡æ€»","keywords":"","body":"gitlabä¸€äº›é—®é¢˜æ±‡æ€» 1.å…³äºgitlab7.12.0åˆå§‹å¯†ç çš„é—®é¢˜ èƒŒæ™¯ï¼šå…¬å¸ç”¨çš„gitlabç‰ˆæœ¬æ˜¯7.12.0ï¼Œè‡ªå·±åœ¨è™šæ‹Ÿæœºä¸­å®‰è£…çš„æ—¶å€™å‘ç°æ‰¾ä¸åˆ°åˆå§‹å¯†ç ï¼Œå„ç§ç™¾åº¦æ€»ç»“å‡ºä»¥ä¸‹ä¸¤ç‚¹ 1.å¿…é¡»æ‰§è¡Œä»¥ä¸‹æˆæƒå‘½ä»¤ï¼Œå¦åˆ™ä¼šæŠ¥502ï¼ŒåŸå› æœªçŸ¥ chmod -R o+x /var/opt/gitlab/gitlab-rails 2.gitlab7.12.0åˆå§‹å¯†ç  root 5iveL!fe 2.gitlabå®˜ç½‘æ³¨å†Œæ—¶é‡åˆ°çš„é—®é¢˜ æ³¨å†Œgitlabæ—¶æç¤ºå¦‚ä¸‹ åŸå›  ä¸Šé¢çš„é”™è¯¯æ˜¯å› ä¸ºæ³¨å†Œæ—¶æœ‰ä¸€ä¸ªgoogleçš„éªŒè¯ç éœ€è¦è¾“å…¥ã€‚ä½†æ˜¯ä¸­å›½æ— æ³•è®¿é—®google,å› æ­¤æ— æ³•è®¿é—®å¹¶è¾“å…¥è¯¥éªŒè¯ç å¯¼è‡´ è§£å†³æ–¹æ³• ç¿»å¢™æˆ–è€…é€šè¿‡ä¸‹æ–¹çš„Githubç™»é™† 3.yumå®‰è£…gitlabæœ€æ–°ç‰ˆ curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash yum -y install gitlab-ce 4.ä¿®æ”¹gitlabé»˜è®¤80ç«¯å£ âš ï¸ä¿®æ”¹å®Œgitlabé»˜è®¤çš„80ç«¯å£ååªéœ€é‡å¯ï¼Œä¸èƒ½é‡è½½é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™ä¼šè¿˜åŸ //ä¿®æ”¹gitlabé»˜è®¤80ç«¯å£ vim /var/opt/gitlab/nginx/conf/gitlab-http.conf //é‡å¯å³å¯ï¼Œä¸èƒ½é‡è½½é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™ä¼šè¦†ç›–ä¿®æ”¹ gitlab-ctl restart æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabé—®é¢˜/gitlabé22ç«¯å£é—®é¢˜.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabé—®é¢˜/gitlabé22ç«¯å£é—®é¢˜.html","title":"gitlabé22ç«¯å£é—®é¢˜","keywords":"","body":"gitlabé22ç«¯å£é—®é¢˜ èƒŒæ™¯è¯´æ˜ï¼š gitlabæ˜¯dockerå¯åŠ¨çš„ï¼Œsshç«¯å£22æ˜ å°„åˆ°äº†å®¿ä¸»æœºçš„222ç«¯å£ï¼Œåœ¨æ·»åŠ è¿œç¨‹ä»“åº“åœ°å€æ—¶å†™æˆäº†è¿™æ · git remote add origin git@10.0.0.13:222/root/jenkins-test1.gitï¼Œå·²ç»æŠŠæœºå™¨çš„å…±é’¥æ·»åŠ åˆ°äº†gitlabä»£ç ä»“åº“ä¸­ï¼Œä½†æ˜¯æ¨é€ä»£ç çš„æ—¶å€™è¿˜æ˜¯æç¤ºéœ€è¦è¾“å…¥å¯†ç  åŸå› ï¼š è¿œç¨‹ä»“åº“åœ°å€ä¸æ­£ç¡® é”™è¯¯åœ°å€ï¼šgit remote add origin git@10.0.0.13:222/root/jenkins-test1.git æ­£ç¡®åœ°å€ï¼š git remote add origin ssh://git@10.0.0.13:222/root/jenkins-test.git é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ åªèƒ½å…ˆæŠŠä»“åº“å…‹éš†ä¸‹æ¥ç„¶åå†æäº¤ä»£ç ï¼Œç›´æ¥æäº¤ä»£ç ä¼šæŠ¥é”™ï¼ŒåŸå› æœªçŸ¥ 1.åˆ é™¤ä¹‹å‰æ·»åŠ çš„è¿œç¨‹åœ°å€å¹¶é‡æ–°æ·»åŠ  git remote rm origin git remote add origin ssh://git@10.0.0.13:222/root/jenkins-test.git 2.æäº¤ä»£ç ï¼ŒæŠ¥é”™ä»“åº“ä¸å­˜åœ¨ #æäº¤ä»£ç ï¼ŒæŠ¥é”™ä»“åº“ä¸å­˜åœ¨ $ git push origin master remote: remote: ======================================================================== remote: remote: The project you were looking for could not be found. remote: remote: ======================================================================== remote: fatal: Could not read from remote repository. Please make sure you have the correct access rights and the repository exists. è§£å†³æ–¹æ³• åªèƒ½å…ˆæŠŠè¿œç¨‹ä»“åº“å…‹éš†ä¸‹æ¥ï¼Œç„¶åå†æäº¤å°±å¯ä»¥äº† #ä¼šæç¤ºæ·»åŠ äº†ä¸€ä¸ªç©ºå­˜å‚¨åº“ $ git clone ssh://git@10.0.0.13:222/root/jenkins-test1.git Cloning into 'jenkins-test1'... warning: You appear to have cloned an empty repository. æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabé…ç½®æ–‡ä»¶ä¿®æ”¹/gitlabé…ç½®æ–‡ä»¶ä¿®æ”¹è®°å½•.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabé…ç½®æ–‡ä»¶ä¿®æ”¹/gitlabé…ç½®æ–‡ä»¶ä¿®æ”¹è®°å½•.html","title":"gitlabé…ç½®æ–‡ä»¶ä¿®æ”¹è®°å½•","keywords":"","body":"gitlabé…ç½®æ–‡ä»¶ä¿®æ”¹è®°å½• gitlabä¿®æ”¹æ—¶åŒº ä¿®æ”¹gitlabé…ç½®æ–‡ä»¶ gitlab.rb ä¿®æ”¹ gitlab_rails['time_zone'] = 'UTC' ä¿®æ”¹ä¸º gitlab_rails['time_zone'] = 'Asia/Shanghai' gitlabä¿®æ”¹é»˜è®¤80ç«¯å£ ä¿®æ”¹ /var/opt/gitlab/nginx/conf/gitlab-http.conf æ–‡ä»¶ä¸­ listen å¤„ âš ï¸ ä¾æ¬¡æ‰§è¡Œå®Œå‘½ä»¤ gitlab-ctl restart å’Œ gitlab-ctl reconfigure æ‰ä¼šæœ‰æ–‡ä»¶ /var/opt/gitlab/nginx/conf/gitlab-http.conf server { listen *:80; ... âš ï¸ ä¿®æ”¹å®Œåæ‰§è¡Œ gitlab-ctl restart é‡å¯å³å¯ï¼Œä¸èƒ½æ‰§è¡Œ gitlab-ctl reconfigure é‡è½½é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™ä¼šè¦†ç›–ä¿®æ”¹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabä½¿ç”¨/1.å…³é—­gitlabè‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabä½¿ç”¨/1.å…³é—­gitlabè‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½.html","title":"å…³é—­gitlabæ³¨å†ŒåŠŸèƒ½","keywords":"","body":"å…³é—­gitlabè‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½ gitlabç™»é™†ç•Œé¢é»˜è®¤æœ‰æ³¨å†ŒåŠŸèƒ½ï¼Œå¯æ ¹æ®éœ€æ±‚å…³é—­ ç¬¬ä¸€æ­¥ã€é€‰æ‹© Admin area ç¬¬äºŒæ­¥ã€é€‰æ‹© Settings ç¬¬ä¸‰æ­¥ã€æ‰¾åˆ° Sing-up Restrictions å–æ¶ˆå‹¾é€‰ Sign-up enabled ç„¶åä¿å­˜ ç¬¬å››æ­¥ã€é€€å‡ºéªŒè¯ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabä½¿ç”¨/2.è®¾ç½®gitlabåˆ†æ”¯ä¿æŠ¤.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/gitlab/gitlabä½¿ç”¨/2.è®¾ç½®gitlabåˆ†æ”¯ä¿æŠ¤.html","title":"è®¾ç½®gitlabåˆ†æ”¯ä¿æŠ¤","keywords":"","body":"è®¾ç½®gitlabåˆ†æ”¯ä¿æŠ¤ ç¬¬ä¸€æ­¥ã€æ–°å»ºç»„ã€é¡¹ç›®ã€ç”¨æˆ· gitlabä¸­ä»¥rootç”¨æˆ·æ–°å»ºä¸€ä¸ªç»„ï¼Œåç§°ä»»æ„ï¼›ä¸€ä¸ªé¡¹ç›®ï¼Œåç§°ä»»æ„ï¼›æ–°å»ºæµ‹è¯•ç”¨æˆ·ï¼Œåç§°ä»»æ„ è¿™é‡Œæ–°å»ºç»„ test ï¼Œæ–°å»ºé¡¹ç›® testï¼Œæ–°å»ºç”¨æˆ· xiaoming å¹¶è®¾ç½®å¯†ç  ç¬¬äºŒæ­¥ã€é…ç½®å…¬é’¥åŠæƒé™ é€‰æ‹©å¦å¤–ä¸€å°æœºå™¨ï¼Œåšä¸ºæµ‹è¯•æœºï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆå¯†é’¥å¯¹ï¼Œè¿™é‡ŒæŠŠæµ‹è¯•ç”¨æˆ· xiaoming çš„å…¬é’¥æ·»åŠ gitlabè´¦æˆ·ä¸­ #ç”Ÿæˆå¯†é’¥ ssh-keygen -t rsa -f ~/.ssh/id_rsa -P '' -q #æ³¨å†Œå¯†é’¥ cat .ssh/id_rsa.pub >> ~/.ssh/authorized_keys æ·»åŠ æµ‹è¯•æœº root ç”¨æˆ·çš„å…¬é’¥åˆ° xiaoming ç”¨æˆ·ä¸­ gitlab rootç”¨æˆ·ç«¯æŠŠæµ‹è¯•ç”¨æˆ· xiaoming æ·»åŠ åˆ°æµ‹è¯•é¡¹ç›®ä¸­å¹¶è®¾ç½®æƒé™ä¸º Developer ç¬¬ä¸‰æ­¥ã€æµ‹è¯•æœºå…‹éš†gitlabç«¯åˆ›å»ºçš„é¡¹ç›®å¹¶åˆ›å»ºæ–‡ä»¶æäº¤è‡³masteråˆ†æ”¯ æµ‹è¯•æœºå…‹éš†é¡¹ç›® âš ï¸è¿™é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ªåŸŸå âš ï¸å¦‚æœgitlabæ˜¯dockerå¯åŠ¨çš„ï¼Œå¹¶ä¸”æŠŠå®¿ä¸»æœºçš„ä»»æ„sshç«¯å£æ˜ å°„åˆ°dockerå®¹å™¨ä¸­ï¼Œåˆ™åœ¨å…‹éš†çš„æ—¶å€™éœ€è¦æ³¨æ„ä¿®æ”¹å…‹éš†è¿œç¨‹ä»“åº“çš„åœ°å€å½¢å¼ é”™è¯¯åœ°å€ï¼šgit remote add origin git@10.0.0.13:222/root/jenkins-test1.git æ­£ç¡®åœ°å€ï¼š git remote add origin ssh://git@10.0.0.13:222/root/jenkins-test.git git clone ssh://git@gitlab.my.com:222/test/test.git æµ‹è¯•æœºåˆ›å»ºæ–‡ä»¶å¹¶æ¨é€ä»£ç  #é…ç½®ç”¨æˆ·ã€é‚®ç®±ä¿¡æ¯ $ git config --local user.name 'xiaoming' $ git config --local user.email 'xiaoming@163.com' $ touch branch-test $ git add . $ git commit -m 'touch branch-test' [master (root-commit) 2583ff0] touch branch-test 1 file changed, 0 insertions(+), 0 deletions(-) create mode 100644 branch-test $ git push origin master Counting objects: 3, done. Writing objects: 100% (3/3), 212 bytes | 0 bytes/s, done. Total 3 (delta 0), reused 0 (delta 0) To ssh://git@gitlab.my.com:222/test/test.git * [new branch] master -> master ä¸Šè¿°æ“ä½œå¯ä»¥çœ‹åˆ°ï¼Œæ™®é€šç”¨æˆ· xiaoming æ˜¯å¯ä»¥ç›´æ¥æ¨é€ä»£ç åˆ° master åˆ†æ”¯çš„ï¼Œæ¥ä¸‹æ¥åšåˆ†æ”¯ä¿æŠ¤ï¼Œåªå…è®¸é¡¹ç›®çš„masterçš„èƒ½æ¨é€åˆ°masteråˆ†æ”¯ ç¬¬å››æ­¥ã€gitlabé…ç½®åˆ†æ”¯ä¿æŠ¤ è¿›å…¥é¡¹ç›®ï¼Œ Settings --> Repository Protected Branches --> Expand Branchï¼šä½ è¦ä¿æŠ¤çš„åˆ†æ”¯(masteræˆ–è€…dev) Allowed to mergeï¼šè°æœ‰æƒé™å»è·Ÿè¿™ä¸ªåˆ†æ”¯åˆå¹¶ Allowed to pushï¼šå…è®¸å¾€åˆ†æ”¯ä¸Šå»æ¨é€ è®¾ç½®å®Œæˆåç‚¹å‡» Protect æµ‹è¯•æœºå†æ¬¡æ¨é€ï¼Œå¯ä»¥çœ‹åˆ°ä¼šæç¤ºä¸è¢«å…è®¸ $ git add . $ git commit -m 'masteråˆ†æ”¯ä¿æŠ¤æµ‹è¯•' [master ab7374e] masteråˆ†æ”¯ä¿æŠ¤æµ‹è¯• 1 file changed, 1 insertion(+) $ git push origin master Counting objects: 5, done. Delta compression using up to 2 threads. Compressing objects: 100% (2/2), done. Writing objects: 100% (3/3), 310 bytes | 0 bytes/s, done. Total 3 (delta 0), reused 0 (delta 0) remote: GitLab: You are not allowed to push code to protected branches on this project. To ssh://git@gitlab.my.com:222/test/test.git ! [remote rejected] master -> master (pre-receive hook declined) error: failed to push some refs to 'ssh://git@gitlab.my.com:222/test/test.git' émasterç”¨æˆ·æäº¤åˆå¹¶è¯·æ±‚ xiaoming ç”¨æˆ·æ— æ³•æ¨é€ä»£ç åˆ° master åˆ†æ”¯ï¼Œå› ä¸ºæœ‰ master åˆ†æ”¯ä¿æŠ¤ ç‚¹å‡» Merge requests å‘èµ·åˆå¹¶ä»£ç è¯·æ±‚ ç‚¹å‡» New merge request in test é€‰æ‹©æºåˆ†æ”¯å’Œåˆå¹¶åˆ†æ”¯ å¡«å†™æ ‡é¢˜ã€æè¿°ã€æäº¤ä¿¡æ¯ æäº¤å®Œæˆ ç™»é™†åˆ°rootç”¨æˆ·æŸ¥çœ‹åˆå¹¶è¯·æ±‚ é€‰æ‹© Merge åˆå¹¶å®Œåå°±å¯ä»¥çœ‹åˆ°åˆå¹¶åçš„ä»£ç äº† æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/jenkins/jenkinså®‰è£…/CentOS7.5å®‰è£…jenkins-2.176.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/jenkins/jenkinså®‰è£…/CentOS7.5å®‰è£…jenkins-2.176.html","title":"CentOS7.5å®‰è£…jenkins-2.176","keywords":"","body":"CentOS7.5å®‰è£…jenkins-2.176 jenkinsä¸­æ–‡å®˜ç½‘ jenkinså®˜ç½‘ 1.å®‰è£…jdk8 jenkinsè¿è¡Œä¾èµ–jdk è‡ªè¡Œåˆ°oracleå®˜ç½‘ä¸‹è½½jdk 1.è§£å‹ç¼©åŒ… [root@jenkins ~]# tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local 2.å¯¼å‡ºç¯å¢ƒå˜é‡ [root@jenkins ~]# cat >/etc/profile.d/jdk8.sh 2.å®‰è£…jenkinsï¼Œè¿™é‡Œå®‰è£…é•¿æœŸæ”¯æŒç‰ˆ #å®‰è£…LTS(é•¿æœŸæ”¯æŒç‰ˆ) LTS (é•¿æœŸæ”¯æŒ) ç‰ˆæœ¬æ¯12å‘¨ä»å¸¸è§„ç‰ˆæœ¬æµä¸­é€‰æ‹©ï¼Œä½œä¸ºè¯¥æ—¶é—´æ®µçš„ç¨³å®šç‰ˆæœ¬ã€‚ [root@jenkins ~]# curl -o /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo [root@jenkins ~]# rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key [root@jenkins ~]# yum -y install jenkins #å®‰è£…æ¯å‘¨æ›´æ–°ç‰ˆ æ¯å‘¨éƒ½ä¼šå‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼Œä¸ºç”¨æˆ·å’Œæ’ä»¶å¼€å‘äººå‘˜æä¾›é”™è¯¯ä¿®å¤å’ŒåŠŸèƒ½ã€‚ [root@jenkins ~]# curl -o /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat/jenkins.repo [root@jenkins ~]# rpm --import https://pkg.jenkins.io/redhat/jenkins.io.key [root@jenkins ~]# yum -y install jenkins #å®‰è£…æŒ‡å®šç‰ˆæœ¬ https://pkg.jenkins.io/redhat-stable/ 3.ä¿®æ”¹jenkinsé…ç½®æ–‡ä»¶ï¼Œè®©jenkinsä»¥rootç”¨æˆ·è¿è¡Œ [root@jenkins ~]# sed -i.bak '29cJENKINS_USER=\"root\"' /etc/sysconfig/jenkins 4.å¯åŠ¨jenkins #å¯åŠ¨jeninså¹¶åŠ å…¥å¼€æœºè‡ªå¯ [root@jenkins ~]# systemctl enable jenkins && systemctl start jenkins 5.æµè§ˆå™¨è®¿é—®jenkins jenkinsåˆšå¯åŠ¨æ¯”è¾ƒæ…¢ï¼Œç­‰å¾…å¯åŠ¨å®Œæˆ ä»/var/lib/jenkins/secrets/initialAdminPasswordæ–‡ä»¶æŒ‰ä¸­è·å–å¯†ç  æ˜¯å¦å®‰è£…æ’ä»¶ï¼Œè‡ªè¡Œé€‰æ‹© é€‰æ‹©æ’ä»¶è¿›è¡Œå®‰è£…ï¼Œå¿…é¡»é€‰æ‹©Localeæ’ä»¶ï¼Œä¿®æ”¹jenkinsè¯­è¨€ ç­‰å¾…å®‰è£…å®Œæˆ æ’ä»¶å®‰è£…å®Œæˆååˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼Œè¾“å…¥å¯†ç ã€ç”¨æˆ·å…¨åã€é‚®ä»¶åœ°å€ jenkins URLé»˜è®¤ä¸ºä¸»æœºIPåœ°å€åŠ 8080ç«¯å£ jenkinsé¦–ç•Œé¢ 6.è®¾ç½®jenkinsé»˜è®¤è¯­è¨€ä¸ºä¸­æ–‡ é€‰æ‹©jenkinsç®¡ç† é…ç½®ç³»ç»Ÿ é»˜è®¤è¯­è¨€å¡«å†™zh_CN æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/jenkins/jenkinså®‰è£…/dockerå®‰è£…jenkins.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/jenkins/jenkinså®‰è£…/dockerå®‰è£…jenkins.html","title":"dockerå®‰è£…jenkins","keywords":"","body":"dockerå®‰è£…jenkins docker jenkins ä¸­å›½å®šåˆ¶ç‰ˆè¯´æ˜ jenkinså®‰è£…æ’ä»¶çš„æ—¶å€™ç”±äºæºåœ¨å›½å¤–ï¼Œå› æ­¤å®‰è£…ä¼šéå¸¸æ…¢ç”šè‡³å¤±è´¥ï¼Œå½“ç„¶ä¹Ÿæœ‰å›½å†…æºå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦è‡ªè¡Œä¿®æ”¹æ–‡ä»¶ï¼Œjenkinsä¸­æ–‡ç¤¾åŒºæ¨å‡ºäº†ä¸­å›½å®šåˆ¶ç‰ˆçš„jenkins dockeré•œåƒï¼Œåªéœ€è¦ä¸‹è½½ç›¸åº”çš„dockeré•œåƒå¹¶å¯åŠ¨å®¹å™¨å³å¯ï¼Œä¸éœ€è¦åšä»»ä½•ä¿®æ”¹æ“ä½œï¼Œå¹¶ä¸”å®‰è£…åjenkinsæ’ä»¶ä¸‹è½½é€Ÿåº¦æœ‰æ˜æ˜¾çš„æå‡ docker jenkinsä¸­å›½å®šåˆ¶ç‰ˆ dockerhubåœ°å€ docker jenkinsä¸­å›½å®šåˆ¶ç‰ˆ githubåœ°å€ jenkinsä¸­æ–‡ç¤¾åŒºç»´æŠ¤çš„ä¸­æ–‡ç®€ä½“æ’ä»¶ jenkinsæ’ä»¶ä¸‹è½½åœ°å€ ç›´æ¥ä½¿ç”¨jenkinsä¸­å›½å®šåˆ¶ç‰ˆé•œåƒå¯åŠ¨å®¹å™¨ docker run \\ -u root \\ -d \\ -h jenkins \\ --name jenkins \\ -p 8081:8080 \\ -p 50000:50000 \\ -v /usr/local/jenkins:/var/jenkins_home \\ -v /var/run/docker.sock:/var/run/docker.sock \\ jenkinszh/jenkins-zh:2.239 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/ansible/ansibleå¥½æ–‡/è¿™æ ·ç†è§£Ansibleæ›´å®¹æ˜“.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/ansible/ansibleå¥½æ–‡/è¿™æ ·ç†è§£Ansibleæ›´å®¹æ˜“.html","title":"è¿™æ ·ç†è§£Ansibleæ›´å®¹æ˜“","keywords":"","body":"è¿™æ ·ç†è§£Ansibleæ›´å®¹æ˜“ åŸæ–‡é“¾æ¥ è¿™ç¯‡æ–‡ç« æ˜¯ Jenkins 2.xå®è·µæŒ‡å— ä½œè€…ç¿Ÿå¿—å†›åšå®¢ä¸­çš„ä¸€ç¯‡å†…å®¹ï¼Œçœ‹å®Œä¹‹åè§‰å¾—å†™çš„éå¸¸å¥½ï¼Œæ‰€ä»¥æ”¶è—ä¸€ä¸‹ æ»šæ»šé•¿æ±Ÿä¸œé€æ°´ï¼ŒæµªèŠ±æ·˜å°½è‹±é›„ã€‚æ˜¯éæˆè´¥è½¬å¤´ç©ºã€‚é’å±±ä¾æ—§åœ¨ï¼Œå‡ åº¦å¤•é˜³çº¢ã€‚â€”â€” ã€Šä¸´æ±Ÿä»™ã€‹ ç”µè„‘åº— ä»å‰ï¼Œæœ‰ä¸€å®¶ç”µè„‘åº—ã€‚åŸæ¥ä½ å³æ˜¯è€æ¿ï¼Œåˆæ˜¯åº—å‘˜æ—¶ï¼Œæ‹¿åˆ°æ¸…å•ï¼Œä½ å°±å¿…é¡»äº²è‡ªåŠ¨æ‰‹é‡‡è´­ï¼Œç„¶åä¸€ä¸ªä¸ªé›¶ä»¶ç»„è£…ã€‚æ¯å¤©éƒ½åšç€å³é‡å¤åˆè¾›è‹¦çš„æ´»ã€‚ è™½è¯´ä½ çš„ç»„è£…æŠ€æœ¯å·²ç»å¾ˆå¨´ç†Ÿäº†ï¼Œä½†æ˜¯å¶å°”è¿˜å‘ç”Ÿè£…é”™çš„æƒ…å†µï¼ˆå¤§æ¦‚æ˜¯é‚£å¤©å’Œè€æ¿å¨˜åµæ¶äº†ï¼‰ï¼ŒæŠŠä¸€ä¸ªå®¢äººè¦æ±‚çš„ CPU i5 è£…æˆäº† CPU i7ã€‚ç»“æœæ˜¯ä½ äºæœ¬æˆ–è€…èµšå¾—å°‘äº†ã€‚ åæ¥ï¼Œä½ é‡‡è´­äº†ä¸€ä¸ªè‡ªåŠ¨ç»„è£…ç”µè„‘çš„æœºå™¨äººã€‚ä½ åªè¦å‘Šè¯‰å®ƒç”µè„‘çš„é…ç½®ï¼Œå¹¶æŠŠé›¶ä»¶æ”¾åˆ°æŒ‡å®šçš„ç®±å­ä¸­ã€‚æ¥ç€å¯åŠ¨è¿™å°æœºå™¨ï¼Œå®ƒå°±è‡ªåŠ¨å¸®ä½ ç»„è£…å¥½ç”µè„‘äº†ã€‚å®ƒæ¯å¤©éƒ½å¹²é‡å¤çš„æ´»ä¹Ÿä¸ä¼šå«è¾›è‹¦ã€‚ æœ€é‡è¦çš„æ˜¯å‡†ç¡®ï¼Œå®ƒä¸ä¼šå› ä¸ºå¿ƒæƒ…ä¸å¥½ï¼Œè€Œè£…é”™ã€‚å› ä¸ºå®ƒæ ¹æœ¬ä¸ä¼šé—¹æƒ…ç»ªã€‚ è¿™æ ·ï¼Œè€æ¿å°±å¯ä»¥ä»é‡å¤çš„å·¥ä½œè§£æ”¾å‡ºæ¥ã€‚ç„¶åå°†å¤šå‡ºæ¥çš„æ—¶é—´èŠ±åœ¨ä¸äººçš„æ²Ÿé€šä¸Šï¼Œä¸ºæœ‰ä¸åŒéœ€æ±‚çš„äººè®¾è®¡æ›´åˆé€‚çš„ç”µè„‘é…ç½®æ¸…å•ã€‚æ¯•ç«Ÿæ¸¸æˆå‘çƒ§å‹å’ŒåŠå…¬å°ç™½é¢†çš„éœ€æ±‚æ˜¯ä¸ä¸€æ ·çš„ã€‚ åœ¨è¿ç»´é¢†åŸŸï¼Œä¸å°‘è¿ç»´äººéƒ½å¹²ç€å³æ˜¯è€æ¿åˆæ˜¯åº—å‘˜çš„å·¥ä½œã€‚å¦‚æœåœ¨è¿ç»´é¢†åŸŸä¹Ÿèƒ½æœ‰è¿™æ ·çš„â€œæœºå™¨äººâ€è¯¥å¤šå¥½ã€‚äº‹å®ä¸Šï¼ŒAnsibleã€Puppetã€Check å°±æ˜¯è¿™æ ·çš„æœºå™¨äººã€‚ ä¸ºä»€ä¹ˆè¦ä»é›¶è®¾è®¡ä¸€ä¸ªè¿ç»´æœºå™¨äºº æœ¬æ–‡å¹¶ä¸æƒ³ç”Ÿç¡¬åœ°ç½—åˆ— Ansible çš„å„ä¸ªçŸ¥è¯†ç‚¹ã€‚å› ä¸ºé‚£æ ·ï¼Œå¤§å®¶ä¸å¦‚ç›´æ¥çœ‹ Ansible å®˜æ–¹æ–‡æ¡£å°±å¥½ã€‚ ç¬”è€…é‡‡ç”¨ä»é›¶è®¾è®¡ä¸€ä¸ªè¿ç»´æœºå™¨äººçš„æ–¹å¼æ¥å‘Šè¯‰ä½ ï¼Œä¸ºä»€ä¹ˆ Ansible ä¼šæ˜¯ç°åœ¨è¿™ä¸ªæ ·å­ã€‚å½“ç„¶ï¼Œç°å®ä¸­çš„ Ansible ä¸ä¼šåƒæœ¬æ–‡æ‰€å†™çš„é‚£æ ·ä¸€æ­¥æ­¥è®¾è®¡ã€‚ ä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Ÿå› ä¸ºç¬”è€…è§‰å¾—åªæœ‰çŸ¥é“ä¸€ä¸ªå·¥å…·èƒŒåçš„è®¾è®¡åŸç†ï¼ŒçœŸæ­£ç”¨è¿™ä¸ªå·¥å…·æ‰ä¼šå¾—å¿ƒåº”æ‰‹ã€‚ è¿ç»´æœºå™¨äººçš„æœ€ç»ˆæ¨¡æ · é¦–å…ˆï¼Œéœ€è¦ç¡®å®šä¸€ä¸‹å®ç°è¿™ä¸ªè¿ç»´æœºå™¨äººçš„ç›®çš„æ˜¯ä»€ä¹ˆã€‚æˆ‘ä»¬å¹¶ä¸æ˜¯å¸Œæœ›æ‰€æœ‰çš„è¿ç»´å·¥ä½œéƒ½äº¤ç»™è¿ç»´æœºå™¨äººï¼Œè€Œæ˜¯å¸Œæœ›è¿ç»´å·¥ä½œä¸­é‡å¤çš„é‚£éƒ¨åˆ†å°½å¯èƒ½çš„äº¤ç»™æœºå™¨äººï¼ŒæŠŠåˆ›é€ æ€§çš„å·¥ä½œå…¨éƒ¨äº¤ç»™äººã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä»¥ç»ˆä¸ºå§‹æ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„å®ç°ç›®æ ‡çš„æ€è€ƒæ¨¡å‹ã€‚æ ¹æ®æ­¤æ€è€ƒæ¨¡å‹ï¼Œæˆ‘ä»¬é¦–å…ˆå¿…é¡»æ¢è®¨è¿ç»´æœºå™¨äººçš„æœ€ç»ˆæ¨¡æ ·ã€‚ç„¶åï¼Œå†è®¨è®ºå¯èƒ½çš„è§£å†³æ–¹æ¡ˆã€‚ é‚£ä¹ˆï¼Œä»€ä¹ˆæ ·çš„è¿ç»´æœºå™¨äººèƒ½å¸®åŠ©æˆ‘ä»¬å®ç°ä¸Šè¿°çš„è‡ªåŠ¨åŒ–è¿ç»´ç›®æ ‡å‘¢ï¼Ÿæƒ³åƒä¸€ä¸‹ã€‚æ˜¯ä¸æ˜¯åªè¦æˆ‘ä»¬å¯¹ç€è¿ç»´æœºå™¨äººè¯´ä¸€å¥ï¼šâ€œæˆ‘è¦éƒ¨ç½²ä¸€ä¸ª Nginx åˆ° 192.168.12.11â€ã€‚å®ƒå°±å¯ä»¥å¸®æˆ‘ä»¬å®Œæˆäº†ï¼Ÿ ä½†æ˜¯å®ƒæ€ä¹ˆçŸ¥é“å¦‚ä½•è¿æ¥åˆ° 192.168.12.11 å‘¢ï¼Ÿæ˜¯ä½¿ç”¨ç”¨æˆ·åå¯†ç çš„æ–¹å¼ï¼Œè¿˜æ˜¯ä½¿ç”¨ç§é’¥ï¼Ÿå®ƒåˆæ€ä¹ˆçŸ¥é“ Nginx éœ€è¦ä»€ä¹ˆæ ·çš„é…ç½®å‘¢ï¼Ÿä¸€é—®ä¸‹æ¥ï¼Œå…¶å®ï¼Œè¯­éŸ³è¿ç»´åªé€‚ç”¨äºå¯åŠ¨ä¸€äº›é¢„å®šä¹‰çš„åŠ¨ä½œã€‚å°±åƒæ±½è½¦çš„ä¸€é”®å¯åŠ¨ã€‚ä½ ä¸å¯èƒ½ä½¿ç”¨è¯­éŸ³æ¥å¯¹ Nginx è¿›è¡Œå¤§é‡çš„é…ç½®ã€‚ è€Œçº¯æ–‡æœ¬æ‰æ˜¯è¿›è¡Œå¤§é‡é…ç½®çš„æœ€å¥½åª’ä»‹ã€‚ æ‰€ä»¥ï¼Œè¿ç»´æœºå™¨äººçš„æœ€ç»ˆæ¨¡æ ·æ˜¯ï¼šæˆ‘ä»¬å°†éƒ¨ç½²çš„ä¸»æœº IPã€ç™»å½•æ–¹å¼ã€Nginx çš„é…ç½®æ”¾åœ¨ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œç„¶åè¿ç»´æœºå™¨äººè¯»å–è¿™ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œç„¶åæ ¹æ®é…ç½®è¿›è¡Œéƒ¨ç½²ã€‚å¦‚æœéƒ¨ç½²çš„æ˜¯ä¸šåŠ¡ç³»ç»Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦å‡†å¤‡è¯¥ä¸šåŠ¡ç³»ç»Ÿçš„äºŒè¿›åˆ¶åŒ…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨æ–‡æœ¬æ–‡ä»¶ä¸­ä½¿ç”¨ä½•ç§è¯­è¨€æè¿°æˆ‘ä»¬çš„é…ç½®éœ€æ±‚å‘¢ï¼Ÿå¯ä»¥åˆ†æˆä¸¤ç§ã€‚ä¸€ç§æ˜¯åˆ©äºäººç±»å­¦ä¹ çš„è‡ªç„¶è¯­è¨€ï¼ˆå¦‚è‹±è¯­ï¼‰ã€‚å¦ä¸€ç§æ˜¯åˆ©äºæœºå™¨è¯»å–çš„ç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚YAMLã€JSONï¼‰ã€‚ æŒ‰å½“å‰çš„æŠ€æœ¯å®ç°çš„å¯èƒ½æ€§ï¼Œä¸è®ºæ˜¯è¿ç»´æœºå™¨äººï¼Œè¿˜æ˜¯äº¤ç»™å…¶å®ƒç¨‹åºï¼Œéƒ½éœ€è¦å°†è‡ªç„¶è¯­è¨€è½¬åˆ°ç»“æ„åŒ–çš„æ•°æ®ã€‚å°±åƒç¨‹åºå‘˜ï¼Œéœ€è¦å°†ä¸šåŠ¡çŸ¥è¯†ç¿»è¯‘æˆç¼–ç¨‹è¯­è¨€ï¼›åƒç¼–è¯‘å™¨å°†ç¼–ç¨‹è¯­è¨€ç¿»è¯‘æˆæœºå™¨çœŸæ­£èƒ½è¯†åˆ«çš„äºŒè¿›åˆ¶ä»£ç ã€‚ è¿ç»´æœºå™¨äººçš„çœŸæ­£æ ¸å¿ƒä¸æ˜¯å°†è‡ªç„¶è¯­è¨€è½¬æˆç»“æ„åŒ–çš„æ•°æ®ã€‚æ‰€ä»¥ï¼Œæ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å†™ç»“æ„åŒ–æ•°æ®ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨ YAML æ ¼å¼ä½œä¸ºç»“æ„åŒ–æ•°æ®çš„è½½ä½“ã€‚å› ä¸ºå®ƒæ˜¯éå¸¸æµè¡Œçš„é…ç½®æ–‡ä»¶æ ¼å¼ã€‚é™ä½äººä»¬å†™ç»“æ„åŒ–æ•°æ®çš„éš¾åº¦ã€‚ å½“ç„¶ï¼Œå¥½çš„è®¾è®¡ä¸åº”è¯¥ä¸å…·ä½“é…ç½®æ–‡ä»¶æ ¼å¼è€¦åˆã€‚ å®ç°è¿ç»´æœºå™¨äººè¦è§£å†³å“ªäº›é—®é¢˜ ä»¥ä¸Šåªæ˜¯ç¡®å®šäº†è¿ç»´æœºå™¨äººçš„æœ€ç»ˆæ¨¡æ ·åŠä½¿ç”¨æ–¹å¼ï¼Œè§£å†³çš„æ˜¯ç”¨æˆ·çš„é—®é¢˜ã€‚ä½†æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯è¿ç»´æœºå™¨äººçš„è®¾è®¡è€…ï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘å¦‚ä½•å®ç°å®ƒã€‚ å›æƒ³ä¸€ä¸‹ï¼Œå¹³æ—¶æˆ‘ä»¬çš„è¿ç»´äººå‘˜æ˜¯å¦‚ä½•å®ç°è‡ªåŠ¨åŒ–çš„ï¼Ÿæ˜¯ä¸æ˜¯å†™å¥½äº† bash è„šæœ¬åï¼Œç„¶åå°†è„šæœ¬ä¸Šä¼ åˆ°ç›®æ ‡æœºå™¨ï¼Œæœ€ååœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œè¯¥è„šæœ¬ã€‚ è¿™ä¸ª bash è„šæœ¬å…¶å®ä¹Ÿå¯ä»¥ç®—æ˜¯ä¸€ç§ç»“æ„åŒ–çš„æ•°æ®æ ¼å¼ï¼Œè€Œä¸”æ˜¯ä¸€ç§ä¸éœ€è¦å†åšç¼–è¯‘ï¼Œç›®æ ‡æœºå™¨èƒ½ç›´æ¥è¿è¡Œçš„æ ¼å¼ã€‚ åœ¨å¹³æ—¶çš„è‡ªåŠ¨åŒ–æ–¹å¼åŸºç¡€ä¸Šè¿›è¡ŒæŠ½è±¡ã€‚æˆ‘ä»¬è§‰å¾—è¦å®ç°è¿ç»´æœºå™¨äººè¦è§£å†³çš„å…³é”®é—®é¢˜æœ‰ï¼š éœ€è¦å°† YAML è½¬æˆç›®æ ‡æœºå™¨å¯æ‰§è¡Œçš„ç¨‹åºï¼ˆæˆ–è„šæœ¬ï¼‰ã€‚ éœ€è¦å°†å¯æ‰§è¡Œçš„ç¨‹åºä¸Šä¼ åˆ°ç›®æ ‡æœºå™¨ï¼Œå¹¶æ‰§è¡Œã€‚ ä¸ºä»€ä¹ˆä¸€å®šè¦å°† YAML è½¬æˆç›®æ ‡æœºå™¨å¯æ‰§è¡Œçš„ç¨‹åºå‘¢ï¼Ÿç›´æ¥å†™ bash ä¸å°±å¯ä»¥äº†ï¼Ÿ å› ä¸ºè¿ç»´æœºå™¨äººè¦è§£å†³çš„ä¸æ­¢æ˜¯ Linux ç³»ç»Ÿçš„è‡ªåŠ¨åŒ–è¿ç»´ï¼Œè¿˜æœ‰ Windowsï¼Œç”šè‡³è·¯ç”±å™¨çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ç§ç‹¬ç«‹äºç›®æ ‡æœºå™¨çš„è¯­è¨€æ¥æè¿°æˆ‘ä»¬çš„è¿ç»´éœ€æ±‚ã€‚ é—®é¢˜ 2 æˆ‘ä»¬å…ˆæ”¾ä¸€æ”¾ï¼Œå› ä¸ºä¸Šä¼ ä»£ç åˆ°ç›®æ ‡ä¸æ˜¯è¿ç»´æœºå™¨äººçš„å…³é”®é—®é¢˜ã€‚ å®ç° YAML è½¬æˆ ï¼Ÿ è™½ç„¶å’±ä»¬å¸Œæœ›è¿ç»´æœºå™¨äººèƒ½è¿ç»´æ‰€æœ‰ç±»å‹çš„æœºå™¨ï¼Œä½†æ˜¯æœ¬æ–‡é‡ç‚¹ä¸æ˜¯è¦åœ¨ä¸€ç¯‡æ–‡ç« å†…å®ç°æ‰€æœ‰ç±»å‹æœºå™¨çš„è‡ªåŠ¨åŒ–è¿ç»´ã€‚æ¥ä¸‹æˆ‘ä»¬åªé’ˆå¯¹ Linux æœºå™¨è¿›è¡Œè®²è§£ã€‚ ç°åœ¨æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜æ˜¯è¦å°† YAML è½¬æˆä»€ä¹ˆç¨‹åºä»¥å®ç°åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œï¼Ÿ å¦‚æœæˆ‘ä»¬å°† YAML è½¬æˆ Java ç¨‹åºï¼Œé‚£ä¹ˆç›®æ ‡æœºå™¨å°±å¿…é¡»è£…æœ‰ JDKï¼Œè¿™æ˜¯ä¸ç°å®çš„ã€‚ä½ ä¸å¯èƒ½è®©æ‰€æœ‰çš„ Linux æœºå™¨éƒ½å®‰è£… JDKã€‚æ‰€ä»¥ï¼ŒYAML æœ€å¥½æ˜¯èƒ½è½¬æˆæ‰€æœ‰ Linux éƒ½æ”¯æŒç¨‹åºã€‚ç›®å‰ç¬”è€…èƒ½æƒ³åˆ°çš„å°±æ˜¯ï¼šbash å’Œ Pythonã€‚ P.S. ç°å®ä¸­ï¼Œå¾ˆå¤šè¿ç»´å·¥å…·è¦æ±‚æ‰€æœ‰çš„ç›®æ ‡æœºå™¨å¿…é¡»å®‰è£…ç‰¹å®šçš„å®¢æˆ·ç«¯çš„ã€‚è€Œ Ansible å´ä¸éœ€è¦ã€‚å¦‚æœåœ¨ä½¿ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·å‰ï¼Œä½ è¦ä¸ºæ‰€æœ‰çš„æœºå™¨å®‰è£…ç‰¹å®šçš„å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆï¼Œä½ æ€ä¹ˆè‡ªåŠ¨åŒ–ä¸ºæ‰€æœ‰çš„æœºå™¨è‡ªåŠ¨å®‰è£…å®¢æˆ·ç«¯å‘¢ï¼Ÿç•™ç€è¯»è€…æ€è€ƒã€‚ ä» bash å’Œ Python ä¹‹é—´åšé€‰æ‹©ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½è®¨è®ºçš„ï¼Œé€‰æ‹© Pythonã€‚ é‚£ä¹ˆï¼Œæ€ä¹ˆå°† YAML è½¬æˆ Python ä»£ç å‘¢ï¼Ÿè¿™è¦çœ‹æˆ‘ä»¬æ€ä¹ˆè®¾è®¡ YAML å†…çš„æè¿°è¯­è¨€äº†ã€‚å…¶å®å°±æ˜¯è®¾è®¡è‡ªåŠ¨åŒ–è¿ç»´æœºå™¨äººçš„é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDSLï¼‰ã€‚ä¸ºæ–¹ä¾¿è®¨è®ºï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºï¼šOPL è¯­è¨€ã€‚ OPL è¯­è¨€1.0ï¼šåŸºæœ¬è¦ç´  ç°åœ¨å’±ä»¬åœ¨ä¸ºä¸€å°æœºå™¨éƒ¨ç½²ä¸€ä¸ª Nginx ä½œä¸ºåˆ‡å…¥ç‚¹ï¼Œæ¥è®¾è®¡æˆ‘ä»¬çš„ OPL è¯­è¨€ã€‚ä»¥ä¸‹å°±æ˜¯1.0ç‰ˆæœ¬ï¼š --- - host: \"192.168.35.10\" ansible_ssh_user: vagrant ansible_ssh_pass: vagrant tasks: - name: install nginx yum: name: nginx action: install hostï¼šä»£è¡¨éƒ¨ç½²çš„ç›®æ ‡æœºå™¨ã€‚ ansible_ssh_*ï¼šå¼€å¤´çš„ key æ˜¯æŒ‡å®š ssh è¿æ¥çš„ç”¨æˆ·åå’Œå¯†ç ã€‚ tasksï¼šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«ä¸€ç³»åˆ—ä»»åŠ¡ã€‚ nameï¼šä»»åŠ¡åç§°ï¼Œæ–¹ä¾¿äººé˜…è¯»ã€‚ yumï¼šè¦æ‰§è¡Œçš„ä»»åŠ¡çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¦æ‰§è¡Œ yum æ“ä½œã€‚yum ä»»åŠ¡ä¸‹çš„ name å±æ€§ä»£è¡¨è¦å®‰è£…çš„è½¯ä»¶åç§°ï¼Œaction å±æ€§ä»£è¡¨æ‰§è¡Œçš„æ˜¯å®‰è£…æ“ä½œã€‚ 1.0ç‰ˆçš„ OPL è¯­è¨€åŒ…å«äº†è¿ç»´é¢†åŸŸæœ€åŸºæœ¬è¦ç´ ï¼š ç›®æ ‡ä¸»æœºçš„æè¿° è¿æ¥ç›®æ ‡ä¸»æœºçš„å¿…è¦ä¿¡æ¯ ä»»åŠ¡æè¿° ä¸ºæ–¹ä¾¿æ²Ÿé€šï¼Œæˆ‘ä»¬æš‚å°†äº› YAML æ–‡ä»¶å‘½åä¸º playbook.ymlã€‚ OPL è¯­è¨€2.0ï¼šé‡‡ç”¨å£°æ˜å¼çš„ä»»åŠ¡æè¿°æ–¹å¼ æ³¨æ„åˆ° OPL è¯­è¨€1.0ä¸­çš„ä»»åŠ¡æè¿°æ–¹å¼å¾ˆåƒç°å®ä¸­æ‰§è¡Œshellï¼šyum install nginxã€‚æˆ‘ä»¬ç§°è¿™ç§æ–¹å¼ä¸ºè„šæœ¬å¼çš„ã€‚è„šæœ¬å¼çš„æè¿°æ–¹å¼ä¸ä¼ ç»Ÿçš„è¿ç»´æ–¹å¼æ›´åƒã€‚ ä½†æ˜¯å£°æ˜å¼çš„æè¿°æ–¹å¼æ›´é€‚åˆ OPL è¯­è¨€æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚æˆ‘ä»¬æœŸæœ›çš„æ˜¯æè¿°æˆ‘ä»¬æœŸæœ›çš„ç»“æœï¼Œè€Œä¸æ˜¯æ¢ä¸€ç§æ–¹å¼å†™è„šæœ¬ã€‚ é‡‡ç”¨å£°æ˜å¼çš„æè¿°æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› ï¼šå¹‚ç­‰çš„ã€‚åœ¨æ¦‚å¿µä¸Šï¼Œå£°æ˜å¼çš„æè¿°è¢«æ‰§è¡Œäº†å¤šå°‘æ¬¡ï¼Œç»“æœéƒ½åº”è¯¥æ˜¯æˆ‘ä»¬æ‰€å£°æ˜çš„ã€‚è€Œç¬¬äºŒæ¬¡æ‰§è¡Œè„šæœ¬å¼çš„ä»£ç æ—¶ï¼Œä½ ä¼šé—®ï¼Œç»“æœè¿˜ä¼šå’Œæˆ‘ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„ä¸€æ ·å—ï¼Ÿ æ‰€ä»¥ï¼Œ2.0ä¸­ï¼Œä»»åŠ¡æè¿°æ–¹å¼æ”¹æˆå£°æ˜å¼ï¼š - name: Ensure nginx present yum: name: nginx state: present state å±æ€§çš„å€¼ä¸º present å½¢å®¹è¯ã€‚ P.S. è¯†åˆ«å£°æ˜å¼ä¸è„šæœ¬å¼çš„ç®€å•åŠæ³•æ˜¯çœ‹å®ƒåœ¨æè¿°ç›®æ ‡çŠ¶æ€æ—¶ï¼Œæ˜¯ç”¨åŠ¨è¯ï¼Œè¿˜æ˜¯ç”¨å½¢å®¹è¯ã€‚ é™¤äº† yum ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥è¦å®ç°çš„æ‰€æœ‰ä»»åŠ¡ä¹Ÿå°†é‡‡ç”¨å£°æ˜å¼ã€‚ OPL è¯­è¨€3.0ï¼šä¸»æœºæ¸…å• åœ¨ 2.0 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åªå®ç°äº†ä¸€å°ç›®æ ‡æœºå™¨çš„éƒ¨ç½²ã€‚ä½†æ˜¯ç°å®ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸è¦é’ˆå¯¹å¤šä¸»æœºè¿›è¡Œéƒ¨ç½²ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§æ›´å¥½çš„æ–¹å¼å»æè¿°ç›®æ ‡ä¸»æœºã€‚ ä¸»æœºæ¸…å•çš„å†…å®¹ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ªæ–‡ä»¶æ¥å­˜æ”¾ã€‚å…³äºæ–‡ä»¶çš„æ ¼å¼ï¼Œæˆ‘ä»¬é‡‡ç”¨ä¸€ç§ç±» INI ï¼ˆINI-likeï¼‰çš„æ ¼å¼ã€‚æ–‡ä»¶åæš‚å‘½åä¸ºï¼šinventoryã€‚ä»¥ä¸‹æ˜¯ inventory æ–‡ä»¶çš„å†…å®¹ï¼š [nginx] 192.168.35.10 192.168.35.11 192.168.35.12 [springboot] 192.168.35.20 192.168.35.21 192.168.35.22 [] æ‹¬å·ä¸­æ˜¯ä¸»æœºåˆ†ç»„çš„åç§°ï¼Œæ¥ä¸‹æ¥æ˜¯å°±æ˜¯è¿™ä¸ªç»„å†…ç›®æ ‡æœºå™¨çš„ IP åˆ—è¡¨ã€‚ è€Œä¸Šä¸€ç‰ˆæœ¬ä¸­çš„ playbook.yml ä¸­çš„ host key æ˜¯å•æ•°ï¼Œæ‰€ä»¥ä¸åˆé€‚äº†ã€‚æˆ‘ä»¬æ”¹æˆ hosts å¤æ•°ï¼ŒåŒæ—¶å€¼å˜æˆäº†åœ¨ä¸»æœºæ¸…å•ä¸­çš„ç»„åï¼Œè€Œä¸æ˜¯å…·ä½“æŸå°ä¸»æœºçš„ IPã€‚ playbook.yml æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š - hosts: \"nginx\" ansible_ssh_user: vagrant ansible_ssh_pass: vagrant tasks: - name: install nginx yum: name: nginx state: present ç»†å¿ƒçš„è¯»è€…æœ‹å‹åº”è¯¥å‘ç°äº†ï¼Œç›®æ ‡æœºå™¨çš„è¿æ¥æ–¹å¼æ˜¯å„ä¸ç›¸åŒçš„ï¼Œæœ‰äº›ç”¨ç”¨æˆ·å¯†ç çš„æ–¹å¼ï¼Œæœ‰äº›ç”¨å¯†é’¥çš„æ–¹å¼ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å†å°† ansible_ssh_* å†™åœ¨ playbook.yml ä¸­å·²ç»ä¸åˆé€‚äº†ã€‚ ç¬”è€…åªèƒ½å‘Šè¯‰ä½ ï¼Œè¿™æ˜¯å‰§æƒ…éœ€è¦ã€‚OPL è¯­è¨€çš„åç»­ç‰ˆæœ¬ä¼šè§£å†³æ­¤é—®é¢˜ã€‚ ç°åœ¨å’±ä»¬ä¸ºè¿ç»´æœºå™¨äººå‡†å¤‡çš„å†…å®¹å·²ç»ä¸å†åªæ˜¯ä¸€ä¸ª playbook.yml æ–‡ä»¶ï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ä¸ªç›®å½•äº†ï¼Œç›®å½•å†…å®¹å¦‚ä¸‹ï¼š â”œâ”€â”€ inventory â””â”€â”€ playbook.yml OPL è¯­è¨€4.0ï¼šinclude ä»»åŠ¡ åœ¨ OPL 1.0 ç‰ˆæœ¬ï¼Œå·²ç»è€ƒè™‘åˆ°äº†ä¸€æ¬¡éƒ¨ç½²å°†ä¼šåŒ…æ‹¬å¾ˆå¤šå­ä»»åŠ¡ã€‚æ‰€ä»¥ä½¿ç”¨äº† tasks è¿™ä¸ªå¤æ•°è¯ã€‚ è€Œç°å®ä¸­ä¸€æ¬¡éƒ¨ç½²ä»»åŠ¡å¾€å¾€åŒ…å«å‡ åä¸ªå­ä»»åŠ¡ï¼Œplaybook.yml çš„æ–‡ä»¶å†…å®¹ä¸€å®šä¼šè†¨èƒ€ã€‚è¿™æ ·çš„æºä»£ç éå¸¸éš¾ç»´æŠ¤ã€‚æ‰€ä»¥ï¼Œåœ¨ 4.0 ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å†³å®šä¸º OPL å¢åŠ ä¸€ä¸ª include_tasks ä»»åŠ¡ç±»å‹ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ include_tasks ä»»åŠ¡ç±»å‹å°†å¦ä¸€ä¸ªåŒ…å«ä»»åŠ¡æè¿°çš„æ–‡ä»¶ï¼ˆè¿™é‡Œæˆ‘ä»¬ç§°ä¸ºå­ä»»åŠ¡é›†ï¼‰å¼•å…¥åˆ°å½“å‰çš„ playbook.ymlã€‚ - hosts: \"nginx\" tasks: - name: config firewalld include_tasks: firewalld.yml - name: install and config nginx include_tasks: nginx.yml è¿™æ—¶çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š â”œâ”€â”€ firewalld.yml â”œâ”€â”€ inventory â”œâ”€â”€ nginx.yml â””â”€â”€ playbook.yml æ‰€æœ‰çš„å­ä»»åŠ¡æ–‡ä»¶éƒ½ä¸ playbook.yml åŒçº§ï¼Œä¼šæ˜¾å¾—å¾ˆä¹±ï¼Œä¸åˆ©äºåŒºåˆ†å“ªä¸ªæ–‡ä»¶æ˜¯ OPL çš„æ‰§è¡Œå…¥å£ã€‚æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥å»ºäº†ä¸€ä¸ª tasks ç›®å½•æ¥ä¸“é—¨å­˜æ”¾å‘¢ï¼Ÿäº‹å®ä¸Šå°±åº”è¯¥è¿™ä¹ˆåšã€‚ æ‰€ä»¥ï¼Œç»è¿‡é‡æ„ï¼Œå¾—åˆ°äº†4.1 ç‰ˆæœ¬ã€‚ç›®å½•ç»“æ„è°ƒæ•´å¦‚ä¸‹ï¼š â”œâ”€â”€ inventory â”œâ”€â”€ playbook.yml â””â”€â”€ tasks â”œâ”€â”€ firewalld.yml â””â”€â”€ nginx.yml playbook.yml ä¸­ include_tasks ä»»åŠ¡çš„æ–‡ä»¶è·¯å¾„åšç›¸åº”çš„è°ƒæ•´ï¼Œæ”¹æˆï¼š - name: install and config nginx include_tasks: tasks/nginx.yml OPL è¯­è¨€5.0ï¼šä¸°å¯Œä»»åŠ¡ç±»å‹ 5.0 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå·²ç»å®ç°äº†ä¸€ä¸ªåŸºæœ¬æ¡†æ¶ã€‚5.0 ç‰ˆæœ¬ä¸­æˆ‘ä»¬å¸Œæœ›åŠ å…¥æ›´å¤šçš„ä»»åŠ¡ç±»å‹ï¼Œä»¥æ»¡è¶³ä¸åŒçš„è¿ç»´éœ€æ±‚ã€‚ copy ä»»åŠ¡ éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œå¸¸å¸¸éœ€è¦å°†ä¸€äº›æ–‡ä»¶ä»æœ¬åœ° copy åˆ°ç›®æ ‡æœºå™¨ã€‚copy ä»»åŠ¡çš„ä»£ç æ ·ä¾‹å¦‚ä¸‹ï¼š - name: \"ensure nginx package exists\" copy: src: \"./files/nginx.tar.gz\" dest: \"/tmp\" ä¸ºæ–¹ä¾¿ç®¡ç†ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰ copy ä»»åŠ¡ç”¨åˆ°çš„æ–‡ä»¶æ”¾åœ¨ files ç›®å½•ä¸­ã€‚æ­¤æ—¶ç›®å½•ç»“æ„è°ƒæ•´å¦‚ä¸‹ï¼š â”œâ”€â”€ inventory â”œâ”€â”€ playbook.yml â””â”€â”€ tasks â”œâ”€â”€ files â”‚ â””â”€â”€ nginx.tar.gz â”œâ”€â”€ firewalld.yml â””â”€â”€ nginx.yml file ä»»åŠ¡ è®¾ç½®æ–‡ä»¶å¤¹çš„æƒé™æ˜¯éå¸¸å¸¸è§çš„æ“ä½œï¼Œæ‰€ä»¥å°±æœ‰äº† file ä»»åŠ¡ã€‚ - name: \"ensure folder /app/nginx is created\" file: path: \"/app/nginx\" owner: \"nginx\" group: \"nginx\" mode: \"0700\" state: \"directory\" ownerï¼šæŒ‡å®šæ–‡ä»¶çš„æ‰€å±ç”¨æˆ·ã€‚ groupï¼šæŒ‡å®šæ–‡ä»¶çš„æ‰€å±ç”¨æˆ·ç»„ã€‚ state å±æ€§çš„å€¼å¯ä»¥ä¸ºï¼š absentï¼šä¸å­˜åœ¨ã€‚å¯ä»¥ç†è§£ä¸ºåˆ é™¤è¯¥æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ã€‚ directoryï¼šæ–‡ä»¶å¤¹ã€‚å¦‚æœè¯¥æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚ fileï¼šæ–‡ä»¶ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚ touchï¼šä¸ linux çš„ touch å®ç°ç›¸åŒçš„æ•ˆæœã€‚ service ä»»åŠ¡ åœ¨æœåŠ¡å®‰è£…å®Œæˆåï¼Œæœ€å¸¸ç”¨çš„æ“ä½œå°±æ˜¯å¯åŠ¨æœåŠ¡äº†ã€‚åŒæ—¶ï¼Œå®ƒä¼šæ ¹æ®ä¸åŒçš„æ“ä½œå†³å®šä½¿ç”¨ä½•ç§ service å®ç°ã€‚æ”¯æŒï¼šBSD init, OpenRC, SysV, Solaris SMF, systemd, upstartã€‚è¿™å°±æ˜¯å°è£…çš„å¼ºå¤§ã€‚ç”¨æˆ·åªéœ€è¦æè¿°ä»–çš„æœŸæœ›ï¼Œå‰©ä¸‹çš„æœºå™¨èƒ½è§£å†³çš„ï¼Œéƒ½ç”±æœºå™¨è§£å†³ã€‚ - name: ensure svn service started service: name: svnserver state: started enabled: true enabled å±æ€§å€¼ä¸º true ä»£è¡¨å¼€æœºè‡ªåŠ¨å¯åŠ¨ã€‚state å±æ€§å€¼å¯ä»¥ä¸ºï¼š reloadedï¼šæœåŠ¡æ˜¯è¢«é‡æ–°åŠ è½½è¿‡çš„ã€‚ restartedï¼šæœåŠ¡æ˜¯è¢«é‡å¯è¿‡çš„ã€‚ startedï¼šæœåŠ¡æ˜¯å¯åŠ¨çš„ã€‚ stoppedï¼šæœåŠ¡æ˜¯åœæ­¢çš„ã€‚ å°ç»“ å¦‚æœ OPL è¯­è¨€è®¾è®¡å¾—è¶³å¤Ÿå¥½ï¼Œå®ƒåº”è¯¥å¯ä»¥è½»æ¾åœ°è¿›è¡Œæ‰©å±•ã€‚æ­¤å¤„ä¸¾çš„å‡ ä¸ªä¾‹å­å·²ç»è¾¾åˆ°ç›®çš„ï¼Œå°±ä¸å†ä¸¾æ›´å¤šçš„ä¾‹å­ã€‚ P.S. OPL è¯­è¨€çš„å­ä»»åŠ¡åœ¨ Ansible ä¸­ç§°ä¸ºæ¨¡å—ï¼ˆmoduleï¼‰ã€‚ OPL è¯­è¨€6.0ï¼šæ¨¡å—åŒ–ä»»åŠ¡ åœ¨ 5.0 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸º OPL å¢åŠ äº†ä¸€äº›çš„ä»»åŠ¡ç±»å‹ã€‚åœ¨å†™äº†ä¸€æ®µæ—¶é—´ OPL è¯­è¨€åï¼Œå‘ç°é‡‡ç”¨ include_tasks å¯¹å¤§è§„æ¨¡ playbook.yml è¿›è¡Œæ‹†åˆ†çš„æ–¹å¼ï¼Œè®¾è®¡ä¸Šçš„å­˜åœ¨ä¸è¶³ï¼šä¸å¤Ÿå†…èšã€‚å…·ä½“è¡¨ç°å¦‚ä¸‹ï¼š include_tasks ä»»åŠ¡ä¸åˆ©äºåˆ†äº«ç»™å…¶ä»–äººä½¿ç”¨ã€‚ nginx.yml ä¸­çš„ copy ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬çº¦å®šä» files ç›®å½•ä¸­è¯»å–æ–‡ä»¶ã€‚ä½†æ˜¯å…¶å®ƒå­ä»»åŠ¡ä¸­çš„ copy åˆä»å“ªé‡Œè¯»å–æ–‡ä»¶å‘¢ï¼Ÿè¿™å°±æ˜¯å­ä»»åŠ¡ä¹‹é—´ä¼šç›¸äº’å½±å“ã€‚ é‚£ä¹ˆå¦‚ä½•è®©å­ä»»åŠ¡æ›´å†…èšå‘¢ï¼Ÿå°†â€œå­ä»»åŠ¡â€çš„é›†åˆè¿›è¡Œå°è£…ï¼Œå¹¶å‘½åä¸º roleã€‚è¿™æ ·æ¯ä¸ª role éƒ½è¢«çœ‹ä½œæˆä¸€ä¸ªæ¨¡å—ã€‚ ç›®å½•ç»“æ„è°ƒæ•´ä¸ºï¼š â”œâ”€â”€ inventory â”œâ”€â”€ playbook.yml â””â”€â”€ roles ## å­˜æ”¾ playbook ä½¿ç”¨åˆ°çš„ role â”œâ”€â”€ firewalld â”‚ â”œâ”€â”€ files â”‚ â””â”€â”€ tasks â”‚ â””â”€â”€ main.yml â””â”€â”€ nginx â”œâ”€â”€ files â”‚ â””â”€â”€ nginx.tar.gz â””â”€â”€ tasks â””â”€â”€ main.yml playbook.yml å†…å®¹è°ƒæ•´å¦‚ä¸‹ï¼š - hosts: \"nginx\" ansible_ssh_user: vagrant ansible_ssh_pass: vagrant roles: - firewalld - nginx æ¯ä¸ª role åªéœ€è¦ç®¡ç†è‡ªå·±å†…éƒ¨çš„é€»è¾‘ï¼Œæ¯”å¦‚ï¼Œæ¯ä¸ª role éƒ½ä¼šæœ‰ä¸€ä¸ª files ç›®å½•ã€‚copy ä»»åŠ¡é»˜è®¤ä»æ‰€åœ¨ role ç›®å½•ä¸­çš„ files ç›®å½•ä¸­è¯»å–ã€‚ä¸Šæ–‡ä»‹ç»çš„ copy ä»»åŠ¡ï¼ˆæ³¨æ„ src å±æ€§å€¼ï¼‰æ”¹ä¸ºï¼š - name: \"ensure nginx package exists\" copy: src: \"nginx.tar.gz\" dest: \"/tmp\" ä»Šåè®¾è®¡çš„æ‰€æœ‰ä»»åŠ¡ç±»å‹é»˜è®¤éƒ½ä» role è‡ªèº«ç›®å½•å¼€å§‹ã€‚ æ¯ä¸ª role çš„æ‰§è¡Œå…¥å£çº¦å®šä¸º tasks/main.ymlã€‚include_tasks ä»»åŠ¡ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œåªä¸è¿‡ï¼Œé»˜è®¤ä» main.yml åŒçº§ç›®å½•è·å–å­ä»»åŠ¡é›†åˆã€‚æ¯”å¦‚ nginx/tasks/main.yml åŒ…å«ä»»åŠ¡ï¼š - name: \"Config nginx\" includes_tasks: config.yml nginx role çš„ tasks ç›®å½•å†…å®¹å¦‚ä¸‹ï¼š â””â”€â”€ nginx â”œâ”€â”€ files â”‚ â””â”€â”€ nginx.tar.gz â””â”€â”€ tasks â”œâ”€â”€ config.yml â””â”€â”€ main.yml OPL è¯­è¨€7.0ï¼šæ”¯æŒå˜é‡ 6.0 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¦‚ä½•å°† role åˆ†äº«ç»™å…¶ä»–äººä½¿ç”¨å‘¢ï¼Ÿç›®å‰èƒ½æƒ³åˆ°çš„æˆæœ¬æœ€ä½çš„æ–¹å¼æ˜¯ç›´æ¥å°† role ç›®å½•æ‹·è´ä¸€ä»½ï¼Œå¹¶ push åˆ° GitHub ä¸Šã€‚å…¶ä»–äººå°† role ä¸‹è½½åˆ°è‡ªå·±çš„ roles ç›®å½•å³å¯ã€‚ å¯æ˜¯ï¼Œå…¶ä»–äººä¸‹è½½ role åï¼Œä¹Ÿéœ€è¦æŸ¥çœ‹ role çš„å†…éƒ¨é€»è¾‘ï¼Œç„¶åä¿®æ”¹å…¶ä¸­çš„é€»è¾‘ï¼Œæ‰èƒ½ä¸ºè‡ªå·±æ‰€ç”¨ã€‚å› ä¸ºå¹¶ä¸æ˜¯æ¯ä¸ªäººçš„ nginx é…ç½®éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™è¯´æ˜å’±ä»¬å½“çš„ OPL çš„è®¾è®¡è¿åäº†ç¨‹åºè®¾è®¡çš„å¼€é—­åŸåˆ™ï¼š å¼€é—­åŸåˆ™è§„å®šâ€œè½¯ä»¶ä¸­çš„å¯¹è±¡ï¼ˆç±»ï¼Œæ¨¡å—ï¼Œå‡½æ•°ç­‰ç­‰ï¼‰åº”è¯¥å¯¹äºæ‰©å±•æ˜¯å¼€æ”¾çš„ï¼Œä½†æ˜¯å¯¹äºä¿®æ”¹æ˜¯å°é—­çš„â€ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªå®ä½“æ˜¯å…è®¸åœ¨ä¸æ”¹å˜å®ƒçš„æºä»£ç çš„å‰æä¸‹å˜æ›´å®ƒçš„è¡Œä¸ºã€‚ â€”â€” ç»´åŸºç™¾ç§‘ é‚£å¦‚ä½•è®¾è®¡æ‰èƒ½ç¬¦åˆå¼€é—­åŸåˆ™å‘¢ï¼Ÿæ–¹æ³•æ˜¯å°†ç»å¸¸å˜åŒ–çš„ä¸åŸºæœ¬ä¸ç”¨å˜åŒ–çš„é€»è¾‘åˆ†ç¦»ã€‚ ä»¥ä¸Šæ–‡ä¸­çš„ nginx role ä¸ºä¾‹è®²è§£ã€‚nginx çš„å®‰è£…éƒ¨ç½²ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯¹äºæ‰€æœ‰äººæ¥è¯´éƒ½æ˜¯å¤§ä½“ç›¸åŒçš„ã€‚ä¸ç›¸åŒçš„æ˜¯ nginx çš„é…ç½®ã€‚ OPL è¯­è¨€7.0ç‰ˆæœ¬å°†è¿™äº›â€œé…ç½®â€æŠ½è±¡å‡ºæ¥ï¼Œä¹Ÿå°±æ˜¯å˜é‡ã€‚role æ ¹æ®è‡ªèº«éœ€è¦åœ¨ role å†…éƒ¨å®šä¹‰å˜é‡ï¼Œç”¨æˆ·åœ¨ role å¤–éƒ¨å¯é‡æ–°è®¾ç½®å˜é‡çš„å€¼ï¼Œå³å¯å®šä¹‰ role ä¸­çš„å˜åŒ–çš„éƒ¨åˆ†ã€‚æ¯”å¦‚é‡æ–°å®šä¹‰ nginx çš„é…ç½®ã€‚ é‚£ä¹ˆï¼Œå…·ä½“å¦‚ä½•å®šä¹‰åŠä½¿ç”¨å˜é‡å‘¢ï¼Ÿ åŒºåˆ†é»˜è®¤å˜é‡å’Œç”¨æˆ·å®šä¹‰å˜é‡ å¯¹äºâ€œå…·ä½“å¦‚ä½•å®šä¹‰åŠä½¿ç”¨å˜é‡å‘¢â€çš„é—®é¢˜ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ­¥æ˜¯è¦å°†é»˜è®¤å˜é‡å’Œç”¨æˆ·å®šä¹‰å˜é‡åŒºåˆ†å¼€ã€‚ ä»¥ä¸Šæ–‡çš„ copy å­ä»»åŠ¡ä¸ºä¾‹ï¼š - name: \"ensure nginx package exists\" copy: src: \"nginx.tar.gz\" dest: \"/tmp\" copy çš„ç›®çš„åœ°çš„å±æ€§ä¸º destï¼Œå®ƒçš„å€¼æ˜¯â€œå†™æ­»â€çš„ã€‚ä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½å¸Œæœ› copy åˆ° /tmp ç›®å½•ã€‚/tmp ç›®å½•æ˜¯ role æœ¬èº«çš„é»˜è®¤å€¼ï¼Œå¦‚æœç”¨æˆ·ä¸æ»¡æ„è¿™ä¸ªé»˜è®¤å€¼ï¼Œå¯ä»¥åœ¨ä½¿ç”¨ role æ—¶ï¼Œä¿®æ”¹ dest çš„å€¼ã€‚ è¿™åˆå¼•å‡ºå¦ä¸€ä¸ªé—®é¢˜ï¼šrole å†…éƒ¨å¦‚ä½•å®šä¹‰é»˜è®¤å€¼ï¼Ÿ åœ¨ role ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª defaults ç›®å½•ï¼Œå¹¶æ”¾ä¸€ä¸ª main.yml ã€‚defaults/main.yml æ–‡ä»¶å†…å®¹å®šä¹‰å˜é‡çš„é»˜è®¤å€¼ã€‚role çš„ç›®å½•ç»“æ„è°ƒæ•´ä¸ºï¼š â”œâ”€â”€ defaults â”‚ â””â”€â”€ main.yml â”œâ”€â”€ files â”‚ â””â”€â”€ nginx.tar.gz â””â”€â”€ tasks â”œâ”€â”€ config.yml â””â”€â”€ main.yml nginx/defaults/main.yml çš„å†…å®¹å¦‚ä¸‹ï¼š --- nginx_package_tmp_dir: \"/tmp\" # å…¶å®ƒå˜é‡ï¼Œæ­¤å¤„çœç•¥ copy å­ä»»åŠ¡çš„æè¿°æ”¹æˆï¼š - name: \"ensure nginx package exists\" copy: src: \"nginx.tar.gz\" dest: \"{{ nginx_package_tmp_dir }}\" {{ }} æ˜¯å˜é‡çš„å ä½ç¬¦ã€‚nginx_package_tmp_dir ä¼šè¢«å®é™…å€¼æ‰€æ›¿æ¢ã€‚ template å­ä»»åŠ¡ nginx çš„é…ç½®æ˜¯ä¸€ä¸ª nginx.conf æ–‡ä»¶ã€‚nginx role ä¸­çš„ nginx.conf åº”è¯¥æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œæ¨¡æ¿å†…çš„å˜é‡å ä½ç¬¦ä¼šè¢«å˜é‡å®é™…å€¼æ›¿æ¢ã€‚æ¨¡æ¿å¼•æ“æˆ‘ä»¬é€‰æ‹©ï¼šJinja2ï¼Œä¸€ä¸ª Python çš„æ¨¡æ¿å¼•æ“ã€‚ è¿™æ ·æƒ³æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„å­ä»»åŠ¡ç±»å‹ templateï¼š - name: ensure nginx config template: src: \"nginx.conf\" dest: \"/usr/local/nginx/conf/nginx.conf\" # ç›®æ ‡è·¯å¾„ ä¸ copy ä»»åŠ¡ç±»ä¼¼ï¼Œä»å“ªé‡Œæ‹¿ nginx.conf æ¨¡æ¿æ–‡ä»¶å‘¢ï¼Ÿä¸ºåŒºåˆ†æ¨¡æ¿æ–‡ä»¶ä¸ä¸€èˆ¬æ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨ role ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª templates ç›®å½•ã€‚æœ€ç»ˆ nginx role çš„ç›®å½•ç»“æ„çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š â”œâ”€â”€ defaults â”‚ â””â”€â”€ main.yml â”œâ”€â”€ files â”‚ â””â”€â”€ nginx.tar.gz â”œâ”€â”€ tasks â”‚ â”œâ”€â”€ config.yml â”‚ â””â”€â”€ main.yml â””â”€â”€ templates â””â”€â”€ nginx.conf nginx.conf éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š ## çœç•¥ server { location / { proxy_pass http://127.0.0.1:/; } } æ–‡ä»¶ä¸­ {{apps_port}} æœ€ç»ˆä¼šè¢«å®é™…å˜é‡çš„å€¼æ›¿æ¢ã€‚ åœ¨å“ªé‡Œå®šä¹‰å˜é‡ï¼Ÿ ç›®å‰æ‰€æœ‰çš„é»˜è®¤å˜é‡å€¼éƒ½å®šä¹‰åœ¨ defaults/main.yml ä¸­ï¼Œé‚£ä¹ˆï¼Œrole çš„ä½¿ç”¨è€…å¦‚ä½•å®šä¹‰è‡ªå·±çš„å˜é‡å€¼å‘¢ï¼Ÿ æˆ‘ä»¬æ”¯æŒå¤šç§æ–¹å¼ï¼š playbook.yml æ–‡ä»¶ä¸­ playbook.yml æ–‡ä»¶ä¸­ï¼Œåˆåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š1. åœ¨ roles çº§åˆ«ï¼›2. åœ¨ playbook çº§åˆ«çš„ã€‚ä»£ç æ ·ä¾‹å¦‚ä¸‹ï¼š --- - hosts: \"nginx\" ## 1. playbook çº§åˆ«å˜é‡ vars: apps_port: 9090 roles: - firewalld ## 2. roles çº§åˆ«å˜é‡ - { role: nginx, apps_port: 9091 } inventory æ–‡ä»¶ä¸­ é’ˆå¯¹æ¯å°æœºå™¨ï¼ŒåŒä¸€å˜é‡å¯èƒ½éœ€è¦è®¾ç½®æˆä¸åŒçš„å€¼ã€‚ [springboot] 192.168.35.20 apps_port=9091 ansible_ssh_user=vagrant ansible_ssh_pass=vagrant 192.168.35.21 apps_port=9092 ansible_ssh_user=vagrant1 ansible_ssh_pass=vagrant1 192.168.35.22 apps_port=9093 ansible_ssh_user=vagrant2 ansible_ssh_pass=vagrant2 åœ¨ OPL3.0 ç‰ˆæœ¬ä¸­çš„é—ç•™é—®é¢˜ï¼Œç»ˆäºè§£å†³äº†ã€‚ansible\\_ssh\\_\\* ç±»çš„å˜é‡å¯ä»¥å…³è”åˆ°å…·ä½“æŸå°æœºå™¨äº†ã€‚ä¹Ÿå°±æ˜¯æ¯å°ä¸»æœºçš„ ansible\\_ssh\\_\\* çš„å€¼éƒ½å¯ä»¥æ˜¯ä¸ä¸€æ ·çš„ã€‚ å‘½ä»¤è¡Œè½¬å…¥ åœ¨å‘½ä»¤è¡Œä¸­åŠ å…¥å‚æ•°ï¼š--extra-vars å³å¯ã€‚ ansible-playbook release.yml --extra-vars \"version=1.23.45 other_variable=foo\" â€‹ å½“å˜é‡å¯ä»¥åœ¨å¤šå¤„å®šä¹‰æ—¶ï¼Œéšä¹‹è€Œæ¥çš„å°±æ˜¯å˜é‡çš„ä¼˜å…ˆçº§é—®é¢˜ã€‚å˜é‡çš„ä¼˜å…ˆçº§åº”è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿé—®é¢˜ç•™ç»™è¯»è€…æ€è€ƒã€‚ OPL è¯­è¨€8.0ï¼šæ”¯æŒæ¡ä»¶åˆ¤æ–­ 8.0 ç‰ˆæœ¬å†³å®šåŠ å…¥æ¡ä»¶åˆ¤æ–­ï¼šwhenã€‚ç”¨æ³•å¦‚ä¸‹ï¼š - name: Ensure nginx exists yum: name: nginx state: present when: ansible_os_family == \"CentOS\" å½“ç›®æ ‡æœºå™¨ä¸æ˜¯ CentOS æ—¶ï¼Œæ‰§è¡Œ yum æ“ä½œä¸€å®šæ˜¯å¤±è´¥çš„ã€‚æ‰€ä»¥ï¼Œåªæœ‰ ansible_os_family == \"CentOS\" ä¸º true æ—¶æ‰æ‰§è¡Œè¯¥å­ä»»åŠ¡ã€‚ ä¸Šä¾‹ä¸­ï¼Œåªæ˜¯å•æ¡ä»¶ã€‚å¦‚æœå¤šæ¡ä»¶å‘¢ï¼Ÿå¦‚ä½•å®ç°â€œä¸â€å’Œâ€œæˆ–â€å‘¢ï¼Ÿ â€œä¸â€çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š - name: \"shut down CentOS 6 and Debian 7 systems\" command: /sbin/shutdown -t now when: ansible_distribution == \"CentOS\" and ansible_distribution_major_version == \"6\" â€‹ æ³¨ï¼šcommand æ˜¯ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„å­ä»»åŠ¡ç±»å‹ã€‚ â€œä¸â€è¿˜æœ‰å¦ä¸€ç§å†™æ³•ï¼š - name: \"shut down CentOS 6 systems\" command: /sbin/shutdown -t now when: - ansible_distribution == \"CentOS\" - ansible_distribution_major_version == \"6\" â€œæˆ–â€çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š - name: \"shut down CentOS 6 and Debian 7 systems\" command: /sbin/shutdown -t now when: ansible_distribution == \"CentOS\" or ansible_distribution == \"Debian\" ) å½“ç„¶ï¼Œä½ å¯ä»¥ç»“åˆâ€œä¸â€å’Œâ€œæˆ–â€æ¥ä½¿ç”¨ï¼š - name: \"shut down CentOS 6 and Debian 7 systems\" command: /sbin/shutdown -t now when: (ansible_distribution == \"CentOS\" and ansible_distribution_major_version == \"6\") or (ansible_distribution == \"Debian\" and ansible_distribution_major_version == \"7\") ä½ å¯ä»¥æŠŠ when æƒ³åƒæˆç¼–ç¨‹è¯­è¨€ä¸­çš„ ifè¯­å¥ã€‚å®ƒä¸å…·ä½“çš„å­ä»»åŠ¡çš„ç±»å‹æ— å…³ï¼Œä»»åŠ¡å­ç±»å‹ä¸‹éƒ½å¯ä»¥ä½¿ç”¨ whenã€‚ OPL è¯­è¨€8.1ï¼šæ”¯æŒéå† å½“æŸä¸ªä»»åŠ¡éœ€è¦æ ¹æ®æ•°ç»„ä¸­çš„æ•°æ®è¿›è¡Œé‡å¤æ‰§è¡Œæ—¶ï¼ŒOPL è¯­è¨€å°±è¦è€ƒè™‘æ”¯æŒéå†äº†ã€‚ - name: Ensure soft exists yum: name: \"{{ item }}\" state: present when: ansible_os_family == \"CentOS\" with_items: - gcc - gcc-c++ å¯ä»¥å°† with_items ç†è§£æˆç¼–ç¨‹è¯­è¨€ä¸­çš„ forè¯­å¥ã€‚{{ item }} ä¸­çš„ item çº¦å®šä»£è¡¨éå†çš„å…ƒç´ ã€‚ OPL è¯­è¨€9.0ï¼šå­ä»»åŠ¡æ”¯æŒè¿”å›å€¼ ç”¨æˆ·åœ¨ä½¿ç”¨ OPL è¯­è¨€æ—¶ï¼Œå†™å‡ºä»¥ä¸‹ä»£ç ï¼š - name: ensure nginx config template: src: \"nginx.conf\" dest: \"/usr/local/nginx/conf\" - name: restart nginx service: name: nginx state: restarted ä»£ç é—®é¢˜å‡ºç°åœ¨å“ªé‡Œå‘¢ï¼Ÿå®ƒä¸æ˜¯å¹‚ç­‰çš„ã€‚ä¸è®º nginx.conf æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–°ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡ OPL å®ƒéƒ½ä¼šé‡å¯ä¸€æ¬¡ nginx æœåŠ¡ã€‚ æˆ‘ä»¬æœŸæœ›çš„æ˜¯å½“ nginx.conf æœ‰æ›´æ–°æ—¶æ‰æ‰§è¡Œå¯åŠ¨ nginx æœåŠ¡ã€‚ æˆ‘ä»¬åº”è¯¥å¦‚ä½•è®¾è®¡ OPL ä»¥è§„é¿æ­¤ç±»é—®é¢˜å‘¢ï¼Ÿ æˆ‘ä»¬ä»é—®é¢˜æœ¬èº«å¼€å§‹ã€‚å½“å­ä»»åŠ¡è®¾è®¡å®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœå»æ‰§è¡Œå¦ä¸€ä¸ªå­ä»»åŠ¡ã€‚ç”¨é€šç”¨ç¼–ç¨‹è¯­è¨€æ¥è¡¨è¾¾ï¼Œå¾ˆç®€å•ï¼š boolean changed = template(\"nginx.conf\", \"/usr/local/nginx/conf\") if(changed){ service(\"nginx\",\"restarted\") } åœ¨é€šç”¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±å®ç°çš„åŠŸèƒ½ï¼Œåœ¨ YAML ä¸­å¦‚ä½•å®ç°å‘¢ï¼Ÿå…¶å®ç±»ä¼¼çš„ï¼Œè®©æ‰€æœ‰çš„å­ä»»åŠ¡æ”¯æŒè¿”å›å€¼ï¼Œç„¶ååœ¨åç»­å­ä»»åŠ¡åšåˆ¤æ–­å°±å¥½äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š - name: ensure nginx config template: src: \"nginx.conf\" dest: \"/usr/local/nginx/conf\" register: nginx_config_result - name: restart nginx service: name: nginx state: restarted when: nginx_config_result.changed register æ˜¯æ–°çš„è¯­å¥ï¼Œç”¨äºå®šä¹‰å­ä»»åŠ¡è¿”å›ç»“æœåç§°ã€‚nginx_config_result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­ changed å°±æ˜¯å®ƒçš„å±æ€§ã€‚changed ä¸º true æ—¶ï¼Œä»£è¡¨ ensure nginx config å­ä»»åŠ¡æœ‰å˜åŒ–ã€‚ OPL è¯­è¨€9.1ï¼šæ”¯æŒå»¶è¿Ÿå¤„ç† åœ¨ä½¿ç”¨ 9.0 ç‰ˆæœ¬ä¸€æ®µæ—¶é—´åï¼Œç”¨æˆ·å¼€å§‹æŠ¥æ€¨ä»¥ä¸‹ä»£ç å†™èµ·æ¥å¤ªå“†å—¦ï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ï¼š - name: ensure nginx config template: src: \"nginx.conf\" dest: \"/usr/local/nginx/conf\" register: nginx_conf_result - name: ensure nginx upstream config template: src: \"upstream.conf\" dest: \"/usr/local/nginx/conf/upstream.conf\" register: nginx_upstream_result - name: ensure nginx vhosts config template: src: \"vhosts.conf\" dest: \"/usr/local/nginx/conf/vhosts.conf\" register: nginx_vhosts_result - name: restarted nginx service service: name: nginx state: restarted when: nginx_conf_result.changed or nginx_upstream_result.changed or nginx_vhosts_result.changed ç”¨æˆ·å†™æˆè¿™ä¹ˆå“†å—¦çš„è¯­å¥ï¼Œå¹¶ä¸æ˜¯ç”¨æˆ·çš„é—®é¢˜ã€‚è€Œæ˜¯æˆ‘ä»¬çš„è®¾è®¡æœ‰æ²¡è€ƒè™‘åˆ°çš„åœ°æ–¹ã€‚ä¹Ÿå°±æ˜¯æœ‰äº›ä»»åŠ¡æ˜¯éœ€è¦è¢«å¦å¤–ä¸€äº›ä»»åŠ¡è§¦å‘æ‰§è¡Œçš„ã€‚æˆ‘ä»¬å½“å‰ä¸æ”¯æŒæ­¤ç§åœºæ™¯ã€‚ ä¸ºå®ç°æ­¤ç±»åœºæ™¯ï¼Œéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š ä¸»åŠ¨è§¦å‘å­ä»»åŠ¡ï¼Œä½¿ç”¨ notify è¯­å¥æŒ‡å®šè¦è§¦å‘çš„å¦ä¸€ä¸ªä»»åŠ¡çš„ä»»åŠ¡åã€‚ é›†ä¸­ä¿å­˜è¢«åŠ¨è§¦å‘çš„ä»»åŠ¡ï¼Œä»¥åŒºåˆ†ä¸»åŠ¨æ‰§è¡Œçš„ä»»åŠ¡å’Œè¢«åŠ¨æ‰§è¡Œçš„ä»»åŠ¡ã€‚çº¦å®šè¢«åŠ¨è§¦å‘çš„ä»»åŠ¡æ”¾åœ¨ role ç›®å½•ä¸‹çš„ handlers/main.yml æ–‡ä»¶ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…·ä½“çœ‹ä¸‹å¦‚ä½•é‡æ„ä»¥ä¸Šå“†å—¦çš„å†™æ³•ã€‚ ç¬¬ä¸€æ­¥ï¼Œå¯¹ nginx role ç›®å½•è¿›è¡Œè°ƒæ•´ï¼š â”œâ”€â”€ defaults â”‚ â””â”€â”€ main.yml â”œâ”€â”€ files â”‚ â””â”€â”€ nginx.tar.gz â”œâ”€â”€ handlers â”‚ â””â”€â”€ main.yml â”œâ”€â”€ tasks â”‚ â”œâ”€â”€ config.yml â”‚ â””â”€â”€ main.yml â””â”€â”€ templates â””â”€â”€ nginx.conf ç¬¬äºŒæ­¥ï¼Œé‡æ„ tasks/config.ymlï¼š - name: ensure nginx config template: src: \"nginx.conf\" dest: \"/usr/local/nginx/conf\" notify: - restart nginx - name: ensure nginx upstream config template: src: \"upstream.conf\" dest: \"/usr/local/nginx/conf/upstream.conf\" notify: - restart nginx - name: ensure nginx vhosts config template: src: \"vhosts.conf\" dest: \"/usr/local/nginx/conf/vhosts.conf\" notify: - restart nginx ç¬¬ä¸‰æ­¥ï¼Œå‘ handlers/main.yml æ–‡ä»¶åŠ å…¥è¢«åŠ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼š --- - name: restart nginx service: name: nginx state: restarted OPL è¯­è¨€ä¹‹å ä»¥ä¸Šåªæ˜¯ OPL è¯­è¨€çš„é›å½¢ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ ¹æ®ç°å®çš„æƒ…å†µä¸æ–­çš„æ‰©å±•å’Œå®Œå–„ã€‚OPL è¯­è¨€çš„è®¾è®¡åªæ˜¯å®ç°è¿ç»´æœºå™¨äººçš„ä¸€éƒ¨åˆ†å·¥ä½œã€‚æˆ‘ä»¬è¿˜éœ€è¦åšçš„å·¥ä½œåŒ…æ‹¬ï¼šå®ç°ä¸€ä¸ªç¨‹åºï¼Œå®ƒä¼šå¯¹ OPL è¯­è¨€è¿›è¡Œç¼–è¯‘ã€‚å¹¶å°†ç¼–è¯‘åçš„ python è„šæœ¬ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚python è„šæœ¬è¿è¡Œåï¼Œè¿™ä¸ªç¨‹åºå°†è¿è¡Œç»“æœåé¦ˆç»™ç”¨æˆ·ã€‚ è¿™ä¸ªç¨‹åºå°±æ˜¯æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­æ•²å…¥çš„ ansible-playbook äº†ã€‚ è‡³äº ansible-playbook çš„æ›´å¤šç»†èŠ‚ï¼Œå·²ä¸å±äºæœ¬æ–‡çš„å†…å®¹ï¼Œä¸ä½œè®¨è®ºã€‚ æ€»ç»“ æœ¬æ–‡é¦–å…ˆä»ç”µè„‘åº—å¼•å‡ºç°ä»£è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·çš„åŸºæœ¬æ¨¡å‹ã€‚æ¥ç€è®¨è®ºåº”è¯¥å¦‚ä½•è®¾è®¡ä¸€æ¬¾è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼ˆä¸Šæ–‡ç§°ä¸ºè¿ç»´æœºå™¨äººï¼‰ã€‚ä»è€Œå¾—çŸ¥éœ€è¦è§£å†³ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š éœ€è¦å°† YAML è½¬æˆç›®æ ‡æœºå™¨å¯æ‰§è¡Œçš„ç¨‹åºï¼ˆæˆ–è„šæœ¬ï¼‰ï¼› éœ€è¦å°†å¯æ‰§è¡Œçš„ç¨‹åºä¸Šä¼ åˆ°ç›®æ ‡æœºå™¨ï¼Œå¹¶æ‰§è¡Œã€‚ ç„¶åæˆ‘ä»¬èŠ±äº†å¤§ç¯‡å¹…ä»‹ç» OPL è¯­è¨€çš„è®¾è®¡ï¼ˆå®é™…ä¸Šæ˜¯ä»‹ç» Ansible çš„ YAML ä¸ºä»€ä¹ˆè¦åƒç°åœ¨è¿™æ ·å†™ï¼‰ã€‚æœ€åç®€å•ä»‹ç» OPL è¯­è¨€åè¦åšçš„äº‹æƒ…ã€‚ è€å®è¯´ï¼Œä»¥ä¸Šå¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ä»é›¶è®¾è®¡ Ansibleã€‚ä¹Ÿä¸å­˜åœ¨ä»€ä¹ˆ OPL è¯­è¨€ã€‚ç¬”è€…åªæ˜¯å¸Œæœ›é€šè¿‡ OPL è¯­è¨€çš„è®¾è®¡è¿‡ç¨‹ï¼Œå°è¯•è®©è¯»è€…äº†è§£ Ansible çš„è®¾è®¡æ€è·¯ã€‚æœŸæœ›è¯»è€…å› ä¸ºæœ¬æ–‡ï¼Œå­¦ä¹  Ansible å˜å¾—æ›´è½»æ¾ã€‚ æœ€åï¼Œæ–‡æœ«æœ‰ OPL è¯­è¨€å„ç‰ˆæœ¬çš„æ ·ä¾‹ã€‚ é™„ ä»é›¶è®¾è®¡ Ansible ä»£ç æ ·ä¾‹ï¼šhttps://github.com/zacker330/design-ansible Jinja2 æ¨¡æ¿è¯­è¨€ï¼šhttp://docs.jinkan.org/docs/jinja2/ End æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/ansible/ansibleåŸºç¡€çŸ¥è¯†.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/ansible/ansibleåŸºç¡€çŸ¥è¯†.html","title":"AnsibleåŸºç¡€çŸ¥è¯†","keywords":"","body":"AnsibleåŸºç¡€çŸ¥è¯† 1.AnsibleåŸºæœ¬æ¦‚è¿° Ansibleæ˜¯ä¸€ä¸ªé…ç½®ç®¡ç†ç³»ç»Ÿconfiguration management systemä½ åªéœ€è¦å¯ä»¥ä½¿ç”¨sshè®¿é—®ä½ çš„æœåŠ¡å™¨æˆ–è®¾å¤‡å°±è¡Œ 1.1Ansibleèƒ½åšä»€ä¹ˆ ansibleå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆä¸€äº›æ‰¹é‡ä»»åŠ¡ï¼Œæˆ–è€…å®Œæˆä¸€äº›éœ€è¦ç»å¸¸é‡å¤çš„å·¥ä½œã€‚ æ¯”å¦‚ï¼šåŒæ—¶åœ¨100å°æœåŠ¡å™¨ä¸Šå®‰è£…nginxæœåŠ¡ï¼Œå¹¶åœ¨å®‰è£…åå¯åŠ¨æœåŠ¡ã€‚ æ¯”å¦‚ï¼šå°†æŸä¸ªæ–‡ä»¶ä¸€æ¬¡æ€§æ‹·è´åˆ°100å°æœåŠ¡å™¨ä¸Šã€‚ æ¯”å¦‚ï¼šæ¯å½“æœ‰æ–°æœåŠ¡å™¨åŠ å…¥å·¥ä½œç¯å¢ƒæ—¶ï¼Œä½ éƒ½è¦ä¸ºæ–°æœåŠ¡å™¨éƒ¨ç½²æŸä¸ªæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ éœ€è¦ç»å¸¸é‡å¤çš„å®Œæˆç›¸åŒçš„å·¥ä½œã€‚ è¿™äº›åœºæ™¯ä¸­æˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨åˆ°ansibleã€‚ 1.2Ansibleè½¯ä»¶ç‰¹ç‚¹ 1.ansibleä¸éœ€è¦å•ç‹¬å®‰è£…å®¢æˆ·ç«¯ï¼ŒSSHç›¸å½“äºansibleå®¢æˆ·ç«¯ã€‚ 2.ansibleä¸éœ€è¦å¯åŠ¨ä»»ä½•æœåŠ¡ï¼Œä»…éœ€å®‰è£…å¯¹åº”å·¥å…·å³å¯ã€‚ 3.ansibleä¾èµ–å¤§é‡çš„pythonæ¨¡å—æ¥å®ç°æ‰¹é‡ç®¡ç†ã€‚ 4.ansibleé…ç½®æ–‡ä»¶/etc/ansible/ansible.cfg 1.3AnsibleåŸºç¡€æ¶æ„ 1.è¿æ¥æ’ä»¶(connectior plugins) ç”¨äºè¿æ¥ä¸»æœº ç”¨æ¥è¿æ¥è¢«ç®¡ç†ç«¯ 2.æ ¸å¿ƒæ¨¡å—(core modules) è¿æ¥ä¸»æœºå®ç°æ“ä½œï¼Œ å®ƒä¾èµ–äºå…·ä½“çš„æ¨¡å—æ¥åšå…·ä½“çš„äº‹æƒ… 3.è‡ªå®šä¹‰æ¨¡å—(custom modules) æ ¹æ®è‡ªå·±çš„éœ€æ±‚ç¼–å†™å…·ä½“çš„æ¨¡å— 4.æ’ä»¶(plugins) å®Œæˆæ¨¡å—åŠŸèƒ½çš„è¡¥å…… 5.å‰§æœ¬(playbooks)ansibleçš„é…ç½®æ–‡ä»¶,å°†å¤šä¸ªä»»åŠ¡å®šä¹‰åœ¨å‰§æœ¬ä¸­ï¼Œç”±ansibleè‡ªåŠ¨æ‰§è¡Œ 6.ä¸»æœºæ¸…å•(host inventory)å®šä¹‰ansibleéœ€è¦æ“ä½œä¸»æœºçš„èŒƒå›´ æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ ansibleæ˜¯æ¨¡å—åŒ–çš„ å®ƒæ‰€æœ‰çš„æ“ä½œéƒ½ä¾èµ–äºæ¨¡å— 2.Ansibleå®‰è£…é…ç½® æ‰€æœ‰çš„å—æ§ä¸»æœºå¿…é¡»ä¸ansibleæœåŠ¡ç«¯åšsshå…å¯†ç™»é™† 2.1.å®‰è£…ansible(éœ€è¦é…ç½®epelæº) [root@m01 ~]# yum install ansible -y //æ£€æŸ¥ansibleç‰ˆæœ¬ [root@m01 ~]# ansible --version ansible 2.6.1 2.2é…ç½®ansible [root@m01 ~]# cat >> /etc/ansible/hosts 2.3éªŒè¯ansibleä¸å—æ§æœºæ˜¯å¦é€šä¿¡ //ansibleæ˜¯é€šè¿‡sshç«¯å£æ¢æµ‹é€šä¿¡ [root@m01 ~]# ansible hehe -m ping 10.0.0.30 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } 10.0.0.40 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } 2.4ansibleè¯­æ³•æ ¼å¼ å‘½ä»¤ ä¸»æœºæ¨¡å—å æŒ‡å®šæ¨¡å—å‚æ•° æ¨¡å—åç§° æŒ‡å®šåˆ©ç”¨æ¨¡å—æ‰§è¡Œçš„åŠ¨ä½œé€‰é¡¹ æ‰¹é‡æ‰§è¡Œæ“ä½œåŠ¨ä½œ [root@m01 ~]# ansible all -m command -a \"hostname\" 10.0.0.31 | SUCCESS | rc=0 >> backup 10.0.0.41 | SUCCESS | rc=0 >> nfs01 all æ¨¡å—å -m æŒ‡å®šæ¨¡å— command commandæ¨¡å—ï¼Œå®ŒæˆåŸºç¡€å‘½ä»¤ -a æŒ‡å®šæ‰§è¡ŒåŠ¨ä½œ \"hostname\" æ‰§è¡Œhostnameå‘½ä»¤ 3.Ansibleç³»åˆ—å‘½ä»¤ 3.1ansiblieç³»åˆ—å‘½ä»¤1ï¼šansible ä½¿ç”¨åœºæ™¯ï¼š éå›ºåŒ–éœ€æ±‚ ä¸´æ—¶ä¸€æ¬¡æ€§æ“ä½œ äºŒæ¬¡å¼€å‘æ¥å£è°ƒç”¨ ä½¿ç”¨ç¤ºä¾‹ //æ£€æŸ¥æœåŠ¡å™¨å­˜æ´»çŠ¶æ€ ansible all -m ping 3.2ansiblieç³»åˆ—å‘½ä»¤2ï¼šansible-galaxy å‘½ä»¤ä½œç”¨ï¼š æ ¹æ®ä¸‹è½½é‡å’Œå…³æ³¨é‡ç­‰ä¿¡æ¯ï¼ŒæŸ¥æ‰¾å’Œå®‰è£…ä¼˜ç§€çš„roles å‘½ä»¤æ ¼å¼ï¼š ansible-galaxy [init|info|install|list|remove] [ --help] [options] ... å‘½ä»¤åˆ†ä¸º3éƒ¨åˆ† (1) [init|info|install|list|remove] init åˆå§‹åŒ–æœ¬åœ°çš„rolesé…ç½®ï¼Œä»¥å¤‡ä¸Šä¼ rolesè‡³galaxy info åˆ—è¡¨æŒ‡å®šroleçš„è¯¦ç»†ä¿¡æ¯ install ä¸‹è½½å¹¶å®‰è£…galaxyæŒ‡å®šçš„rolesåˆ°æœ¬åœ° list åˆ—å‡ºæœ¬åœ°å·²ç»ä¸‹è½½çš„roles remove åˆ é™¤æœ¬åœ°å·²ç»ä¸‹è½½çš„roles (2) helpç”¨æ³•æ˜¾ç¤º[--help] ansible-galaxy init --help (3) å‚æ•°é¡¹ ansible-galaxy init [options] role_name 3.3ansiblieç³»åˆ—å‘½ä»¤3ï¼šansible-doc å‘½ä»¤ä½œç”¨ï¼š æ¨¡å—æ–‡æ¡£è¯´æ˜ å‘½ä»¤æ ¼å¼ï¼š ansible-doc [options] [module] ç¤ºä¾‹ï¼š //åˆ—å‡ºansibleæ”¯æŒçš„ æ¨¡å— ansible-doc -l //æ¨¡å—åŠŸèƒ½è¯´æ˜ ansible-doc ping 3.4ansiblieç³»åˆ—å‘½ä»¤4ï¼šansible-playbook å‘½ä»¤ä½œç”¨ï¼š è¯»å–é¢„å…ˆç¼–å†™å¥½çš„playbookæ–‡ä»¶å®ç°æ‰¹é‡ç®¡ç† å‘½ä»¤æ ¼å¼ï¼š ansible-playbook xxx.yaml ç¤ºä¾‹ï¼š //æ‰§è¡Œhttp_installè¿™ä¸ªplaybookç§å®šä¹‰çš„æ‰€æœ‰ä»»åŠ¡é›† ansible-playbook http_install.yaml 3.5ansiblieç³»åˆ—å‘½ä»¤5ï¼šansible-vault å‘½ä»¤ä½œç”¨ï¼š ç”¨äºé…ç½®æ–‡ä»¶åŠ å¯† å‘½ä»¤æ ¼å¼ï¼š ansible-vault [encrypt|decrypt|create|edit|rekey|view] [--help] [options] file ç¤ºä¾‹ï¼š //åŠ å¯†a.yamlæ–‡ä»¶ ansible-vault encrypt a.yaml encrypt åŠ å¯† //åŠ å¯†åæŸ¥çœ‹a.yamlæ–‡ä»¶å°±ä¼šæ˜¾ç¤ºä¹±ç  //è§£å¯†a.yamlæ–‡ä»¶ ansible-vault decrypt a.yaml decrypt è§£å¯† 4.Ansibleæ­£åˆ™ 4.1ALLå…¨é‡åŒ¹é… allæˆ–* åŒ¹é…æ‰€æœ‰ä¸»æœºï¼Œallä¸*å·åŠŸèƒ½ç›¸åŒ //allå’Œå·åŠŸèƒ½ç›¸åŒï¼Œä½†æ˜¯\\å·éœ€è¦ç”¨\"\"å¼•èµ·æ¥ ansible all -m ping ansible \"*\" -m ping 4.2é€»è¾‘æˆ–åŒ¹é… ï¼š åŒæ—¶å¯¹å¤šå°ä¸»æœºæˆ–å¤šä¸ªç»„åŒæ—¶æ‰§è¡Œï¼Œç›¸äº’ä¹‹é—´ç”¨\":\"åˆ†å‰² web1:web2 //æ£€æµ‹webç»„å’Œnfsç»„ä¸­æ‰€æœ‰ä¸»æœºçš„å­˜æ´» ansible \"web:nfs\" -m ping 4.3é€»è¾‘éåŒ¹é… ï¼ é€»è¾‘éç”¨!è¡¨ç¤ºï¼Œä¸»è¦é’ˆå¯¹å¤šé‡æ¡ä»¶çš„åŒ¹é…è§„åˆ™ //æ‰€æœ‰åœ¨aç»„ä½†ä¸åœ¨bç»„çš„ä¸»æœº a:!b 4.4é€»è¾‘ä¸åŒ¹é… & é€»è¾‘ä¸ç”¨&è¡¨ç¤º //aç»„å’Œbç»„ä¸­åŒæ—¶å­˜åœ¨çš„ä¸»æœº a:&b 4.5æ¨¡ç³ŠåŒ¹é… * *é€šé…ç¬¦åœ¨ansibleä¸­è¡¨ç¤º0ä¸ªæˆ–å¤šä¸ªä»»æ„å­—ç¬¦ //æ‰€æœ‰ä»¥wwwå¼€å¤´.comç»“å°¾çš„ä¸»æœº 4.6æ­£åˆ™åŒ¹é… ~ ~åœ¨ansibleä¸­è¡¨ç¤ºæ­£åˆ™åŒ¹é… //åŒ¹é…www.a.comå’Œwww.b.com âš ï¸æ³¨æ„ ~è¦åœ¨æœ€å‰è¾¹ï¼Œä¸€å®šè¦åŠ åŒå¼•å· 5.Ansibleæ¸…å•ç®¡ç† inventoryæ–‡ä»¶é€šå¸¸ç”¨äºå®šä¹‰è¦ç®¡ç†ä¸»æœºçš„è®¤è¯ä¿¡æ¯ï¼Œ ä¾‹å¦‚sshç™»å½•ç”¨æˆ·åã€å¯†ç ä»¥åŠkeyç›¸å…³ä¿¡æ¯ã€‚å¦‚ä½•é…ç½®Inventoryæ–‡ä»¶ ä¸»æœº 1.æ”¯æŒä¸»æœºåé€šé…ä»¥åŠæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¾‹å¦‚web[1:3].abc.com 2.æ”¯æŒåŸºäºéæ ‡å‡†çš„sshç«¯å£ï¼Œä¾‹å¦‚web1.abc.com:6666 3.æ”¯æŒæŒ‡å®šå˜é‡ï¼Œå¯å¯¹ä¸ªåˆ«ä¸»æœºçš„ç‰¹æ®Šé…ç½®ï¼Œå¦‚ç™»é™†ç”¨æˆ·ï¼Œå¯†ç ç­‰ ä¸»æœºç»„ 1.æ”¯æŒåµŒå¥—ç»„ï¼Œä¾‹å¦‚[game:children],é‚£ä¹ˆåœ¨gameæ¨¡å—ä¸‹é¢çš„ç»„éƒ½ä¼šè¢«gameæ‰€åŒ…å« 2.æ”¯æŒæŒ‡å®šå˜é‡ï¼Œä¾‹å¦‚[game:vars]åœ¨ä¸‹é¢æŒ‡å®šå˜é‡ [root@m01 ~]# cat /etc/ansible/hosts [webservers] 10.0.0.8 10.0.0.31 10.0.0.41 10.0.0.61 //æ·»åŠ ä¸‰å°ä¸»æœºè‡³webserver[lowç‰ˆ] [webservers] web1.abc.com web2.abc.com web3.abc.com //æ·»åŠ ä¸‰å°ä¸»æœºè‡³webserver[lowæ”¹è‰¯ç‰ˆ] [webservers] web[1:3].abc.com //æ·»åŠ ä¸‰å°ä¸»æœºè‡³webserver[å¯†ç ç‰ˆ] [webservers] web1.abc.com ansible_ssh_pass='123456' web2.abc.com ansible_ssh_pass='123456' web3.abc.com ansible_ssh_pass='123456' //æ·»åŠ ä¸‰å°ä¸»æœºè‡³webserver[å¯†ç æ”¹è‰¯ç‰ˆ] [webservers] web[1:3].abc.com ansible_ssh_pass='123456' //æ·»åŠ ä¸‰å°ä¸»æœºè‡³webserver[å¯†ç æ‹†åˆ†ç‰ˆ] [webservers] web1.abc.com web2.abc.com web3.abc.com [webservers:vars] ansible_ssh_pass='123456' //å®šä¹‰å¤šç»„ï¼Œå¤šç»„æ±‡æ€»æ•´åˆ [apache] web1.abc.com web2.abc.com web3.abc.com [apache:vars] ansible_ssh_pass='123456' [nginx] 10.0.0.7 10.0.0.31 10.0.0.41 10.0.0.61 [nginx:vars] ansible_ssh_pass='123456' //webserversç»„åŒ…æ‹¬ä¸¤ä¸ªå­ç»„[apapche,nginx] [webservers:children] apache nginx ansible nginx --list-hosts ansible apache --list-hosts ansible websers --list-hosts Ansibleå†…ç½®å˜é‡ å‚æ•° ç”¨é€” ç¤ºä¾‹ ansible_ssh_host å®šä¹‰hosts sshåœ°å€ ansible_ssh_host=192.168.1.10 ansible_ssh_port å®šä¹‰hosts sshç«¯å£ ansible_ssh_port=2222 ansible_ssh_user å®šä¹‰hosts sshè®¤è¯ç”¨æˆ· ansible_ssh_user=user ansible_ssh_pass å®šä¹‰hosts sshè®¤è¯å¯†ç  ansible_ssh_pass=pass ansible_sudo å®šä¹‰hosts sudoç”¨æˆ· ansible_sudo=www ansible_sudo_pass å®šä¹‰hosts sudoå¯†ç  ansible_sudo_pass=pass ansible_sudo_exe å®šä¹‰hosts sudoè·¯å¾„ ansible_sudo_exe=/usr/bin/sudo ansible_connection å®šä¹‰hosts è¿æ¥æ–¹å¼ ansible_connection=local ansible_ssh_private_key_file å®šä¹‰hosts ç§é’¥ ansible_ssh_private_key_file=/root/key ansible_ssh_shell_type å®šä¹‰hosts shellç±»å‹ ansible_ssh_shell_type=bash ansible_python_interpreter å®šä¹‰hosts ä»»åŠ¡æ‰§è¡Œpythonè·¯å¾„ ansible_python_interpreter=/usr/bin/python2.7 ansible_*_interpreter å®šä¹‰hosts å…¶ä»–è¯­è¨€è§£æè·¯å¾„ ansible_* _interpreter=/usr/bin/ruby 6.Ansible Playbook playbookæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—ç»„æˆçš„ï¼Œä½¿ç”¨å¤šä¸ªä¸åŒçš„æ¨¡å—ï¼Œå®Œæˆä¸€ä»¶äº‹æƒ… playbooké€šè¿‡yamlè¯­æ³•è¯†åˆ«æè¿°çš„çŠ¶æ€æ–‡ä»¶ã€‚æ‰©å±•åæ˜¯yamlæˆ–yml 6.1YAMLä¸‰æ¿æ–§ ç¼©è¿› YAMLä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„ç¼©è¿›é£æ ¼è¡¨ç¤ºå±‚çº§ç»“æ„,æ¯ä¸ªç¼©è¿›ç”±ä¸¤ä¸ªç©ºæ ¼ç»„æˆ, ä¸èƒ½ä½¿ç”¨tabs å†’å· ä»¥å†’å·ç»“å°¾çš„é™¤å¤–ï¼Œå…¶ä»–æ‰€æœ‰å†’å·åé¢æ‰€æœ‰å¿…é¡»æœ‰ç©ºæ ¼ çŸ­æ¨ªçº¿ è¡¨ç¤ºåˆ—è¡¨é¡¹ï¼Œä½¿ç”¨ä¸€ä¸ªçŸ­æ¨ªæ åŠ ä¸€ä¸ªç©ºæ ¼ å¤šä¸ªé¡¹ä½¿ç”¨åŒæ ·çš„ç¼©è¿›çº§åˆ«ä½œä¸ºåŒä¸€åˆ—è¡¨ 6.2ansible playbookå®‰è£…Apacheç¤ºä¾‹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/ansible/ansibleå¸¸ç”¨æ¨¡å—.html":{"url":"linux/è‡ªåŠ¨åŒ–è¿ç»´å¹³å°/ansible/ansibleå¸¸ç”¨æ¨¡å—.html","title":"Ansibleå¸¸ç”¨æ¨¡å—","keywords":"","body":"Ansibleå¸¸ç”¨æ¨¡å— æ¨¡å—åœ¨ansibleä¸­æ˜¯æŒ‡éœ€è¦å¿«é€Ÿæ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œ å¹¶ä¸”ä¸éœ€è¦ä¿å­˜çš„å‘½ä»¤ï¼Œå¯¹äºå¤æ‚çš„å‘½ä»¤åˆ™ä¸ºplaybook Ansibleæ³¨æ„äº‹é¡¹->æç¤ºé¢œè‰²ä¿¡æ¯è¯´æ˜ ç¿”é»„è‰²ï¼šå¯¹è¿œç¨‹èŠ‚ç‚¹è¿›è¡Œç›¸åº”ä¿®æ”¹ å¸½å­ç»¿ï¼šå¯¹è¿œç¨‹èŠ‚ç‚¹ä¸è¿›è¡Œç›¸åº”ä¿®æ”¹ï¼Œæˆ–è€…åªæ˜¯å¯¹è¿œç¨‹èŠ‚ç‚¹ä¿¡æ¯è¿›è¡ŒæŸ¥çœ‹ æ·±çº¢è‰²ï¼šæ“ä½œæ‰§è¡Œå‘½ä»¤æœ‰å¼‚å¸¸ æµ…ç´«è‰²ï¼šè¡¨ç¤ºå¯¹å‘½ä»¤æ‰§è¡Œå‘å‡ºè­¦å‘Šä¿¡æ¯ï¼ˆå¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Œç»™ä½ ä¸€ä¸‹å»ºè®®ï¼‰ ansibleæŸ¥çœ‹å¸®åŠ©æ–¹æ³• [root@m01 ~]# ansible-doc -l #æŸ¥çœ‹æ‰€æœ‰æ¨¡å—è¯´æ˜ä¿¡æ¯ [root@m01 ~]# ansible-doc copy #è¡¨ç¤ºæŒ‡å®šæŸ¥çœ‹æŸä¸ªæ¨¡å—å‚æ•°ç”¨æ³•ä¿¡æ¯ ä¸€ã€å‘½ä»¤æ¨¡å— 1.1commandæ¨¡å— ä¸æ”¯æŒç®¡é“ ä¸æ”¯æŒé€šé…ç¬¦ //é»˜è®¤æ¨¡å—, æ‰§è¡Œå‘½ä»¤ [root@m01 ~]# ansible all -m command -a \"hostname\" [root@m01 ~]# ansible all -a hostname 1.2shellæ¨¡å— æ”¯æŒç®¡é“ æ”¯æŒé€šé…ç¬¦ [root@m01 ~]# ansible all -m shell -a \"ifconfig|grep eth0\" -f 50 -f =forks /etc/ansible/ansible.cfg #ç»“æœè¿”å›çš„æ•°é‡ 1.3rawæ¨¡å— æ”¯æŒç®¡é“ æ”¯æŒé€šé…ç¬¦ [root@m01 ~]# ansible all -m raw -a \"ifconfig\" äºŒã€è„šæœ¬æ¨¡å— 2.1scriptæ‰§è¡Œè„šæœ¬æ¨¡å— //ç¼–å†™è„šæœ¬ [root@m01 ~]# mkdir -p /server/scripts [root@m01 ~]# cat /server/scripts/yum.sh #!/usr/bin/bash yum -y install iftop //åœ¨æœ¬åœ°è¿è¡Œæ¨¡å—ï¼Œç­‰åŒäºåœ¨è¿œç¨‹æ‰§è¡Œï¼Œä¸éœ€è¦å°†è„šæœ¬æ–‡ä»¶è¿›è¡Œæ¨é€ç›®æ ‡ä¸»æœºæ‰§è¡Œ [root@m01 ~]# ansible web01 -m script -a \"/server/scripts/yum.sh\" ä¸‰ã€å®‰è£…æ¨¡å— 3.1yumå®‰è£…è½¯ä»¶æ¨¡å— [root@m01 ~]# ansible all -m yum -a \"name=httpd state=installed\" name #æŒ‡å®šè¦å®‰è£…çš„è½¯ä»¶åŒ…åç§° state #æŒ‡å®šä½¿ç”¨yumçš„æ–¹æ³• installedï¼Œpresent #å®‰è£…è½¯ä»¶åŒ… removedï¼Œabsent #ç§»é™¤è½¯ä»¶åŒ… latest #å®‰è£…æœ€æ–°è½¯ä»¶åŒ… å››ã€æ–‡ä»¶æ¨¡å— 4.1copyæ‹·è´æ–‡ä»¶æ¨¡å— //æ¨é€æ–‡ä»¶æ¨¡å— [root@m01 ~]# ansible all -m copy -a \"src=/etc/hosts dest=/tmp/test.txt\" //åœ¨æ¨é€è¦†ç›–è¿œç¨‹ç«¯æ–‡ä»¶å‰ï¼Œå¯¹è¿œç«¯å·²æœ‰æ–‡ä»¶è¿›è¡Œå¤‡ä»½ï¼ŒæŒ‰ç…§æ—¶é—´ä¿¡æ¯å¤‡ä»½ [root@m01 ~]# ansible all -m copy -a \"src=/etc/hosts dest=/tmp/test.txt backup=yes\" æ³¨æ„ï¼šå½“ansibleæœ¬åœ°/etc/hostsæ–‡ä»¶å†…å®¹å˜åŒ–ä¹‹åï¼Œå—æ§æœºæœ¬åœ°æ‰ä¼šæœ‰å¤‡ä»½æ–‡ä»¶ [root@web01 tmp]# ls hehe test.txt test.txt.2772.2017-09-15@09:43:26~ //ç›´æ¥å‘è¿œç«¯æ–‡ä»¶å†…å†™å…¥æ•°æ®ä¿¡æ¯ï¼Œå¹¶ä¸”ä¼šè¦†ç›–è¿œç«¯æ–‡ä»¶å†…åŸæœ‰æ•°æ®ä¿¡æ¯ [root@m01 ~]# ansible all -m copy -a \"content='abc' dest=/tmp/abc\" src #æ¨é€æ•°æ®çš„æºæ–‡ä»¶ä¿¡æ¯ dest #æ¨é€æ•°æ®çš„ç›®æ ‡è·¯å¾„ backup #å¯¹æ¨é€ä¼ è¾“è¿‡å»çš„æ–‡ä»¶ï¼Œè¿›è¡Œå¤‡ä»½ content #ç›´æ¥æ‰¹é‡åœ¨è¢«ç®¡ç†ç«¯æ–‡ä»¶ä¸­æ·»åŠ å†…å®¹ group #å°†æœ¬åœ°æ–‡ä»¶æ¨é€åˆ°è¿œç«¯ï¼ŒæŒ‡å®šæ–‡ä»¶å±ç»„ä¿¡æ¯ owner #å°†æœ¬åœ°æ–‡ä»¶æ¨é€åˆ°è¿œç«¯ï¼ŒæŒ‡å®šæ–‡ä»¶å±ä¸»ä¿¡æ¯ mode #å°†æœ¬åœ°æ–‡ä»¶æ¨é€åˆ°è¿œç«¯ï¼ŒæŒ‡å®šæ–‡ä»¶æƒé™ä¿¡æ¯ 4.2fileæ–‡ä»¶é…ç½®æ¨¡å— [root@m01 ~]# ansible all -m file -a \"path=/tmp/abc state=diretory\" [root@m01 ~]# ansible all -m file -a \"path=/tmp/tt state=touch mode=555 owner=root group=root\" [root@m01 ~]# ansible all -m file -a \"src=/tmp/tt path=/tmp/tt_link state=link\" path #æŒ‡å®šè¿œç¨‹ä¸»æœºç›®å½•æˆ–æ–‡ä»¶ä¿¡æ¯ recurse #é€’å½’æˆæƒ state directory #åœ¨è¿œç«¯åˆ›å»ºç›®å½• touch #åœ¨è¿œç«¯åˆ›å»ºæ–‡ä»¶ link #linkæˆ–hardè¡¨ç¤ºåˆ›å»ºé“¾æ¥æ–‡ä»¶ absent #è¡¨ç¤ºåˆ é™¤æ–‡ä»¶æˆ–ç›®å½• mode #è®¾ç½®æ–‡ä»¶æˆ–ç›®å½•æƒé™ owner #è®¾ç½®æ–‡ä»¶æˆ–ç›®å½•å±ä¸»ä¿¡æ¯ group #è®¾ç½®æ–‡ä»¶æˆ–ç›®å½•å±ç»„ä¿¡æ¯ äº”ã€æœåŠ¡æ¨¡å— 5.1serviceæœåŠ¡æ¨¡å— [root@m01 ~]# ansible all -m service -a \"name=crond state=stopped enabled=yes\" name #å®šä¹‰è¦å¯åŠ¨æœåŠ¡çš„åç§° state #æŒ‡å®šæœåŠ¡çŠ¶æ€æ˜¯åœæ­¢æˆ–æ˜¯è¿è¡Œï¼Œåœæ­¢å’Œè¿è¡ŒæŒ‡ä»¤è¦å†™æˆè¿‡å»æ—¶ started #å¯åŠ¨ stopped #åœæ­¢ restarted #é‡å¯ reloaded #é‡è½½ enabled #æ˜¯å¦è®©æœåŠ¡å¼€å¯è‡ªå¯åŠ¨ å…­ã€ç”¨æˆ·å’Œç»„æ¨¡å— 6.1groupç»„æ¨¡å— [root@m01 ~]# ansible all -m group -a \"name=hehe gid=888\" name #æŒ‡å®šåˆ›å»ºçš„ç»„å gid #æŒ‡å®šç»„çš„gid state absent #ç§»é™¤è¿œç«¯ä¸»æœºçš„ç»„ present #åˆ›å»ºè¿œç«¯ä¸»æœºçš„ç»„ï¼ˆé»˜è®¤ï¼‰ 6.2userç”¨æˆ·æ¨¡å— //-123ä½¿ç”¨MD5è¿›è¡ŒåŠ å¯† -stdin éäº¤äº’å¼ -salt åŠ å¯†å‚æ•° [root@m01 ~]# echo \"bgx\" | openssl passwd -123 -stdin -salt 'salt' [root@m01 ~]# ansible all -m user -a \"name=hehe uid=888 group=888 shell=/sbin/nologin create_home=no\" [root@m01 ~]# ansible all -m user -a \"name=hehe password='$1$765yDGau$diDKPRoCIPMU6KEVEaPTZ0' \" uid #æŒ‡å®šç”¨æˆ·çš„uid group #æŒ‡å®šç”¨æˆ·ç»„åç§° groups #æŒ‡å®šé™„åŠ ç»„åç§° password #ç»™ç”¨æˆ·æ·»åŠ å¯†ç  shell #æŒ‡å®šç”¨æˆ·ç™»å½•shell create_home #æ˜¯å¦åˆ›å»ºå®¶ç›®å½• ä¸ƒã€è®¡åˆ’ä»»åŠ¡æ¨¡å— 7.1cronå®šæ—¶ä»»åŠ¡æ¨¡å— //æ­£å¸¸ä½¿ç”¨crondæœåŠ¡ [root@m01 ~]# crontab -l * * * * * /bin/sh /server/scripts/yum.sh //ä½¿ç”¨ansibleæ·»åŠ ä¸€æ¡å®šæ—¶ä»»åŠ¡ [root@m01 ~]# ansible all -m cron -a \"minute=* hour=* day=* month=* weekday=* job='/bin/sh /server/scripts/test.sh'\" [root@m01 ~]# ansible all -m cron -a \"job='/bin/sh /server/scripts/test.sh'\" //è®¾ç½®å®šæ—¶ä»»åŠ¡æ³¨é‡Šä¿¡æ¯ï¼Œé˜²æ­¢é‡å¤ï¼Œnameè®¾å®š [root@m01 ~]# ansible all -m cron -a \"name='cron01' job='/bin/sh /server/scripts/test.sh'\" //åˆ é™¤ç›¸åº”å®šæ—¶ä»»åŠ¡ [root@m01 ~]# ansible all -m cron -a \"name='ansible cron02' minute=0 hour=0 job='/bin/sh /server/scripts/test.sh' state=absent\" //æ³¨é‡Šç›¸åº”å®šæ—¶ä»»åŠ¡ï¼Œä½¿å®šæ—¶ä»»åŠ¡å¤±æ•ˆ [root@m01 scripts]# ansible all -m cron -a \"name='ansible cron01' minute=0 hour=0 job='/bin/sh /server/scripts/test.sh' disabled=no\" minute #åˆ†é’Ÿ hour #å°æ—¶ day #æ—¥æœŸ month #æœˆä»½ weekday #æ˜ŸæœŸ job #è¦æ‰§è¡Œçš„å‘½ä»¤æˆ–è„šæœ¬ name #æŒ‡å®šè®¡åˆ’ä»»åŠ¡åˆ«å disabled #æ˜¯å¦æ³¨é‡Š state absent #åˆ é™¤ å…«ã€æŒ‚è½½æ¨¡å— 8.1mountæ¨¡å— [root@m01 ~]# ansible all -m mount -a \"src=172.16.1.31:/data path=/data fstype=nfs opts=defaults state=present\" [root@m01 ~]# ansible web -m mount -a \"src=172.16.1.31:/data path=/data fstype=nfs opts=defaults state=mounted\" [root@m01 ~]# ansible web -m mount -a \"src=172.16.1.31:/data path=/data fstype=nfs opts=defaults state=unmounted\" [root@m01 ~]# ansible web -m mount -a \"src=172.16.1.31:/data path=/data fstype=nfs opts=defaults state=absent\" src #æŒ‡å®šè¦æŒ‚è½½çš„å†…å®¹ path #æœ¬åœ°æŒ‚è½½ç‚¹ fstype #æŒ‚è½½ç±»å‹ opts #æŒ‚è½½æƒé™ state present #å¼€æœºæŒ‚è½½ï¼Œä»…å°†æŒ‚è½½é…ç½®å†™å…¥/etc/fstab mounted #æŒ‚è½½è®¾å¤‡ï¼Œå¹¶å°†é…ç½®å†™å…¥/etc/fstab unmounted #å¸è½½è®¾å¤‡ï¼Œä¸ä¼šæ¸…é™¤/etc/fstabå†™å…¥çš„é…ç½® absent #å¸è½½è®¾å¤‡ï¼Œä¼šæ¸…ç†/etc/fstabå†™å…¥çš„é…ç½® ä¹ã€è§£å‹ç¼©æ¨¡å— 9.1unarchiveæ¨¡å— [root@m01 ~]# ansible all -m unarchive -a \"src=/tmp/hehe.tar.gz dest=/tmp\" [root@m01 ~]# ansible all -m unarchive -a \"src=/tmp/hehe.tar.gz dest=/tmp copy=no\" copy #é»˜è®¤ä¸ºyesï¼Œå³å…ˆåœ¨æœ¬åœ°è§£å‹ç„¶åå†ä¼ è¾“åˆ°å—æ§æœºï¼Œç­‰äºnoï¼Œè§£å‹ç¼©å—æ§æœºå‹ç¼©åŒ… creates #å½“æ–‡ä»¶å­˜åœ¨æ—¶ï¼Œä¸å†è¿›è¡Œè§£å‹ mode #æŒ‡å®šè§£å‹ç¼©æ–‡ä»¶æƒé™ list_files #æ˜¯å¦åˆ—å‡ºæ–‡ä»¶åˆ—è¡¨ï¼Œé»˜è®¤no remote_src #è¡¨ç¤ºæ–‡ä»¶å·²ç»åœ¨å—æ§æœºä¸Šï¼Œç›¸å½“äºcopy =no åã€ä¸‹è½½æ¨¡å— 10.1get_urlæ¨¡å— [root@m01 ~]# ansible all -m get_url -a \"url=xxx dest=/opt\" url #æŒ‡å®šè¦ä¸‹è½½çš„urlåœ°å€ dest #æŒ‡å®šå°†urlä¸‹è½½è‡³å“ª åä¸€ã€æ›¿æ¢æ¨¡å— 11.1 lineinfileæ¨¡å— [root@m01 ~]# ansible all -m lineinfile -a \"path=/root/hehe regexp='^user admin' line='user hehe'\" path #æ–‡ä»¶è·¯å¾„ regexp #åŒ¹é…çš„è§„åˆ™ï¼Œå³è¦æ›¿æ¢çš„å†…å®¹ line #æ›¿æ¢ä¸ºä»€ä¹ˆ state adsent #åˆ é™¤ 11.2 replaceæ¨¡å— [root@m01 ~]# ansible all -m replace -a \"path=/root/hehe regexp='^user admin' replace='hehe'\" path #æ–‡ä»¶è·¯å¾„ regexp #åŒ¹é…çš„è§„åˆ™ï¼Œå³è¦æ›¿æ¢çš„å†…å®¹ replace #æ›¿æ¢ä¸ºä»€ä¹ˆ åäºŒã€mysqlæ¨¡å— 12.1mysql_userç®¡ç†ç”¨æˆ·æ¨¡å— [root@m01 ~]# ansible mysql -m mysql_user -a 'login_host=localhost login_password=abc123 login_user=root name=abc password=abc123 priv=zabbix.*:ALL state=present' login_host #ç™»é™†ä¸»æœº login_password #ç™»é™†å¯†ç  login_user #ç™»é™†ç”¨æˆ· name #è¦åˆ›å»ºçš„ç”¨æˆ· password #åˆ›å»ºçš„ç”¨æˆ·çš„å¯†ç  priv #æˆæƒ state present #åˆ›å»º 12.2mysql_dbç®¡ç†æ•°æ®åº“æ¨¡å— [root@m01 ~]# ansible mysql -m mysql_db -a 'login_host=localhost login_password=abc123 login_user=root name=hehe state=present' login_host #ç™»é™†ä¸»æœº login_password #ç™»é™†å¯†ç  login_user #ç™»é™†ç”¨æˆ· name #è¦åˆ›å»ºçš„æ•°æ®åº“ state present #åˆ›å»º æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbixæ•…éšœ/zabbixæ•…éšœ.html":{"url":"linux/monitor/zabbix/zabbixæ•…éšœ/zabbixæ•…éšœ.html","title":"zabbixæ•…éšœè®°å½•","keywords":"","body":"zabbixæ•…éšœ zabbixæ•°æ®åº“è¿ç§»çš„ä¸€ä¸ªå°é—®é¢˜ èƒŒæ™¯ï¼š åŸå…ˆzabbix5.0æ˜¯éƒ¨ç½²åœ¨1c1gçš„åä¸ºäº‘ä¸»æœºä¸Šï¼Œä½†æ˜¯å› ä¸ºæœ‰å…¶ä»–æœåŠ¡è¿è¡Œå› æ­¤ä¼šå¯¼è‡´mysqlç»å¸¸è¢«ç³»ç»Ÿå¹²æ‰ï¼Œé€‰æ‹©æŠŠæ•°æ®åº“è¿ç§»è‡³1c4gçš„è…¾è®¯äº‘ä¸»æœºä¸Š è¿‡ç¨‹ï¼š å¯¼å‡ºzabbixåº“ï¼Œæ‹·è´è‡³è…¾è®¯äº‘ä¸»æœºç„¶åå¯¼å…¥ ä¿®æ”¹zabbix-serveré…ç½®æ–‡ä»¶/etc/zabbix/zabbix_server.confä¸­çš„DBHostä¸ºæ–°ä¸»æœºIPæˆ–åŸŸå è…¾è®¯äº‘ä¸»æœºmysqlä¸­é‡æ–°æˆæƒzabbixï¼Œå³åªå…è®¸åä¸ºäº‘ä¸»æœºè¿æ¥ é—®é¢˜ï¼š zabbixæŠ¥é”™å¦‚ä¸‹ æ’æŸ¥è¿‡ç¨‹ï¼š zabbixæœåŠ¡ç«¯æ—¥å¿—ä¸­æ²¡æœ‰æœ‰ç”¨çš„ä¿¡æ¯ åˆšå¯¼å…¥æˆåŠŸåzabbixæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä¹Ÿå¯ä»¥è·å–æ•°æ®ï¼Œä½†æ˜¯éš”äº†ä¸€æ®µæ—¶é—´æŠ¥é”™Unknown database 'zabbix'ï¼ŒåŸå› æ˜¯åœ¨åä¸ºäº‘æœºå™¨ä¸Šæ‰§è¡Œäº†åˆ é™¤zabbixæ•°æ®åº“çš„æ“ä½œï¼Œä½†æ˜¯é…ç½®æ–‡ä»¶/etc/zabbix/web/zabbix.conf.phpä¸­çš„æ•°æ®åº“æŒ‡å‘è¿˜æ˜¯æœ¬æœºï¼Œå› æ­¤ä¼šæŠ¥é”™æœªçŸ¥çš„æ•°æ®åº“ è§£å†³æ–¹æ³•ï¼š ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/zabbix/web/zabbix.conf.phpä¸­$DB['SERVER']å­—æ®µä¸­çš„localhostä¸ºæ–°mysqlä¸»æœºçš„IPæˆ–åŸŸå æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/1.CentOS7.5å®‰è£…zabbix-3.4.html":{"url":"linux/monitor/zabbix/zabbix3.4/1.CentOS7.5å®‰è£…zabbix-3.4.html","title":"zabbix3.4å®‰è£…","keywords":"","body":"CentOS7.5å®‰è£…zabbix-3.4 ä¸€ã€å®‰è£…ç¯å¢ƒ æ“ä½œç³»ç»Ÿ IPåœ°å€ åŸŸå å†…å­˜ CentOS7.5 10.0.0.200 my.zabbix.com 1G äºŒã€å®‰è£…æ­¥éª¤ zabbix3.4 ä¸­æ–‡æ‰‹å†Œåœ°å€ 2.1é…ç½®zabbixä»“åº“ [root@zabbix-server ~]# rpm -ivh https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm //å®é™…ä¸ºä¸‹è½½zabbix.repo [root@zabbix-server ~]# cat /etc/yum.repos.d/zabbix.repo [zabbix] name=Zabbix Official Repository - $basearch baseurl=http://repo.zabbix.com/zabbix/3.4/rhel/7/$basearch/ enabled=1 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591 [zabbix-non-supported] name=Zabbix Official Repository non-supported - $basearch baseurl=http://repo.zabbix.com/non-supported/rhel/7/$basearch/ enabled=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX gpgcheck=1 2.2å®‰è£…Zabbixç¨‹åºåŒ…ï¼Œä»¥åŠMySQLã€Zabbix-agent [root@zabbix-server ~]# yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent mariadb-server 2.3åˆ›å»ºZabbixæ•°æ®åº“ä»¥åŠç”¨æˆ·æˆæƒ #å¯åŠ¨mariadb [root@zabbix-server ~]# systemctl start mariadb && systemctl enable mariadb #mariadbé»˜è®¤rootç”¨æˆ·å¯†ç ä¸ºç©º [root@zabbix-server ~]# mysql -uroot -e \"create database zabbix character set utf8 collate utf8_bin;\" && mysql -uroot -e \"grant all privileges on zabbix.* to zabbix@localhost identified by 'zabbix';\" && mysql -uroot -e \"flush privileges;\" 2.4å¯¼å…¥Zabbixæ•°æ®è‡³æ•°æ®åº“ä¸­ [root@zabbix-server ~]# zcat /usr/share/doc/zabbix-server-mysql-3.4.15/create.sql.gz |mysql -uroot zabbix 2.5ç¼–è¾‘/etc/zabbix/zabbix_server.confæ–‡ä»¶ï¼Œä¿®æ”¹æ•°æ®åº“é…ç½® #ä¿®æ”¹/etc/zabbix/zabbix_server.confæ–‡ä»¶ 91è¡Œï¼Œå–æ¶ˆDBHost=localhostæ³¨é‡Š 125è¡Œï¼Œä¿®æ”¹ä¸ºDBPassword=zabbix #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ [root@zabbix-server ~]# sed -i.bak '/# DBHost=localhost/c DBHost=localhost' /etc/zabbix/zabbix_server.conf [root@zabbix-server ~]# sed -i '/# DBPassword=/c DBPassword=zabbix' /etc/zabbix/zabbix_server.conf #ä¿®æ”¹åçš„é…ç½®æ–‡ä»¶ [root@zabbix-server ~]# grep ^[a-Z] /etc/zabbix/zabbix_server.conf LogFile=/var/log/zabbix/zabbix_server.log LogFileSize=0 PidFile=/var/run/zabbix/zabbix_server.pid DBHost=localhost DBName=zabbix DBUser=zabbix DBPassword=zabbix SNMPTrapperFile=/var/log/snmptrap/snmptrap.log Timeout=4 AlertScriptsPath=/usr/lib/zabbix/alertscripts ExternalScripts=/usr/lib/zabbix/externalscripts LogSlowQueries=3000 2.6å¯åŠ¨ZabbixæœåŠ¡è¿›ç¨‹ï¼Œå¹¶åŠ å…¥å¼€æœºè‡ªå¯ [root@zabbix-server ~]# systemctl start zabbix-server && systemctl enable zabbix-server 2.7é…ç½®Apacheçš„é…ç½®æ–‡ä»¶/etc/httpd/conf.d/zabbix.confï¼Œä¿®æ”¹æ—¶åŒº #ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ [root@zabbix-server ~]# sed -i.bak '/Riga$/c php_value date.timezone Asia/Shanghai' /etc/httpd/conf.d/zabbix.conf [root@zabbix-server ~]# vim /etc/httpd/conf.d/zabbix.conf php_value max_execution_time 300 php_value memory_limit 128M php_value post_max_size 16M php_value upload_max_filesize 2M php_value max_input_time 300 php_value always_populate_raw_post_data -1 //å–æ¶ˆæ³¨é‡Šï¼Œè®¾ç½®æ­£ç¡®çš„æ—¶åŒº # php_value date.timezone Europe/Riga php_value date.timezone Asia/Shanghai 2.8æ•´åˆnginxï¼Œè®©zabbixå¯ä»¥ä»¥åŸŸåè®¿é—® å› ä¸ºæœ¬æ–‡ç”¨åˆ°äº†apacheæ¥å±•ç¤ºzabbix webç•Œé¢ï¼Œå› æ­¤è®¾ç½®apacheç›‘å¬8080ç«¯å£ï¼Œnginxç›‘å¬80ç«¯å£ #å®‰è£…nginxï¼Œæå‰ä¸Šä¼ nginxç¦»çº¿åŒ…ï¼Œä¹Ÿå¯ä»¥ç›´æ¥yumå®‰è£…nginx [root@zabbix-server ~]# ls nginx-1.14.0-1.el7_4.ngx.x86_64.rpm [root@zabbix-server ~]# rpm -ivh nginx-1.14.0-1.el7_4.ngx.x86_64.rpm #é…ç½®apacheä¸»é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹ç›‘å¬ç«¯å£ å°†Listen80ä¿®æ”¹ä¸ºListen 8080 [root@zabbix-server ~]# sed -i.bak '/Listen 80/c Listen 8080' /etc/httpd/conf/httpd.conf #é…ç½®nginxè™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶ [root@zabbix-server ~]# cat >> /etc/nginx/conf.d/my.zabbix.com.conf > /etc/nginx/proxy_params 2.9å¯åŠ¨Apache WebæœåŠ¡å™¨ [root@zabbix-server ~]# systemctl enable httpd && systemctl start httpd 2.10æµè§ˆå™¨è¾“å…¥åœ°å€my.zabbix.com/zabbixå¼€å§‹å®‰è£… ç¬¬ä¸€æ­¥ ç¬¬äºŒæ­¥ï¼Œå…¨éƒ¨ä¸ºOKæ‰å¯ä»¥ ç¬¬ä¸‰æ­¥ é…ç½®æ•°æ®åº“è¿æ¥ ç¬¬å››æ­¥ ç¬¬äº”æ­¥ï¼Œç¡®è®¤ä¿¡æ¯ ç¬¬å…­æ­¥ï¼Œå®Œæˆå®‰è£… å®Œæˆå®‰è£…åä¼šç”Ÿæˆä¸€ä¸ªé…ç½®ä¿¡æ¯æ–‡ä»¶ ç¬¬ä¸ƒæ­¥ï¼Œç™»é™† ç¬¬å…«æ­¥ï¼Œä¿®æ”¹zabbixè¯­è¨€ä¸ºä¸­æ–‡ å®Œæˆå®‰è£…åé¦–ç•Œé¢ 2.11 è§£å†³å›¾å½¢ä¸­æ–‡ä¹±ç é—®é¢˜ 2.11.1ä»windowsæ‰¾åˆ°æ¥·ä½“å­—ä½“simkaiï¼Œæœç´¢æ¥·ä½“å³å¯ windowsè·¯å¾„ cç›˜-->Windows-->Fonts macè·¯å¾„/Library/Fonts 2.11.2åœ¨zabbix-serverä¸Šå¤‡ä»½zabbixé»˜è®¤å­—ä½“å¹¶ä¸”ä¸Šä¼ æ–°å­—ä½“ [root@zabbix-server ~]# cd /usr/share/fonts/dejavu/ [root@zabbix-server dejavu]# ls DejaVuSans-BoldOblique.ttf DejaVuSansCondensed-BoldOblique.ttf DejaVuSansCondensed-Oblique.ttf DejaVuSans-ExtraLight.ttf DejaVuSans.ttf DejaVuSans-Bold.ttf DejaVuSansCondensed-Bold.ttf DejaVuSansCondensed.ttf DejaVuSans-Oblique.ttf #ç„¶åä¸Šä¼ å­—ä½“ï¼Œä¿®æ”¹åç§°ä¸ºDejaVuSans.ttf [root@zabbix-server dejavu]# mv DejaVuSans.ttf DejaVuSans.ttf.bak [root@zabbix-server dejavu]# mv simkai.ttf DejaVuSans.ttf #æ³¨æ„å­—ä½“çš„æƒé™è¦è®©zabbixç”¨æˆ·å¯ä»¥è¯» [root@zabbix-server dejavu]# ll DejaVuSans.ttf -rw-r--r-- 1 root root 19647736 Jan 13 16:29 DejaVuSans.ttf 2.11.3éªŒè¯æ•ˆæœ ç›‘æµ‹ä¸­-->å›¾å½¢ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/2.é…ç½®zabbixåŸºäºapacheã€nginxç”¨æˆ·è®¤è¯.html":{"url":"linux/monitor/zabbix/zabbix3.4/2.é…ç½®zabbixåŸºäºapacheã€nginxç”¨æˆ·è®¤è¯.html","title":"zabbixåŸºäºapacheã€nginxç”¨æˆ·è®¤è¯","keywords":"","body":"é…ç½®zabbixåŸºäºapacheã€nginxç”¨æˆ·è®¤è¯ ä¸€ã€åŸºäºapache 1.ä¿®æ”¹Apacheçš„é…ç½®æ–‡ä»¶/etc/httpd/conf/httpd.conf å¯¹éœ€è¦è®¤è¯çš„èµ„æºæ‰€åœ¨çš„ç›®å½•è¿›è¡Œé…ç½®,åœ¨æ–‡ä»¶æœ€åä¸€è¡ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ï¼Œå…¶ä¸­Allowoverride authconfigä¸€è¡Œè¡¨ç¤ºå…è®¸å¯¹/etc/zabbix/webç›®å½•ä¸‹çš„å†…å®¹è¿›è¡Œç”¨æˆ·è®¤è¯ [root@zabbix-server ~]# vim /etc/httpd/conf/httpd.conf Options Indexes FollowSymLinks Allowoverride AuthConfig Order allow,deny Allow from all 2.åœ¨é™åˆ¶è®¿é—®ç›®å½•/usr/share/zabbixä¸‹åˆ›å»ºæ–‡ä»¶.htaccessï¼Œå¹¶å†™å…¥ä»¥ä¸‹å†…å®¹ [root@zabbix-server ~]# cat > /usr/share/zabbix/.htaccess 3.åˆ›å»ºä¸€ä¸ªç”¨æˆ·åä¸ºadmin,å¯†ç ä¸º123456çš„ç™»é™†è®¤è¯ç”¨æˆ·ï¼ŒåŒæ—¶å°†å¯†ç å­˜æ”¾äº/etc/zabbix/auth_conf [root@zabbix-server ~]# yum -y install httpd-tools [root@zabbix-server ~]# htpasswd -b -c /usr/share/zabbix/auth_file admin 123456 Adding password for user admin 4.é‡å¯apacheæœåŠ¡ [root@zabbix-server ~]# systemctl restart httpd äºŒã€åŸºäºnginx 1.å®‰è£…åŒ… [root@zabbix-server ~]# yum -y install httpd-tools 2.åˆ›å»ºè®¤è¯æ–‡ä»¶ã€é…ç½®nginx è¿™é‡ŒæŒ‡å®šäº†è®¤è¯æ–‡ä»¶æ˜¯/etc/nginx/auth_fileï¼Œè®¤è¯çš„ç”¨æˆ·åæ˜¯adminï¼Œå¯†ç æ˜¯123456ï¼Œæ–‡ä»¶çš„æ‰€æœ‰è€…ä¸ºrootï¼Œæƒé™æ˜¯644 [root@zabbix-server ~]# htpasswd -b -c /etc/nginx/auth_file admin 123456 #nginxé…ç½®æ–‡ä»¶å†™å…¥auth_basicå’Œauth_basic_user_file location / { auth_basic \"Auth access down Input your Passwd!\"; auth_basic_user_file /etc/nginx/auth_file; } æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/3.zabbix3.4ç›‘æ§ä¸€å°ä¸»æœº.html":{"url":"linux/monitor/zabbix/zabbix3.4/3.zabbix3.4ç›‘æ§ä¸€å°ä¸»æœº.html","title":"zabbix3.4ç›‘æ§ä¸€å°ä¸»æœº","keywords":"","body":"zabbix3.4ç›‘æ§ä¸€å°ä¸»æœº zabbix-serverIPåœ°å€ï¼š10.0.0.200 1.å®‰è£…zabbix-agent [root@test1 ~]# rpm -ivh https://mirrors4.tuna.tsinghua.edu.cn/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.15-1.el7.x86_64.rpm 2.é…ç½®zabbix-agent #æŒ‡å®šzabbix-serveråœ°å€ [root@test1 ~]# sed -i.bak 's/Server=127.0.0.1/Server=10.0.0.200/' /etc/zabbix/zabbix_agentd.conf 3.å¯åŠ¨zabbix-agent #å¯åŠ¨zabbix-agentå¹¶è®¾ç½®å¼€æœºè‡ªèµ· [root@test1 ~]# systemctl start zabbix-agent && systemctl enable zabbix-agent #æ£€æµ‹ç«¯å£ netstat -ntpl|grep 10050tcp 0 0 0.0.0.0:10050 0.0.0.0:* LISTEN 5220/zabbix_agentd tcp6 0 0 :::10050 :::* LISTEN 5220/zabbix_agentd 4.åœ¨zabbix-serverç«¯webç•Œé¢ï¼Œç‚¹å‡»é…ç½®-->ä¸»æœº-->åˆ›å»ºä¸»æœº 5.ç‚¹å‡»é…ç½®-->ä¸»æœº-->æ¨¡æ¿-->é“¾æ¥æŒ‡ç¤ºå™¨ æ·»åŠ åçš„ä¸»æœº æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/4.zabbix3.4åˆ›å»ºè‡ªå®šä¹‰è§¦å‘å™¨.html":{"url":"linux/monitor/zabbix/zabbix3.4/4.zabbix3.4åˆ›å»ºè‡ªå®šä¹‰è§¦å‘å™¨.html","title":"zabbix3.4åˆ›å»ºè‡ªå®šä¹‰è§¦å‘å™¨","keywords":"","body":"zabbix3.4åˆ›å»ºè‡ªå®šä¹‰è§¦å‘å™¨ è§¦å‘å™¨ï¼štrigger å½“ç›‘æ§é¡¹è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œäº§ç”Ÿå‘Šè­¦ ç¬¬ä¸€æ­¥ï¼Œé…ç½®-->ä¸»æœº-->ä¸»æœºåˆ—è¡¨å¤„çš„è§¦å‘å™¨-->åˆ›å»ºè§¦å‘å™¨ ç¬¬äºŒæ­¥ï¼Œæ·»åŠ è¡¨è¾¾å¼ ç¬¬ä¸‰æ­¥ï¼Œæ·»åŠ è¡¨è¾¾å¼åæµ‹è¯•è¡¨è¾¾å¼ ç¬¬å››æ­¥ï¼ŒæŸ¥çœ‹è§¦å‘å™¨åˆ—è¡¨ä¸­åˆšæ·»åŠ çš„è§¦å‘å™¨ ç¬¬äº”æ­¥ï¼ŒæŸ¥çœ‹ç›‘æ§é¡¹ä¸­åˆšæ·»åŠ çš„è§¦å‘å™¨ é…ç½®-->ä¸»æœº-->ä¸»æœºåˆ—è¡¨ä¸­çš„ä¸»æœº-->ç›‘æ§é¡¹ ç¬¬å…­æ­¥ï¼Œå¼€å¯zabbixç›‘æ§é¢æ¿å‘Šè­¦å£°éŸ³ å³ä¸Šè§’-->å°äººå¤´-->æ­£åœ¨å‘é€æ¶ˆæ¯-->å‹¾é€‰è¦æ¥å—çš„å‘Šè­¦ ç¬¬ä¸ƒæ­¥ï¼ŒæŸ¥çœ‹zabbixç›‘æ§é¦–é¡µ åœ¨ç”¨ä¸€ä¸ªç»ˆç«¯ç™»é™†zabbix-agentä¸»æœºï¼Œæ­¤æ—¶rootç™»é™†æ•°ä¸º2ï¼Œå°±ä¼šè§¦å‘å‘Šè­¦ ç¬¬å…«æ­¥ï¼ŒæŸ¥çœ‹é”®å€¼ æ·»åŠ å®Œæˆåï¼Œå¯ä»¥åœ¨zabbix-serverç«¯è·å–ç›‘æ§é¡¹çš„å€¼ é…ç½®-->ä¸»æœº-->ä¸»æœºåˆ—è¡¨-->ç›‘æ§é¡¹-->é”®å€¼ zabbix-serverç«¯å–å€¼ #zabbix-serverç«¯å®‰è£…zabbix-getåŒ… [root@zabbix-server ~]# yum -y install zabbix-get #å¯¹agentç«¯å–é”®å€¼ï¼Œç»“æœä¸º2è¡¨æ˜rootç”¨æˆ·ç™»é™†æ•°ä¸º2 [root@zabbix-server ~]# zabbix_get -s 10.0.0.10 -k system.users.num 2 -s æŒ‡å®šagentç«¯IPåœ°å€ -k é”®å€¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/5.zabbix3.4è‡ªå®šä¹‰ç›‘æ§é¡¹.html":{"url":"linux/monitor/zabbix/zabbix3.4/5.zabbix3.4è‡ªå®šä¹‰ç›‘æ§é¡¹.html","title":"zabbix3.4è‡ªå®šä¹‰ç›‘æ§é¡¹","keywords":"","body":"zabbix3.4è‡ªå®šä¹‰ç›‘æ§é¡¹ ä¸€ã€å®éªŒç¯å¢ƒ æœåŠ¡å™¨è§’è‰² ip ä¸»æœºå zabbix-server 10.0.0.200 zabbix-server zabbix-agent 10.0.0.10 test1 äºŒã€zabbixè‡ªå®šä¹‰ç›‘æ§é¡¹æ•´ä½“è¿‡ç¨‹ 2.1åœ¨å¯¹åº”çš„agentä¸»æœºä¸Šç¼–å†™è‡ªå®šä¹‰ç›‘æ§TCPçš„11ç§çŠ¶æ€ï¼ˆåœ¨agentæœ¬åœ°è¿›è¡Œå–å€¼ï¼‰ #è¿›åˆ°/etc/zabbix/zabbix_agentd.d [root@test1 zabbix_agentd.d]# pwd /etc/zabbix/zabbix_agentd.d #ç¼–å†™è‡ªå®šä¹‰å–å€¼æ–‡ä»¶ [root@test1 zabbix_agentd.d]# cat > tcp_state.conf 2.2åœ¨serverä¸Šä½¿ç”¨zabbix_getè·å–å¯¹åº”ä¸»æœºçš„å€¼ [root@test1 zabbix-server]# zabbix_get -s 10.0.0.10 -k tcp_state[estb] 2.3åœ¨webç•Œé¢æ·»åŠ  ç›‘æ§é¡¹ å°†ç›‘æ§é¡¹åˆ¶ä½œäº†ä¸€ä¸ªå›¾å½¢ å°†ä¸»æœºå…³è”è¯¥ TCPçŠ¶æ€çš„æ¨¡æ¿ ä¸‰ã€åˆ›å»ºzabbixè‡ªå®šä¹‰ç›‘æ§é¡¹ 3.1è‡ªå®šä¹‰ç›‘æ§tcp11ç§çŠ¶æ€(ä¼ å‚æ–¹å¼ï¼Œåœ¨æœ¬åœ°å–å€¼) //åˆ›å»ºè‡ªå®šä¹‰ç›‘æ§é¡¹æ–‡ä»¶ [root@test ~]# cd /etc/zabbix/zabbix_agentd.d/ [root@test ~]# cat > tcp_state.conf 3.2åœ¨zabbix-webç«¯å…ˆåˆ›å»ºæ¨¡æ¿ é…ç½®-->æ¨¡æ¿-->åˆ›å»ºæ¨¡æ¿ æ·»åŠ æ¨¡æ¿åå¯ä»¥åœ¨é…ç½®-->æ¨¡æ¿ä¸­çœ‹åˆ°åˆšæ–°å»ºçš„æ¨¡æ¿ 3.3ç‚¹å‡»åˆ›å»ºçš„æ¨¡æ¿ä¸­çš„ç›‘æ§é¡¹ï¼Œä¸è¦ç‚¹ä¸»æœºä¸­çš„ç›‘æ§é¡¹ï¼Œç„¶åç‚¹å‡»åˆ›å»ºç›‘æ§é¡¹ ç‚¹å‡»æ·»åŠ åå°±å¯ä»¥çœ‹åˆ°åˆšåˆ›å»ºçš„ç›‘æ§é¡¹ 3.4åˆ©ç”¨å…‹éš†å¿«é€Ÿæ·»åŠ ç›‘æ§é¡¹ ç‚¹å‡»åˆšåˆ›å»ºçš„ç›‘æ§é¡¹ ç‚¹å‡»å…‹éš† ç„¶åå¡«å†™ä¿¡æ¯ï¼Œå†ç‚¹å‡»æœ€ä¸‹æ–¹æ·»åŠ  å…¶ä½™tcpçŠ¶æ€ä¾ç…§å…‹éš†æ–¹æ³•ä¾æ¬¡æ·»åŠ  tcp12ç§çŠ¶æ€ï¼Œtcp_state.conf ä¸ºåœ¨agentç«¯ /etc/zabbix/zabbix_agentd.d è·¯å¾„ä¸‹åˆ›å»ºçš„æ–‡ä»¶ä¸­è‡ªå®šä¹‰çš„ [root@test1 zabbix_agentd.d]# cat tcp_state.conf UserParameter=tcp_state[*],ss -an|awk '{print $2}'|grep -i \"$1\"|wc -l tcp_state[ESTABLISHED] tcp_state[SYN-SENT] tcp_state[SYN-RECV] tcp_state[FIN-WAIT1] tcp_state[FIN-WAIT2] tcp_state[TIME-WAIT] tcp_state[CLOSE] tcp_state[CLOSE-WAIT] tcp_state[LAST-ACK] tcp_state[LISTEN] tcp_state[CLOSING] tcp_state[UNKNOWN] åœ¨é…ç½®-->æ¨¡æ¿ä¸­å¯ä»¥çœ‹æ–°å»ºçš„æ¨¡æ¿çš„ä¿¡æ¯ï¼Œæ­¤æ—¶çš„æ¨¡æ¿æ˜¯æ–°å»ºçš„ï¼Œä¸ä¸»æœºæ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œé™¤éä¸»æœºé“¾æ¥è¿™ä¸ªæ¨¡æ¿ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰åˆšåˆ›å»ºçš„12é¡¹ç›‘æ§é¡¹ï¼Œä½†æ˜¯æ²¡æœ‰å›¾å½¢ï¼Œéœ€è¦æ‰‹åŠ¨å†åˆ›å»ºå›¾å½¢ 3.5åˆ›å»ºå›¾å½¢ é…ç½®-->æ¨¡æ¿-->åˆ›å»ºçš„æ¨¡æ¿(è¿™é‡Œä¸ºLinux TCP Status)-->å›¾å½¢-->åˆ›å»ºå›¾å½¢ æ·»åŠ åçš„å›¾å½¢ é…ç½®-->æ¨¡æ¿-->æ–°å»ºçš„æ¨¡æ¿ å¯ä»¥çœ‹åˆ°åˆšåˆ›å»ºçš„å›¾å½¢ é…ç½®-->ä¸»æœº-->æ¨¡æ¿ æŸ¥çœ‹å›¾å½¢ï¼Œç›‘æµ‹ä¸­-->æœ€æ–°æ•°æ® æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/6.zabbix3.4è‡ªå®šä¹‰å‘Šè­¦å†…å®¹.html":{"url":"linux/monitor/zabbix/zabbix3.4/6.zabbix3.4è‡ªå®šä¹‰å‘Šè­¦å†…å®¹.html","title":"zabbix3.4è‡ªå®šä¹‰å‘Šè­¦å†…å®¹","keywords":"","body":"zabbix3.4è‡ªå®šä¹‰å‘Šè­¦å†…å®¹ 1.å¯åŠ¨é»˜è®¤å‘Šè­¦é¡¹ é…ç½®-->åŠ¨ä½œ 2.ä¿®æ”¹å‘Šè­¦å†…å®¹ é»˜è®¤å‘Šè­¦ä¿¡æ¯ #å‘Šè­¦æ ‡é¢˜ Problem: {TRIGGER.NAME} #å‘Šè­¦å†…å®¹ Problem started at {EVENT.TIME} on {EVENT.DATE} Problem name: {TRIGGER.NAME} Host: {HOST.NAME} Severity: {TRIGGER.SEVERITY} Original problem ID: {EVENT.ID} {TRIGGER.URL} ä¿®æ”¹å‘Šè­¦é»˜è®¤æ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME} æ•…éšœ! ä¿®æ”¹å‘Šè­¦å†…å®¹å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME} æ•…éšœ! { å‘Šè­¦ä¸»æœº:{HOST.NAME} å‘Šè­¦åœ°å€:{HOST.IP} ç›‘æ§é¡¹ç›®:{ITEM.NAME} ç›‘æ§å–å€¼:{ITEM.LASTVALUE} å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY} å½“å‰çŠ¶æ€:{TRIGGER.STATUS} å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME} å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME} äº‹ä»¶ID:{EVENT.ID} } 3.ä¿®æ”¹æ¢å¤å†…å®¹ é»˜è®¤æ¢å¤ä¿¡æ¯ #æ¢å¤æ ‡é¢˜ Resolved: {TRIGGER.NAME} #æ¢å¤å†…å®¹ Problem has been resolved at {EVENT.RECOVERY.TIME} on {EVENT.RECOVERY.DATE} Problem name: {TRIGGER.NAME} Host: {HOST.NAME} Severity: {TRIGGER.SEVERITY} Original problem ID: {EVENT.ID} {TRIGGER.URL} ä¿®æ”¹æ¢å¤ä¿¡æ¯æ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME} å·²æ¢å¤! ä¿®æ”¹æ¢å¤ä¿¡æ¯å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME} å·²æ¢å¤! { å‘Šè­¦ä¸»æœº:{HOST.NAME} å‘Šè­¦åœ°å€:{HOST.IP} ç›‘æ§é¡¹ç›®:{ITEM.NAME} ç›‘æ§å–å€¼:{ITEM.LASTVALUE} å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY} å½“å‰çŠ¶æ€:{TRIGGER.STATUS} å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME} å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME} æ¢å¤æ—¶é—´:{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME} æŒç»­æ—¶é—´:{EVENT.AGE} äº‹ä»¶ID:{EVENT.ID} } 4.ä¿®æ”¹ç¡®è®¤æ“ä½œ é»˜è®¤ç¡®è®¤ä¿¡æ¯ #ç¡®è®¤æ ‡é¢˜ Acknowledged: {TRIGGER.NAME} #ç¡®è®¤å†…å®¹ {USER.FULLNAME} acknowledged problem at {ACK.DATE} {ACK.TIME} with the following message: {ACK.MESSAGE} Current problem status is {EVENT.STATUS} ä¿®æ”¹ç¡®è®¤æ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤ ä¿®æ”¹ç¡®è®¤å†…å®¹å¦‚ä¸‹ { ç¡®è®¤äºº:{USER.FULLNAME} æ—¶é—´:{ACK.DATE} {ACK.TIME} ç¡®è®¤ä¿¡æ¯å¦‚ä¸‹: \"{ACK.MESSAGE}\" é—®é¢˜æœåŠ¡å™¨IP:{HOSTNAME1} é—®é¢˜ID:{EVENT.ID} å½“å‰çš„é—®é¢˜æ˜¯: {TRIGGER.NAME} } ä¿®æ”¹å®Œåç‚¹å‡»æ›´æ–° æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/7.zabbix3.4é…ç½®è§¦å‘zabbix-agentç«¯shellè„šæœ¬ã€å‘½ä»¤.html":{"url":"linux/monitor/zabbix/zabbix3.4/7.zabbix3.4é…ç½®è§¦å‘zabbix-agentç«¯shellè„šæœ¬ã€å‘½ä»¤.html","title":"zabbix3.4é…ç½®è§¦å‘zabbix-agentç«¯shellè„šæœ¬ã€å‘½ä»¤","keywords":"","body":"zabbix3.4é…ç½®è§¦å‘zabbix-agentç«¯shellè„šæœ¬ã€å‘½ä»¤ ä¸€ã€è¯´æ˜ 1.zabbix-serverç«¯é…ç½®äº†è§¦å‘å™¨ï¼Œå¦‚æœç›‘æ§é¡¹çš„é˜€å€¼è¾¾åˆ°è§¦å‘å™¨çš„å€¼ï¼Œä¼šå‘å‡ºå‘Šè­¦ä¿¡æ¯ã€‚æˆ‘ä»¬è¿˜æƒ³å¢åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œå¦‚ç£ç›˜ä½¿ç”¨ç©ºé—´è¾¾åˆ°80%é˜€å€¼çš„æ—¶å€™ï¼Œè§¦å‘ä¸€ä¸ªè‡ªåŠ¨æ¸…ç†ç£ç›˜ç©ºé—´çš„è„šæœ¬ï¼Œè¾¾åˆ°æ‰€è°“çš„â€œè‡ªæ„ˆâ€åŠŸèƒ½ 2.è¦é…ç½®å¥½ç›‘æ§é¡¹ã€è§¦å‘å™¨ï¼Œè¦ç¡®ä¿è§¦å‘å™¨åœ¨ç›‘æ§é¡¹è¾¾åˆ°è®¾ç½®çš„é˜€å€¼çš„æ—¶å€™èƒ½æ­£å¸¸è§¦å‘ï¼Œè¿™ä¸ªæ˜¯å®ç°è§¦å‘zabbix-agentè„šæœ¬ä»»åŠ¡æ‰§è¡Œçš„å‰æï¼Œæ­¤å¤„ä»¥ç£ç›˜å¯ç”¨ç©ºé—´ä½äº30%ä¸ºä¾‹ äºŒã€æ‰§è¡Œæ­¥éª¤ 2.1zabbix-agentç«¯å¼€å¯å…è®¸è¿œç¨‹æ‰§è¡Œå‘½ä»¤ //zabbix-agentç«¯ç¼–è¾‘é…ç½®æ–‡ä»¶/etc/zabbix/zabbix_agentd.confç¬¬73è¡Œï¼Œå–æ¶ˆ# EnableRemoteCommands=0æ³¨é‡Šï¼Œå¹¶æŠŠå€¼ä¿®æ”¹ä¸º1 EnableRemoteCommands=0 ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ [root@zabbix-agent ~]# sed -i.bak '/# EnableRemoteCommands=0/a EnableRemoteCommands=1' /etc/zabbix/zabbix_agentd.conf //é‡å¯zabbix-agent [root@zabbix-agent ~]# systemctl restart zabbix-agent 2.2åœ¨zabbix-agentç«¯ç¼–å†™è„šæœ¬ï¼Œäº¤ç»™è§¦å‘å™¨è§¦å‘æ—¶æ‰§è¡Œ //åˆ›å»ºå­˜æ”¾è„šæœ¬ç›®å½•ï¼Œåœ¨zabbix-serverç«¯é…ç½®è§¦å‘è„šæœ¬æ—¶è¦å†™è„šæœ¬çš„ç»å¯¹è·¯å¾„ [root@zabbix-agent ~]# mkdir /etc/zabbix/scripts //ç¼–å†™è„šæœ¬,æ­¤å¤„ä»…ä»…æ˜¯ä¸ºäº†æ¼”ç¤ºè§¦å‘æ•ˆæœ [root@zabbix-agent ~]# mkdir /etc/zabbix/scripts [root@zabbix-agent ~]# cat >/etc/zabbix/scripts/test.sh > /tmp/test.txt EOF 2.3åœ¨zabbix-agentç«¯å°†zabbixç”¨æˆ·åŠ å…¥åˆ°sudoä¸­ visudoç¼–è¾‘æ–‡ä»¶ï¼Œåœ¨93è¡Œæ–°åŠ å…¥abbix ALL=(ALL) NOPASSWD: ALL vidusoç¼–è¾‘æ–‡ä»¶ï¼Œæ³¨é‡Š53è¡ŒDefaults !visiblepw //ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ [root@zabbix-agent ~]# sed -i.bak '/^root/a zabbix ALL=(ALL) NOPASSWD: ALL' /etc/sudoers && sed -i '/Defaults !visiblepw/c#Defaults !visiblepw' /etc/sudoers 2.4zabbix-serveråˆ›å»ºåŠ¨ä½œï¼Œå¹¶æŒ‡å®šåªè®©æŸä¸ªä¸»æœºç»„æ‰§è¡Œå‘½ä»¤ é…ç½®-->åŠ¨ä½œ-->åˆ›å»ºåŠ¨ä½œ æ“ä½œ-->æ–°çš„ è¿›è¡Œç›¸å…³é…ç½® åœ¨zabbix-agentç«¯åšå¦‚ä¸‹æ“ä½œ #åˆ›å»ºä¸€ä¸ª8Gçš„å¤§æ–‡ä»¶è®©ç³»ç»Ÿç£ç›˜ä½¿ç”¨ç‡å¤§äº80%ï¼Œè¿™æ ·å°±ä¼šè§¦å‘å‘Šè­¦ï¼Œä»è€Œæ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„è„šæœ¬ dd if=/dev/zero of=/opt/bigfile bs=1M count=8192 #ç­‰å¾…serverç«¯webç•Œé¢å‘Šè­¦åï¼Œå°±ä¼šåœ¨æˆ‘ä»¬è‡ªå®šçš„è„šæœ¬ä¸­è®¾å®šçš„è·¯å¾„/tmpä¸‹åˆ›å»ºä¸€ä¸ªtest.txtæ–‡ä»¶ cat /tmp/test.txt 2018-01-10-22:28:13ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡80% æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/8.zabbix3.4è®¾ç½®é‚®ä»¶å‘Šè­¦.html":{"url":"linux/monitor/zabbix/zabbix3.4/8.zabbix3.4è®¾ç½®é‚®ä»¶å‘Šè­¦.html","title":"zabbix3.4è®¾ç½®é‚®ä»¶å‘Šè­¦","keywords":"","body":"zabbix3.4è®¾ç½®é‚®ä»¶å‘Šè­¦ ç¬¬ä¸€æ­¥ã€é…ç½®-->åŠ¨ä½œ-->å¯ç”¨åŠ¨ä½œ ç¬¬äºŒæ­¥ã€ç®¡ç†-->æŠ¥è­¦åª’ä»‹ç±»å‹-->é€‰æ‹©Email ç¬¬ä¸‰æ­¥ã€è®¾ç½®æœåŠ¡å™¨å‘ä»¶äººï¼Œä½¿ç”¨é‚®ç®±è´¦æˆ·å’Œæˆæƒå¯†ç ï¼Œæˆæƒå¯†ç åœ¨qqé‚®ç®±å®˜ç½‘ä¸­è®¾ç½® ç¬¬å››æ­¥ã€è®¾ç½®æ”¶ä»¶äººé‚®ç®±ï¼Œå³ä¸Šè§’å°äººå¤´-->æŠ¥è­¦åª’ä»‹--æ·»åŠ  ç¬¬äº”æ­¥ã€æ”¶ä»¶äººç±»å‹é€‰æ‹©Emailï¼Œå¡«å†™æ”¶ä»¶äººé‚®ç®±ï¼Œæ¥å—æŠ¥è­¦çº§åˆ«ï¼Œæ·»åŠ  ç¬¬å…­æ­¥ã€ç¡®è®¤æ²¡æœ‰é—®é¢˜ï¼Œç‚¹å‡»æ›´æ–° ç¬¬ä¸ƒæ­¥ã€éªŒè¯æ˜¯å¦å‘é€é‚®ä»¶ ç¬¬å…«æ­¥ã€qqé‚®ç®±æŸ¥çœ‹é‚®ä»¶ é‚®ä»¶å‘é€å¤±è´¥ å‘é€é‚®ä»¶å¤±è´¥åŸå› 1ï¼šqqé‚®ç®±æœåŠ¡å™¨åœ°å€å†™é”™ï¼Œæ­£ç¡®ä¸ºsmtp.qq.comï¼Œè€Œä¸æ˜¯mail.qq.com å‘é€é‚®ä»¶å¤±è´¥åŸå› 2ï¼šå¡«å†™å‘ä»¶äººä¿¡æ¯åæ²¡æœ‰ä¿å­˜ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/9.zabbix3.4è®¾ç½®é‚®ä»¶å‘Šè­¦å‡çº§.html":{"url":"linux/monitor/zabbix/zabbix3.4/9.zabbix3.4è®¾ç½®é‚®ä»¶å‘Šè­¦å‡çº§.html","title":"zabbix3.4è®¾ç½®é‚®ä»¶å‘Šè­¦å‡çº§","keywords":"","body":"zabbix3.4è®¾ç½®é‚®ä»¶å‘Šè­¦å‡çº§ ä¸€ã€é‚®ä»¶å‘Šè­¦å‡çº§è¿‡ç¨‹ è¿™é‡Œä»…ä½œç¤ºä¾‹ 1.é¦–å…ˆå‘ç»™è¿ç»´ç»„ï¼ŒæŒç»­10åˆ†é’Ÿ 2.è¿ç»´ç»„æ²¡æœ‰è§£å†³ï¼Œå‘ç»™ç»ç†ç»„ï¼ŒæŒç»­10åˆ†é’Ÿ 3.ç»ç†ç»„æ²¡æœ‰è§£å†³ï¼Œå‘ç»™æ€»ç›‘ç»„ äºŒã€é‚®ä»¶å‘Šè­¦å‡çº§è¿‡ç¨‹é…ç½® 2.1é…ç½®-->åŠ¨ä½œ-->é€‰æ‹©åŠ¨ä½œ(è¿™é‡Œé€‰æ‹©é»˜è®¤) 2.2æ“ä½œ-->ç‚¹å‡» æ–°çš„ 2.3å¡«å†™ç¬¬ä¸€æ­¥å‘é€è®¾ç½® 2.4å¡«å†™ç¬¬äºŒæ­¥å‘é€è®¾ç½® 2.5å¡«å†™ç¬¬ä¸‰æ­¥å‘é€è®¾ç½® 2.6æ·»åŠ å®Œæˆåé¡µé¢ æ“ä½œæ­¥éª¤å†™1-2ï¼Œ2-3ï¼Œ3-4 1-2ï¼Œ3-4ï¼Œ5-6éƒ½å¯ä»¥ 2.7æ·»åŠ å®Œæˆååœ¨ç›¸åº”ç”¨æˆ·å¡«å†™æ”¶ä»¶åœ°å€å³å¯ï¼Œç®¡ç†-->ç”¨æˆ·--æŠ¥è­¦åª’ä»‹ 2.8ç»™åˆ›å»ºçš„ç”¨æˆ·ç¾¤ç»„èµ‹äºˆè¯»å†™æƒé™ ç®¡ç†-->ç”¨æˆ·ç¾¤ç»„-->é€‰æ‹©åˆ›å»ºçš„ç”¨æˆ·ç¾¤ç»„-->æƒé™ 2.9éªŒè¯ ç»è¿‡æµ‹è¯• 1.ç®¡ç†å‘˜å³è¿ç»´ç»„å…ˆæ”¶åˆ°å‘Šè­¦ï¼Œå¯¹åº”ä¸‹å›¾ä¸­é—®é¢˜ä¸‹æ–¹1 2.è§„å®šæ—¶é—´æ²¡æœ‰å®Œæˆå‘é€ç»™ç»ç†ç»„ï¼Œå¯¹åº”ä¸‹å›¾ä¸­é—®é¢˜ä¸‹æ–¹2 3.ç»ç†ç»„åœ¨è§„å®šæ—¶é—´å†…æ²¡æœ‰å®Œæˆå¤„ç†å‘é€ç»™æ€»ç›‘ç»„ï¼Œå¯¹åº”ä¸‹å›¾ä¸­é—®é¢˜ä¸‹æ–¹3ï¼Œåº”ä¸ºæœ¬æ–‡ä¸­è®¾ç½®æ€»ç›‘æ¥å—1åˆ†é’Ÿï¼Œå› æ­¤æ€»ç›‘åªæ¥å—ä¸€æ¬¡ 4.å¦‚æœæ¢å¤ï¼Œè¿ç»´ç»„ã€ç»ç†ç»„ã€æ€»ç›‘ç»„éƒ½ä¼šæ”¶åˆ°æ¢å¤ä¿¡æ¯ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/10.zabbix3.4ä½¿ç”¨ä¼ä¸šå¾®ä¿¡å‘Šè­¦.html":{"url":"linux/monitor/zabbix/zabbix3.4/10.zabbix3.4ä½¿ç”¨ä¼ä¸šå¾®ä¿¡å‘Šè­¦.html","title":"zabbix3.4ä½¿ç”¨ä¼ä¸šå¾®ä¿¡å‘Šè­¦","keywords":"","body":"zabbix3.4ä½¿ç”¨ä¼ä¸šå¾®ä¿¡å‘Šè­¦ ç¬¬ä¸€æ­¥ã€æ³¨å†Œä¼ä¸šå¾®ä¿¡ï¼Œä¸ªäººå°±å¯ä»¥æ³¨å†Œï¼Œç„¶åæŒ‰ç…§æç¤ºå¡«å†™ç›¸å…³ä¿¡æ¯ ä¼ä¸šå¾®ä¿¡æ³¨å†Œåœ°å€ ç¬¬äºŒæ­¥ã€ç™»é™†ä¼ä¸šå¾®ä¿¡ ä¼ä¸šå¾®ä¿¡é¦–ç•Œé¢ åº”ç”¨ä¸å°ç¨‹åº-->åˆ›å»ºåº”ç”¨ï¼Œæ ¹æ®æç¤ºå¡«å†™ç›¸å…³ä¿¡æ¯ï¼Œè¿™é‡Œå·²ç»åˆ›å»ºå¥½äº†ä¸€ä¸ªzabbixç›‘æ§ ç‚¹å‡»åˆ›å»ºçš„åº”ç”¨ï¼Œåç»­pythonè„šæœ¬ä¼šç”¨åˆ°Agentldå’ŒSecret ç‚¹å‡»æˆ‘çš„ä¼ä¸šï¼Œåç»­pythonè„šæœ¬ä¼šç”¨åˆ°ä¼ä¸šID ç¬¬ä¸‰æ­¥ã€zabbix-serverç«¯é…ç½®pythonè„šæœ¬ 3.1ç¯å¢ƒå‡†å¤‡ #å®‰è£…ä¾èµ–åŒ… [root@zabbix-server ~]# yum -y install python-pip [root@zabbix-server ~]# pip install requests [root@zabbix-server ~]# cd /usr/lib/zabbix/alertscripts [root@zabbix-server alertscripts]# ls weixin.py #ç»™è„šæœ¬èµ‹äºˆæ‰§è¡Œæƒé™ [root@zabbix-server alertscripts]# chmod +x weixin.py #ä¸€å®šè¦ä¿®æ”¹/tmp/weixin.logè¿™ä¸ªæ–‡ä»¶çš„æƒé™ä¸ºzabbixï¼Œå› ä¸ºzabbixç¨‹åºåœ¨æ‰§è¡Œweixin.pyçš„æ—¶å€™æ˜¯ä»¥zabbixç”¨æˆ·æ‰§è¡Œçš„ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶é»˜è®¤æ˜¯rootï¼Œä¸ä¿®æ”¹æƒé™ä¼šæŠ¥é”™ [root@zabbix-server alertscripts]# chown zabbix.zabbix /tmp/weixin.log 3.2ç¼–å†™å¾®ä¿¡å‘Šè­¦è„šæœ¬ [root@zabbix-server alertscripts]# pwd /usr/lib/zabbix/alertscripts [root@zabbix-server alertscripts]# cat >weixin.py æˆå‘˜ä¿¡æ¯ä¸­æŸ¥çœ‹ [root@zabbix-server alertscripts]# ./weixin.py ä¼ä¸šå¾®ä¿¡å· test test ä¼ä¸šå¾®ä¿¡æ”¶åˆ°ä¿¡æ¯å³ä¸ºæ­£ç¡® ç¬¬å››æ­¥ã€zabbix-serverç«¯é…ç½® 4.1ç®¡ç†-->æŠ¥è­¦åª’ä»‹ç±»å‹-->åˆ›å»ºåª’ä½“ç±»å‹ 4.2å¡«å†™ç›¸å…³ä¿¡æ¯ è„šæœ¬åç§°ä¸ºè‡ªå·±å®šä¹‰çš„weixin.pyï¼Œè·¯å¾„ä¸ºåœ¨zabbix-serverç«¯/etc/zabbix/zabbix_server.confä¸­å®šä¹‰ AlertScriptsPath=/usr/lib/zabbix/alertscripts åœ¨ä¸‹å›¾ä¸­è„šæœ¬å‚æ•°çš„åœ°æ–¹å†™å…¥ä»¥ä¸‹3ä¸ªå‚æ•°ï¼Œæ³¨æ„è„šæœ¬å‚æ•°ä¸€å®šè¦å¡«å†™æ­£ç¡® {ALERT.SENDTO} {ALERT.SUBJECT} {ALERT.MESSAGE} 4.3è®¾ç½®æ”¶ä»¶äºº å³ä¸Šè§’å°äººå¤´-->æŠ¥è­¦åª’ä»‹-->æ·»åŠ  ç¬¬äº”æ­¥ã€ä¿®æ”¹å‘Šè­¦ç›¸å…³ä¿¡æ¯ 5.1ä¿®æ”¹å‘Šè­¦æ“ä½œ ä¿®æ”¹æ“ä½œæ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME} æ•…éšœ! ä¿®æ”¹æ¶ˆæ¯å†…å®¹å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME} æ•…éšœ! { å‘Šè­¦ä¸»æœº:{HOST.NAME} å‘Šè­¦åœ°å€:{HOST.IP} ç›‘æ§é¡¹ç›®:{ITEM.NAME} ç›‘æ§å–å€¼:{ITEM.LASTVALUE} å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY} å½“å‰çŠ¶æ€:{TRIGGER.STATUS} å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME} å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME} äº‹ä»¶ID:{EVENT.ID} } 5.2ä¿®æ”¹æ¢å¤æ“ä½œ ä¿®æ”¹æ¢å¤æ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME} å·²æ¢å¤! ä¿®æ”¹æ¢å¤å†…å®¹å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME} å·²æ¢å¤! { å‘Šè­¦ä¸»æœº:{HOST.NAME} å‘Šè­¦åœ°å€:{HOST.IP} ç›‘æ§é¡¹ç›®:{ITEM.NAME} ç›‘æ§å–å€¼:{ITEM.LASTVALUE} å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY} å½“å‰çŠ¶æ€:{TRIGGER.STATUS} å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME} å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME} æ¢å¤æ—¶é—´:{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME} æŒç»­æ—¶é—´:{EVENT.AGE} äº‹ä»¶ID:{EVENT.ID} } 5.3ä¿®æ”¹ç¡®è®¤ä¿¡æ¯ ä¿®æ”¹ç¡®è®¤æ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤ ä¿®æ”¹ç¡®è®¤å†…å®¹å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤ { ç¡®è®¤äºº:{USER.FULLNAME} æ—¶é—´:{ACK.DATE} {ACK.TIME} ç¡®è®¤ä¿¡æ¯å¦‚ä¸‹: \"{ACK.MESSAGE}\" é—®é¢˜æœåŠ¡å™¨IP:{HOSTNAME1} é—®é¢˜ID:{EVENT.ID} å½“å‰çš„é—®é¢˜æ˜¯: {TRIGGER.NAME} } ç¬¬å…­æ­¥ã€éªŒè¯ ä¼ä¸šå¾®ä¿¡ä¸­åˆ›å»ºçš„zabbixç›‘æ§åº”ç”¨èƒ½æ”¶åˆ°ä¿¡æ¯å³ä¸ºæ­£ç¡® pcç«¯ä¼ä¸šå¾®ä¿¡ æ‰‹æœºç«¯ä¼ä¸šå¾®ä¿¡ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix3.4/11.zabbix3.4ä½¿ç”¨é’‰é’‰å‘Šè­¦.html":{"url":"linux/monitor/zabbix/zabbix3.4/11.zabbix3.4ä½¿ç”¨é’‰é’‰å‘Šè­¦.html","title":"zabbix3.4ä½¿ç”¨é’‰é’‰å‘Šè­¦","keywords":"","body":"zabbix3.4ä½¿ç”¨é’‰é’‰å‘Šè­¦ ç¬¬ä¸€æ­¥ã€é’‰é’‰æœºå™¨äººåˆ›å»º æ‰“å¼€windowsé’‰é’‰å®¢æˆ·ç«¯-->å³ä¸Šè§’å¤´åƒå¤„-->æœºå™¨äººç®¡ç† é€‰æ‹©è‡ªå®šä¹‰ é€‰æ‹©æ·»åŠ  å¡«å†™æœºå™¨äººåå­—å’Œè¦æ·»åŠ åˆ°çš„ç¾¤ç»„ è¿™é‡Œçš„webhookå€¼éœ€è¦å†™åœ¨åç»­pythonè„šæœ¬ä¸­ ç¬¬äºŒæ­¥ã€zabbix-serverç«¯ç¼–å†™pythonè„šæœ¬ #åœ¨zabbix-serverç«¯ç¼–è¾‘pythonè„šæœ¬ [root@zabbix-server alertscripts]# pwd /usr/lib/zabbix/alertscripts [root@zabbix-server alertscripts]# cat >/usr/lib/zabbix/alertscripts/ dingding.py ç¬¬ä¸‰æ­¥ã€zabbix webç•Œé¢è®¾ç½® 3.1åˆ›å»ºé’‰é’‰å‘Šè­¦ ç®¡ç†-->æŠ¥è­¦åª’ä»‹ç±»å‹-->åˆ›å»ºåª’ä½“ç±»å‹ å¡«å†™ç›¸å…³ä¿¡æ¯ï¼Œæ³¨æ„è„šæœ¬å‚æ•°å†™ {ALERT.MESSAGE} å³ä¸Šè§’å°äººå¤´-->æŠ¥è­¦åª’ä»‹-->æ·»åŠ  3.2ä¿®æ”¹å‘Šè­¦æ“ä½œ ä¿®æ”¹æ“ä½œæ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME} æ•…éšœ! ä¿®æ”¹æ¶ˆæ¯å†…å®¹å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME} æ•…éšœ! { å‘Šè­¦ä¸»æœº:{HOST.NAME} å‘Šè­¦åœ°å€:{HOST.IP} ç›‘æ§é¡¹ç›®:{ITEM.NAME} ç›‘æ§å–å€¼:{ITEM.LASTVALUE} å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY} å½“å‰çŠ¶æ€:{TRIGGER.STATUS} å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME} å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME} äº‹ä»¶ID:{EVENT.ID} } 3.3ä¿®æ”¹æ¢å¤æ“ä½œ ä¿®æ”¹æ¢å¤æ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME} å·²æ¢å¤! ä¿®æ”¹æ¢å¤å†…å®¹å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME} å·²æ¢å¤! { å‘Šè­¦ä¸»æœº:{HOST.NAME} å‘Šè­¦åœ°å€:{HOST.IP} ç›‘æ§é¡¹ç›®:{ITEM.NAME} ç›‘æ§å–å€¼:{ITEM.LASTVALUE} å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY} å½“å‰çŠ¶æ€:{TRIGGER.STATUS} å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME} å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME} æ¢å¤æ—¶é—´:{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME} æŒç»­æ—¶é—´:{EVENT.AGE} äº‹ä»¶ID:{EVENT.ID} } 3.4ä¿®æ”¹ç¡®è®¤ä¿¡æ¯ ä¿®æ”¹ç¡®è®¤æ ‡é¢˜å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤ ä¿®æ”¹ç¡®è®¤å†…å®¹å¦‚ä¸‹ æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤ { ç¡®è®¤äºº:{USER.FULLNAME} æ—¶é—´:{ACK.DATE} {ACK.TIME} ç¡®è®¤ä¿¡æ¯å¦‚ä¸‹: \"{ACK.MESSAGE}\" é—®é¢˜æœåŠ¡å™¨IP:{HOSTNAME1} é—®é¢˜ID:{EVENT.ID} å½“å‰çš„é—®é¢˜æ˜¯: {TRIGGER.NAME} } ç¬¬å››æ­¥ã€é’‰é’‰éªŒè¯ pcç«¯é’‰é’‰ æ‰‹æœºç«¯é’‰é’‰ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/zabbix/zabbix5.0/1.centos7å®‰è£…zabbix5.0.html":{"url":"linux/monitor/zabbix/zabbix5.0/1.centos7å®‰è£…zabbix5.0.html","title":"1.zabbix5.0å®‰è£…","keywords":"","body":"centos7å®‰è£…zabbix5.0 zabbix5.0æ ‡å‡†å®‰è£…å®˜æ–¹æ–‡æ¡£ ä¸€ã€æ ‡å‡†å®‰è£… 1.æ·»åŠ yumæº rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm 2.å®‰è£…zabbix-serverå’Œzabbix-agent yum -y install zabbix-server-mysql zabbix-agent 3.å®‰è£…Zabbix frontend å¯ç”¨çº¢å¸½è½¯ä»¶é›†åˆ yum -y install centos-release-scl 4.ç¼–è¾‘é…ç½®æ–‡ä»¶/etc/yum.repos.d/zabbix.repoä»¥ä½¿ç”¨zabbix-frontendåº“ [zabbix-frontend] enabled=1 #ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¿®æ”¹ sed -i '11s/0/1/' /etc/yum.repos.d/zabbix.repo 5.å®‰è£…Zabbix frontendåŒ… yum -y install zabbix-web-mysql-scl zabbix-apache-conf-scl 6.åˆ›å»ºæ•°æ®åº“ mysql -e \"create database zabbix character set utf8 collate utf8_bin;\" mysql -e \"create user zabbix@localhost identified by 'zabbix';\" mysql -e \"grant all privileges on zabbix.* to zabbix@localhost;\" 7.å¯¼å…¥æ•°æ®åº“ zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix 8.ä¸ºZabbix serveré…ç½®æ•°æ®åº“ ç¼–è¾‘é…ç½®æ–‡ä»¶/etc/zabbix/zabbix_server.conf //é…ç½®æ•°æ®åº“å¯†ç  DBPassword=zabbix #ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ sed -i.bak '/# DBPassword=/c DBPassword=zabbix' /etc/zabbix/zabbix_server.conf 9.ä¸ºZabbixå‰ç«¯é…ç½®PHP ç¼–è¾‘é…ç½®æ–‡ä»¶/etc/opt/rh/rh-php72/php-fpm.d/zabbix.confè®¾ç½®æ—¶åŒº sed -i.bak '/^;/c php_value[date.timezone] = Asia/Shanghai' /etc/opt/rh/rh-php72/php-fpm.d/zabbix.conf [root@hwy ~]# 10.ç»™/etc/zabbixæ‰€æœ‰æ–‡ä»¶æƒé™è®¾ç½®ä¸ºzabbix chown -R zabbix.zabbix /etc/zabbix/ 11.å¯åŠ¨æœåŠ¡ systemctl restart zabbix-server zabbix-agent httpd rh-php72-php-fpm systemctl enable zabbix-server zabbix-agent httpd rh-php72-php-fpm 12.å®Œæˆå®‰è£… ç¬¬ä¸€æ­¥ã€æµè§ˆå™¨è®¿é—® IP:ç«¯å£/zabbix ç‚¹å‡»Next step ç¬¬äºŒæ­¥ã€æ£€æŸ¥é…ç½®ï¼Œè¦å…¨éƒ¨OKæ‰å¯ä»¥ ç¬¬ä¸‰æ­¥ã€é…ç½®æ•°æ®åº“ä¿¡æ¯ ç¬¬å››æ­¥ã€zabbix-serveråç§°é…ç½® ç¬¬äº”æ­¥ã€ç¡®è®¤é…ç½®ä¿¡æ¯ å¦‚æœé‡åˆ°è¿™ä¸ªåˆ™æ˜¯æƒé™é—®é¢˜ï¼Œç‚¹å‡»é“¾æ¥ä¸‹è½½é…ç½®æ–‡ä»¶å¹¶å­˜æ”¾è‡³/etc/zabbix/webç›®å½•ä¸‹ï¼Œå¹¶ä¸”æƒé™è®¾ç½®ä¸º644ï¼Œå±ä¸»å’Œå±ç»„éƒ½æ˜¯zabbix ç¬¬ä¸ƒæ­¥ã€å®Œæˆå®‰è£… ç¬¬å…«æ­¥ã€ç™»é™†zabbix ç”¨æˆ·åAdmin å¯†ç zabbix ç™»é™†åé¦–ç•Œé¢ è®¾ç½®ä¸­æ–‡ ç‚¹å‡»å·¦ä¸‹è§’User settingsï¼ŒLanguageå¤„é€‰æ‹©Chinese(zh_CN)ï¼Œç„¶åç‚¹å‡»Update 13.ä¿®æ”¹ä¸­æ–‡ä¹±ç é—®é¢˜ ç‚¹å‡»ä¸»æœº-->å›¾å½¢ï¼Œä¼šçœ‹åˆ°æœ‰ä¹±ç  è§£å†³æ–¹æ³• ä»windowsæ‰¾åˆ°æ¥·ä½“å­—ä½“simkaiï¼Œæœç´¢æ¥·ä½“å³å¯ windowsè·¯å¾„ cç›˜-->Windows-->Fonts macè·¯å¾„/Library/Fonts åœ¨zabbix-serverä¸Šå¤‡ä»½zabbixé»˜è®¤å­—ä½“å¹¶ä¸”ä¸Šä¼ æ–°å­—ä½“ [root@zabbix-server ~]# cd /usr/share/fonts/dejavu/ [root@zabbix-server dejavu]# ls DejaVuSans-BoldOblique.ttf DejaVuSansCondensed-BoldOblique.ttf DejaVuSansCondensed-Oblique.ttf DejaVuSans-ExtraLight.ttf DejaVuSans.ttf DejaVuSans-Bold.ttf DejaVuSansCondensed-Bold.ttf DejaVuSansCondensed.ttf DejaVuSans-Oblique.ttf #ç„¶åä¸Šä¼ å­—ä½“ï¼Œä¿®æ”¹åç§°ä¸ºDejaVuSans.ttf [root@zabbix-server dejavu]# mv DejaVuSans.ttf DejaVuSans.ttf.bak [root@zabbix-server dejavu]# mv simkai.ttf DejaVuSans.ttf #æ³¨æ„å­—ä½“çš„æƒé™è¦è®©zabbixç”¨æˆ·å¯ä»¥è¯» [root@zabbix-server dejavu]# chmod 644 DejaVuSans.ttf [root@zabbix-server dejavu]# ll DejaVuSans.ttf -rw-r--r-- 1 root root 19647736 Jan 13 16:29 DejaVuSans.ttf æµè§ˆå™¨åˆ·æ–°éªŒè¯ äºŒã€dockerå®‰è£… zabbix5.0 dockerå®‰è£…å®˜æ–¹æ–‡æ¡£ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/monitor/grafana/1.centos7å®‰è£…grafana7.0.3å¹¶ç»“åˆzabbixæ•°æ®æºè¿›è¡ŒåŸºç¡€ç›‘æ§.html":{"url":"linux/monitor/grafana/1.centos7å®‰è£…grafana7.0.3å¹¶ç»“åˆzabbixæ•°æ®æºè¿›è¡ŒåŸºç¡€ç›‘æ§.html","title":"grafana7.0.3å®‰è£…å¹¶ç»“åˆzabbixæ•°æ®æºè¿›è¡ŒåŸºç¡€ç›‘æ§","keywords":"","body":"centos7å®‰è£…grafana7.0.3å¹¶ç»“åˆzabbixæ•°æ®æºè¿›è¡ŒåŸºç¡€ç›‘æ§ frafanaå®˜ç½‘ grafanaå®˜æ–¹ä¸‹è½½åœ°å€ grafanaå®˜æ–¹ç®¡ç†é…ç½®æ–‡æ¡£ 1.ä¸‹è½½å®‰è£…åŒ…å¹¶å®‰è£… wget https://dl.grafana.com/oss/release/grafana-7.0.3-1.x86_64.rpm yum -y localinstall grafana-7.0.3-1.x86_64.rpm 2.å¯åŠ¨æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ grafanaé»˜è®¤ç›‘å¬TCP/3000ç«¯å£ grafanaé…ç½®æ–‡ä»¶/etc/grafana/grafana.ini systemctl enable grafana-server && systemctl start grafana-server 3.ç™»é™†grafana åˆå§‹é»˜è®¤è´¦æˆ·å’Œå¯†ç éƒ½æ˜¯admin ç™»é™†æˆåŠŸåä¼šæç¤ºä¿®æ”¹å¯†ç ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è·³è¿‡ä¸ä¿®æ”¹ ç™»é™†åé¦–ç•Œé¢ 4.å®‰è£…zabbixæ’ä»¶ grafana å®˜æ–¹æ’ä»¶ä¸‹è½½åœ°å€ grafana-cli plugins install alexanderzobnin-zabbix-app #æ’ä»¶å®‰è£…å®Œæˆåè¦é‡å¯grafana systemctl restart grafana-server 5.å¯ç”¨zabbixæ’ä»¶ ç¬¬ä¸€æ­¥ã€ç‚¹å‡»å·¦ä¾§è®¾ç½®æŒ‰é’®ï¼Œç„¶åç‚¹å‡»Plugins ç¬¬äºŒæ­¥ã€åœ¨æœ€ä¸‹è¾¹æ‰¾åˆ°zabbixæ’ä»¶ï¼Œçº¢è‰²è­¦å‘Šè¡¨æ˜æ’ä»¶æ˜¯å¤–éƒ¨æ’ä»¶ ç¬¬ä¸‰æ­¥ã€å…è®¸zabbixæ’ä»¶ 6.é…ç½®zabbixæ•°æ®æº ç¬¬ä¸€æ­¥ã€ç‚¹å‡»å·¦ä¾§è®¾ç½®æŒ‰é’®ï¼Œç„¶åé€‰æ‹©Data Sources ç¬¬äºŒæ­¥ã€é€‰æ‹©Add data source ç¬¬ä¸‰æ­¥ã€é€‰æ‹©zabbix ç¬¬å››æ­¥ã€é…ç½®zabbixç”¨æˆ·å¯†ç ä¿¡æ¯ grafanaä¼šè‡ªåŠ¨ä½¿ç”¨é»˜è®¤çš„zabbix apiåœ°å€ é…ç½®å®Œæˆåç‚¹å‡»ä¸‹æ–¹çš„Save & Test zabbix apiåœ°å€å¦‚ä¸‹ï¼Œå¦‚æœlocalhostæ— æ³•è§£æï¼Œåˆ™éœ€è¦æŠŠlocalhostæ”¹æˆzabbixçš„åŸŸå http://localhost/zabbix/api_jsonrpc.php æ£€æµ‹æˆåŠŸä¼šæç¤ºå¦‚ä¸‹ 7.æ·»åŠ dashboardè¿›è¡Œè‡ªå®šä¹‰ç›‘æ§ 7.1 åˆ›å»ºdashboard ç‚¹å‡»å·¦ä¾§+å·ï¼Œé€‰æ‹©Dashboard é€‰æ‹©å³ä¸Šè§’Dashboard settings å¯¹dashboardè¿›è¡Œé‡å‘½å ç¡®è®¤dashboardåç§° åˆ›å»ºå®Œæˆåçš„dashboard 7.2 åˆ›å»ºç›‘æ§å›¾å½¢ é€‰æ‹©åˆ›å»ºå¥½çš„dashboardï¼Œç„¶åç‚¹å‡»å³ä¸Šè§’çš„Add panelï¼Œæ·»åŠ ä¸€ä¸ªé¢æ¿ ç¤ºä¾‹ï¼šåˆ›å»ºCPUè´Ÿè½½ç›‘æ§å›¾å½¢ ä¿®æ”¹æ ‡é¢˜ 7.3 ä¿å­˜dashboard å³ä¸Šè§’ç‚¹å‡»Save ä¿å­˜dashboardçš„æ—¶å€™ä¼šè¦æ±‚æ·»åŠ æ”¹å˜çš„æè¿°ä¿¡æ¯ï¼Œå³ä¿®æ”¹äº†å“ªäº›å†…å®¹ ä¿å­˜å®Œåç‚¹å‡»Apply æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼Œå·¦ä¸Šè§’æ˜¯æ–°å»ºçš„dashboardï¼Œæœ€å¥½ä»¥éƒ¨é—¨åç§°å‘½åï¼Œè¿™æ ·ä¾¿äºåŒºåˆ†ä¸åŒéƒ¨é—¨çš„æœºå™¨ï¼Œè¿™é‡Œæ˜¯ç¤ºä¾‹åˆ›å»ºäº†CPUè´Ÿè½½ç›‘æ§å›¾å½¢ï¼Œå…¶ä½™ç›‘æ§åˆ›å»ºæ–¹æ³•ä¸€è‡´ï¼Œé¢æ¿å¤§å°ä¹Ÿå¯ä»¥è°ƒæ•´ åˆ›å»ºå…¶ä»–ç›‘æ§å›¾å½¢ å¦‚æœæƒ³è¦åˆ›å»ºå…¶ä»–ç›‘æ§é¡¹å›¾å½¢ï¼Œå…ˆé€‰æ‹©å¯¹åº”çš„dashboardï¼Œç„¶ååœ¨åˆ›å»ºé¢æ¿ï¼Œæœ€ååœ¨é¢æ¿ä¸­é€‰æ‹©ç›¸åº”çš„ç›‘æ§ä¿¡æ¯å³å¯ ä¿®æ”¹ç›‘æ§å›¾å½¢æŒ‡æ ‡å•ä½ åœ¨å¯ç”¨å†…å­˜ç›‘æ§ä¸­ï¼Œé»˜è®¤çš„å•ä½ä¸å¤ªå¥½è¯†åˆ« ä¿®æ”¹æŒ‡æ ‡å•ä½ ç‚¹å‡»å³ä¾§çš„Axes(è½´)ï¼Œé€‰æ‹©ç›¸å¯¹åº”çš„è½´ï¼Œæ¯”å¦‚Left Y(å·¦Yè½´)ï¼Œç„¶ååœ¨Unit(å•ä½)é€‰é¡¹å¡å¤„é€‰æ‹©ç›¸åº”çš„å•ä½ï¼Œé€‰æ‹©Data(Metric)ä¸‹çš„bytes(Metric) æœ€ç»ˆæ•ˆæœï¼Œè¿™æ ·çœ‹èµ·æ¥å·¦ä¾§æ˜¾ç¤ºå•ä½å°±æ¯”è¾ƒæ˜äº†äº† æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/æ€§èƒ½æµ‹è¯•/æ–‡ä»¶åˆ é™¤æ•ˆç‡æµ‹è¯•/æµ‹è¯•Linuxä¸‹åˆ é™¤å¤§é‡æ–‡ä»¶çš„æ•ˆç‡.html":{"url":"linux/æ€§èƒ½æµ‹è¯•/æ–‡ä»¶åˆ é™¤æ•ˆç‡æµ‹è¯•/æµ‹è¯•Linuxä¸‹åˆ é™¤å¤§é‡æ–‡ä»¶çš„æ•ˆç‡.html","title":"æ–‡ä»¶åˆ é™¤æ•ˆç‡æµ‹è¯•","keywords":"","body":"æµ‹è¯•Linuxä¸‹åˆ é™¤å¤§é‡æ–‡ä»¶çš„æ•ˆç‡ åˆ›å»º50ä¸‡ä¸ªæµ‹è¯•æ–‡ä»¶ //åˆ›å»º50ä¸‡ä¸ªæ–‡ä»¶ mkdir /test && cd /test time for i in $(seq 1 500000);do echo text >>$i.txt;done real 1m9.177s user 0m9.731s sys 0m48.238s //æ€»å¤§å°ä¸º2G du -sh /test/ 2.0G /test/ 1.rmåˆ é™¤ time rm -rf * -bash: /usr/bin/rm: Argument list too long real 0m1.709s user 0m1.580s sys 0m0.123s æ–‡ä»¶å¤ªå¤šï¼Œrmä¸èµ·ä½œç”¨ 2.findåˆ é™¤ time find ./ -type f -exec rm {} \\; real 10m56.698s user 2m13.203s sys 8m35.653s ç”¨æ—¶10åˆ†é’Ÿ 3.find with delete time find ./ -type f -delete real 0m26.757s user 0m1.222s sys 0m23.112s ç”¨æ—¶26ç§’ 4.rsyncåˆ é™¤ //å…ˆå»ºç«‹ä¸€ä¸ªç©ºæ–‡ä»¶å¤¹test-bak mkdir test-bak time rsync -a --delete test-bak/ /test/ real 0m25.440s user 0m1.364s sys 0m22.082s ç”¨æ—¶25ç§’ 5.python2.7 import os import timeit def main(): for pathname,dirnames,filenames in os.walk('/test'): for filename in filenames: file=os.path.join(pathname,filename) os.remove(file) if __name__=='__main__': t=timeit.Timer('main()','from __main__ import main') print t.timeit(1) ç”¨æ—¶35ç§’ 6.perl time perl -e 'for(){((stat)[9] ç³»ç»Ÿç¯å¢ƒ ucloud 1c2g centos7.7 #ä½¿ç”¨ddå‘½ä»¤æµ‹è¯•ç£ç›˜è¯»å†™é€Ÿåº¦ä¸º78.6MB/s dd if=/dev/zero of=/opt/bigfile bs=1M count=1024 1024+0 records in 1024+0 records out 1073741824 bytes (1.1 GB) copied, 13.668 s, 78.6 MB/s #ä½¿ç”¨hdparmæµ‹è¯•ç£ç›˜è¯»å†™é€Ÿåº¦ä¸º74.60MB/s hdparm -t --direct /dev/vda1 /dev/vda1: Timing O_DIRECT disk reads: 230 MB in 3.08 seconds = 74.60 MB/sec 50ä¸‡ä¸ªæ–‡ä»¶åˆ é™¤æ‰€ç”¨æ—¶é—´ rmåˆ é™¤ï¼šæ–‡ä»¶å¤ªå¤šï¼Œæ— æ³•åˆ é™¤ findåˆ é™¤ï¼šç”¨æ—¶10åˆ†é’Ÿ find with deleteåˆ é™¤ï¼šç”¨æ—¶26ç§’ rsyncåˆ é™¤ï¼šç”¨æ—¶25ç§’ python2.7åˆ é™¤ï¼šç”¨æ—¶35ç§’ perlåˆ é™¤ï¼šç”¨æ—¶33ç§’ rsyncåˆ é™¤æœ€å¿« æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxç³»ç»Ÿ/centos8/CentOS8ä½¿ç”¨è®°å½•.html":{"url":"linux/linuxç³»ç»Ÿ/centos8/CentOS8ä½¿ç”¨è®°å½•.html","title":"centos8ä½¿ç”¨è®°å½•","keywords":"","body":"CentOS8ä½¿ç”¨è®°å½• centos8çš„ä½œè€…åº”è¯¥å¾ˆå–œæ¬¢è…¾è®¯çš„åœ°ä¸‹åŸä¸å‹‡å£«(dnf)ï¼Œå¦åˆ™è¸ğŸæ€ä¹ˆä¼šæŠŠå®‰è£…å‘½ä»¤yumå°¼ç›æ”¹æˆdnf ï¼Ÿï¼Ÿï¼Ÿ 1.æ›´æ¢yumæº 1.å¤‡ä»½ mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup 2.ä¸‹è½½é˜¿é‡Œäº‘yumæº wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo æˆ– curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo 3.ç”Ÿæˆç¼“å­˜ dnf clean all dnf makecache 4.å®‰è£…epolæº yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm sed -i 's|^#baseurl=https://download.fedoraproject.org/pub|baseurl=https://mirrors.aliyun.com|' /etc/yum.repos.d/epel* sed -i 's|^metalink|#metalink|' /etc/yum.repos.d/epel* 2.åŒæ­¥æ—¶é—´ centos8ä¸æ”¯æŒntpdateäº†ï¼Œæ”¹ç”¨chrony 1.å®‰è£… dnf -y install chrony 2.ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/chrony.confï¼Œæ³¨é‡Špoolå¼€å¤´ä¸€è¡Œï¼Œæ–°å¢é˜¿é‡Œäº‘åœ°å€ #pool 2.centos.pool.ntp.org iburst server ntp.aliyun.com iburst sed -i.bak '3s/^/#&/g' /etc/chrony.conf && sed -i '4cserver ntp.aliyun.com iburst' /etc/chrony.conf serverï¼šæŒ‡æ˜æ—¶é—´æœåŠ¡å™¨åœ°å€ï¼› allow NETADD/NETMASK allow allï¼šå…è®¸æ‰€æœ‰å®¢æˆ·ç«¯ä¸»æœºï¼› deny NETADDR/NETMASK deny allï¼šæ‹’ç»æ‰€æœ‰å®¢æˆ·ç«¯ï¼› bindcmdaddressï¼šå‘½ä»¤ç®¡ç†æ¥å£ç›‘å¬çš„åœ°å€ï¼› local stratum 10ï¼šå³ä½¿è‡ªå·±æœªèƒ½é€šè¿‡ç½‘ç»œæ—¶é—´æœåŠ¡å™¨åŒæ­¥åˆ°æ—¶é—´ï¼Œä¹Ÿå…è®¸å°†æœ¬åœ°æ—¶é—´ä½œä¸ºæ ‡å‡†æ—¶é—´æˆæ—¶ç»™å…¶å®ƒå®¢æˆ·ç«¯ï¼› 3.å¯åŠ¨æœåŠ¡ systemctl enable chronyd && systemctl start chronyd 4.æ£€æŸ¥ç«¯å£ chronydæœåŠ¡ç›‘å¬udp32ç«¯å£ netstat -nupl|grep chronyd 5.éªŒè¯åŒæ­¥ chronyc sources 210 Number of sources = 1 MS Name/IP address Stratum Poll Reach LastRx Last sample =============================================================================== ^* 203.107.6.88 2 6 17 44 -2379us[-3100us] +/- 43ms ä¸ªäººå®é™…ä½¿ç”¨ï¼Œè¿™ä¸ªchronyä¸å¥½ç”¨ï¼Œç»å¯¹æ²¡æœ‰ntpdateå¥½ç”¨ï¼Œæˆ‘æ‰‹åŠ¨æ›´æ”¹äº†æ—¶é—´ï¼Œå°¼ç›5åˆ†é’Ÿäº†è¿˜æ²¡æœ‰åŒæ­¥ï¼Œåƒåœ¾ è¿˜æ˜¯ç›´æ¥ä½¿ç”¨å‘½ä»¤æ¥çš„å¿« chronyd -q \"server ntp.aliyun.com iburst\" centos8ç»§ç»­ä½¿ç”¨ntpdate 1.æ·»åŠ wlnmpæº rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm 2.å®‰è£…ntpæœåŠ¡ dnf -y install wntp 3.æ—¶é—´åŒæ­¥ ntpdate ntp.aliyun.com 3.centos8ç½‘ç»œæœåŠ¡ centos8ä½¿ç”¨çš„æ˜¯NetworkManagerç®¡ç†ç½‘ç»œï¼Œä¸èƒ½ä½¿ç”¨systemctldç®¡ç†network systemctl enable NetworkManager nmcli c reload eth0 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxç³»ç»Ÿ/ubuntu/ubuntu18.04ä½¿ç”¨è®°å½•.html":{"url":"linux/linuxç³»ç»Ÿ/ubuntu/ubuntu18.04ä½¿ç”¨è®°å½•.html","title":"ubuntuä½¿ç”¨è®°å½•","keywords":"","body":"ubuntu18.04ä½¿ç”¨è®°å½• 1.è®¾ç½®é™æ€IP //ç¼–è¾‘æ–‡ä»¶ root@ubuntu18:~# cat /etc/netplan/01-network-manager-all.yaml # Let NetworkManager manage all devices on this system network: ethernets: enp0s5: #âš ï¸è¿™é‡Œè¦çœ‹ä¸€ä¸‹ç½‘å¡çš„åç§° dhcp4: false addresses: [10.0.0.15/24] gateway4: 10.0.0.1 nameservers: addresses: [223.5.5.5,114.114.114.114] version: 2 renderer: networkd //ä½¿è®¾ç½®ç”Ÿæ•ˆ netplan apply 2.å¼€å¯sshæœåŠ¡ //ubuntu-18.04desktpoç‰ˆé»˜è®¤åªå®‰è£…ssh-agent sudo apt -y install openssh-server //å¯åŠ¨æœåŠ¡ sudo service ssh start 3.å®‰è£…python3.6 //ubuntu18.04é»˜è®¤pythonç‰ˆæœ¬æ˜¯3.7 root@ubuntu18:~# python3 Python 3.7.5rc1 (default, Oct 8 2019, 16:47:45) [GCC 9.2.1 20191008] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information. root@ubuntu18:~# python3.7 Python 3.7.5rc1 (default, Oct 8 2019, 16:47:45) [GCC 9.2.1 20191008] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information. //å®‰è£…ä¾èµ–åŒ… apt -y install python3-dev libffi-dev libssl-dev zlib* //æºç ç¼–è¯‘å®‰è£…python3.6 ./configure --enable-optimizations --prefix=/usr/local/python36 make make altinstall #é˜²æ­¢è¦†ç›–åŸæ¥çš„ç‰ˆæœ¬ //è®¾ç½®ç¯å¢ƒå˜é‡ echo \"PATH=/usr/local/python36/bin:$PATH\" >/etc/profile.d/python36.sh && source /etc/ //è®¾ç½®pipå›½å†…æº mkdir /root/.pip cat >/root/.pip/pip.conf ubuntuå®‰è£…python3.6é—®é¢˜ 4.æ›´æ¢å›½å†…æº(ubuntu18.04) //å¤‡ä»½åŸæœ‰æ–‡ä»¶ cp /etc/apt/sources.list{,.bak} //è®¾ç½®ä¸ºé˜¿é‡Œäº‘æº cat >/etc/apt/sources.list æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxç³»ç»Ÿ/kali/kali2020.1ä½¿ç”¨è®°å½•.html":{"url":"linux/linuxç³»ç»Ÿ/kali/kali2020.1ä½¿ç”¨è®°å½•.html","title":"kaliä½¿ç”¨è®°å½•","keywords":"","body":"kali2020.1ä½¿ç”¨è®°å½• 1.å¼€å¯ssh kalié»˜è®¤sshæœåŠ¡éƒ¨å¼€å¯ //å¯åŠ¨sshæœåŠ¡ service ssh start //å¼€æœºè‡ªå¯ update-rc.d ssh enable 2.é…ç½®ç½‘å¡ 1.ç¼–è¾‘æ–‡ä»¶/etc/network/interfaces #æ³¨é‡Šä»¥ä¸‹ä¸¤è¡Œ #auto lo #iface lo inet loopback auto eth0 iface eth0 inet static address 10.0.0.17 netmask 255.255.255.0 gateway 10.0.0.1 2.é‡å¯ç½‘è·¯æœåŠ¡ service networking restart 3.é…ç½®é˜¿é‡Œäº‘æº #ç¼–è¾‘æ–‡ä»¶/etc/apt/sources.listï¼Œå†™å…¥ä»¥ä¸‹ä¸¤è¡Œ deb https://mirrors.aliyun.com/kali kali-rolling main non-free contrib deb-src https://mirrors.aliyun.com/kali kali-rolling main non-free contrib #æ›´æ–° apt update 4.è®¾ç½®å›¾å½¢ç•Œé¢ 1.å®‰è£…åŒ… apt install x-window-system-core xfce4 -y 2.åœ¨å‘½ä»¤è¡Œè¾“å…¥â€dpkg-reconfigure localesâ€ã€‚è¿›å…¥å›¾å½¢åŒ–ç•Œé¢ä¹‹åï¼Œï¼ˆç©ºæ ¼æ˜¯é€‰æ‹©ï¼ŒTabæ˜¯åˆ‡æ¢ï¼Œ*æ˜¯é€‰ä¸­ï¼‰ï¼Œé€‰ä¸­zh_CN.UTF-8ï¼Œç¡®å®šåï¼Œå°†h_CN.UTF-8é€‰ä¸ºé»˜è®¤ã€‚ æ¥ä¸‹æ¥çš„å‡ æ­¥å°±æ˜¯é€‰æ‹©zh_CN.UTF-8 3.å®‰è£…ä¸­æ–‡å­—ä½“ apt-get -y install xfonts-intl-chinese apt-get -y install ttf-wqy-microhei å®‰è£…å®Œåå¦‚æœæ²¡æœ‰æ˜¾ç¤ºä¸­æ–‡é‡å¯å³å¯ #å¼€æœºè®¾ç½®è¿›å…¥å›¾å½¢ç•Œé¢ 1.ç¼–è¾‘/etc/default/grub ä¿®æ”¹quiteä¸ºtext GRUB_CMDLINE_LINUX_DEFAULT=\"quiet\" 2.ä½¿é…ç½®ç”Ÿæ•ˆ update-grub 5.kaliè®¾ç½®æœåŠ¡å¼€æœºè‡ªå¯ //è®¾ç½®å¼€æœºè‡ªå¯ update-rc.d æœåŠ¡ enable //ç¦æ­¢å¼€æœºå¯åŠ¨ update-rc.d æœåŠ¡ disable // åˆ é™¤å¼€æœºå¯åŠ¨ update-rc.d -f æœåŠ¡ remove æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxç³»ç»Ÿ/deepin/deepin15.11ä½¿ç”¨è®°å½•.html":{"url":"linux/linuxç³»ç»Ÿ/deepin/deepin15.11ä½¿ç”¨è®°å½•.html","title":"deepinä½¿ç”¨è®°å½•","keywords":"","body":"deepin15.11ä½¿ç”¨è®°å½• æ·±åº¦å®˜æ–¹ä¸‹è½½åœ°å€ æ·±åº¦ç³»ç»Ÿç®¡ç†å®˜æ–¹æ–‡æ¡£ 1.ä¿®æ”¹ç½‘å¡åç§°ä¸ºeth0 1.å¤‡ä»½æ–‡ä»¶ cp /etc/default/grub{,.bak} 2.ä¿®æ”¹/etc/default/grub ä¿®æ”¹GRUB_CMDLINE_LINUX=\"\" ä¿®æ”¹ä¸ºGRUB_CMDLINE_LINUX=\"net.ifnames=0 biosdevname=0\" 3.æ›´æ–°grub update-grub é‡å¯ç³»ç»Ÿ 2.è®¾ç½®IPåœ°å€ 1.å¤‡ä»½ç½‘å¡é…ç½®æ–‡ä»¶ cp /etc/network/interfaces{,.bak} #æ³¨é‡Šè¿™è¡Œ #source-directory /etc/network/interfaces.d #å†™å…¥ä»¥ä¸‹é…ç½®ä¿¡æ¯ auto eth0 iface eth0 inet static address 10.0.0.18 netmask 255.255.255.0 gateway 10.0.0.1 2.é‡å¯ç½‘ç»œæœåŠ¡ systemctl restart networking 3.å®‰è£…sshæœåŠ¡ 1.å®‰è£… apt -y install openssh-server 2.å¯åŠ¨ systemctl start sshd 3.è®¾ç½®å¼€æœºè‡ªå¯ï¼Œéœ€è¦è‡ªè¡Œåˆ›å»º/etc/rc.localæ–‡ä»¶ï¼Œç„¶åæŠŠè¦å¯åŠ¨çš„æœåŠ¡å‘½ä»¤å†™ä¸Š(æ­¤æ–¹å¼é€‚ç”¨äºsystemdç®¡ç†çš„æœåŠ¡) cat >/etc/rc.local æ£€æµ‹åŒ…æ˜¯å¦å®‰è£… dpkg --list |grep åŒ…å æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/ç½‘ç»œåè®®/tcp:ip/TCP:IP åè®®.html":{"url":"linux/ç½‘ç»œåè®®/tcp:ip/TCP:IP åè®®.html","title":"TCP/IPåè®®","keywords":"","body":"TCP/IP åè®® æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ æ€»çº² ä¸€ã€ è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„åˆ†å±‚ è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„åˆ†å±‚ ä¸éš¾çœ‹å‡ºï¼ŒTCP/IP ä¸ OSI åœ¨åˆ†å±‚æ¨¡å—ä¸Šç¨æœ‰åŒºåˆ«ã€‚OSI å‚è€ƒæ¨¡å‹æ³¨é‡â€œé€šä¿¡åè®®å¿…è¦çš„åŠŸèƒ½æ˜¯ä»€ä¹ˆâ€ï¼Œè€Œ TCP/IP åˆ™æ›´å¼ºè°ƒâ€œåœ¨è®¡ç®—æœºä¸Šå®ç°åè®®åº”è¯¥å¼€å‘å“ªç§ç¨‹åºâ€ã€‚ äºŒã€TCP/IPåŸºç¡€ 2.1 TCP/IP çš„å…·ä½“å«ä¹‰ ä»å­—é¢æ„ä¹‰ä¸Šè®²ï¼Œæœ‰äººå¯èƒ½ä¼šè®¤ä¸º TCP/IP æ˜¯æŒ‡ TCP å’Œ IP ä¸¤ç§åè®®ã€‚å®é™…ç”Ÿæ´»å½“ä¸­æœ‰æ—¶ä¹Ÿç¡®å®å°±æ˜¯æŒ‡è¿™ä¸¤ç§åè®®ã€‚ç„¶è€Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå®ƒåªæ˜¯åˆ©ç”¨ IP è¿›è¡Œé€šä¿¡æ—¶æ‰€å¿…é¡»ç”¨åˆ°çš„åè®®ç¾¤çš„ç»Ÿç§°ã€‚å…·ä½“æ¥è¯´ï¼ŒIP æˆ– ICMPã€TCP æˆ– UDPã€TELNET æˆ– FTPã€ä»¥åŠ HTTP ç­‰éƒ½å±äº TCP/IP åè®®ã€‚ä»–ä»¬ä¸ TCP æˆ– IP çš„å…³ç³»ç´§å¯†ï¼Œæ˜¯äº’è”ç½‘å¿…ä¸å¯å°‘çš„ç»„æˆéƒ¨åˆ†ã€‚TCP/IP ä¸€è¯æ³›æŒ‡è¿™äº›åè®®ï¼Œå› æ­¤ï¼Œæœ‰æ—¶ä¹Ÿç§° TCP/IP ä¸ºç½‘é™…åè®®ç¾¤ã€‚ äº’è”ç½‘è¿›è¡Œé€šä¿¡æ—¶ï¼Œéœ€è¦ç›¸åº”çš„ç½‘ç»œåè®®ï¼ŒTCP/IP åŸæœ¬å°±æ˜¯ä¸ºä½¿ç”¨äº’è”ç½‘è€Œå¼€å‘åˆ¶å®šçš„åè®®æ—ã€‚å› æ­¤ï¼Œäº’è”ç½‘çš„åè®®å°±æ˜¯ TCP/IPï¼ŒTCP/IP å°±æ˜¯äº’è”ç½‘çš„åè®®ã€‚ ç½‘é™…åè®®ç¾¤ 2.2 æ•°æ®åŒ… åŒ…ã€å¸§ã€æ•°æ®åŒ…ã€æ®µã€æ¶ˆæ¯ ä»¥ä¸Šäº”ä¸ªæœ¯è¯­éƒ½ç”¨æ¥è¡¨è¿°æ•°æ®çš„å•ä½ï¼Œå¤§è‡´åŒºåˆ†å¦‚ä¸‹ï¼š åŒ…å¯ä»¥è¯´æ˜¯å…¨èƒ½æ€§æœ¯è¯­ï¼› å¸§ç”¨äºè¡¨ç¤ºæ•°æ®é“¾è·¯å±‚ä¸­åŒ…çš„å•ä½ï¼› æ•°æ®åŒ…æ˜¯ IP å’Œ UDP ç­‰ç½‘ç»œå±‚ä»¥ä¸Šçš„åˆ†å±‚ä¸­åŒ…çš„å•ä½ï¼› æ®µåˆ™è¡¨ç¤º TCP æ•°æ®æµä¸­çš„ä¿¡æ¯ï¼› æ¶ˆæ¯æ˜¯æŒ‡åº”ç”¨åè®®ä¸­æ•°æ®çš„å•ä½ã€‚ æ¯ä¸ªåˆ†å±‚ä¸­ï¼Œéƒ½ä¼šå¯¹æ‰€å‘é€çš„æ•°æ®é™„åŠ ä¸€ä¸ªé¦–éƒ¨ï¼Œåœ¨è¿™ä¸ªé¦–éƒ¨ä¸­åŒ…å«äº†è¯¥å±‚å¿…è¦çš„ä¿¡æ¯ï¼Œå¦‚å‘é€çš„ç›®æ ‡åœ°å€ä»¥åŠåè®®ç›¸å…³ä¿¡æ¯ã€‚é€šå¸¸ï¼Œä¸ºåè®®æä¾›çš„ä¿¡æ¯ä¸ºåŒ…é¦–éƒ¨ï¼Œæ‰€è¦å‘é€çš„å†…å®¹ä¸ºæ•°æ®ã€‚åœ¨ä¸‹ä¸€å±‚çš„è§’åº¦çœ‹ï¼Œä»ä¸Šä¸€å±‚æ”¶åˆ°çš„åŒ…å…¨éƒ¨éƒ½è¢«è®¤ä¸ºæ˜¯æœ¬å±‚çš„æ•°æ®ã€‚ æ•°æ®åŒ…é¦–éƒ¨ ç½‘ç»œä¸­ä¼ è¾“çš„æ•°æ®åŒ…ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€éƒ¨åˆ†æ˜¯åè®®æ‰€è¦ç”¨åˆ°çš„é¦–éƒ¨ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ä¸Šä¸€å±‚ä¼ è¿‡æ¥çš„æ•°æ®ã€‚é¦–éƒ¨çš„ç»“æ„ç”±åè®®çš„å…·ä½“è§„èŒƒè¯¦ç»†å®šä¹‰ã€‚åœ¨æ•°æ®åŒ…çš„é¦–éƒ¨ï¼Œæ˜ç¡®æ ‡æ˜äº†åè®®åº”è¯¥å¦‚ä½•è¯»å–æ•°æ®ã€‚åè¿‡æ¥è¯´ï¼Œçœ‹åˆ°é¦–éƒ¨ï¼Œä¹Ÿå°±èƒ½å¤Ÿäº†è§£è¯¥åè®®å¿…è¦çš„ä¿¡æ¯ä»¥åŠæ‰€è¦å¤„ç†çš„æ•°æ®ã€‚åŒ…é¦–éƒ¨å°±åƒåè®®çš„è„¸ã€‚ 2.3 æ•°æ®å¤„ç†æµç¨‹ ä¸‹å›¾ä»¥ç”¨æˆ· a å‘ç”¨æˆ· b å‘é€é‚®ä»¶ä¸ºä¾‹å­ï¼š æ•°æ®å¤„ç†æµç¨‹ â‘  åº”ç”¨ç¨‹åºå¤„ç† é¦–å…ˆåº”ç”¨ç¨‹åºä¼šè¿›è¡Œç¼–ç å¤„ç†ï¼Œè¿™äº›ç¼–ç ç›¸å½“äº OSI çš„è¡¨ç¤ºå±‚åŠŸèƒ½ï¼› ç¼–ç è½¬åŒ–åï¼Œé‚®ä»¶ä¸ä¸€å®šé©¬ä¸Šè¢«å‘é€å‡ºå»ï¼Œè¿™ç§ä½•æ—¶å»ºç«‹é€šä¿¡è¿æ¥ä½•æ—¶å‘é€æ•°æ®çš„ç®¡ç†åŠŸèƒ½ï¼Œç›¸å½“äº OSI çš„ä¼šè¯å±‚åŠŸèƒ½ã€‚ â‘¡ TCP æ¨¡å—çš„å¤„ç† TCP æ ¹æ®åº”ç”¨çš„æŒ‡ç¤ºï¼Œè´Ÿè´£å»ºç«‹è¿æ¥ã€å‘é€æ•°æ®ä»¥åŠæ–­å¼€è¿æ¥ã€‚TCP æä¾›å°†åº”ç”¨å±‚å‘æ¥çš„æ•°æ®é¡ºåˆ©å‘é€è‡³å¯¹ç«¯çš„å¯é ä¼ è¾“ã€‚ä¸ºäº†å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œéœ€è¦åœ¨åº”ç”¨å±‚æ•°æ®çš„å‰ç«¯é™„åŠ ä¸€ä¸ª TCP é¦–éƒ¨ã€‚ â‘¢ IP æ¨¡å—çš„å¤„ç† IP å°† TCP ä¼ è¿‡æ¥çš„ TCP é¦–éƒ¨å’Œ TCP æ•°æ®åˆèµ·æ¥å½“åšè‡ªå·±çš„æ•°æ®ï¼Œå¹¶åœ¨ TCP é¦–éƒ¨çš„å‰ç«¯åŠ ä¸Šè‡ªå·±çš„ IP é¦–éƒ¨ã€‚IP åŒ…ç”Ÿæˆåï¼Œå‚è€ƒè·¯ç”±æ§åˆ¶è¡¨å†³å®šæ¥å—æ­¤ IP åŒ…çš„è·¯ç”±æˆ–ä¸»æœºã€‚ â‘£ ç½‘ç»œæ¥å£ï¼ˆä»¥å¤ªç½‘é©±åŠ¨ï¼‰çš„å¤„ç† ä» IP ä¼ è¿‡æ¥çš„ IP åŒ…å¯¹äºä»¥å¤ªç½‘æ¥è¯´å°±æ˜¯æ•°æ®ã€‚ç»™è¿™äº›æ•°æ®é™„åŠ ä¸Šä»¥å¤ªç½‘é¦–éƒ¨å¹¶è¿›è¡Œå‘é€å¤„ç†ï¼Œç”Ÿæˆçš„ä»¥å¤ªç½‘æ•°æ®åŒ…å°†é€šè¿‡ç‰©ç†å±‚ä¼ è¾“ç»™æ¥æ”¶ç«¯ã€‚ â‘¤ ç½‘ç»œæ¥å£ï¼ˆä»¥å¤ªç½‘é©±åŠ¨ï¼‰çš„å¤„ç† ä¸»æœºæ”¶åˆ°ä»¥å¤ªç½‘åŒ…åï¼Œé¦–å…ˆä»ä»¥å¤ªç½‘åŒ…é¦–éƒ¨æ‰¾åˆ° MAC åœ°å€åˆ¤æ–­æ˜¯å¦ä¸ºå‘é€ç»™è‡ªå·±çš„åŒ…ï¼Œè‹¥ä¸æ˜¯åˆ™ä¸¢å¼ƒæ•°æ®ã€‚ å¦‚æœæ˜¯å‘é€ç»™è‡ªå·±çš„åŒ…ï¼Œåˆ™ä»ä»¥å¤ªç½‘åŒ…é¦–éƒ¨ä¸­çš„ç±»å‹ç¡®å®šæ•°æ®ç±»å‹ï¼Œå†ä¼ ç»™ç›¸åº”çš„æ¨¡å—ï¼Œå¦‚ IPã€ARP ç­‰ã€‚è¿™é‡Œçš„ä¾‹å­åˆ™æ˜¯ IP ã€‚ â‘¥ IP æ¨¡å—çš„å¤„ç† IP æ¨¡å—æ¥æ”¶åˆ° æ•°æ®åä¹Ÿåšç±»ä¼¼çš„å¤„ç†ã€‚ä»åŒ…é¦–éƒ¨ä¸­åˆ¤æ–­æ­¤ IP åœ°å€æ˜¯å¦ä¸è‡ªå·±çš„ IP åœ°å€åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™æ ¹æ®é¦–éƒ¨çš„åè®®ç±»å‹å°†æ•°æ®å‘é€ç»™å¯¹åº”çš„æ¨¡å—ï¼Œå¦‚ TCPã€UDPã€‚è¿™é‡Œçš„ä¾‹å­åˆ™æ˜¯ TCPã€‚ å¦å¤–å—ï¼Œå¯¹äºæœ‰è·¯ç”±å™¨çš„æƒ…å†µï¼Œæ¥æ”¶ç«¯åœ°å€å¾€å¾€ä¸æ˜¯è‡ªå·±çš„åœ°å€ï¼Œæ­¤æ—¶ï¼Œéœ€è¦å€ŸåŠ©è·¯ç”±æ§åˆ¶è¡¨ï¼Œåœ¨è°ƒæŸ¥åº”è¯¥é€å¾€çš„ä¸»æœºæˆ–è·¯ç”±å™¨ä¹‹åå†è¿›è¡Œè½¬å‘æ•°æ®ã€‚ â‘¦ TCP æ¨¡å—çš„å¤„ç† åœ¨ TCP æ¨¡å—ä¸­ï¼Œé¦–å…ˆä¼šè®¡ç®—ä¸€ä¸‹æ ¡éªŒå’Œï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦è¢«ç ´åã€‚ç„¶åæ£€æŸ¥æ˜¯å¦åœ¨æŒ‰ç…§åºå·æ¥æ”¶æ•°æ®ã€‚æœ€åæ£€æŸ¥ç«¯å£å·ï¼Œç¡®å®šå…·ä½“çš„åº”ç”¨ç¨‹åºã€‚æ•°æ®è¢«å®Œæ•´åœ°æ¥æ”¶ä»¥åï¼Œä¼šä¼ ç»™ç”±ç«¯å£å·è¯†åˆ«çš„åº”ç”¨ç¨‹åºã€‚ â‘§ åº”ç”¨ç¨‹åºçš„å¤„ç† æ¥æ”¶ç«¯åº”ç”¨ç¨‹åºä¼šç›´æ¥æ¥æ”¶å‘é€ç«¯å‘é€çš„æ•°æ®ã€‚é€šè¿‡è§£ææ•°æ®ï¼Œå±•ç¤ºç›¸åº”çš„å†…å®¹ã€‚ ä¸‰ã€ä¼ è¾“å±‚ä¸­çš„ TCP å’Œ UDP TCP/IP ä¸­æœ‰ä¸¤ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„ä¼ è¾“å±‚åè®®ï¼Œåˆ†åˆ«æ˜¯ TCP å’Œ UDPã€‚ TCP æ˜¯é¢å‘è¿æ¥çš„ã€å¯é çš„æµåè®®ã€‚æµå°±æ˜¯æŒ‡ä¸é—´æ–­çš„æ•°æ®ç»“æ„ï¼Œå½“åº”ç”¨ç¨‹åºé‡‡ç”¨ TCP å‘é€æ¶ˆæ¯æ—¶ï¼Œè™½ç„¶å¯ä»¥ä¿è¯å‘é€çš„é¡ºåºï¼Œä½†è¿˜æ˜¯çŠ¹å¦‚æ²¡æœ‰ä»»ä½•é—´éš”çš„æ•°æ®æµå‘é€ç»™æ¥æ”¶ç«¯ã€‚TCP ä¸ºæä¾›å¯é æ€§ä¼ è¾“ï¼Œå®è¡Œâ€œé¡ºåºæ§åˆ¶â€æˆ–â€œé‡å‘æ§åˆ¶â€æœºåˆ¶ã€‚æ­¤å¤–è¿˜å…·å¤‡â€œæµæ§åˆ¶ï¼ˆæµé‡æ§åˆ¶ï¼‰â€ã€â€œæ‹¥å¡æ§åˆ¶â€ã€æé«˜ç½‘ç»œåˆ©ç”¨ç‡ç­‰ä¼—å¤šåŠŸèƒ½ã€‚ UDP æ˜¯ä¸å…·æœ‰å¯é æ€§çš„æ•°æ®æŠ¥åè®®ã€‚ç»†å¾®çš„å¤„ç†å®ƒä¼šäº¤ç»™ä¸Šå±‚çš„åº”ç”¨å»å®Œæˆã€‚åœ¨ UDP çš„æƒ…å†µä¸‹ï¼Œè™½ç„¶å¯ä»¥ç¡®ä¿å‘é€æ¶ˆæ¯çš„å¤§å°ï¼Œå´ä¸èƒ½ä¿è¯æ¶ˆæ¯ä¸€å®šä¼šåˆ°è¾¾ã€‚å› æ­¤ï¼Œåº”ç”¨æœ‰æ—¶ä¼šæ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œé‡å‘å¤„ç†ã€‚ TCP å’Œ UDP çš„ä¼˜ç¼ºç‚¹æ— æ³•ç®€å•åœ°ã€ç»å¯¹åœ°å»åšæ¯”è¾ƒï¼šTCP ç”¨äºåœ¨ä¼ è¾“å±‚æœ‰å¿…è¦å®ç°å¯é ä¼ è¾“çš„æƒ…å†µï¼›è€Œåœ¨ä¸€æ–¹é¢ï¼ŒUDP ä¸»è¦ç”¨äºé‚£äº›å¯¹é«˜é€Ÿä¼ è¾“å’Œå®æ—¶æ€§æœ‰è¾ƒé«˜è¦æ±‚çš„é€šä¿¡æˆ–å¹¿æ’­é€šä¿¡ã€‚TCP å’Œ UDP åº”è¯¥æ ¹æ®åº”ç”¨çš„ç›®çš„æŒ‰éœ€ä½¿ç”¨ã€‚ 3.1ç«¯å£å· æ•°æ®é“¾è·¯å’Œ IP ä¸­çš„åœ°å€ï¼Œåˆ†åˆ«æŒ‡çš„æ˜¯ MAC åœ°å€å’Œ IP åœ°å€ã€‚å‰è€…ç”¨æ¥è¯†åˆ«åŒä¸€é“¾è·¯ä¸­ä¸åŒçš„è®¡ç®—æœºï¼Œåè€…ç”¨æ¥è¯†åˆ« TCP/IP ç½‘ç»œä¸­äº’è¿çš„ä¸»æœºå’Œè·¯ç”±å™¨ã€‚åœ¨ä¼ è¾“å±‚ä¹Ÿæœ‰è¿™ç§ç±»ä¼¼äºåœ°å€çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯ç«¯å£å·ã€‚ç«¯å£å·ç”¨æ¥è¯†åˆ«åŒä¸€å°è®¡ç®—æœºä¸­è¿›è¡Œé€šä¿¡çš„ä¸åŒåº”ç”¨ç¨‹åºã€‚å› æ­¤ï¼Œå®ƒä¹Ÿè¢«ç§°ä¸ºç¨‹åºåœ°å€ã€‚ 3.1.1 æ ¹æ®ç«¯å£å·è¯†åˆ«åº”ç”¨ ä¸€å°è®¡ç®—æœºä¸ŠåŒæ—¶å¯ä»¥è¿è¡Œå¤šä¸ªç¨‹åºã€‚ä¼ è¾“å±‚åè®®æ­£æ˜¯åˆ©ç”¨è¿™äº›ç«¯å£å·è¯†åˆ«æœ¬æœºä¸­æ­£åœ¨è¿›è¡Œé€šä¿¡çš„åº”ç”¨ç¨‹åºï¼Œå¹¶å‡†ç¡®åœ°å°†æ•°æ®ä¼ è¾“ã€‚ æ•°æ®ç«¯å£å·è¯†åˆ«åº”ç”¨ 3.1.2 é€šè¿‡ IP åœ°å€ã€ç«¯å£å·ã€åè®®å·è¿›è¡Œé€šä¿¡è¯†åˆ« ä»…å‡­ç›®æ ‡ç«¯å£å·è¯†åˆ«æŸä¸€ä¸ªé€šä¿¡æ˜¯è¿œè¿œä¸å¤Ÿçš„ã€‚ é€šè¿‡ç«¯å£å·ã€IPåœ°å€ã€åè®®å·è¿›è¡Œé€šä¿¡è¯†åˆ« â‘  å’Œâ‘¡ çš„é€šä¿¡æ˜¯åœ¨ä¸¤å°è®¡ç®—æœºä¸Šè¿›è¡Œçš„ã€‚å®ƒä»¬çš„ç›®æ ‡ç«¯å£å·ç›¸åŒï¼Œéƒ½æ˜¯80ã€‚è¿™é‡Œå¯ä»¥æ ¹æ®æºç«¯å£å·åŠ ä»¥åŒºåˆ†ã€‚ â‘¢ å’Œ â‘  çš„ç›®æ ‡ç«¯å£å·å’Œæºç«¯å£å·å®Œå…¨ç›¸åŒï¼Œä½†å®ƒä»¬å„è‡ªçš„æº IP åœ°å€ä¸åŒã€‚ æ­¤å¤–ï¼Œå½“ IP åœ°å€å’Œç«¯å£å·å…¨éƒ½ä¸€æ ·æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡åè®®å·æ¥åŒºåˆ†ï¼ˆTCP å’Œ UDPï¼‰ 3.1.3 ç«¯å£å·çš„ç¡®å®š æ ‡å‡†æ—¢å®šçš„ç«¯å£å·ï¼šè¿™ç§æ–¹æ³•ä¹Ÿå«é™æ€æ–¹æ³•ã€‚å®ƒæ˜¯æŒ‡æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½æœ‰å…¶æŒ‡å®šçš„ç«¯å£å·ã€‚ä½†å¹¶ä¸æ˜¯è¯´å¯ä»¥éšæ„ä½¿ç”¨ä»»ä½•ä¸€ä¸ªç«¯å£å·ã€‚ä¾‹å¦‚ HTTPã€FTPã€TELNET ç­‰å¹¿ä¸ºä½¿ç”¨çš„åº”ç”¨åè®®ä¸­æ‰€ä½¿ç”¨çš„ç«¯å£å·å°±æ˜¯å›ºå®šçš„ã€‚è¿™äº›ç«¯å£å·è¢«ç§°ä¸ºçŸ¥åç«¯å£å·ï¼Œåˆ†å¸ƒåœ¨ 0~1023 ä¹‹é—´ï¼›é™¤çŸ¥åç«¯å£å·ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç«¯å£å·è¢«æ­£å¼æ³¨å†Œï¼Œå®ƒä»¬åˆ†å¸ƒåœ¨ 1024~49151 ä¹‹é—´ï¼Œä¸è¿‡è¿™äº›ç«¯å£å·å¯ç”¨äºä»»ä½•é€šä¿¡ç”¨é€”ã€‚ æ—¶åºåˆ†é…æ³•ï¼šæœåŠ¡å™¨æœ‰å¿…è¦ç¡®å®šç›‘å¬ç«¯å£å·ï¼Œä½†æ˜¯æ¥å—æœåŠ¡çš„å®¢æˆ·ç«¯æ²¡å¿…è¦ç¡®å®šç«¯å£å·ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸‹ï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå®Œå…¨å¯ä»¥ä¸ç”¨è‡ªå·±è®¾ç½®ç«¯å£å·ï¼Œè€Œå…¨æƒäº¤ç»™æ“ä½œç³»ç»Ÿè¿›è¡Œåˆ†é…ã€‚åŠ¨æ€åˆ†é…çš„ç«¯å£å·èŒƒå›´åœ¨ 49152~65535 ä¹‹é—´ã€‚ 3.1.4 ç«¯å£å·ä¸åè®® ç«¯å£å·ç”±å…¶ä½¿ç”¨çš„ä¼ è¾“å±‚åè®®å†³å®šã€‚å› æ­¤ï¼Œä¸åŒçš„ä¼ è¾“å±‚åè®®å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç«¯å£å·ã€‚ æ­¤å¤–ï¼Œé‚£äº›çŸ¥åç«¯å£å·ä¸ä¼ è¾“å±‚åè®®å¹¶æ— å…³ç³»ã€‚åªè¦ç«¯å£ä¸€è‡´éƒ½å°†åˆ†é…åŒä¸€ç§åº”ç”¨ç¨‹åºè¿›è¡Œå¤„ç†ã€‚ 3.2 UDP UDP ä¸æä¾›å¤æ‚çš„æ§åˆ¶æœºåˆ¶ï¼Œåˆ©ç”¨ IP æä¾›é¢å‘æ— è¿æ¥çš„é€šä¿¡æœåŠ¡ã€‚ å¹¶ä¸”å®ƒæ˜¯å°†åº”ç”¨ç¨‹åºå‘æ¥çš„æ•°æ®åœ¨æ”¶åˆ°çš„é‚£ä¸€åˆ»ï¼Œç«‹å³æŒ‰ç…§åŸæ ·å‘é€åˆ°ç½‘ç»œä¸Šçš„ä¸€ç§æœºåˆ¶ã€‚å³ä½¿æ˜¯å‡ºç°ç½‘ç»œæ‹¥å µçš„æƒ…å†µï¼ŒUDP ä¹Ÿæ— æ³•è¿›è¡Œæµé‡æ§åˆ¶ç­‰é¿å…ç½‘ç»œæ‹¥å¡è¡Œä¸ºã€‚ æ­¤å¤–ï¼Œä¼ è¾“é€”ä¸­å‡ºç°ä¸¢åŒ…ï¼ŒUDP ä¹Ÿä¸è´Ÿè´£é‡å‘ã€‚ ç”šè‡³å½“åŒ…çš„åˆ°è¾¾é¡ºåºå‡ºç°ä¹±åºæ—¶ä¹Ÿæ²¡æœ‰çº æ­£çš„åŠŸèƒ½ã€‚ å¦‚æœéœ€è¦ä»¥ä¸Šçš„ç»†èŠ‚æ§åˆ¶ï¼Œä¸å¾—ä¸äº¤ç”±é‡‡ç”¨ UDP çš„åº”ç”¨ç¨‹åºå»å¤„ç†ã€‚ UDP å¸¸ç”¨äºä¸€ä¸‹å‡ ä¸ªæ–¹é¢ï¼š1.åŒ…æ€»é‡è¾ƒå°‘çš„é€šä¿¡ï¼ˆDNSã€SNMPç­‰ï¼‰ï¼›2.è§†é¢‘ã€éŸ³é¢‘ç­‰å¤šåª’ä½“é€šä¿¡ï¼ˆå³æ—¶é€šä¿¡ï¼‰ï¼›3.é™å®šäº LAN ç­‰ç‰¹å®šç½‘ç»œä¸­çš„åº”ç”¨é€šä¿¡ï¼›4.å¹¿æ’­é€šä¿¡ï¼ˆå¹¿æ’­ã€å¤šæ’­ï¼‰ã€‚ 3.3 TCP TCP ä¸ UDP çš„åŒºåˆ«ç›¸å½“å¤§ã€‚å®ƒå……åˆ†åœ°å®ç°äº†æ•°æ®ä¼ è¾“æ—¶å„ç§æ§åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥è¿›è¡Œä¸¢åŒ…æ—¶çš„é‡å‘æ§åˆ¶ï¼Œè¿˜å¯ä»¥å¯¹æ¬¡åºä¹±æ‰çš„åˆ†åŒ…è¿›è¡Œé¡ºåºæ§åˆ¶ã€‚è€Œè¿™äº›åœ¨ UDP ä¸­éƒ½æ²¡æœ‰ã€‚ æ­¤å¤–ï¼ŒTCP ä½œä¸ºä¸€ç§é¢å‘æœ‰è¿æ¥çš„åè®®ï¼Œåªæœ‰åœ¨ç¡®è®¤é€šä¿¡å¯¹ç«¯å­˜åœ¨æ—¶æ‰ä¼šå‘é€æ•°æ®ï¼Œä»è€Œå¯ä»¥æ§åˆ¶é€šä¿¡æµé‡çš„æµªè´¹ã€‚ æ ¹æ® TCP çš„è¿™äº›æœºåˆ¶ï¼Œåœ¨ IP è¿™ç§æ— è¿æ¥çš„ç½‘ç»œä¸Šä¹Ÿèƒ½å¤Ÿå®ç°é«˜å¯é æ€§çš„é€šä¿¡ï¼ˆ ä¸»è¦é€šè¿‡æ£€éªŒå’Œã€åºåˆ—å·ã€ç¡®è®¤åº”ç­”ã€é‡å‘æ§åˆ¶ã€è¿æ¥ç®¡ç†ä»¥åŠçª—å£æ§åˆ¶ç­‰æœºåˆ¶å®ç°ï¼‰ã€‚ 3.3.1 ä¸‰æ¬¡æ¡æ‰‹ï¼ˆé‡ç‚¹ï¼‰ TCP æä¾›é¢å‘æœ‰è¿æ¥çš„é€šä¿¡ä¼ è¾“ã€‚é¢å‘æœ‰è¿æ¥æ˜¯æŒ‡åœ¨æ•°æ®é€šä¿¡å¼€å§‹ä¹‹å‰å…ˆåšå¥½ä¸¤ç«¯ä¹‹é—´çš„å‡†å¤‡å·¥ä½œã€‚ æ‰€è°“ä¸‰æ¬¡æ¡æ‰‹æ˜¯æŒ‡å»ºç«‹ä¸€ä¸ª TCP è¿æ¥æ—¶éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯æ€»å…±å‘é€ä¸‰ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„å»ºç«‹ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æ‰§è¡Œconnectæ¥è§¦å‘ã€‚ ä¸‹é¢æ¥çœ‹çœ‹ä¸‰æ¬¡æ¡æ‰‹çš„æµç¨‹å›¾ï¼š ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å°†æ ‡å¿—ä½SYNç½®ä¸º1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=Jï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯è¿›å…¥SYN_SENTçŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯ç¡®è®¤ã€‚ ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡å™¨ç«¯æ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½SYN=1çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨ç«¯å°†æ ‡å¿—ä½SYNå’ŒACKéƒ½ç½®ä¸º1ï¼Œack=J+1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=Kï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™å®¢æˆ·ç«¯ä»¥ç¡®è®¤è¿æ¥è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯è¿›å…¥SYN_RCVDçŠ¶æ€ã€‚ ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°ç¡®è®¤åï¼Œæ£€æŸ¥ackæ˜¯å¦ä¸ºJ+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ACKç½®ä¸º1ï¼Œack=K+1ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯æ£€æŸ¥ackæ˜¯å¦ä¸ºK+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œéšåå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ä¹‹é—´å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®äº†ã€‚ 3.3.2 å››æ¬¡æŒ¥æ‰‹ï¼ˆé‡ç‚¹ï¼‰ å››æ¬¡æŒ¥æ‰‹å³ç»ˆæ­¢TCPè¿æ¥ï¼Œå°±æ˜¯æŒ‡æ–­å¼€ä¸€ä¸ªTCPè¿æ¥æ—¶ï¼Œéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ€»å…±å‘é€4ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„æ–­å¼€ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯ä»»ä¸€æ–¹æ‰§è¡Œcloseæ¥è§¦å‘ã€‚ ç”±äºTCPè¿æ¥æ˜¯å…¨åŒå·¥çš„ï¼Œå› æ­¤ï¼Œæ¯ä¸ªæ–¹å‘éƒ½å¿…é¡»è¦å•ç‹¬è¿›è¡Œå…³é—­ï¼Œè¿™ä¸€åŸåˆ™æ˜¯å½“ä¸€æ–¹å®Œæˆæ•°æ®å‘é€ä»»åŠ¡åï¼Œå‘é€ä¸€ä¸ªFINæ¥ç»ˆæ­¢è¿™ä¸€æ–¹å‘çš„è¿æ¥ï¼Œæ”¶åˆ°ä¸€ä¸ªFINåªæ˜¯æ„å‘³ç€è¿™ä¸€æ–¹å‘ä¸Šæ²¡æœ‰æ•°æ®æµåŠ¨äº†ï¼Œå³ä¸ä¼šå†æ”¶åˆ°æ•°æ®äº†ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªTCPè¿æ¥ä¸Šä»ç„¶èƒ½å¤Ÿå‘é€æ•°æ®ï¼Œç›´åˆ°è¿™ä¸€æ–¹å‘ä¹Ÿå‘é€äº†FINã€‚é¦–å…ˆè¿›è¡Œå…³é—­çš„ä¸€æ–¹å°†æ‰§è¡Œä¸»åŠ¨å…³é—­ï¼Œè€Œå¦ä¸€æ–¹åˆ™æ‰§è¡Œè¢«åŠ¨å…³é—­ã€‚ ä¸‹é¢æ¥çœ‹çœ‹å››æ¬¡æŒ¥æ‰‹çš„æµç¨‹å›¾ï¼š ä¸­æ–­è¿æ¥ç«¯å¯ä»¥æ˜¯å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨ç«¯ã€‚ ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªFIN=Mï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ç«¯çš„æ•°æ®ä¼ é€ï¼Œå®¢æˆ·ç«¯è¿›å…¥FIN_WAIT_1çŠ¶æ€ã€‚æ„æ€æ˜¯è¯´\"æˆ‘å®¢æˆ·ç«¯æ²¡æœ‰æ•°æ®è¦å‘ç»™ä½ äº†\"ï¼Œä½†æ˜¯å¦‚æœä½ æœåŠ¡å™¨ç«¯è¿˜æœ‰æ•°æ®æ²¡æœ‰å‘é€å®Œæˆï¼Œåˆ™ä¸å¿…æ€¥ç€å…³é—­è¿æ¥ï¼Œå¯ä»¥ç»§ç»­å‘é€æ•°æ®ã€‚ ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡å™¨ç«¯æ”¶åˆ°FINåï¼Œå…ˆå‘é€ack=M+1ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œä½ çš„è¯·æ±‚æˆ‘æ”¶åˆ°äº†ï¼Œä½†æ˜¯æˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œè¯·ç»§ç»­ä½ ç­‰æˆ‘çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±è¿›å…¥FIN_WAIT_2 çŠ¶æ€ï¼Œç»§ç»­ç­‰å¾…æœåŠ¡å™¨ç«¯çš„FINæŠ¥æ–‡ã€‚ ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šå½“æœåŠ¡å™¨ç«¯ç¡®å®šæ•°æ®å·²å‘é€å®Œæˆï¼Œåˆ™å‘å®¢æˆ·ç«¯å‘é€FIN=NæŠ¥æ–‡ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå¥½äº†ï¼Œæˆ‘è¿™è¾¹æ•°æ®å‘å®Œäº†ï¼Œå‡†å¤‡å¥½å…³é—­è¿æ¥äº†ã€‚æœåŠ¡å™¨ç«¯è¿›å…¥LAST_ACKçŠ¶æ€ã€‚ ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°FIN=NæŠ¥æ–‡åï¼Œå°±çŸ¥é“å¯ä»¥å…³é—­è¿æ¥äº†ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯ä¸ç›¸ä¿¡ç½‘ç»œï¼Œæ€•æœåŠ¡å™¨ç«¯ä¸çŸ¥é“è¦å…³é—­ï¼Œæ‰€ä»¥å‘é€ack=N+1åè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œå¦‚æœServerç«¯æ²¡æœ‰æ”¶åˆ°ACKåˆ™å¯ä»¥é‡ä¼ ã€‚æœåŠ¡å™¨ç«¯æ”¶åˆ°ACKåï¼Œå°±çŸ¥é“å¯ä»¥æ–­å¼€è¿æ¥äº†ã€‚å®¢æˆ·ç«¯ç­‰å¾…äº†2MSLåä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œåˆ™è¯æ˜æœåŠ¡å™¨ç«¯å·²æ­£å¸¸å…³é—­ï¼Œé‚£å¥½ï¼Œæˆ‘å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚æœ€ç»ˆå®Œæˆäº†å››æ¬¡æ¡æ‰‹ã€‚ ä¸Šé¢æ˜¯ä¸€æ–¹ä¸»åŠ¨å…³é—­ï¼Œå¦ä¸€æ–¹è¢«åŠ¨å…³é—­çš„æƒ…å†µï¼Œå®é™…ä¸­è¿˜ä¼šå‡ºç°åŒæ—¶å‘èµ·ä¸»åŠ¨å…³é—­çš„æƒ…å†µï¼Œ å…·ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š 3.3.3 é€šè¿‡åºåˆ—å·ä¸ç¡®è®¤åº”ç­”æé«˜å¯é æ€§ åœ¨ TCP ä¸­ï¼Œå½“å‘é€ç«¯çš„æ•°æ®åˆ°è¾¾æ¥æ”¶ä¸»æœºæ—¶ï¼Œæ¥æ”¶ç«¯ä¸»æœºä¼šè¿”å›ä¸€ä¸ªå·²æ”¶åˆ°æ¶ˆæ¯çš„é€šçŸ¥ã€‚è¿™ä¸ªæ¶ˆæ¯å«åšç¡®è®¤åº”ç­”ï¼ˆACKï¼‰ã€‚å½“å‘é€ç«¯å°†æ•°æ®å‘å‡ºä¹‹åä¼šç­‰å¾…å¯¹ç«¯çš„ç¡®è®¤åº”ç­”ã€‚å¦‚æœæœ‰ç¡®è®¤åº”ç­”ï¼Œè¯´æ˜æ•°æ®å·²ç»æˆåŠŸåˆ°è¾¾å¯¹ç«¯ã€‚åä¹‹ï¼Œåˆ™æ•°æ®ä¸¢å¤±çš„å¯èƒ½æ€§å¾ˆå¤§ã€‚ åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰ç­‰å¾…åˆ°ç¡®è®¤åº”ç­”ï¼Œå‘é€ç«¯å°±å¯ä»¥è®¤ä¸ºæ•°æ®å·²ç»ä¸¢å¤±ï¼Œå¹¶è¿›è¡Œé‡å‘ã€‚ç”±æ­¤ï¼Œå³ä½¿äº§ç”Ÿäº†ä¸¢åŒ…ï¼Œä»ç„¶èƒ½å¤Ÿä¿è¯æ•°æ®èƒ½å¤Ÿåˆ°è¾¾å¯¹ç«¯ï¼Œå®ç°å¯é ä¼ è¾“ã€‚ æœªæ”¶åˆ°ç¡®è®¤åº”ç­”å¹¶ä¸æ„å‘³ç€æ•°æ®ä¸€å®šä¸¢å¤±ã€‚ä¹Ÿæœ‰å¯èƒ½æ˜¯æ•°æ®å¯¹æ–¹å·²ç»æ”¶åˆ°ï¼Œåªæ˜¯è¿”å›çš„ç¡®è®¤åº”ç­”åœ¨é€”ä¸­ä¸¢å¤±ã€‚è¿™ç§æƒ…å†µä¹Ÿä¼šå¯¼è‡´å‘é€ç«¯è¯¯ä»¥ä¸ºæ•°æ®æ²¡æœ‰åˆ°è¾¾ç›®çš„åœ°è€Œé‡å‘æ•°æ®ã€‚ æ­¤å¤–ï¼Œä¹Ÿæœ‰å¯èƒ½å› ä¸ºä¸€äº›å…¶ä»–åŸå› å¯¼è‡´ç¡®è®¤åº”ç­”å»¶è¿Ÿåˆ°è¾¾ï¼Œåœ¨æºä¸»æœºé‡å‘æ•°æ®ä»¥åæ‰åˆ°è¾¾çš„æƒ…å†µä¹Ÿå±¡è§ä¸é²œã€‚æ­¤æ—¶ï¼Œæºä¸»æœºåªè¦æŒ‰ç…§æœºåˆ¶é‡å‘æ•°æ®å³å¯ã€‚ å¯¹äºç›®æ ‡ä¸»æœºæ¥è¯´ï¼Œåå¤æ”¶åˆ°ç›¸åŒçš„æ•°æ®æ˜¯ä¸å¯å–çš„ã€‚ä¸ºäº†å¯¹ä¸Šå±‚åº”ç”¨æä¾›å¯é çš„ä¼ è¾“ï¼Œç›®æ ‡ä¸»æœºå¿…é¡»æ”¾å¼ƒé‡å¤çš„æ•°æ®åŒ…ã€‚ä¸ºæ­¤æˆ‘ä»¬å¼•å…¥äº†åºåˆ—å·ã€‚ åºåˆ—å·æ˜¯æŒ‰ç…§é¡ºåºç»™å‘é€æ•°æ®çš„æ¯ä¸€ä¸ªå­—èŠ‚ï¼ˆ8ä½å­—èŠ‚ï¼‰éƒ½æ ‡ä¸Šå·ç çš„ç¼–å·ã€‚æ¥æ”¶ç«¯æŸ¥è¯¢æ¥æ”¶æ•°æ® TCP é¦–éƒ¨ä¸­çš„åºåˆ—å·å’Œæ•°æ®çš„é•¿åº¦ï¼Œå°†è‡ªå·±ä¸‹ä¸€æ­¥åº”è¯¥æ¥æ”¶çš„åºåˆ—å·ä½œä¸ºç¡®è®¤åº”ç­”è¿”é€å›å»ã€‚é€šè¿‡åºåˆ—å·å’Œç¡®è®¤åº”ç­”å·ï¼ŒTCP èƒ½å¤Ÿè¯†åˆ«æ˜¯å¦å·²ç»æ¥æ”¶æ•°æ®ï¼Œåˆèƒ½å¤Ÿåˆ¤æ–­æ˜¯å¦éœ€è¦æ¥æ”¶ï¼Œä»è€Œå®ç°å¯é ä¼ è¾“ã€‚ åºåˆ—å·å’Œç¡®è®¤åº”ç­” 3.3.4 é‡å‘è¶…æ—¶çš„ç¡®å®š é‡å‘è¶…æ—¶æ˜¯æŒ‡åœ¨é‡å‘æ•°æ®ä¹‹å‰ï¼Œç­‰å¾…ç¡®è®¤åº”ç­”åˆ°æ¥çš„é‚£ä¸ªç‰¹å®šæ—¶é—´é—´éš”ã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ä»æœªæ”¶åˆ°ç¡®è®¤åº”ç­”ï¼Œå‘é€ç«¯å°†è¿›è¡Œæ•°æ®é‡å‘ã€‚æœ€ç†æƒ³çš„æ˜¯ï¼Œæ‰¾åˆ°ä¸€ä¸ªæœ€å°æ—¶é—´ï¼Œå®ƒèƒ½ä¿è¯â€œç¡®è®¤åº”ç­”ä¸€å®šèƒ½åœ¨è¿™ä¸ªæ—¶é—´å†…è¿”å›â€ã€‚ TCP è¦æ±‚ä¸è®ºå¤„åœ¨ä½•ç§ç½‘ç»œç¯å¢ƒä¸‹éƒ½è¦æä¾›é«˜æ€§èƒ½é€šä¿¡ï¼Œå¹¶ä¸”æ— è®ºç½‘ç»œæ‹¥å µæƒ…å†µå‘ç”Ÿä½•ç§å˜åŒ–ï¼Œéƒ½å¿…é¡»ä¿æŒè¿™ä¸€ç‰¹æ€§ã€‚ä¸ºæ­¤ï¼Œå®ƒåœ¨æ¯æ¬¡å‘åŒ…æ—¶éƒ½ä¼šè®¡ç®—å¾€è¿”æ—¶é—´åŠå…¶åå·®ã€‚å°†è¿™ä¸ªå¾€è¿”æ—¶é—´å’Œåå·®æ—¶é—´ç›¸åŠ ï¼Œé‡å‘è¶…æ—¶çš„æ—¶é—´å°±æ˜¯æ¯”è¿™ä¸ªæ€»å’Œè¦ç¨å¤§ä¸€ç‚¹çš„å€¼ã€‚ åœ¨ BSD çš„ Unix ä»¥åŠ Windows ç³»ç»Ÿä¸­ï¼Œè¶…æ—¶éƒ½ä»¥0.5ç§’ä¸ºå•ä½è¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤é‡å‘è¶…æ—¶éƒ½æ˜¯0.5ç§’çš„æ•´æ•°å€ã€‚ä¸è¿‡ï¼Œæœ€åˆå…¶é‡å‘è¶…æ—¶çš„é»˜è®¤å€¼ä¸€èˆ¬è®¾ç½®ä¸º6ç§’å·¦å³ã€‚ æ•°æ®è¢«é‡å‘ä¹‹åè‹¥è¿˜æ˜¯æ”¶ä¸åˆ°ç¡®è®¤åº”ç­”ï¼Œåˆ™è¿›è¡Œå†æ¬¡å‘é€ã€‚æ­¤æ—¶ï¼Œç­‰å¾…ç¡®è®¤åº”ç­”çš„æ—¶é—´å°†ä¼šä»¥2å€ã€4å€çš„æŒ‡æ•°å‡½æ•°å»¶é•¿ã€‚ æ­¤å¤–ï¼Œæ•°æ®ä¹Ÿä¸ä¼šè¢«æ— é™ã€åå¤åœ°é‡å‘ã€‚è¾¾åˆ°ä¸€å®šé‡å‘æ¬¡æ•°ä¹‹åï¼Œå¦‚æœä»æ²¡æœ‰ä»»ä½•ç¡®è®¤åº”ç­”è¿”å›ï¼Œå°±ä¼šåˆ¤æ–­ä¸ºç½‘ç»œæˆ–å¯¹ç«¯ä¸»æœºå‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼ºåˆ¶å…³é—­è¿æ¥ã€‚å¹¶ä¸”é€šçŸ¥åº”ç”¨é€šä¿¡å¼‚å¸¸å¼ºè¡Œç»ˆæ­¢ã€‚ 3.3.5 ä»¥æ®µä¸ºå•ä½å‘é€æ•°æ® åœ¨å»ºç«‹ TCP è¿æ¥çš„åŒæ—¶ï¼Œä¹Ÿå¯ä»¥ç¡®å®šå‘é€æ•°æ®åŒ…çš„å•ä½ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°å…¶ä¸ºâ€œæœ€å¤§æ¶ˆæ¯é•¿åº¦â€ï¼ˆMSSï¼‰ã€‚æœ€ç†æƒ³çš„æƒ…å†µæ˜¯ï¼Œæœ€å¤§æ¶ˆæ¯é•¿åº¦æ­£å¥½æ˜¯ IP ä¸­ä¸ä¼šè¢«åˆ†ç‰‡å¤„ç†çš„æœ€å¤§æ•°æ®é•¿åº¦ã€‚ TCP åœ¨ä¼ é€å¤§é‡æ•°æ®æ—¶ï¼Œæ˜¯ä»¥ MSS çš„å¤§å°å°†æ•°æ®è¿›è¡Œåˆ†å‰²å‘é€ã€‚è¿›è¡Œé‡å‘æ—¶ä¹Ÿæ˜¯ä»¥ MSS ä¸ºå•ä½ã€‚ MSS åœ¨ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å€™ï¼Œåœ¨ä¸¤ç«¯ä¸»æœºä¹‹é—´è¢«è®¡ç®—å¾—å‡ºã€‚ä¸¤ç«¯çš„ä¸»æœºåœ¨å‘å‡ºå»ºç«‹è¿æ¥çš„è¯·æ±‚æ—¶ï¼Œä¼šåœ¨ TCP é¦–éƒ¨ä¸­å†™å…¥ MSS é€‰é¡¹ï¼Œå‘Šè¯‰å¯¹æ–¹è‡ªå·±çš„æ¥å£èƒ½å¤Ÿé€‚åº”çš„ MSS çš„å¤§å°ã€‚ç„¶åä¼šåœ¨ä¸¤è€…ä¹‹é—´é€‰æ‹©ä¸€ä¸ªè¾ƒå°çš„å€¼æŠ•å…¥ä½¿ç”¨ã€‚ 3.3.6 åˆ©ç”¨çª—å£æ§åˆ¶æé«˜é€Ÿåº¦ TCP ä»¥1ä¸ªæ®µä¸ºå•ä½ï¼Œæ¯å‘é€ä¸€ä¸ªæ®µè¿›è¡Œä¸€æ¬¡ç¡®è®¤åº”ç­”çš„å¤„ç†ã€‚è¿™æ ·çš„ä¼ è¾“æ–¹å¼æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯åŒ…çš„å¾€è¿”æ—¶é—´è¶Šé•¿é€šä¿¡æ€§èƒ½å°±è¶Šä½ã€‚ ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTCP å¼•å…¥äº†çª—å£è¿™ä¸ªæ¦‚å¿µã€‚ç¡®è®¤åº”ç­”ä¸å†æ˜¯ä»¥æ¯ä¸ªåˆ†æ®µï¼Œè€Œæ˜¯ä»¥æ›´å¤§çš„å•ä½è¿›è¡Œç¡®è®¤ï¼Œè½¬å‘æ—¶é—´å°†ä¼šè¢«å¤§å¹…åœ°ç¼©çŸ­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€ç«¯ä¸»æœºï¼Œåœ¨å‘é€äº†ä¸€ä¸ªæ®µä»¥åä¸å¿…è¦ä¸€ç›´ç­‰å¾…ç¡®è®¤åº”ç­”ï¼Œè€Œæ˜¯ç»§ç»­å‘é€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š çª—å£æ§åˆ¶ çª—å£å¤§å°å°±æ˜¯æŒ‡æ— éœ€ç­‰å¾…ç¡®è®¤åº”ç­”è€Œå¯ä»¥ç»§ç»­å‘é€æ•°æ®çš„æœ€å¤§å€¼ã€‚ä¸Šå›¾ä¸­çª—å£å¤§å°ä¸º4ä¸ªæ®µã€‚è¿™ä¸ªæœºåˆ¶å®ç°äº†ä½¿ç”¨å¤§é‡çš„ç¼“å†²åŒºï¼Œé€šè¿‡å¯¹å¤šä¸ªæ®µåŒæ—¶è¿›è¡Œç¡®è®¤åº”ç­”çš„åŠŸèƒ½ã€‚ 3.3.7 æ»‘åŠ¨çª—å£æ§åˆ¶ ä¸Šå›¾ä¸­çš„çª—å£å†…çš„æ•°æ®å³ä¾¿æ²¡æœ‰æ”¶åˆ°ç¡®è®¤åº”ç­”ä¹Ÿå¯ä»¥è¢«å‘é€å‡ºå»ã€‚ä¸è¿‡ï¼Œåœ¨æ•´ä¸ªçª—å£çš„ç¡®è®¤åº”ç­”æ²¡æœ‰åˆ°è¾¾ä¹‹å‰ï¼Œå¦‚æœå…¶ä¸­éƒ¨åˆ†æ•°æ®å‡ºç°ä¸¢åŒ…ï¼Œé‚£ä¹ˆå‘é€ç«¯ä»ç„¶è¦è´Ÿè´£é‡ä¼ ã€‚ä¸ºæ­¤ï¼Œå‘é€ç«¯ä¸»æœºéœ€è¦è®¾ç½®ç¼“å­˜ä¿ç•™è¿™äº›å¾…è¢«é‡ä¼ çš„æ•°æ®ï¼Œç›´åˆ°æ”¶åˆ°ä»–ä»¬çš„ç¡®è®¤åº”ç­”ã€‚ åœ¨æ»‘åŠ¨çª—å£ä»¥å¤–çš„éƒ¨åˆ†åŒ…æ‹¬æœªå‘é€çš„æ•°æ®ä»¥åŠå·²ç»ç¡®è®¤å¯¹ç«¯å·²æ”¶åˆ°çš„æ•°æ®ã€‚å½“æ•°æ®å‘å‡ºåè‹¥å¦‚æœŸæ”¶åˆ°ç¡®è®¤åº”ç­”å°±å¯ä»¥ä¸ç”¨å†è¿›è¡Œé‡å‘ï¼Œæ­¤æ—¶æ•°æ®å°±å¯ä»¥ä»ç¼“å­˜åŒºæ¸…é™¤ã€‚ æ”¶åˆ°ç¡®è®¤åº”ç­”çš„æƒ…å†µä¸‹ï¼Œå°†çª—å£æ»‘åŠ¨åˆ°ç¡®è®¤åº”ç­”ä¸­çš„åºåˆ—å·çš„ä½ç½®ã€‚è¿™æ ·å¯ä»¥é¡ºåºåœ°å°†å¤šä¸ªæ®µåŒæ—¶å‘é€æé«˜é€šä¿¡æ€§èƒ½ã€‚è¿™ç§æœºåˆ¶ä¹Ÿåˆ«ç§°ä¸ºæ»‘åŠ¨çª—å£æ§åˆ¶ã€‚ 3.3.8 çª—å£æ§åˆ¶ä¸­çš„é‡å‘æ§åˆ¶ åœ¨ä½¿ç”¨çª—å£æ§åˆ¶ä¸­ï¼Œ å‡ºç°ä¸¢åŒ…ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š â‘  ç¡®è®¤åº”ç­”æœªèƒ½è¿”å›çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®å·²ç»åˆ°è¾¾å¯¹ç«¯ï¼Œæ˜¯ä¸éœ€è¦å†è¿›è¡Œé‡å‘çš„ï¼Œå¦‚ä¸‹å›¾ï¼š â‘¡ æŸä¸ªæŠ¥æ–‡æ®µä¸¢å¤±çš„æƒ…å†µã€‚æ¥æ”¶ä¸»æœºå¦‚æœæ”¶åˆ°ä¸€ä¸ªè‡ªå·±åº”è¯¥æ¥æ”¶çš„åºåˆ—å·ä»¥å¤–çš„æ•°æ®æ—¶ï¼Œä¼šé’ˆå¯¹å½“å‰ä¸ºæ­¢æ”¶åˆ°æ•°æ®è¿”å›ç¡®è®¤åº”ç­”ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“æŸä¸€æŠ¥æ–‡æ®µä¸¢å¤±åï¼Œå‘é€ç«¯ä¼šä¸€ç›´æ”¶åˆ°åºå·ä¸º1001çš„ç¡®è®¤åº”ç­”ï¼Œå› æ­¤ï¼Œåœ¨çª—å£æ¯”è¾ƒå¤§ï¼Œåˆå‡ºç°æŠ¥æ–‡æ®µä¸¢å¤±çš„æƒ…å†µä¸‹ï¼ŒåŒä¸€ä¸ªåºåˆ—å·çš„ç¡®è®¤åº”ç­”å°†ä¼šè¢«é‡å¤ä¸æ–­åœ°è¿”å›ã€‚è€Œå‘é€ç«¯ä¸»æœºå¦‚æœè¿ç»­3æ¬¡æ”¶åˆ°åŒä¸€ä¸ªç¡®è®¤åº”ç­”ï¼Œå°±ä¼šå°†å…¶å¯¹åº”çš„æ•°æ®è¿›è¡Œé‡å‘ã€‚è¿™ç§æœºåˆ¶æ¯”ä¹‹å‰æåˆ°çš„è¶…æ—¶ç®¡ç†æ›´åŠ é«˜æ•ˆï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸ºé«˜é€Ÿé‡å‘æ§åˆ¶ã€‚ å››ã€ç½‘ç»œå±‚ä¸­çš„ IP åè®® IPï¼ˆIPv4ã€IPv6ï¼‰ç›¸å½“äº OSI å‚è€ƒæ¨¡å‹ä¸­çš„ç¬¬3å±‚â€”â€”ç½‘ç»œå±‚ã€‚ç½‘ç»œå±‚çš„ä¸»è¦ä½œç”¨æ˜¯â€œå®ç°ç»ˆç«¯èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡â€ã€‚è¿™ç§ç»ˆç«¯èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ä¹Ÿå«â€œç‚¹å¯¹ç‚¹é€šä¿¡â€ã€‚ ç½‘ç»œçš„ä¸‹ä¸€å±‚â€”â€”æ•°æ®é“¾è·¯å±‚çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨äº’è¿åŒä¸€ç§æ•°æ®é“¾è·¯çš„èŠ‚ç‚¹ä¹‹é—´è¿›è¡ŒåŒ…ä¼ é€’ã€‚è€Œä¸€æ—¦è·¨è¶Šå¤šç§æ•°æ®é“¾è·¯ï¼Œå°±éœ€è¦å€ŸåŠ©ç½‘ç»œå±‚ã€‚ç½‘ç»œå±‚å¯ä»¥è·¨è¶Šä¸åŒçš„æ•°æ®é“¾è·¯ï¼Œå³ä½¿æ˜¯åœ¨ä¸åŒçš„æ•°æ®é“¾è·¯ä¸Šä¹Ÿèƒ½å®ç°ä¸¤ç«¯èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®åŒ…ä¼ è¾“ã€‚ IP å¤§è‡´åˆ†ä¸ºä¸‰å¤§ä½œç”¨æ¨¡å—ï¼Œå®ƒä»¬æ˜¯ IP å¯»å€ã€è·¯ç”±ï¼ˆæœ€ç»ˆèŠ‚ç‚¹ä¸ºæ­¢çš„è½¬å‘ï¼‰ä»¥åŠ IP åˆ†åŒ…ä¸ç»„åŒ…ã€‚ 4.1 IP åœ°å€ 4.1.1 IP åœ°å€æ¦‚è¿° åœ¨è®¡ç®—æœºé€šä¿¡ä¸­ï¼Œä¸ºäº†è¯†åˆ«é€šä¿¡å¯¹ç«¯ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªç±»ä¼¼äºåœ°å€çš„è¯†åˆ«ç è¿›è¡Œæ ‡è¯†ã€‚åœ¨æ•°æ®é“¾è·¯ä¸­çš„ MAC åœ°å€æ­£æ˜¯ç”¨æ¥æ ‡è¯†åŒä¸€ä¸ªé“¾è·¯ä¸­ä¸åŒè®¡ç®—æœºçš„ä¸€ç§è¯†åˆ«ç ã€‚ ä½œä¸ºç½‘ç»œå±‚çš„ IP ,ä¹Ÿæœ‰è¿™ç§åœ°å€ä¿¡æ¯ï¼Œä¸€èˆ¬å«åš IP åœ°å€ã€‚IP åœ°å€ç”¨äºåœ¨â€œè¿æ¥åˆ°ç½‘ç»œä¸­çš„æ‰€æœ‰ä¸»æœºä¸­è¯†åˆ«å‡ºè¿›è¡Œé€šä¿¡çš„ç›®æ ‡åœ°å€â€ã€‚å› æ­¤ï¼Œåœ¨ TCP/IP é€šä¿¡ä¸­æ‰€æœ‰ä¸»æœºæˆ–è·¯ç”±å™¨å¿…é¡»è®¾å®šè‡ªå·±çš„ IP åœ°å€ã€‚ ä¸è®ºä¸€å°ä¸»æœºä¸å“ªç§æ•°æ®é“¾è·¯è¿æ¥ï¼Œå…¶ IP åœ°å€çš„å½¢å¼éƒ½ä¿æŒä¸å˜ã€‚ IP åœ°å€ï¼ˆIPv4 åœ°å€ï¼‰ç”±32ä½æ­£æ•´æ•°æ¥è¡¨ç¤ºã€‚IP åœ°å€åœ¨è®¡ç®—æœºå†…éƒ¨ä»¥äºŒè¿›åˆ¶æ–¹å¼è¢«å¤„ç†ã€‚ç„¶è€Œï¼Œç”±äºæˆ‘ä»¬å¹¶ä¸ä¹ æƒ¯äºé‡‡ç”¨äºŒè¿›åˆ¶æ–¹å¼ï¼Œæˆ‘ä»¬å°†32ä½çš„ IP åœ°å€ä»¥æ¯8ä½ä¸ºä¸€ç»„ï¼Œåˆ†æˆ4ç»„ï¼Œæ¯ç»„ä»¥ â€œ.â€ éš”å¼€ï¼Œå†å°†æ¯ç»„æ•°è½¬æ¢æˆåè¿›åˆ¶æ•°ã€‚å¦‚ä¸‹ï¼š 4.1.2 IP åœ°å€ç”±ç½‘ç»œå’Œä¸»æœºä¸¤éƒ¨åˆ†æ ‡è¯†ç»„æˆ å¦‚ä¸‹å›¾ï¼Œç½‘ç»œæ ‡è¯†åœ¨æ•°æ®é“¾è·¯çš„æ¯ä¸ªæ®µé…ç½®ä¸åŒçš„å€¼ã€‚ç½‘ç»œæ ‡è¯†å¿…é¡»ä¿è¯ç›¸äº’è¿æ¥çš„æ¯ä¸ªæ®µçš„åœ°å€ä¸ç›¸é‡å¤ã€‚è€Œç›¸åŒæ®µå†…ç›¸è¿çš„ä¸»æœºå¿…é¡»æœ‰ç›¸åŒçš„ç½‘ç»œåœ°å€ã€‚IP åœ°å€çš„â€œä¸»æœºæ ‡è¯†â€åˆ™ä¸å…è®¸åœ¨åŒä¸€ä¸ªç½‘æ®µå†…é‡å¤å‡ºç°ã€‚ç”±æ­¤ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç½‘ç»œåœ°å€å’Œä¸»æœºåœ°å€ï¼Œåœ¨ç›¸äº’è¿æ¥çš„æ•´ä¸ªç½‘ç»œä¸­ä¿è¯æ¯å°ä¸»æœºçš„ IP åœ°å€éƒ½ä¸ä¼šç›¸äº’é‡å ã€‚å³ IP åœ°å€å…·æœ‰äº†å”¯ä¸€æ€§ã€‚ IPåœ°å€çš„ä¸»æœºæ ‡è¯† å¦‚ä¸‹å›¾ï¼ŒIP åŒ…è¢«è½¬å‘åˆ°é€”ä¸­æŸä¸ªè·¯ç”±å™¨æ—¶ï¼Œæ­£æ˜¯åˆ©ç”¨ç›®æ ‡ IP åœ°å€çš„ç½‘ç»œæ ‡è¯†è¿›è¡Œè·¯ç”±ã€‚å› ä¸ºå³ä½¿ä¸çœ‹ä¸»æœºæ ‡è¯†ï¼Œåªè¦ä¸€è§åˆ°ç½‘ç»œæ ‡è¯†å°±èƒ½åˆ¤æ–­å‡ºæ˜¯å¦ä¸ºè¯¥ç½‘æ®µå†…çš„ä¸»æœºã€‚ IPåœ°å€çš„ç½‘ç»œæ ‡è¯† 4.1.3 IP åœ°å€çš„åˆ†ç±» IP åœ°å€åˆ†ä¸ºå››ä¸ªçº§åˆ«ï¼Œåˆ†åˆ«ä¸ºAç±»ã€Bç±»ã€Cç±»ã€Dç±»ã€‚å®ƒæ ¹æ® IP åœ°å€ä¸­ä»ç¬¬ 1 ä½åˆ°ç¬¬ 4 ä½çš„æ¯”ç‰¹åˆ—å¯¹å…¶ç½‘ç»œæ ‡è¯†å’Œä¸»æœºæ ‡è¯†è¿›è¡ŒåŒºåˆ†ã€‚ A ç±» IP åœ°å€æ˜¯é¦–ä½ä»¥ â€œ0â€ å¼€å¤´çš„åœ°å€ã€‚ä»ç¬¬ 1 ä½åˆ°ç¬¬ 8 ä½æ˜¯å®ƒçš„ç½‘ç»œæ ‡è¯†ã€‚ç”¨åè¿›åˆ¶è¡¨ç¤ºçš„è¯ï¼Œ0.0.0.0~127.0.0.0 æ˜¯ A ç±»çš„ç½‘ç»œåœ°å€ã€‚A ç±»åœ°å€çš„å 24 ä½ç›¸å½“äºä¸»æœºæ ‡è¯†ã€‚å› æ­¤ï¼Œä¸€ä¸ªç½‘æ®µå†…å¯å®¹çº³çš„ä¸»æœºåœ°å€ä¸Šé™ä¸º16,777,214ä¸ªã€‚ B ç±» IP åœ°å€æ˜¯å‰ä¸¤ä½ â€œ10â€ çš„åœ°å€ã€‚ä»ç¬¬ 1 ä½åˆ°ç¬¬ 16 ä½æ˜¯å®ƒçš„ç½‘ç»œæ ‡è¯†ã€‚ç”¨åè¿›åˆ¶è¡¨ç¤ºçš„è¯ï¼Œ128.0.0.0~191.255.0.0 æ˜¯ B ç±»çš„ç½‘ç»œåœ°å€ã€‚B ç±»åœ°å€çš„å 16 ä½ç›¸å½“äºä¸»æœºæ ‡è¯†ã€‚å› æ­¤ï¼Œä¸€ä¸ªç½‘æ®µå†…å¯å®¹çº³çš„ä¸»æœºåœ°å€ä¸Šé™ä¸º65,534ä¸ªã€‚ C ç±» IP åœ°å€æ˜¯å‰ä¸‰ä½ä¸º â€œ110â€ çš„åœ°å€ã€‚ä»ç¬¬ 1 ä½åˆ°ç¬¬ 24 ä½æ˜¯å®ƒçš„ç½‘ç»œæ ‡è¯†ã€‚ç”¨åè¿›åˆ¶è¡¨ç¤ºçš„è¯ï¼Œ192.0.0.0~223.255.255.0 æ˜¯ C ç±»çš„ç½‘ç»œåœ°å€ã€‚C ç±»åœ°å€çš„å 8 ä½ç›¸å½“äºä¸»æœºæ ‡è¯†ã€‚å› æ­¤ï¼Œä¸€ä¸ªç½‘æ®µå†…å¯å®¹çº³çš„ä¸»æœºåœ°å€ä¸Šé™ä¸º254ä¸ªã€‚ D ç±» IP åœ°å€æ˜¯å‰å››ä½ä¸º â€œ1110â€ çš„åœ°å€ã€‚ä»ç¬¬ 1 ä½åˆ°ç¬¬ 32 ä½æ˜¯å®ƒçš„ç½‘ç»œæ ‡è¯†ã€‚ç”¨åè¿›åˆ¶è¡¨ç¤ºçš„è¯ï¼Œ224.0.0.0~239.255.255.255 æ˜¯ D ç±»çš„ç½‘ç»œåœ°å€ã€‚D ç±»åœ°å€æ²¡æœ‰ä¸»æœºæ ‡è¯†ï¼Œå¸¸ç”¨äºå¤šæ’­ã€‚ åœ¨åˆ†é… IP åœ°å€æ—¶å…³äºä¸»æœºæ ‡è¯†æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ã€‚å³è¦ç”¨æ¯”ç‰¹ä½è¡¨ç¤ºä¸»æœºåœ°å€æ—¶ï¼Œä¸å¯ä»¥å…¨éƒ¨ä¸º 0 æˆ–å…¨éƒ¨ä¸º 1ã€‚å› ä¸ºå…¨éƒ¨ä¸º 0 åªæœ‰åœ¨è¡¨ç¤ºå¯¹åº”çš„ç½‘ç»œåœ°å€æˆ– IP åœ°å€ä¸å¯ä»¥è·çŸ¥çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨ã€‚è€Œå…¨éƒ¨ä¸º 1 çš„ä¸»æœºé€šå¸¸ä½œä¸ºå¹¿æ’­åœ°å€ã€‚å› æ­¤ï¼Œåœ¨åˆ†é…è¿‡ç¨‹ä¸­ï¼Œåº”è¯¥å»æ‰è¿™ä¸¤ç§æƒ…å†µã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ C ç±»åœ°å€æ¯ä¸ªç½‘æ®µæœ€å¤šåªèƒ½æœ‰ 254ï¼ˆ 28 - 2 = 254ï¼‰ä¸ªä¸»æœºåœ°å€çš„åŸå› ã€‚ 4.1.4 å¹¿æ’­åœ°å€ å¹¿æ’­åœ°å€ç”¨äºåœ¨åŒä¸€ä¸ªé“¾è·¯ä¸­ç›¸äº’è¿æ¥çš„ä¸»æœºä¹‹é—´å‘é€æ•°æ®åŒ…ã€‚å°† IP åœ°å€ä¸­çš„ä¸»æœºåœ°å€éƒ¨åˆ†å…¨éƒ¨è®¾ç½®ä¸º 1ï¼Œå°±æˆäº†å¹¿æ’­åœ°å€ã€‚ å¹¿æ’­åˆ†ä¸ºæœ¬åœ°å¹¿æ’­å’Œç›´æ¥å¹¿æ’­ä¸¤ç§ã€‚åœ¨æœ¬ç½‘ç»œå†…çš„å¹¿æ’­å«åšæœ¬åœ°å¹¿æ’­ï¼›åœ¨ä¸åŒç½‘ç»œä¹‹é—´çš„å¹¿æ’­å«åšç›´æ¥å¹¿æ’­ã€‚ 4.1.5 IP å¤šæ’­ å¤šæ’­ç”¨äºå°†åŒ…å‘é€ç»™ç‰¹å®šç»„å†…çš„æ‰€æœ‰ä¸»æœºã€‚ç”±äºå…¶ç›´æ¥ä½¿ç”¨ IP åœ°å€ï¼Œå› æ­¤ä¹Ÿä¸å­˜åœ¨å¯é ä¼ è¾“ã€‚ ç›¸æ¯”äºå¹¿æ’­ï¼Œå¤šæ’­æ—¢å¯ä»¥ç©¿é€è·¯ç”±å™¨ï¼Œåˆå¯ä»¥å®ç°åªç»™é‚£äº›å¿…è¦çš„ç»„å‘é€æ•°æ®åŒ…ã€‚è¯·çœ‹ä¸‹å›¾ï¼š IPå¤šæ’­ å¤šæ’­ä½¿ç”¨ D ç±»åœ°å€ã€‚å› æ­¤ï¼Œå¦‚æœä»é¦–ä½å¼€å§‹åˆ°ç¬¬ 4 ä½æ˜¯ â€œ1110â€ï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯å¤šæ’­åœ°å€ã€‚è€Œå‰©ä¸‹çš„ 28 ä½å¯ä»¥æˆä¸ºå¤šæ’­çš„ç»„ç¼–å·ã€‚ æ­¤å¤–ï¼Œ å¯¹äºå¤šæ’­ï¼Œæ‰€æœ‰çš„ä¸»æœºï¼ˆè·¯ç”±å™¨ä»¥å¤–çš„ä¸»æœºå’Œç»ˆç«¯ä¸»æœºï¼‰å¿…é¡»å±äº 224.0.0.1 çš„ç»„ï¼Œæ‰€æœ‰çš„è·¯ç”±å™¨å¿…é¡»å±äº 224.0.0.2 çš„ç»„ã€‚ 1.6 å­ç½‘æ©ç  ç°åœ¨ä¸€ä¸ª IP åœ°å€çš„ç½‘ç»œæ ‡è¯†å’Œä¸»æœºæ ‡è¯†å·²ä¸å†å—é™äºè¯¥åœ°å€çš„ç±»åˆ«ï¼Œè€Œæ˜¯ç”±ä¸€ä¸ªå«åšâ€œå­ç½‘æ©ç â€çš„è¯†åˆ«ç é€šè¿‡å­ç½‘ç½‘ç»œåœ°å€ç»†åˆ†å‡ºæ¯” A ç±»ã€B ç±»ã€C ç±»æ›´å°ç²’åº¦çš„ç½‘ç»œã€‚è¿™ç§æ–¹å¼å®é™…ä¸Šå°±æ˜¯å°†åŸæ¥ A ç±»ã€B ç±»ã€C ç±»ç­‰åˆ†ç±»ä¸­çš„ä¸»æœºåœ°å€éƒ¨åˆ†ç”¨ä½œå­ç½‘åœ°å€ï¼Œå¯ä»¥å°†åŸç½‘ç»œåˆ†ä¸ºå¤šä¸ªç‰©ç†ç½‘ç»œçš„ä¸€ç§æœºåˆ¶ã€‚ å­ç½‘æ©ç ç”¨äºŒè¿›åˆ¶æ–¹å¼è¡¨ç¤ºçš„è¯ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª 32 ä½çš„æ•°å­—ã€‚å®ƒå¯¹åº” IP åœ°å€ç½‘ç»œæ ‡è¯†éƒ¨åˆ†çš„ä½å…¨éƒ¨ä¸º â€œ1â€ï¼Œå¯¹åº” IP åœ°å€ä¸»æœºæ ‡è¯†çš„éƒ¨åˆ†åˆ™å…¨éƒ¨ä¸º â€œ0â€ã€‚ç”±æ­¤ï¼Œä¸€ä¸ª IP åœ°å€å¯ä»¥ä¸å†å—é™äºè‡ªå·±çš„ç±»åˆ«ï¼Œè€Œæ˜¯å¯ä»¥ç”¨è¿™æ ·çš„å­ç½‘æ©ç è‡ªç”±åœ°å®šä½è‡ªå·±çš„ç½‘ç»œæ ‡è¯†é•¿åº¦ã€‚å½“ç„¶ï¼Œå­ç½‘æ©ç å¿…é¡»æ˜¯ IP åœ°å€çš„é¦–ä½å¼€å§‹è¿ç»­çš„ â€œ1â€ã€‚ å¯¹äºå­ç½‘æ©ç ï¼Œç›®å‰æœ‰ä¸¤ç§è¡¨ç¤ºæ–¹å¼ã€‚ç¬¬ä¸€ç§æ˜¯ï¼Œå°† IP åœ°å€ä¸å­ç½‘æ©ç çš„åœ°å€åˆ†åˆ«ç”¨ä¸¤è¡Œæ¥è¡¨ç¤ºã€‚ä»¥ 172.20.100.52 çš„å‰ 26 ä½æ˜¯ç½‘ç»œåœ°å€çš„æƒ…å†µä¸ºä¾‹ï¼Œå¦‚ä¸‹ï¼š ç¬¬äºŒç§è¡¨ç¤ºæ–¹å¼æ˜¯ï¼Œåœ¨æ¯ä¸ª IP åœ°å€åé¢è¿½åŠ ç½‘ç»œåœ°å€çš„ä½æ•°ç”¨ â€œ/ â€ éš”å¼€ï¼Œå¦‚ä¸‹ï¼š å¦å¤–ï¼Œåœ¨ç¬¬äºŒç§æ–¹å¼ä¸‹è®°è¿°ç½‘ç»œåœ°å€æ—¶å¯ä»¥çœç•¥åé¢çš„ â€œ0â€ ã€‚ä¾‹å¦‚ï¼š172.20.0.0/26 è·Ÿ 172.20/26 å…¶å®æ˜¯ä¸€ä¸ªæ„æ€ã€‚ 4.2 è·¯ç”± å‘é€æ•°æ®åŒ…æ—¶æ‰€ä½¿ç”¨çš„åœ°å€æ˜¯ç½‘ç»œå±‚çš„åœ°å€ï¼Œå³ IP åœ°å€ã€‚ç„¶è€Œä»…ä»…æœ‰ IP åœ°å€è¿˜ä¸è¶³ä»¥å®ç°å°†æ•°æ®åŒ…å‘é€åˆ°å¯¹ç«¯ç›®æ ‡åœ°å€ï¼Œåœ¨æ•°æ®å‘é€è¿‡ç¨‹ä¸­è¿˜éœ€è¦ç±»ä¼¼äºâ€œæŒ‡æ˜è·¯ç”±å™¨æˆ–ä¸»æœºâ€çš„ä¿¡æ¯ï¼Œä»¥ä¾¿çœŸæ­£å‘å¾€ç›®æ ‡åœ°å€ã€‚ä¿å­˜è¿™ç§ä¿¡æ¯çš„å°±æ˜¯è·¯ç”±æ§åˆ¶è¡¨ã€‚ è¯¥è·¯ç”±æ§åˆ¶è¡¨çš„å½¢æˆæ–¹å¼æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯ç®¡ç†å‘˜æ‰‹åŠ¨è®¾ç½®ï¼Œå¦ä¸€ç§æ˜¯è·¯ç”±å™¨ä¸å…¶ä»–è·¯ç”±å™¨ç›¸äº’äº¤æ¢ä¿¡æ¯æ—¶è‡ªåŠ¨åˆ·æ–°ã€‚å‰è€…ä¹Ÿå«åšé™æ€è·¯ç”±æ§åˆ¶ï¼Œè€Œåè€…å«åšåŠ¨æ€è·¯ç”±æ§åˆ¶ã€‚ IP åè®®å§‹ç»ˆè®¤ä¸ºè·¯ç”±è¡¨æ˜¯æ­£ç¡®çš„ã€‚ç„¶åï¼ŒIP æœ¬èº«å¹¶æ²¡æœ‰å®šä¹‰åˆ¶ä½œè·¯ç”±æ§åˆ¶è¡¨çš„åè®®ã€‚å³ IP æ²¡æœ‰åˆ¶ä½œè·¯ç”±æ§åˆ¶è¡¨çš„æœºåˆ¶ã€‚è¯¥è¡¨ç¤ºç”±ä¸€ä¸ªå«åšâ€œè·¯ç”±åè®®â€çš„åè®®åˆ¶ä½œè€Œæˆã€‚ 4.2.1 IP åœ°å€ä¸è·¯ç”±æ§åˆ¶ IP åœ°å€çš„ç½‘ç»œåœ°å€éƒ¨åˆ†ç”¨äºè¿›è¡Œè·¯ç”±æ§åˆ¶ã€‚ è·¯ç”±æ§åˆ¶è¡¨ä¸­è®°å½•ç€ç½‘ç»œåœ°å€ä¸ä¸‹ä¸€æ­¥åº”è¯¥å‘é€è‡³è·¯ç”±å™¨çš„åœ°å€ã€‚ åœ¨å‘é€ IP åŒ…æ—¶ï¼Œé¦–å…ˆè¦ç¡®å®š IP åŒ…é¦–éƒ¨ä¸­çš„ç›®æ ‡åœ°å€ï¼Œå†ä»è·¯ç”±æ§åˆ¶è¡¨ä¸­æ‰¾åˆ°ä¸è¯¥åœ°å€å…·æœ‰ç›¸åŒç½‘ç»œåœ°å€çš„è®°å½•ï¼Œæ ¹æ®è¯¥è®°å½•å°† IP åŒ…è½¬å‘ç»™ç›¸åº”çš„ä¸‹ä¸€ä¸ªè·¯ç”±å™¨ã€‚å¦‚æœè·¯ç”±æ§åˆ¶è¡¨ä¸­å­˜åœ¨å¤šæ¡ç›¸åŒç½‘ç»œåœ°å€çš„è®°å½•ï¼Œå°±é€‰æ‹©ä¸€ä¸ªæœ€ä¸ºå»åˆçš„ç½‘ç»œåœ°å€ã€‚ è·¯ç”±æ§åˆ¶è¡¨ä¸IPåŒ…å‘é€ 4.3 IP åˆ†åŒ…ä¸ç»„åŒ… æ¯ç§æ•°æ®é“¾è·¯çš„æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼‰éƒ½ä¸å°½ç›¸åŒï¼Œå› ä¸ºæ¯ä¸ªä¸åŒç±»å‹çš„æ•°æ®é“¾è·¯çš„ä½¿ç”¨ç›®çš„ä¸åŒã€‚ä½¿ç”¨ç›®çš„ä¸åŒï¼Œå¯æ‰¿è½½çš„ MTU ä¹Ÿå°±ä¸åŒã€‚ ä»»ä½•ä¸€å°ä¸»æœºéƒ½æœ‰å¿…è¦å¯¹ IP åˆ†ç‰‡è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚åˆ†ç‰‡å¾€å¾€åœ¨ç½‘ç»œä¸Šé‡åˆ°æ¯”è¾ƒå¤§çš„æŠ¥æ–‡æ— æ³•ä¸€ä¸‹å­å‘é€å‡ºå»æ—¶æ‰ä¼šè¿›è¡Œå¤„ç†ã€‚ ç»è¿‡åˆ†ç‰‡ä¹‹åçš„ IP æ•°æ®æŠ¥åœ¨è¢«é‡ç»„çš„æ—¶å€™ï¼Œåªèƒ½ç”±ç›®æ ‡ä¸»æœºè¿›è¡Œã€‚è·¯ç”±å™¨è™½ç„¶åšåˆ†ç‰‡ä½†ä¸ä¼šè¿›è¡Œé‡ç»„ã€‚ 4.3.1 è·¯å¾„ MTU å‘ç° åˆ†ç‰‡æœºåˆ¶ä¹Ÿæœ‰å®ƒçš„ä¸è¶³ã€‚å¦‚è·¯ç”±å™¨çš„å¤„ç†è´Ÿè·åŠ é‡ä¹‹ç±»ã€‚å› æ­¤ï¼Œåªè¦å…è®¸ï¼Œæ˜¯ä¸å¸Œæœ›ç”±è·¯ç”±å™¨è¿›è¡Œ IP æ•°æ®åŒ…çš„åˆ†ç‰‡å¤„ç†çš„ã€‚ ä¸ºäº†åº”å¯¹åˆ†ç‰‡æœºåˆ¶çš„ä¸è¶³ï¼Œâ€œè·¯å¾„ MTU å‘ç°â€ æŠ€æœ¯åº”è¿è€Œç”Ÿã€‚è·¯å¾„ MTU æŒ‡çš„æ˜¯ï¼Œä»å‘é€ç«¯ä¸»æœºåˆ°æ¥æ”¶ç«¯ä¸»æœºä¹‹é—´ä¸éœ€è¦åˆ†ç‰‡æ˜¯æœ€å¤§ MTU çš„å¤§å°ã€‚å³è·¯å¾„ä¸­å­˜åœ¨çš„æ‰€æœ‰æ•°æ®é“¾è·¯ä¸­æœ€å°çš„ MTU ã€‚ è¿›è¡Œè·¯å¾„ MTU å‘ç°ï¼Œå°±å¯ä»¥é¿å…åœ¨ä¸­é€”çš„è·¯ç”±å™¨ä¸Šè¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œä¹Ÿå¯ä»¥åœ¨ TCP ä¸­å‘é€æ›´å¤§çš„åŒ…ã€‚ 4.4 IPv6 IPv6ï¼ˆIP version 6ï¼‰æ˜¯ä¸ºäº†æ ¹æœ¬è§£å†³ IPv4 åœ°å€è€—å°½çš„é—®é¢˜è€Œè¢«æ ‡å‡†åŒ–çš„ç½‘é™…åè®®ã€‚IPv4 çš„åœ°å€é•¿åº¦ä¸º 4 ä¸ª 8 ä½å­—èŠ‚ï¼Œå³ 32 æ¯”ç‰¹ã€‚è€Œ IPv6 çš„åœ°å€é•¿åº¦åˆ™æ˜¯åŸæ¥çš„ 4 å€ï¼Œå³ 128 æ¯”ç‰¹ï¼Œä¸€èˆ¬å†™æˆ 8 ä¸ª 16 ä½å­—èŠ‚ã€‚ 4.4.1 IPv6 çš„ç‰¹ç‚¹ IP å¾—çŸ¥çš„æ‰©å¤§ä¸è·¯ç”±æ§åˆ¶è¡¨çš„èšåˆã€‚ æ€§èƒ½æå‡ã€‚åŒ…é¦–éƒ¨é•¿åº¦é‡‡ç”¨å›ºå®šçš„å€¼ï¼ˆ40å­—èŠ‚ï¼‰ï¼Œä¸å†é‡‡ç”¨é¦–éƒ¨æ£€éªŒç ã€‚ç®€åŒ–é¦–éƒ¨ç»“æ„ï¼Œå‡è½»è·¯ç”±å™¨è´Ÿæ‹…ã€‚è·¯ç”±å™¨ä¸å†åšåˆ†ç‰‡å¤„ç†ã€‚ æ”¯æŒå³æ’å³ç”¨åŠŸèƒ½ã€‚å³ä½¿æ²¡æœ‰DHCPæœåŠ¡å™¨ä¹Ÿå¯ä»¥å®ç°è‡ªåŠ¨åˆ†é… IP åœ°å€ã€‚ é‡‡ç”¨è®¤è¯ä¸åŠ å¯†åŠŸèƒ½ã€‚åº”å¯¹ä¼ªé€  IP åœ°å€çš„ç½‘ç»œå®‰å…¨åŠŸèƒ½ä»¥åŠé˜²æ­¢çº¿è·¯çªƒå¬çš„åŠŸèƒ½ã€‚ å¤šæ’­ã€Mobile IP æˆä¸ºæ‰©å±•åŠŸèƒ½ã€‚ 4.4.2 IPv6 ä¸­ IP åœ°å€çš„æ ‡è®°æ–¹æ³• ä¸€èˆ¬äººä»¬å°† 128 æ¯”ç‰¹ IP åœ°å€ä»¥æ¯ 16 æ¯”ç‰¹ä¸ºä¸€ç»„ï¼Œæ¯ç»„ç”¨å†’å·ï¼ˆâ€œï¼šâ€ï¼‰éš”å¼€è¿›è¡Œæ ‡è®°ã€‚ è€Œä¸”å¦‚æœå‡ºç°è¿ç»­çš„ 0 æ—¶è¿˜å¯ä»¥å°†è¿™äº› 0 çœç•¥ï¼Œå¹¶ç”¨ä¸¤ä¸ªå†’å·ï¼ˆâ€œï¼šï¼šâ€ï¼‰éš”å¼€ã€‚ä½†æ˜¯ï¼Œä¸€ä¸ª IP åœ°å€ä¸­åªå…è®¸å‡ºç°ä¸€æ¬¡ä¸¤ä¸ªè¿ç»­çš„å†’å·ã€‚ 4.4.3 IPv6 åœ°å€çš„ç»“æ„ IPv6 ç±»ä¼¼ IPv4ï¼Œä¹Ÿæ˜¯é€šè¿‡ IP åœ°å€çš„å‰å‡ ä½æ ‡è¯† IP åœ°å€çš„ç§ç±»ã€‚ åœ¨äº’è”ç½‘é€šä¿¡ä¸­ï¼Œä½¿ç”¨ä¸€ç§å…¨å±€çš„å•æ’­åœ°å€ã€‚å®ƒæ˜¯äº’è”ç½‘ä¸­å”¯ä¸€çš„ä¸€ä¸ªåœ°å€ï¼Œä¸éœ€è¦æ­£å¼åˆ†é… IP åœ°å€ã€‚ 4.4.4 å…¨å±€å•æ’­åœ°å€ å…¨å±€å•æ’­åœ°å€æ˜¯æŒ‡ä¸–ç•Œä¸Šå”¯ä¸€çš„ä¸€ä¸ªåœ°å€ã€‚å®ƒæ˜¯äº’è”ç½‘é€šä¿¡ä»¥åŠå„ä¸ªåŸŸå†…éƒ¨é€šä¿¡ä¸­æœ€ä¸ºå¸¸ç”¨çš„ä¸€ä¸ª IPv6 åœ°å€ã€‚ æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç°åœ¨ IPv6 çš„ç½‘ç»œä¸­æ‰€ä½¿ç”¨çš„æ ¼å¼ä¸ºï¼Œn = 48ï¼Œm = 16 ä»¥åŠ 128 - n - m = 64ã€‚å³å‰ 64 æ¯”ç‰¹ä¸ºç½‘ç»œæ ‡è¯†ï¼Œå 64 æ¯”ç‰¹ä¸ºä¸»æœºæ ‡è¯†ã€‚ å…¨å±€å•æ’­åœ°å€ 4.4.5 é“¾è·¯æœ¬åœ°å•æ’­åœ°å€ é“¾è·¯æœ¬åœ°å•æ’­åœ°å€æ˜¯æŒ‡åœ¨åŒä¸€ä¸ªæ•°æ®é“¾è·¯å†…å”¯ä¸€çš„åœ°å€ã€‚å®ƒç”¨äºä¸ç»è¿‡è·¯ç”±å™¨ï¼Œåœ¨åŒä¸€ä¸ªé“¾è·¯ä¸­çš„é€šä¿¡ã€‚é€šå¸¸æ¥å£ ID ä¿å­˜ 64 æ¯”ç‰¹ç‰ˆçš„ MAC åœ°å€ã€‚ é“¾è·¯æœ¬åœ°å•æ’­åœ°å€ 4.4.6 å”¯ä¸€æœ¬åœ°åœ°å€ å”¯ä¸€æœ¬åœ°åœ°å€æ˜¯ä¸è¿›è¡Œäº’è”ç½‘é€šä¿¡æ—¶æ‰€ç”¨çš„åœ°å€ã€‚ å”¯ä¸€æœ¬åœ°åœ°å€è™½ç„¶ä¸ä¼šä¸äº’è”ç½‘è¿æ¥ï¼Œä½†æ˜¯ä¹Ÿä¼šå°½å¯èƒ½åœ°éšæœºç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„å…¨å±€ IDã€‚ L é€šå¸¸è¢«ç½®ä¸º 1 å…¨å±€ ID çš„å€¼éšæœºå†³å®š å­ç½‘ ID æ˜¯æŒ‡è¯¥åŸŸå­ç½‘åœ°å€ æ¥å£ ID å³ä¸ºæ¥å£çš„ ID å”¯ä¸€æœ¬åœ°åœ°å€ 4.4.7 IPv6 åˆ†æ®µå¤„ç† IPv6 çš„åˆ†ç‰‡å¤„ç†åªåœ¨ä½œä¸ºèµ·ç‚¹çš„å‘é€ç«¯ä¸»æœºä¸Šè¿›è¡Œï¼Œè·¯ç”±å™¨ä¸å‚ä¸åˆ†ç‰‡ã€‚ IPv6 ä¸­æœ€å° MTU ä¸º 1280 å­—èŠ‚ï¼Œå› æ­¤ï¼Œåœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­å¯¹äºé‚£äº›æœ‰ä¸€å®šç³»ç»Ÿèµ„æºé™åˆ¶çš„è®¾å¤‡æ¥è¯´ï¼Œä¸éœ€è¦è¿›è¡Œâ€œè·¯å¾„ MTU å‘ç°â€ï¼Œè€Œæ˜¯åœ¨å‘é€ IP åŒ…æ—¶ç›´æ¥ä»¥ 1280 å­—èŠ‚ä¸ºå•ä½åˆ†ç‰‡é€å‡ºã€‚ 4.4.8 IP é¦–éƒ¨ï¼ˆæš‚ç•¥ï¼‰ 4.5 IP åè®®ç›¸å…³æŠ€æœ¯ IP æ—¨åœ¨è®©æœ€ç»ˆç›®æ ‡ä¸»æœºæ”¶åˆ°æ•°æ®åŒ…ï¼Œä½†æ˜¯åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ä»…ä»…æœ‰ IP æ˜¯æ— æ³•å®ç°é€šä¿¡çš„ã€‚å¿…é¡»è¿˜æœ‰èƒ½å¤Ÿè§£æä¸»æœºåç§°å’Œ MAC åœ°å€çš„åŠŸèƒ½ï¼Œä»¥åŠæ•°æ®åŒ…åœ¨å‘é€è¿‡ç¨‹ä¸­å¼‚å¸¸æƒ…å†µå¤„ç†çš„åŠŸèƒ½ã€‚ 4.5.1 DNS æˆ‘ä»¬å¹³å¸¸åœ¨è®¿é—®æŸä¸ªç½‘ç«™æ—¶ä¸é€‚ç”¨ IP åœ°å€ï¼Œè€Œæ˜¯ç”¨ä¸€ä¸²ç”±ç½—é©¬å­—å’Œç‚¹å·ç»„æˆçš„å­—ç¬¦ä¸²ã€‚è€Œä¸€èˆ¬ç”¨æˆ·åœ¨ä½¿ç”¨ TCP/IP è¿›è¡Œé€šä¿¡æ—¶ä¹Ÿä¸ä½¿ç”¨ IP åœ°å€ã€‚èƒ½å¤Ÿè¿™æ ·åšæ˜¯å› ä¸ºæœ‰äº† DNS ï¼ˆDomain Name Systemï¼‰åŠŸèƒ½çš„æ”¯æŒã€‚DNS å¯ä»¥å°†é‚£ä¸²å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢ä¸ºå…·ä½“çš„ IP åœ°å€ã€‚ è¿™ç§ DNS ä¸ä»…é€‚ç”¨äº IPv4ï¼Œè¿˜é€‚ç”¨äº IPv6ã€‚ 4.5.2 ARP åªè¦ç¡®å®šäº† IP åœ°å€ï¼Œå°±å¯ä»¥å‘è¿™ä¸ªç›®æ ‡åœ°å€å‘é€ IP æ•°æ®æŠ¥ã€‚ç„¶è€Œï¼Œåœ¨åº•å±‚æ•°æ®é“¾è·¯å±‚ï¼Œè¿›è¡Œå®é™…é€šä¿¡æ—¶å´æœ‰å¿…è¦äº†è§£æ¯ä¸ª IP åœ°å€æ‰€å¯¹åº”çš„ MAC åœ°å€ã€‚ ARP æ˜¯ä¸€ç§è§£å†³åœ°å€é—®é¢˜çš„åè®®ã€‚ä»¥ç›®æ ‡ IP åœ°å€ä¸ºçº¿ç´¢ï¼Œç”¨æ¥å®šä½ä¸‹ä¸€ä¸ªåº”è¯¥æ¥æ”¶æ•°æ®åˆ†åŒ…çš„ç½‘ç»œè®¾å¤‡å¯¹åº”çš„ MAC åœ°å€ã€‚ä¸è¿‡ ARP åªé€‚ç”¨äº IPv4ï¼Œä¸èƒ½ç”¨äº IPv6ã€‚IPv6 ä¸­å¯ä»¥ç”¨ ICMPv6 æ›¿ä»£ ARP å‘é€é‚»å±…æ¢ç´¢æ¶ˆæ¯ã€‚ RARP æ˜¯å°† ARP åè¿‡æ¥ï¼Œä» MAC åœ°å€å®šä½ IP åœ°å€çš„ä¸€ç§åè®®ã€‚ 4.5.3 ICMP ICMP çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼Œç¡®è®¤ IP åŒ…æ˜¯å¦æˆåŠŸé€è¾¾ç›®æ ‡åœ°å€ï¼Œé€šçŸ¥åœ¨å‘é€è¿‡ç¨‹å½“ä¸­ IP åŒ…è¢«åºŸå¼ƒçš„å…·ä½“åŸå› ï¼Œæ”¹å–„ç½‘ç»œè®¾ç½®ç­‰ã€‚ IPv4 ä¸­ ICMP ä»…ä½œä¸ºä¸€ä¸ªè¾…åŠ©ä½œç”¨æ”¯æŒ IPv4ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ IPv4 æ—¶æœŸï¼Œå³ä½¿æ²¡æœ‰ ICMPï¼Œä»ç„¶å¯ä»¥å®ç° IP é€šä¿¡ã€‚ç„¶è€Œï¼Œåœ¨ IPv6 ä¸­ï¼ŒICMP çš„ä½œç”¨è¢«æ‰©å¤§ï¼Œå¦‚æœæ²¡æœ‰ ICMPv6ï¼ŒIPv6 å°±æ— æ³•è¿›è¡Œæ­£å¸¸é€šä¿¡ã€‚ 4.5.4 DHCP å¦‚æœé€ä¸€ä¸ºæ¯ä¸€å°ä¸»æœºè®¾ç½® IP åœ°å€ä¼šæ˜¯éå¸¸ç¹ççš„äº‹æƒ…ã€‚ç‰¹åˆ«æ˜¯åœ¨ç§»åŠ¨ä½¿ç”¨ç¬”è®°æœ¬ç”µè„‘ã€åªèƒ½ç»ˆç«¯ä»¥åŠå¹³æ¿ç”µè„‘ç­‰è®¾å¤‡æ—¶ï¼Œæ¯ç§»åŠ¨åˆ°ä¸€ä¸ªæ–°çš„åœ°æ–¹ï¼Œéƒ½è¦é‡æ–°è®¾ç½® IP åœ°å€ã€‚ äºæ˜¯ï¼Œä¸ºäº†å®ç°è‡ªåŠ¨è®¾ç½® IP åœ°å€ã€ç»Ÿä¸€ç®¡ç† IP åœ°å€åˆ†é…ï¼Œå°±äº§ç”Ÿäº† DHCPï¼ˆDynamic Host Configuration Protocolï¼‰åè®®ã€‚æœ‰äº† DHCPï¼Œè®¡ç®—æœºåªè¦è¿æ¥åˆ°ç½‘ç»œï¼Œå°±å¯ä»¥è¿›è¡Œ TCP/IP é€šä¿¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒDHCP è®©å³æ’å³ç”¨å˜å¾—å¯èƒ½ã€‚ DHCP ä¸ä»…åœ¨ IPv4 ä¸­ï¼Œåœ¨ IPv6 ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚ 4.5.5 NAT NATï¼ˆNetwork Address Translatorï¼‰æ˜¯ç”¨äºåœ¨æœ¬åœ°ç½‘ç»œä¸­ä½¿ç”¨ç§æœ‰åœ°å€ï¼Œåœ¨è¿æ¥äº’è”ç½‘æ—¶è½¬è€Œä½¿ç”¨å…¨å±€ IP åœ°å€çš„æŠ€æœ¯ã€‚ é™¤è½¬æ¢ IP åœ°å€å¤–ï¼Œè¿˜å‡ºç°äº†å¯ä»¥è½¬æ¢ TCPã€UDP ç«¯å£å·çš„ NAPTï¼ˆNetwork Address Ports Translatorï¼‰æŠ€æœ¯ï¼Œç”±æ­¤å¯ä»¥å®ç°ç”¨ä¸€ä¸ªå…¨å±€ IP åœ°å€ä¸å¤šä¸ªä¸»æœºçš„é€šä¿¡ã€‚ NATï¼ˆNAPTï¼‰å®é™…ä¸Šæ˜¯ä¸ºæ­£åœ¨é¢ä¸´åœ°å€æ¯ç«­çš„ IPv4 è€Œå¼€å‘çš„æŠ€æœ¯ã€‚ä¸è¿‡ï¼Œåœ¨ IPv6 ä¸­ä¸ºäº†æé«˜ç½‘ç»œå®‰å…¨ä¹Ÿåœ¨ä½¿ç”¨ NATï¼Œåœ¨ IPv4 å’Œ IPv6 ä¹‹é—´çš„ç›¸äº’é€šä¿¡å½“ä¸­å¸¸å¸¸ä½¿ç”¨ NAT-PTã€‚ 4.5.6 IP éš§é“ å¤¹ç€ IPv4 ç½‘ç»œçš„ä¸¤ä¸ª IPv6 ç½‘ç»œ å¦‚ä¸Šå›¾çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œç½‘ç»œ A ä¸ç½‘ç»œ B ä¹‹é—´æ— æ³•ç›´æ¥è¿›è¡Œé€šä¿¡ï¼Œä¸ºäº†è®©å®ƒä»¬ä¹‹é—´æ­£å¸¸é€šä¿¡ï¼Œè¿™æ—¶å¿…é¡»å¾—é‡‡ç”¨ IP éš§é“çš„åŠŸèƒ½ã€‚ IP éš§é“å¯ä»¥å°†é‚£äº›ä»ç½‘ç»œ A å‘è¿‡æ¥çš„ IPv6 çš„åŒ…ç»Ÿåˆä¸ºä¸€ä¸ªæ•°æ®ï¼Œå†ä¸ºä¹‹è¿½åŠ ä¸€ä¸ª IPv4 çš„é¦–éƒ¨ä»¥åè½¬å‘ç»™ç½‘ç»œ Cã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç´§æ¥ç€ IP é¦–éƒ¨çš„æ˜¯ TCP æˆ– UDP çš„é¦–éƒ¨ã€‚ç„¶è€Œï¼Œç°åœ¨çš„åº”ç”¨å½“ä¸­â€œ IP é¦–éƒ¨çš„åé¢è¿˜æ˜¯ IP é¦–éƒ¨â€æˆ–è€…â€œ IP é¦–éƒ¨çš„åé¢æ˜¯ IPv6 çš„é¦–éƒ¨â€ç­‰æƒ…å†µä¸æ—¥ä¿±å¢ã€‚è¿™ç§åœ¨ç½‘ç»œå±‚çš„é¦–éƒ¨åé¢è¿½åŠ ç½‘ç»œå±‚é¦–éƒ¨çš„é€šä¿¡æ–¹æ³•å°±å«åšâ€œ IP éš§é“â€ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/ç½‘ç»œåè®®/http/HTTP åè®®.html":{"url":"linux/ç½‘ç»œåè®®/http/HTTP åè®®.html","title":"HTTPåè®®","keywords":"","body":"HTTP åè®® æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ æ€»çº² ä¸€ã€æ¦‚è¿° 1.1 è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„åˆ†å±‚ 1.2 TCP/IP é€šä¿¡ä¼ è¾“æµ åˆ©ç”¨ TCP/IP åè®®æ—è¿›è¡Œç½‘ç»œé€šä¿¡æ—¶ï¼Œä¼šé€šè¿‡åˆ†å±‚é¡ºåºä¸å¯¹æ–¹è¿›è¡Œé€šä¿¡ã€‚å‘é€ç«¯ä»åº”ç”¨å±‚å¾€ä¸‹èµ°ï¼Œæ¥æ”¶ç«¯åˆ™ä»é“¾è·¯å±‚å¾€ä¸Šèµ°ã€‚å¦‚ä¸‹ï¼š TCP/IP é€šä¿¡ä¼ è¾“æµ é¦–å…ˆä½œä¸ºå‘é€ç«¯çš„å®¢æˆ·ç«¯åœ¨åº”ç”¨å±‚ï¼ˆHTTP åè®®ï¼‰å‘å‡ºä¸€ä¸ªæƒ³çœ‹æŸä¸ª Web é¡µé¢çš„ HTTP è¯·æ±‚ã€‚ æ¥ç€ï¼Œä¸ºäº†ä¼ è¾“æ–¹ä¾¿ï¼Œåœ¨ä¼ è¾“å±‚ï¼ˆTCP åè®®ï¼‰æŠŠä»åº”ç”¨å±‚å¤„æ”¶åˆ°çš„æ•°æ®ï¼ˆHTTP è¯·æ±‚æŠ¥æ–‡ï¼‰è¿›è¡Œåˆ†å‰²ï¼Œå¹¶åœ¨å„ä¸ªæŠ¥æ–‡ä¸Šæ‰“ä¸Šæ ‡è®°åºå·åŠç«¯å£å·åè½¬å‘ç»™ç½‘ç»œå±‚ã€‚ åœ¨ç½‘ç»œå±‚ï¼ˆIP åè®®ï¼‰ï¼Œå¢åŠ ä½œä¸ºé€šä¿¡ç›®çš„åœ°çš„ MAC åœ°å€åè½¬å‘ç»™é“¾è·¯å±‚ã€‚è¿™æ ·ä¸€æ¥ï¼Œå‘å¾€ç½‘ç»œçš„é€šä¿¡è¯·æ±‚å°±å‡†å¤‡é½å…¨äº†ã€‚ æ¥æ”¶ç«¯çš„æœåŠ¡å™¨åœ¨é“¾è·¯å±‚æ¥æ”¶åˆ°æ•°æ®ï¼ŒæŒ‰åºå¾€ä¸Šå±‚å‘é€ï¼Œä¸€ç›´åˆ°åº”ç”¨å±‚ã€‚å½“ä¼ è¾“åˆ°åº”ç”¨å±‚ï¼Œæ‰èƒ½ç®—çœŸæ­£æ¥æ”¶åˆ°ç”±å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„ HTTPè¯·æ±‚ã€‚ HTTPè¯·æ±‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åœ¨ç½‘ç»œä½“ç³»ç»“æ„ä¸­ï¼ŒåŒ…å«äº†ä¼—å¤šçš„ç½‘ç»œåè®®ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦å›´ç»• HTTP åè®®ï¼ˆHTTP/1.1ç‰ˆæœ¬ï¼‰å±•å¼€ã€‚ HTTPåè®®ï¼ˆHyperText Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰æ˜¯ç”¨äºä»WWWæœåŠ¡å™¨ä¼ è¾“è¶…æ–‡æœ¬åˆ°æœ¬åœ°æµè§ˆå™¨çš„ä¼ è¾“åè®®ã€‚å®ƒå¯ä»¥ä½¿æµè§ˆå™¨æ›´åŠ é«˜æ•ˆï¼Œä½¿ç½‘ç»œä¼ è¾“å‡å°‘ã€‚å®ƒä¸ä»…ä¿è¯è®¡ç®—æœºæ­£ç¡®å¿«é€Ÿåœ°ä¼ è¾“è¶…æ–‡æœ¬æ–‡æ¡£ï¼Œè¿˜ç¡®å®šä¼ è¾“æ–‡æ¡£ä¸­çš„å“ªä¸€éƒ¨åˆ†ï¼Œä»¥åŠå“ªéƒ¨åˆ†å†…å®¹é¦–å…ˆæ˜¾ç¤º(å¦‚æ–‡æœ¬å…ˆäºå›¾å½¢)ç­‰ã€‚ HTTPæ˜¯å®¢æˆ·ç«¯æµè§ˆå™¨æˆ–å…¶ä»–ç¨‹åºä¸WebæœåŠ¡å™¨ä¹‹é—´çš„åº”ç”¨å±‚é€šä¿¡åè®®ã€‚åœ¨Internetä¸Šçš„WebæœåŠ¡å™¨ä¸Šå­˜æ”¾çš„éƒ½æ˜¯è¶…æ–‡æœ¬ä¿¡æ¯ï¼Œå®¢æˆ·æœºéœ€è¦é€šè¿‡HTTPåè®®ä¼ è¾“æ‰€è¦è®¿é—®çš„è¶…æ–‡æœ¬ä¿¡æ¯ã€‚HTTPåŒ…å«å‘½ä»¤å’Œä¼ è¾“ä¿¡æ¯ï¼Œä¸ä»…å¯ç”¨äºWebè®¿é—®ï¼Œä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–å› ç‰¹ç½‘/å†…è”ç½‘åº”ç”¨ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ï¼Œä»è€Œå®ç°å„ç±»åº”ç”¨èµ„æºè¶…åª’ä½“è®¿é—®çš„é›†æˆã€‚ æˆ‘ä»¬åœ¨æµè§ˆå™¨çš„åœ°å€æ é‡Œè¾“å…¥çš„ç½‘ç«™åœ°å€å«åšURL (Uniform Resource Locatorï¼Œç»Ÿä¸€èµ„æºå®šä½ç¬¦)ã€‚å°±åƒæ¯å®¶æ¯æˆ·éƒ½æœ‰ä¸€ä¸ªé—¨ç‰Œåœ°å€ä¸€æ ·ï¼Œæ¯ä¸ªç½‘é¡µä¹Ÿéƒ½æœ‰ä¸€ä¸ªInternetåœ°å€ã€‚å½“ä½ åœ¨æµè§ˆå™¨çš„åœ°å€æ¡†ä¸­è¾“å…¥ä¸€ä¸ªURLæˆ–æ˜¯å•å‡»ä¸€ä¸ªè¶…çº§é“¾æ¥æ—¶ï¼ŒURLå°±ç¡®å®šäº†è¦æµè§ˆçš„åœ°å€ã€‚æµè§ˆå™¨é€šè¿‡è¶…æ–‡æœ¬ä¼ è¾“åè®®(HTTP)ï¼Œå°†WebæœåŠ¡å™¨ä¸Šç«™ç‚¹çš„ç½‘é¡µä»£ç æå–å‡ºæ¥ï¼Œå¹¶ç¿»è¯‘æˆæ¼‚äº®çš„ç½‘é¡µã€‚ äºŒã€HTTP å·¥ä½œè¿‡ç¨‹ HTTPè¯·æ±‚å“åº”æ¨¡å‹ HTTPé€šä¿¡æœºåˆ¶æ˜¯åœ¨ä¸€æ¬¡å®Œæ•´çš„ HTTP é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´å°†å®Œæˆä¸‹åˆ—7ä¸ªæ­¥éª¤ï¼š 1.å»ºç«‹ TCP è¿æ¥ åœ¨HTTPå·¥ä½œå¼€å§‹ä¹‹å‰ï¼Œå®¢æˆ·ç«¯é¦–å…ˆè¦é€šè¿‡ç½‘ç»œä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œè¯¥è¿æ¥æ˜¯é€šè¿‡ TCP æ¥å®Œæˆçš„ï¼Œè¯¥åè®®ä¸ IP åè®®å…±åŒæ„å»º Internetï¼Œå³è‘—åçš„ TCP/IP åè®®æ—ï¼Œå› æ­¤ Internet åˆè¢«ç§°ä½œæ˜¯ TCP/IP ç½‘ç»œã€‚HTTP æ˜¯æ¯” TCP æ›´é«˜å±‚æ¬¡çš„åº”ç”¨å±‚åè®®ï¼Œæ ¹æ®è§„åˆ™ï¼Œåªæœ‰ä½å±‚åè®®å»ºç«‹ä¹‹åï¼Œæ‰èƒ½è¿›è¡Œé«˜å±‚åè®®çš„è¿æ¥ï¼Œå› æ­¤ï¼Œé¦–å…ˆè¦å»ºç«‹ TCP è¿æ¥ï¼Œä¸€èˆ¬ TCP è¿æ¥çš„ç«¯å£å·æ˜¯80ï¼› 2.å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚å‘½ä»¤ ä¸€æ—¦å»ºç«‹äº†TCPè¿æ¥ï¼Œå®¢æˆ·ç«¯å°±ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚å‘½ä»¤ï¼› ä¾‹å¦‚ï¼šGET/sample/hello.jsp HTTP/1.1 3.å®¢æˆ·ç«¯å‘é€è¯·æ±‚å¤´ä¿¡æ¯ å®¢æˆ·ç«¯å‘é€å…¶è¯·æ±‚å‘½ä»¤ä¹‹åï¼Œè¿˜è¦ä»¥å¤´ä¿¡æ¯çš„å½¢å¼å‘æœåŠ¡å™¨å‘é€ä¸€äº›åˆ«çš„ä¿¡æ¯ï¼Œä¹‹åå®¢æˆ·ç«¯å‘é€äº†ä¸€ç©ºç™½è¡Œæ¥é€šçŸ¥æœåŠ¡å™¨ï¼Œå®ƒå·²ç»ç»“æŸäº†è¯¥å¤´ä¿¡æ¯çš„å‘é€ï¼› 4.æœåŠ¡å™¨åº”ç­” å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚åï¼ŒæœåŠ¡å™¨ä¼šå®¢æˆ·ç«¯è¿”å›å“åº”ï¼› ä¾‹å¦‚ï¼š HTTP/1.1 200 OK å“åº”çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯åè®®çš„ç‰ˆæœ¬å·å’Œå“åº”çŠ¶æ€ç  5.æœåŠ¡å™¨è¿”å›å“åº”å¤´ä¿¡æ¯ æ­£å¦‚å®¢æˆ·ç«¯ä¼šéšåŒè¯·æ±‚å‘é€å…³äºè‡ªèº«çš„ä¿¡æ¯ä¸€æ ·ï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šéšåŒå“åº”å‘ç”¨æˆ·å‘é€å…³äºå®ƒè‡ªå·±çš„æ•°æ®åŠè¢«è¯·æ±‚çš„æ–‡æ¡£ï¼› 6.æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ® æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€å¤´ä¿¡æ¯åï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªç©ºç™½è¡Œæ¥è¡¨ç¤ºå¤´ä¿¡æ¯çš„å‘é€åˆ°æ­¤ä¸ºç»“æŸï¼Œæ¥ç€ï¼Œå®ƒå°±ä»¥ Content-Type å“åº”å¤´ä¿¡æ¯æ‰€æè¿°çš„æ ¼å¼å‘é€ç”¨æˆ·æ‰€è¯·æ±‚çš„å®é™…æ•°æ®ï¼› 7.æœåŠ¡å™¨å…³é—­ TCP è¿æ¥ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€æ—¦æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿”å›äº†è¯·æ±‚æ•°æ®ï¼Œå®ƒå°±è¦å…³é—­ TCP è¿æ¥ï¼Œç„¶åå¦‚æœå®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨åœ¨å…¶å¤´ä¿¡æ¯åŠ å…¥äº†è¿™è¡Œä»£ç  Connection:keep-alive ï¼ŒTCP è¿æ¥åœ¨å‘é€åå°†ä»ç„¶ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œäºæ˜¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç»§ç»­é€šè¿‡ç›¸åŒçš„è¿æ¥å‘é€è¯·æ±‚ã€‚ä¿æŒè¿æ¥èŠ‚çœäº†ä¸ºæ¯ä¸ªè¯·æ±‚å»ºç«‹æ–°è¿æ¥æ‰€éœ€çš„æ—¶é—´ï¼Œè¿˜èŠ‚çº¦äº†ç½‘ç»œå¸¦å®½ã€‚ ä¸‰ã€HTTP åè®®åŸºç¡€ 3.1 é€šè¿‡è¯·æ±‚å’Œå“åº”çš„äº¤æ¢è¾¾æˆé€šä¿¡ åº”ç”¨ HTTP åè®®æ—¶ï¼Œå¿…å®šæ˜¯ä¸€ç«¯æ‹…ä»»å®¢æˆ·ç«¯è§’è‰²ï¼Œå¦ä¸€ç«¯æ‹…ä»»æœåŠ¡å™¨ç«¯è§’è‰²ã€‚ä»…ä»ä¸€æ¡é€šä¿¡çº¿è·¯æ¥è¯´ï¼ŒæœåŠ¡å™¨ç«¯å’Œå®¢æœç«¯çš„è§’è‰²æ˜¯ç¡®å®šçš„ã€‚HTTP åè®®è§„å®šï¼Œè¯·æ±‚ä»å®¢æˆ·ç«¯å‘å‡ºï¼Œæœ€åæœåŠ¡å™¨ç«¯å“åº”è¯¥è¯·æ±‚å¹¶è¿”å›ã€‚æ¢å¥è¯è¯´ï¼Œè‚¯å®šæ˜¯å…ˆä»å®¢æˆ·ç«¯å¼€å§‹å»ºç«‹é€šä¿¡çš„ï¼ŒæœåŠ¡å™¨ç«¯åœ¨æ²¡æœ‰æ¥æ”¶åˆ°è¯·æ±‚ä¹‹å‰ä¸ä¼šå‘é€å“åº”ã€‚ 3.2 HTTP æ˜¯ä¸ä¿å­˜çŠ¶æ€çš„åè®® HTTP æ˜¯ä¸€ç§æ— çŠ¶æ€åè®®ã€‚åè®®è‡ªèº«ä¸å¯¹è¯·æ±‚å’Œå“åº”ä¹‹é—´çš„é€šä¿¡çŠ¶æ€è¿›è¡Œä¿å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ HTTP è¿™ä¸ªçº§åˆ«ï¼Œåè®®å¯¹äºå‘é€è¿‡çš„è¯·æ±‚æˆ–å“åº”éƒ½ä¸åšæŒä¹…åŒ–å¤„ç†ã€‚è¿™æ˜¯ä¸ºäº†æ›´å¿«åœ°å¤„ç†å¤§é‡äº‹åŠ¡ï¼Œç¡®ä¿åè®®çš„å¯ä¼¸ç¼©æ€§ï¼Œè€Œç‰¹æ„æŠŠ HTTP åè®®è®¾è®¡æˆå¦‚æ­¤ç®€å•çš„ã€‚ å¯æ˜¯éšç€ Web çš„ä¸æ–­å‘å±•ï¼Œæˆ‘ä»¬çš„å¾ˆå¤šä¸šåŠ¡éƒ½éœ€è¦å¯¹é€šä¿¡çŠ¶æ€è¿›è¡Œä¿å­˜ã€‚äºæ˜¯æˆ‘ä»¬å¼•å…¥äº† Cookie æŠ€æœ¯ã€‚æœ‰äº† Cookie å†ç”¨ HTTP åè®®é€šä¿¡ï¼Œå°±å¯ä»¥ç®¡ç†çŠ¶æ€äº†ã€‚ 3.3 ä½¿ç”¨ Cookie çš„çŠ¶æ€ç®¡ç† Cookie æŠ€æœ¯é€šè¿‡åœ¨è¯·æ±‚å’Œå“åº”æŠ¥æ–‡ä¸­å†™å…¥ Cookie ä¿¡æ¯æ¥æ§åˆ¶å®¢æˆ·ç«¯çš„çŠ¶æ€ã€‚Cookie ä¼šæ ¹æ®ä»æœåŠ¡å™¨ç«¯å‘é€çš„å“åº”æŠ¥æ–‡å†…çš„ä¸€ä¸ªå«åš Set-Cookie çš„é¦–éƒ¨å­—æ®µä¿¡æ¯ï¼Œé€šçŸ¥å®¢æˆ·ç«¯ä¿å­˜Cookieã€‚å½“ä¸‹æ¬¡å®¢æˆ·ç«¯å†å¾€è¯¥æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨åœ¨è¯·æ±‚æŠ¥æ–‡ä¸­åŠ å…¥ Cookie å€¼åå‘é€å‡ºå»ã€‚æœåŠ¡å™¨ç«¯å‘ç°å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„ Cookie åï¼Œä¼šå»æ£€æŸ¥ç©¶ç«Ÿæ˜¯ä»å“ªä¸€ä¸ªå®¢æˆ·ç«¯å‘æ¥çš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå¯¹æ¯”æœåŠ¡å™¨ä¸Šçš„è®°å½•ï¼Œæœ€åå¾—åˆ°ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ã€‚ Cookie çš„æµç¨‹ 3.4 è¯·æ±‚ URI å®šä½èµ„æº HTTP åè®®ä½¿ç”¨ URI å®šä½äº’è”ç½‘ä¸Šçš„èµ„æºã€‚æ­£æ˜¯å› ä¸º URI çš„ç‰¹å®šåŠŸèƒ½ï¼Œåœ¨äº’è”ç½‘ä¸Šä»»æ„ä½ç½®çš„èµ„æºéƒ½èƒ½è®¿é—®åˆ°ã€‚ 3.5 å‘ŠçŸ¥æœåŠ¡å™¨æ„å›¾çš„ HTTP æ–¹æ³•ï¼ˆHTTP/1.1ï¼‰ æ–¹æ³• æè¿° è¯·æ±‚ å“åº” GET ç”¨æ¥è¯·æ±‚è®¿é—®å·²è¢«URIè¯†åˆ«çš„èµ„æºæŒ‡å®šçš„èµ„æºç»æœåŠ¡å™¨ç«¯è§£æåè¿”å›å“åº”å†…å®¹ GET /index.html HTTP/1.1Host: www.baidu.com è¿”å›index.htmlçš„é¡µé¢èµ„æº POST ç”¨æ¥ä¼ è¾“å®ä½“çš„ä¸»ä½“è™½ç„¶ç”¨GETæ–¹æ³•ä¹Ÿå¯ä»¥ä¼ è¾“å®ä½“çš„ä¸»ä½“ï¼Œä½†ä¸€èˆ¬ä¸ç”¨GETæ–¹æ³•è¿›è¡Œä¼ è¾“ï¼Œè€Œæ˜¯ç”¨POSTæ–¹æ³•è™½è¯´POSTçš„åŠŸèƒ½ä¸GETç›¸ä¼¼ï¼Œä½†POSTçš„ä¸»è¦ç›®çš„å¹¶ä¸æ˜¯è·å–å“åº”çš„ä¸»ä½“å†…å®¹ POST /submit.cgi HTTP/1.1Host: www.baidu.comContent-Length: 1500(1500å­—èŠ‚çš„æ•°æ®) è¿”å›submit.cgiæ¥æ”¶æ•°æ®çš„å¤„ç†ç»“æœ PUT ç”¨æ¥ä¼ è¾“æ–‡ä»¶å°±åƒFTPåè®®çš„æ–‡ä»¶ä¸Šä¼ ä¸€æ ·ï¼Œè¦æ±‚åœ¨è¯·æ±‚æŠ¥æ–‡çš„ä¸»ä½“ä¸­åŒ…å«æ–‡ä»¶çš„å†…å®¹ï¼Œç„¶åä¿å­˜åˆ°è¯·æ±‚URIæŒ‡å®šçš„ä½ç½® PUT /example.html HTTP/1.1Host: www.baidu.comContent-Type: text/htmlContent-Length: 1560(1560å­—èŠ‚çš„æ•°æ®) å“åº”è¿”å›çŠ¶æ€å— 204 No Content(æ¯”å¦‚ï¼šè¯¥htmlå·²å­˜åœ¨äºæœåŠ¡å™¨ä¸Š) HEAD ç”¨äºç¡®è®¤URIçš„æœ‰æ•ˆæ€§åŠèµ„æºæ›´æ–°çš„æ—¥æœŸæ—¶é—´ç­‰ï¼Œå’ŒGETæ–¹æ³•ä¸€æ ·ï¼Œåªæ˜¯ä¸è¿”å›æŠ¥æ–‡ä¸»ä½“éƒ¨åˆ† HEAD /index.html HTTP/1.1Host: www.baidu.com è¿”å›index.htmlæœ‰å…³çš„å“åº”å¤´éƒ¨ DELETE ç”¨æ¥åˆ é™¤æ–‡ä»¶ï¼Œæ˜¯ä¸PUT ç›¸åçš„æ–¹æ³•æŒ‰è¯·æ±‚URIåˆ é™¤æŒ‡å®šçš„èµ„æº DELETE /example.html HTTP/1.1Host: www.baidu.com å“åº”è¿”å›çŠ¶æ€å— 204 No Content(æ¯”å¦‚ï¼šè¯¥htmlå·²å­˜åœ¨äºæœåŠ¡å™¨ä¸Š) OPTIONS ç”¨æ¥æŸ¥è¯¢é’ˆå¯¹è¯·æ±‚URIæŒ‡å®šçš„èµ„æºæ”¯æŒçš„æ–¹æ³• OPTIONS * HTTP/1.1Host: www.baidu.com HTTP/1.1 200 OKAllow: GET,POST,HEAD,OPTIONS(è¿”å›æœåŠ¡å™¨æ”¯æŒçš„æ–¹æ³•) TRACE è®©webæœåŠ¡å™¨ç«¯å°†ä¹‹å‰çš„è¯·æ±‚é€šä¿¡ç¯å›ç»™å®¢æˆ·ç«¯çš„æ–¹æ³•å‘é€è¯·æ±‚æ—¶ï¼Œåœ¨Max-Forwardsé¦–éƒ¨å­—æ®µä¸­å¡«å…¥æ•°å€¼ï¼Œæ¯ç»è¿‡ä¸€ä¸ªæœåŠ¡ç«¯å°±å°†è¯¥æ•°å­—å‡1ï¼Œå½“æ•°å€¼åˆšå¥½å‰‘åˆ°0æ—¶å°±åœæ­¢æŒç»­ä¼ è¾“ï¼Œæœ€åæ¥æ”¶åˆ°è¯·æ±‚çš„æœåŠ¡ç«¯åˆ™è¿”å›çŠ¶æ€ç  200 OK çš„å“åº” TRACE /HTTP/1.1Host: www.baidu.comMax-Forwards: 2 HTTP/1.1 200 OkContent-Type: message/httpContent-Length: 1024TRACE / HTTP/1.1Host: www.baidu.comMax-Forwards: 2(è¿”å›å“åº”åŒ…å«è¯·æ±‚å†…å®¹) CONNECT è¦æ±‚åœ¨ä¸ä»£ç†æœåŠ¡å™¨é€šä¿¡æ—¶å»ºç«‹éš§é“ï¼Œå®ç°ç”¨éš§é“åè®®è¿›è¡ŒTCPé€šä¿¡ï¼Œä¸»è¦ä½¿ç”¨SSLå’ŒTLSåè®®æŠŠé€šä¿¡å†…å®¹åŠ å¯†åç»ç½‘ç»œéš§é“ä¼ è¾“ CONNECT proxy.sample.com:8000 HTTP/1.1Host: proxy.sample.com HTTP/1.1 200 OK(ä¹‹åè¿›å…¥ç½‘ç»œéš§é“) 3.6 æŒä¹…è¿æ¥ HTTP åè®®çš„åˆå§‹ç‰ˆæœ¬ä¸­ï¼Œæ¯è¿›è¡Œä¸€ä¸ª HTTP é€šä¿¡éƒ½è¦æ–­å¼€ä¸€æ¬¡ TCP è¿æ¥ã€‚æ¯”å¦‚ä½¿ç”¨æµè§ˆå™¨æµè§ˆä¸€ä¸ªåŒ…å«å¤šå¼ å›¾ç‰‡çš„ HTML é¡µé¢æ—¶ï¼Œåœ¨å‘é€è¯·æ±‚è®¿é—® HTML é¡µé¢èµ„æºçš„åŒæ—¶ï¼Œä¹Ÿä¼šè¯·æ±‚è¯¥ HTML é¡µé¢é‡ŒåŒ…å«çš„å…¶ä»–èµ„æºã€‚å› æ­¤ï¼Œæ¯æ¬¡çš„è¯·æ±‚éƒ½ä¼šé€ æˆæ— ç•çš„ TCP è¿æ¥å»ºç«‹å’Œæ–­å¼€ï¼Œå¢åŠ é€šä¿¡é‡çš„å¼€é”€ã€‚ ä¸ºäº†è§£å†³ä¸Šè¿° TCP è¿æ¥çš„é—®é¢˜ï¼ŒHTTP/1.1 å’Œéƒ¨åˆ† HTTP/1.0 æƒ³å‡ºäº†æŒä¹…è¿æ¥çš„æ–¹æ³•ã€‚å…¶ç‰¹ç‚¹æ˜¯ï¼Œåªè¦ä»»æ„ä¸€ç«¯æ²¡æœ‰æ˜ç¡®æå‡ºæ–­å¼€è¿æ¥ï¼Œåˆ™ä¿æŒ TCP è¿æ¥çŠ¶æ€ã€‚æ—¨åœ¨å»ºç«‹ä¸€æ¬¡ TCP è¿æ¥åè¿›è¡Œå¤šæ¬¡è¯·æ±‚å’Œå“åº”çš„äº¤äº’ã€‚åœ¨ HTTP/1.1 ä¸­ï¼Œæ‰€æœ‰çš„è¿æ¥é»˜è®¤éƒ½æ˜¯æŒä¹…è¿æ¥ã€‚ 3.7 ç®¡çº¿åŒ– æŒä¹…è¿æ¥ä½¿å¾—å¤šæ•°è¯·æ±‚ä»¥ç®¡çº¿åŒ–æ–¹å¼å‘é€æˆä¸ºå¯èƒ½ã€‚ä»¥å‰å‘é€è¯·æ±‚åéœ€ç­‰å¾…å¹¶æ¥æ”¶åˆ°å“åº”ï¼Œæ‰èƒ½å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚ç®¡çº¿åŒ–æŠ€æœ¯å‡ºç°åï¼Œä¸ç”¨ç­‰å¾…äº¦å¯å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚è¿™æ ·å°±èƒ½åšåˆ°åŒæ—¶å¹¶è¡Œå‘é€å¤šä¸ªè¯·æ±‚ï¼Œè€Œä¸éœ€è¦ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°ç­‰å¾…å“åº”äº†ã€‚ æ¯”å¦‚ï¼Œå½“è¯·æ±‚ä¸€ä¸ªåŒ…å«å¤šå¼ å›¾ç‰‡çš„ HTML é¡µé¢æ—¶ï¼Œä¸æŒ¨ä¸ªè¿æ¥ç›¸æ¯”ï¼Œç”¨æŒä¹…è¿æ¥å¯ä»¥è®©è¯·æ±‚æ›´å¿«ç»“æŸã€‚è€Œç®¡çº¿åŒ–æŠ€æœ¯è¦æ¯”æŒä¹…è¿æ¥é€Ÿåº¦æ›´å¿«ã€‚è¯·æ±‚æ•°è¶Šå¤šï¼Œæ—¶é—´å·®å°±è¶Šæ˜æ˜¾ã€‚ å››ã€HTTP åè®®æŠ¥æ–‡ç»“æ„ 4.1 HTTP æŠ¥æ–‡ ç”¨äº HTTP åè®®äº¤äº’çš„ä¿¡æ¯è¢«ç§°ä¸º HTTP æŠ¥æ–‡ã€‚è¯·æ±‚ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰çš„ HTTP æŠ¥æ–‡å«åšè¯·æ±‚æŠ¥æ–‡ï¼›å“åº”ç«¯ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰çš„å«åšå“åº”æŠ¥æ–‡ã€‚HTTP æŠ¥æ–‡æœ¬èº«æ˜¯ç”±å¤šè¡Œï¼ˆç”¨ CR+LF ä½œæ¢è¡Œç¬¦ï¼‰æ•°æ®æ„æˆçš„å­—ç¬¦ä¸²æ–‡æœ¬ã€‚ 4.2 HTTP æŠ¥æ–‡ç»“æ„ HTTP æŠ¥æ–‡å¤§è‡´å¯åˆ†ä¸ºæŠ¥æ–‡é¦–éƒ¨å’ŒæŠ¥æ–‡ä¸»ä½“ä¸¤éƒ¨åˆ†ã€‚ä¸¤è€…ç”±æœ€åˆå‡ºç°çš„ç©ºè¡Œï¼ˆCR+LFï¼‰æ¥åˆ’åˆ†ã€‚é€šå¸¸ï¼Œå¹¶ä¸ä¸€å®šæœ‰æŠ¥æ–‡ä¸»ä½“ã€‚å¦‚ä¸‹ï¼š HTTP æŠ¥æ–‡ç»“æ„ 4.2.1 è¯·æ±‚æŠ¥æ–‡ç»“æ„ è¯·æ±‚æŠ¥æ–‡ç»“æ„ è¯·æ±‚æŠ¥æ–‡çš„é¦–éƒ¨å†…å®¹ç”±ä»¥ä¸‹æ•°æ®ç»„æˆï¼š è¯·æ±‚è¡Œ â€”â€” åŒ…å«ç”¨äºè¯·æ±‚çš„æ–¹æ³•ã€è¯·æ±‚ URI å’Œ HTTP ç‰ˆæœ¬ã€‚ é¦–éƒ¨å­—æ®µ â€”â€” åŒ…å«è¡¨ç¤ºè¯·æ±‚çš„å„ç§æ¡ä»¶å’Œå±æ€§çš„å„ç±»é¦–éƒ¨ã€‚ï¼ˆé€šç”¨é¦–éƒ¨ã€è¯·æ±‚é¦–éƒ¨ã€å®ä½“é¦–éƒ¨ä»¥åŠRFCé‡Œæœªå®šä¹‰çš„é¦–éƒ¨å¦‚ Cookie ç­‰ï¼‰ è¯·æ±‚æŠ¥æ–‡çš„ç¤ºä¾‹ï¼Œå¦‚ä¸‹ï¼š 4.2.2 å“åº”æŠ¥æ–‡ç»“æ„ å“åº”æŠ¥æ–‡çš„é¦–éƒ¨å†…å®¹ç”±ä»¥ä¸‹æ•°æ®ç»„æˆï¼š çŠ¶æ€è¡Œ â€”â€” åŒ…å«è¡¨æ˜å“åº”ç»“æœçš„çŠ¶æ€ç ã€åŸå› çŸ­è¯­å’Œ HTTP ç‰ˆæœ¬ã€‚ é¦–éƒ¨å­—æ®µ â€”â€” åŒ…å«è¡¨ç¤ºè¯·æ±‚çš„å„ç§æ¡ä»¶å’Œå±æ€§çš„å„ç±»é¦–éƒ¨ã€‚ï¼ˆé€šç”¨é¦–éƒ¨ã€å“åº”é¦–éƒ¨ã€å®ä½“é¦–éƒ¨ä»¥åŠRFCé‡Œæœªå®šä¹‰çš„é¦–éƒ¨å¦‚ Cookie ç­‰ï¼‰ å“åº”æŠ¥æ–‡çš„ç¤ºä¾‹ï¼Œå¦‚ä¸‹ï¼š äº”ã€HTTP æŠ¥æ–‡é¦–éƒ¨ä¹‹è¯·æ±‚è¡Œã€çŠ¶æ€è¡Œ 5.1 è¯·æ±‚è¡Œ ä¸¾ä¸ªæ —å­ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ª HTTP è¯·æ±‚çš„æŠ¥æ–‡ï¼š GET /index.htm HTTP/1.1 Host: sample.com å…¶ä¸­ï¼Œä¸‹é¢çš„è¿™è¡Œå°±æ˜¯è¯·æ±‚è¡Œï¼Œ GET /index.htm HTTP/1.1 å¼€å¤´çš„ GET è¡¨ç¤ºè¯·æ±‚è®¿é—®æœåŠ¡å™¨çš„ç±»å‹ï¼Œç§°ä¸ºæ–¹æ³•ï¼› éšåçš„å­—ç¬¦ä¸² /index.htm æŒ‡æ˜äº†è¯·æ±‚è®¿é—®çš„èµ„æºå¯¹è±¡ï¼Œä¹Ÿå«åšè¯·æ±‚ URIï¼› æœ€åçš„ HTTP/1.1ï¼Œå³ HTTP çš„ç‰ˆæœ¬å·ï¼Œç”¨æ¥æç¤ºå®¢æˆ·ç«¯ä½¿ç”¨çš„ HTTP åè®®åŠŸèƒ½ã€‚ ç»¼åˆæ¥çœ‹ï¼Œå¤§æ„æ˜¯è¯·æ±‚è®¿é—®æŸå° HTTP æœåŠ¡å™¨ä¸Šçš„ /index.htm é¡µé¢èµ„æºã€‚ 5.2 çŠ¶æ€è¡Œ åŒæ ·ä¸¾ä¸ªæ —å­ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ª HTTP å“åº”çš„æŠ¥æ–‡ï¼š HTTP/1.1 200 OK Date: Mon, 10 Jul 2017 15:50:06 GMT Content-Length: 256 Content-Type: text/html ... å…¶ä¸­ï¼Œä¸‹é¢çš„è¿™è¡Œå°±æ˜¯çŠ¶æ€è¡Œï¼Œ HTTP/1.1 200 OK å¼€å¤´çš„ HTTP/1.1 è¡¨ç¤ºæœåŠ¡å™¨å¯¹åº”çš„ HTTP ç‰ˆæœ¬ï¼› ç´§æŒ¨ç€çš„ 200 OK è¡¨ç¤ºè¯·æ±‚çš„å¤„ç†ç»“æœçš„çŠ¶æ€ç å’ŒåŸå› çŸ­è¯­ã€‚ å…­ã€HTTP æŠ¥æ–‡é¦–éƒ¨ä¹‹é¦–éƒ¨å­—æ®µï¼ˆé‡ç‚¹åˆ†æï¼‰ 6.1 é¦–éƒ¨å­—æ®µæ¦‚è¿° å…ˆæ¥å›é¡¾ä¸€ä¸‹é¦–éƒ¨å­—æ®µåœ¨æŠ¥æ–‡çš„ä½ç½®ï¼ŒHTTP æŠ¥æ–‡åŒ…å«æŠ¥æ–‡é¦–éƒ¨å’ŒæŠ¥æ–‡ä¸»ä½“ï¼ŒæŠ¥æ–‡é¦–éƒ¨åŒ…å«è¯·æ±‚è¡Œï¼ˆæˆ–çŠ¶æ€è¡Œï¼‰å’Œé¦–éƒ¨å­—æ®µã€‚ åœ¨æŠ¥æ–‡ä¼—å¤šçš„å­—æ®µå½“ä¸­ï¼ŒHTTP é¦–éƒ¨å­—æ®µåŒ…å«çš„ä¿¡æ¯æœ€ä¸ºä¸°å¯Œã€‚é¦–éƒ¨å­—æ®µåŒæ—¶å­˜åœ¨äºè¯·æ±‚å’Œå“åº”æŠ¥æ–‡å†…ï¼Œå¹¶æ¶µç›– HTTP æŠ¥æ–‡ç›¸å…³çš„å†…å®¹ä¿¡æ¯ã€‚ä½¿ç”¨é¦–éƒ¨å­—æ®µæ˜¯ä¸ºäº†ç»™å®¢æœç«¯å’ŒæœåŠ¡å™¨ç«¯æä¾›æŠ¥æ–‡ä¸»ä½“å¤§å°ã€æ‰€ä½¿ç”¨çš„è¯­è¨€ã€è®¤è¯ä¿¡æ¯ç­‰å†…å®¹ã€‚ 6.2 é¦–éƒ¨å­—æ®µç»“æ„ HTTP é¦–éƒ¨å­—æ®µæ˜¯ç”±é¦–éƒ¨å­—æ®µåå’Œå­—æ®µå€¼æ„æˆçš„ï¼Œä¸­é—´ç”¨å†’å·â€œï¼šâ€åˆ†éš”ã€‚ å¦å¤–ï¼Œå­—æ®µå€¼å¯¹åº”å•ä¸ª HTTP é¦–éƒ¨å­—æ®µå¯ä»¥æœ‰å¤šä¸ªå€¼ã€‚ å½“ HTTP æŠ¥æ–‡é¦–éƒ¨ä¸­å‡ºç°äº†ä¸¤ä¸ªæˆ–ä»¥ä¸Šå…·æœ‰ç›¸åŒé¦–éƒ¨å­—æ®µåçš„é¦–éƒ¨å­—æ®µæ—¶ï¼Œè¿™ç§æƒ…å†µåœ¨è§„èŒƒå†…å°šæœªæ˜ç¡®ï¼Œæ ¹æ®æµè§ˆå™¨å†…éƒ¨å¤„ç†é€»è¾‘çš„ä¸åŒï¼Œä¼˜å…ˆå¤„ç†çš„é¡ºåºå¯èƒ½ä¸åŒï¼Œç»“æœå¯èƒ½å¹¶ä¸ä¸€è‡´ã€‚ é¦–éƒ¨å­—æ®µå å†’å· å­—æ®µå€¼ Content-Type ï¼š text/html Keep-Alive ï¼š timeout=30, max=120 6.3 é¦–éƒ¨å­—æ®µç±»å‹ é¦–éƒ¨å­—æ®µæ ¹æ®å®é™…ç”¨é€”è¢«åˆ†ä¸ºä»¥ä¸‹4ç§ç±»å‹ï¼š ç±»å‹ æè¿° é€šç”¨é¦–éƒ¨å­—æ®µ è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡ä¸¤æ–¹éƒ½ä¼šä½¿ç”¨çš„é¦–éƒ¨ è¯·æ±‚é¦–éƒ¨å­—æ®µ ä»å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€è¯·æ±‚æŠ¥æ–‡æ—¶ä½¿ç”¨çš„é¦–éƒ¨ã€‚è¡¥å……äº†è¯·æ±‚çš„é™„åŠ å†…å®¹ã€å®¢æˆ·ç«¯ä¿¡æ¯ã€å“åº”å†…å®¹ç›¸å…³ä¼˜å…ˆçº§ç­‰ä¿¡æ¯ å“åº”é¦–éƒ¨å­—æ®µ ä»æœåŠ¡å™¨ç«¯å‘å®¢æˆ·ç«¯è¿”å›å“åº”æŠ¥æ–‡æ—¶ä½¿ç”¨çš„é¦–éƒ¨ã€‚è¡¥å……äº†å“åº”çš„é™„åŠ å†…å®¹ï¼Œä¹Ÿä¼šè¦æ±‚å®¢æˆ·ç«¯é™„åŠ é¢å¤–çš„å†…å®¹ä¿¡æ¯ã€‚ å®ä½“é¦–éƒ¨å­—æ®µ é’ˆå¯¹è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡çš„å®ä½“éƒ¨åˆ†ä½¿ç”¨çš„é¦–éƒ¨ã€‚è¡¥å……äº†èµ„æºå†…å®¹æ›´æ–°æ—¶é—´ç­‰ä¸å®ä½“æœ‰å…³çš„çš„ä¿¡æ¯ã€‚ 6.4 é€šç”¨é¦–éƒ¨å­—æ®µï¼ˆHTTP/1.1ï¼‰ é¦–éƒ¨å­—æ®µå è¯´æ˜ Cache-Control æ§åˆ¶ç¼“å­˜çš„è¡Œä¸º Connection é€æŒ‘é¦–éƒ¨ã€è¿æ¥çš„ç®¡ç† Date åˆ›å»ºæŠ¥æ–‡çš„æ—¥æœŸæ—¶é—´ Pragma æŠ¥æ–‡æŒ‡ä»¤ Trailer æŠ¥æ–‡æœ«ç«¯çš„é¦–éƒ¨ä¸€è§ˆ Transfer-Encoding æŒ‡å®šæŠ¥æ–‡ä¸»ä½“çš„ä¼ è¾“ç¼–ç æ–¹å¼ Upgrade å‡çº§ä¸ºå…¶ä»–åè®® Via ä»£ç†æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯ Warning é”™è¯¯é€šçŸ¥ 6.4.1 Cache-Control é€šè¿‡æŒ‡å®šé¦–éƒ¨å­—æ®µ Cache-Control çš„æŒ‡ä»¤ï¼Œå°±èƒ½æ“ä½œç¼“å­˜çš„å·¥ä½œæœºåˆ¶ã€‚ 6.4.1.1 å¯ç”¨çš„æŒ‡ä»¤ä¸€è§ˆ å¯ç”¨çš„æŒ‡ä»¤æŒ‰è¯·æ±‚å’Œå“åº”åˆ†ç±»å¦‚ä¸‹ï¼š ç¼“å­˜è¯·æ±‚æŒ‡ä»¤ æŒ‡ä»¤ å‚æ•° è¯´æ˜ no-cache æ—  å¼ºåˆ¶å‘æœåŠ¡å™¨å†æ¬¡éªŒè¯ no-store æ—  ä¸ç¼“å­˜è¯·æ±‚æˆ–å“åº”çš„ä»»ä½•å†…å®¹ max-age = [ç§’] å¿…éœ€ å“åº”çš„æœ€å¤§Ageå€¼ max-stale( =[ç§’]) å¯çœç•¥ æ¥æ”¶å·²è¿‡æœŸçš„å“åº” min-fresh = [ç§’] å¿…éœ€ æœŸæœ›åœ¨æŒ‡å®šæ—¶é—´å†…çš„å“åº”ä»æœ‰æ•ˆ no-transform æ—  ä»£ç†ä¸å¯æ›´æ”¹åª’ä½“ç±»å‹ only-if-cached æ—  ä»ç¼“å­˜è·å–èµ„æº cache-extension - æ–°æŒ‡ä»¤æ ‡è®°ï¼ˆtokenï¼‰ ç¼“å­˜å“åº”æŒ‡ä»¤ æŒ‡ä»¤ å‚æ•° è¯´æ˜ public æ—  å¯å‘ä»»æ„æ–¹æä¾›å“åº”çš„ç¼“å­˜ private å¯çœç•¥ ä»…å‘ç‰¹å®šç”¨æˆ·è¿”å›å“åº” no-cache å¯çœç•¥ ç¼“å­˜å‰å¿…é¡»å…ˆç¡®è®¤å…¶æœ‰æ•ˆæ€§ no-store æ—  ä¸ç¼“å­˜è¯·æ±‚æˆ–å“åº”çš„ä»»ä½•å†…å®¹ no-transform æ—  ä»£ç†ä¸å¯æ›´æ”¹åª’ä½“ç±»å‹ must-revalidate æ—  å¯ç¼“å­˜ä½†å¿…é¡»å†å‘æºæœåŠ¡å™¨è¿›è¡Œç¡®è®¤ proxy-revalidate æ—  è¦æ±‚ä¸­é—´ç¼“å­˜æœåŠ¡å™¨å¯¹ç¼“å­˜çš„å“åº”æœ‰æ•ˆæ€§å†è¿›è¡Œç¡®è®¤ max-age = [ç§’] å¿…éœ€ å“åº”çš„æœ€å¤§Ageå€¼ s-maxage = [ç§’] å¿…éœ€ å…¬å…±ç¼“å­˜æœåŠ¡å™¨å“åº”çš„æœ€å¤§Ageå€¼ cache-extension - æ–°æŒ‡ä»¤æ ‡è®°ï¼ˆtokenï¼‰ 6.4.1.2 è¡¨ç¤ºèƒ½å¦ç¼“å­˜çš„æŒ‡ä»¤ public æŒ‡ä»¤ Cache-Control: public å½“æŒ‡å®šä½¿ç”¨ public æŒ‡ä»¤æ—¶ï¼Œåˆ™æ˜ç¡®è¡¨æ˜å…¶ä»–ç”¨æˆ·ä¹Ÿå¯åˆ©ç”¨ç¼“å­˜ã€‚ private æŒ‡ä»¤ Cache-Control: private å½“æŒ‡å®š private æŒ‡ä»¤åï¼Œå“åº”åªä»¥ç‰¹å®šçš„ç”¨æˆ·ä½œä¸ºå¯¹è±¡ï¼Œè¿™ä¸ public æŒ‡ä»¤çš„è¡Œä¸ºç›¸åã€‚ç¼“å­˜æœåŠ¡å™¨ä¼šå¯¹è¯¥ç‰¹å®šç”¨æˆ·æä¾›èµ„æºç¼“å­˜çš„æœåŠ¡ï¼Œå¯¹äºå…¶ä»–ç”¨æˆ·å‘é€è¿‡æ¥çš„è¯·æ±‚ï¼Œä»£ç†æœåŠ¡å™¨åˆ™ä¸ä¼šè¿”å›ç¼“å­˜ã€‚ no-cache æŒ‡ä»¤ Cache-Control: no-cache ä½¿ç”¨ no-cache æŒ‡ä»¤æ˜¯ä¸ºäº†é˜²æ­¢ä»ç¼“å­˜ä¸­è¿”å›è¿‡æœŸçš„èµ„æºã€‚ å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¸­å¦‚æœåŒ…å« no-cache æŒ‡ä»¤ï¼Œåˆ™è¡¨ç¤ºå®¢æˆ·ç«¯å°†ä¸ä¼šæ¥æ”¶ç¼“å­˜è¿‡çš„å“åº”ã€‚äºæ˜¯ï¼Œâ€œä¸­é—´â€çš„ç¼“å­˜æœåŠ¡å™¨å¿…é¡»æŠŠå®¢æˆ·ç«¯è¯·æ±‚è½¬å‘ç»™æºæœåŠ¡å™¨ã€‚ å¦‚æœæœåŠ¡å™¨ä¸­è¿”å›çš„å“åº”åŒ…å« no-cache æŒ‡ä»¤ï¼Œé‚£ä¹ˆç¼“å­˜æœåŠ¡å™¨ä¸èƒ½å¯¹èµ„æºè¿›è¡Œç¼“å­˜ã€‚æºæœåŠ¡å™¨ä»¥åä¹Ÿå°†ä¸å†å¯¹ç¼“å­˜æœåŠ¡å™¨è¯·æ±‚ä¸­æå‡ºçš„èµ„æºæœ‰æ•ˆæ€§è¿›è¡Œç¡®è®¤ï¼Œä¸”ç¦æ­¢å…¶å¯¹å“åº”èµ„æºè¿›è¡Œç¼“å­˜æ“ä½œã€‚ Cache-Control: no-cache=Location ç”±æœåŠ¡å™¨è¿”å›çš„å“åº”ä¸­ï¼Œè‹¥æŠ¥æ–‡é¦–éƒ¨å­—æ®µ Cache-Control ä¸­å¯¹ no-cache å­—æ®µåå…·ä½“æŒ‡å®šå‚æ•°å€¼ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°è¿™ä¸ªè¢«æŒ‡å®šå‚æ•°å€¼çš„é¦–éƒ¨å­—æ®µå¯¹åº”çš„å“åº”æŠ¥æ–‡åï¼Œå°±ä¸èƒ½ä½¿ç”¨ç¼“å­˜ã€‚æ¢è¨€ä¹‹ï¼Œæ— å‚æ•°å€¼çš„é¦–éƒ¨å­—æ®µå¯ä»¥ä½¿ç”¨ç¼“å­˜ã€‚åªèƒ½åœ¨å“åº”æŒ‡ä»¤ä¸­æŒ‡å®šè¯¥å‚æ•°ã€‚ no-store æŒ‡ä»¤ Cache-Control: no-store å½“ä½¿ç”¨ no-store æŒ‡ä»¤æ—¶ï¼Œæš—ç¤ºè¯·æ±‚ï¼ˆå’Œå¯¹åº”çš„å“åº”ï¼‰æˆ–å“åº”ä¸­åŒ…å«æœºå¯†ä¿¡æ¯ã€‚å› æ­¤ï¼Œè¯¥æŒ‡ä»¤è§„å®šç¼“å­˜ä¸èƒ½åœ¨æœ¬åœ°å­˜å‚¨è¯·æ±‚æˆ–å“åº”çš„ä»»ä¸€éƒ¨åˆ†ã€‚ æ³¨æ„ï¼šno-cache æŒ‡ä»¤ä»£è¡¨ä¸ç¼“å­˜è¿‡æœŸçš„æŒ‡ä»¤ï¼Œç¼“å­˜ä¼šå‘æºæœåŠ¡å™¨è¿›è¡Œæœ‰æ•ˆæœŸç¡®è®¤åå¤„ç†èµ„æºï¼›no-store æŒ‡ä»¤æ‰æ˜¯çœŸæ­£çš„ä¸è¿›è¡Œç¼“å­˜ã€‚ 6.4.1.3 æŒ‡å®šç¼“å­˜æœŸé™å’Œè®¤è¯çš„æŒ‡ä»¤ s-maxage æŒ‡ä»¤ Cache-Control: s-maxage=604800ï¼ˆå•ä½ï¼šç§’ï¼‰ s-maxage æŒ‡ä»¤çš„åŠŸèƒ½å’Œ max-age æŒ‡ä»¤çš„ç›¸åŒï¼Œå®ƒä»¬çš„ä¸åŒç‚¹æ˜¯ s-maxage æŒ‡ä»¤åªé€‚ç”¨äºä¾›å¤šä½ç”¨æˆ·ä½¿ç”¨çš„å…¬å…±ç¼“å­˜æœåŠ¡å™¨ï¼ˆä¸€èˆ¬æŒ‡ä»£ç†ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå‘åŒä¸€ç”¨æˆ·é‡å¤è¿”å›å“åº”çš„æœåŠ¡å™¨æ¥è¯´ï¼Œè¿™ä¸ªæŒ‡ä»¤æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚ å¦å¤–ï¼Œå½“ä½¿ç”¨ s-maxage æŒ‡ä»¤åï¼Œåˆ™ç›´æ¥å¿½ç•¥å¯¹ Expires é¦–éƒ¨å­—æ®µåŠ max-age æŒ‡ä»¤çš„å¤„ç†ã€‚ max-age æŒ‡ä»¤ Cache-Control: max-age=604800ï¼ˆå•ä½ï¼šç§’ï¼‰ å½“å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¸­åŒ…å« max-age æŒ‡ä»¤æ—¶ï¼Œå¦‚æœåˆ¤å®šç¼“å­˜èµ„æºçš„ç¼“å­˜æ—¶é—´æ•°å€¼æ¯”æŒ‡å®šçš„æ—¶é—´æ›´å°ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°±æ¥æ”¶ç¼“å­˜çš„èµ„æºã€‚å¦å¤–ï¼Œå½“æŒ‡å®š max-age çš„å€¼ä¸º0ï¼Œé‚£ä¹ˆç¼“å­˜æœåŠ¡å™¨é€šå¸¸éœ€è¦å°†è¯·æ±‚è½¬å‘ç»™æºæœåŠ¡å™¨ã€‚ å½“æœåŠ¡å™¨è¿”å›çš„å“åº”ä¸­åŒ…å« max-age æŒ‡ä»¤æ—¶ï¼Œç¼“å­˜æœåŠ¡å™¨å°†ä¸å¯¹èµ„æºçš„æœ‰æ•ˆæ€§å†ä½œç¡®è®¤ï¼Œè€Œ max-age æ•°å€¼ä»£è¡¨èµ„æºä¿å­˜ä¸ºç¼“å­˜çš„æœ€é•¿æ—¶é—´ã€‚ åº”ç”¨ HTTP/1.1 ç‰ˆæœ¬çš„ç¼“å­˜æœåŠ¡å™¨é‡åˆ°åŒæ—¶å­˜åœ¨ Expires é¦–éƒ¨å­—æ®µçš„æƒ…å†µæ—¶ï¼Œä¼šä¼˜å…ˆå¤„ç† max-age æŒ‡ä»¤ï¼Œå¹¶å¿½ç•¥æ‰ Expires é¦–éƒ¨å­—æ®µï¼›è€Œ HTTP/1.0 ç‰ˆæœ¬çš„ç¼“å­˜æœåŠ¡å™¨åˆ™ç›¸åã€‚ min-fresh æŒ‡ä»¤ Cache-Control: min-fresh=60ï¼ˆå•ä½ï¼šç§’ï¼‰ min-fresh æŒ‡ä»¤è¦æ±‚ç¼“å­˜æœåŠ¡å™¨è¿”å›è‡³å°‘è¿˜æœªè¿‡æŒ‡å®šæ—¶é—´çš„ç¼“å­˜èµ„æºã€‚ max-stale æŒ‡ä»¤ Cache-Control: max-stale=3600ï¼ˆå•ä½ï¼šç§’ï¼‰ ä½¿ç”¨ max-stale å¯æŒ‡ç¤ºç¼“å­˜èµ„æºï¼Œå³ä½¿è¿‡æœŸä¹Ÿç…§å¸¸æ¥æ”¶ã€‚ å¦‚æœæŒ‡ä»¤æœªæŒ‡å®šå‚æ•°å€¼ï¼Œé‚£ä¹ˆæ— è®ºç»è¿‡å¤šä¹…ï¼Œå®¢æˆ·ç«¯éƒ½ä¼šæ¥æ”¶å“åº”ï¼›å¦‚æœæŒ‡å®šäº†å…·ä½“å‚æ•°å€¼ï¼Œé‚£ä¹ˆå³ä½¿è¿‡æœŸï¼Œåªè¦ä»å¤„äº max-stale æŒ‡å®šçš„æ—¶é—´å†…ï¼Œä»æ—§ä¼šè¢«å®¢æˆ·ç«¯æ¥æ”¶ã€‚ only-if-cached æŒ‡ä»¤ Cache-Control: only-if-cached è¡¨ç¤ºå®¢æˆ·ç«¯ä»…åœ¨ç¼“å­˜æœåŠ¡å™¨æœ¬åœ°ç¼“å­˜ç›®æ ‡èµ„æºçš„æƒ…å†µä¸‹æ‰ä¼šè¦æ±‚å…¶è¿”å›ã€‚æ¢è¨€ä¹‹ï¼Œè¯¥æŒ‡ä»¤è¦æ±‚ç¼“å­˜æœåŠ¡å™¨ä¸é‡æ–°åŠ è½½å“åº”ï¼Œä¹Ÿä¸ä¼šå†æ¬¡ç¡®è®¤èµ„æºçš„æœ‰æ•ˆæ€§ã€‚ must-revalidate æŒ‡ä»¤ Cache-Control: must-revalidate ä½¿ç”¨ must-revalidate æŒ‡ä»¤ï¼Œä»£ç†ä¼šå‘æºæœåŠ¡å™¨å†æ¬¡éªŒè¯å³å°†è¿”å›çš„å“åº”ç¼“å­˜ç›®å‰æ˜¯å¦ä»æœ‰æ•ˆã€‚å¦å¤–ï¼Œä½¿ç”¨ must-revalidate æŒ‡ä»¤ä¼šå¿½ç•¥è¯·æ±‚çš„ max-stale æŒ‡ä»¤ã€‚ proxy-revalidate æŒ‡ä»¤ Cache-Control: proxy-revalidate proxy-revalidate æŒ‡ä»¤è¦æ±‚æ‰€æœ‰çš„ç¼“å­˜æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯å¸¦æœ‰è¯¥æŒ‡ä»¤çš„è¯·æ±‚è¿”å›å“åº”ä¹‹å‰ï¼Œå¿…é¡»å†æ¬¡éªŒè¯ç¼“å­˜çš„æœ‰æ•ˆæ€§ã€‚ no-transform æŒ‡ä»¤ Cache-Control: no-transform ä½¿ç”¨ no-transform æŒ‡ä»¤è§„å®šæ— è®ºæ˜¯åœ¨è¯·æ±‚è¿˜æ˜¯å“åº”ä¸­ï¼Œç¼“å­˜éƒ½ä¸èƒ½æ”¹å˜å®ä½“ä¸»ä½“çš„åª’ä½“ç±»å‹ã€‚è¿™æ ·åšå¯é˜²æ­¢ç¼“å­˜æˆ–ä»£ç†å‹ç¼©å›¾ç‰‡ç­‰ç±»ä¼¼æ“ä½œã€‚ 6.4.1.4 Cache-Control æ‰©å±• Cache-Control: private, community=\"UCI\" é€šè¿‡ cache-extension æ ‡è®°ï¼ˆtokenï¼‰ï¼Œå¯ä»¥æ‰©å±• Cache-Control é¦–éƒ¨å­—æ®µå†…çš„æŒ‡ä»¤ã€‚ä¸Šè¿° community æŒ‡ä»¤å³æ‰©å±•çš„æŒ‡ä»¤ï¼Œå¦‚æœç¼“å­˜æœåŠ¡å™¨ä¸èƒ½ç†è§£è¿™ä¸ªæ–°æŒ‡ä»¤ï¼Œå°±ä¼šç›´æ¥å¿½ç•¥æ‰ã€‚ 6.4.2 Connection Connection é¦–éƒ¨å­—æ®µå…·å¤‡ä»¥ä¸‹ä¸¤ä¸ªä½œç”¨ï¼š æ§åˆ¶ä¸å†è½¬å‘çš„é¦–éƒ¨å­—æ®µ Connection: Upgrade åœ¨å®¢æˆ·ç«¯å‘é€è¯·æ±‚å’ŒæœåŠ¡å™¨è¿”å›å“åº”ä¸­ï¼Œä½¿ç”¨ Connection é¦–éƒ¨å­—æ®µï¼Œå¯æ§åˆ¶ä¸å†è½¬å‘ç»™ä»£ç†çš„é¦–éƒ¨å­—æ®µï¼Œå³åˆ é™¤åå†è½¬å‘ï¼ˆå³Hop-by-hopé¦–éƒ¨ï¼‰ã€‚ ç®¡ç†æŒä¹…è¿æ¥ Connection: close HTTP/1.1 ç‰ˆæœ¬çš„é»˜è®¤è¿æ¥éƒ½æ˜¯æŒä¹…è¿æ¥ã€‚å½“æœåŠ¡å™¨ç«¯æƒ³æ˜ç¡®æ–­å¼€è¿æ¥æ—¶ï¼Œåˆ™æŒ‡å®š Connection é¦–éƒ¨å­—æ®µçš„å€¼ä¸º closeã€‚ Connection: Keep-Alive HTTP/1.1 ä¹‹å‰çš„ HTTP ç‰ˆæœ¬çš„é»˜è®¤è¿æ¥éƒ½æ˜¯éæŒä¹…è¿æ¥ã€‚ä¸ºæ­¤ï¼Œå¦‚æœæƒ³åœ¨æ—§ç‰ˆæœ¬çš„ HTTP åè®®ä¸Šç»´æŒæŒç»­è¿æ¥ï¼Œåˆ™éœ€è¦æŒ‡å®š Connection é¦–éƒ¨å­—æ®µçš„å€¼ä¸º Keep-Aliveã€‚ 6.4.3 Date è¡¨æ˜åˆ›å»º HTTP æŠ¥æ–‡çš„æ—¥æœŸå’Œæ—¶é—´ã€‚ Date: Mon, 10 Jul 2017 15:50:06 GMT HTTP/1.1 åè®®ä½¿ç”¨åœ¨ RFC1123 ä¸­è§„å®šçš„æ—¥æœŸæ—¶é—´çš„æ ¼å¼ã€‚ 6.4.4 Pragma Pragma é¦–éƒ¨å­—æ®µæ˜¯ HTTP/1.1 ç‰ˆæœ¬ä¹‹å‰çš„å†å²é—ç•™å­—æ®µï¼Œä»…ä½œä¸ºä¸ HTTP/1.0 çš„å‘åå…¼å®¹è€Œå®šä¹‰ã€‚ Pragma: no-cache è¯¥é¦–éƒ¨å­—æ®µå±äºé€šç”¨é¦–éƒ¨å­—æ®µï¼Œä½†åªç”¨åœ¨å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¸­ï¼Œè¦æ±‚æ‰€æœ‰çš„ä¸­é—´æœåŠ¡å™¨ä¸è¿”å›ç¼“å­˜çš„èµ„æºã€‚ æ‰€æœ‰çš„ä¸­é—´æœåŠ¡å™¨å¦‚æœéƒ½èƒ½ä»¥ HTTP/1.1 ä¸ºåŸºå‡†ï¼Œé‚£ç›´æ¥é‡‡ç”¨ Cache-Control: no-cache æŒ‡å®šç¼“å­˜çš„å¤„ç†æ–¹å¼æœ€ä¸ºç†æƒ³ã€‚ä½†æ˜¯è¦æ•´ä½“æŒæ¡æ‰€æœ‰ä¸­é—´æœåŠ¡å™¨ä½¿ç”¨çš„ HTTP åè®®ç‰ˆæœ¬å´æ˜¯ä¸ç°å®çš„ï¼Œæ‰€ä»¥ï¼Œå‘é€çš„è¯·æ±‚ä¼šåŒæ—¶åŒ…å«ä¸‹é¢ä¸¤ä¸ªé¦–éƒ¨å­—æ®µï¼š Cache-Control: no-cache Pragma: no-cache 6.4.5 Trailer Trailer: Expires é¦–éƒ¨å­—æ®µ Trailer ä¼šäº‹å…ˆè¯´æ˜åœ¨æŠ¥æ–‡ä¸»ä½“åè®°å½•äº†å“ªäº›é¦–éƒ¨å­—æ®µã€‚å¯åº”ç”¨åœ¨ HTTP/1.1 ç‰ˆæœ¬åˆ†å—ä¼ è¾“ç¼–ç æ—¶ã€‚ 6.4.6 Transfer-Encoding Transfer-Encoding: chunked è§„å®šäº†ä¼ è¾“æŠ¥æ–‡ä¸»ä½“æ—¶é‡‡ç”¨çš„ç¼–ç æ–¹å¼ã€‚ HTTP/1.1 çš„ä¼ è¾“ç¼–ç æ–¹å¼ä»…å¯¹åˆ†å—ä¼ è¾“ç¼–ç æœ‰æ•ˆã€‚ 6.4.7 Upgrade Upgrade: TSL/1.0 ç”¨äºæ£€æµ‹ HTTP åè®®åŠå…¶ä»–åè®®æ˜¯å¦å¯ä½¿ç”¨æ›´é«˜çš„ç‰ˆæœ¬è¿›è¡Œé€šä¿¡ï¼Œå…¶å‚æ•°å€¼å¯ä»¥ç”¨æ¥æŒ‡å®šä¸€ä¸ªå®Œå…¨ä¸åŒçš„é€šä¿¡åè®®ã€‚ 6.4.8 Via Via: 1.1 a1.sample.com(Squid/2.7) ä¸ºäº†è¿½è¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´çš„è¯·æ±‚å’Œå“åº”æŠ¥æ–‡çš„ä¼ è¾“è·¯å¾„ã€‚ æŠ¥æ–‡ç»è¿‡ä»£ç†æˆ–ç½‘å…³æ—¶ï¼Œä¼šç°åœ¨é¦–éƒ¨å­—æ®µ Via ä¸­é™„åŠ è¯¥æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œç„¶åå†è¿›è¡Œè½¬å‘ã€‚ é¦–éƒ¨å­—æ®µ Via ä¸ä»…ç”¨äºè¿½è¸ªæŠ¥æ–‡çš„è½¬å‘ï¼Œè¿˜å¯é¿å…è¯·æ±‚å›ç¯çš„å‘ç”Ÿã€‚ 6.4.9 Warning è¯¥é¦–éƒ¨å­—æ®µé€šå¸¸ä¼šå‘ŠçŸ¥ç”¨æˆ·ä¸€äº›ä¸ç¼“å­˜ç›¸å…³çš„é—®é¢˜çš„è­¦å‘Šã€‚ Warning é¦–éƒ¨å­—æ®µçš„æ ¼å¼å¦‚ä¸‹ï¼š Warningï¼š[è­¦å‘Šç ][è­¦å‘Šçš„ä¸»æœº:ç«¯å£å·] \"[è­¦å‘Šå†…å®¹]\"([æ—¥æœŸæ—¶é—´]) æœ€åçš„æ—¥æœŸæ—¶é—´å¯çœç•¥ã€‚ HTTP/1.1 ä¸­å®šä¹‰äº†7ç§è­¦å‘Šï¼Œè­¦å‘Šç å¯¹åº”çš„è­¦å‘Šå†…å®¹ä»…æ¨èå‚è€ƒï¼Œå¦å¤–ï¼Œè­¦å‘Šç å…·å¤‡æ‰©å±•æ€§ï¼Œä»Šåæœ‰å¯èƒ½è¿½åŠ æ–°çš„è­¦å‘Šç ã€‚ è­¦å‘Šç  è­¦å‘Šå†…å®¹ è¯´æ˜ 110 Response is stale(å“åº”å·²è¿‡æœŸ) ä»£ç†è¿”å›å·²è¿‡æœŸçš„èµ„æº 111 Revalidation failed(å†éªŒè¯å¤±è´¥) ä»£ç†å†éªŒè¯èµ„æºæœ‰æ•ˆæ€§æ—¶å¤±è´¥ï¼ˆæœåŠ¡å™¨æ— æ³•åˆ°è¾¾ç­‰åŸå› ï¼‰ 112 Disconnection operation(æ–­å¼€è¿æ¥æ“ä½œ) ä»£ç†ä¸äº’è”ç½‘è¿æ¥è¢«æ•…æ„åˆ‡æ–­ 113 Heuristic expiration(è¯•æ¢æ€§è¿‡æœŸ) å“åº”çš„è¯•ç”¨æœŸè¶…è¿‡24å°æ—¶(æœ‰æ•ˆç¼“å­˜çš„è®¾å®šæ—¶é—´å¤§äº24å°æ—¶çš„æƒ…å†µä¸‹) 199 Miscellaneous warning(æ‚é¡¹è­¦å‘Š) ä»»æ„çš„è­¦å‘Šå†…å®¹ 214 Transformation applied(ä½¿ç”¨äº†è½¬æ¢) ä»£ç†å¯¹å†…å®¹ç¼–ç æˆ–åª’ä½“ç±»å‹ç­‰æ‰§è¡Œäº†æŸäº›å¤„ç†æ—¶ 299 Miscellaneous persistent warning(æŒä¹…æ‚é¡¹è­¦å‘Š) ä»»æ„çš„è­¦å‘Šå†…å®¹ 6.5 è¯·æ±‚é¦–éƒ¨å­—æ®µï¼ˆHTTP/1.1ï¼‰ é¦–éƒ¨å­—æ®µå è¯´æ˜ Accept ç”¨æˆ·ä»£ç†å¯å¤„ç†çš„åª’ä½“ç±»å‹ Accept-Charset ä¼˜å…ˆçš„å­—ç¬¦é›† Accept-Encoding ä¼˜å…ˆçš„å†…å®¹ç¼–ç  Accept-Language ä¼˜å…ˆçš„è¯­è¨€ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰ Authorization Webè®¤è¯ä¿¡æ¯ Expect æœŸå¾…æœåŠ¡å™¨çš„ç‰¹å®šè¡Œä¸º From ç”¨æˆ·çš„ç”µå­é‚®ç®±åœ°å€ Host è¯·æ±‚èµ„æºæ‰€åœ¨æœåŠ¡å™¨ If-Match æ¯”è¾ƒå®ä½“æ ‡è®°ï¼ˆETagï¼‰ If-Modified-Since æ¯”è¾ƒèµ„æºçš„æ›´æ–°æ—¶é—´ If-None-Match æ¯”è¾ƒå®ä½“æ ‡è®°ï¼ˆä¸ If-Macth ç›¸åï¼‰ If-Range èµ„æºæœªæ›´æ–°æ—¶å‘é€å®ä½“ Byte çš„èŒƒå›´è¯·æ±‚ If-Unmodified-Since æ¯”è¾ƒèµ„æºçš„æ›´æ–°æ—¶é—´(ä¸ If-Modified-Since ç›¸å) Max-Forwards æœ€å¤§ä¼ è¾“é€è·³æ•° Proxy-Authorization ä»£ç†æœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯ Range å®ä½“çš„å­—èŠ‚èŒƒå›´è¯·æ±‚ Referer å¯¹è¯·æ±‚ä¸­ URI çš„åŸå§‹è·å–æ–¹ TE ä¼ è¾“ç¼–ç çš„ä¼˜å…ˆçº§ User-Agent HTTP å®¢æˆ·ç«¯ç¨‹åºçš„ä¿¡æ¯ 6.5.1 Accept Accept: text/html, application/xhtml+xml, application/xml; q=0.5 Accept é¦–éƒ¨å­—æ®µå¯é€šçŸ¥æœåŠ¡å™¨ï¼Œç”¨æˆ·ä»£ç†èƒ½å¤Ÿå¤„ç†çš„åª’ä½“ç±»å‹åŠåª’ä½“ç±»å‹çš„ç›¸å¯¹ä¼˜å…ˆçº§ã€‚å¯ä½¿ç”¨ type/subtype è¿™ç§å½¢å¼ï¼Œä¸€æ¬¡æŒ‡å®šå¤šç§åª’ä½“ç±»å‹ã€‚ è‹¥æƒ³è¦ç»™æ˜¾ç¤ºçš„åª’ä½“ç±»å‹å¢åŠ ä¼˜å…ˆçº§ï¼Œåˆ™ä½¿ç”¨ q=[æ•°å€¼] æ¥è¡¨ç¤ºæƒé‡å€¼ï¼Œç”¨åˆ†å·ï¼ˆ;ï¼‰è¿›è¡Œåˆ†éš”ã€‚æƒé‡å€¼çš„èŒƒå›´ 0~1ï¼ˆå¯ç²¾ç¡®åˆ°å°æ•°ç‚¹åä¸‰ä½ï¼‰ï¼Œä¸” 1 ä¸ºæœ€å¤§å€¼ã€‚ä¸æŒ‡å®šæƒé‡å€¼æ—¶ï¼Œé»˜è®¤ä¸º 1ã€‚ 6.5.2 Accept-Charset Accept-Charset: iso-8859-5, unicode-1-1; q=0.8 Accept-Charset é¦–éƒ¨å­—æ®µå¯ç”¨æ¥é€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·ä»£ç†æ”¯æŒçš„å­—ç¬¦é›†åŠå­—ç¬¦é›†çš„ç›¸å¯¹ä¼˜å…ˆé¡ºåºã€‚å¦å¤–ï¼Œå¯ä¸€æ¬¡æ€§æŒ‡å®šå¤šç§å­—ç¬¦é›†ã€‚åŒæ ·ä½¿ç”¨ q=[æ•°å€¼] æ¥è¡¨ç¤ºç›¸å¯¹ä¼˜å…ˆçº§ã€‚ 6.5.3 Accept-Encoding Accept-Encoding: gzip, deflate Accept-Encoding é¦–éƒ¨å­—æ®µç”¨æ¥å‘ŠçŸ¥æœåŠ¡å™¨ç”¨æˆ·ä»£ç†æ”¯æŒçš„å†…å®¹ç¼–ç åŠå†…å®¹ç¼–ç çš„ä¼˜å…ˆé¡ºåºï¼Œå¹¶å¯ä¸€æ¬¡æ€§æŒ‡å®šå¤šç§å†…å®¹ç¼–ç ã€‚åŒæ ·ä½¿ç”¨ q=[æ•°å€¼] æ¥è¡¨ç¤ºç›¸å¯¹ä¼˜å…ˆçº§ã€‚ä¹Ÿå¯ä½¿ç”¨æ˜Ÿå·ï¼ˆ*ï¼‰ä½œä¸ºé€šé…ç¬¦ï¼ŒæŒ‡å®šä»»æ„çš„ç¼–ç æ ¼å¼ã€‚ 6.5.4 Accept-Language Accept-Lanuage: zh-cn,zh;q=0.7,en=us,en;q=0.3 å‘ŠçŸ¥æœåŠ¡å™¨ç”¨æˆ·ä»£ç†èƒ½å¤Ÿå¤„ç†çš„è‡ªç„¶è¯­è¨€é›†ï¼ˆæŒ‡ä¸­æ–‡æˆ–è‹±æ–‡ç­‰ï¼‰ï¼Œä»¥åŠè‡ªç„¶è¯­è¨€é›†çš„ç›¸å¯¹ä¼˜å…ˆçº§ï¼Œå¯ä¸€æ¬¡æ€§æŒ‡å®šå¤šç§è‡ªç„¶è¯­è¨€é›†ã€‚åŒæ ·ä½¿ç”¨ q=[æ•°å€¼] æ¥è¡¨ç¤ºç›¸å¯¹ä¼˜å…ˆçº§ã€‚ 6.5.5 Authorization Authorization: Basic ldfKDHKfkDdasSAEdasd== å‘ŠçŸ¥æœåŠ¡å™¨ç”¨æˆ·ä»£ç†çš„è®¤è¯ä¿¡æ¯ï¼ˆè¯ä¹¦å€¼ï¼‰ã€‚é€šå¸¸ï¼Œæƒ³è¦é€šè¿‡æœåŠ¡å™¨è®¤è¯çš„ç”¨æˆ·ä»£ç†ä¼šåœ¨æ¥æ”¶åˆ°è¿”å›çš„ 401 çŠ¶æ€ç å“åº”åï¼ŒæŠŠé¦–éƒ¨å­—æ®µ Authorization åŠ å…¥è¯·æ±‚ä¸­ã€‚å…±ç”¨ç¼“å­˜åœ¨æ¥æ”¶åˆ°å«æœ‰ Authorization é¦–éƒ¨å­—æ®µçš„è¯·æ±‚æ—¶çš„æ“ä½œå¤„ç†ä¼šç•¥æœ‰å·®å¼‚ã€‚ 6.5.6 Expect Expect: 100-continue å‘ŠçŸ¥æœåŠ¡å™¨å®¢æˆ·ç«¯æœŸæœ›å‡ºç°çš„æŸç§ç‰¹å®šè¡Œä¸ºã€‚ 6.5.7 From From: Deeson_Woo@163.com å‘ŠçŸ¥æœåŠ¡å™¨ä½¿ç”¨ç”¨æˆ·ä»£ç†çš„ç”µå­é‚®ä»¶åœ°å€ã€‚ 6.5.8 Host Host: www.jianshu.com å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œè¯·æ±‚çš„èµ„æºæ‰€å¤„çš„äº’è”ç½‘ä¸»æœºå’Œç«¯å£å·ã€‚ Host é¦–éƒ¨å­—æ®µæ˜¯ HTTP/1.1 è§„èŒƒå†…å”¯ä¸€ä¸€ä¸ªå¿…é¡»è¢«åŒ…å«åœ¨è¯·æ±‚å†…çš„é¦–éƒ¨å­—æ®µã€‚ è‹¥æœåŠ¡å™¨æœªè®¾å®šä¸»æœºåï¼Œé‚£ç›´æ¥å‘é€ä¸€ä¸ªç©ºå€¼å³å¯ Host: ã€‚ 6.5.9 If-Match å½¢å¦‚ If-xxx è¿™ç§æ ·å¼çš„è¯·æ±‚é¦–éƒ¨å­—æ®µï¼Œéƒ½å¯ç§°ä¸ºæ¡ä»¶è¯·æ±‚ã€‚æœåŠ¡å™¨æ¥æ”¶åˆ°é™„å¸¦æ¡ä»¶çš„è¯·æ±‚åï¼Œåªæœ‰åˆ¤æ–­æŒ‡å®šæ¡ä»¶ä¸ºçœŸæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œè¯·æ±‚ã€‚ If-Match: \"123456\" é¦–éƒ¨å­—æ®µ If-Matchï¼Œå±é™„å¸¦æ¡ä»¶ä¹‹ä¸€ï¼Œå®ƒä¼šå‘ŠçŸ¥æœåŠ¡å™¨åŒ¹é…èµ„æºæ‰€ç”¨çš„å®ä½“æ ‡è®°ï¼ˆETagï¼‰å€¼ã€‚è¿™æ—¶çš„æœåŠ¡å™¨æ— æ³•ä½¿ç”¨å¼± ETag å€¼ã€‚ æœåŠ¡å™¨ä¼šæ¯”å¯¹ If-Match çš„å­—æ®µå€¼å’Œèµ„æºçš„ ETag å€¼ï¼Œä»…å½“ä¸¤è€…ä¸€è‡´æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œè¯·æ±‚ã€‚åä¹‹ï¼Œåˆ™è¿”å›çŠ¶æ€ç  412 Precondition Failed çš„å“åº”ã€‚ è¿˜å¯ä»¥ä½¿ç”¨æ˜Ÿå·ï¼ˆ*ï¼‰æŒ‡å®š If-Match çš„å­—æ®µå€¼ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒæœåŠ¡å™¨å°†ä¼šå¿½ç•¥ ETag çš„å€¼ï¼Œåªè¦èµ„æºå­˜åœ¨å°±å¤„ç†è¯·æ±‚ã€‚ 6.5.10 If-Modified-Since If-Modified-Since: Mon, 10 Jul 2017 15:50:06 GMT é¦–éƒ¨å­—æ®µ If-Modified-Sinceï¼Œå±é™„å¸¦æ¡ä»¶ä¹‹ä¸€ï¼Œç”¨äºç¡®è®¤ä»£ç†æˆ–å®¢æˆ·ç«¯æ‹¥æœ‰çš„æœ¬åœ°èµ„æºçš„æœ‰æ•ˆæ€§ã€‚ å®ƒä¼šå‘ŠçŸ¥æœåŠ¡å™¨è‹¥ If-Modified-Since å­—æ®µå€¼æ—©äºèµ„æºçš„æ›´æ–°æ—¶é—´ï¼Œåˆ™å¸Œæœ›èƒ½å¤„ç†è¯¥è¯·æ±‚ã€‚è€Œåœ¨æŒ‡å®š If-Modified-Since å­—æ®µå€¼çš„æ—¥æœŸæ—¶é—´ä¹‹åï¼Œå¦‚æœè¯·æ±‚çš„èµ„æºéƒ½æ²¡æœ‰è¿‡æ›´æ–°ï¼Œåˆ™è¿”å›çŠ¶æ€ç  304 Not Modified çš„å“åº”ã€‚ 6.5.11 If-None-Match If-None-Match: \"123456\" é¦–éƒ¨å­—æ®µ If-None-Match å±äºé™„å¸¦æ¡ä»¶ä¹‹ä¸€ã€‚å®ƒå’Œé¦–éƒ¨å­—æ®µ If-Match ä½œç”¨ç›¸åã€‚ç”¨äºæŒ‡å®š If-None-Match å­—æ®µå€¼çš„å®ä½“æ ‡è®°ï¼ˆETagï¼‰å€¼ä¸è¯·æ±‚èµ„æºçš„ ETag ä¸ä¸€è‡´æ—¶ï¼Œå®ƒå°±å‘ŠçŸ¥æœåŠ¡å™¨å¤„ç†è¯¥è¯·æ±‚ã€‚ 6.5.12 If-Range If-Range: \"123456\" é¦–éƒ¨å­—æ®µ If-Range å±äºé™„å¸¦æ¡ä»¶ä¹‹ä¸€ã€‚å®ƒå‘ŠçŸ¥æœåŠ¡å™¨è‹¥æŒ‡å®šçš„ If-Range å­—æ®µå€¼ï¼ˆETag å€¼æˆ–è€…æ—¶é—´ï¼‰å’Œè¯·æ±‚èµ„æºçš„ ETag å€¼æˆ–æ—¶é—´ç›¸ä¸€è‡´æ—¶ï¼Œåˆ™ä½œä¸ºèŒƒå›´è¯·æ±‚å¤„ç†ã€‚åä¹‹ï¼Œåˆ™è¿”å›å…¨ä½“èµ„æºã€‚ ä¸‹é¢æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ä¸ä½¿ç”¨é¦–éƒ¨å­—æ®µ If-Range å‘é€è¯·æ±‚çš„æƒ…å†µã€‚æœåŠ¡å™¨ç«¯çš„èµ„æºå¦‚æœæ›´æ–°ï¼Œé‚£å®¢æˆ·ç«¯æŒæœ‰èµ„æºä¸­çš„ä¸€éƒ¨åˆ†ä¹Ÿä¼šéšä¹‹æ— æ•ˆï¼Œå½“ç„¶ï¼ŒèŒƒå›´è¯·æ±‚ä½œä¸ºå‰ææ˜¯æ— æ•ˆçš„ã€‚è¿™æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæš‚ä¸”ä»¥çŠ¶æ€ç  412 Precondition Failed ä½œä¸ºå“åº”è¿”å›ï¼Œå…¶ç›®çš„æ˜¯å‚¬ä¿ƒå®¢æˆ·ç«¯å†æ¬¡å‘é€è¯·æ±‚ã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸ä½¿ç”¨é¦–éƒ¨å­—æ®µ If-Range æ¯”èµ·æ¥ï¼Œå°±éœ€è¦èŠ±è´¹ä¸¤å€çš„åŠŸå¤«ã€‚ 6.5.13 If-Unmodified-Since If-Unmodified-Since: Mon, 10 Jul 2017 15:50:06 GMT é¦–éƒ¨å­—æ®µ If-Unmodified-Since å’Œé¦–éƒ¨å­—æ®µ If-Modified-Since çš„ä½œç”¨ç›¸åã€‚å®ƒçš„ä½œç”¨çš„æ˜¯å‘ŠçŸ¥æœåŠ¡å™¨ï¼ŒæŒ‡å®šçš„è¯·æ±‚èµ„æºåªæœ‰åœ¨å­—æ®µå€¼å†…æŒ‡å®šçš„æ—¥æœŸæ—¶é—´ä¹‹åï¼Œæœªå‘ç”Ÿæ›´æ–°çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½å¤„ç†è¯·æ±‚ã€‚å¦‚æœåœ¨æŒ‡å®šæ—¥æœŸæ—¶é—´åå‘ç”Ÿäº†æ›´æ–°ï¼Œåˆ™ä»¥çŠ¶æ€ç  412 Precondition Failed ä½œä¸ºå“åº”è¿”å›ã€‚ 6.5.14 Max-Forwards Max-Forwards: 10 é€šè¿‡ TRACE æ–¹æ³•æˆ– OPTIONS æ–¹æ³•ï¼Œå‘é€åŒ…å«é¦–éƒ¨å­—æ®µ Max-Forwards çš„è¯·æ±‚æ—¶ï¼Œè¯¥å­—æ®µä»¥åè¿›åˆ¶æ•´æ•°å½¢å¼æŒ‡å®šå¯ç»è¿‡çš„æœåŠ¡å™¨æœ€å¤§æ•°ç›®ã€‚æœåŠ¡å™¨åœ¨å¾€ä¸‹ä¸€ä¸ªæœåŠ¡å™¨è½¬å‘è¯·æ±‚ä¹‹å‰ï¼ŒMax-Forwards çš„å€¼å‡ 1 åé‡æ–°èµ‹å€¼ã€‚å½“æœåŠ¡å™¨æ¥æ”¶åˆ° Max-Forwards å€¼ä¸º 0 çš„è¯·æ±‚æ—¶ï¼Œåˆ™ä¸å†è¿›è¡Œè½¬å‘ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å“åº”ã€‚ 6.5.15 Proxy-Authorization Proxy-Authorization: Basic dGlwOjkpNLAGfFY5 æ¥æ”¶åˆ°ä»ä»£ç†æœåŠ¡å™¨å‘æ¥çš„è®¤è¯è´¨è¯¢æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå‘é€åŒ…å«é¦–éƒ¨å­—æ®µ Proxy-Authorization çš„è¯·æ±‚ï¼Œä»¥å‘ŠçŸ¥æœåŠ¡å™¨è®¤è¯æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚ è¿™ä¸ªè¡Œä¸ºæ˜¯ä¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ HTTP è®¿é—®è®¤è¯ç›¸ç±»ä¼¼çš„ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼Œè®¤è¯è¡Œä¸ºå‘ç”Ÿåœ¨å®¢æˆ·ç«¯ä¸ä»£ç†ä¹‹é—´ã€‚ 6.5.16 Range Range: bytes=5001-10000 å¯¹äºåªéœ€è·å–éƒ¨åˆ†èµ„æºçš„èŒƒå›´è¯·æ±‚ï¼ŒåŒ…å«é¦–éƒ¨å­—æ®µ Range å³å¯å‘ŠçŸ¥æœåŠ¡å™¨èµ„æºçš„æŒ‡å®šèŒƒå›´ã€‚ æ¥æ”¶åˆ°é™„å¸¦ Range é¦–éƒ¨å­—æ®µè¯·æ±‚çš„æœåŠ¡å™¨ï¼Œä¼šåœ¨å¤„ç†è¯·æ±‚ä¹‹åè¿”å›çŠ¶æ€ç ä¸º 206 Partial Content çš„å“åº”ã€‚æ— æ³•å¤„ç†è¯¥èŒƒå›´è¯·æ±‚æ—¶ï¼Œåˆ™ä¼šè¿”å›çŠ¶æ€ç  200 OK çš„å“åº”åŠå…¨éƒ¨èµ„æºã€‚ 6.5.17 Referer Referer: http://www.sample.com/index.html é¦–éƒ¨å­—æ®µ Referer ä¼šå‘ŠçŸ¥æœåŠ¡å™¨è¯·æ±‚çš„åŸå§‹èµ„æºçš„ URIã€‚ 6.5.18 TE TE: gzip, deflate; q=0.5 é¦–éƒ¨å­—æ®µ TE ä¼šå‘ŠçŸ¥æœåŠ¡å™¨å®¢æˆ·ç«¯èƒ½å¤Ÿå¤„ç†å“åº”çš„ä¼ è¾“ç¼–ç æ–¹å¼åŠç›¸å¯¹ä¼˜å…ˆçº§ã€‚å®ƒå’Œé¦–éƒ¨å­—æ®µ Accept-Encoding çš„åŠŸèƒ½å¾ˆç›¸åƒï¼Œä½†æ˜¯ç”¨äºä¼ è¾“ç¼–ç ã€‚ é¦–éƒ¨å­—æ®µ TE é™¤æŒ‡å®šä¼ è¾“ç¼–ç ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æŒ‡å®šä¼´éš trailer å­—æ®µçš„åˆ†å—ä¼ è¾“ç¼–ç çš„æ–¹å¼ã€‚åº”ç”¨åè€…æ—¶ï¼Œåªéœ€æŠŠ trailers èµ‹å€¼ç»™è¯¥å­—æ®µå€¼ã€‚TE: trailers 6.5.19 User-Agent User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:13.0) Gecko/20100101 é¦–éƒ¨å­—æ®µ User-Agent ä¼šå°†åˆ›å»ºè¯·æ±‚çš„æµè§ˆå™¨å’Œç”¨æˆ·ä»£ç†åç§°ç­‰ä¿¡æ¯ä¼ è¾¾ç»™æœåŠ¡å™¨ã€‚ ç”±ç½‘ç»œçˆ¬è™«å‘èµ·è¯·æ±‚æ—¶ï¼Œæœ‰å¯èƒ½ä¼šåœ¨å­—æ®µå†…æ·»åŠ çˆ¬è™«ä½œè€…çš„ç”µå­é‚®ä»¶åœ°å€ã€‚æ­¤å¤–ï¼Œå¦‚æœè¯·æ±‚ç»è¿‡ä»£ç†ï¼Œé‚£ä¹ˆä¸­é—´ä¹Ÿå¾ˆå¯èƒ½è¢«æ·»åŠ ä¸Šä»£ç†æœåŠ¡å™¨çš„åç§°ã€‚ 6.6 å“åº”é¦–éƒ¨å­—æ®µï¼ˆHTTP/1.1ï¼‰ é¦–éƒ¨å­—æ®µå è¯´æ˜ Accept-Ranges æ˜¯å¦æ¥å—å­—èŠ‚èŒƒå›´è¯·æ±‚ Age æ¨ç®—èµ„æºåˆ›å»ºç»è¿‡æ—¶é—´ ETag èµ„æºçš„åŒ¹é…ä¿¡æ¯ Location ä»¤å®¢æˆ·ç«¯é‡å®šå‘è‡³æŒ‡å®š URI Proxy-Authenticate ä»£ç†æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯ Retry-After å¯¹å†æ¬¡å‘èµ·è¯·æ±‚çš„æ—¶æœºè¦æ±‚ Server HTTP æœåŠ¡å™¨çš„å®‰è£…ä¿¡æ¯ Vary ä»£ç†æœåŠ¡å™¨ç¼“å­˜çš„ç®¡ç†ä¿¡æ¯ WWW-Authenticate æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯ 6.6.1 Accept-Ranges Accept-Ranges: bytes é¦–éƒ¨å­—æ®µ Accept-Ranges æ˜¯ç”¨æ¥å‘ŠçŸ¥å®¢æˆ·ç«¯æœåŠ¡å™¨æ˜¯å¦èƒ½å¤„ç†èŒƒå›´è¯·æ±‚ï¼Œä»¥æŒ‡å®šè·å–æœåŠ¡å™¨ç«¯æŸä¸ªéƒ¨åˆ†çš„èµ„æºã€‚ å¯æŒ‡å®šçš„å­—æ®µå€¼æœ‰ä¸¤ç§ï¼Œå¯å¤„ç†èŒƒå›´è¯·æ±‚æ—¶æŒ‡å®šå…¶ä¸º bytesï¼Œåä¹‹åˆ™æŒ‡å®šå…¶ä¸º noneã€‚ 6.6.2 Age Age: 1200 é¦–éƒ¨å­—æ®µ Age èƒ½å‘ŠçŸ¥å®¢æˆ·ç«¯ï¼ŒæºæœåŠ¡å™¨åœ¨å¤šä¹…å‰åˆ›å»ºäº†å“åº”ã€‚å­—æ®µå€¼çš„å•ä½ä¸ºç§’ã€‚ è‹¥åˆ›å»ºè¯¥å“åº”çš„æœåŠ¡å™¨æ˜¯ç¼“å­˜æœåŠ¡å™¨ï¼ŒAge å€¼æ˜¯æŒ‡ç¼“å­˜åçš„å“åº”å†æ¬¡å‘èµ·è®¤è¯åˆ°è®¤è¯å®Œæˆçš„æ—¶é—´å€¼ã€‚ä»£ç†åˆ›å»ºå“åº”æ—¶å¿…é¡»åŠ ä¸Šé¦–éƒ¨å­—æ®µ Ageã€‚ 6.6.3 ETag ETag: \"usagi-1234\" é¦–éƒ¨å­—æ®µ ETag èƒ½å‘ŠçŸ¥å®¢æˆ·ç«¯å®ä½“æ ‡è¯†ã€‚å®ƒæ˜¯ä¸€ç§å¯å°†èµ„æºä»¥å­—ç¬¦ä¸²å½¢å¼åšå”¯ä¸€æ€§æ ‡è¯†çš„æ–¹å¼ã€‚æœåŠ¡å™¨ä¼šä¸ºæ¯ä»½èµ„æºåˆ†é…å¯¹åº”çš„ ETag å€¼ã€‚ å¦å¤–ï¼Œå½“èµ„æºæ›´æ–°æ—¶ï¼ŒETag å€¼ä¹Ÿéœ€è¦æ›´æ–°ã€‚ç”Ÿæˆ ETag å€¼æ—¶ï¼Œå¹¶æ²¡æœ‰ç»Ÿä¸€çš„ç®—æ³•è§„åˆ™ï¼Œè€Œä»…ä»…æ˜¯ç”±æœåŠ¡å™¨æ¥åˆ†é…ã€‚ ETag ä¸­æœ‰å¼º ETag å€¼å’Œå¼± ETag å€¼ä¹‹åˆ†ã€‚å¼º ETag å€¼ï¼Œä¸è®ºå®ä½“å‘ç”Ÿå¤šä¹ˆç»†å¾®çš„å˜åŒ–éƒ½ä¼šæ”¹å˜å…¶å€¼ï¼›å¼± ETag å€¼åªç”¨äºæç¤ºèµ„æºæ˜¯å¦ç›¸åŒã€‚åªæœ‰èµ„æºå‘ç”Ÿäº†æ ¹æœ¬æ”¹å˜ï¼Œäº§ç”Ÿå·®å¼‚æ—¶æ‰ä¼šæ”¹å˜ ETag å€¼ã€‚è¿™æ—¶ï¼Œä¼šåœ¨å­—æ®µå€¼æœ€å¼€å§‹å¤„é™„åŠ  W/ï¼š ETag: W/\"usagi-1234\"ã€‚ 6.6.4 Location Location: http://www.sample.com/sample.html ä½¿ç”¨é¦–éƒ¨å­—æ®µ Location å¯ä»¥å°†å“åº”æ¥æ”¶æ–¹å¼•å¯¼è‡³æŸä¸ªä¸è¯·æ±‚ URI ä½ç½®ä¸åŒçš„èµ„æºã€‚ åŸºæœ¬ä¸Šï¼Œè¯¥å­—æ®µä¼šé…åˆ 3xx ï¼šRedirection çš„å“åº”ï¼Œæä¾›é‡å®šå‘çš„ URIã€‚ å‡ ä¹æ‰€æœ‰çš„æµè§ˆå™¨åœ¨æ¥æ”¶åˆ°åŒ…å«é¦–éƒ¨å­—æ®µ Location çš„å“åº”åï¼Œéƒ½ä¼šå¼ºåˆ¶æ€§åœ°å°è¯•å¯¹å·²æç¤ºçš„é‡å®šå‘èµ„æºçš„è®¿é—®ã€‚ 6.6.5 Proxy-Authenticate Proxy-Authenticate: Basic realm=\"Usagidesign Auth\" é¦–éƒ¨å­—æ®µ Proxy-Authenticate ä¼šæŠŠç”±ä»£ç†æœåŠ¡å™¨æ‰€è¦æ±‚çš„è®¤è¯ä¿¡æ¯å‘é€ç»™å®¢æˆ·ç«¯ã€‚ å®ƒä¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ HTTP è®¿é—®è®¤è¯çš„è¡Œä¸ºç›¸ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå…¶è®¤è¯è¡Œä¸ºæ˜¯åœ¨å®¢æˆ·ç«¯ä¸ä»£ç†ä¹‹é—´è¿›è¡Œçš„ã€‚ 6.6.6 Retry-After Retry-After: 180 é¦–éƒ¨å­—æ®µ Retry-After å‘ŠçŸ¥å®¢æˆ·ç«¯åº”è¯¥åœ¨å¤šä¹…ä¹‹åå†æ¬¡å‘é€è¯·æ±‚ã€‚ä¸»è¦é…åˆçŠ¶æ€ç  503 Service Unavailable å“åº”ï¼Œæˆ– 3xx Redirect å“åº”ä¸€èµ·ä½¿ç”¨ã€‚ å­—æ®µå€¼å¯ä»¥æŒ‡å®šä¸ºå…·ä½“çš„æ—¥æœŸæ—¶é—´ï¼ˆMon, 10 Jul 2017 15:50:06 GMT ç­‰æ ¼å¼ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ›å»ºå“åº”åçš„ç§’æ•°ã€‚ 6.6.7 Server Server: Apache/2.2.6 (Unix) PHP/5.2.5 é¦–éƒ¨å­—æ®µ Server å‘ŠçŸ¥å®¢æˆ·ç«¯å½“å‰æœåŠ¡å™¨ä¸Šå®‰è£…çš„ HTTP æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ã€‚ä¸å•å•ä¼šæ ‡å‡ºæœåŠ¡å™¨ä¸Šçš„è½¯ä»¶åº”ç”¨åç§°ï¼Œè¿˜æœ‰å¯èƒ½åŒ…æ‹¬ç‰ˆæœ¬å·å’Œå®‰è£…æ—¶å¯ç”¨çš„å¯é€‰é¡¹ã€‚ 6.6.8 Vary Vary: Accept-Language é¦–éƒ¨å­—æ®µ Vary å¯å¯¹ç¼“å­˜è¿›è¡Œæ§åˆ¶ã€‚æºæœåŠ¡å™¨ä¼šå‘ä»£ç†æœåŠ¡å™¨ä¼ è¾¾å…³äºæœ¬åœ°ç¼“å­˜ä½¿ç”¨æ–¹æ³•çš„å‘½ä»¤ã€‚ ä»ä»£ç†æœåŠ¡å™¨æ¥æ”¶åˆ°æºæœåŠ¡å™¨è¿”å›åŒ…å« Vary æŒ‡å®šé¡¹çš„å“åº”ä¹‹åï¼Œè‹¥å†è¦è¿›è¡Œç¼“å­˜ï¼Œä»…å¯¹è¯·æ±‚ä¸­å«æœ‰ç›¸åŒ Vary æŒ‡å®šé¦–éƒ¨å­—æ®µçš„è¯·æ±‚è¿”å›ç¼“å­˜ã€‚å³ä½¿å¯¹ç›¸åŒèµ„æºå‘èµ·è¯·æ±‚ï¼Œä½†ç”±äº Vary æŒ‡å®šçš„é¦–éƒ¨å­—æ®µä¸ç›¸åŒï¼Œå› æ­¤å¿…é¡»è¦ä»æºæœåŠ¡å™¨é‡æ–°è·å–èµ„æºã€‚ 6.6.9 WWW-Authenticate WWW-Authenticate: Basic realm=\"Usagidesign Auth\" é¦–éƒ¨å­—æ®µ WWW-Authenticate ç”¨äº HTTP è®¿é—®è®¤è¯ã€‚å®ƒä¼šå‘ŠçŸ¥å®¢æˆ·ç«¯é€‚ç”¨äºè®¿é—®è¯·æ±‚ URI æ‰€æŒ‡å®šèµ„æºçš„è®¤è¯æ–¹æ¡ˆï¼ˆBasic æˆ–æ˜¯ Digestï¼‰å’Œå¸¦å‚æ•°æç¤ºçš„è´¨è¯¢ï¼ˆchallengeï¼‰ã€‚ 6.7 å®ä½“é¦–éƒ¨å­—æ®µï¼ˆHTTP/1.1ï¼‰ é¦–éƒ¨å­—æ®µå è¯´æ˜ Allow èµ„æºå¯æ”¯æŒçš„ HTTP æ–¹æ³• Content-Encoding å®ä½“ä¸»ä½“é€‚ç”¨çš„ç¼–ç æ–¹å¼ Content-Language å®ä½“ä¸»ä½“çš„è‡ªç„¶è¯­è¨€ Content-Length å®ä½“ä¸»ä½“çš„å¤§å°ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ Content-Location æ›¿ä»£å¯¹åº”èµ„æºçš„ URI Content-MD5 å®ä½“ä¸»ä½“çš„æŠ¥æ–‡æ‘˜è¦ Content-Range å®ä½“ä¸»ä½“çš„ä½ç½®èŒƒå›´ Content-Type å®ä½“ä¸»ä½“çš„åª’ä½“ç±»å‹ Expires å®ä½“ä¸»ä½“è¿‡æœŸçš„æ—¥æœŸæ—¶é—´ Last-Modified èµ„æºçš„æœ€åä¿®æ”¹æ—¥æœŸæ—¶é—´ 6.7.1 Allow Allow: GET, HEAD é¦–éƒ¨å­—æ®µ Allow ç”¨äºé€šçŸ¥å®¢æˆ·ç«¯èƒ½å¤Ÿæ”¯æŒ Request-URI æŒ‡å®šèµ„æºçš„æ‰€æœ‰ HTTP æ–¹æ³•ã€‚ å½“æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸æ”¯æŒçš„ HTTP æ–¹æ³•æ—¶ï¼Œä¼šä»¥çŠ¶æ€ç  405 Method Not Allowed ä½œä¸ºå“åº”è¿”å›ã€‚ä¸æ­¤åŒæ—¶ï¼Œè¿˜ä¼šæŠŠæ‰€æœ‰èƒ½æ”¯æŒçš„ HTTP æ–¹æ³•å†™å…¥é¦–éƒ¨å­—æ®µ Allow åè¿”å›ã€‚ 6.7.2 Content-Encoding Content-Encoding: gzip é¦–éƒ¨å­—æ®µ Content-Encoding ä¼šå‘ŠçŸ¥å®¢æˆ·ç«¯æœåŠ¡å™¨å¯¹å®ä½“çš„ä¸»ä½“éƒ¨åˆ†é€‰ç”¨çš„å†…å®¹ç¼–ç æ–¹å¼ã€‚å†…å®¹ç¼–ç æ˜¯æŒ‡åœ¨ä¸ä¸¢å¤±å®ä½“ä¿¡æ¯çš„å‰æä¸‹æ‰€è¿›è¡Œçš„å‹ç¼©ã€‚ ä¸»è¦é‡‡ç”¨è¿™ 4 ç§å†…å®¹ç¼–ç çš„æ–¹å¼ï¼ˆgzipã€compressã€deflateã€identityï¼‰ã€‚ 6.7.3 Content-Language Content-Language: zh-CN é¦–éƒ¨å­—æ®µ Content-Language ä¼šå‘ŠçŸ¥å®¢æˆ·ç«¯ï¼Œå®ä½“ä¸»ä½“ä½¿ç”¨çš„è‡ªç„¶è¯­è¨€ï¼ˆæŒ‡ä¸­æ–‡æˆ–è‹±æ–‡ç­‰è¯­è¨€ï¼‰ã€‚ 6.7.4 Content-Length Content-Length: 15000 é¦–éƒ¨å­—æ®µ Content-Length è¡¨æ˜äº†å®ä½“ä¸»ä½“éƒ¨åˆ†çš„å¤§å°ï¼ˆå•ä½æ˜¯å­—èŠ‚ï¼‰ã€‚å¯¹å®ä½“ä¸»ä½“è¿›è¡Œå†…å®¹ç¼–ç ä¼ è¾“æ—¶ï¼Œä¸èƒ½å†ä½¿ç”¨ Content-Lengthé¦–éƒ¨å­—æ®µã€‚ 6.7.5 Content-Location Content-Location: http://www.sample.com/index.html é¦–éƒ¨å­—æ®µ Content-Location ç»™å‡ºä¸æŠ¥æ–‡ä¸»ä½“éƒ¨åˆ†ç›¸å¯¹åº”çš„ URIã€‚å’Œé¦–éƒ¨å­—æ®µ Location ä¸åŒï¼ŒContent-Location è¡¨ç¤ºçš„æ˜¯æŠ¥æ–‡ä¸»ä½“è¿”å›èµ„æºå¯¹åº”çš„ URIã€‚ 6.7.6 Content-MD5 Content-MD5: OGFkZDUwNGVhNGY3N2MxMDIwZmQ4NTBmY2IyTY== é¦–éƒ¨å­—æ®µ Content-MD5 æ˜¯ä¸€ä¸²ç”± MD5 ç®—æ³•ç”Ÿæˆçš„å€¼ï¼Œå…¶ç›®çš„åœ¨äºæ£€æŸ¥æŠ¥æ–‡ä¸»ä½“åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦ä¿æŒå®Œæ•´ï¼Œä»¥åŠç¡®è®¤ä¼ è¾“åˆ°è¾¾ã€‚ 6.7.7 Content-Range Content-Range: bytes 5001-10000/10000 é’ˆå¯¹èŒƒå›´è¯·æ±‚ï¼Œè¿”å›å“åº”æ—¶ä½¿ç”¨çš„é¦–éƒ¨å­—æ®µ Content-Rangeï¼Œèƒ½å‘ŠçŸ¥å®¢æˆ·ç«¯ä½œä¸ºå“åº”è¿”å›çš„å®ä½“çš„å“ªä¸ªéƒ¨åˆ†ç¬¦åˆèŒƒå›´è¯·æ±‚ã€‚å­—æ®µå€¼ä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œè¡¨ç¤ºå½“å‰å‘é€éƒ¨åˆ†åŠæ•´ä¸ªå®ä½“å¤§å°ã€‚ 6.7.8 Content-Type Content-Type: text/html; charset=UTF-8 é¦–éƒ¨å­—æ®µ Content-Type è¯´æ˜äº†å®ä½“ä¸»ä½“å†…å¯¹è±¡çš„åª’ä½“ç±»å‹ã€‚å’Œé¦–éƒ¨å­—æ®µ Accept ä¸€æ ·ï¼Œå­—æ®µå€¼ç”¨ type/subtype å½¢å¼èµ‹å€¼ã€‚å‚æ•° charset ä½¿ç”¨ iso-8859-1 æˆ– euc-jp ç­‰å­—ç¬¦é›†è¿›è¡Œèµ‹å€¼ã€‚ 6.7.9 Expires Expires: Mon, 10 Jul 2017 15:50:06 GMT é¦–éƒ¨å­—æ®µ Expires ä¼šå°†èµ„æºå¤±æ•ˆçš„æ—¥æœŸå‘ŠçŸ¥å®¢æˆ·ç«¯ã€‚ ç¼“å­˜æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°å«æœ‰é¦–éƒ¨å­—æ®µ Expires çš„å“åº”åï¼Œä¼šä»¥ç¼“å­˜æ¥åº”ç­”è¯·æ±‚ï¼Œåœ¨ Expires å­—æ®µå€¼æŒ‡å®šçš„æ—¶é—´ä¹‹å‰ï¼Œå“åº”çš„å‰¯æœ¬ä¼šä¸€ç›´è¢«ä¿å­˜ã€‚å½“è¶…è¿‡æŒ‡å®šçš„æ—¶é—´åï¼Œç¼“å­˜æœåŠ¡å™¨åœ¨è¯·æ±‚å‘é€è¿‡æ¥æ—¶ï¼Œä¼šè½¬å‘æºæœåŠ¡å™¨è¯·æ±‚èµ„æºã€‚ æºæœåŠ¡å™¨ä¸å¸Œæœ›ç¼“å­˜æœåŠ¡å™¨å¯¹èµ„æºç¼“å­˜æ—¶ï¼Œæœ€å¥½åœ¨ Expires å­—æ®µå†…å†™å…¥ä¸é¦–éƒ¨å­—æ®µ Date ç›¸åŒçš„æ—¶é—´å€¼ã€‚ 6.7.10 Last-Modified Last-Modified: Mon, 10 Jul 2017 15:50:06 GMT é¦–éƒ¨å­—æ®µ Last-Modified æŒ‡æ˜èµ„æºæœ€ç»ˆä¿®æ”¹çš„æ—¶é—´ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªå€¼å°±æ˜¯ Request-URI æŒ‡å®šèµ„æºè¢«ä¿®æ”¹çš„æ—¶é—´ã€‚ä½†ç±»ä¼¼ä½¿ç”¨ CGI è„šæœ¬è¿›è¡ŒåŠ¨æ€æ•°æ®å¤„ç†æ—¶ï¼Œè¯¥å€¼æœ‰å¯èƒ½ä¼šå˜æˆæ•°æ®æœ€ç»ˆä¿®æ”¹æ—¶çš„æ—¶é—´ã€‚ 6.8 ä¸º Cookie æœåŠ¡çš„é¦–éƒ¨å­—æ®µ é¦–éƒ¨å­—æ®µå è¯´æ˜ é¦–éƒ¨ç±»å‹ Set-Cookie å¼€å§‹çŠ¶æ€ç®¡ç†æ‰€ä½¿ç”¨çš„ Cookie ä¿¡æ¯ å“åº”é¦–éƒ¨å­—æ®µ Cookie æœåŠ¡å™¨æ¥æ”¶åˆ°çš„ Cookie ä¿¡æ¯ è¯·æ±‚é¦–éƒ¨å­—æ®µ 6.8.1 Set-Cookie Set-Cookie: status=enable; expires=Mon, 10 Jul 2017 15:50:06 GMT; path=/; ä¸‹é¢çš„è¡¨æ ¼åˆ—ä¸¾äº† Set-Cookie çš„å­—æ®µå€¼ã€‚ å±æ€§ è¯´æ˜ NAME=VALUE èµ‹äºˆ Cookie çš„åç§°å’Œå…¶å€¼ï¼ˆå¿…éœ€é¡¹ï¼‰ expires=DATE Cookie çš„æœ‰æ•ˆæœŸï¼ˆè‹¥ä¸æ˜ç¡®æŒ‡å®šåˆ™é»˜è®¤ä¸ºæµè§ˆå™¨å…³é—­å‰ä¸ºæ­¢ï¼‰ path=PATH å°†æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ç›®å½•ä½œä¸ºCookieçš„é€‚ç”¨å¯¹è±¡ï¼ˆè‹¥ä¸æŒ‡å®šåˆ™é»˜è®¤ä¸ºæ–‡æ¡£æ‰€åœ¨çš„æ–‡ä»¶ç›®å½•ï¼‰ domain=åŸŸå ä½œä¸º Cookie é€‚ç”¨å¯¹è±¡çš„åŸŸå ï¼ˆè‹¥ä¸æŒ‡å®šåˆ™é»˜è®¤ä¸ºåˆ›å»º Cookieçš„æœåŠ¡å™¨çš„åŸŸåï¼‰ Secure ä»…åœ¨ HTTPS å®‰å…¨é€šä¿¡æ—¶æ‰ä¼šå‘é€ Cookie HttpOnly åŠ ä»¥é™åˆ¶ï¼Œä½¿ Cookie ä¸èƒ½è¢« JavaScript è„šæœ¬è®¿é—® 6.8.1.1 expires å±æ€§ Cookie çš„ expires å±æ€§æŒ‡å®šæµè§ˆå™¨å¯å‘é€ Cookie çš„æœ‰æ•ˆæœŸã€‚ å½“çœç•¥ expires å±æ€§æ—¶ï¼Œå…¶æœ‰æ•ˆæœŸä»…é™äºç»´æŒæµè§ˆå™¨ä¼šè¯ï¼ˆSessionï¼‰æ—¶é—´æ®µå†…ã€‚è¿™é€šå¸¸é™äºæµè§ˆå™¨åº”ç”¨ç¨‹åºè¢«å…³é—­ä¹‹å‰ã€‚ å¦å¤–ï¼Œä¸€æ—¦ Cookie ä»æœåŠ¡å™¨ç«¯å‘é€è‡³å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨ç«¯å°±ä¸å­˜åœ¨å¯ä»¥æ˜¾å¼åˆ é™¤ Cookie çš„æ–¹æ³•ã€‚ä½†å¯é€šè¿‡è¦†ç›–å·²è¿‡æœŸçš„ Cookieï¼Œå®ç°å¯¹å®¢æˆ·ç«¯ Cookie çš„å®è´¨æ€§åˆ é™¤æ“ä½œã€‚ 6.8.1.2 path å±æ€§ Cookie çš„ path å±æ€§å¯ç”¨äºé™åˆ¶æŒ‡å®š Cookie çš„å‘é€èŒƒå›´çš„æ–‡ä»¶ç›®å½•ã€‚ 6.8.1.3 domain å±æ€§ é€šè¿‡ Cookie çš„ domain å±æ€§æŒ‡å®šçš„åŸŸåå¯åšåˆ°ä¸ç»“å°¾åŒ¹é…ä¸€è‡´ã€‚æ¯”å¦‚ï¼Œå½“æŒ‡å®š example.com åï¼Œé™¤example.com ä»¥å¤–ï¼Œwww.example.com æˆ– www2.example.com ç­‰éƒ½å¯ä»¥å‘é€ Cookieã€‚ å› æ­¤ï¼Œé™¤äº†é’ˆå¯¹å…·ä½“æŒ‡å®šçš„å¤šä¸ªåŸŸåå‘é€ Cookie ä¹‹ å¤–ï¼Œä¸æŒ‡å®š domain å±æ€§æ˜¾å¾—æ›´å®‰å…¨ã€‚ 6.8.1.4 secure å±æ€§ Cookie çš„ secure å±æ€§ç”¨äºé™åˆ¶ Web é¡µé¢ä»…åœ¨ HTTPS å®‰å…¨è¿æ¥æ—¶ï¼Œæ‰å¯ä»¥å‘é€ Cookieã€‚ 6.8.1.5 HttpOnly å±æ€§ Cookie çš„ HttpOnly å±æ€§æ˜¯ Cookie çš„æ‰©å±•åŠŸèƒ½ï¼Œå®ƒä½¿ JavaScript è„šæœ¬æ— æ³•è·å¾— Cookieã€‚å…¶ä¸»è¦ç›®çš„ä¸ºé˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆCross-site scriptingï¼ŒXSSï¼‰å¯¹ Cookie çš„ä¿¡æ¯çªƒå–ã€‚ é€šè¿‡ä¸Šè¿°è®¾ç½®ï¼Œé€šå¸¸ä» Web é¡µé¢å†…è¿˜å¯ä»¥å¯¹ Cookie è¿›è¡Œè¯»å–æ“ä½œã€‚ä½†ä½¿ç”¨ JavaScript çš„ document.cookie å°±æ— æ³•è¯»å–é™„åŠ  HttpOnly å±æ€§åçš„ Cookie çš„å†…å®¹äº†ã€‚å› æ­¤ï¼Œä¹Ÿå°±æ— æ³•åœ¨ XSS ä¸­åˆ©ç”¨ JavaScript åŠ«æŒ Cookie äº†ã€‚ 6.8.2 Cookie Cookie: status=enable é¦–éƒ¨å­—æ®µ Cookie ä¼šå‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå½“å®¢æˆ·ç«¯æƒ³è·å¾— HTTP çŠ¶æ€ç®¡ç†æ”¯æŒæ—¶ï¼Œå°±ä¼šåœ¨è¯·æ±‚ä¸­åŒ…å«ä»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„ Cookieã€‚æ¥æ”¶åˆ°å¤šä¸ª Cookie æ—¶ï¼ŒåŒæ ·å¯ä»¥ä»¥å¤šä¸ª Cookie å½¢å¼å‘é€ã€‚ 6.9 å…¶ä»–é¦–éƒ¨å­—æ®µ HTTP é¦–éƒ¨å­—æ®µæ˜¯å¯ä»¥è‡ªè¡Œæ‰©å±•çš„ã€‚æ‰€ä»¥åœ¨ Web æœåŠ¡å™¨å’Œæµè§ˆå™¨çš„åº”ç”¨ä¸Šï¼Œä¼šå‡ºç°å„ç§éæ ‡å‡†çš„é¦–éƒ¨å­—æ®µã€‚ ä»¥ä¸‹æ˜¯æœ€ä¸ºå¸¸ç”¨çš„é¦–éƒ¨å­—æ®µã€‚ 6.9.1 X-Frame-Options X-Frame-Options: DENY é¦–éƒ¨å­—æ®µ X-Frame-Options å±äº HTTP å“åº”é¦–éƒ¨ï¼Œç”¨äºæ§åˆ¶ç½‘ç«™å†…å®¹åœ¨å…¶ä»– Web ç½‘ç«™çš„ Frame æ ‡ç­¾å†…çš„æ˜¾ç¤ºé—®é¢˜ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ç‚¹å‡»åŠ«æŒï¼ˆclickjackingï¼‰æ”»å‡»ã€‚é¦–éƒ¨å­—æ®µ X-Frame-Options æœ‰ä»¥ä¸‹ä¸¤ä¸ªå¯æŒ‡å®šçš„å­—æ®µå€¼ï¼š DENYï¼šæ‹’ç» SAMEORIGINï¼šä»…åŒæºåŸŸåä¸‹çš„é¡µé¢ï¼ˆTop-level-browsing-contextï¼‰åŒ¹é…æ—¶è®¸å¯ã€‚ï¼ˆæ¯”å¦‚ï¼Œå½“æŒ‡å®š http://sample.com/sample.html é¡µé¢ä¸º SAMEORIGIN æ—¶ï¼Œé‚£ä¹ˆ sample.com ä¸Šæ‰€æœ‰é¡µé¢çš„ frame éƒ½è¢«å…è®¸å¯åŠ è½½è¯¥é¡µé¢ï¼Œè€Œ example.com ç­‰å…¶ä»–åŸŸåçš„é¡µé¢å°±ä¸è¡Œäº†ï¼‰ 6.9.2 X-XSS-Protection X-XSS-Protection: 1 é¦–éƒ¨å­—æ®µ X-XSS-Protection å±äº HTTP å“åº”é¦–éƒ¨ï¼Œå®ƒæ˜¯é’ˆå¯¹è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆXSSï¼‰çš„ä¸€ç§å¯¹ç­–ï¼Œç”¨äºæ§åˆ¶æµè§ˆå™¨ XSS é˜²æŠ¤æœºåˆ¶çš„å¼€å…³ã€‚é¦–éƒ¨å­—æ®µ X-XSS-Protection å¯æŒ‡å®šçš„å­—æ®µå€¼å¦‚ä¸‹: 0 ï¼šå°† XSS è¿‡æ»¤è®¾ç½®æˆæ— æ•ˆçŠ¶æ€ 1 ï¼šå°† XSS è¿‡æ»¤è®¾ç½®æˆæœ‰æ•ˆçŠ¶æ€ 6.9.3 DNT DNT: 1 é¦–éƒ¨å­—æ®µ DNT å±äº HTTP è¯·æ±‚é¦–éƒ¨ï¼Œå…¶ä¸­ DNT æ˜¯ Do Not Track çš„ç®€ç§°ï¼Œæ„ä¸ºæ‹’ç»ä¸ªäººä¿¡æ¯è¢«æ”¶é›†ï¼Œæ˜¯è¡¨ç¤ºæ‹’ç»è¢«ç²¾å‡†å¹¿å‘Šè¿½è¸ªçš„ä¸€ç§æ–¹æ³•ã€‚é¦–éƒ¨å­—æ®µ DNT å¯æŒ‡å®šçš„å­—æ®µå€¼å¦‚ä¸‹ï¼š 0 ï¼šåŒæ„è¢«è¿½è¸ª 1 ï¼šæ‹’ç»è¢«è¿½è¸ª ç”±äºé¦–éƒ¨å­—æ®µ DNT çš„åŠŸèƒ½å…·å¤‡æœ‰æ•ˆæ€§ï¼Œæ‰€ä»¥ Web æœåŠ¡å™¨éœ€è¦å¯¹ DNTåšå¯¹åº”çš„æ”¯æŒã€‚ 6.9.4 P3P P3P: CP=\"CAO DSP LAW CURa ADMa DEVa TAIa PSAa PSDa IVAa IVDa OUR BUS IND é¦–éƒ¨å­—æ®µ P3P å±äº HTTP å“åº”é¦–éƒ¨ï¼Œé€šè¿‡åˆ©ç”¨ P3Pï¼ˆThe Platform for Privacy Preferencesï¼Œåœ¨çº¿éšç§åå¥½å¹³å°ï¼‰æŠ€æœ¯ï¼Œå¯ä»¥è®© Web ç½‘ç«™ä¸Šçš„ä¸ªäººéšç§å˜æˆä¸€ç§ä»…ä¾›ç¨‹åºå¯ç†è§£çš„å½¢å¼ï¼Œä»¥è¾¾åˆ°ä¿æŠ¤ç”¨æˆ·éšç§çš„ç›®çš„ã€‚ è¦è¿›è¡Œ P3P çš„è®¾å®šï¼Œéœ€æŒ‰ä»¥ä¸‹æ“ä½œæ­¥éª¤è¿›è¡Œï¼š æ­¥éª¤ 1ï¼šåˆ›å»º P3P éšç§ æ­¥éª¤ 2ï¼šåˆ›å»º P3P éšç§å¯¹ç…§æ–‡ä»¶åï¼Œä¿å­˜å‘½ååœ¨ /w3c/p3p.xml æ­¥éª¤ 3ï¼šä» P3P éšç§ä¸­æ–°å»º Compact policies åï¼Œè¾“å‡ºåˆ° HTTP å“åº”ä¸­ ä¸ƒã€HTTP å“åº”çŠ¶æ€ç ï¼ˆé‡ç‚¹åˆ†æï¼‰ 7.1 çŠ¶æ€ç æ¦‚è¿° HTTP çŠ¶æ€ç è´Ÿè´£è¡¨ç¤ºå®¢æˆ·ç«¯ HTTP è¯·æ±‚çš„è¿”å›ç»“æœã€æ ‡è®°æœåŠ¡å™¨ç«¯çš„å¤„ç†æ˜¯å¦æ­£å¸¸ã€é€šçŸ¥å‡ºç°çš„é”™è¯¯ç­‰å·¥ä½œã€‚ HTTP çŠ¶æ€ç å¦‚ 200 OK ï¼Œä»¥ 3 ä½æ•°å­—å’ŒåŸå› çŸ­è¯­ç»„æˆã€‚æ•°å­—ä¸­çš„ç¬¬ä¸€ä½æŒ‡å®šäº†å“åº”ç±»åˆ«ï¼Œåä¸¤ä½æ— åˆ†ç±»ã€‚ ä¸å°‘è¿”å›çš„å“åº”çŠ¶æ€ç éƒ½æ˜¯é”™è¯¯çš„ï¼Œä½†æ˜¯ç”¨æˆ·å¯èƒ½å¯Ÿè§‰ä¸åˆ°è¿™ç‚¹ã€‚æ¯”å¦‚ Web åº”ç”¨ç¨‹åºå†…éƒ¨å‘ç”Ÿé”™è¯¯ï¼ŒçŠ¶æ€ç ä¾ç„¶è¿”å› 200 OKã€‚ 7.2 çŠ¶æ€ç ç±»åˆ« ç±»åˆ« åŸå› çŸ­è¯­ 1xx Informational(ä¿¡æ¯æ€§çŠ¶æ€ç ) æ¥æ”¶çš„è¯·æ±‚æ­£åœ¨å¤„ç† 2xx Success(æˆåŠŸçŠ¶æ€ç ) è¯·æ±‚æ­£å¸¸å¤„ç†å®Œæ¯• 3xx Redirection(é‡å®šå‘çŠ¶æ€ç ) éœ€è¦è¿›è¡Œé™„åŠ æ“ä½œä»¥å®Œæˆè¯·æ±‚ 4xx Client Error(å®¢æˆ·ç«¯é”™è¯¯çŠ¶æ€ç ) æœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚ 5xx Server Error(æœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç ) æœåŠ¡å™¨å¤„ç†è¯·æ±‚å‡ºé”™ æˆ‘ä»¬å¯ä»¥è‡ªè¡Œæ”¹å˜ RFC2616 ä¸­å®šä¹‰çš„çŠ¶æ€ç æˆ–è€…æœåŠ¡å™¨ç«¯è‡ªè¡Œåˆ›å»ºçŠ¶æ€ç ï¼Œåªè¦éµå®ˆçŠ¶æ€ç çš„ç±»åˆ«å®šä¹‰å°±å¯ä»¥äº†ã€‚ 7.3 å¸¸ç”¨çŠ¶æ€ç è§£æ HTTP çŠ¶æ€ç ç§ç±»ç¹å¤šï¼Œæ•°é‡è¾¾å‡ åç§ã€‚å…¶ä¸­æœ€å¸¸ç”¨çš„æœ‰ä»¥ä¸‹ 14 ç§ï¼Œä¸€èµ·æ¥çœ‹çœ‹ã€‚ 7.3.1 200 OK è¡¨ç¤ºä»å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ç«¯è¢«æ­£å¸¸å¤„ç†äº†ã€‚ 7.3.2 204 No Content ä»£è¡¨æœåŠ¡å™¨æ¥æ”¶çš„è¯·æ±‚å·²æˆåŠŸå¤„ç†ï¼Œä½†åœ¨è¿”å›çš„å“åº”æŠ¥æ–‡ä¸­ä¸å«å®ä½“çš„ä¸»ä½“éƒ¨åˆ†ã€‚å¦å¤–ï¼Œä¹Ÿä¸å…è®¸è¿”å›ä»»ä½•å®ä½“çš„ä¸»ä½“ã€‚ ä¸€èˆ¬åœ¨åªéœ€è¦ä»å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€æ¶ˆæ¯ï¼Œè€ŒæœåŠ¡å™¨ç«¯ä¸éœ€è¦å‘å®¢æˆ·ç«¯å‘é€æ–°æ¶ˆæ¯å†…å®¹çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ 7.3.3 206 Partial Content è¡¨ç¤ºå®¢æˆ·ç«¯è¿›è¡Œäº†èŒƒå›´è¯·æ±‚ï¼Œè€ŒæœåŠ¡å™¨æˆåŠŸæ‰§è¡Œäº†è¿™éƒ¨åˆ†çš„ GET è¯·æ±‚ã€‚å“åº”æŠ¥æ–‡ä¸­åŒ…å«ç”± Content-Range é¦–éƒ¨å­—æ®µæŒ‡å®šèŒƒå›´çš„å®ä½“å†…å®¹ã€‚ 7.3.4 301 Moved Permanently æ°¸ä¹…æ€§é‡å®šå‘ã€‚è¡¨ç¤ºè¯·æ±‚çš„èµ„æºå·²è¢«åˆ†é…äº†æ–°çš„ URIã€‚ä»¥ååº”ä½¿ç”¨èµ„æºç°åœ¨æ‰€æŒ‡çš„ URIã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå·²ç»æŠŠèµ„æºå¯¹åº”çš„ URI ä¿å­˜ä¸ºä¹¦ç­¾äº†ï¼Œè¿™æ—¶åº”è¯¥æŒ‰ Location é¦–éƒ¨å­—æ®µæç¤ºçš„ URI é‡æ–°ä¿å­˜ã€‚ 7.3.5 302 Found ä¸´æ—¶æ€§é‡å®šå‘ã€‚è¡¨ç¤ºè¯·æ±‚çš„èµ„æºå·²è¢«åˆ†é…äº†æ–°çš„ URIï¼Œå¸Œæœ›ç”¨æˆ·ï¼ˆæœ¬æ¬¡ï¼‰èƒ½ä½¿ç”¨æ–°çš„ URI è®¿é—®ã€‚ å’Œ 301 Moved Permanently çŠ¶æ€ç ç›¸ä¼¼ï¼Œä½† 302 Found çŠ¶æ€ç ä»£è¡¨èµ„æºä¸æ˜¯è¢«æ°¸ä¹…ç§»åŠ¨ï¼Œåªæ˜¯ä¸´æ—¶æ€§è´¨çš„ã€‚æ¢å¥è¯è¯´ï¼Œå·²ç§»åŠ¨çš„èµ„æºå¯¹åº”çš„ URI å°†æ¥è¿˜æœ‰å¯èƒ½å‘ç”Ÿæ”¹å˜ã€‚ 7.3.6 303 See Other è¡¨ç¤ºç”±äºè¯·æ±‚çš„èµ„æºå­˜åœ¨ç€å¦ä¸€ä¸ª URIï¼Œåº”ä½¿ç”¨ GET æ–¹æ³•å®šå‘è·å–è¯·æ±‚çš„èµ„æºã€‚ 303 See Other å’Œ 302 Found çŠ¶æ€ç æœ‰ç€ç›¸åŒçš„åŠŸèƒ½ï¼Œä½† 303 See Other çŠ¶æ€ç æ˜ç¡®è¡¨ç¤ºå®¢æˆ·ç«¯åº”é‡‡ç”¨ GET æ–¹æ³•è·å–èµ„æºï¼Œè¿™ç‚¹ä¸ 302 Found çŠ¶æ€ç æœ‰åŒºåˆ«ã€‚ 7.3.7 304 Not Modified è¡¨ç¤ºå®¢æˆ·ç«¯å‘é€é™„å¸¦æ¡ä»¶çš„è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ç«¯å…è®¸è¯·æ±‚è®¿é—®çš„èµ„æºï¼Œä½†æœªæ»¡è¶³æ¡ä»¶çš„æƒ…å†µã€‚ 304 Not Modified çŠ¶æ€ç è¿”å›æ—¶ï¼Œä¸åŒ…å«ä»»ä½•å“åº”çš„ä¸»ä½“éƒ¨åˆ†ã€‚ 304 Not Modified è™½ç„¶è¢«åˆ’åˆ†åˆ° 3xx ç±»åˆ«ä¸­ï¼Œä½†å’Œé‡å®šå‘æ²¡æœ‰å…³ç³»ã€‚ 7.3.8 307 Temporary Redirect ä¸´æ—¶é‡å®šå‘ã€‚è¯¥çŠ¶æ€ç ä¸ 302 Found æœ‰ç€ç›¸åŒçš„å«ä¹‰ã€‚ 7.3.9 400 Bad Request è¡¨ç¤ºè¯·æ±‚æŠ¥æ–‡ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯ã€‚å½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œéœ€ä¿®æ”¹è¯·æ±‚çš„å†…å®¹åå†æ¬¡å‘é€è¯·æ±‚ã€‚ å¦å¤–ï¼Œæµè§ˆå™¨ä¼šåƒ 200 OK ä¸€æ ·å¯¹å¾…è¯¥çŠ¶æ€ç ã€‚ 7.3.10 401 Unauthorized è¡¨ç¤ºå‘é€çš„è¯·æ±‚éœ€è¦æœ‰é€šè¿‡ HTTP è®¤è¯ï¼ˆBASIC è®¤è¯ã€DIGEST è®¤è¯ï¼‰çš„è®¤è¯ä¿¡æ¯ã€‚ å¦å¤–ï¼Œè‹¥ä¹‹å‰å·²è¿›è¡Œè¿‡ 1 æ¬¡è¯·æ±‚ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·è®¤è¯å¤±è´¥ã€‚ è¿”å›å«æœ‰ 401 Unauthorized çš„å“åº”å¿…é¡»åŒ…å«ä¸€ä¸ªé€‚ç”¨äºè¢«è¯·æ±‚èµ„æºçš„ WWW-Authenticate é¦–éƒ¨ç”¨ä»¥è´¨è¯¢ï¼ˆchallengeï¼‰ç”¨æˆ·ä¿¡æ¯ã€‚ 7.3.11 403 Forbidden è¡¨æ˜å¯¹è¯·æ±‚èµ„æºçš„è®¿é—®è¢«æœåŠ¡å™¨æ‹’ç»äº†ã€‚æœåŠ¡å™¨ç«¯æ²¡æœ‰å¿…è¦ç»™å‡ºè¯¦ç»†çš„æ‹’ç»ç†ç”±ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨å“åº”æŠ¥æ–‡çš„å®ä½“ä¸»ä½“éƒ¨åˆ†å¯¹åŸå› è¿›è¡Œæè¿°ã€‚ 7.3.12 404 Not Found è¡¨æ˜æœåŠ¡å™¨ä¸Šæ— æ³•æ‰¾åˆ°è¯·æ±‚çš„èµ„æºã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ‹’ç»è¯·æ±‚ä¸”ä¸æƒ³è¯´æ˜ç†ç”±çš„æ—¶å€™ä½¿ç”¨ã€‚ 7.3.13 500 Internal Server Error è¡¨æ˜æœåŠ¡å™¨ç«¯åœ¨æ‰§è¡Œè¯·æ±‚æ—¶å‘ç”Ÿäº†é”™è¯¯ã€‚ä¹Ÿå¯èƒ½æ˜¯ Web åº”ç”¨å­˜åœ¨çš„ bug æˆ–æŸäº›ä¸´æ—¶çš„æ•…éšœã€‚ 7.3.14 503 Service Unavailable è¡¨æ˜æœåŠ¡å™¨æš‚æ—¶å¤„äºè¶…è´Ÿè½½æˆ–æ­£åœ¨è¿›è¡Œåœæœºç»´æŠ¤ï¼Œç°åœ¨æ— æ³•å¤„ç†è¯·æ±‚ã€‚å¦‚æœäº‹å…ˆå¾—çŸ¥è§£é™¤ä»¥ä¸ŠçŠ¶å†µéœ€è¦çš„æ—¶é—´ï¼Œæœ€å¥½å†™å…¥ Retry-After é¦–éƒ¨å­—æ®µå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å…«ã€HTTP æŠ¥æ–‡å®ä½“ 8.1 HTTP æŠ¥æ–‡å®ä½“æ¦‚è¿° HTTP æŠ¥æ–‡ç»“æ„ å¤§å®¶è¯·ä»”ç»†çœ‹çœ‹ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œå„ä¸ªç»„æˆéƒ¨åˆ†å¯¹åº”çš„å†…å®¹ã€‚ æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æŠ¥æ–‡å’Œå®ä½“çš„æ¦‚å¿µã€‚å¦‚æœæŠŠ HTTP æŠ¥æ–‡æƒ³è±¡æˆå› ç‰¹ç½‘è´§è¿ç³»ç»Ÿä¸­çš„ç®±å­ï¼Œé‚£ä¹ˆ HTTP å®ä½“å°±æ˜¯æŠ¥æ–‡ä¸­å®é™…çš„è´§ç‰©ã€‚ æŠ¥æ–‡ï¼šæ˜¯ç½‘ç»œä¸­äº¤æ¢å’Œä¼ è¾“çš„æ•°æ®å•å…ƒï¼Œå³ç«™ç‚¹ä¸€æ¬¡æ€§è¦å‘é€çš„æ•°æ®å—ã€‚æŠ¥æ–‡åŒ…å«äº†å°†è¦å‘é€çš„å®Œæ•´çš„æ•°æ®ä¿¡æ¯ï¼Œå…¶é•¿çŸ­å¾ˆä¸ä¸€è‡´ï¼Œé•¿åº¦ä¸é™ä¸”å¯å˜ã€‚ å®ä½“ï¼šä½œä¸ºè¯·æ±‚æˆ–å“åº”çš„æœ‰æ•ˆè½½è·æ•°æ®ï¼ˆè¡¥å……é¡¹ï¼‰è¢«ä¼ è¾“ï¼Œå…¶å†…å®¹ç”±å®ä½“é¦–éƒ¨å’Œå®ä½“ä¸»ä½“ç»„æˆã€‚ï¼ˆå®ä½“é¦–éƒ¨ç›¸å…³å†…å®¹åœ¨ä¸Šé¢ç¬¬å…­ç‚¹ä¸­å·²æœ‰é˜è¿°ã€‚ï¼‰ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢ç¤ºä¾‹å³å›¾ä¸­æ·±çº¢è‰²æ¡†çš„å†…å®¹å°±æ˜¯æŠ¥æ–‡çš„å®ä½“éƒ¨åˆ†ï¼Œè€Œè“è‰²æ¡†çš„ä¸¤éƒ¨åˆ†å†…å®¹åˆ†åˆ«å°±æ˜¯å®ä½“é¦–éƒ¨å’Œå®ä½“ä¸»ä½“ã€‚è€Œå·¦å›¾ä¸­ç²‰çº¢æ¡†å†…å®¹å°±æ˜¯æŠ¥æ–‡ä¸»ä½“ã€‚ é€šå¸¸ï¼ŒæŠ¥æ–‡ä¸»ä½“ç­‰äºå®ä½“ä¸»ä½“ã€‚åªæœ‰å½“ä¼ è¾“ä¸­è¿›è¡Œç¼–ç æ“ä½œæ—¶ï¼Œå®ä½“ä¸»ä½“çš„å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œæ‰å¯¼è‡´å®ƒå’ŒæŠ¥æ–‡ä¸»ä½“äº§ç”Ÿå·®å¼‚ã€‚ 8.2 å†…å®¹ç¼–ç  HTTP åº”ç”¨ç¨‹åºæœ‰æ—¶åœ¨å‘é€ä¹‹å‰éœ€è¦å¯¹å†…å®¹è¿›è¡Œç¼–ç ã€‚ä¾‹å¦‚ï¼Œåœ¨æŠŠå¾ˆå¤§çš„ HTML æ–‡æ¡£å‘é€ç»™é€šè¿‡æ…¢é€Ÿè¿æ¥ä¸Šæ¥çš„å®¢æˆ·ç«¯ä¹‹å‰ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šå¯¹å…¶è¿›è¡Œå‹ç¼©ï¼Œè¿™æ ·æœ‰åŠ©äºå‡å°‘ä¼ è¾“å®ä½“çš„æ—¶é—´ã€‚æœåŠ¡å™¨è¿˜å¯ä»¥æŠŠå†…å®¹æ…ä¹±æˆ–åŠ å¯†ï¼Œä»¥æ­¤æ¥é˜²æ­¢æœªæˆæƒçš„ç¬¬ä¸‰æ–¹çœ‹åˆ°æ–‡æ¡£çš„å†…å®¹ã€‚ è¿™ç§ç±»å‹çš„ç¼–ç æ˜¯åœ¨å‘é€æ–¹åº”ç”¨åˆ°å†…å®¹ä¹‹ä¸Šçš„ã€‚å½“å†…å®¹ç»è¿‡å†…å®¹ç¼–ç åï¼Œç¼–å¥½ç çš„æ•°æ®å°±æ”¾åœ¨å®ä½“ä¸»ä½“ä¸­ï¼Œåƒå¾€å¸¸ä¸€æ ·å‘é€ç»™æ¥æ”¶æ–¹ã€‚ å†…å®¹ç¼–ç ç±»å‹ï¼š ç¼–ç æ–¹å¼ æè¿° gzip è¡¨æ˜å®ä½“é‡‡ç”¨ GNU zip ç¼–ç  compress è¡¨æ˜å®ä½“é‡‡ç”¨ Unix çš„æ–‡ä»¶å‹ç¼©ç¨‹åº deflate è¡¨æ˜å®ä½“é‡‡ç”¨ zlib çš„æ ¼å¼å‹ç¼©çš„ identity è¡¨æ˜æ²¡æœ‰å¯¹å®ä½“è¿›è¡Œç¼–ç ï¼Œå½“æ²¡æœ‰ Content-Encoding é¦–éƒ¨å­—æ®µæ—¶ï¼Œé»˜è®¤é‡‡ç”¨æ­¤ç¼–ç æ–¹å¼ 8.3 ä¼ è¾“ç¼–ç  å†…å®¹ç¼–ç æ˜¯å¯¹æŠ¥æ–‡çš„ä¸»ä½“è¿›è¡Œçš„å¯é€†å˜æ¢ï¼Œæ˜¯å’Œå†…å®¹çš„å…·ä½“æ ¼å¼ç»†èŠ‚ç´§å¯†ç›¸å…³çš„ã€‚ ä¼ è¾“ç¼–ç ä¹Ÿæ˜¯ä½œç”¨åœ¨å®ä½“ä¸»ä½“ä¸Šçš„å¯é€†å˜æ¢ï¼Œä½†ä½¿ç”¨å®ƒä»¬æ˜¯ç”±äºæ¶æ„æ–¹é¢çš„åŸå› ï¼ŒåŒå†…å®¹çš„æ ¼å¼æ— å…³ã€‚ä½¿ç”¨ä¼ è¾“ç¼–ç æ˜¯ä¸ºäº†æ”¹å˜æŠ¥æ–‡ä¸­çš„æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„æ–¹å¼ã€‚ å†…å®¹ç¼–ç å’Œä¼ è¾“ç¼–ç çš„å¯¹æ¯” 8.4 åˆ†å—ç¼–ç  åˆ†å—ç¼–ç æŠŠæŠ¥æ–‡åˆ†å‰²æˆè‹¥å¹²å·²çŸ¥å¤§å°çš„å—ã€‚å—ä¹‹é—´æ˜¯ç´§æŒ¨ç€å‘é€çš„ï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨å‘é€ä¹‹å‰çŸ¥é“æ•´ä¸ªæŠ¥æ–‡çš„å¤§å°äº†ã€‚åˆ†å—ç¼–ç æ˜¯ä¸€ç§ä¼ è¾“ç¼–ç ï¼Œæ˜¯æŠ¥æ–‡çš„å±æ€§ã€‚ åˆ†å—ç¼–ç ä¸æŒä¹…è¿æ¥ è‹¥å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ä¹‹é—´ä¸æ˜¯æŒä¹…è¿æ¥ï¼Œå®¢æˆ·ç«¯å°±ä¸éœ€è¦çŸ¥é“å®ƒåœ¨è¯»å–çš„ä¸»ä½“çš„é•¿åº¦ï¼Œè€Œåªéœ€è¦è¯»å–åˆ°æœåŠ¡å™¨å…³é—­ä¸»ä½“è¿æ¥ä¸ºæ­¢ã€‚ å½“ä½¿ç”¨æŒä¹…è¿æ¥æ—¶ï¼Œåœ¨æœåŠ¡å™¨å†™ä¸»ä½“ä¹‹å‰ï¼Œå¿…é¡»çŸ¥é“å®ƒçš„å¤§å°å¹¶åœ¨ Content-Length é¦–éƒ¨ä¸­å‘é€ã€‚å¦‚æœæœåŠ¡å™¨åŠ¨æ€åˆ›å»ºå†…å®¹ï¼Œå°±å¯èƒ½åœ¨å‘é€ä¹‹å‰æ— æ³•çŸ¥é“ä¸»ä½“çš„é•¿åº¦ã€‚ åˆ†å—ç¼–ç ä¸ºè¿™ç§å›°éš¾æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œåªè¦å…è®¸æœåŠ¡å™¨æŠŠä¸»ä½“åˆ†å—å‘é€ï¼Œè¯´æ˜æ¯å—çš„å¤§å°å°±å¯ä»¥äº†ã€‚å› ä¸ºä¸»ä½“æ˜¯åŠ¨æ€åˆ›å»ºçš„ï¼ŒæœåŠ¡å™¨å¯ä»¥ç¼“å†²å®ƒçš„ä¸€éƒ¨åˆ†ï¼Œå‘é€å…¶å¤§å°å’Œç›¸åº”çš„å—ï¼Œç„¶ååœ¨ä¸»ä½“å‘é€å®Œä¹‹å‰é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚æœåŠ¡å™¨å¯ä»¥ç”¨å¤§å°ä¸º 0 çš„å—ä½œä¸ºä¸»ä½“ç»“æŸçš„ä¿¡å·ï¼Œè¿™æ ·å°±å¯ä»¥ç»§ç»­ä¿æŒè¿æ¥ï¼Œä¸ºä¸‹ä¸€ä¸ªå“åº”åšå‡†å¤‡ã€‚ æ¥çœ‹çœ‹ä¸€ä¸ªåˆ†å—ç¼–ç çš„æŠ¥æ–‡ç¤ºä¾‹ï¼š åˆ†å—ç¼–ç çš„æŠ¥æ–‡ 8.5 å¤šéƒ¨åˆ†åª’ä½“ç±»å‹ MIME ä¸­çš„ multipartï¼ˆå¤šéƒ¨åˆ†ï¼‰ç”µå­é‚®ä»¶æŠ¥æ–‡ä¸­åŒ…å«å¤šä¸ªæŠ¥æ–‡ï¼Œå®ƒä»¬åˆåœ¨ä¸€èµ·ä½œä¸ºå•ä¸€çš„å¤æ‚æŠ¥æ–‡å‘é€ã€‚æ¯ä¸€éƒ¨åˆ†éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæœ‰å„è‡ªçš„æè¿°å…¶å†…å®¹çš„é›†ï¼Œä¸åŒéƒ¨åˆ†ä¹‹é—´ç”¨åˆ†ç•Œå­—ç¬¦ä¸²è¿æ¥åœ¨ä¸€èµ·ã€‚ ç›¸åº”å¾—ï¼ŒHTTP åè®®ä¸­ä¹Ÿé‡‡çº³äº†å¤šéƒ¨åˆ†å¯¹è±¡é›†åˆï¼Œå‘é€çš„ä¸€ä»½æŠ¥æ–‡ä¸»ä½“å†…å¯åŒ…å«å¤šç§ç±»å‹å®ä½“ã€‚ å¤šéƒ¨åˆ†å¯¹è±¡é›†åˆåŒ…å«çš„å¯¹è±¡å¦‚ä¸‹ï¼š multipart/form-dataï¼šåœ¨ Web è¡¨å•æ–‡ä»¶ä¸Šä¼ æ—¶ä½¿ç”¨ã€‚ multipart/byterangesï¼šçŠ¶æ€ç  206 Partial Content å“åº”æŠ¥æ–‡åŒ…å«äº†å¤šä¸ªèŒƒå›´çš„å†…å®¹æ—¶ä½¿ç”¨ã€‚ 8.6 èŒƒå›´è¯·æ±‚ å‡è®¾ä½ æ­£åœ¨ä¸‹è½½ä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶ï¼Œå·²ç»ä¸‹äº†å››åˆ†ä¹‹ä¸‰ï¼Œå¿½ç„¶ç½‘ç»œä¸­æ–­äº†ï¼Œé‚£ä¸‹è½½å°±å¿…é¡»é‡å¤´å†æ¥ä¸€éã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä¸€ç§å¯æ¢å¤çš„æœºåˆ¶ï¼Œå³èƒ½ä»ä¹‹å‰ä¸‹è½½ä¸­æ–­å¤„æ¢å¤ä¸‹è½½ã€‚è¦å®ç°è¯¥åŠŸèƒ½ï¼Œè¿™å°±è¦ç”¨åˆ°èŒƒå›´è¯·æ±‚ã€‚ æœ‰äº†èŒƒå›´è¯·æ±‚ï¼Œ HTTP å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¯·æ±‚æ›¾è·å–å¤±è´¥çš„å®ä½“çš„ä¸€ä¸ªèŒƒå›´ï¼ˆæˆ–è€…è¯´ä¸€éƒ¨åˆ†ï¼‰ï¼Œæ¥æ¢å¤ä¸‹è½½è¯¥å®ä½“ã€‚å½“ç„¶è¿™æœ‰ä¸€ä¸ªå‰æï¼Œé‚£å°±æ˜¯ä»å®¢æˆ·ç«¯ä¸Šä¸€æ¬¡è¯·æ±‚è¯¥å®ä½“åˆ°è¿™ä¸€æ¬¡å‘å‡ºèŒƒå›´è¯·æ±‚çš„æ—¶é—´æ®µå†…ï¼Œè¯¥å¯¹è±¡æ²¡æœ‰æ”¹å˜è¿‡ã€‚ä¾‹å¦‚ï¼š GET /bigfile.html HTTP/1.1 Host: www.sample.com Range: bytes=20224- Â·Â·Â· å®ä½“èŒƒå›´è¯·æ±‚ç¤ºä¾‹ ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯æ–‡æ¡£å¼€å¤´20224å­—èŠ‚ä¹‹åçš„éƒ¨åˆ†ã€‚ ä¹ã€ä¸ HTTP åä½œçš„ Web æœåŠ¡å™¨ HTTP é€šä¿¡æ—¶ï¼Œé™¤å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç”¨äºååŠ©é€šä¿¡çš„åº”ç”¨ç¨‹åºã€‚å¦‚ä¸‹åˆ—å‡ºæ¯”è¾ƒé‡è¦çš„å‡ ä¸ªï¼šä»£ç†ã€ç¼“å­˜ã€ç½‘å…³ã€éš§é“ã€Agent ä»£ç†ã€‚ 9.1 ä»£ç† HTTP ä»£ç†æœåŠ¡å™¨æ˜¯ Web å®‰å…¨ã€åº”ç”¨é›†æˆä»¥åŠæ€§èƒ½ä¼˜åŒ–çš„é‡è¦ç»„æˆæ¨¡å—ã€‚ä»£ç†ä½äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´ï¼Œæ¥æ”¶å®¢æˆ·ç«¯æ‰€æœ‰çš„ HTTP è¯·æ±‚ï¼Œå¹¶å°†è¿™äº›è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨ï¼ˆå¯èƒ½ä¼šå¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹ä¹‹åå†è¿›è¡Œè½¬å‘ï¼‰ã€‚å¯¹ç”¨æˆ·æ¥è¯´ï¼Œè¿™äº›åº”ç”¨ç¨‹åºå°±æ˜¯ä¸€ä¸ªä»£ç†ï¼Œä»£è¡¨ç”¨æˆ·è®¿é—®æœåŠ¡å™¨ã€‚ å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œé€šå¸¸ä¼šå°†ä»£ç†ä½œä¸ºè½¬å‘æ‰€æœ‰ Web æµé‡çš„å¯ä¿¡ä»»ä¸­é—´èŠ‚ç‚¹ä½¿ç”¨ã€‚ä»£ç†è¿˜å¯ä»¥å¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œè¿‡æ»¤ï¼Œå®‰å…¨ä¸Šç½‘æˆ–ç»¿è‰²ä¸Šç½‘ã€‚ 9.2 ç¼“å­˜ æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼š æµè§ˆå™¨å†æ¬¡è¯·æ±‚ï¼š Web ç¼“å­˜æˆ–ä»£ç†ç¼“å­˜æ˜¯ä¸€ç§ç‰¹æ®Šçš„ HTTP ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥å°†ç»è¿‡ä»£ç†ä¼ è¾“çš„å¸¸ç”¨æ–‡æ¡£å¤åˆ¶ä¿å­˜èµ·æ¥ã€‚ä¸‹ä¸€ä¸ªè¯·æ±‚åŒä¸€æ–‡æ¡£çš„å®¢æˆ·ç«¯å°±å¯ä»¥äº«å—ç¼“å­˜çš„ç§æœ‰å‰¯æœ¬æ‰€æä¾›çš„æœåŠ¡äº†ã€‚å®¢æˆ·ç«¯ä»é™„è¿‘çš„ç¼“å­˜ä¸‹è½½æ–‡æ¡£ä¼šæ¯”ä»è¿œç¨‹ Web æœåŠ¡å™¨ä¸‹è½½å¿«å¾—å¤šã€‚ 9.3 ç½‘å…³ HTTP / FTP ç½‘å…³ ç½‘å…³æ˜¯ä¸€ç§ç‰¹æ®Šçš„æœåŠ¡å™¨ï¼Œä½œä¸ºå…¶ä»–æœåŠ¡å™¨çš„ä¸­é—´å®ä½“ä½¿ç”¨ã€‚é€šå¸¸ç”¨äºå°† HTTP æµé‡è½¬æ¢æˆå…¶ä»–çš„åè®®ã€‚ç½‘å…³æ¥æ”¶è¯·æ±‚æ—¶å°±å¥½åƒè‡ªå·±æ˜¯èµ„æºçš„æºæœåŠ¡å™¨ä¸€æ ·ã€‚å®¢æˆ·ç«¯å¯èƒ½å¹¶ä¸çŸ¥é“è‡ªå·±æ­£åœ¨è·Ÿä¸€ä¸ªç½‘å…³è¿›è¡Œé€šä¿¡ã€‚ 9.4 éš§é“ HTTP/SSL éš§é“ éš§é“æ˜¯ä¼šåœ¨å»ºç«‹èµ·æ¥ä¹‹åï¼Œå°±ä¼šåœ¨ä¸¤æ¡è¿æ¥ä¹‹é—´å¯¹åŸå§‹æ•°æ®è¿›è¡Œç›²è½¬å‘çš„ HTTP åº”ç”¨ç¨‹åºã€‚HTTP éš§é“é€šå¸¸ç”¨æ¥åœ¨ä¸€æ¡æˆ–å¤šæ¡ HTTP è¿æ¥ä¸Šè½¬å‘é HTTP æ•°æ®ï¼Œè½¬å‘æ—¶ä¸ä¼šçª¥æ¢æ•°æ®ã€‚ HTTP éš§é“çš„ä¸€ç§å¸¸è§ç”¨é€”å°±æ˜¯é€šè¿‡ HTTP è¿æ¥æ‰¿è½½åŠ å¯†çš„å®‰å…¨å¥—æ¥å­—å±‚ï¼ˆSSLï¼‰æµé‡ï¼Œè¿™æ · SSL æµé‡å°±å¯ä»¥ç©¿è¿‡åªå…è®¸ Web æµé‡é€šè¿‡çš„é˜²ç«å¢™äº†ã€‚ 9.5 Agent ä»£ç† è‡ªåŠ¨æœç´¢å¼•æ“â€œç½‘ç»œèœ˜è››â€ Agent ä»£ç†æ˜¯ä»£è¡¨ç”¨æˆ·å‘èµ· HTTP è¯·æ±‚çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚æ‰€æœ‰å‘å¸ƒ Web è¯·æ±‚çš„åº”ç”¨ç¨‹åºéƒ½æ˜¯ HTTP Agent ä»£ç†ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/ç½‘ç»œåè®®/http/HTTPSåè®®.html":{"url":"linux/ç½‘ç»œåè®®/http/HTTPSåè®®.html","title":"HTTPSåè®®","keywords":"","body":"HTTPSåè®® æœ¬æ–‡ä¸¥é‡æŠ„è¢­è‡³äº’è”ç½‘ æœ¬ç¯‡å°†è®¨è®º HTTPS çš„åŠ è§£å¯†åŸç†ï¼Œå¾ˆå¤šäººéƒ½çŸ¥é“ RSAï¼Œä»¥ä¸º HTTPS=RSAï¼Œä½¿ç”¨ RSA åŠ è§£å¯†æ•°æ®ï¼Œå®é™…ä¸Šè¿™æ˜¯ä¸å¯¹çš„ã€‚ HTTPS æ˜¯ä½¿ç”¨ RSA è¿›è¡Œèº«ä»½éªŒè¯å’Œäº¤æ¢å¯†é’¥ï¼Œç„¶åå†ä½¿ç”¨äº¤æ¢çš„å¯†é’¥è¿›è¡ŒåŠ è§£å¯†æ•°æ®ã€‚ èº«ä»½éªŒè¯æ˜¯ä½¿ç”¨ RSA çš„éå¯¹ç§°åŠ å¯†ï¼Œè€Œæ•°æ®ä¼ è¾“æ˜¯åŒæ–¹ä½¿ç”¨ç›¸åŒçš„å¯†é’¥è¿›è¡Œçš„å¯¹ç§°åŠ å¯†ã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†ï¼Ÿ å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯† å‡è®¾éš”å£å°ç‹æƒ³è¦çº¦å°çº¢å‡ºæ¥ï¼Œä½†æ˜¯ä»–ä¸æƒ³è®©å°æ˜çŸ¥é“ï¼Œäºæ˜¯ä»–æƒ³ç”¨å¯¹ç§°åŠ å¯†ç»™å°çº¢ä¼ äº†ä¸ªå°çº¸æ¡ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä»–æƒ³å‘é€çš„æ•°æ®æ˜¯\"Meet at 5:00 PM\"ï¼ˆ5 ç‚¹è§é¢ï¼Œå¦‚æœæ˜¯ä¸­æ–‡çš„è¯å¯ä»¥ä½¿ç”¨ UTF-8 ç¼–ç ï¼‰ï¼ŒåŠ å¯†æ–¹å¼æ˜¯ç›´æ¥åœ¨ ASCII è¡¨è¿›è¡Œå·¦ç§»æˆ–å³ç§»ã€‚ ä»–çš„å¯†é’¥æ˜¯ 3ï¼Œè¡¨ç¤ºåœ¨ ASCII è¡¨å¾€åç§» 3 ä½ï¼Œå°±ä¼šå˜æˆ\"Phhw#dw#8=33#SP\"ï¼Œè¿™æ ·ä¸€èˆ¬äººå¦‚æœæˆªè·äº†ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€çš„ã€‚ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ—¢ç„¶ä»–å¯ä»¥æˆªè·ä½ çš„æ•°æ®ï¼Œè‡ªç„¶ä¹Ÿå¯ä»¥æˆªè·ä½ çš„å¯†é’¥ï¼Œè¿›è€Œè¿›è¡Œè§£å¯†ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ‰€ä»¥å°ç‹æ‰“ç®—ç”¨éå¯¹ç§°åŠ å¯†ï¼Œéå¯¹ç§°åŠ å¯†çš„ç‰¹ç‚¹æ˜¯åŒæ–¹éƒ½æœ‰è‡ªå·±çš„å…¬é’¥å’Œç§é’¥å¯¹ï¼Œå…¶ä¸­å…¬é’¥å‘ç»™å¯¹æ–¹ï¼Œå¯†é’¥ä¸äº¤æ¢è‡ªå·±ä¿ç®¡ä¸æ³„æ¼ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å…¶ä¸­å°çº¢çš„å…¬é’¥ä¸ºï¼š public_key = (N, e) = (3233, 17) å¥¹æŠŠå…¬é’¥å‘ç»™äº†å°æ˜ï¼Œå¥¹è‡ªå·±çš„ç§é’¥ä¸ºï¼š private_key = (N, e) = (3233, 2753) è¿™é‡Œæ³¨æ„å…¬é’¥å’Œç§é’¥éƒ½æ˜¯ä¸¤ä¸ªæ•°ï¼ŒN é€šå¸¸æ˜¯ä¸€ä¸ªå¤§æ•´æ•°ï¼Œe è¡¨ç¤ºä¸€ä¸ªå¹‚æŒ‡æ•°ã€‚ç°åœ¨å°ç‹æƒ³ç»™å°çº¢å‘æ¶ˆæ¯ï¼Œäºæ˜¯ä»–ç”¨å°çº¢çš„å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œæ€ä¹ˆåŠ å¯†å‘¢ï¼Ÿ ä»–è¦å‘é€çš„ç¬¬ä¸€ä¸ªå­—æ¯ä¸º t=â€œMâ€ï¼Œâ€œMâ€çš„ ASCII ç¼–ç ä¸º 77ï¼Œ77 çš„åŠ å¯†è¿‡ç¨‹å¦‚ä¸‹è®¡ç®—ï¼š T = 77 ^ e % N = 77 ^ 17 % 3233 = 3123 æŠŠ 77 åš e æ¬¡å¹‚ç„¶åæ¨¡ä»¥ Nï¼Œä¾¿å¾—åˆ°äº† T=3123ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°å‘ç»™å°çº¢ï¼ˆå…¶ä»–å­—æ¯æŒ‰åŒæ ·æ–¹å¼å¤„ç†ï¼‰ã€‚ å°çº¢æ”¶åˆ° T ä¹‹åä¾¿ç”¨å¥¹çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œè®¡ç®—å¦‚ä¸‹ï¼š t = T ^ e % N = 3123 ^ 2753 % 3233 = 77 è®¡ç®—æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·ä¾¿æŠŠ T è¿˜åŸæˆäº† tï¼Œåªè¦å…¬ç§é’¥é…å¯¹ï¼Œä¾¿å¯é€šè¿‡ä¸€äº›æ•°å­¦å…¬å¼è¯æ˜ä¸Šé¢çš„æ¨ç®—æ˜¯æˆç«‹çš„ã€‚è¿™ä¸ªå°±æ˜¯ RSA çš„åŠ è§£å¯†åŸç†ï¼Œå¦‚æœæ— æ³•çŸ¥é“ç§é’¥ä¾¿æ— æ³•è¿›è¡Œæ­£ç¡®è§£å¯†ã€‚ åè¿‡æ¥ï¼Œä½¿ç”¨ç§é’¥è¿›è¡ŒåŠ å¯†ï¼Œå…¬é’¥è¿›è¡Œè§£å¯†ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚é‚£ä¹ˆ HTTPS æ˜¯æ€ä¹ˆåˆ©ç”¨ RSA è¿›è¡ŒåŠ è§£å¯†çš„å‘¢ï¼Œæˆ‘ä»¬ä» HTTPS è¿æ¥å»ºç«‹è¿‡ç¨‹è¯´èµ·ã€‚ HTTPS è¿æ¥å»ºç«‹è¿‡ç¨‹ HTTPS ä¸»è¦æœ‰ä»¥ä¸‹ä½œç”¨ï¼š éªŒè¯æœåŠ¡æ–¹èº«ä»½ï¼Œå¦‚æˆ‘è®¿é—® google.com çš„æ—¶å€™è¿çš„ç¡®å®å°±æ˜¯è°·æ­ŒæœåŠ¡å™¨ é˜²æ­¢æ•°æ®è¢«åŠ«æŒï¼Œä¾‹å¦‚æœ‰äº›è¿è¥å•†ä¼šç»™ http çš„é¡µé¢æ’å…¥å¹¿å‘Š é˜²æ­¢æ•æ„Ÿæ•°æ®è¢«çªƒå–ç¯¡æ”¹ç­‰ æ­£å¦‚ openssl çš„æ³¨é‡Šæ‰€è¯´ï¼Œè¿™æ˜¯é˜²æ­¢ä¸­é—´äººæ”»å‡»çš„å”¯ä¸€æ–¹æ³•ï¼š æˆ‘ä»¬ä»¥ MDNï¼ˆhttps://developer.mozilla.orgï¼‰çš„ç½‘ç«™ä¸ºä¾‹ï¼Œç„¶åç”¨ wireshark æŠ“åŒ…ï¼Œè§‚å¯Ÿ HTTPS è¿æ¥å»ºç«‹çš„è¿‡ç¨‹ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š é¦–å…ˆæ˜¯ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼Œç„¶åå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å‘èµ·ä¸€ä¸ª HTTPS è¿æ¥å»ºç«‹è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å…ˆå‘ä¸€ä¸ª Client Hello çš„åŒ…ï¼Œç„¶åæœåŠ¡ç«¯å“åº”ä¸€ä¸ª Server Helloã€‚ æ¥ç€å†ç»™å®¢æˆ·ç«¯å‘é€å®ƒçš„è¯ä¹¦ï¼Œç„¶ååŒæ–¹ç»è¿‡å¯†é’¥äº¤æ¢ï¼Œæœ€åä½¿ç”¨äº¤æ¢çš„å¯†é’¥åŠ è¡ŒåŠ è§£å¯†æ•°æ®ã€‚ åœ¨ Client Hello é‡Œé¢å®¢æˆ·ç«¯ä¼šå‘ŠçŸ¥æœåŠ¡ç«¯è‡ªå·±å½“å‰çš„ä¸€äº›ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åŒ…æ‹¬å®¢æˆ·ç«¯è¦ä½¿ç”¨çš„ TLS ç‰ˆæœ¬ï¼Œæ”¯æŒçš„åŠ å¯†å¥—è£…ï¼Œè¦è®¿é—®çš„åŸŸåï¼Œç»™æœåŠ¡ç«¯ç”Ÿæˆçš„ä¸€ä¸ªéšæœºæ•°ï¼ˆNonceï¼‰ç­‰ã€‚ éœ€è¦æå‰å‘ŠçŸ¥æœåŠ¡å™¨æƒ³è¦è®¿é—®çš„åŸŸåä»¥ä¾¿æœåŠ¡å™¨å‘é€ç›¸åº”çš„åŸŸåçš„è¯ä¹¦è¿‡æ¥ï¼Œå› ä¸ºæ­¤æ—¶è¿˜æ²¡æœ‰å‘ç”Ÿ HTTP è¯·æ±‚ã€‚ æœåŠ¡ç«¯åœ¨ Server Hello é‡Œé¢ä¼šåšä¸€äº›å“åº”ï¼š æœåŠ¡ç«¯é€‰ä¸­çš„åŠ å¯†å¥—è£…å« TLSECDHERSAWITHAES128GCM_SHA256ï¼Œè¿™ä¸€ä¸²çš„æ„æ€æ˜¯ï¼š å¯†é’¥äº¤æ¢ä½¿ç”¨ ECDHE è¯ä¹¦ç­¾åç®—æ³• RSA æ•°æ®åŠ å¯†ä½¿ç”¨ AES 128 GCM ç­¾åæ ¡éªŒä½¿ç”¨ SHA256 æ¥ç€æœåŠ¡ç»™å®¢æˆ·ç«¯å‘æ¥äº† 4 ä¸ªè¯ä¹¦ï¼š ç¬¬ä¸€ä¸ªè¯ä¹¦çš„å…¬ç”¨åï¼ˆcommon nameï¼‰å°±æ˜¯æˆ‘ä»¬å½“å‰è®¿é—®çš„åŸŸå developer.mozilla.orgã€‚ å¦‚æœå…¬ç”¨åæ˜¯ *.mozilla.org çš„è¯é‚£ä¹ˆè¿™ä¸ªè¯ä¹¦ä¾¿èƒ½ç»™ mozilla.org çš„æ‰€æœ‰äºŒçº§å­åŸŸåä½¿ç”¨ã€‚ ç¬¬äºŒä¸ªè¯ä¹¦æ˜¯ç¬¬ä¸€ä¸ªè¯ä¹¦çš„ç­¾å‘æœºæ„ï¼ˆCAï¼‰çš„è¯ä¹¦ï¼Œå®ƒæ˜¯ Amazonï¼Œä¹Ÿå°±æ˜¯è¯´ Amazon ä¼šç”¨å®ƒçš„ç§é’¥ç»™ developer.mozilla.org è¿›è¡Œç­¾åã€‚ ä¾æ­¤ç±»æ¨ï¼Œç¬¬ä¸‰ä¸ªè¯ä¹¦ä¼šç»™ç¬¬äºŒä¸ªè¯ä¹¦ç­¾åï¼Œç¬¬å››ä¸ªè¯ä¹¦ä¼šç»™ç¬¬ä¸‰ä¸ªè¯ä¹¦ç­¾åï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬å››ä¸ªè¯ä¹¦æ˜¯ä¸€ä¸ªæ ¹ï¼ˆRootï¼‰è¯ä¹¦ã€‚ ä¸€ä¸ªè¯ä¹¦é‡Œé¢ä¼šæœ‰ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å±•å¼€ç¬¬ä¸€ä¸ªè¯ä¹¦çœ‹ä¸€ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¯ä¹¦åŒ…å«ä¸‰éƒ¨åˆ†å†…å®¹ï¼š tbsCertificateï¼ˆto be signed certificateï¼‰å¾…ç­¾åè¯ä¹¦å†…å®¹ è¯ä¹¦ç­¾åç®—æ³• CA ç»™çš„ç­¾å ä¹Ÿå°±æ˜¯è¯´ CA ä¼šç”¨å®ƒçš„ç§é’¥å¯¹ tbsCertificate è¿›è¡Œç­¾åï¼Œå¹¶æ”¾åœ¨ç­¾åéƒ¨åˆ†ã€‚ä¸ºä»€ä¹ˆè¯ä¹¦è¦ç­¾åå‘¢ï¼Ÿç­¾åæ˜¯ä¸ºäº†éªŒè¯èº«ä»½ã€‚ èº«ä»½éªŒè¯ æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ tbsCertificate é‡Œé¢æœ‰ä»€ä¹ˆå†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å®ƒé‡Œé¢åŒ…æ‹¬äº†è¯ä¹¦çš„å…¬é’¥ã€è¯ä¹¦çš„é€‚ç”¨å…¬ç”¨åã€è¯ä¹¦çš„æœ‰æ•ˆæœŸè¿˜æœ‰å®ƒçš„ç­¾å‘è€…ç­‰ä¿¡æ¯ã€‚ Amazon çš„è¯ä¹¦ä¹Ÿå…·å¤‡ä¸Šè¿°ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Amazon è¯ä¹¦çš„å…¬é’¥æ‹·å‡ºæ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸­é—´æœ‰ä¸€äº›å¡«å……çš„æ•°å­—ï¼Œç”¨ç°è‰²å­—è¡¨ç¤ºã€‚å¯ä»¥çœ‹åˆ°Né€šå¸¸æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•´æ•°ï¼ˆäºŒè¿›åˆ¶ 2048 ä½ï¼‰ï¼Œè€Œ e é€šå¸¸ä¸º 65537ã€‚ ç„¶åæˆ‘ä»¬ç”¨è¿™ä¸ª CA çš„å…¬é’¥å¯¹ mozilla.org çš„è¯ä¹¦ç­¾åè¿›è¡Œè§£å¯†ï¼Œæ–¹æ³•å’Œä¸Šé¢çš„ç±»ä¼¼ï¼š å–è§£å¯†åçš„æ•°å­— decrypted çš„åå…­è¿›åˆ¶çš„æœ« 64 ä½ï¼Œå³ä¸ºäºŒè¿›åˆ¶ 256 ä½çš„ SHA å“ˆå¸Œç­¾åã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æ‰‹åŠ¨è®¡ç®—ä¸€ä¸‹ tbsCertificate çš„ SHA256 å“ˆå¸Œå€¼ï¼Œæ–¹æ³•æ˜¯åœ¨ wireshark é‡Œé¢æŠŠ tbsCertificate å¯¼å‡ºä¸€ä¸ªåŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼š ç„¶åå†ä½¿ç”¨ openssl è®¡ç®—å®ƒçš„å“ˆå¸Œå€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š liyinchengs-MBP:https liyincheng$ openssl dgst -sha256 ~/tbsCertificate.binSHA256(/Users/liyincheng/tbsCertificate.bin)= 5e300091593a10b944051512d39114d56909dc9a504e55cfa2e2984a883a827d æˆ‘ä»¬å‘ç°æ‰‹åŠ¨è®¡ç®—çš„å“ˆå¸Œå€¼å’ŒåŠ å¯†åçš„è¯ä¹¦é‡Œçš„å“ˆå¸Œå€¼ä¸€è‡´ï¼è¯´æ˜åªæœ‰çŸ¥é“äº† Amazon ç§é’¥çš„äººæ‰èƒ½æ­£ç¡®åœ°å¯¹ mozilla.org çš„è¯ä¹¦ç­¾åï¼Œå› ä¸ºå…¬ç§é’¥æ˜¯å”¯ä¸€åŒ¹é…çš„ã€‚ å› æ­¤æˆ‘ä»¬éªŒè¯äº†ç¬¬ä¸€ä¸ªè¯ä¹¦ mozilla.org ç¡®å®æ˜¯ç”±ç¬¬äºŒä¸ªè¯ä¹¦ Amazon ç­¾å‘çš„ï¼Œä½¿ç”¨åŒæ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯ Amazon æ˜¯ç”±ç¬¬ä¸‰ä¸ªç­¾å‘çš„ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ç”±ç¬¬å››ä¸ªæ ¹è¯ä¹¦ç­¾å‘ã€‚ å¹¶ä¸”ç¬¬å››ä¸ªè¯ä¹¦æ˜¯æ ¹è¯ä¹¦ï¼Œå®ƒæ˜¯å†…ç½®äºæ“ä½œç³»ç»Ÿçš„ï¼ˆé€šè¿‡ Mac çš„ keychain å·¥å…·å¯ä»¥æŸ¥çœ‹ï¼‰ï¼š å‡å¦‚ Hacker é€šè¿‡ DNS æ¬ºéª—ä¹‹ç±»çš„æ–¹å¼æŠŠä½ è®¿é—®çš„åŸŸåæŒ‡å‘äº†ä»–çš„æœºå™¨ï¼Œç„¶åä»–å†ä¼ªé€ ä¸€ä¸ªè¯ä¹¦ã€‚ ä½†æ˜¯ç”±äºæ ¹è¯ä¹¦éƒ½æ˜¯å†…ç½®äºæ“ä½œç³»ç»Ÿçš„ï¼Œæ‰€ä»¥å®ƒæ”¹ä¸äº†ç­¾åçš„å…¬é’¥ï¼Œå¹¶ä¸”å®ƒæ²¡æœ‰æ­£ç¡®çš„ç§é’¥ï¼Œåªèƒ½ç”¨è‡ªå·±çš„ç§é’¥ï¼Œç”±äºå…¬ç§é’¥ä¸é…å¯¹ï¼Œå¾ˆéš¾ä¿è¯åŠ è§£å¯†åçš„ä¿¡æ¯ä¸€è‡´ã€‚ æˆ–è€…ç›´æ¥æŠŠæµè§ˆå™¨æ‹¿åˆ°çš„è¯ä¹¦æ¬åˆ°ä»–è‡ªå·±çš„æœåŠ¡å™¨ï¼Ÿè¿™æ ·å†ç»™æµè§ˆå™¨å‘çš„è¯ä¹¦ä¾¿æ˜¯ä¸€æ¨¡ä¸€æ ·ï¼Œä½†æ˜¯ç”±äºä»–ä¸çŸ¥é“è¯ä¹¦çš„ç§é’¥ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡Œåç»­çš„æ“ä½œï¼Œå› æ­¤è¿™æ ·æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚ è¿™ä¸ªå°±æ˜¯ HTTPS èƒ½å¤ŸéªŒè¯èº«ä»½çš„åŸç†ã€‚å¦å¤–ä¸€ä¸ªä¾‹å­æ˜¯ SSHï¼Œéœ€è¦æ‰‹åŠ¨éªŒè¯ç­¾åæ˜¯å¦æ­£ç¡®ã€‚ ä¾‹å¦‚é€šè¿‡æ‰“ç”µè¯æˆ–è€…å‘é‚®ä»¶ç­‰æ–¹å¼å‘ŠçŸ¥æœåŠ¡å™¨çš„ç­¾åï¼Œä¸è‡ªå·±ç®—çš„è¯ä¹¦çš„ç­¾åæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´è¯´æ˜è¯ä¹¦æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ï¼ˆå¦‚è¯ä¹¦çš„å…¬é’¥æ²¡æœ‰è¢«æ”¹ä¸º Hacker çš„å…¬é’¥ï¼‰ï¼š ä¸Šé¢å±•ç¤ºçš„ä¾¿æ˜¯è‡ªå·±æ‰‹åŠ¨è®¡ç®—çš„å€¼ï¼Œæ‹¿è¿™ä¸ªå€¼å’Œä¹‹å‰çš„å€¼è¿›è¡Œæ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ä¾¿å¯çŸ¥å‘è¿‡æ¥çš„è¯ä¹¦æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚ é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ RSA çš„å¯†é’¥å¯¹è¿›è¡ŒåŠ å¯†æ•°æ®ï¼Ÿå› ä¸º RSA çš„å¯†é’¥å¯¹æ•°å€¼å¤ªå¤§ï¼Œä¸å¤ªåˆé€‚é¢‘ç¹åœ°åŠ è§£å¯†æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æ›´å°çš„å¯†é’¥ã€‚ å¦ä¸€ä¸ªåŸå› æ˜¯æœåŠ¡ç«¯æ²¡æœ‰æµè§ˆå™¨æˆ–è€…å®¢æˆ·ç«¯çš„å¯†é’¥ï¼Œæ— æ³•å‘æµè§ˆå™¨å‘é€åŠ å¯†çš„æ•°æ®ï¼ˆä¸èƒ½ç”¨è‡ªå·±çš„ç§é’¥åŠ å¯†ï¼Œå› ä¸ºå…¬é’¥æ˜¯å…¬å¼€çš„ï¼‰ã€‚æ‰€ä»¥éœ€è¦è¿›è¡Œå¯†é’¥äº¤æ¢ã€‚ å¯†é’¥äº¤æ¢ å¯†é’¥äº¤æ¢çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šRSA å’Œ ECDHEï¼ŒRSA çš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œæµè§ˆå™¨ç”Ÿæˆä¸€æŠŠå¯†é’¥ï¼Œç„¶åä½¿ç”¨è¯ä¹¦ RSA çš„å…¬é’¥è¿›è¡ŒåŠ å¯†å‘ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡å†ä½¿ç”¨å®ƒçš„å¯†é’¥è¿›è¡Œè§£å¯†å¾—åˆ°å¯†é’¥ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå…±äº«å¯†é’¥äº†ã€‚ å®ƒçš„ç¼ºç‚¹æ˜¯æ”»å‡»è€…è™½ç„¶åœ¨å‘é€çš„è¿‡ç¨‹ä¸­æ— æ³•ç ´è§£ï¼Œä½†æ˜¯å¦‚æœå®ƒä¿å­˜äº†æ‰€æœ‰åŠ å¯†çš„æ•°æ®ï¼Œç­‰åˆ°è¯ä¹¦åˆ°æœŸæ²¡æœ‰è¢«ç»´æŠ¤ä¹‹ç±»çš„åŸå› å¯¼è‡´ç§é’¥æ³„éœ²ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥ä½¿ç”¨è¿™æŠŠç§é’¥å»è§£å¯†ä¹‹å‰ä¼ é€è¿‡çš„æ‰€æœ‰æ•°æ®ã€‚ è€Œä½¿ç”¨ ECDHE æ˜¯ä¸€ç§æ›´å®‰å…¨çš„å¯†é’¥äº¤æ¢ç®—æ³•ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒæ–¹é€šè¿‡ ECDHE è¿›è¡Œå¯†é’¥äº¤æ¢ï¼š ECDHE çš„å…¨ç§°æ˜¯ Elliptic Curve Diffieâ€“Hellman key Exchange æ¤­åœ†æ›²çº¿è¿ªé-èµ«å°”æ›¼å¯†é’¥äº¤æ¢ï¼Œå®ƒæ˜¯å¯¹è¿ªé-èµ«å°”æ›¼å¯†é’¥äº¤æ¢ç®—æ³•çš„æ”¹è¿›ã€‚ è¿™ä¸ªç®—æ³•çš„æ€æƒ³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸ºäº†å¾—åˆ°å…±äº«ç§˜é’¥ Kï¼Œç”²ç”¨å®ƒçš„ç§é’¥è®¡ç®—ä¸€ä¸ªæ•° g^aï¼Œå‘é€ç»™ä¹™ï¼Œä¹™çš„ç§é’¥ä¸º bï¼Œä¹™ä¾¿å¾—åˆ° K= g^a^bï¼ŒåŒæ—¶å‘é€ g^b ç»™ç”²ï¼Œç”²ä¹Ÿå¾—åˆ°äº† K=g^b^aã€‚ è¿™ä¸ªåº”è¯¥æ¯”è¾ƒå¥½ç†è§£ï¼Œè€Œå¼•å…¥æ¤­åœ†æ›²çº¿åŠ å¯†èƒ½å¤Ÿæé«˜ç ´è§£éš¾åº¦ã€‚ æ¤­åœ†æ›²çº¿åŠ å¯† ç°åœ¨çš„è¯ä¹¦çš„ç­¾åç®—æ³•æœ‰ä¸¤ç§ï¼šRSA å’Œæ–°èµ·çš„ ECã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œgoogle.com ä¾¿æ˜¯ä½¿ç”¨çš„ ECC è¯ä¹¦ï¼š æˆ‘ä»¬ä¸Šé¢è®¨è®ºçš„ä¾¿æ˜¯ RSAï¼Œç ´è§£ RSA çš„éš¾ç‚¹åœ¨äºæ— æ³•å¯¹å…¬é’¥çš„ N è¿›è¡Œè´¨æ•°åˆ†è§£ã€‚ å¦‚æœä½ èƒ½å¯¹è¯ä¹¦çš„ N æ‹†æˆä¸¤ä¸ªè´¨æ•°ç›¸ä¹˜ï¼Œä¾¿å¯æ¨ç®—å‡ºè¯ä¹¦çš„ç§é’¥ï¼Œä½†æ˜¯åœ¨å½“å‰çš„è®¡ç®—èƒ½åŠ›ä¸‹æ˜¯ä¸å¯èƒ½çš„ã€‚è€Œ ECC çš„ç ´è§£éš¾ç‚¹åœ¨äºæ‰¾åˆ°æŒ‡å®šç‚¹çš„ç³»æ•°ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæœ‰ä¸€æ¡æ¤­åœ†æ›²çº¿æ–¹ç¨‹ï¼š y ^ 3 = x ^ 2 + ax + b: ç»™å®šä¸€ä¸ªèµ·ç‚¹ Gï¼ˆxï¼Œyï¼‰ï¼Œç°åœ¨è¦è®¡ç®—ç‚¹ P=2G çš„åæ ‡ï¼Œå…¶è¿‡ç¨‹æ˜¯åœ¨ G ç‚¹ä¸Šåšä¸€æ¡çº¿ä¸æ›²çº¿ç›¸åˆ‡äº -2Gï¼Œåš -2G ç›¸å¯¹äº x è½´çš„åå°„ä¾¿å¾—åˆ° 2G ç‚¹ã€‚ ä¸ºäº†è®¡ç®— 3G çš„åæ ‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿æ¥ 2G ä¸ G ä¸æ›²çº¿ç›¸éƒŠäº -3Gï¼Œå†åšåå°„å¾—åˆ° 3Gï¼ŒåŒç†è®¡ç®— 4G ä¾¿æ˜¯è¿æ¥ G ä¸ 3G å†åšåå°„ã€‚å¦‚æœæœ€åä¸€ä¸ªç‚¹å’Œèµ·ç‚¹çš„è¿çº¿å‚ç›´äº x è½´ï¼Œè¯´æ˜æ‰€æœ‰çš„ç‚¹å·²ç”¨å®Œã€‚ EC çš„éš¾ç‚¹åœ¨äºç»™å®šèµ·ç‚¹ G å’Œç‚¹ Kï¼š K = kG æƒ³è¦å¾—åˆ° Kï¼ˆK è¶³å¤Ÿå¤§ï¼‰æ˜¯ä¸€ä»¶å¾ˆå›°éš¾çš„äº‹æƒ…ã€‚è¿™ä¸ª K ä¾¿æ˜¯ç§é’¥ï¼Œè€Œ K=kG ä¾¿æ˜¯å…¬é’¥ã€‚ECC æ˜¯æ€ä¹ˆåŠ è§£å¯†æ•°æ®çš„å‘¢ï¼Ÿ å‡è®¾è¦åŠ å¯†çš„æ•°æ®ä¸º mï¼ŒæŠŠè¿™ä¸ªç‚¹å½“ä½œxåæ ‡å¾—åˆ°åœ¨æ›²çº¿ä¸Šçš„ä¸€ä¸ªç‚¹ Mï¼Œå–å®šä¸€ä¸ªéšæœºæ•° rï¼Œè®¡ç®—ç‚¹ C1=rGï¼ŒC2=M+rKã€‚ æŠŠè¿™ä¸¤ä¸ªç‚¹ä¾¿æ˜¯åŠ å¯†åçš„æ•°æ®ï¼Œå‘ç»™å¯¹æ–¹ï¼Œå¯¹æ–¹æ”¶åˆ°åä½¿ç”¨ç§é’¥ K è¿›è¡Œè§£å¯†ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š M = C2 - rK = C2 - rkG = C2 - rkG = C2 - kC1 é€šè¿‡ä¸Šé¢çš„è®¡ç®—ä¾¿èƒ½è¿˜åŸå¾—åˆ° Mï¼Œè€Œä¸çŸ¥é“ç§é’¥ K çš„äººæ˜¯æ— æ³•è§£å¯†çš„ã€‚æ›´å¤šç»†èŠ‚å¯è§ Medium çš„è¿™ç¯‡æ–‡ç« ã€ŠECC elliptic curve encryptionã€‹ã€‚è¿™æ ·æˆ‘ä»¬ä¾¿ç†è§£äº† ECC çš„åŸç†ï¼Œé‚£ä¹ˆæ€ä¹ˆåˆ©ç”¨ ECC è¿›è¡Œå¯†é’¥äº¤æ¢å‘¢ï¼Ÿ ECC å¯†é’¥äº¤æ¢ åŸç†å¾ˆç®€å•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¹‹å‰äº¤æ¢çš„æ˜¯ä¸¤ä¸ªå¹‚æ¬¡æ–¹çš„æ•°ï¼Œç°åœ¨å˜æˆäº¤æ¢ä¸¤ä¸ªæ›²çº¿ä¸Šçš„ç‚¹ã€‚ è€Œæ›²çº¿æ–¹ç¨‹æ˜¯è§„å®šå¥½çš„ï¼Œä¾‹å¦‚ Curve X25519 ä½¿ç”¨çš„æ›²çº¿æ–¹ç¨‹ä¸ºï¼š y^2 = x^3 + 486662x^2 + x åœ¨å¯†é’¥äº¤æ¢é‡Œé¢ä¼šæŒ‡å®šæ‰€ä½¿ç”¨çš„æ›²çº¿æ–¹ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š mozilla.org æ‰€ä½¿ç”¨çš„æ›²çº¿æ–¹ç¨‹ä¸º secp256r1ï¼Œè¿™ä¸ªä¹Ÿæ˜¯æ¯”è¾ƒæµè¡Œçš„ä¸€ä¸ªï¼Œå®ƒçš„å‚æ•°æ¯” Curve X25519 å¤§å¾ˆå¤šã€‚ å¯†é’¥äº¤æ¢ä¹Ÿä½¿ç”¨äº†è¯ä¹¦çš„ç§é’¥è¿›è¡Œç­¾åï¼Œä¿è¯äº¤æ¢çš„å¯†é’¥ä¸ä¼šè¢«äººç¯¡æ”¹ï¼Œåªæ˜¯è¿™é‡Œçš„ç§é’¥æ˜¯ mozilla è‡ªå·±çš„ç§é’¥ã€‚ ä¹Ÿå°±æ˜¯è¯´ä»è¿æ¥å»ºç«‹åˆ°ç°åœ¨éƒ½æ˜¯æ˜æ–‡ä¼ è¾“çš„ã€‚æ¥ä¸‹æ¥åŒæ–¹å‘é€ Change Cipher Spec çš„åŒ…é€šçŸ¥ï¼Œæ¥ä¸‹æ¥çš„åŒ…éƒ½æŒ‰ç…§ä¹‹å‰çº¦å®šå¥½çš„æ–¹å¼è¿›è¡ŒåŠ å¯†ã€‚è‡³æ­¤æ•´ä¸ªå®‰å…¨è¿æ¥å»ºç«‹å®Œæ¯•ã€‚ HTTPS è¯ä¹¦çš„åº”ç”¨ é‚£ä¹ˆæ˜¯è°åœ¨åš HTTPS åŠ å¯†å‘¢ï¼ŸæœåŠ¡ç«¯é€šå¸¸æ˜¯ Nginxã€Apache è¿™äº›åå‘ä»£ç†æœåŠ¡å™¨åšçš„ï¼Œè€Œå…·ä½“çš„ä¸šåŠ¡æœåŠ¡å™¨ä¸éœ€è¦å¤„ç†ï¼Œå®¢æˆ·ç«¯é€šå¸¸æ˜¯æµè§ˆå™¨ç­‰åšçš„åŠ è§£å¯†ï¼ŒChrome æ˜¯ä½¿ç”¨ boringSSL è¿™ä¸ªåº“ï¼Œfork è‡ª opensslã€‚ æˆ‘ä»¬é€šè¿‡ letâ€™s encrypt å¯ä»¥ç”³è¯·å…è´¹çš„ TLS è¯ä¹¦ï¼Œæ¯ 3 ä¸ªæœˆéœ€è¦æ‰‹åŠ¨ç»­ã€‚ è¯ä¹¦åˆ†ä¸º 3 ç§ï¼šDVã€OVã€EVï¼ŒDV é€‚ç”¨äºä¸ªäººï¼ŒOV å’Œ EV éœ€è¦èº«ä»½å®¡æ ¸ï¼ŒEV æœ€é«˜ç«¯ã€‚ EV è¯ä¹¦ä¼šåœ¨æµè§ˆå™¨çš„åœ°å€æ æ˜¾ç¤ºè¯ä¹¦çš„ä¼ä¸šåç§°ï¼š ä½†æ˜¯æ–°ç‰ˆçš„ Chrome ä¼¼ä¹æŠŠè¿™ä¸ªå»æ‰äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“å¼€ medium çš„æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæç¤ºï¼š As part of an experiment, Chrome temporarily shows only the lock icon in the address bar. Your SSL certificate with Extended Validation is still valid. å¦å¤–æˆ‘ä»¬å¯ä»¥ç”¨ openssl ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åè¯ä¹¦ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š openssl req -x509 -nodes -sha256 -days 365 -newkey rsa:2048 -keyout test.com.key -out test.com.crt ä¾¿ä¼šå¾—åˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼Œtest.com.crt æ˜¯è¯ä¹¦ï¼Œtest.com.key æ˜¯è¯ä¹¦çš„ç§é’¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç„¶åæŠŠè¿™ä¸¤ä¸ªæ–‡ä»¶ç»™ Nginx ä½¿ç”¨ä¾¿èƒ½ä½¿ç”¨ HTTPS è®¿é—®ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š server { listen 443; server_name test.com; ssl on; ssl_certificate test.com.crt; ssl_certificate_key test.com.key; } å¯ä»¥æŠŠè¿™ä¸ªè¯ä¹¦æ·»åŠ åˆ°ç³»ç»Ÿè¯ä¹¦é‡Œé¢ï¼Œè¿™æ ·æµè§ˆå™¨ç­‰ä¾¿èƒ½ä¿¡ä»»ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ mkcert å·¥å…·ä¸€æ­¥åˆ°ä½ã€‚ å®¢æˆ·ç«¯è¯ä¹¦ è¿˜æœ‰ä¸€ç§è¯ä¹¦å«å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŒæ ·éœ€è¦å‘ CA æœºæ„ç”³è¯·ä¸€ä¸ªå®¢æˆ·ç«¯è¯ä¹¦ï¼Œå’ŒæœåŠ¡ç«¯ TLS è¯ä¹¦ä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯ï¼ŒæœåŠ¡ç«¯è¯ä¹¦é€šå¸¸æ˜¯å’ŒåŸŸåç»‘å®šçš„ï¼Œè€Œå®¢æˆ·ç«¯è¯ä¹¦å¯ä»¥ç»™æœ¬åœ°çš„ä»»æ„å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œç­¾åã€‚ ç­¾åéªŒè¯ç®—æ³•å’Œä¸Šæ–‡è®¨è®ºçš„ TLS è¯ä¹¦ä¸€è‡´ã€‚ä¸ºä»€ä¹ˆå¯æ‰§è¡Œæ–‡ä»¶éœ€è¦ç­¾åå‘¢ï¼Œå› ä¸ºå¦‚æœä¸ç­¾åçš„è¯ï¼Œç³»ç»Ÿä¼šæ‹¦æˆªå®‰è£…æˆ–è€…è¿è¡Œï¼Œå¦‚ Mac åŒå‡»ä¸€ä¸ªæœªç­¾åçš„ dmg åŒ…çš„æç¤ºï¼š ç›´æ¥ä¸è®©ä½ è¿è¡Œäº†ï¼Œè€Œ Windows ä¹Ÿæœ‰ç±»ä¼¼çš„æç¤ºï¼ŒWindows æ˜¯ä¼šç»™ä¸€ä¸ªè­¦å‘Šï¼š è€Œå½“æˆ‘ä»¬è¿è¡Œä¸€ä¸ªå·²ç­¾åçš„ exe æ–‡ä»¶å°†ä¼šæ˜¯æ­£å¸¸çš„æç¤ºï¼Œå¦‚ Chrome çš„æç¤ºï¼š ç»¼ä¸Šæœ¬æ–‡ä¸»è¦è®¨è®ºäº†å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†çš„åŸç†ï¼Œå¹¶ä»‹ç»äº†å¦‚ä½•åˆ©ç”¨ RSA å¯¹è¯ä¹¦ç­¾åçš„æ£€éªŒä»¥éªŒè¯è¿æ¥æœåŠ¡å™¨çš„èº«ä»½ï¼Œæ€ä¹ˆåˆ©ç”¨ ECC è¿›è¡Œæ•°æ®åŠ å¯†å’Œå¯†é’¥äº¤æ¢ï¼Œä»‹ç»äº†ä¸‹æ€ä¹ˆç”Ÿæˆå’Œä½¿ç”¨ HTTPS è¯ä¹¦ï¼Œå¹¶ä»‹ç»äº†ä¸‹å®¢æˆ·ç«¯è¯ä¹¦ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/ç½‘ç»œåè®®/tcp:ip/TCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹.html":{"url":"linux/ç½‘ç»œåè®®/tcp:ip/TCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹.html","title":"TCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹","keywords":"","body":"TCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ ä¸‰æ¬¡æ¡æ‰‹ï¼ˆé‡ç‚¹ï¼‰ TCP æä¾›é¢å‘æœ‰è¿æ¥çš„é€šä¿¡ä¼ è¾“ã€‚é¢å‘æœ‰è¿æ¥æ˜¯æŒ‡åœ¨æ•°æ®é€šä¿¡å¼€å§‹ä¹‹å‰å…ˆåšå¥½ä¸¤ç«¯ä¹‹é—´çš„å‡†å¤‡å·¥ä½œã€‚ æ‰€è°“ä¸‰æ¬¡æ¡æ‰‹æ˜¯æŒ‡å»ºç«‹ä¸€ä¸ª TCP è¿æ¥æ—¶éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯æ€»å…±å‘é€ä¸‰ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„å»ºç«‹ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æ‰§è¡Œconnectæ¥è§¦å‘ã€‚ ä¸‹é¢æ¥çœ‹çœ‹ä¸‰æ¬¡æ¡æ‰‹çš„æµç¨‹å›¾ï¼š ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å°†æ ‡å¿—ä½SYNç½®ä¸º1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=Jï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯è¿›å…¥SYN_SENTçŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯ç¡®è®¤ã€‚ ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡å™¨ç«¯æ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½SYN=1çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨ç«¯å°†æ ‡å¿—ä½SYNå’ŒACKéƒ½ç½®ä¸º1ï¼Œack=J+1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=Kï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™å®¢æˆ·ç«¯ä»¥ç¡®è®¤è¿æ¥è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯è¿›å…¥SYN_RCVDçŠ¶æ€ã€‚ ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°ç¡®è®¤åï¼Œæ£€æŸ¥ackæ˜¯å¦ä¸ºJ+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ACKç½®ä¸º1ï¼Œack=K+1ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯æ£€æŸ¥ackæ˜¯å¦ä¸ºK+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œéšåå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ä¹‹é—´å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®äº†ã€‚ è¿™é‡Œå°å†™çš„ackä¸ºç¡®è®¤ç¼–å·(ä¸Šä¸€æ¬¡å¯¹æ–¹ä¸»æœºä¼ è¾“è¿‡æ¥çš„seq+1)ï¼Œå¤§å†™çš„ACKæ˜¯ç¡®è®¤å€¼ï¼Œç¡®è®¤å€¼ä¸º1è¡¨ç¤ºç¡®è®¤è¿æ¥ å››æ¬¡æŒ¥æ‰‹ï¼ˆé‡ç‚¹ï¼‰ å››æ¬¡æŒ¥æ‰‹å³ç»ˆæ­¢TCPè¿æ¥ï¼Œå°±æ˜¯æŒ‡æ–­å¼€ä¸€ä¸ªTCPè¿æ¥æ—¶ï¼Œéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ€»å…±å‘é€4ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„æ–­å¼€ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯ä»»ä¸€æ–¹æ‰§è¡Œcloseæ¥è§¦å‘ã€‚ ç”±äºTCPè¿æ¥æ˜¯å…¨åŒå·¥çš„ï¼Œå› æ­¤ï¼Œæ¯ä¸ªæ–¹å‘éƒ½å¿…é¡»è¦å•ç‹¬è¿›è¡Œå…³é—­ï¼Œè¿™ä¸€åŸåˆ™æ˜¯å½“ä¸€æ–¹å®Œæˆæ•°æ®å‘é€ä»»åŠ¡åï¼Œå‘é€ä¸€ä¸ªFINæ¥ç»ˆæ­¢è¿™ä¸€æ–¹å‘çš„è¿æ¥ï¼Œæ”¶åˆ°ä¸€ä¸ªFINåªæ˜¯æ„å‘³ç€è¿™ä¸€æ–¹å‘ä¸Šæ²¡æœ‰æ•°æ®æµåŠ¨äº†ï¼Œå³ä¸ä¼šå†æ”¶åˆ°æ•°æ®äº†ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªTCPè¿æ¥ä¸Šä»ç„¶èƒ½å¤Ÿå‘é€æ•°æ®ï¼Œç›´åˆ°è¿™ä¸€æ–¹å‘ä¹Ÿå‘é€äº†FINã€‚é¦–å…ˆè¿›è¡Œå…³é—­çš„ä¸€æ–¹å°†æ‰§è¡Œä¸»åŠ¨å…³é—­ï¼Œè€Œå¦ä¸€æ–¹åˆ™æ‰§è¡Œè¢«åŠ¨å…³é—­ã€‚ ä¸‹é¢æ¥çœ‹çœ‹å››æ¬¡æŒ¥æ‰‹çš„æµç¨‹å›¾ï¼š ä¸­æ–­è¿æ¥ç«¯å¯ä»¥æ˜¯å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨ç«¯ã€‚ ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªFIN=Mï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ç«¯çš„æ•°æ®ä¼ é€ï¼Œå®¢æˆ·ç«¯è¿›å…¥FIN_WAIT_1çŠ¶æ€ã€‚æ„æ€æ˜¯è¯´\"æˆ‘å®¢æˆ·ç«¯æ²¡æœ‰æ•°æ®è¦å‘ç»™ä½ äº†\"ï¼Œä½†æ˜¯å¦‚æœä½ æœåŠ¡å™¨ç«¯è¿˜æœ‰æ•°æ®æ²¡æœ‰å‘é€å®Œæˆï¼Œåˆ™ä¸å¿…æ€¥ç€å…³é—­è¿æ¥ï¼Œå¯ä»¥ç»§ç»­å‘é€æ•°æ®ã€‚ ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡å™¨ç«¯æ”¶åˆ°FINåï¼Œå…ˆå‘é€ack=M+1ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œä½ çš„è¯·æ±‚æˆ‘æ”¶åˆ°äº†ï¼Œä½†æ˜¯æˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œè¯·ç»§ç»­ä½ ç­‰æˆ‘çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±è¿›å…¥FIN_WAIT_2 çŠ¶æ€ï¼Œç»§ç»­ç­‰å¾…æœåŠ¡å™¨ç«¯çš„FINæŠ¥æ–‡ã€‚ ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šå½“æœåŠ¡å™¨ç«¯ç¡®å®šæ•°æ®å·²å‘é€å®Œæˆï¼Œåˆ™å‘å®¢æˆ·ç«¯å‘é€FIN=NæŠ¥æ–‡ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå¥½äº†ï¼Œæˆ‘è¿™è¾¹æ•°æ®å‘å®Œäº†ï¼Œå‡†å¤‡å¥½å…³é—­è¿æ¥äº†ã€‚æœåŠ¡å™¨ç«¯è¿›å…¥LAST_ACKçŠ¶æ€ã€‚ ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°FIN=NæŠ¥æ–‡åï¼Œå°±çŸ¥é“å¯ä»¥å…³é—­è¿æ¥äº†ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯ä¸ç›¸ä¿¡ç½‘ç»œï¼Œæ€•æœåŠ¡å™¨ç«¯ä¸çŸ¥é“è¦å…³é—­ï¼Œæ‰€ä»¥å‘é€ack=N+1åè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œå¦‚æœServerç«¯æ²¡æœ‰æ”¶åˆ°ACKåˆ™å¯ä»¥é‡ä¼ ã€‚æœåŠ¡å™¨ç«¯æ”¶åˆ°ACKåï¼Œå°±çŸ¥é“å¯ä»¥æ–­å¼€è¿æ¥äº†ã€‚å®¢æˆ·ç«¯ç­‰å¾…äº†2MSLåä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œåˆ™è¯æ˜æœåŠ¡å™¨ç«¯å·²æ­£å¸¸å…³é—­ï¼Œé‚£å¥½ï¼Œæˆ‘å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚æœ€ç»ˆå®Œæˆäº†å››æ¬¡æ¡æ‰‹ã€‚ ä¸Šé¢æ˜¯ä¸€æ–¹ä¸»åŠ¨å…³é—­ï¼Œå¦ä¸€æ–¹è¢«åŠ¨å…³é—­çš„æƒ…å†µï¼Œå®é™…ä¸­è¿˜ä¼šå‡ºç°åŒæ—¶å‘èµ·ä¸»åŠ¨å…³é—­çš„æƒ…å†µï¼Œ å…·ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š å…³äºTCPåè®®ä¸­ä¸‰æ¬¡æ¡æ‰‹ä¸­çš„å¤§å†™ACKå’Œå°å†™ack numberçš„åŒºåˆ« åœ¨ä¸‰æ¬¡æ¡æ‰‹å‘é€çš„æ•°æ®åŒ…ä¸­æœ‰ä¸¤ä¸ªACKå€¼ï¼ˆAcknowledgementï¼‰ï¼Œäººä»¬ä¹ æƒ¯ä¸€ä¸ªå¤§å†™ï¼Œä¸€ä¸ªå°å†™æ¥åŠ ä»¥åŒºåˆ†ã€‚å¤§å°å†™åªæ˜¯ä¸ºäº†ä¾¿äºåŒºåˆ† ä¸€ä¸ªæ˜¯ç¡®è®¤å€¼(Acknowledgement)ï¼Œä¸º1ä¾¿æ˜¯ç¡®è®¤è¿æ¥ã€‚ å¦ä¸€ä¸ªæ˜¯ç¡®è®¤ç¼–å·(Acknowledgement Number)ï¼Œå³æ¥æ”¶åˆ°çš„ä¸Šä¸€æ¬¡è¿œç«¯ä¸»æœºä¼ æ¥çš„seqç„¶å+1ï¼Œå†å‘é€ç»™è¿œç«¯ä¸»æœºã€‚æç¤ºè¿œç«¯ä¸»æœºå·²ç»æˆåŠŸæ¥æ”¶ä¸Šä¸€æ¬¡æ‰€æœ‰æ•°æ®ã€‚ ä¸‰æ¬¡æ¡æ‰‹çš„æ•°æ®åŒ… ç¬¬ä¸€æ¬¡æ¡æ‰‹ çº¢æ¡†å†…ä¸ºç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶IPä¸º192.168.56.1çš„è¯·æ±‚ç«¯ï¼ˆè¯·æ±‚è¿æ¥ç«¯ï¼‰å‘é€çš„seqï¼Œå€¼ä¸º0ï¼ˆå®é™…ä¸­æ­¤å€¼ä¸ä¸€å®šä¸º0ï¼‰ ç¬¬äºŒæ¬¡æ¡æ‰‹ çº¢æ¡†å†…ä¸ºç¬¬äºŒæ¬¡æ¡æ‰‹æ—¶IPä¸º192.168.56.130çš„æœåŠ¡ç«¯ï¼ˆè¢«è¯·æ±‚è¿æ¥ç«¯ï¼‰å‘é€çš„seqï¼Œå› ä¸ºæ˜¯æœåŠ¡ç«¯å‘ç»™è¯·æ±‚ç«¯çš„ä¸€ä¸ªæ–°çš„seqï¼Œæ‰€ä»¥å€¼ä¸º0ï¼ˆå®é™…ä¸­æ­¤å€¼ä¸ä¸€å®šä¸º0ï¼‰ è“æ¡†å†…ä¸ºAckï¼ˆAcknowledgement Numberç¡®è®¤ç¼–å·ï¼‰å³æˆ‘ç†è§£çš„å°å†™çš„ackï¼Œå€¼ä¸ºç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶è¯·æ±‚ç«¯å‘é€æ¥çš„seq+1å³0+1=1 ç¬¬ä¸‰æ¬¡æ¡æ‰‹ çº¢æ¡†å†…ä¸ºç¬¬ä¸‰æ¬¡æ¡æ‰‹æ—¶IPä¸º192.168.56.1çš„è¯·æ±‚ç«¯ï¼ˆè¯·æ±‚è¿æ¥ç«¯ï¼‰å‘é€çš„seqï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶å®ƒå‘é€ç»™æœåŠ¡ç«¯çš„seqä¸º0ï¼ˆé»„æ¡†å†…ï¼‰ï¼Œåœ¨ä¸Šæ¬¡çš„åŸºç¡€ä¸Š+1ï¼Œå€¼å°±æ˜¯1ã€‚ è“æ¡†å†…çš„Ackï¼ˆAcknowledgement Numberç¡®è®¤ç¼–å·ï¼‰è¿˜æ˜¯æˆ‘ç†è§£çš„å°å†™çš„ackï¼Œå€¼ä¸ºç¬¬äºŒæ¬¡æ¡æ‰‹æ—¶è¯·æ±‚ç«¯å‘æ¥çš„seq+1ï¼Œå³ç»¿æ¡†ä¸­çš„seq+1ï¼Œå€¼ä¸º0+1=1 é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé‚£ä¸ªèµ·ç¡®è®¤è¿æ¥ä½œç”¨çš„ç¡®è®¤å€¼å³æˆ‘ç†è§£çš„é‚£ä¸ªå¤§å†™çš„ACKåœ¨å“ªå‘¢ï¼Ÿ åœ¨è¿™é‡Œï¼Œå±•å¼€çœ‹ä¸€ä¸‹ï¼š å¯¹ç…§ç½‘ä¸Šæ‰¾åˆ°çš„å…³äºç¬¬äºŒæ¬¡æ¡æ‰‹çš„æ ‡å¿—ä½çš„ä¸€å¼ å›¾å¯ä»¥çœ‹å‡ºï¼š ç¡®è®¤ä½å³ACKï¼Œä¸º1å³ä¸ºç¡®è®¤è¿›è¡Œè¿æ¥ åŒæ­¥ä½å³SYNï¼Œä»ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶ï¼Œæ­¤ä½å°±ä¸º1 ä¸‹é¢æ˜¯ç½‘ä¸Šæ‰¾åˆ°çš„ä¸‰æ¬¡æ¡æ‰‹çš„æ ‡å¿—å›¾ï¼Œä¾›å‚è€ƒï¼š ç¬¬ä¸€æ¬¡æ¡æ‰‹çš„æ ‡å¿—ä½ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ ‡å¿—ä½é‡Œé¢åªæœ‰ä¸ªåŒæ­¥ä½ï¼Œä¹Ÿå°±æ˜¯åœ¨åšè¯·æ±‚(SYN) ç¬¬äºŒæ¬¡æ¡æ‰‹çš„æ ‡å¿—ä½ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ ‡å¿—ä½é‡Œé¢æœ‰ä¸ªç¡®è®¤ä½å’ŒåŒæ­¥ä½ï¼Œä¹Ÿå°±æ˜¯åœ¨åšåº”ç­”(SYN + ACK) ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„æ ‡å¿—ä½ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ ‡å¿—ä½é‡Œé¢åªæœ‰ä¸ªç¡®è®¤ä½ï¼Œä¹Ÿå°±æ˜¯å†åšå†æ¬¡ç¡®è®¤(ACK) æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/1.mysqlåŸºæœ¬æ“ä½œ.html":{"url":"db/mysql/mysqlåŸºç¡€/1.mysqlåŸºæœ¬æ“ä½œ.html","title":"1.mysqlåŸºæœ¬æ“ä½œ","keywords":"","body":"mysqlåŸºç¡€ mysqlåŸºæœ¬æ“ä½œ Mysql å…³ç³»å‹æ•°æ®åº“ï¼Œè¡¨è·Ÿè¡¨ä¹‹é—´å¯ä»¥å»ºç«‹å…³ç³» åº“-->è¡¨ï¼šåˆ—(å­—æ®µ faield) â€‹ è¡Œ(è®°å½• record) 1.è¿æ¥mysql mysql -uç”¨æˆ·å -på¯†ç  [root@mysql ~]# mysql -u root -p Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 32 Server version: 5.6.40 MySQL Community Server (GPL) Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. mysql> 2.è®¾ç½®rootå¯†ç  æ–¹æ³•ä¸€ å‘½ä»¤è¡Œè®¾ç½® mysqladmin -uroot password 'å¯†ç ' æ–¹æ³•äºŒ è¿›å…¥mysqlè®¾ç½® set password = password('å¯†ç '); 3.mysqlåˆå§‹å®‰å…¨è®¾ç½® mysql_secure_installation [root@mysql ~]# mysql_secure_installation Enter current password for root (enter for none): #è¾“å…¥rootå¯†ç  Change the root password? [Y/n] #æ˜¯å¦æ”¹å˜rootå¯†ç  Remove anonymous users? [Y/n] #æ˜¯å¦ç§»é™¤åŒ¿åç”¨æˆ· Disallow root login remotely? [Y/n] #æ˜¯å¦å…è®¸rootè¿œç¨‹ç™»é™† Remove test database and access to it? [Y/n] #æ˜¯å¦ç§»é™¤teståº“å¹¶ä¸”ä¸èƒ½è®¿é—® Reload privilege tables now? [Y/n] #æ˜¯å¦é‡æ–°åŠ è½½æƒé™è¡¨ Enter current password for root (enter for none): #è¾“å…¥rootå¯†ç  4.mysqlæ–‡ä»¶(yumå®‰è£…) [root@mysql ~]# cd /var/lib/mysql/ [root@mysql mysql]# ls ibdata1 ib_logfile0 ib_logfile1 mysql mysql.sock ibdata1 #InnoDBå­˜å‚¨å¼•æ“çš„ç³»ç»Ÿè¡¨ç©ºé—´ï¼Œå­˜æ”¾InnoDBè¡¨çš„æ•°æ®ã€å›æ»šæ®µ ib_logfile0ã€ib_logfile1 #InnoDBæ—¥å¿—æ–‡ä»¶ç»„ mysql #æ•°æ®åº“ åº“åå­— mysql.sock #mysqlçš„socketæ–‡ä»¶ï¼Œç”¨äºæœ¬æœºç”¨æˆ·ç™»é™†mysql mysqlä¸»é…ç½®æ–‡ä»¶ /etc/my.cnf 5.åº“çš„ç®¡ç† 5.1åˆ›å»ºæ•°æ®åº“ create database æ•°æ®åº“å mysql> create database DB1; Query OK, 1 row affected (0.00 sec) mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | DB1 | | mysql | | performance_schema | | sys | +--------------------+ 5 rows in set (0.05 sec) 5.2åˆ é™¤æ•°æ®åº“ drop database æ•°æ®åº“å mysql> drop database DB1; Query OK, 0 rows affected (0.00 sec) mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | sys | +--------------------+ 4 rows in set (0.09 sec) 5.3æŸ¥è¯¢æ•°æ®åº“ show databases mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | +--------------------+ 2 rows in set (0.00 sec) 5.4ä½¿ç”¨æ•°æ®åº“ use æ•°æ®åº“å mysql> use DB1; Database changed mysql> select database(); #æŸ¥çœ‹å½“å‰ä½¿ç”¨å“ªä¸ªæ•°æ®åº“ +------------+ | database() | +------------+ | DB1 | +------------+ 1 row in set (0.00 sec) 6.è¡¨çš„ç®¡ç† 6.1åˆ›å»ºè¡¨ create table è¡¨å(åˆ—å1 æ•°æ®ç±»å‹,åˆ—å2 æ•°æ®ç±»å‹); mysql> create table t1(id int(3),name char(30),sex enum('M','F'),hobby set('a','b','c')); Query OK, 0 rows affected (0.03 sec) #desc è¡¨å //æè¿°è¡¨ mysql> desc t1; +-------+------------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+------------------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | | name | char(30) | YES | | NULL | | | sex | enum('M','F') | YES | | NULL | | | hobby | set('a','b','c') | YES | | NULL | | +-------+------------------+------+-----+---------+-------+ 4 rows in set (0.13 sec) #insert into è¡¨å values(......); //å‘è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into t1 values(1,'xiaoming','M','a,b,c'); Query OK, 1 row affected (0.00 sec) mysql> select * from t1; +----+----------+-----+-------+ | id | name | sex | hobby | +----+----------+-----+-------+ | 1 | xiaoming | M | a,b,c | +----+----------+-----+-------+ 1 row in set (0.12 sec) 6.2åˆ é™¤è¡¨ åˆ é™¤ä¸€ä¸ªè¡¨ drop table è¡¨å åˆ é™¤å¤šä¸ªè¡¨ drop table è¡¨1,è¡¨2ï¼Œã€‚ã€‚ã€‚è¡¨n; #åˆ é™¤ä¸€ä¸ªè¡¨ mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | t1 | +---------------+ 1 row in set (0.13 sec) mysql> drop table t1; Query OK, 0 rows affected (0.12 sec) #åˆ é™¤å¤šä¸ªè¡¨ mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | t1 | | t2 | +---------------+ 2 rows in set (0.16 sec) mysql> drop table t1,t2; Query OK, 0 rows affected (0.20 sec) 6.3ä¿®æ”¹è¡¨ 6.3.1å¢åŠ åˆ— alter table è¡¨å add åˆ—å æ•°æ®ç±»å‹; #æŸ¥çœ‹t1è¡¨ï¼Œæ­¤æ—¶è¡¨ä¸­åªæœ‰ä¸€ä¸ªåˆ—idï¼Œç°åœ¨æƒ³å¢åŠ ä¸€ä¸ªåˆ—name mysql> desc t1; +-------+--------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+--------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | +-------+--------+------+-----+---------+-------+ 1 row in set (0.10 sec) #ç»™t1è¡¨å¢åŠ åˆ—name mysql> alter table t1 add name char(10); Query OK, 0 rows affected (0.15 sec) Records: 0 Duplicates: 0 Warnings: 0 #æŸ¥çœ‹t1è¡¨ï¼Œå·²ç»å¢åŠ nameåˆ— mysql> desc t1; +-------+----------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+----------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | | name | char(10) | YES | | NULL | | +-------+----------+------+-----+---------+-------+ 2 rows in set (0.10 sec) addå¢åŠ åˆ—é»˜è®¤æ˜¯åœ¨æœ€åè¾¹æ·»åŠ ï¼Œå¦‚æœéœ€è¦æŒ‡å®šè¿½åˆ°çš„ä½ç½®éœ€è¦åšä»¥ä¸‹æ“ä½œ #t2è¡¨å†…å®¹å¦‚ä¸‹ï¼Œç°åœ¨è¦è¿½åŠ ä¸€ä¸ªphoneåˆ—ï¼Œè¿½åŠ åˆ°nameåˆ—çš„åè¾¹ mysql> desc t2; +---------+----------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +---------+----------+------+-----+---------+-------+ | id | int(11) | YES | | NULL | | | name | char(10) | YES | | NULL | | | address | char(30) | YES | | NULL | | +---------+----------+------+-----+---------+-------+ 3 rows in set (0.01 sec) #éœ€è¦ç”¨åˆ°afterå…³é”®å­—ï¼Œæ­¤è¯­å¥è¡¨æ˜åœ¨nameåˆ—åè¿½åŠ phoneåˆ— mysql> alter table t2 add phone char(11) after name; Query OK, 0 rows affected (0.04 sec) Records: 0 Duplicates: 0 Warnings: 0 mysql> desc t2; +---------+----------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +---------+----------+------+-----+---------+-------+ | id | int(11) | YES | | NULL | | | name | char(10) | YES | | NULL | | | phone | char(11) | YES | | NULL | | | address | char(30) | YES | | NULL | | +---------+----------+------+-----+---------+-------+ 4 rows in set (0.00 sec) #å¦‚æœè¦è¿½åŠ åˆ°ç¬¬ä¸€åˆ—ï¼Œéœ€è¦ç”¨åˆ°firstå…³é”®å­— mysql> alter table t2 add sex enum('F','M') first; Query OK, 0 rows affected (0.05 sec) Records: 0 Duplicates: 0 Warnings: 0 mysql> desc t2; +---------+---------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +---------+---------------+------+-----+---------+-------+ | sex | enum('F','M') | YES | | NULL | | | id | int(11) | YES | | NULL | | | name | char(10) | YES | | NULL | | | phone | char(11) | YES | | NULL | | | address | char(30) | YES | | NULL | | +---------+---------------+------+-----+---------+-------+ 5 rows in set (0.00 sec) âš ï¸âš ï¸âš ï¸ ä¿®æ”¹åˆ—ä¸­ä¸æ”¯æŒbeforeï¼Œåªæœ‰afterå’Œfirst 6.3.2åˆ é™¤åˆ— alter table è¡¨å drop åˆ—å; #æŸ¥çœ‹t1è¡¨ï¼Œè¡¨ä¸­æœ‰ä¸¤ä¸ªåˆ—idå’Œname,ç°åœ¨è¦åˆ é™¤nameåˆ— mysql> desc t1; +-------+----------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+----------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | | name | char(10) | YES | | NULL | | +-------+----------+------+-----+---------+-------+ 2 rows in set (0.10 sec) #åˆ é™¤nameåˆ— mysql> alter table t1 drop name; Query OK, 0 rows affected (0.14 sec) Records: 0 Duplicates: 0 Warnings: 0 #æŸ¥çœ‹t1è¡¨nameåˆ—å·²ç»åˆ é™¤ mysql> desc t1; +-------+--------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+--------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | +-------+--------+------+-----+---------+-------+ 1 row in set (0.12 sec) 6.3.3ä¿®æ”¹åˆ—å alter table è¡¨å change æ—§åˆ—å æ–°åˆ—å æ•°æ®ç±»å‹; changeæ—¢å¯ä»¥ä¿®æ”¹åˆ—åï¼Œåˆå¯ä»¥ä¿®æ”¹åˆ—ç±»å‹ #æŸ¥çœ‹t1è¡¨ï¼Œè¡¨ä¸­æœ‰idå’Œnameä¸¤ä¸ªåˆ—ï¼Œç°åœ¨è¦å°†nameåˆ—ä¿®æ”¹ä¸ºaddressåˆ— mysql> desc t1; +-------+----------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+----------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | | name | char(10) | YES | | NULL | | +-------+----------+------+-----+---------+-------+ 2 rows in set (0.10 sec) #ä¿®æ”¹nameåˆ— mysql> alter table t1 change name address varchar(30); Query OK, 0 rows affected (0.19 sec) Records: 0 Duplicates: 0 Warnings: 0 #æŸ¥çœ‹t1è¡¨ï¼ŒåŸnameåˆ—å·²ç»ä¿®æ”¹ä¸ºaddressï¼Œåˆ—ç±»å‹å·²ç”±charä¿®æ”¹ä¸ºvarchar mysql> desc t1; +---------+-------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +---------+-------------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | | address | varchar(30) | YES | | NULL | | +---------+-------------+------+-----+---------+-------+ 2 rows in set (0.17 sec) 6.3.4ä¿®æ”¹åˆ—çš„æ•°æ®ç±»å‹ alter table è¡¨å modify åˆ—å æ–°åˆ—æ•°æ®ç±»å‹; #t1è¡¨ä¸­æœ‰idåˆ—å’Œaddressåˆ—ï¼Œç°åœ¨è¦æŠŠaddressåˆ—çš„æ•°æ®ç±»å‹ç”±varcharæ”¹ä¸ºchar mysql> desc t1; +---------+-------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +---------+-------------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | | address | varchar(30) | YES | | NULL | | +---------+-------------+------+-----+---------+-------+ 2 rows in set (0.16 sec) #ä¿®æ”¹addressåˆ—æ•°æ®ç±»å‹ä¸ºchar mysql> alter table t1 modify address char(20); Query OK, 0 rows affected (0.22 sec) Records: 0 Duplicates: 0 Warnings: 0 #æŸ¥çœ‹t1è¡¨ï¼Œaddressåˆ—çš„æ•°æ®ç±»å‹å·²ç»ä¿®æ”¹ä¸ºchar mysql> desc t1; +---------+----------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +---------+----------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | | address | char(20) | YES | | NULL | | +---------+----------+------+-----+---------+-------+ 2 rows in set (0.19 sec) 6.3.5ä¿®æ”¹è¡¨å rename table æ—§è¡¨å to æ–°è¡¨å #æŸ¥çœ‹è¡¨ï¼Œç°åœ¨è¦å°†è¡¨t1ä¿®æ”¹ä¸ºtable1 mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | t1 | +---------------+ 1 row in set (0.14 sec) #ä¿®æ”¹è¡¨t1ä¸ºtable1 mysql> rename table t1 to table1; Query OK, 0 rows affected (0.16 sec) mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | table1 | +---------------+ 1 row in set (0.18 sec) 6.4æŸ¥çœ‹è¡¨ show tables #å…ˆè¿›å…¥ä¸€ä¸ªåº“ mysql> use db1; Database changed #æŸ¥çœ‹åº“ä¸­æ‰€æœ‰çš„è¡¨ mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | t1 | +---------------+ 1 row in set (0.18 sec) 7.æ•°æ®ç®¡ç† 7.1å¢åŠ æ•°æ® insert into è¡¨å values(......); æ–¹å¼ä¸€ ç›´æ¥æ’å…¥å€¼ #æŸ¥çœ‹è¡¨t1ï¼Œç°åœ¨æ˜¯ä¸€å¼ ç©ºè¡¨ mysql> desc t1; +---------+----------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +---------+----------+------+-----+---------+-------+ | id | int(3) | YES | | NULL | | | address | char(20) | YES | | NULL | | +---------+----------+------+-----+---------+-------+ 2 rows in set (0.17 sec) mysql> select * from t1; Empty set //å‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼Œæ’å…¥ä¸€æ¡ mysql> insert into t1 values(1,'åŒ—äº¬'); Query OK, 1 row affected (0.19 sec) //å‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼Œæ’å…¥å¤šæ¡ mysql> insert into t1 values(2,'ä¸Šæµ·'),(3,'å¹¿å·'),(4,'æ·±åœ³'); Query OK, 3 rows affected (0.15 sec) Records: 3 Duplicates: 0 Warnings: 0 //æŸ¥çœ‹t1è¡¨ä¸­çš„æ•°æ® mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 2 | ä¸Šæµ· | | 3 | å¹¿å· | | 4 | æ·±åœ³ | +----+---------+ 4 rows in set (0.16 sec) æ–¹å¼äºŒ ä»åˆ«çš„è¡¨ä¸­é€‰æ‹©æ•°æ®æ’å…¥ #åˆ›å»ºt1è¡¨ mysql> create table t1(id int primary key auto_increment,address char(10)); Query OK, 0 rows affected (0.02 sec) //å‘è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into t1(address) values('åŒ—äº¬'),('æ­å·'),('æ·±åœ³'); Query OK, 3 rows affected (0.00 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 2 | æ­å· | | 3 | æ·±åœ³ | +----+---------+ 3 rows in set (0.00 sec) #åˆ›å»ºt2è¡¨ mysql> create table t2(id int primary key auto_increment,address char(10)); Query OK, 0 rows affected (0.02 sec) //å°†t1è¡¨ä¸­çš„å†…å®¹æ’å…¥åˆ°t2è¡¨ä¸­ mysql> insert into t2(select * from t1); Query OK, 3 rows affected (0.01 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from t2; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 2 | æ­å· | | 3 | æ·±åœ³ | +----+---------+ 3 rows in set (0.00 sec) âš ï¸å¦‚æœä¸¤ä¸ªè¡¨ä¸­çš„å­—æ®µä¸ä¸€è‡´ï¼Œä»å¦ä¸€å¼ è¡¨ä¸­æ’å…¥æ•°æ®çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨æŒ‡å®šå­—æ®µ #åˆ›å»ºt3è¡¨ mysql> create table t3(id int primary key auto_increment,address char(10),qnum tinyint); Query OK, 0 rows affected (0.02 sec) //æ­¤æ—¶æƒ³æ’å…¥t1è¡¨çš„æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨æŒ‡å®šä¸€ä¸‹ä¸¤å¼ è¡¨ä¸­çš„å…±åŒå­—æ®µ mysql> insert into t3(id,address) (select * from t1); Query OK, 3 rows affected (0.01 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from t3; +----+---------+------+ | id | address | qnum | +----+---------+------+ | 1 | åŒ—äº¬ | NULL | | 2 | æ­å· | NULL | | 3 | æ·±åœ³ | NULL | +----+---------+------+ 3 rows in set (0.00 sec) 7.2åˆ é™¤æ•°æ® delete from è¡¨å where æ¡ä»¶; #æŸ¥çœ‹t1è¡¨ä¸­çš„æ•°æ® mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 2 | ä¸Šæµ· | | 3 | å¹¿å· | | 4 | æ·±åœ³ | +----+---------+ 4 rows in set (0.16 sec) //åˆ é™¤è¡¨ä¸­åœ°å€ä¸ºä¸Šæµ·çš„æ•°æ® mysql> delete from t1 where id=2; Query OK, 1 row affected (0.16 sec) //æŸ¥çœ‹t1è¡¨ä¸­å†…å®¹ mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 3 | å¹¿å· | | 4 | æ·±åœ³ | +----+---------+ 3 rows in set (0.16 sec) #å†æ¬¡æ–°å»ºt1è¡¨ ysql> create table t1(id int primary key auto_increment,address char(10)); Query OK, 0 rows affected (0.02 sec) //å‘t1è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into t1(address) values('åŒ—äº¬'),('ä¸Šæµ·'),('å¹¿å·'); Query OK, 3 rows affected (0.00 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 2 | ä¸Šæµ· | | 3 | å¹¿å· | +----+---------+ //deleteæ–¹å¼æ¸…ç©ºt1è¡¨ mysql> delete from t1; Query OK, 3 rows affected (0.00 sec) mysql> select * from t1; Empty set (0.00 sec) //å‘è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into t1(address) values('æ­å·'),('æ·±åœ³'); Query OK, 2 rows affected (0.00 sec) Records: 2 Duplicates: 0 Warnings: 0 //å‘ç°å¹¶æ²¡æœ‰æ¸…ç©ºè‡ªå¢å­—æ®µï¼Œå¦‚æœéœ€è¦æ¸…ç©ºè‡ªå¢å­—æ®µï¼Œéœ€è¦ç”¨åˆ°truncateè¯­å¥ mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 4 | æ­å· | | 5 | æ·±åœ³ | +----+---------+ 2 rows in set (0.00 sec) truncate table è¡¨å æ¸…ç©ºè¡¨å¹¶é‡ç½®è‡ªå¢å­—æ®µ #åˆ›å»ºä¸€ä¸ªt1è¡¨ mysql> create table t1(id int,address char(10)); Query OK, 0 rows affected (0.02 sec) mysql> insert into t1 values(1,'åŒ—äº¬'); Query OK, 1 row affected (0.00 sec) mysql> select * from t1; +------+---------+ | id | address | +------+---------+ | 1 | åŒ—äº¬ | +------+---------+ 1 row in set (0.00 sec) #truncateæ¸…ç©ºè¡¨ï¼Œä¸¤ç§å†™æ³•ï¼Œtruncateåè¾¹çš„tableå¯ä»¥ä¸åŠ  mysql> truncate t1; Query OK, 0 rows affected (0.01 sec) mysql> truncate table t1; Query OK, 0 rows affected (0.03 sec) //æŸ¥çœ‹è¡¨t1ï¼Œå·²ç»æ¸…ç©º mysql> select * from t1; Empty set (0.00 sec) #å†åˆ›å»ºä¸€ä¸ªt2è¡¨ï¼Œè¡¨ä¸­æœ‰è‡ªå¢å­—æ®µ mysql> create table t2(id int primary key auto_increment,address char(10)); Query OK, 0 rows affected (0.02 sec) //å‘è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into t2(address) values('æ­å·'),('æ·±åœ³'); Query OK, 2 rows affected (0.00 sec) Records: 2 Duplicates: 0 Warnings: 0 mysql> select * from t2; +----+---------+ | id | address | +----+---------+ | 1 | æ­å· | | 2 | æ·±åœ³ | +----+---------+ 2 rows in set (0.00 sec) //truncateæ¸…ç©ºè¡¨ mysql> truncate t2; Query OK, 0 rows affected (0.02 sec) //å‘è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into t2(address) values('æ­å·'),('æ·±åœ³'); Query OK, 2 rows affected (0.01 sec) Records: 2 Duplicates: 0 Warnings: 0 //truncateæ¸…ç©ºè¡¨çš„æ–¹å¼ä¼šå°†è¡¨ä¸­çš„è‡ªå¢å­—æ®µåŒæ—¶åˆ é™¤ï¼Œè€Œdelete from è¡¨åçš„æ–¹å¼ä¸å¯ä»¥åˆ é™¤è‡ªå¢ mysql> select * from t2; +----+---------+ | id | address | +----+---------+ | 1 | æ­å· | | 2 | æ·±åœ³ | +----+---------+ 2 rows in set (0.00 sec) 7.3ä¿®æ”¹æ•°æ® update è¡¨å set æ—§å€¼=æ–°å€¼ where æ¡ä»¶; #æŸ¥çœ‹è¡¨t1ï¼Œç°åœ¨è¦å°†è¡¨ä¸­çš„ä¸Šæµ·ä¿®æ”¹ä¸ºæ­å· mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 2 | ä¸Šæµ· | | 3 | å¹¿å· | | 4 | æ·±åœ³ | +----+---------+ 4 rows in set (0.12 sec) #ä¿®æ”¹è¡¨t1ä¸­åœ°å€ä¸ºä¸Šæµ·çš„åˆ—ä¸ºæ­å· mysql> update t1 set address='æ­å·' where id=2; Query OK, 1 row affected (0.18 sec) Rows matched: 1 Changed: 1 Warnings: 0 #æŸ¥çœ‹è¡¨t1ï¼Œä¸Šæµ·å·²ç»ä¿®æ”¹ä¸ºæ­å· mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 2 | æ­å· | | 3 | å¹¿å· | | 4 | æ·±åœ³ | +----+---------+ 4 rows in set (0.13 sec) 7.4æŸ¥è¯¢æ•°æ® select åˆ—å from è¡¨å where æ¡ä»¶ #æŸ¥è¯¢è¡¨ä¸­æ‰€æœ‰å†…å®¹ mysql> select * from t1; +----+---------+ | id | address | +----+---------+ | 1 | åŒ—äº¬ | | 2 | æ­å· | | 3 | å¹¿å· | | 4 | æ·±åœ³ | +----+---------+ 4 rows in set (0.14 sec) #æ ¹æ®æ¡ä»¶æŸ¥è¯¢ æŸ¥è¯¢t1è¡¨ä¸­id=1çš„addressåˆ— mysql> select address from t1 where id=1; +---------+ | address | +---------+ | åŒ—äº¬ | +---------+ 1 row in set (0.18 sec) 8.mysqlå¸¸ç”¨å‡½æ•° å¸¸ç”¨å‡½æ•° user() #æŸ¥çœ‹å½“å‰ç”¨æˆ· database() #æŸ¥çœ‹å½“å‰æ‰€å±åº“ version() #æŸ¥çœ‹MySQLç‰ˆæœ¬ now() #ç³»ç»Ÿæ—¶é—´ sum() #æ±‚å’Œ avg() #å¹³å‡å€¼ max() #æœ€å¤§å€¼ min() #æœ€å°å€¼ count() #ç»Ÿè®¡æ•°é‡ 8.1user() æŸ¥çœ‹å½“å‰ç”¨æˆ· mysql> select user(); +----------------+ | user() | +----------------+ | root@localhost | +----------------+ 1 row in set (0.00 sec) å½“å‰ç™»é™†ç”¨æˆ·æ˜¯rootï¼Œç™»é™†çš„ä¸»æœºæ˜¯æœ¬æœº 8.2database() æŸ¥çœ‹å½“å‰æ‰€åœ¨åº“ mysql> select database(); +------------+ | database() | +------------+ | db1 | +------------+ 1 row in set (0.12 sec) å½“å‰æ‰€åœ¨æ•°æ®åº“æ˜¯db1 8.3version() æŸ¥çœ‹mysqlç‰ˆæœ¬ mysql> select version(); +-----------+ | version() | +-----------+ | 5.7.22 | +-----------+ 1 row in set (0.11 sec) å½“å‰mysqlç‰ˆæœ¬æ˜¯5.7.22 8.4now() æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ—¶é—´ mysql> select now(); +---------------------+ | now() | +---------------------+ | 2018-10-25 21:10:18 | +---------------------+ 1 row in set (0.11 sec) å½“å‰ç³»ç»Ÿæ—¶é—´æ˜¯2018å¹´10æœˆ25æ—¥21æ—¶10åˆ†18ç§’ 8.5sum() æ±‚å’Œ #æŸ¥çœ‹studentè¡¨ mysql> select * from student; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 80 | | 3 | å°ä¸½ | 70 | | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | +------+--------+-------+ 5 rows in set (0.00 sec) #æ±‚å­¦ç”Ÿè¡¨ä¸­æ‰€æœ‰äººçš„æ€»æˆç»© mysql> select sum(score) as total_points from student; +--------------+ | total_points | +--------------+ | 374 | +--------------+ #æ±‚å­¦ç”Ÿè¡¨ä¸­æˆç»©å¤§äº70åˆ†çš„æ€»å’Œ mysql> select sum(score) as total_points from student where score>=70; +--------------+ | total_points | +--------------+ | 249 | +--------------+ 1 row in set (0.00 sec) 8.6avg() å¹³å‡å€¼ #æŸ¥çœ‹studentè¡¨ mysql> select * from student; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 80 | | 3 | å°ä¸½ | 70 | | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | +------+--------+-------+ 5 rows in set (0.00 sec) #æ±‚æ‰€æœ‰äººåˆ†æ•°çš„å¹³å‡å€¼ mysql> select avg(score) as avg_points from student; +------------+ | avg_points | +------------+ | 74.8 | +------------+ 1 row in set (0.00 sec) #æ±‚70åˆ†ä»¥ä¸Šçš„äººçš„åˆ†æ•°å¹³å‡å€¼ mysql> select avg(score) as avg_points from student where score>=70; +------------+ | avg_points | +------------+ | 83 | +------------+ 1 row in set (0.00 sec) 8.7max() æœ€å¤§å€¼ #æŸ¥çœ‹studentè¡¨ mysql> select * from student; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 80 | | 3 | å°ä¸½ | 70 | | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | +------+--------+-------+ 5 rows in set (0.00 sec) #æŸ¥è¯¢studentè¡¨ä¸­åˆ†æ•°æœ€é«˜çš„ mysql> select max(score) from student; +------------+ | max(score) | +------------+ | 99 | +------------+ 1 row in set (0.00 sec) 8.8min() æœ€å°å€¼ #æŸ¥çœ‹studentè¡¨ mysql> select * from student; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 80 | | 3 | å°ä¸½ | 70 | | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | +------+--------+-------+ 5 rows in set (0.00 sec) #ä¼ studentè¡¨ä¸­åˆ†æ•°æœ€ä½çš„ mysql> select min(score) from student; +------------+ | min(score) | +------------+ | 59 | +------------+ 1 row in set (0.00 sec) 8.9count() ç»Ÿè®¡æ•°é‡ #æŸ¥çœ‹studentè¡¨ mysql> select * from student; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 80 | | 3 | å°ä¸½ | 70 | | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | +------+--------+-------+ 5 rows in set (0.00 sec) #æŸ¥è¯¢studentè¡¨ä¸­åˆ†æ•°å¤§äº60çš„äººæ•° mysql> select count(*) from student where score>60; +----------+ | count(*) | +----------+ | 4 | +----------+ 1 row in set (0.00 sec) 9.mysqlæ•°æ®æŸ¥è¯¢æ“ä½œ 9.1æ•°å­¦è¿ç®— + åŠ æ³• mysql> select 1+1; +-----+ | 1+1 | +-----+ | 2 | +-----+ 1 row in set (0.00 sec) - å‡æ³• mysql> select 100-1; +-------+ | 100-1 | +-------+ | 99 | +-------+ 1 row in set (0.00 sec) * ä¹˜æ³• mysql> select 100*3; +-------+ | 100*3 | +-------+ | 300 | +-------+ 1 row in set (0.00 sec) / é™¤æ³• mysql> select 100/3; +---------+ | 100/3 | +---------+ | 33.3333 | +---------+ 1 row in set (0.00 sec) % å–ä½™ mysql> select 7%3; +------+ | 7%3 | +------+ | 1 | +------+ 1 row in set (0.00 sec) pow å¹‚è¿ç®— mysql> select pow(3,3); +----------+ | pow(3,3) | +----------+ | 27 | +----------+ 1 row in set (0.00 sec) âš ï¸mysqlä¸­ä¸æ”¯æŒ**æ–¹å¼çš„å¹‚è¿ç®—ï¼Œéœ€è¦ç”¨åˆ°powæ–¹æ³• 9.2æ¯”è¾ƒè¿ç®— > å¤§äº #è¿”å›å€¼ä¸º0è¡¨ç¤ºç»“æœä¸ºå‡ mysql> select 3>6; +-----+ | 3>6 | +-----+ | 0 | +-----+ 1 row in set (0.01 sec) #è¿”å›å€¼ä¸º1è¡¨ç¤ºç»“æœä¸ºçœŸ mysql> select 6>3; +-----+ | 6>3 | +-----+ | 1 | +-----+ 1 row in set (0.00 sec) #è¿”å›å€¼ä¸º1è¡¨ç¤ºç»“æœä¸ºçœŸ mysql> select 6>3; +-----+ | 6>3 | +-----+ | 1 | +-----+ 1 row in set (0.00 sec) #è¿”å›å€¼ä¸º0è¡¨ç¤ºç»“æœä¸ºå‡ mysql> select 6 >= å¤§äºç­‰äº #è¿”å›å€¼ä¸º0è¡¨ç¤ºç»“æœä¸ºå‡ mysql> select 6 select 6>=3; +------+ | 6>=3 | +------+ | 1 | +------+ 1 row in set (0.00 sec) #è¿”å›å€¼ä¸º1è¡¨ç¤ºç»“æœä¸ºçœŸ mysql> select 6 select 6 = ç­‰äº #è¿”å›å€¼ä¸º1è¡¨ç¤ºç»“æœä¸ºçœŸ mysql> select 5=5; +-----+ | 5=5 | +-----+ | 1 | +-----+ 1 row in set (0.00 sec) #è¿”å›å€¼ä¸º0è¡¨ç¤ºç»“æœä¸ºå‡ mysql> select 5=6; +-----+ | 5=6 | +-----+ | 0 | +-----+ 1 row in set (0.00 sec) != ä¸ç­‰äº #è¿”å›å€¼ä¸º1è¡¨ç¤ºç»“æœä¸ºçœŸ mysql> select 3!=2; +------+ | 3!=2 | +------+ | 1 | +------+ 1 row in set (0.01 sec) #è¿”å›å€¼ä¸º0è¡¨ç¤ºç»“æœä¸ºå‡ mysql> select 3!=3; +------+ | 3!=3 | +------+ | 0 | +------+ 1 row in set (0.00 sec) 9.3é€»è¾‘è¿ç®— && ä¸ #è¿”å›å€¼ä¸º1è¡¨ç¤ºç»“æœä¸ºçœŸ mysql> select 3>1 && 5>1; +------------+ | 3>1 && 5>1 | +------------+ | 1 | +------------+ 1 row in set (0.00 sec) #è¿”å›å€¼ä¸º0è¡¨ç¤ºç»“æœä¸ºå‡ mysql> select 3>1 && 51 && 5 || æˆ– #è¿”å›å€¼ä¸º1è¡¨ç¤ºç»“æœä¸ºçœŸ æˆ–å…³ç³»ä¸­æœ‰ä¸€ä¸ªä¸ºçœŸç»“æœå°±ä¸ºçœŸ mysql> select 3>1 || 51 || 5 select 3 not é #æ­¤å†™æ³•ä¸æ­£ç¡® mysql> select 3>6 not 3>5; ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '3>5' at line 1 #è¿”å›å€¼ä¸º1è¡¨ç¤ºç»“æœä¸ºçœŸ mysql> select not 3>5; +---------+ | not 3>5 | +---------+ | 1 | +---------+ 1 row in set (0.00 sec) #è¿”å›å€¼ä¸º0è¡¨ç¤ºç»“æœä¸ºå‡ mysql> select not 5>3; +---------+ | not 5>3 | +---------+ | 0 | +---------+ 1 row in set (0.00 sec) 9.4æ’åº order by order by åˆ—å #é»˜è®¤å‡åº order by åˆ—å desc #é™åº #studentè¡¨å†…å®¹å¦‚ä¸‹ mysql> select * from student; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 79 | | 3 | å°ä¸½ | 88 | | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | +------+--------+-------+ 5 rows in set (0.00 sec) #æŒ‰ç…§æˆç»©å‡åºæ’åº mysql> select * from student order by score; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | | 2 | å°çº¢ | 79 | | 3 | å°ä¸½ | 88 | | 1 | å°æ˜ | 99 | +------+--------+-------+ 5 rows in set (0.00 sec) #æŒ‰ç…§æˆç»©é™åºæ’åº mysql> select * from student order by score desc; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 3 | å°ä¸½ | 88 | | 2 | å°çº¢ | 79 | | 5 | å°æ´² | 66 | | 4 | å°å¼º | 59 | +------+--------+-------+ 5 rows in set (0.00 sec) 9.5é™åˆ¶ limit limitç”¨äºé™åˆ¶æŸ¥è¯¢ç»“æœçš„æ¡æ•° #studentè¡¨å†…å®¹å¦‚ä¸‹ mysql> select * from student; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 79 | | 3 | å°ä¸½ | 88 | | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | +------+--------+-------+ 5 rows in set (0.00 sec) #é™åˆ¶æŸ¥è¯¢ç»“æœæ˜¾ç¤º3æ¡ mysql> select * from student limit 3; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 79 | | 3 | å°ä¸½ | 88 | +------+--------+-------+ 3 rows in set (0.00 sec) 9.6åˆ†ç»„ group by 9.6.1group byç®€å•ä½¿ç”¨ç¤ºä¾‹ #t1è¡¨å†…å®¹å¦‚ä¸‹ mysql> select * from t1; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99.9 | | 2 | å°æ˜ | 60.6 | | 3 | å°çº¢ | 70 | | 4 | å°æ´² | 88.5 | | 5 | å°æ˜ | 77.5 | | 6 | å°æ´² | 59 | +------+--------+-------+ 6 rows in set (0.00 sec) #æ ¹æ®å§“ååˆ†ç»„ï¼Œgroup byä¼šå°†åˆ—ä¸­å€¼ç›¸åŒçš„è¡Œåˆå¹¶ mysql> select name from t1 group by name; +--------+ | name | +--------+ | å°æ˜ | | å°æ´² | | å°çº¢ | +--------+ 3 rows in set (0.00 sec) #æ¥ä¸ªé”™è¯¯ç¤ºä¾‹ mysql> select * from t1 group by name; ERROR 1055 (42000): Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'db1.t1.id' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by é”™è¯¯åŸå› ï¼š group byè¯­å¥ä¼šå°†åˆ—ä¸­å€¼ç›¸åŒçš„è¡Œåˆå¹¶ï¼Œä¾‹å¦‚ä¸Šè¾¹çš„t1è¡¨ä¸­ï¼Œæœ‰å¤šä¸ªåå­—ç›¸åŒçš„äººå°æ˜ï¼Œgroup byå·²ç»å°†å¤šä¸ªå°æ˜çš„å€¼åˆå¹¶ä¸ºä¸€ä¸ªï¼Œä½†æ˜¯å°æ˜æ˜¯å§“åç›¸åŒçš„ä¸åŒçš„äººï¼Œæˆç»©ä¹Ÿä¸åŒï¼Œå› æ­¤æŸ¥è¯¢çš„æ—¶å€™ä¼šæŠ¥é”™ 9.6.2group by+having åˆ†ç»„åå†è¿‡æ»¤ #åˆ›å»ºscoreè¡¨ mysql> create table score(sname char(10), cname char(10), grade int); Query OK, 0 rows affected (0.03 sec) //å‘è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into score(sname,cname,grade) values ('å¼ ä¸‰','æ•°å­¦',80), ('å¼ ä¸‰','è¯­æ–‡',90), ('å¼ ä¸‰','è‹±è¯­',70), ('å¼ ä¸‰','ç‰©ç†',60), ('æå››','æ•°å­¦',66), ('æå››','è¯­æ–‡',60), ('æå››','è‹±è¯­',80), ('æå››','ç‰©ç†',90), ('åˆ˜äº”','è¯­æ–‡',99), ('åˆ˜äº”','æ•°å­¦',50), ('åˆ˜äº”','è‹±è¯­',50), ('åˆ˜äº”','ç‰©ç†',89), ('ç½—å…­','è¯­æ–‡',99), ('ç½—å…­','æ•°å­¦',80), ('ç½—å…­','ç‰©ç†',78), ('ç½—å…­','è‹±è¯­',96), ('è®¸ä¸ƒ','æ•°å­¦',96), ('è®¸ä¸ƒ','è¯­æ–‡',96), ('è®¸ä¸ƒ','è‹±è¯­',96), ('è®¸ä¸ƒ','ç‰©ç†',96); Query OK, 20 rows affected (0.03 sec) Records: 20 Duplicates: 0 Warnings: 0 //æŸ¥è¯¢å¹³å‡æˆç»©å¤§äº90åˆ†å¹¶ä¸”è¯­æ–‡è¯¾95åˆ†ä»¥ä¸Šçš„å­¦ç”Ÿåå’Œå¹³å‡æˆç»© mysql> select sname,avg(grade) from score where sname in (select sname from score where cname='è¯­æ–‡' and grade > 95) group by sname; +--------+------------+ | sname | avg(grade) | +--------+------------+ | åˆ˜äº” | 72.0000 | | ç½—å…­ | 88.2500 | | è®¸ä¸ƒ | 96.0000 | +--------+------------+ 3 rows in set (0.00 sec) mysql> select sname,avg(grade) from score where sname in (select sname from score where cname='è¯­æ–‡' and grade > 95) group by sname having avg(grade) > 90; +--------+------------+ | sname | avg(grade) | +--------+------------+ | è®¸ä¸ƒ | 96.0000 | +--------+------------+ 1 row in set (0.00 sec) 9.6.3group by+group_concatå‡½æ•°ä½¿ç”¨ç¤ºä¾‹ #åˆ›å»ºbookè¡¨ mysql> create table book(ä¹¦å char(20) not null, ä½œè€… char(10) not null, å‡ºç‰ˆç¤¾ char(20) not null, ä»·æ ¼ int unsigned, å‡ºç‰ˆæ—¥æœŸ date); Query OK, 0 rows affected (0.02 sec) #å‘bookè¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into book values( 'é‚£ä¸ªå¥³å­©','å°æ˜','å·¥ä¸šå‡ºç‰ˆç¤¾',80,'2016-07-01'), ('é˜¿ä¸‰ä¼ è¯´','å°æ´²','äººæ°‘å‡ºç‰ˆç¤¾',10,'2019-09-09'), ('å¥”è·‘çš„è‰æ³¥é©¬','å°æ˜','ç›—ç‰ˆå‡ºç‰ˆç¤¾',60,'2017-07-12'), ('ä¸Šè¯¾å¿…å¤‡ä¸‰ä»¶å¥—','å°é¢–','äººæ°‘å‡ºç‰ˆç¤¾',250,'2018-11-11'), ('ç«¥è¯æ•…äº‹','','å·¥ä¸šå‡ºç‰ˆç¤¾',50,'2019-09-01'); Query OK, 5 rows affected (0.01 sec) Records: 5 Duplicates: 0 Warnings: 0 mysql> select * from book; +-----------------------+--------+-----------------+--------+--------------+ | ä¹¦å | ä½œè€… | å‡ºç‰ˆç¤¾ | ä»·æ ¼ | å‡ºç‰ˆæ—¥æœŸ | +-----------------------+--------+-----------------+--------+--------------+ | é‚£ä¸ªå¥³å­© | å°æ˜ | å·¥ä¸šå‡ºç‰ˆç¤¾ | 80 | 2016-07-01 | | é˜¿ä¸‰ä¼ è¯´ | å°æ´² | äººæ°‘å‡ºç‰ˆç¤¾ | 10 | 2019-09-09 | | å¥”è·‘çš„è‰æ³¥é©¬ | å°æ˜ | ç›—ç‰ˆå‡ºç‰ˆç¤¾ | 60 | 2017-07-12 | | ä¸Šè¯¾å¿…å¤‡ä¸‰ä»¶å¥— | å°é¢– | äººæ°‘å‡ºç‰ˆç¤¾ | 250 | 2018-11-11 | | ç«¥è¯æ•…äº‹ | | å·¥ä¸šå‡ºç‰ˆç¤¾ | 50 | 2019-09-01 | +-----------------------+--------+-----------------+--------+--------------+ 5 rows in set (0.00 sec) //æŸ¥è¯¢å„å‡ºç‰ˆç¤¾å‡ºç‰ˆçš„æ‰€æœ‰å›¾ä¹¦ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°group_concat()å‡½æ•° mysql> select å‡ºç‰ˆç¤¾,group_concat(ä¹¦å) from book group by å‡ºç‰ˆç¤¾; +-----------------+------------------------------------+ | å‡ºç‰ˆç¤¾ | group_concat(ä¹¦å) | +-----------------+------------------------------------+ | äººæ°‘å‡ºç‰ˆç¤¾ | é˜¿ä¸‰ä¼ è¯´,ä¸Šè¯¾å¿…å¤‡ä¸‰ä»¶å¥— | | å·¥ä¸šå‡ºç‰ˆç¤¾ | é‚£ä¸ªå¥³å­©,ç«¥è¯æ•…äº‹ | | ç›—ç‰ˆå‡ºç‰ˆç¤¾ | å¥”è·‘çš„è‰æ³¥é©¬ | +-----------------+------------------------------------+ 3 rows in set (0.00 sec) 9.7æ£€ç´¢åŒºé—´ between...and... #studentè¡¨å†…å®¹å¦‚ä¸‹ mysql> select * from student; +------+--------+-------+ | id | name | score | +------+--------+-------+ | 1 | å°æ˜ | 99 | | 2 | å°çº¢ | 79 | | 3 | å°ä¸½ | 88 | | 4 | å°å¼º | 59 | | 5 | å°æ´² | 66 | +------+--------+-------+ 5 rows in set (0.00 sec) #æŸ¥è¯¢æˆç»©åœ¨60åˆ†åˆ°90åˆ†ä¹‹é—´çš„å­¦ç”Ÿå§“å mysql> select name,score from student where score between 60 and 90; +--------+-------+ | name | score | +--------+-------+ | å°çº¢ | 79 | | å°ä¸½ | 88 | | å°æ´² | 66 | +--------+-------+ 3 rows in set (0.00 sec) 9.8åˆ¤æ–­æ˜¯å¦åœ¨èŒƒå›´ in not in #in åœ¨ä¸€ä¸ªèŒƒå›´å†… //æŸ¥çœ‹t1è¡¨ mysql> select * from t1; +------+---------+------+ | id | name | age | +------+---------+------+ | 1 | å°æ˜ | 20 | | 2 | å¤§Bå“¥ | 30 | | 3 | å°Bå“¥ | 25 | | 4 | é¾™å“¥ | 38 | | 5 | å°é¢– | 18 | | 6 | å°æ´² | 19 | +------+---------+------+ 6 rows in set (0.00 sec) //æŸ¥è¯¢å¹´é¾„æ˜¯18ã€20ã€30å²ä¹‹é—´çš„äººçš„ä¿¡æ¯ mysql> select * from t1 where age in(18,19,30); +------+---------+------+ | id | name | age | +------+---------+------+ | 2 | å¤§Bå“¥ | 30 | | 5 | å°é¢– | 18 | | 6 | å°æ´² | 19 | +------+---------+------+ 3 rows in set (0.00 sec) #not in ä¸åœ¨ä¸€ä¸ªèŒƒå›´å†… //æŸ¥è¯¢å¹´é¾„ä¸åœ¨18ã€20ã€30å²ä¹‹é—´çš„äººçš„ä¿¡æ¯ mysql> select * from t1 where age not in(18,19,30); +------+---------+------+ | id | name | age | +------+---------+------+ | 1 | å°æ˜ | 20 | | 3 | å°Bå“¥ | 25 | | 4 | é¾™å“¥ | 38 | +------+---------+------+ 3 rows in set (0.00 sec) 10.mysqlçš„APIåŠæ¥å£è‡ªå¸¦å‘½ä»¤ APIï¼šåº”ç”¨ç¨‹åºæ¥å£ 10.1mysql API mysql APIå°±æ˜¯èƒ½å¤Ÿä¸è¿›å…¥mysqlè€Œåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œsqlè¯­å¥ï¼Œåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨-eé€‰é¡¹ mysqlAPIç¤ºä¾‹1ï¼Œåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨SQLè¯­å¥ [root@mysql ~]# mysql -uroot -p123 mysql -e \"show databases;\" +--------------------+ | Database | +--------------------+ | information_schema | | DB1 | | mysql | | performance_schema | | test | +--------------------+ mysqlAPIç¤ºä¾‹2ï¼Œphpè¿æ¥mysql 10.2mysqlæ¥å£è‡ªå¸¦å‘½ä»¤ ä»¥ä¸‹å‘½ä»¤åœ¨mysqlä¸­æˆ–è€…å‘½ä»¤è¡Œæ‰§è¡Œéƒ½å¯ä»¥ help æˆ–ï¼Ÿ #æŸ¥çœ‹å¸®åŠ© \\G #æ ¼å¼åŒ–æŸ¥çœ‹æ•°æ®ï¼ˆkeyï¼švalueï¼‰ \\T æˆ– tee #è®°å½•æ—¥å¿— \\cï¼ˆ5.7å¯ä»¥ctrl+cï¼‰ #ç»“æŸå‘½ä»¤ \\s æˆ– status #æŸ¥çœ‹çŠ¶æ€ä¿¡æ¯ \\. æˆ– source #å¯¼å…¥SQLæ•°æ® \\uæˆ– use #ä½¿ç”¨æ•°æ®åº“ \\q æˆ– exit æˆ– quit #é€€å‡º æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/2.mysqlä¸‹è½½.html":{"url":"db/mysql/mysqlåŸºç¡€/2.mysqlä¸‹è½½.html","title":"2.mysqlä¸‹è½½æ•™ç¨‹","keywords":"","body":"mysqlå®˜ç½‘å¯èƒ½ä¼šåº”ä¸ºæ›´æ–°è€Œå¯¼è‡´ä¸‹è½½ç•Œé¢è·Ÿæœ¬æ–‡ä¸ä¸€è‡´ï¼Œè¯·ä»¥å®˜ç½‘ä¸ºå‡† 1.ç™»é™†mysqlå®˜ç½‘www.mysql.com,ç„¶åç‚¹å‡»DOWNLOADS 2.ç‚¹å‡»[MySQL Community (GPL) Downloads Â»ï¼ˆç¤¾åŒºç‰ˆï¼‰ 3.ç‚¹å‡»MySQL Community Serverï¼ˆMySQLç¤¾åŒºæœåŠ¡å™¨ï¼‰ 4.é€‰æ‹©Looking for previous GA versionsï¼ˆå­˜æ¡£ç‰ˆæœ¬ï¼‰ï¼Œè¿™é¡¹ä¸ºé€‰æ‹©æ—§ç‰ˆæœ¬mysql 5.é€‰æ‹©ç›¸åº”çš„mysqlç‰ˆæœ¬ï¼Œé€‰æ‹©Linux-Genercï¼ˆé€šç”¨linxu ç‹¬ç«‹æ¶æ„ï¼‰è¿™ä¸ªç•Œé¢åªèƒ½ä¸‹è½½å½“å‰ç‰ˆæœ¬çš„æœ€åä¸€ä¸ªå°ç‰ˆæœ¬ âš ï¸è¿™é‡Œä¸‹è½½çš„æ˜¯mysqläºŒè¿›åˆ¶åŒ… 6.ä¸‹è½½æŒ‡å®šçš„ç‰ˆæœ¬ ç‚¹å‡»Archived versions Â»(å­˜æ¡£ç‰ˆæœ¬) é€‰æ‹©ç¤¾åŒºç‰ˆ é€‰æ‹©è‡ªå·±æƒ³è¦ä¸‹è½½çš„ç‰ˆæœ¬ã€åŒ…ç±»å‹(æºç ã€äºŒè¿›åˆ¶ã€rpmç­‰)ã€å®‰è£…å¹³å° æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/3.CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-5.6.40.html":{"url":"db/mysql/mysqlåŸºç¡€/3.CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-5.6.40.html","title":"MySQL-5.6.40","keywords":"","body":"CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-5.6.40 mysql-5.6.40äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ 10f61e60f8c42b6635e5c1f423bce8be https://cdn.mysql.com/archives/mysql-5.6/mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz mysql-5.6.41äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ b0ac6851908b5c17b6a283d10709fcfd https://cdn.mysql.com/archives/mysql-5.6/mysql-5.6.41-linux-glibc2.12-x86_64.tar.gz mysql-5.6.42äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ fc8c6df660ba42b280c3b1d59bd8ee27 https://cdn.mysql.com/archives/mysql-5.6/mysql-5.6.42-linux-glibc2.12-x86_64.tar.gz 1.ä¸‹è½½MySQL-5.6.40äºŒè¿›åˆ¶åŒ… wget https://cdn.mysql.com/archives/mysql-5.6/mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz 2.è§£å‹ç¼©mysqläºŒè¿›åˆ¶åŒ…åˆ°/usr/local tar xf mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz -C /usr/local 3.ä¿®æ”¹åç§°ã€åšè½¯è¿æ¥ mv /usr/local/mysql-5.6.40-linux-glibc2.12-x86_64 /usr/local/mysql-5.6.40 ln -s /usr/local/mysql-5.6.40 /usr/local/mysql 4.åˆ›å»ºmysqlç”¨æˆ· #åˆ›å»ºmysqlç”¨æˆ· useradd mysql -s /bin/nologin -M 5.æ‹·è´ä¸»é…ç½®æ–‡ä»¶ #å¤‡ä»½/etc/my.cnf mv /etc/my.cnf /etc/my.cnf.old #æ‹·è´ä¸»é…ç½®æ–‡ä»¶ cp /usr/local/mysql/support-files/my-default.cnf /etc/my.cnf 6.æ‹·è´å¯åŠ¨è„šæœ¬ cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld 7.ç›¸å…³ç›®å½•ã€æ–‡ä»¶æˆæƒ chown -R mysql.mysql /usr/local/mysql* chown mysql.mysql /etc/my.cnf 8.åˆå§‹åŒ–mysql #åˆå§‹åŒ–å‰å®‰è£…ä¾èµ–åŒ… yum -y install autoconf #åˆå§‹åŒ–mysql cd /usr/local/mysql/scripts && ./mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --user #æŒ‡å®šmysqlç”¨æˆ· --basedir #æŒ‡å®šmysqlå®‰è£…ç›®å½• --datadir #æŒ‡å®šmysqlæ•°æ®ç›®å½• 9.æ·»åŠ mysqlå‘½ä»¤ç¯å¢ƒå˜é‡ #å¯¼å‡ºmysqlå‘½ä»¤ç¯å¢ƒå˜é‡ echo \"export PATH=/usr/local/mysql/bin:$PATH\" > /etc/profile.d/mysql.sh #ä½¿é…ç½®ç”Ÿæ•ˆ source /etc/profile 10.é…ç½®systemdç®¡ç†mysql cat > /etc/systemd/system/mysqld.service 11.å¯åŠ¨mysqlã€æ£€æŸ¥å¯åŠ¨ #é‡æ–°åŠ è½½systemdç³»ç»ŸæœåŠ¡ systemctl daemon-reload #å¯åŠ¨mysql systemctl start mysqld && systemctl enable mysqld #æŸ¥çœ‹mysqlç«¯å£ $ netstat -ntpl | grep 3306 tcp6 0 0 :::3306 :::* LISTEN 31349/mysqld 12.è¿›å…¥mysqlå¹¶è®¾ç½®å¯†ç  #è¿›å…¥mysql mysql #è®¾ç½®mysqlå¯†ç  mysql> set password='123'; Query OK, 0 rows affected (0.00 sec) mysql> flush privileges; Query OK, 0 rows affected (0.01 sec) åˆ°æ­¤ï¼Œmysql5.6.40äºŒè¿›åˆ¶å®‰è£…å®Œæˆï¼ï¼ï¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/4.CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-5.7.22.html":{"url":"db/mysql/mysqlåŸºç¡€/4.CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-5.7.22.html","title":"MySQL-5.7.22","keywords":"","body":"CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-5.7.22 mysql-5.7.22äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ 9ef7a05695f8b4ea29f8d077c3b415e2 https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz mysql-5.7.23äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ d903d3dbf235b74059a4b3e216c71161 https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.23-linux-glibc2.12-x86_64.tar.gz mysql-5.7.24äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ 9ef7a05695f8b4ea29f8d077c3b415e2 https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz âš ï¸âš ï¸âš ï¸ äºŒè¿›åˆ¶å®‰è£…mysqlçš„å¯åŠ¨è„šæœ¬å’Œ å®‰è£…ç›®å½•/mysql/bin/mysqld_safe è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­éƒ½æ˜¯é»˜è®¤/usr/local/mysqlï¼Œå¦‚æœå®‰è£…ç›®å½•ä¸åœ¨/usr/local/ä¸‹ï¼Œéœ€è¦ä¿®æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„è·¯å¾„ï¼Œå³æŠŠ/usr/localæ›¿æ¢ä¸ºmysqlå®‰è£…ç›®å½• sed -i 's#/usr/local#/application#g' /etc/init.d/mysql /application/mysql/bin/mysqld_safe 1.ä¸‹è½½MySQL-5.7.22äºŒè¿›åˆ¶åŒ… wget https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz 2.è§£å‹ç¼©mysqläºŒè¿›åˆ¶åŒ…åˆ°/usr/local tar xf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C /usr/local 3.ä¿®æ”¹åç§°ã€åšè½¯è¿æ¥ mv /usr/local/mysql-5.7.22-linux-glibc2.12-x86_64 /usr/local/mysql-5.7.22 && ln -s /usr/local/mysql-5.7.22 /usr/local/mysql 4.åˆ›å»ºmysqlç”¨æˆ· useradd -M -s /bin/nologin mysql 5.ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶ï¼Œmyql-5.7.22äºŒè¿›åˆ¶åŒ…é»˜è®¤æ²¡æœ‰mysqlé…ç½®æ–‡ä»¶ âš ï¸å¦‚æœæŒ‡å®šäº†mysqlçš„socketæ–‡ä»¶ä½ç½®ï¼Œåˆ™å¿…é¡»æ·»åŠ [client]æ ‡ç­¾å¹¶åŒæ—¶æŒ‡å®šsocketæ–‡ä»¶ä½ç½®ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šä»/tmpä¸‹æ‰¾socketæ–‡ä»¶ #å¤‡ä»½/etc/my.cnf mv /etc/my.cnf /etc/my.cnf.old #ä»¥ä¸‹é…ç½®ä¸ºæœ€ç²¾ç®€ç‰ˆï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œç›¸åº”è®¾ç½® cat >> /etc/my.cnf 6.åˆ›å»ºsocketæ–‡ä»¶ç›®å½• mkdir -p /var/lib/mysql 7.ç›¸å…³ç›®å½•ã€æ–‡ä»¶æˆæƒ chown -R mysql.mysql /usr/local/mysql* /var/lib/mysql chown mysql.mysql /etc/my.cnf 8.æ‹·è´å¯åŠ¨è„šæœ¬ cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld 9.åˆå§‹åŒ–mysql /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --user #æŒ‡å®šmysqlç”¨æˆ· --basedir #æŒ‡å®šmysqlå®‰è£…ç›®å½• --datadir #æŒ‡å®šmysqlæ•°æ®ç›®å½• --initialize-insecure #ä¸ç”Ÿæˆéšæœºå¯†ç  âš ï¸âš ï¸âš ï¸mysql-5.7.22åˆå§‹åŒ–æ²¡æœ‰æç¤ºï¼ï¼ï¼ 10.æ·»åŠ mysqlå‘½ä»¤ç¯å¢ƒå˜é‡ #å¯¼å‡ºmysqlå‘½ä»¤ç¯å¢ƒå˜é‡ echo \"export PATH=/usr/local/mysql/bin:$PATH\" > /etc/profile.d/mysql.sh #ä½¿é…ç½®ç”Ÿæ•ˆ source /etc/profile 11.é…ç½®systemdç®¡ç†mysql cat >> /etc/systemd/system/mysqld.service 12.å¯åŠ¨mysqlã€æ£€æŸ¥å¯åŠ¨ #é‡æ–°åŠ è½½systemdç³»ç»ŸæœåŠ¡ systemctl daemon-reload #å¯åŠ¨mysqlå¹¶åŠ å…¥å¼€æœºè‡ªå¯ systemctl start mysqld && systemctl enable mysqld #æŸ¥çœ‹mysqlç«¯å£ $ netstat -ntpl | grep 3306 tcp6 0 0 :::3306 :::* LISTEN 31349/mysqld 13.è¿›å…¥mysqlå¹¶è®¾ç½®å¯†ç  #è¿›å…¥mysql mysql #è®¾ç½®mysqlå¯†ç  mysql> set password='123'; Query OK, 0 rows affected (0.00 sec) mysql> flush privileges; Query OK, 0 rows affected (0.01 sec) åˆ°æ­¤ï¼Œmysql5.7.22äºŒè¿›åˆ¶å®‰è£…å®Œæˆï¼ï¼ï¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/5.CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-8.0.12.html":{"url":"db/mysql/mysqlåŸºç¡€/5.CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-8.0.12.html","title":"MySQL-8.0.12","keywords":"","body":"CentOS7.5äºŒè¿›åˆ¶å®‰è£…MySQL-8.0.12 mysql-8.0.12äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ 58bcd8af8b9d966140430ae4c846df73 https://cdn.mysql.com/archives/mysql-8.0/mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz mysql-8.0.13äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ ea0b14eaf516784aa0f8af6015ccdbf2 https://cdn.mysql.com/archives/mysql-8.0/mysql-8.0.13-linux-glibc2.12-x86_64.tar.xz mysql-8.0.14äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ MD5å€¼ b9a04efa353f4b16d5c034a4e6e73cc8 https://cdn.mysql.com/archives/mysql-8.0/mysql-8.0.14-linux-glibc2.12-x86_64.tar.xz 1.å®‰è£…ä¾èµ–åŒ… yum -y install -y gcc gcc-c++ autoconf bison-devel ncurses-devel libaio-devel numactl 2.åˆ›å»ºmysqlç”¨æˆ· useradd -M -s /sbin/nologin mysql 3.ä¸‹è½½mysql-8.0.12äºŒè¿›åˆ¶åŒ… wget https://downloads.mysql.com/archives/get/file/mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz 4.è§£å‹ç¼©mysqläºŒè¿›åˆ¶åŒ…åˆ°/usr/local tar xf mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz -C /usr/local/ 5.ä¿®æ”¹ç›®å½•åç§°ã€ä¿®æ”¹mysqlç›®å½•æ‰€æœ‰è€…ã€åšè½¯è¿æ¥ mv mysql-8.0.12-linux-glibc2.12-x86_64 /usr/local/mysql-8.0.12 ln -s /usr/local/mysql-8.0.12/ /usr/local/mysql 6.ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶ï¼Œmysql-8.0.12é»˜è®¤æ²¡æœ‰ä¸»é…ç½®æ–‡ä»¶ âš ï¸å¦‚æœæŒ‡å®šäº†mysqlçš„socketæ–‡ä»¶ä½ç½®ï¼Œåˆ™å¿…é¡»æ·»åŠ [client]æ ‡ç­¾å¹¶åŒæ—¶æŒ‡å®šsocketæ–‡ä»¶ä½ç½®ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šä»/tmpä¸‹æ‰¾socketæ–‡ä»¶ #å¤‡ä»½åŸæœ‰/etc/my.cnf mv /etc/my.cnf /etc/my.cnf.old #ä»¥ä¸‹ä¸ºç²¾ç®€ç‰ˆä¸»é…ç½®æ–‡ä»¶ï¼Œåç»­æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ cat >> /etc/my.cnf 6.åˆ›å»ºsocketæ–‡ä»¶ç›®å½• mkdir -p /var/lib/mysql 7.ç›¸å…³ç›®å½•ã€æ–‡ä»¶æˆæƒ chown -R mysql.mysql /usr/local/mysql* /var/lib/mysql chown mysql.mysql /etc/my.cnf 8.æ‹·è´å¯åŠ¨è„šæœ¬ cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld 9.åˆå§‹åŒ–mysql /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data mysql8.0.12åˆå§‹åŒ–æ²¡æœ‰æç¤ºï¼ï¼ï¼ --initialize --user #æŒ‡å®šmysqlç”¨æˆ· --basedir #æŒ‡å®šmysqlå®‰è£…ç›®å½• --datadir #æŒ‡å®šmysqlæ•°æ®ç›®å½• --initialize-insecure #ä¸ç”Ÿæˆéšæœºå¯†ç  10.æ·»åŠ mysqlå‘½ä»¤ç¯å¢ƒå˜é‡ #å¯¼å‡ºmysqlå‘½ä»¤ç¯å¢ƒå˜é‡ echo \"export PATH=/usr/local/mysql/bin:$PATH\" > /etc/profile.d/mysql.sh #ä½¿é…ç½®ç”Ÿæ•ˆ source /etc/profile 11.é…ç½®systemdç®¡ç†mysql cat > /etc/systemd/system/mysqld.service 12.å¯åŠ¨mysqlã€æ£€æŸ¥å¯åŠ¨ #é‡æ–°åŠ è½½systemdç³»ç»ŸæœåŠ¡ systemctl daemon-reload #å¯åŠ¨mysqlå¹¶åŠ å…¥å¼€æœºè‡ªå¯ systemctl start mysqld && systemctl enable mysqld #æŸ¥çœ‹mysqlç«¯å£ $ netstat -ntpl | grep 3306 tcp6 0 0 :::3306 :::* LISTEN 31349/mysqld 13.è¿æ¥mysqlå¹¶è®¾ç½®å¯†ç  #è¿›å…¥mysql mysql #è®¾ç½®mysqlå¯†ç  mysql> set password='123'; Query OK, 0 rows affected (0.00 sec) mysql> flush privileges; Query OK, 0 rows affected (0.01 sec) åˆ°æ­¤ï¼Œmysql8.0.12äºŒè¿›åˆ¶å®‰è£…å®Œæˆï¼ï¼ï¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/6.CentOS7.5ç¼–è¯‘å®‰è£…MySQL-5.6.40.html":{"url":"db/mysql/mysqlåŸºç¡€/6.CentOS7.5ç¼–è¯‘å®‰è£…MySQL-5.6.40.html","title":"MySQL-5.6.40","keywords":"","body":"CentOS7.5ç¼–è¯‘å®‰è£…MySQL-5.6.40 1.å®‰è£…ä¾èµ–åŒ… [root@db01 ~]# yum install -y gcc gcc-c++ automake autoconf cmake bison-devel ncurses-devel libaio-devel 2.ä¸‹è½½MySQL-5.6.40.tar.gz [root@db01 ~]# wget https://downloads.mysql.com/archives/get/file/mysql-5.6.40.tar.gz 3.è§£å‹ç¼© [root@db01 ~]# tar xf mysql-5.6.40.tar.gz 4.è¿›å…¥è§£å‹ç¼©ç›®å½•ï¼Œè¿›è¡Œç¼–è¯‘å®‰è£… //è¿›å…¥åˆ°è§£å‹ç›®å½• [root@db01 ~]# cd mysql-5.6.40 //è¿›è¡Œcmake [root@db01 mysql-5.6.40]# cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/mysql-5.6.40 \\ > -DDEFAULT_CHARSET=utf8 \\ > -DDEFAULT_COLLATION=utf8_general_ci \\ > -DWITH_EXTRA_CHARSETS=all \\ > -DWITH_INNOBASE_STORAGE_ENGINE=1 \\ > -DWITH_FEDERATED_STORAGE_ENGINE=1 \\ > -DWITH_BLACKHOLE_STORAGE_ENGINE=1 \\ > -DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \\ > -DWITH_ZLIB=bundled \\ > -DWITH_SSL=bundled \\ > -DENABLED_LOCAL_INFILE=1 \\ > -DWITH_EMBEDDED_SERVER=1 \\ > -DENABLE_DOWNLOADS=1 \\ > -DWITH_DEBUG=0 //ç¼–è¯‘å¹¶å®‰è£… [root@db01 mysql-5.6.40]# make && make install 5.åˆ›å»ºmysqlç”¨æˆ·å’Œç»„å¹¶åšmysqlå®‰è£…ç›®å½•è½¯è¿æ¥ //åˆ›å»ºmysqlç»„ [root@db01 ~]# groupadd mysql //åˆ›å»ºmysqlç”¨æˆ· [root@db01 ~]# useradd -r -g mysql -s /bin/false mysql //ä¿®æ”¹mysqlç›®å½•æƒé™ [root@db01 ~]# chown -R mysql.mysql /usr/local/mysql-5.6.40 //åšmysqlå®‰è£…ç›®å½•è½¯è¿æ¥ [root@db01 ~]# ln -s /usr/local/mysql-5.6.40 /usr/local/mysql 6.åˆå§‹åŒ–æ•°æ®åº“ [root@db01 ~]# /usr/local/mysql/scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data 7.æ‹·è´mysqlä¸»é…ç½®æ–‡ä»¶ //å¤‡ä»½/etc/my.cnf [root@db01 ~]# mv /etc/my.cnf /etc/my.cnf.old //æ‹·è´mysqlé…ç½®æ–‡ä»¶ [root@db01 ~]# cp /usr/local/mysql/support-files/my-default.cnf /etc/my.cnf 8.æ‹·è´mysqlå¯åŠ¨æ–‡ä»¶ [root@db01 ~]# cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld 9.å¯¼å‡ºmysqlå‘½ä»¤ç¯å¢ƒå˜é‡ //æœ€å¥½ä¸è¦ç›´æ¥è¿½åŠ åˆ°/etc/profileï¼Œå¯é€‰æ‹©åœ¨/etc/profile.d/åˆ›å»ºä¸€ä¸ªx.sh [root@db01 ~]# echo \"export PATH=/usr/local/mysql/bin:$PATH\" > /etc/profile.d/mysql.sh //ä½¿é…ç½®ç”Ÿæ•ˆ [root@db01 ~]# source /etc/profile 10.å¯åŠ¨mysql [root@db01 ~]# /etc/init.d/mysqld start 11.ç”¨systemdç®¡ç†mysql //ç¼–è¾‘/usr/lib/systemd/system/mysqld.serviceï¼Œå†™å…¥ä»¥ä¸‹å‡ è¡Œ [root@db01 ~]# cat > /usr/lib/systemd/system/mysqld.service åˆ°æ­¤ï¼Œmysql5.6.40ç¼–è¯‘å®‰è£…å®Œæˆï¼ï¼ï¼ æ‰©å±•ï¼šä¸€å°ä¸»æœºmysqlå·²ç»ç¼–è¯‘å¥½ï¼Œé€šè¿‡æ‹·è´ç›¸å…³ç›®å½•å’Œæ–‡ä»¶çš„æ–¹å¼å¿«é€Ÿéƒ¨ç½²å…¶ä»–mysqlå®ä¾‹ æ­¥éª¤ï¼š 1.å‡ å°æœºå™¨çš„ç¯å¢ƒè¦ä¸€è‡´ï¼Œæ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ç¯å¢ƒ 2.æ‹·è´mysqlç¼–è¯‘å®‰è£…è·¯å¾„ç›®å½•ï¼Œæœ¬æ–‡ä¸º/usr/local/mysql-5.6.40 3.æ‹·è´mysqlé…ç½®æ–‡ä»¶ã€å¯åŠ¨æ–‡ä»¶ã€mysqlå‘½ä»¤ç¯å¢ƒå˜é‡æ–‡ä»¶/etc/profile(æˆ–è€…åœ¨å¦å¤–çš„mysqlä¸»æœºæ‰‹åŠ¨å¡«å†™) 4.æ‹·è´systemdç®¡ç†æ–‡ä»¶ 5.åˆ›å»ºmysqlç”¨æˆ·å’Œç»„ 1.å·²ç»ç¼–è¯‘å®‰è£…å¥½çš„mysqlä¸»æœºæ‹·è´ç›¸å…³åŒ… //æ‰“åŒ…mysqlç¼–è¯‘å®‰è£…ç›®å½• [root@db01 ~]# cd /usr/local [root@db01 local]# tar cf /root/mysql.tar mysql-5.6.40 //å°†åŒ…æ‹·è´è‡³å¦ä¸€å°mysqlä¸»æœº [root@db01 ~]# scp mysql.tar 10.0.0.3:/usr/local //æ‹·è´é…ç½®æ–‡ä»¶ [root@db01 ~]# scp /usr/local/mysql-5.6.40/support-files/my-default.cnf 10.0.0.3:/etc //æ‹·è´å¯åŠ¨æ–‡ä»¶ [root@db01 ~]# scp /etc/init.d/mysqld 10.0.0.3:/etc/init.d //æ‹·è´systemdç®¡ç†æ–‡ä»¶ [root@db01 ~]# scp /usr/lib/systemd/system/mysqld.service 10.0.0.3:/usr/lib/systemd/system //æ‹·è´mysqlå‘½ä»¤ç¯å¢ƒå˜é‡æ–‡ä»¶ [root@db01 local]# scp /etc/profile.d/mysql.sh 10.0.0.3:/etc/profile.d 2.å¦å¤–ä¸€å°mysqlä¸»æœºæ“ä½œ /åˆ›å»ºmysqlç”¨æˆ·å’Œç»„ [root@db03 ~]# groupadd mysql [root@db03 ~]# useradd -r -g mysql -s /bin/false mysql //è§£å‹ç¼©æ‹·è´è¿‡æ¥çš„mysqlåŒ… [root@db03 ~]# cd /usr/local [root@db03 local]# tar xf mysql.tar //ä¿®æ”¹mysqlæ‰€æœ‰è€… [root@db03 local]# chown -R mysql.mysql mysql-5.6.40 //åšè½¯è¿æ¥ [root@db03 local]# ln -s mysql-5.6.40/ mysql //ä½¿mysqlå‘½ä»¤ç¯å¢ƒå˜é‡é…ç½®ç”Ÿæ•ˆ [root@db03 local]# source /etc/profile //å¤‡ä»½/etc/my.cnf [root@db03 local]# mv my.cnf my.cnf.old //ä¿®æ”¹æ‹·è´è¿‡æ¥çš„mysqlé…ç½®æ–‡ä»¶ [root@db03 local]# mv my-default.cnf my.cnf //å¯åŠ¨mysqlå¹¶è®¾ç½®å¼€æœºè‡ªå¯ [root@db03 ~]# systemctl start mysqld ; systemctl enable mysqld æˆ–è€… [root@db03 ~]# /etc/init.d/mysqld start //éªŒè¯ç«¯å£ [root@db03 ~]# netstat -ntpl|grep 3306 tcp6 0 0 :::3306 :::* LISTEN 1799/mysqld åˆ°æ­¤ï¼Œå¿«é€Ÿéƒ¨ç½²mysqlå®Œæˆ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/7.CentOS7.5ç¼–è¯‘å®‰è£…MySQL-5.7.23.html":{"url":"db/mysql/mysqlåŸºç¡€/7.CentOS7.5ç¼–è¯‘å®‰è£…MySQL-5.7.23.html","title":"MySQL-5.7.23","keywords":"","body":"CentOS7.5ç¼–è¯‘å®‰è£…MySQL-5.7.23 1.å®‰è£…ä¾èµ–åŒ… [root@db03 ~]# yum -y install -y gcc gcc-c++ automake autoconf cmake bison-devel ncurses-devel libaio-devel 2.åˆ›å»ºmysqlç›¸å…³ç›®å½•åŠç”¨æˆ·å’Œç»„ //åˆ›å»ºmysqlå®‰è£…ç›®å½• [root@db03 ~]# mkdir /usr/local/mysql-5.7.23 //åˆ›å»ºmysqlç»„ [root@db01 ~]# groupadd mysql //åˆ›å»ºmysqlç”¨æˆ· [root@db01 ~]# useradd -r -g mysql -s /bin/false mysql 3.ä¸‹è½½boost 5.7ç‰ˆæœ¬éœ€è¦ä¸‹è½½ä¸€ä¸ªBoost C++ 1.59.0ï¼ˆè¿™æ˜¯ä¸€ç»„æ‰©å……C++åŠŸèƒ½çš„ç»è¿‡åŒè¡Œè¯„å®¡ï¼ˆPeer-reviewedï¼‰ä¸”å¼€æ”¾æºä»£ç ç¨‹åºåº“ã€‚å¤§å¤šæ•°çš„å‡½æ•°ä¸ºäº†èƒ½å¤Ÿä»¥å¼€æ”¾æºä»£ç ã€å°é—­é¡¹ç›®çš„æ–¹å¼è¿ä½œï¼Œè€ŒæˆæƒäºBoostè½¯ä»¶è®¸å¯åè®®ï¼ˆBoost Software Licenseï¼‰ä¹‹ä¸‹ã€‚ï¼‰ [root@db03 ~]# wget https://sourceforge.net/projects/boost/files/boost/1.59.0/boost_1_59_0.tar.gz 4.è§£å‹ç¼©boostè‡³/usr/local/mysql-5.7.23 [root@db03 ~]# tar xf boost_1_59_0.tar.gz -C /usr/local/mysql-5.7.23 5.ä¸‹è½½mysql-5.7.23 [root@db03 ~]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.23.tar.gz 6.è§£å‹ç¼©mysql //è§£å‹ç¼©ä¸‹è½½çš„åŒ… [root@db03 ~]# tar xf mysql-5.7.23.tar.gz 7.è¿›å…¥è§£å‹ç›®å½•ï¼Œå¼€å§‹ç¼–è¯‘å®‰è£… [root@db03 ~]# cd mysql-5.7.23 [root@db03 mysql-5.7.23]# cmake -DCMAKE_INSTALL_PREFIX=/usr/local/mysql-5.7.23 \\ -DMYSQL_USER=mysql \\ -DWITH_MYISAM_STORAGE_ENGINE=1 \\ -DWITH_INNOBASE_STORAGE_ENGINE=1 \\ -DEXTRA_CHARSETS=all \\ -DDEFAULT_CHARSET=utf8 \\ -DDEFAULT_COLLATION=utf8_general_ci \\ -DWITH_DEBUG=0 \\ -DMYSQL_MAINTAINER_MODE=0 \\ -DWITH_SSL:STRING=bundled \\ -DWITH_ZLIB:STRING=bundled \\ -DWITH_SYSTEMD=1 \\ -DDOWNLOAD_BOOST=0 \\ -DWITH_DEBUG=0 \\ -DWITH_BOOST=/usr/local/mysql-5.7.23/boost //ç¼–è¯‘å¹¶å®‰è£… [root@db03 mysql-5.7.23]# make && make install 8.ä¿®æ”¹mysqlå®‰è£…ç›®å½•æ‰€æœ‰è€…å¹¶åšè½¯è¿æ¥ //ä¿®æ”¹ç›®å½•æ‰€æœ‰è€… [root@db03 ~]# chown -R mysql.mysql /usr/local/mysql-5.7.23 //åšè½¯è¿æ¥ [root@db03 ~]# ln -s /usr/local/mysql-5.7.23/ /usr/local/mysql 9.åˆå§‹åŒ–mysql //è¿›å…¥mysqlç¼–è¯‘å®‰è£…ç›®å½• [root@db03 ~]# cd /usr/local/mysql âš ï¸âš ï¸âš ï¸æ³¨æ„ï¼ï¼ï¼ MySQL 5.7.6ä¹‹å‰çš„ç‰ˆæœ¬æ‰§è¡Œè¿™ä¸ªè„šæœ¬åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®åº“ ./bin/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data MySQL 5.7.6ä¹‹åç”¨ä»¥ä¸‹è„šæœ¬åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®åº“ ./bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data //åˆå§‹åŒ–mysql [root@db03 mysql]# ./bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --initialize-insecure #åˆå§‹åŒ–åŠ æ­¤é€‰é¡¹è¡¨ç¤ºåˆå§‹åŒ–åä¸ç”Ÿæˆéšæœºå¯†ç  é€šè¿‡mysqld --verbose --help|grep initializeæŸ¥çœ‹è¯´æ˜ è¿”å›ä»¥ä¸‹ç»“æœè¡¨æ˜åˆå§‹åŒ–æ­£ç¡® 10.ç¼–è¾‘mysqlä¸»é…ç½®æ–‡ä»¶ æ³¨æ„mysql-5.7.23æºç åŒ…é»˜è®¤æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼ï¼ï¼ï¼ï¼ï¼ //å¤‡ä»½/etc/my.cnf [root@db03 local]# mv /etc/my.cnf /etc/my.cnf.old [root@db03 local]# cd //ä»¥ä¸‹é…ç½®ä¸ºæœ€ç²¾ç®€ç‰ˆï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œç›¸åº”è®¾ç½® [root@db03 ~]# vim /etc/my.cnf [mysqld] basedir=/usr/local/mysql datadir=/usr/local/mysql/data user=mysql log-error=/usr/local/mysql/data/error.log 11.æ‹·è´mysqlå¯åŠ¨æ–‡ä»¶ //æ‹·è´mysql.serveræ–‡ä»¶å°±å¯ä»¥ä½¿ç”¨/etc/init.d/mysqld æ–¹å¼å¯åŠ¨mysql [root@db03 ~]# cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld 12.systemdç®¡ç†mysql [root@db03 ~]# cat > /etc/systemd/system/mysqld.service 13.å¯¼å‡ºmysqlå‘½ä»¤ç¯å¢ƒå˜é‡ï¼Œä½¿mysqlå‘½ä»¤å¯ä»¥ä½¿ç”¨ //æœ€å¥½ä¸è¦å¾€/etc/profileä¸­è¿½åŠ å†…å®¹ï¼Œå¯ä»¥åˆ›å»º/etc/profile.d/x.sh [root@db03 ~]# echo 'export PATH=/usr/local/mysql/bin:$PATH' > /etc/profile.d/mysql.sh //ä½¿é…ç½®ç”Ÿæ•ˆ [root@db03 ~]# source /etc/profile 14.å¯åŠ¨mysqlï¼Œæ£€æŸ¥å¯åŠ¨ //å¯åŠ¨mysql [root@db03 ~]# systemctl start mysqld //æ£€æŸ¥å¯åŠ¨ [root@db03 ~]# netstat -ntpl tcp6 0 0 :::3306 :::* LISTEN 21196/mysqld æ‰©å±•ï¼šä¸€å°ä¸»æœºmysqlå·²ç»ç¼–è¯‘å¥½ï¼Œé€šè¿‡æ‹·è´ç›¸å…³ç›®å½•å’Œæ–‡ä»¶çš„æ–¹å¼å¿«é€Ÿéƒ¨ç½²å…¶ä»–mysql æ­¥éª¤ï¼š 1.å‡ å°æœºå™¨çš„ç¯å¢ƒè¦ä¸€è‡´ï¼Œæ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ç¯å¢ƒ 2.æ‹·è´mysqlç¼–è¯‘å®‰è£…è·¯å¾„ç›®å½•ï¼Œæœ¬æ–‡ä¸º/usr/local/mysql-5.7.23 3.æ‹·è´mysqlé…ç½®æ–‡ä»¶ã€å¯åŠ¨æ–‡ä»¶ã€mysqlå‘½ä»¤ç¯å¢ƒå˜é‡æ–‡ä»¶/etc/profile.d/mysql.sh(æˆ–è€…åœ¨å¦å¤–çš„mysqlä¸»æœºæ‰‹åŠ¨å¡«å†™) 4.æ‹·è´systemdç®¡ç†æ–‡ä»¶ 5.åˆ›å»ºmysqlç”¨æˆ·å’Œç»„ 1.å·²ç»ç¼–è¯‘å®‰è£…å¥½çš„mysqlä¸»æœºæ‹·è´ç›¸å…³åŒ… //æ‰“åŒ…mysqlç¼–è¯‘å®‰è£…ç›®å½• [root@db01 ~]# cd /usr/local [root@db01 local]# tar cf /root/mysql.tar mysql-5.7.23 //å°†åŒ…æ‹·è´è‡³å¦ä¸€å°mysqlä¸»æœº [root@db01 ~]# scp mysql.tar 10.0.0.3:/usr/local //æ‹·è´é…ç½®æ–‡ä»¶,5.7.23é»˜è®¤æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶æ˜¯æ‰‹åŠ¨å†™çš„ [root@db01 ~]# scp /etc/my.cnf 10.0.0.3:/etc //æ‹·è´å¯åŠ¨æ–‡ä»¶ [root@db01 ~]# scp /etc/init.d/mysqld 10.0.0.3:/etc/init.d //æ‹·è´systemdç®¡ç†æ–‡ä»¶ [root@db01 ~]# scp /etc/systemd/system/mysqld.service 10.0.0.3:/etc/systemd/system //æ‹·è´mysqlå‘½ä»¤ç¯å¢ƒå˜é‡æ–‡ä»¶ [root@db01 ~]# scp /etc/profile.d/mysql.sh 10.0.0.3:/etc/profile.d 2.å¦å¤–ä¸€å°mysqlä¸»æœºæ“ä½œ //åˆ›å»ºmysqlç”¨æˆ·å’Œç»„ [root@db03 ~]# groupadd mysql [root@db03 ~]# useradd -r -g mysql -s /bin/false mysql //è§£å‹ç¼©æ‹·è´è¿‡æ¥çš„mysqlåŒ… [root@db03 ~]# cd /usr/local [root@db03 local]# tar xf mysql.tar //ä¿®æ”¹mysqlæ‰€æœ‰è€… [root@db03 local]# chown -R mysql.mysql mysql-5.7.23 //åšè½¯è¿æ¥ [root@db03 local]# ln -s mysql-5.7.23/ mysql //ä½¿mysqlå‘½ä»¤ç¯å¢ƒå˜é‡é…ç½®ç”Ÿæ•ˆ [root@db03 local]# source /etc/profile //å¯åŠ¨mysql [root@db03 ~]# systemctl start mysqld ï¼›systemctl enable mysqld æˆ–è€… [root@db03 ~]# /etc/init.d/mysqld start //éªŒè¯ç«¯å£ [root@db03 ~]# netstat -ntpl|grep 3306 tcp6 0 0 :::3306 :::* LISTEN 1799/mysqld åˆ°æ­¤ï¼Œå¿«é€Ÿéƒ¨ç½²mysqlå®Œæˆ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/9.mysqlè¿æ¥ä¸å¯åŠ¨è¿‡ç¨‹.html":{"url":"db/mysql/mysqlåŸºç¡€/9.mysqlè¿æ¥ä¸å¯åŠ¨è¿‡ç¨‹.html","title":"4.mysqlè¿æ¥ä¸å¯åŠ¨è¿‡ç¨‹","keywords":"","body":"mysqlè¿æ¥ä¸å¯åŠ¨è¿‡ç¨‹ 1.mysqlè¿æ¥ç®¡ç† 1.1è¿æ¥å·¥å…· 1)MySQLè‡ªå¸¦çš„è¿æ¥å·¥å…· mysql å¸¸è§çš„ç‰¹å®šäºå®¢æˆ·æœºçš„è¿æ¥é€‰é¡¹ï¼š -uï¼šæŒ‡å®šç”¨æˆ· -pï¼šæŒ‡å®šå¯†ç  -hï¼šæŒ‡å®šä¸»æœº -Pï¼šæŒ‡å®šç«¯å£ -Sï¼šæŒ‡å®šsockæ–‡ä»¶ -eï¼šæŒ‡å®šSQL(å‘½ä»¤è¡Œæ‰§è¡Œsqlå‘½ä»¤) 2)ç¬¬ä¸‰æ–¹çš„è¿æ¥å·¥å…· sqlyogã€navicat åº”ç”¨ç¨‹åºè¿æ¥MySQL æ³¨æ„ï¼šéœ€è¦åŠ è½½å¯¹åº”è¯­è¨€ç¨‹åºçš„API 1.2è¿æ¥æ–¹å¼ 1.2.1socketè¿æ¥ ç¬¬ä¸€ç§æ–¹å¼ //mysql -uroot -p [root@db01 ~]# mysql -uroot -p mysql> status; Connection: Localhost via UNIX socket ç¬¬äºŒç§æ–¹å¼ [root@db01 ~]# mysql -uroot -p -S /tmp/mysql.sock mysql> status; Connection: Localhost via UNIX socket 1.2.2TCP/IPè¿æ¥ [root@db01 ~]# mysql -uroot -p -h10.0.0.11 -P3306 mysql> status; Connection: 10.0.0.11 via TCP/IP 2.mysqlå¯åŠ¨æµç¨‹ 2.1ç¤ºæ„å›¾ /etc/init.d/mysqld start ------> mysqld_safe ------> mysqld 2.2mysqlå¯åŠ¨ä¼˜å…ˆé¡ºåº 1.å‘½ä»¤è¡Œé€‰é¡¹ 2.åˆå§‹åŒ–é…ç½®æ–‡ä»¶ 3.é¢„ç¼–è¯‘é€‰é¡¹ï¼Œé¢„ç¼–è¯‘é€‰é¡¹ä¼˜å…ˆçº§æœ€ä½ï¼Œå› æ­¤ï¼Œå³ä½¿åœ¨ç¼–è¯‘çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šæŸäº›é€‰é¡¹ï¼Œä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ 2.3é…ç½®æ–‡ä»¶è¯»å–é¡ºåº âš ï¸âš ï¸âš ï¸æ­¤é¡ºåºä¸ºä½¿ç”¨/etc/init.d/mysql.serviceå¯åŠ¨è„šæœ¬æ–¹æ³•ç”Ÿæ•ˆï¼Œä½¿ç”¨systemdä¸ç”Ÿæ•ˆ 1./etc/my.cnf 2./etc/mysql/my.cnf 3.å®‰è£…ç›®å½•/my.cnfï¼ˆå‰ææ˜¯åœ¨ç¯å¢ƒå˜é‡ä¸­å®šä¹‰äº† å®‰è£…ç›®å½• å˜é‡ï¼‰ 4.defaults-extra-file ï¼ˆç±»ä¼¼includeï¼‰ 5.~/.my.cnf å‘½ä»¤è¡Œä¸­åŠ ä¸Š--defaults-file=xxxï¼Œä»¥ä¸Šæ–‡ä»¶éƒ½ä¸è¯»å– âš ï¸âš ï¸âš ï¸é…ç½®æ–‡ä»¶é¡ºåºä¼˜å…ˆï¼Œä½†æ˜¯é…ç½®ä¼˜å…ˆçº§æœ€ä½ é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§æœ€ç»ˆç»“è®º 1ã€å‘½ä»¤è¡Œ 2ã€defaults-file 3ã€é…ç½®æ–‡ä»¶ 4ã€é¢„ç¼–è¯‘ æŸ¥çœ‹mysqlé»˜è®¤è¯»å–my.cnfçš„é¡ºåº $ mysql --help --verbose | grep 'my.cnf' order of preference, my.cnf, $MYSQL_TCP_PORT, /etc/my.cnf /etc/mysql/my.cnf /usr/local/mysql/etc/my.cnf ~/.my.cnf æŸ¥çœ‹mysqldé»˜è®¤è¯»å–my.cnfçš„é¡ºåº $ mysqld --verbose --help | grep 'my.cnf' /etc/my.cnf /etc/mysql/my.cnf /usr/local/mysql/etc/my.cnf ~/.my.cnf my.cnf, $MYSQL_TCP_PORT, /etc/services, built-in default 2.4å‘½ä»¤è¡Œä¸defaults-fileä¼˜å…ˆçº§æ¯”è¾ƒç¤ºä¾‹ åœ¨/tmp/a.txtä¸­æŒ‡å®šsocketæ–‡ä»¶ä½ç½®ï¼Œç„¶åç”¨mysqld_safeå¯åŠ¨ï¼Œsocketæ–‡ä»¶æœ€ç»ˆä¼šåœ¨/tmp/b.sock //ç¼–è¾‘ä¸€ä¸ªæ–‡ä»¶ [root@db01 ~]# cat /tmp/a.txt [mysqld] socket=/tmp/a.sock //ç”¨mysqld_safeå¯åŠ¨å¹¶æŒ‡å®šsocketæ–‡ä»¶ä½ç½® [root@db01 ~]# mysqld_safe --defaults-file=/etc/my.cnf --socket=/tmp/b.sock æœ€ç»ˆsocketæ–‡ä»¶åœ¨/tmp/b.sockï¼Œå› æ­¤è¯´æ˜äº†åœ¨å‘½ä»¤è¡Œä¸­çš„ä¼˜å…ˆçº§æœ€å¤§ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/10.mysqlæ•°æ®ç±»å‹å’ŒSQLè¯­å¥åˆ†ç±».html":{"url":"db/mysql/mysqlåŸºç¡€/10.mysqlæ•°æ®ç±»å‹å’ŒSQLè¯­å¥åˆ†ç±».html","title":"5.mysqlæ•°æ®ç±»å‹å’ŒSQLè¯­å¥åˆ†ç±»","keywords":"","body":"mysqlæ•°æ®ç±»å‹å’ŒSQLè¯­å¥åˆ†ç±» 1.SQLè¯­å¥åˆ†ç±» DDL(Data Definition Language)æ•°æ®å®šä¹‰è¯­è¨€ createã€alterã€drop DML(Data Manipulation Language)æ•°æ®æ“çºµè¯­è¨€ insertã€updateã€delete DCL(Data Control Language)æ•°æ®æ§åˆ¶è¯­è¨€ grantã€revoke DQL(Data Query Language)æ•°æ®æŸ¥è¯¢è¯­è¨€ selectã€show 2.mysqlæ•°æ®ç±»å‹ 2.1æ•°å€¼ç±»å‹ 2.1.1æ•´å‹ ç±»å‹ å¤§å° èŒƒå›´ï¼ˆæœ‰ç¬¦å·ï¼‰ èŒƒå›´ï¼ˆæ— ç¬¦å·ï¼‰unsignedçº¦æŸ ç”¨é€” TINYINT 1 å­—èŠ‚ (-128ï¼Œ127) (0ï¼Œ255) å°æ•´æ•°å€¼ SMALLINT 2 å­—èŠ‚ (-32 768ï¼Œ32 767) (0ï¼Œ65 535) å¤§æ•´æ•°å€¼ MEDIUMINT 3 å­—èŠ‚ (-8 388 608ï¼Œ8 388 607) (0ï¼Œ16 777 215) å¤§æ•´æ•°å€¼ INTæˆ–INTEGER 4 å­—èŠ‚ (-2 147 483 648ï¼Œ2 147 483 647) (0ï¼Œ4 294 967 295) å¤§æ•´æ•°å€¼ BIGINT 8 å­—èŠ‚ (-9 233 372 036 854 775 808ï¼Œ9 223 372 036 854 775 807) (0ï¼Œ18 446 744 073 709 551 615) æå¤§æ•´æ•°å€¼ 2.1.1.1 intå’Œtinyintä½¿ç”¨ç¤ºä¾‹ å¸¸ç”¨çš„æ•°æ®ç±»å‹æ˜¯tinyintå’Œint #åˆ›å»ºè¡¨t1 mysql> create table t1(t tinyint,i int); Query OK, 0 rows affected (0.02 sec) //å‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼Œæœ‰ç¬¦å·çš„tinyintä¸‹é™æ˜¯-128ï¼Œå› æ­¤æ’å…¥-129æŠ¥é”™ mysql> insert into t1 values(-129,-129); ERROR 1264 (22003): Out of range value for column 't' at row 1 mysql> insert into t1 values(-128,-129); Query OK, 1 row affected (0.01 sec) #åˆ›å»ºè¡¨t2 mysql> create table t2(t tinyint(3),i int(3)); Query OK, 0 rows affected (0.08 sec) //å‘è¡¨t2ä¸­æ’å…¥æ•°æ® mysql> insert into t2 values(1000,1000); ERROR 1264 (22003): Out of range value for column 't' at row 1 mysql> insert into t2 values(999,1000); ERROR 1264 (22003): Out of range value for column 't' at row 1 mysql> insert into t2 values(128,999); ERROR 1264 (22003): Out of range value for column 't' at row 1 mysql> insert into t2 values(127,999); Query OK, 1 row affected (0.01 sec) 2.1.2æµ®ç‚¹å‹ ç±»å‹ å¤§å° èŒƒå›´(æœ‰ç¬¦å·) èŒƒå›´(æ— ç¬¦å·) ç”¨é€” FLOAT 4 å­—èŠ‚float(255,30) (-3.402 823 466 E+38ï¼Œ-1.175 494 351 E-38)ï¼Œ0ï¼Œ(1.175 494 351 E-38ï¼Œ3.402 823 466 351 E+38) 0ï¼Œ(1.175 494 351 E-38ï¼Œ3.402 823 466 E+38) å•ç²¾åº¦ æµ®ç‚¹æ•°å€¼ DOUBLE 8 å­—èŠ‚double(255,30) (-1.797 693 134 862 315 7 E+308ï¼Œ-2.225 073 858 507 201 4 E-308)ï¼Œ0ï¼Œ(2.225 073 858 507 201 4 E-308ï¼Œ1.797 693 134 862 315 7 E+308) 0ï¼Œ(2.225 073 858 507 201 4 E-308ï¼Œ1.797 693 134 862 315 7 E+308) åŒç²¾åº¦ æµ®ç‚¹æ•°å€¼ DECIMAL å¯¹DECIMAL(M,D) ï¼Œå¦‚æœM>Dï¼Œä¸ºM+2å¦åˆ™ä¸ºD+2double(65,30) ä¾èµ–äºMå’ŒDçš„å€¼ ä¾èµ–äºMå’ŒDçš„å€¼ å°æ•°å€¼ floatã€doubleã€decimalçš„æ ¼å¼ç›¸åŒ float(m,n) double(m,n) decimal(m,n) å…¶ä¸­mè¡¨ç¤ºä¸€å…±æœ‰mä½ï¼Œæœ‰nä½å°æ•° #åˆ›å»ºt1è¡¨ï¼Œä¸‰ä¸ªå­—æ®µåˆ†åˆ«ä¸ºfloatï¼Œdoubleå’Œdecimalå‚æ•°è¡¨ç¤ºä¸€å…±æ˜¾ç¤º5ä½ï¼Œå°æ•°éƒ¨åˆ†å 2ä½ mysql> create table t1(id1 float(5,2),id2 double(5,2),id3 decimal(5,2)); Query OK, 0 rows affected (0.01 sec) mysql> desc t1; +-------+--------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+--------------+------+-----+---------+-------+ | id1 | float(5,2) | YES | | NULL | | | id2 | double(5,2) | YES | | NULL | | | id3 | decimal(5,2) | YES | | NULL | | +-------+--------------+------+-----+---------+-------+ 3 rows in set (0.00 sec) //å‘è¡¨ä¸­æ’å…¥1.11ï¼Œç»“æœæ­£å¸¸ mysql> insert into t1 values(1.11,1.11,1.11); Query OK, 1 row affected (0.00 sec) mysql> select * from t1; +------+------+------+ | id1 | id2 | id3 | +------+------+------+ | 1.11 | 1.11 | 1.11 | +------+------+------+ 1 row in set (0.00 sec) //å‘è¡¨ä¸­æ’å…¥1.234å‘ç°åªèƒ½ä¿ç•™2ä½å°æ•° mysql> insert into t1 values(1.234,1.234,1.234); Query OK, 1 row affected, 1 warning (0.01 sec) mysql> select * from t1; +------+------+------+ | id1 | id2 | id3 | +------+------+------+ | 1.11 | 1.11 | 1.11 | | 1.23 | 1.23 | 1.23 | +------+------+------+ 2 rows in set (0.00 sec) //mysql> insert into t1 values(1.236,1.236,1.236); Query OK, 1 row affected, 1 warning (0.02 sec) mysql> select * from t1; +------+------+------+ | id1 | id2 | id3 | +------+------+------+ | 1.11 | 1.11 | 1.11 | | 1.23 | 1.23 | 1.23 | | 1.24 | 1.24 | 1.24 | +------+------+------+ 3 rows in set (0.00 sec).236ï¼Œè™½ç„¶åªèƒ½ä¿ç•™2ä½å°æ•°ï¼Œä½†æ˜¯æœ‰å››èˆäº”å…¥çš„è§„åˆ™ #æ–°å»ºt2è¡¨ mysql> create table t2(f float,do double,de decimal); Query OK, 0 rows affected (0.08 sec) mysql> desc t2; +-------+---------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+---------------+------+-----+---------+-------+ | f | float | YES | | NULL | | | do | double | YES | | NULL | | | de | decimal(10,0) | YES | | NULL | | +-------+---------------+------+-----+---------+-------+ 3 rows in set (0.00 sec) //åˆ†åˆ«æ’å…¥1.2345ï¼ŒæŸ¥çœ‹è¡¨å¯ä»¥çœ‹åˆ°decimalé»˜è®¤æ˜¯æ•´å‹ mysql> insert into t2 values(1.2345,1.2345,1.2345); Query OK, 1 row affected, 1 warning (0.00 sec) mysql> select * from t2; +--------+--------+------+ | f | do | de | +--------+--------+------+ | 1.2345 | 1.2345 | 1 | +--------+--------+------+ 1 row in set (0.00 sec) //åˆ†åˆ«æ’å…¥è¶…é•¿çš„æ•°ï¼ŒæŸ¥çœ‹3è€…çš„åŒºåˆ«ï¼Œå¯ä»¥çœ‹åˆ°doubleçš„ç²¾åº¦æ›´é«˜ mysql> insert into t2 values(1.234567890123456789,1.234567890123456789,1.234567890123456789); Query OK, 1 row affected, 1 warning (0.02 sec) mysql> select * from t2; +---------+--------------------+------+ | f | do | de | +---------+--------------------+------+ | 1.2345 | 1.2345 | 1 | | 1.23457 | 1.2345678901234567 | 1 | +---------+--------------------+------+ 2 rows in set (0.00 sec) ç»“è®ºï¼š åœ¨ä¸æŒ‡å®šé•¿åº¦çš„æƒ…å†µä¸‹ï¼Œdecimalé»˜è®¤æ˜¯æ•´å‹å­˜å‚¨ doubleçš„ç²¾åº¦è¦æ¯”floaté«˜ 2.2å­—ç¬¦ä¸²ç±»å‹ ç±»å‹ å¤§å° ç”¨é€” CHAR 0-255å­—èŠ‚ å®šé•¿å­—ç¬¦ä¸² VARCHAR 0-65535 å­—èŠ‚ å˜é•¿å­—ç¬¦ä¸² TINYBLOB 0-255å­—èŠ‚ ä¸è¶…è¿‡ 255 ä¸ªå­—ç¬¦çš„äºŒè¿›åˆ¶å­—ç¬¦ä¸² TINYTEXT 0-255å­—èŠ‚ çŸ­æ–‡æœ¬å­—ç¬¦ä¸² BLOB 0-65 535å­—èŠ‚ äºŒè¿›åˆ¶å½¢å¼çš„é•¿æ–‡æœ¬æ•°æ® TEXT 0-65 535å­—èŠ‚ é•¿æ–‡æœ¬æ•°æ® MEDIUMBLOB 0-16 777 215å­—èŠ‚ äºŒè¿›åˆ¶å½¢å¼çš„ä¸­ç­‰é•¿åº¦æ–‡æœ¬æ•°æ® MEDIUMTEXT 0-16 777 215å­—èŠ‚ ä¸­ç­‰é•¿åº¦æ–‡æœ¬æ•°æ® LONGBLOB 0-4 294 967 295å­—èŠ‚ äºŒè¿›åˆ¶å½¢å¼çš„æå¤§æ–‡æœ¬æ•°æ® LONGTEXT 0-4 294 967 295å­—èŠ‚ æå¤§æ–‡æœ¬æ•°æ® 2.2.1 charä¸varcharä½¿ç”¨ç¤ºä¾‹ CHAR å’Œ VARCHAR ç±»å‹ç±»ä¼¼ï¼Œä½†å®ƒä»¬ä¿å­˜å’Œæ£€ç´¢çš„æ–¹å¼ä¸åŒã€‚å®ƒä»¬çš„æœ€å¤§é•¿åº¦å’Œæ˜¯å¦å°¾éƒ¨ç©ºæ ¼è¢«ä¿ç•™ç­‰æ–¹é¢ä¹Ÿä¸åŒã€‚åœ¨å­˜å‚¨æˆ–æ£€ç´¢è¿‡ç¨‹ä¸­ä¸è¿›è¡Œå¤§å°å†™è½¬æ¢ã€‚ CHARåˆ—çš„é•¿åº¦å›ºå®šä¸ºåˆ›å»ºè¡¨æ˜¯å£°æ˜çš„é•¿åº¦,èŒƒå›´(0-255);è€ŒVARCHARçš„å€¼æ˜¯å¯å˜é•¿å­—ç¬¦ä¸²èŒƒå›´(0-65535)ã€‚ #åˆ›å»ºè¡¨t1 mysql> create table t1(c char(4),v varchar(4)); Query OK, 0 rows affected (0.09 sec) //å‘t1è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into t1 values('ab ','ab '); Query OK, 1 row affected (0.01 sec) mysql> select * from t1; +------+------+ | c | v | +------+------+ | ab | ab | +------+------+ 1 row in set (0.00 sec) //æ£€ç´¢çš„æ—¶å€™charä¼šå»æ‰ç©ºæ ¼ mysql> select length(c),length(v) from t1; +-----------+-----------+ | length(c) | length(v) | +-----------+-----------+ | 2 | 4 | +-----------+-----------+ 1 row in set (0.00 sec) //ç»™æŸ¥è¯¢ç»“æœåŠ ä¸Šä¸€ä¸ªç¬¦å·ä¼šçœ‹çš„æ›´æ¸…æ™°ï¼Œcharåœ¨æ£€ç´¢çš„æ—¶å€™ä¼šå»æ‰ç©ºæ ¼ mysql> select concat(c,'+'),concat(v,'+') from t1; +---------------+---------------+ | concat(c,'+') | concat(v,'+') | +---------------+---------------+ | ab+ | ab + | +---------------+---------------+ 1 row in set (0.01 sec) charå­˜å‚¨çš„æ—¶å€™æ˜¯å®šé•¿ï¼Œä¾‹å¦‚ï¼Œchar(5)ï¼Œä½†æ˜¯åªæ’å…¥äº†ä¸€ä¸ªå­—ç¬¦aï¼Œåˆ™ä¼šåœ¨å­—ç¬¦aåè¾¹è¡¥å…¨4ä¸ªç©ºæ ¼ varcharå­˜å‚¨çš„æ—¶å€™æ˜¯å˜é•¿ï¼Œä¾‹å¦‚ï¼Œvarchar(5)ï¼Œä½†æ˜¯åªæ’å…¥äº†ä¸€ä¸ªå­—ç¬¦aï¼Œåˆ™å­˜å‚¨aåè¿˜ä¼šåœ¨açš„ä½ç½®åè¾¹åŠ ä¸€ä¸ªaçš„ä½ç½®ç¼–å· 2.3æ—¥æœŸå’Œæ—¶é—´ç±»å‹ ç±»å‹ å¤§å° (å­—èŠ‚) èŒƒå›´ æ ¼å¼ ç”¨é€” DATE 3 1000-01-01/9999-12-31 YYYY-MM-DD å¹´æœˆæ—¥ TIME 3 '-838:59:59'/'838:59:59' HH:MM:SS æ—¶åˆ†ç§’ YEAR 1 1901/2155 YYYY å¹´ä»½å€¼ DATETIME 8 1000-01-01 00:00:00/9999-12-31 23:59:59 YYYY-MM-DD HH:MM:SS å¹´æœˆæ—¥æ—¶åˆ†ç§’ TIMESTAMP 4 1970-01-01 00:00:00/2038ç»“æŸæ—¶é—´æ˜¯ç¬¬ 2147483647 ç§’ï¼ŒåŒ—äº¬æ—¶é—´ 2038-1-19 11:14:07ï¼Œæ ¼æ—å°¼æ²»æ—¶é—´ 2038å¹´1æœˆ19æ—¥ å‡Œæ™¨ 03:14:07 YYYYMMDD HHMMSS æ··åˆæ—¥æœŸå’Œæ—¶é—´å€¼ï¼Œæ—¶é—´æˆ³ âš ï¸âš ï¸âš ï¸IMESTAMåªæ”¯æŒåˆ°2038å¹´çš„æ—¶é—´ï¼Œå› æ­¤ç”¨çš„æ¯”è¾ƒå°‘ 2.3.1 DATEã€TIMEã€DATETIMEä½¿ç”¨ç¤ºä¾‹ #åˆ›å»ºè¡¨t2ï¼Œ3ä¸ªåˆ—æ•°æ®ç±»å‹ä¾æ¬¡ä¸ºdateã€timeã€datetime mysql> create table t2(d date,t time,dt datetime); Query OK, 0 rows affected (0.02 sec) //å‘t2è¡¨ä¸­æ’å…¥æ•°æ®ï¼Œè¿™é‡Œä½¿ç”¨now()å‡½æ•° mysql> insert into t2 values(now(),now(),now()); Query OK, 1 row affected, 1 warning (0.00 sec) //æŸ¥çœ‹t2è¡¨ä¸­çš„æ•°æ® åˆ—dçš„æ•°æ®ç±»å‹æ˜¯date å¹´æœˆæ—¥ åˆ—tçš„æ•°æ®ç±»å‹æ˜¯time æ—¶åˆ†ç§’ åˆ—dtçš„æ•°æ®ç±»å‹æ˜¯datetime å¹´æœˆæ—¥æ—¶åˆ†ç§’ mysql> select * from t2; +------------+----------+---------------------+ | d | t | dt | +------------+----------+---------------------+ | 2018-10-28 | 17:32:33 | 2018-10-28 17:32:33 | +------------+----------+---------------------+ 1 row in set (0.00 sec) //å‘t2è¡¨ä¸­æ’å…¥æ•°æ®ï¼Œè¿™é‡Œæ‰‹åŠ¨æŒ‡å®šï¼Œæœ‰ä¸¤ç§æ–¹æ³• æ–¹æ³•ä¸€ mysql> insert into t2 values('2018-08-08','08:08:08','2016-06-06 06:06:06'); Query OK, 1 row affected (0.01 sec) æ–¹æ³•äºŒ mysql> insert into t2 values('20180808','080808','20160606060606'); Query OK, 1 row affected (0.00 sec) mysql> select * from t2; +------------+----------+---------------------+ | d | t | dt | +------------+----------+---------------------+ | 2018-08-08 | 08:08:08 | 2016-06-06 06:06:06 | | 2018-08-08 | 08:08:08 | 2016-06-06 06:06:06 | +------------+----------+---------------------+ 2 rows in set (0.00 sec) âš ï¸åªæœ‰TIMESTAMPç±»å‹æ’å…¥æ•°æ®ä¸ºç©ºæ—¶ä¼šè‡ªåŠ¨æ·»åŠ å½“å‰æ—¶é—´ï¼Œå…¶ä½™æ•°æ®ç±»å‹æ’å…¥ä¸ºç©ºå°±æ˜¯ç©º mysql> insert into t2 values(null,null,null); Query OK, 1 row affected (0.04 sec) mysql> select * from t2; +------------+----------+---------------------+ | d | t | dt | +------------+----------+---------------------+ | 2018-10-28 | 17:32:33 | 2018-10-28 17:32:33 | | NULL | NULL | NULL | +------------+----------+---------------------+ 2 rows in set (0.00 sec) 2.3.2 YEARä½¿ç”¨ç¤ºä¾‹ #åˆ›å»ºt3è¡¨ï¼Œåˆ—yçš„ç±»å‹ä¸ºyear mysql> create table t3(y year); Query OK, 0 rows affected (0.02 sec) //æ’å…¥æ•°æ®ï¼Œè¿™é‡Œä½¿ç”¨now()æ–¹æ³• mysql> insert into t3 values(now()); Query OK, 1 row affected (0.01 sec) //æ’å…¥æ•°æ®ï¼Œè¿™é‡Œæ‰‹åŠ¨æŒ‡å®š mysql> insert into t3 values('2020'); Query OK, 1 row affected (0.00 sec) mysql> select * from t3; +------+ | y | +------+ | 2019 | | 2020 | +------+ 2 rows in set (0.00 sec) 2.3.3 TIMESTAMPä½¿ç”¨ç¤ºä¾‹ #åˆ›å»ºt1è¡¨ mysql> create table t1(t timestamp); Query OK, 0 rows affected (0.03 sec) #æè¿°t1è¡¨ï¼Œå¯ä»¥çœ‹åˆ°timestampæœ‰é»˜è®¤çš„CURRENT_TIMESTAMPå’Œon update CURRENT_TIMESTAMPï¼Œå³æ›´æ–°å½“å‰çš„æ—¶é—´ mysql> desc t1; +-------+-----------+------+-----+-------------------+-----------------------------+ | Field | Type | Null | Key | Default | Extra | +-------+-----------+------+-----+-------------------+-----------------------------+ | t | timestamp | NO | | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP | +-------+-----------+------+-----+-------------------+-----------------------------+ 1 row in set (0.00 sec) //å‘t1è¡¨ä¸­æ’å…¥æ•°æ®,ä½¿ç”¨now()å‡½æ•° mysql> insert into t1 values(now()); Query OK, 1 row affected (0.01 sec) //å‘t1è¡¨ä¸­æ’å…¥ç©ºï¼Œtimestampä¼šè‡ªåŠ¨è¡¥å…¨å½“å‰æ—¶é—´ mysql> insert into t1 values(null); Query OK, 1 row affected (0.00 sec) mysql> select * from t1; +---------------------+ | t | +---------------------+ | 2018-10-28 17:54:32 | | 2018-10-28 17:56:07 | +---------------------+ 2 rows in set (0.00 sec) timestampæ—¶é—´ä¸Šé™åŠä¸‹é™ mysql> desc t1; +-------+-----------+------+-----+-------------------+-----------------------------+ | Field | Type | Null | Key | Default | Extra | +-------+-----------+------+-----+-------------------+-----------------------------+ | t | timestamp | NO | | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP | +-------+-----------+------+-----+-------------------+-----------------------------+ 1 row in set (0.00 sec) //timestampæ—¶é—´ä¸Šé™æ˜¯2038-01-19 11:14:07 mysql> insert into t1 values('2038-01-19 11:14:08'); ERROR 1292 (22007): Incorrect datetime value: '2038-01-19 11:14:08' for column 't' at row 1 mysql> insert into t1 values('2038-01-19 11:14:07'); Query OK, 1 row affected (0.01 sec) //timestampæ—¶é—´ä¸‹é™æ˜¯1970-01-01 08:00:01 mysql> insert into t1 values('1970-01-01 08:00:00'); ERROR 1292 (22007): Incorrect datetime value: '1970-01-01 08:00:00' for column 't' at row 1 mysql> insert into t1 values('1970-01-01 08:00:01'); Query OK, 1 row affected (0.00 sec) 2.4ENUMå’ŒSETç±»å‹ ç±»å‹ å¤§å° ç”¨é€” ENUM å¯¹1-255ä¸ªæˆå‘˜çš„æšä¸¾éœ€è¦1ä¸ªå­—èŠ‚å­˜å‚¨;å¯¹äº255-65535ä¸ªæˆå‘˜ï¼Œéœ€è¦2ä¸ªå­—èŠ‚å­˜å‚¨;æœ€å¤šå…è®¸65535ä¸ªæˆå‘˜ã€‚ å•é€‰ï¼šé€‰æ‹©æ€§åˆ« SET 1-8ä¸ªæˆå‘˜çš„é›†åˆï¼Œå 1ä¸ªå­—èŠ‚9-16ä¸ªæˆå‘˜çš„é›†åˆï¼Œå 2ä¸ªå­—èŠ‚17-24ä¸ªæˆå‘˜çš„é›†åˆï¼Œå 3ä¸ªå­—èŠ‚25-32ä¸ªæˆå‘˜çš„é›†åˆï¼Œå 4ä¸ªå­—èŠ‚33-64ä¸ªæˆå‘˜çš„é›†åˆï¼Œå 8ä¸ªå­—èŠ‚ å¤šé€‰ï¼šå…´è¶£çˆ±å¥½ 2.4.1 ENUM(æšä¸¾)ä½¿ç”¨ç¤ºä¾‹ ENUMä¸­æ–‡åç§°å«æšä¸¾ç±»å‹ï¼Œå®ƒçš„å€¼èŒƒå›´éœ€è¦åœ¨åˆ›å»ºè¡¨æ—¶é€šè¿‡æšä¸¾æ–¹å¼æ˜¾ç¤ºã€‚ENUMåªå…è®¸ä»å€¼é›†åˆä¸­é€‰å–å•ä¸ªå€¼ï¼Œè€Œä¸èƒ½ä¸€æ¬¡å–å¤šä¸ªå€¼ //åˆ›å»ºt1è¡¨ï¼Œæ€§åˆ«è®¾ç½®ä¸ºENUMç±»å‹ mysql> create table t1(id int,name char(10),sex enum('F','M')); Query OK, 0 rows affected (0.02 sec) //å‘t1è¡¨ä¸­æ’å…¥æ•°æ®ï¼Œæ€§åˆ«æ˜¯åœ¨ENUMä¸­å®šä¹‰çš„å°±å¯æ’å…¥æˆåŠŸ mysql> insert into t1 values(1,'å°æ˜','M'); Query OK, 1 row affected (0.00 sec) mysql> insert into t1 values(1,'å°çº¢','F'); Query OK, 1 row affected (0.01 sec) //æ€§åˆ«æ’å…¥ENUMä¸­æ²¡æœ‰å®šä¹‰çš„å°±ä¼šæŠ¥é”™ mysql> insert into t1 values(1,'å°çº¢','A'); ERROR 1265 (01000): Data truncated for column 'sex' at row 1 2.4.2 SET(é›†åˆ)ä½¿ç”¨ç¤ºä¾‹ SETå’ŒENUMéå¸¸ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œé‡Œé¢å¯ä»¥åŒ…å«0-64ä¸ªæˆå‘˜ã€‚æ ¹æ®æˆå‘˜çš„ä¸åŒï¼Œå­˜å‚¨ä¸Šä¹Ÿæœ‰æ‰€ä¸åŒã€‚setç±»å‹å¯ä»¥å…è®¸å€¼é›†åˆä¸­ä»»æ„é€‰æ‹©1æˆ–å¤šä¸ªå…ƒç´ è¿›è¡Œç»„åˆã€‚å¯¹è¶…å‡ºèŒƒå›´çš„å†…å®¹å°†ä¸å…è®¸æ³¨å…¥ï¼Œè€Œå¯¹é‡å¤çš„å€¼å°†è¿›è¡Œè‡ªåŠ¨å»é‡ã€‚ //åˆ›å»ºè¡¨t1ï¼Œçˆ±å¥½åˆ—è®¾ç½®ä¸ºSETç±»å‹ mysql> create table t1(id int,name char(10),hobby set('ç¯®çƒ','è¶³çƒ','çœ‹ç”µå½±')); Query OK, 0 rows affected (0.02 sec) mysql> insert into t1 values(1,'å°æ˜','ç¯®çƒ'); Query OK, 1 row affected (0.01 sec) mysql> insert into t1 values(2,'å°æ´²','ç¯®çƒ,è¶³çƒ'); Query OK, 1 row affected (0.00 sec) mysql> insert into t1 values(3,'å°ä¸½','ç¯®çƒ,è¶³çƒ,ç¯®çƒ,çœ‹ç”µå½±,è¶³çƒ'); Query OK, 1 row affected (0.00 sec) //æŸ¥è¯¢ç»“æœå¯ä»¥çœ‹åˆ°SETå¯ä»¥åªé€‰æ‹©ä¸€ä¸ªçˆ±å¥½ï¼Œé€‰æ‹©å¤šä¸ªçˆ±å¥½ï¼Œå¹¶ä¸”å¯ä»¥å»é‡ mysql> select * from t1; +------+--------+-------------------------+ | id | name | hobby | +------+--------+-------------------------+ | 1 | å°æ˜ | ç¯®çƒ | | 2 | å°æ´² | ç¯®çƒ,è¶³çƒ | | 3 | å°ä¸½ | ç¯®çƒ,è¶³çƒ,çœ‹ç”µå½± | +------+--------+-------------------------+ 3 rows in set (0.00 sec) æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/11.mysqlä¸­è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³».html":{"url":"db/mysql/mysqlåŸºç¡€/11.mysqlä¸­è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³».html","title":"6.mysqlä¸­è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³»","keywords":"","body":"mysqlä¸­è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³» 1.å¦‚ä½•åˆ†æè¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³» åˆ†ææ­¥éª¤ï¼š #1ã€å…ˆç«™åœ¨å·¦è¡¨çš„è§’åº¦å»æ‰¾ æ˜¯å¦å·¦è¡¨çš„å¤šæ¡è®°å½•å¯ä»¥å¯¹åº”å³è¡¨çš„ä¸€æ¡è®°å½•ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¯æ˜å·¦è¡¨çš„ä¸€ä¸ªå­—æ®µforeign key å³è¡¨ä¸€ä¸ªå­—æ®µï¼ˆé€šå¸¸æ˜¯idï¼‰ #2ã€å†ç«™åœ¨å³è¡¨çš„è§’åº¦å»æ‰¾ æ˜¯å¦å³è¡¨çš„å¤šæ¡è®°å½•å¯ä»¥å¯¹åº”å·¦è¡¨çš„ä¸€æ¡è®°å½•ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¯æ˜å³è¡¨çš„ä¸€ä¸ªå­—æ®µforeign key å·¦è¡¨ä¸€ä¸ªå­—æ®µï¼ˆé€šå¸¸æ˜¯idï¼‰ #3ã€æ€»ç»“ï¼š #å¤šå¯¹ä¸€ï¼š å¦‚æœåªæœ‰æ­¥éª¤1æˆç«‹ï¼Œåˆ™æ˜¯å·¦è¡¨å¤šå¯¹ä¸€å³è¡¨ å¦‚æœåªæœ‰æ­¥éª¤2æˆç«‹ï¼Œåˆ™æ˜¯å³è¡¨å¤šå¯¹ä¸€å·¦è¡¨ #å¤šå¯¹å¤š å¦‚æœæ­¥éª¤1å’Œ2åŒæ—¶æˆç«‹ï¼Œåˆ™è¯æ˜è¿™ä¸¤å¼ è¡¨æ—¶ä¸€ä¸ªåŒå‘çš„å¤šå¯¹ä¸€ï¼Œå³å¤šå¯¹å¤š,éœ€è¦å®šä¹‰ä¸€ä¸ªè¿™ä¸¤å¼ è¡¨çš„å…³ç³»è¡¨æ¥ä¸“é—¨å­˜æ”¾äºŒè€…çš„å…³ç³» #ä¸€å¯¹ä¸€: å¦‚æœ1å’Œ2éƒ½ä¸æˆç«‹ï¼Œè€Œæ˜¯å·¦è¡¨çš„ä¸€æ¡è®°å½•å”¯ä¸€å¯¹åº”å³è¡¨çš„ä¸€æ¡è®°å½•ï¼Œåä¹‹äº¦ç„¶ã€‚è¿™ç§æƒ…å†µå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨å·¦è¡¨foreign keyå³è¡¨çš„åŸºç¡€ä¸Šï¼Œå°†å·¦è¡¨çš„å¤–é”®å­—æ®µè®¾ç½®æˆuniqueå³å¯ 2.mysqlä¸­è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³» 2.1 ä¸€å¯¹å¤š å…³è”æ–¹å¼ å¤–é”® foreign key è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³»ä¸ºä¸€å¯¹å¤š ä¾‹å¦‚ï¼Œå‡ºç‰ˆç¤¾ä¸ä¹¦ä¹‹é—´çš„å…³ç³»å°±æ˜¯ä¸€å¯¹å¤šï¼Œä¸€ä¸ªå‡ºç‰ˆç¤¾å¯ä»¥å‡ºç‰ˆå¤šä¸ªä¹¦ ä¾‹å¦‚ï¼Œç­çº§è¡¨å’Œå­¦ç”Ÿè¡¨ï¼Œä¸€ä¸ªç­çº§å¯ä»¥æœ‰å¤šä¸ªå­¦ç”Ÿï¼Œä½†æ˜¯ä¸€ä¸ªå­¦ç”Ÿåªèƒ½å±äºä¸€ä¸ªç­çº§ ä¾‹å¦‚ï¼ŒæœåŠ¡å™¨å’Œæœºæˆ¿ï¼Œä¸€ä¸ªæœºæˆ¿å¯ä»¥æœ‰å¤šå°æœåŠ¡å™¨ï¼Œä½†æ˜¯ä¸€ä¸ªæœåŠ¡å™¨åªèƒ½å±äºä¸€ä¸ªæœºæˆ¿ 2.1.1ç¤ºä¾‹1ï¼Œå‡ºç‰ˆç¤¾è¡¨ä¸å›¾ä¹¦è¡¨ ä¸€ä¸ªå‡ºç‰ˆç¤¾å¯ä»¥å‡ºç‰ˆå¤šä¸ªä¹¦ #åˆ›å»ºå‡ºç‰ˆç¤¾è¡¨ mysql> create table chubanshe(id int primary key auto_increment,name char(10)); Query OK, 0 rows affected (0.02 sec) #åˆ›å»ºå›¾ä¹¦è¡¨ mysql> create table book( id int primary key auto_increment, name char(20), chubanshe_id int not null, foreign key(chubanshe_id) references chubanshe(id) on delete cascade on update cascade); Query OK, 0 rows affected (0.04 sec) //å‘å‡ºç‰ˆç¤¾è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into chubanshe(name) values ('äººæ°‘å‡ºç‰ˆç¤¾'), ('é‚®ç”µå‡ºç‰ˆç¤¾'), ('æœºæ¢°å‡ºç‰ˆç¤¾'); Query OK, 3 rows affected (0.01 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from chubanshe; +----+-----------------+ | id | name | +----+-----------------+ | 1 | äººæ°‘å‡ºç‰ˆç¤¾ | | 2 | é‚®ç”µå‡ºç‰ˆç¤¾ | | 3 | æœºæ¢°å‡ºç‰ˆç¤¾ | +----+-----------------+ 3 rows in set (0.00 sec) //å‘å›¾ä¹¦è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into book(name,chubanshe_id) values ('ç«¥è¯æ•…äº‹',1), ('é˜¿ç«¥æœ¨',2), ('è€äººä¸æµ·',1), ('ä¼šé£çš„é¸Ÿ',3), ('è‘µèŠ±å®å…¸',2); Query OK, 5 rows affected (0.00 sec) Records: 5 Duplicates: 0 Warnings: 0 mysql> select * from book; +----+--------------+--------------+ | id | name | chubanshe_id | +----+--------------+--------------+ | 1 | ç«¥è¯æ•…äº‹ | 1 | | 2 | é˜¿ç«¥æœ¨ | 2 | | 3 | è€äººä¸æµ· | 1 | | 4 | ä¼šé£çš„é¸Ÿ | 3 | | 5 | è‘µèŠ±å®å…¸ | 2 | +----+--------------+--------------+ 5 rows in set (0.00 sec) ç°åœ¨å‡ºç‰ˆç¤¾è¡¨ä¸å›¾ä¹¦è¡¨å°±æ˜¯ä¸€å¯¹å¤šå…³ç³»ï¼Œå›¾ä¹¦è¡¨ä¸­çš„chubanshe_idå¯¹åº”å‡ºç‰ˆç¤¾è¡¨ä¸­çš„å‡ºç‰ˆç¤¾idï¼Œä¸€ä¸ªå‡ºç‰ˆç¤¾å¯ä»¥å‡ºç‰ˆå¤šä¸ªä¹¦ 2.1.2ç¤ºä¾‹2ï¼Œå­¦ç”Ÿè¡¨å’Œç­çº§è¡¨ ä¸€ä¸ªç­çº§å¯ä»¥æœ‰å¤šä¸ªå­¦ç”Ÿï¼Œä½†æ˜¯ä¸€ä¸ªå­¦ç”Ÿåªèƒ½å±äºä¸€ä¸ªç­çº§ #åˆ›å»ºå­¦ç”Ÿè¡¨ mysql> create table student( sid int primary key auto_increment, sname char(10) not null, class_id int not null, foreign key(class_id) references class(cid)); Query OK, 0 rows affected (0.02 sec) #åˆ›å»ºç­çº§è¡¨ mysql> create table class(cid int auto_increment primary key); Query OK, 0 rows affected (0.04 sec) //å‘å­¦ç”Ÿè¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into student(sname,class_id) values('å°æ˜',1),('å°çº¢',1),('å°æ´²',2),('å°è‚–',3),('å°ä¸½',3); Query OK, 5 rows affected (0.00 sec) Records: 5 Duplicates: 0 Warnings: 0 mysql> select * from student; +-----+--------+----------+ | sid | sname | class_id | +-----+--------+----------+ | 1 | å°æ˜ | 1 | | 2 | å°çº¢ | 1 | | 3 | å°æ´² | 2 | | 4 | å°è‚– | 3 | | 5 | å°ä¸½ | 3 | +-----+--------+----------+ 5 rows in set (0.00 sec) //å‘ç­çº§è¡¨ä¸­æ’å…¥æ•°æ®ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªcidï¼Œè‡ªåŠ¨å¢é•¿ mysql> insert into class values(); Query OK, 1 row affected (0.01 sec) mysql> select * from class; +-----+ | cid | +-----+ | 1 | | 2 | | 3 | +-----+ 3 rows in set (0.00 sec) //é”™è¯¯ç¤ºä¾‹ï¼Œå‘å­¦ç”Ÿè¡¨ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼Œç­çº§idæŒ‡å®šä¸€ä¸ªä¸å­˜åœ¨çš„ï¼Œä¼šæŠ¥é”™ mysql> insert into student(sname,class_id) values('å°é»‘',4); ERROR 1452 (23000): Cannot add or update a child row: a foreign key constraint fails (`ppp`.`student`, CONSTRAINT `student_ibfk_1` FOREIGN KEY (`class_id`) REFERENCES `class` (`cid`)) //é”™è¯¯ç¤ºä¾‹ï¼Œå°è¯•åˆ é™¤ç­çº§è¡¨ä¸­çš„ä¸€ä¸ªè®°å½•ï¼ŒæŠ¥é”™ï¼Œä¸å¯ä»¥åˆ é™¤ï¼Œå› ä¸ºå­¦ç”Ÿè¡¨ä¸­æœ‰å¯¹åº”çš„ç­çº§ï¼Œè¿™ä¸ªæ— æ³•åˆ é™¤ mysql> delete from class where cid=1; ERROR 1451 (23000): Cannot delete or update a parent row: a foreign key constraint fails (`ppp`.`student`, CONSTRAINT `student_ibfk_1` FOREIGN KEY (`class_id`) REFERENCES `class` (`cid`)) 2.1.3ç¤ºä¾‹3ï¼Œæœºæˆ¿è¡¨ä¸æœåŠ¡å™¨è¡¨ ä¸€ä¸ªæœºæˆ¿å¯ä»¥æœ‰å¤šä¸ªæœåŠ¡å™¨ï¼Œä½†æ˜¯ä¸€ä¸ªæœåŠ¡å™¨åªèƒ½å½’å±ä¸€ä¸ªæœºæˆ¿ #åˆ›å»ºæœºæˆ¿è¡¨ mysql> create table server_room( rid int primary key auto_increment, rname char(10) not null); Query OK, 0 rows affected (0.03 sec) #åˆ›å»ºæœåŠ¡å™¨è¡¨ mysql> create table server( sid int primary key auto_increment, sname char(10) not null,room_id int not null, foreign key(room_id) references server_room(rid)); Query OK, 0 rows affected (0.02 sec) //å‘æœºæˆ¿è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into server_room(rname) values('æˆ¿å±±æœºæˆ¿'),('çŸ³æ™¯å±±æœºæˆ¿'),('ä¸°å° æœºæˆ¿'); Query OK, 3 rows affected (0.00 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from server_room; +-----+-----------------+ | rid | rname | +-----+-----------------+ | 1 | æˆ¿å±±æœºæˆ¿ | | 2 | çŸ³æ™¯å±±æœºæˆ¿ | | 3 | ä¸°å°æœºæˆ¿ | +-----+-----------------+ 3 rows in set (0.00 sec) //å‘æœåŠ¡å™¨è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into server(sname,room_id) values('HP',1),('DELL',1),('è”æƒ³',2),('IBM',3),('åä¸º',3); Query OK, 5 rows affected (0.00 sec) Records: 5 Duplicates: 0 Warnings: 0 mysql> select * from server; +-----+--------+---------+ | sid | sname | room_id | +-----+--------+---------+ | 1 | HP | 1 | | 2 | DELL | 1 | | 3 | è”æƒ³ | 2 | | 4 | IBM | 3 | | 5 | åä¸º | 3 | +-----+--------+---------+ 5 rows in set (0.00 sec) //é”™è¯¯ç¤ºä¾‹ï¼Œå°è¯•ä¿®æ”¹æœºæˆ¿è¡¨ä¸­çš„æœºæˆ¿ç¼–å·ï¼Œç»“æœæŠ¥é”™ï¼Œå› ä¸ºæœåŠ¡å™¨è¡¨ä¸­æœ‰å¯¹åº”ç¼–å·ä¸º3çš„ä¸°å°æœºæˆ¿çš„æœåŠ¡å™¨ mysql> select * from server_room; +-----+-----------------+ | rid | rname | +-----+-----------------+ | 1 | æˆ¿å±±æœºæˆ¿ | | 2 | çŸ³æ™¯å±±æœºæˆ¿ | | 3 | ä¸°å°æœºæˆ¿ | +-----+-----------------+ 3 rows in set (0.00 sec) mysql> update server_room set rid=5 where rid=3; ERROR 1451 (23000): Cannot delete or update a parent row: a foreign key constraint fails (`ppp`.`server`, CONSTRAINT `server_ibfk_1` FOREIGN KEY (`room_id`) REFERENCES `server_room` (`rid`)) 2.2 ä¸€å¯¹ä¸€ å…³è”æ–¹å¼ foreign key+unique è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³»æ˜¯ä¸€å¯¹ä¸€ ä¾‹å¦‚ï¼Œå…¬å¸ä¸­å‘˜å·¥ä¸å‘˜å·¥çš„ä¼ä¸šé‚®ç®±å°±æ˜¯ä¸€å¯¹ä¸€å…³ç³» 2.2.1ç¤ºä¾‹1ï¼Œå‘˜å·¥è¡¨ä¸ä¼ä¸šé‚®ç®±è¡¨ #åˆ›å»ºå‘˜å·¥è¡¨ mysql> create table employee( eid int primary key auto_increment, #å‘˜å·¥idï¼Œä¸»é”®ï¼Œè‡ªå¢ ename char(20) not null, #å‘˜å·¥å§“å sex enum('F','M'), #å‘˜å·¥æ€§åˆ« enterprise_mail_id int unique); #ä¼ä¸šé‚®ç®±idï¼Œä¸èƒ½é‡å¤ Query OK, 0 rows affected (0.03 sec) #åˆ›å»ºä¼ä¸šé‚®ç®±è¡¨ mysql> create table enterprise_mail( mid int primary key, #ä¼ä¸šé‚®ç®±idï¼Œä¸»é”® email char(50), #é‚®ç®±ä¿¡æ¯ employee_id int unique not null, #å‘˜å·¥idï¼Œä¸èƒ½é‡å¤ foreign key(employee_id) references employee(eid)); #ä¼ä¸šé‚®ç®±è¡¨ä¸­çš„å‘˜å·¥idæ˜¯å¤–é”®ï¼Œå…³è”å‘˜å·¥è¡¨ä¸­çš„å‘˜å·¥id Query OK, 0 rows affected (0.03 sec) //å‘å‘˜å·¥è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into employee(ename,sex,enterprise_mail_id) values -> ('å°æ˜','M',101), -> ('å°æ´²','M',102), -> ('å°é¢–','F',103); Query OK, 3 rows affected (0.00 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from employee; +-----+--------+------+--------------------+ | eid | ename | sex | enterprise_mail_id | +-----+--------+------+--------------------+ | 1 | å°æ˜ | M | 101 | | 2 | å°æ´² | M | 102 | | 3 | å°é¢– | F | 103 | +-----+--------+------+--------------------+ 3 rows in set (0.00 sec) //å‘ä¼ä¸šé‚®ç®±è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into enterprise_mail values (101,'xiaoming@testin.cn',1), (102,'xiaozhou@testin.cn',2), (103,'xiaoying@testin.cn',3); Query OK, 3 rows affected (0.01 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from enterprise_mail; +-----+--------------------+-------------+ | mid | email | employee_id | +-----+--------------------+-------------+ | 101 | xiaoming@testin.cn | 1 | | 102 | xiaozhou@testin.cn | 2 | | 103 | xiaoying@testin.cn | 3 | +-----+--------------------+-------------+ 3 rows in set (0.00 sec) //å°è¯•åˆ é™¤å‘˜å·¥è¡¨ä¸­çš„ä»»æ„ä¸€æ¡æ•°æ®ï¼Œå› ä¸ºæœ‰å¤–é”®çº¦æŸï¼Œå› æ­¤æ— æ³•åˆ é™¤ mysql> delete from employee where eid=1; ERROR 1451 (23000): Cannot delete or update a parent row: a foreign key constraint fails (`db1`.`enterprise_mail`, CONSTRAINT `enterprise_mail_ibfk_1` FOREIGN KEY (`employee_id`) REFERENCES `employee` (`eid`)) //å°è¯•åˆ é™¤ä¼ä¸šé‚®ç®±è¡¨ä¸­çš„ä»»æ„ä¸€æ¡æ•°æ® mysql> delete from enterprise_mail where mid=101; Query OK, 1 row affected (0.01 sec) 2.3 å¤šå¯¹å¤š å…³è”æ–¹å¼ å¤–é”®foreign key+ä¸€å¼ æ–°çš„è¡¨ è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³»æ˜¯å¤šå¯¹å¤š ä¾‹å¦‚ï¼Œä¸€æœ¬ä¹¦å¯ä»¥æœ‰å¤šä¸ªä½œè€…ï¼Œä¸€ä¸ªä½œè€…å¯ä»¥å†™å¤šæœ¬ä¹¦ 2.3.1ç¤ºä¾‹1ï¼Œä¹¦ç±è¡¨ã€ä½œè€…è¡¨ã€å…³è”ä¹¦ç±è¡¨ä¸ä½œè€…è¡¨çš„ç¬¬3å¼ è¡¨ #åˆ›å»ºä¹¦ç±è¡¨ mysql> create table book( bid int primary key auto_increment, bname char(20) not null); Query OK, 0 rows affected (0.02 sec) #åˆ›å»ºä½œè€…è¡¨ mysql> create table author( aid int primary key auto_increment, aname char(20) not null); Query OK, 0 rows affected (0.03 sec) #åˆ›å»ºå…³è”ä¹¦ç±ä¸ä½œè€…è¡¨ï¼Œè¡¨ä¸­æœ‰ä¹¦ç±idå’Œä½œè€…idï¼Œåˆ†åˆ«ä½œä¸ºä¹¦ç±è¡¨ä¸­bidå’Œä½œè€…è¡¨ä¸­aidçš„å¤–é”® mysql> create table book_and_author( book_id int not null, author_id int not null, foreign key(book_id) references book(bid), foreign key(author_id) references author(aid)); Query OK, 0 rows affected (0.03 sec) //å‘ä¹¦ç±è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into book(bname) values('ç«¥è¯æ•…äº‹'),('é‚£ä¸ªå¥³å­©'),('ä¸Šè¯¾å¿…å¤‡ä¸‰ä»¶å¥—'); Query OK, 3 rows affected (0.00 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from book; +-----+-----------------------+ | bid | bname | +-----+-----------------------+ | 1 | ç«¥è¯æ•…äº‹ | | 2 | é‚£ä¸ªå¥³å­© | | 3 | ä¸Šè¯¾å¿…å¤‡ä¸‰ä»¶å¥— | +-----+-----------------------+ 3 rows in set (0.00 sec) //å‘ä½œè€…è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into author(aname) values('ä½œè€…å°æ˜'),('ä½œè€…å°ä¸½'),('ä½œè€…å°æ´²'); Query OK, 3 rows affected (0.01 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> select * from author; +-----+--------------+ | aid | aname | +-----+--------------+ | 1 | ä½œè€…å°æ˜ | | 2 | ä½œè€…å°ä¸½ | | 3 | ä½œè€…å°æ´² | +-----+--------------+ 3 rows in set (0.00 sec) //å‘å…³è”è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into book_and_author values(1,1),(1,2),(2,2),(2,3),(3,1),(3,3); Query OK, 6 rows affected (0.00 sec) Records: 6 Duplicates: 0 Warnings: 0 mysql> select * from book_and_author; +---------+-----------+ | book_id | author_id | +---------+-----------+ | 1 | 1 | #ç«¥è¯æ•…äº‹çš„ä½œè€…æ˜¯å°æ˜ | 1 | 2 | #ç«¥è¯æ•…äº‹çš„ä½œè€…æ˜¯å°ä¸½ | 2 | 2 | #é‚£ä¸ªå¥³å­©çš„ä½œè€…æ˜¯å°ä¸½ | 2 | 3 | #é‚£ä¸ªå¥³å­©çš„ä½œè€…æ˜¯å°æ´² | 3 | 1 | #ä¸Šè¯¾å¿…å¤‡ä¸‰ä»¶å¥—çš„ä½œè€…æ˜¯å°æ˜ | 3 | 3 | #ä¸Šè¯¾å¿…å¤‡ä¸‰ä»¶å¥—çš„ä½œè€…æ˜¯å°æ´² +---------+-----------+ 6 rows in set (0.00 sec) è¿™ä¸ªå…³è”ä¹¦ç±è¡¨ä¸ä½œè€…è¡¨çš„å…³è”è¡¨ä¸­å°±æ˜¯ä¸€ä¸ªä½œè€…å†™äº†å¤šæœ¬ä¹¦ï¼Œä¸€æœ¬ä¹¦æœ‰å¤šä¸ªä½œè€… //é”™è¯¯ç¤ºèŒƒï¼Œå°è¯•åˆ é™¤ä¹¦ç±è¡¨ä¸ä½œè€…è¡¨ä¸­çš„ä»»æ„ä¸€æ¡æ•°æ® mysql> delete from book where bid=1; ERROR 1451 (23000): Cannot delete or update a parent row: a foreign key constraint fails (`db1`.`book_and_author`, CONSTRAINT `book_and_author_ibfk_1` FOREIGN KEY (`book_id`) REFERENCES `book` (`bid`)) mysql> delete from author where aid=3; ERROR 1451 (23000): Cannot delete or update a parent row: a foreign key constraint fails (`db1`.`book_and_author`, CONSTRAINT `book_and_author_ibfk_2` FOREIGN KEY (`author_id`) REFERENCES `author` (`aid`)) //åˆ é™¤å…³è”è¡¨ä¸­çš„æ•°æ®ï¼Œæ˜¯å¯ä»¥åˆ é™¤çš„ï¼Œå› ä¸ºè¿™åªæ˜¯ä¸€ä¸ªå…³è”è¡¨ï¼Œåˆ é™¤äº†å…³è”idï¼Œåªæ˜¯æŠŠåŸæ¥ä¸¤å¼ è¡¨çš„å…³è”å…³ç³»åˆ é™¤äº† è¿™é‡Œåˆ é™¤äº†å…³è”è¡¨ä¸­çš„å›¾ä¹¦idï¼Œè¿™æ ·å°±æ˜¯åŸæ¥çš„å›¾ä¹¦è¡¨ä¸­ä¸º1çš„ä¹¦æ‰¾ä¸åˆ°å¯¹åº”çš„ä½œè€…äº† mysql> delete from book_and_author where book_id=1; Query OK, 2 rows affected (0.01 sec) mysql> select * from book_and_author; +---------+-----------+ | book_id | author_id | +---------+-----------+ | 2 | 2 | | 2 | 3 | | 3 | 1 | | 3 | 3 | +---------+-----------+ 4 rows in set (0.00 sec) //åˆ é™¤å…³è”idåå°±å¯ä»¥åˆ é™¤åŸå…ˆä¸èƒ½åˆ é™¤çš„å›¾ä¹¦æˆ–è€…ä½œè€…idäº† mysql> delete from book where bid=1; Query OK, 1 row affected (0.00 sec) //å…³è”idä¸º2çš„æ²¡æœ‰åˆ é™¤ï¼Œå› æ­¤ä¸èƒ½åˆ é™¤å›¾ä¹¦è¡¨ä¸­bidä¸º2çš„ mysql> delete from book where bid=2; ERROR 1451 (23000): Cannot delete or update a parent row: a foreign key constraint fails (`db1`.`book_and_author`, CONSTRAINT `book_and_author_ibfk_1` FOREIGN KEY (`book_id`) REFERENCES `book` (`bid`)) æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/12.mysqlå…³é”®å­—å’Œsqlè¯­å¥æ‰§è¡Œé¡ºåº.html":{"url":"db/mysql/mysqlåŸºç¡€/12.mysqlå…³é”®å­—å’Œsqlè¯­å¥æ‰§è¡Œé¡ºåº.html","title":"7.mysqlå…³é”®å­—å’Œsqlè¯­å¥æ‰§è¡Œé¡ºåº","keywords":"","body":"mysqlå…³é”®å­—å’Œsqlè¯­å¥æ‰§è¡Œé¡ºåº 1.mysqlå…³é”®å­— å…³é”®å­— å«ä¹‰ not null éç©º primary key ä¸»é”®(å”¯ä¸€ä¸”éç©º) foreign key å¤–é”® unique å”¯ä¸€é”® auto_increment è‡ªå¢(æ­¤åˆ—å¿…é¡»æ˜¯ä¸»é”®æˆ–è€…å”¯ä¸€é”®) default é»˜è®¤å€¼ unsigned éè´Ÿæ•° comment æ³¨é‡Šè¯´æ˜ distinct å»é‡ limit é™åˆ¶ having è¿‡æ»¤ group by åˆ†ç»„ order by æ’åº(é»˜è®¤å‡åºï¼ŒåŠ descé™åº) like whereæ¡ä»¶ä¸­ä½¿ç”¨ï¼Œä¸%é…åˆä½¿ç”¨ï¼Œè¡¨ç¤ºæ¨¡ç³ŠåŒ¹é… in whereæ¡ä»¶ä¸­ä½¿ç”¨ï¼ŒæŸ¥è¯¢èŒƒå›´å†…çš„æ•°æ® 2.sqlè¯­å¥æ‰§è¡Œé¡ºåº å•è¡¨æŸ¥è¯¢è¯­å¥ è¯­å¥ å«ä¹‰ select dictinct å­—æ®µå å»é‡ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°ï¼Œå››åˆ™è¿ç®—ï¼Œé‡å‘½å from è¡¨å as åˆ«å æŸ¥è¯¢çš„æ—¶å€™ä¸´æ—¶ä¿®æ”¹è¡¨å where æ¡ä»¶ æ¡ä»¶å¯ä»¥ç”¨æ¯”è¾ƒè¿ç®—ï¼Œé€»è¾‘è¿ç®—ï¼Œlikeï¼Œin group by æ ¹æ®æŸä¸ªå­—æ®µä¸€è‡´çš„é¡¹è¿›è¡Œåˆ†ç»„ having è¿‡æ»¤ï¼Œå¯ä»¥ä½¿ç”¨èšåˆå‡½æ•°ï¼Œåœ¨åˆ†ç»„ä¹‹åå¯¹æ•°æ® order by å­—æ®µ æ’åºï¼Œé»˜è®¤å‡åºï¼Œdescé™åº limit m,n ä»m+1å¼€å§‹å–næ¡ï¼Œmé»˜è®¤ä¸º0 æ‰§è¡Œé¡ºåº 1.from 2.where 3.group by 4.having 5.select 6.distinct 7.order by 8.limit æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/13.selecté«˜çº§ç”¨æ³•.html":{"url":"db/mysql/mysqlåŸºç¡€/13.selecté«˜çº§ç”¨æ³•.html","title":"8.selecté«˜çº§ç”¨æ³•","keywords":"","body":"selecté«˜çº§ç”¨æ³• ä¸€ã€å¤šè¡¨è¿æ¥æŸ¥è¯¢ select è¡¨1.åˆ—å,è¡¨2.åˆ—å from è¡¨1,è¡¨2 where è¡¨1.åˆ—1=è¡¨2.åˆ—1 and è¡¨1.åˆ—2=å€¼ 1.1åˆ›å»ºä¸¤å¼ è¡¨ mysql> create table t1(id int,name char(20)); Query OK, 0 rows affected (0.02 sec) mysql> create table t2(id int,age tinyint); Query OK, 0 rows affected (0.02 sec) 1.2å‘è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into t1 values(1,'aaa'),(2,'bbb'),(3,'ccc'); Query OK, 3 rows affected (0.01 sec) Records: 3 Duplicates: 0 Warnings: 0 mysql> insert into t2 values(1,25),(2,26),(3,27); Query OK, 3 rows affected (0.00 sec) Records: 3 Duplicates: 0 Warnings: 0 1.3æŸ¥è¯¢t1ã€t2è¡¨ä¸­idä¸º1çš„äººçš„å¹´é¾„ mysql> select t1.name,t2.age from t1,t2 where t1.id=t2.id and t1.id=1; +------+------+ | name | age | +------+------+ | aaa | 25 | +------+------+ 1 row in set (0.00 sec) äºŒã€sql joinè¿æ¥ 2.1sql joinè¿æ¥ç¤ºæ„å›¾ ä¸‹å›¾å±•ç¤ºäº† LEFT JOINã€RIGHT JOINã€INNER JOINã€OUTER JOIN ç›¸å…³çš„ 7 ç§ç”¨æ³• 2.2sqlæ•°æ®å‡†å¤‡ 2.2.1åˆ›å»ºä¸€ä¸ªäººåè¡¨å’Œåœ°å€è¡¨ 1.åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ mysql> create database DB1 charset utf8 collate=utf8_general_ci; Query OK, 1 row affected (0.01 sec) 2.åˆ›å»ºäººåè¡¨ mysql> create table person(person_id int,name varchar(20)); Query OK, 0 rows affected (0.02 sec) 3.åˆ›å»ºåœ°å€è¡¨ mysql> create table address(address_id int,person_id int,city varchar(20)); Query OK, 0 rows affected (0.02 sec) 2.2.2å‘è¡¨ä¸­æ’å…¥æ•°æ® 1.å‘äººåè¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into person values(1,'å¼ ä¸‰'),(2,'æå››'),(3,'ç‹äº”'),(4,'æ¨å…­'); Query OK, 4 rows affected (0.01 sec) Records: 4 Duplicates: 0 Warnings: 0 2.å‘åœ°å€è¡¨ä¸­æ’å…¥æ•°æ® mysql> insert into address values(1,1,'åŒ—äº¬'),(2,2,'ä¸Šæµ·'),(3,3,'å¹¿å·'),(5,5,'æ­å·'); Query OK, 4 rows affected (0.01 sec) Records: 4 Duplicates: 0 Warnings: 0 2.2.3æŸ¥çœ‹è¡¨ä¿¡æ¯ //äººåè¡¨ mysql> select * from person; +-----------+--------+ | person_id | name | +-----------+--------+ | 1 | å¼ ä¸‰ | | 2 | æå›› | | 3 | ç‹äº” | | 4 | æ¨å…­ | +-----------+--------+ 4 rows in set (0.01 sec) //åœ°å€è¡¨ mysql> select * from address; +------------+-----------+--------+ | address_id | person_id | city | +------------+-----------+--------+ | 1 | 1 | åŒ—äº¬ | | 2 | 2 | ä¸Šæµ· | | 3 | 3 | å¹¿å· | | 5 | 5 | æ­å· | +------------+-----------+--------+ 4 rows in set (0.00 sec) 2.3sql joinè¿æ¥æŸ¥è¯¢ç¤ºä¾‹ 2.3.1ä¼ ç»Ÿè¿æ¥ä¸JOIN ON //ä½¿ç”¨DB1åº“ mysql> use DB1; Database changed //æŸ¥è¯¢å¼ ä¸‰çš„åœ°å€ ä¼ ç»Ÿè¿æ¥ mysql> select person.name,address.city from person,address where person.name='å¼ ä¸‰' and person.person_id=address.person_id; +--------+--------+ | name | city | +--------+--------+ | å¼ ä¸‰ | åŒ—äº¬ | +--------+--------+ 1 row in set (0.01 sec) //æŸ¥è¯¢å¼ ä¸‰çš„åœ°å€ JOIN ONè¿æ¥ mysql> select person.name,address.city from person join address on(person.person_id=address.person_id) where person.name='å¼ ä¸‰'; +--------+--------+ | name | city | +--------+--------+ | å¼ ä¸‰ | åŒ—äº¬ | +--------+--------+ 1 row in set (0.00 sec) âš ï¸ä¼ ç»Ÿè¿æ¥ä¸JOIN ONæŸ¥è¯¢çš„ç»“æœæ˜¯ä¸€æ ·çš„ 2.3.2è‡ªè¿æ¥ NATURAL JOIN è‡ªç„¶è¿æ¥:æ ¹æ®è¿æ¥çš„ä¸¤ä¸ªè¡¨ä¸­çš„å…¬å…±åˆ—ä¸ºæ‚¨åˆ›å»ºéšå¼è¿æ¥å­å¥ã€‚å…¬å…±åˆ—æ˜¯ä¸¤ä¸ªè¡¨ä¸­åç§°ç›¸åŒçš„åˆ—ã€‚è‡ªç„¶è¿æ¥å¯ä»¥æ˜¯å†…è¿æ¥ã€å·¦å¤–è¿æ¥æˆ–å³å¤–è¿æ¥ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯å†…éƒ¨è¿æ¥ã€‚ è‡ªè¿æ¥çš„è¡¨è¦æœ‰å…±åŒçš„åˆ—åå­—ï¼Œpersonè¡¨å’Œaddressè¡¨ä¸­éƒ½æœ‰åˆ—person_id //æŸ¥è¯¢å¼ ä¸‰çš„åœ°å€ mysql> select person.name,address.city from person natural join address where person.name='å¼ ä¸‰'; +--------+--------+ | name | city | +--------+--------+ | å¼ ä¸‰ | åŒ—äº¬ | +--------+--------+ 1 row in set (0.00 sec) 2.3.3å†…è¿æ¥ INNER JOIN INNER JOIN å…³é”®å­—åœ¨è¡¨ä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ªåŒ¹é…æ—¶è¿”å›è¡Œã€‚ //personè¡¨ä¸­å’Œaddressè¡¨ä¸­ç›¸åŒçš„idåˆ— mysql> select * from person inner join address on person.person_id=address.address_id; +-----------+--------+------------+-----------+--------+ | person_id | name | address_id | person_id | city | +-----------+--------+------------+-----------+--------+ | 1 | å¼ ä¸‰ | 1 | 1 | åŒ—äº¬ | | 2 | æå›› | 2 | 2 | ä¸Šæµ· | | 3 | ç‹äº” | 3 | 3 | å¹¿å· | +-----------+--------+------------+-----------+--------+ 3 rows in set (0.00 sec) 2.3.4å·¦å¤–è¿æ¥ LEFT JOIN ON å·¦å¤–è¿æ¥:ä»å·¦è¡¨è¿”å›æ‰€æœ‰çš„è¡Œ(è¡¨1),ä¸æ­£ç¡®çš„åŒ¹é…è¡Œ(è¡¨2)ã€‚å½“æ²¡æœ‰åŒ¹é…æ—¶ï¼Œå³è¾¹çš„ç»“æœä¸ºNULLã€‚ select æŸ¥è¯¢å†…å®¹ from å·¦è¡¨ left join å³è¡¨ on å·¦è¡¨.åˆ—=å³è¡¨.åˆ— //äººåè¡¨personä¸ºå·¦è¡¨ï¼Œåœ°å€è¡¨addressä¸ºå³è¡¨ å·¦å¤–è¿æ¥ mysql> select * from person left join address on person.person_id=address.person_id; +-----------+--------+------------+-----------+--------+ | person_id | name | address_id | person_id | city | +-----------+--------+------------+-----------+--------+ | 1 | å¼ ä¸‰ | 1 | 1 | åŒ—äº¬ | | 2 | æå›› | 2 | 2 | ä¸Šæµ· | | 3 | ç‹äº” | 3 | 3 | å¹¿å· | | 4 | æ¨å…­ | NULL | NULL | NULL | +-----------+--------+------------+-----------+--------+ 4 rows in set (0.01 sec) //åœ°å€è¡¨addressä¸ºå·¦è¡¨ï¼Œäººåè¡¨personä½å³è¡¨ å³å¤–è¿æ¥ mysql> select * from address right join person on person.person_id=address.person_id; +------------+-----------+--------+-----------+--------+ | address_id | person_id | city | person_id | name | +------------+-----------+--------+-----------+--------+ | 1 | 1 | åŒ—äº¬ | 1 | å¼ ä¸‰ | | 2 | 2 | ä¸Šæµ· | 2 | æå›› | | 3 | 3 | å¹¿å· | 3 | ç‹äº” | | NULL | NULL | NULL | 4 | æ¨å…­ | +------------+-----------+--------+-----------+--------+ 4 rows in set (0.00 sec) 2.3.5å³å¤–è¿æ¥ RIGHT JOIN ON å³å¤–è¿æ¥:è¿”å›å³è¡¨(è¡¨2)ä¸­çš„æ‰€æœ‰è¡Œï¼Œä»¥åŠå·¦è¡¨(è¡¨1)ä¸­çš„åŒ¹é…è¡Œã€‚å½“æ²¡æœ‰åŒ¹é…æ—¶ï¼Œå·¦è¾¹çš„ç»“æœä¸ºNULLã€‚ select æŸ¥è¯¢å†…å®¹ from å·¦è¡¨ right join å³è¡¨ on å³è¡¨.åˆ—=å·¦è¡¨.åˆ— //äººåè¡¨personä¸ºå·¦è¡¨ï¼Œåœ°å€è¡¨addressä¸ºå³è¡¨ mysql> select * from person right join address on person.person_id=address.person_id; +-----------+--------+------------+-----------+--------+ | person_id | name | address_id | person_id | city | +-----------+--------+------------+-----------+--------+ | 1 | å¼ ä¸‰ | 1 | 1 | åŒ—äº¬ | | 2 | æå›› | 2 | 2 | ä¸Šæµ· | | 3 | ç‹äº” | 3 | 3 | å¹¿å· | | NULL | NULL | 5 | 5 | æ­å· | +-----------+--------+------------+-----------+--------+ 4 rows in set (0.00 sec) //addressè¡¨ä¸ºå·¦è¡¨ï¼Œpersonè¡¨ä¸ºå³è¡¨ mysql> select * from address left join person on person.person_id=address.person_id; +------------+-----------+--------+-----------+--------+ | address_id | person_id | city | person_id | name | +------------+-----------+--------+-----------+--------+ | 1 | 1 | åŒ—äº¬ | 1 | å¼ ä¸‰ | | 2 | 2 | ä¸Šæµ· | 2 | æå›› | | 3 | 3 | å¹¿å· | 3 | ç‹äº” | | 5 | 5 | æ­å· | NULL | NULL | +------------+-----------+--------+-----------+--------+ 4 rows in set (0.00 sec) 2.3.6åˆå¹¶æŸ¥è¯¢ UNION UNION å»é‡å¤å¹¶åˆå¹¶ UNION ALL ä¸å»é‡ å…¨äº¤: è¿”å›å·¦è¡¨çš„æ‰€æœ‰è¡Œå’Œå³è¡¨çš„æ‰€æœ‰è¡Œï¼Œæ˜¯å·¦äº¤å’Œå³äº¤çš„è”åˆã€‚ æ³¨æ„ï¼Œç”±äºMySqlä¸­æ²¡æœ‰Full Joinå‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡æŠŠLeft Joinå’ŒRight Joinçš„ç»“æœUnionèµ·æ¥ä¹Ÿæ˜¯å¯ä»¥çš„ï¼š //æŸ¥è¯¢åŸå¸‚ä¸ºåŒ—äº¬æˆ–ä¸Šæµ·çš„æ‰€æœ‰ä¿¡æ¯ mysql> select * from address where city='åŒ—äº¬' or city='ä¸Šæµ·'; +------------+-----------+--------+ | address_id | person_id | city | +------------+-----------+--------+ | 1 | 1 | åŒ—äº¬ | | 2 | 2 | ä¸Šæµ· | +------------+-----------+--------+ 2 rows in set (0.00 sec) æˆ– mysql> select * from address where city in ('åŒ—äº¬','ä¸Šæµ·'); +------------+-----------+--------+ | address_id | person_id | city | +------------+-----------+--------+ | 1 | 1 | åŒ—äº¬ | | 2 | 2 | ä¸Šæµ· | +------------+-----------+--------+ 2 rows in set (0.01 sec) //unionåˆå¹¶æŸ¥è¯¢æ•ˆç‡æœ€é«˜ mysql> select * from address where city='åŒ—äº¬' union select * from address where city='ä¸Šæµ·'; +------------+-----------+--------+ | address_id | person_id | city | +------------+-----------+--------+ | 1 | 1 | åŒ—äº¬ | | 2 | 2 | ä¸Šæµ· | +------------+-----------+--------+ 2 rows in set (0.00 sec) æˆ– mysql> select * from address where city='åŒ—äº¬' union all select * from address where city='ä¸Šæµ·'; +------------+-----------+--------+ | address_id | person_id | city | +------------+-----------+--------+ | 1 | 1 | åŒ—äº¬ | | 2 | 2 | ä¸Šæµ· | +------------+-----------+--------+ 2 rows in set (0.00 sec) æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/14.mysqlå­—ç¬¦é›†.html":{"url":"db/mysql/mysqlåŸºç¡€/14.mysqlå­—ç¬¦é›†.html","title":"9.mysqlå­—ç¬¦é›†","keywords":"","body":"mysqlå­—ç¬¦é›† 1.å­—ç¬¦é›†å®šä¹‰ å­—ç¬¦é›†(charset)ï¼šæ˜¯ä¸€ä¸ªç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰æŠ½è±¡å­—ç¬¦çš„é›†åˆã€‚å­—ç¬¦æ˜¯å„ç§æ–‡å­—å’Œç¬¦å·çš„æ€»ç§°ï¼Œ åŒ…æ‹¬å„å›½å®¶æ–‡å­—ã€æ ‡ç‚¹ç¬¦å·ã€å›¾å½¢ç¬¦å·ã€æ•°å­—ç­‰ 2.mysqlæ•°æ®åº“çš„å­—ç¬¦é›† 1.å­—ç¬¦é›† charset 2.æ ¡å¯¹è§„åˆ™ collation 3.mysqlä¸­å¸¸è§çš„å­—ç¬¦é›† ASCIIå­—ç¬¦é›† 1.ä¸€å…±128ä¸ªå­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼ã€æ ‡ç‚¹ç¬¦å·ã€æ•°å­—ã€å¤§å°å†™å­—æ¯å’Œä¸€äº›ä¸å¯è§å­—ç¬¦ 2.æ¯ä¸ªå­—ç¬¦ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚ç¼–ç --ä¸€ä¸ªå­—èŠ‚æ˜¯8ä½ï¼Œä¸€å…±æœ‰256ä¸ªç¼–ç æ–¹å¼è¶³ä»¥æ‰¿æ‹…128ä¸ª ISO 8859-1å­—ç¬¦é›†-latin1 1.ä¸€å…±256ä¸ªå­—ç¬¦ï¼Œè¶³ä»¥ç”¨ä¸€ä¸ªå­—èŠ‚æ ‡è¯†ã€‚ 2.å…±æ”¶å½•256ä¸ªå­—ç¬¦ï¼Œæ˜¯åœ¨ASCIIå­—ç¬¦é›†çš„åŸºç¡€ä¸Šåˆæ‰©å……äº†128ä¸ªè¥¿æ¬§å¸¸ç”¨å­—ç¬¦ GB2312å­—ç¬¦é›† 1.æ”¶å½•äº†æ±‰å­—ä»¥åŠæ‹‰ä¸å­—æ¯ã€å¸Œè…Šå­—æ¯ã€æ—¥æ–‡å¹³å‡ååŠç‰‡å‡åå­—æ¯ã€ä¿„è¯­è¥¿é‡Œå°”å­—æ¯ 2.åŒæ—¶è¿™ç§å­—ç¬¦é›†åˆå…¼å®¹ASCIIå­—ç¬¦é›† 3.å¦‚æœè¯¥å­—ç¬¦åœ¨ASCIIå­—ç¬¦é›†ä¸­ï¼Œåˆ™é‡‡ç”¨1å­—èŠ‚ç¼–ç ã€‚å¦åˆ™é‡‡ç”¨2å­—èŠ‚ç¼–ç ã€‚ 4.ç±»ä¼¼è¿™ç§ä¸€ä¸ªå­—ç¬¦éœ€è¦çš„å­—èŠ‚æ•°ä¸åŒç§°ä¸ºè¾¹é•¿ç¼–ç  GBKå­—ç¬¦é›† GBKå­—ç¬¦é›†åªæ˜¯åœ¨æ”¶å½•å­—ç¬¦èŒƒå›´ä¸Šå¯¹GB2312å­—ç¬¦é›†ä½œäº†æ‰©å……ï¼Œç¼–ç æ–¹å¼ä¸Šå…¼å®¹GB2312 utf8å­—ç¬¦é›† 1.æ”¶å½•åœ°çƒä¸Šèƒ½æƒ³åˆ°çš„æ‰€æœ‰å­—ç¬¦ï¼Œè€Œä¸”è¿˜åœ¨ä¸æ–­æ‰©å……ã€‚è¿™ç§å­—ç¬¦é›†å…¼å®¹ASCIIå­—ç¬¦é›†ï¼Œé‡‡ç”¨å˜é•¿ç¼–ç æ–¹å¼ï¼Œç¼–ç ä¸€ä¸ªå­—ç¬¦éœ€è¦ä½¿ç”¨1ï½4ä¸ªå­—èŠ‚ 2.å…¼å®¹ASCII 3.utf8åªæ˜¯Unicodeå­—ç¬¦é›†çš„ä¸€ç§ç¼–ç æ–¹æ¡ˆï¼ŒUnicodeå­—ç¬¦é›†å¯ä»¥é‡‡ç”¨utf8ã€utf16ã€utf32è¿™å‡ ç§ç¼–ç æ–¹æ¡ˆï¼Œutf8ä½¿ç”¨1ï½4ä¸ªå­—èŠ‚ç¼–ç ä¸€ä¸ªå­—ç¬¦ï¼Œutf16ä½¿ç”¨2ä¸ªæˆ–4ä¸ªå­—èŠ‚ç¼–ç ä¸€ä¸ªå­—ç¬¦ï¼Œutf32ä½¿ç”¨4ä¸ªå­—èŠ‚ç¼–ç ä¸€ä¸ªå­—ç¬¦ã€‚ 4.mysqlå¸¸è§æ ¡å¯¹è§„åˆ™ 1.ciï¼šå¤§å°å†™ä¸æ•æ„Ÿ 2.csæˆ–binï¼šå¤§å°å†™æ•æ„Ÿ ç¤ºä¾‹ create database DB1 charset utf8 collate=utf8_general_ci 5.æŸ¥çœ‹å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™ æŸ¥çœ‹å­—ç¬¦é›†(mysql5.7) mysql> show charset; +----------+---------------------------------+---------------------+--------+ | Charset | Description | Default collation | Maxlen | +----------+---------------------------------+---------------------+--------+ | big5 | Big5 Traditional Chinese | big5_chinese_ci | 2 | | dec8 | DEC West European | dec8_swedish_ci | 1 | | cp850 | DOS West European | cp850_general_ci | 1 | | hp8 | HP West European | hp8_english_ci | 1 | | koi8r | KOI8-R Relcom Russian | koi8r_general_ci | 1 | | latin1 | cp1252 West European | latin1_swedish_ci | 1 | | latin2 | ISO 8859-2 Central European | latin2_general_ci | 1 | | swe7 | 7bit Swedish | swe7_swedish_ci | 1 | | ascii | US ASCII | ascii_general_ci | 1 | | ujis | EUC-JP Japanese | ujis_japanese_ci | 3 | | sjis | Shift-JIS Japanese | sjis_japanese_ci | 2 | | hebrew | ISO 8859-8 Hebrew | hebrew_general_ci | 1 | | tis620 | TIS620 Thai | tis620_thai_ci | 1 | | euckr | EUC-KR Korean | euckr_korean_ci | 2 | | koi8u | KOI8-U Ukrainian | koi8u_general_ci | 1 | | gb2312 | GB2312 Simplified Chinese | gb2312_chinese_ci | 2 | | greek | ISO 8859-7 Greek | greek_general_ci | 1 | | cp1250 | Windows Central European | cp1250_general_ci | 1 | | gbk | GBK Simplified Chinese | gbk_chinese_ci | 2 | | latin5 | ISO 8859-9 Turkish | latin5_turkish_ci | 1 | | armscii8 | ARMSCII-8 Armenian | armscii8_general_ci | 1 | | utf8 | UTF-8 Unicode | utf8_general_ci | 3 | | ucs2 | UCS-2 Unicode | ucs2_general_ci | 2 | | cp866 | DOS Russian | cp866_general_ci | 1 | | keybcs2 | DOS Kamenicky Czech-Slovak | keybcs2_general_ci | 1 | | macce | Mac Central European | macce_general_ci | 1 | | macroman | Mac West European | macroman_general_ci | 1 | | cp852 | DOS Central European | cp852_general_ci | 1 | | latin7 | ISO 8859-13 Baltic | latin7_general_ci | 1 | | utf8mb4 | UTF-8 Unicode | utf8mb4_general_ci | 4 | | cp1251 | Windows Cyrillic | cp1251_general_ci | 1 | | utf16 | UTF-16 Unicode | utf16_general_ci | 4 | | utf16le | UTF-16LE Unicode | utf16le_general_ci | 4 | | cp1256 | Windows Arabic | cp1256_general_ci | 1 | | cp1257 | Windows Baltic | cp1257_general_ci | 1 | | utf32 | UTF-32 Unicode | utf32_general_ci | 4 | | binary | Binary pseudo charset | binary | 1 | | geostd8 | GEOSTD8 Georgian | geostd8_general_ci | 1 | | cp932 | SJIS for Windows Japanese | cp932_japanese_ci | 2 | | eucjpms | UJIS for Windows Japanese | eucjpms_japanese_ci | 3 | | gb18030 | China National Standard GB18030 | gb18030_chinese_ci | 4 | +----------+---------------------------------+---------------------+--------+ 41 rows in set (0.00 sec) æŸ¥çœ‹æ ¡å¯¹è§„åˆ™ mysql> show collation; +--------------------------+----------+-----+---------+----------+---------+ | Collation | Charset | Id | Default | Compiled | Sortlen | +--------------------------+----------+-----+---------+----------+---------+ | big5_chinese_ci | big5 | 1 | Yes | Yes | 1 | | big5_bin | big5 | 84 | | Yes | 1 | | dec8_swedish_ci | dec8 | 3 | Yes | Yes | 1 | | dec8_bin | dec8 | 69 | | Yes | 1 | | cp850_general_ci | cp850 | 4 | Yes | Yes | 1 | | cp850_bin | cp850 | 80 | | Yes | 1 | | hp8_english_ci | hp8 | 6 | Yes | Yes | 1 | | hp8_bin | hp8 | 72 | | Yes | 1 | | koi8r_general_ci | koi8r | 7 | Yes | Yes | 1 | | koi8r_bin | koi8r | 74 | | Yes | 1 | | latin1_german1_ci | latin1 | 5 | | Yes | 1 | | latin1_swedish_ci | latin1 | 8 | Yes | Yes | 1 | | latin1_danish_ci | latin1 | 15 | | Yes | 1 | | latin1_german2_ci | latin1 | 31 | | Yes | 2 | | latin1_bin | latin1 | 47 | | Yes | 1 | | latin1_general_ci | latin1 | 48 | | Yes | 1 | | latin1_general_cs | latin1 | 49 | | Yes | 1 | | latin1_spanish_ci | latin1 | 94 | | Yes | 1 | | latin2_czech_cs | latin2 | 2 | | Yes | 4 | | latin2_general_ci | latin2 | 9 | Yes | Yes | 1 | | latin2_hungarian_ci | latin2 | 21 | | Yes | 1 | | latin2_croatian_ci | latin2 | 27 | | Yes | 1 | | latin2_bin | latin2 | 77 | | Yes | 1 | | swe7_swedish_ci | swe7 | 10 | Yes | Yes | 1 | | swe7_bin | swe7 | 82 | | Yes | 1 | | ascii_general_ci | ascii | 11 | Yes | Yes | 1 | | ascii_bin | ascii | 65 | | Yes | 1 | | ujis_japanese_ci | ujis | 12 | Yes | Yes | 1 | | ujis_bin | ujis | 91 | | Yes | 1 | | sjis_japanese_ci | sjis | 13 | Yes | Yes | 1 | | sjis_bin | sjis | 88 | | Yes | 1 | | hebrew_general_ci | hebrew | 16 | Yes | Yes | 1 | | hebrew_bin | hebrew | 71 | | Yes | 1 | | tis620_thai_ci | tis620 | 18 | Yes | Yes | 4 | | tis620_bin | tis620 | 89 | | Yes | 1 | | euckr_korean_ci | euckr | 19 | Yes | Yes | 1 | | euckr_bin | euckr | 85 | | Yes | 1 | | koi8u_general_ci | koi8u | 22 | Yes | Yes | 1 | | koi8u_bin | koi8u | 75 | | Yes | 1 | | gb2312_chinese_ci | gb2312 | 24 | Yes | Yes | 1 | | gb2312_bin | gb2312 | 86 | | Yes | 1 | | greek_general_ci | greek | 25 | Yes | Yes | 1 | | greek_bin | greek | 70 | | Yes | 1 | | cp1250_general_ci | cp1250 | 26 | Yes | Yes | 1 | | cp1250_czech_cs | cp1250 | 34 | | Yes | 2 | | cp1250_croatian_ci | cp1250 | 44 | | Yes | 1 | | cp1250_bin | cp1250 | 66 | | Yes | 1 | | cp1250_polish_ci | cp1250 | 99 | | Yes | 1 | | gbk_chinese_ci | gbk | 28 | Yes | Yes | 1 | | gbk_bin | gbk | 87 | | Yes | 1 | | latin5_turkish_ci | latin5 | 30 | Yes | Yes | 1 | | latin5_bin | latin5 | 78 | | Yes | 1 | | armscii8_general_ci | armscii8 | 32 | Yes | Yes | 1 | | armscii8_bin | armscii8 | 64 | | Yes | 1 | | utf8_general_ci | utf8 | 33 | Yes | Yes | 1 | | utf8_bin | utf8 | 83 | | Yes | 1 | | utf8_unicode_ci | utf8 | 192 | | Yes | 8 | | utf8_icelandic_ci | utf8 | 193 | | Yes | 8 | | utf8_latvian_ci | utf8 | 194 | | Yes | 8 | | utf8_romanian_ci | utf8 | 195 | | Yes | 8 | | utf8_slovenian_ci | utf8 | 196 | | Yes | 8 | | utf8_polish_ci | utf8 | 197 | | Yes | 8 | | utf8_estonian_ci | utf8 | 198 | | Yes | 8 | | utf8_spanish_ci | utf8 | 199 | | Yes | 8 | | utf8_swedish_ci | utf8 | 200 | | Yes | 8 | | utf8_turkish_ci | utf8 | 201 | | Yes | 8 | | utf8_czech_ci | utf8 | 202 | | Yes | 8 | | utf8_danish_ci | utf8 | 203 | | Yes | 8 | | utf8_lithuanian_ci | utf8 | 204 | | Yes | 8 | | utf8_slovak_ci | utf8 | 205 | | Yes | 8 | | utf8_spanish2_ci | utf8 | 206 | | Yes | 8 | | utf8_roman_ci | utf8 | 207 | | Yes | 8 | | utf8_persian_ci | utf8 | 208 | | Yes | 8 | | utf8_esperanto_ci | utf8 | 209 | | Yes | 8 | | utf8_hungarian_ci | utf8 | 210 | | Yes | 8 | | utf8_sinhala_ci | utf8 | 211 | | Yes | 8 | | utf8_german2_ci | utf8 | 212 | | Yes | 8 | | utf8_croatian_ci | utf8 | 213 | | Yes | 8 | | utf8_unicode_520_ci | utf8 | 214 | | Yes | 8 | | utf8_vietnamese_ci | utf8 | 215 | | Yes | 8 | | utf8_general_mysql500_ci | utf8 | 223 | | Yes | 1 | | ucs2_general_ci | ucs2 | 35 | Yes | Yes | 1 | | ucs2_bin | ucs2 | 90 | | Yes | 1 | | ucs2_unicode_ci | ucs2 | 128 | | Yes | 8 | | ucs2_icelandic_ci | ucs2 | 129 | | Yes | 8 | | ucs2_latvian_ci | ucs2 | 130 | | Yes | 8 | | ucs2_romanian_ci | ucs2 | 131 | | Yes | 8 | | ucs2_slovenian_ci | ucs2 | 132 | | Yes | 8 | | ucs2_polish_ci | ucs2 | 133 | | Yes | 8 | | ucs2_estonian_ci | ucs2 | 134 | | Yes | 8 | | ucs2_spanish_ci | ucs2 | 135 | | Yes | 8 | | ucs2_swedish_ci | ucs2 | 136 | | Yes | 8 | | ucs2_turkish_ci | ucs2 | 137 | | Yes | 8 | | ucs2_czech_ci | ucs2 | 138 | | Yes | 8 | | ucs2_danish_ci | ucs2 | 139 | | Yes | 8 | | ucs2_lithuanian_ci | ucs2 | 140 | | Yes | 8 | | ucs2_slovak_ci | ucs2 | 141 | | Yes | 8 | | ucs2_spanish2_ci | ucs2 | 142 | | Yes | 8 | | ucs2_roman_ci | ucs2 | 143 | | Yes | 8 | | ucs2_persian_ci | ucs2 | 144 | | Yes | 8 | | ucs2_esperanto_ci | ucs2 | 145 | | Yes | 8 | | ucs2_hungarian_ci | ucs2 | 146 | | Yes | 8 | | ucs2_sinhala_ci | ucs2 | 147 | | Yes | 8 | | ucs2_german2_ci | ucs2 | 148 | | Yes | 8 | | ucs2_croatian_ci | ucs2 | 149 | | Yes | 8 | | ucs2_unicode_520_ci | ucs2 | 150 | | Yes | 8 | | ucs2_vietnamese_ci | ucs2 | 151 | | Yes | 8 | | ucs2_general_mysql500_ci | ucs2 | 159 | | Yes | 1 | | cp866_general_ci | cp866 | 36 | Yes | Yes | 1 | | cp866_bin | cp866 | 68 | | Yes | 1 | | keybcs2_general_ci | keybcs2 | 37 | Yes | Yes | 1 | | keybcs2_bin | keybcs2 | 73 | | Yes | 1 | | macce_general_ci | macce | 38 | Yes | Yes | 1 | | macce_bin | macce | 43 | | Yes | 1 | | macroman_general_ci | macroman | 39 | Yes | Yes | 1 | | macroman_bin | macroman | 53 | | Yes | 1 | | cp852_general_ci | cp852 | 40 | Yes | Yes | 1 | | cp852_bin | cp852 | 81 | | Yes | 1 | | latin7_estonian_cs | latin7 | 20 | | Yes | 1 | | latin7_general_ci | latin7 | 41 | Yes | Yes | 1 | | latin7_general_cs | latin7 | 42 | | Yes | 1 | | latin7_bin | latin7 | 79 | | Yes | 1 | | utf8mb4_general_ci | utf8mb4 | 45 | Yes | Yes | 1 | | utf8mb4_bin | utf8mb4 | 46 | | Yes | 1 | | utf8mb4_unicode_ci | utf8mb4 | 224 | | Yes | 8 | | utf8mb4_icelandic_ci | utf8mb4 | 225 | | Yes | 8 | | utf8mb4_latvian_ci | utf8mb4 | 226 | | Yes | 8 | | utf8mb4_romanian_ci | utf8mb4 | 227 | | Yes | 8 | | utf8mb4_slovenian_ci | utf8mb4 | 228 | | Yes | 8 | | utf8mb4_polish_ci | utf8mb4 | 229 | | Yes | 8 | | utf8mb4_estonian_ci | utf8mb4 | 230 | | Yes | 8 | | utf8mb4_spanish_ci | utf8mb4 | 231 | | Yes | 8 | | utf8mb4_swedish_ci | utf8mb4 | 232 | | Yes | 8 | | utf8mb4_turkish_ci | utf8mb4 | 233 | | Yes | 8 | | utf8mb4_czech_ci | utf8mb4 | 234 | | Yes | 8 | | utf8mb4_danish_ci | utf8mb4 | 235 | | Yes | 8 | | utf8mb4_lithuanian_ci | utf8mb4 | 236 | | Yes | 8 | | utf8mb4_slovak_ci | utf8mb4 | 237 | | Yes | 8 | | utf8mb4_spanish2_ci | utf8mb4 | 238 | | Yes | 8 | | utf8mb4_roman_ci | utf8mb4 | 239 | | Yes | 8 | | utf8mb4_persian_ci | utf8mb4 | 240 | | Yes | 8 | | utf8mb4_esperanto_ci | utf8mb4 | 241 | | Yes | 8 | | utf8mb4_hungarian_ci | utf8mb4 | 242 | | Yes | 8 | | utf8mb4_sinhala_ci | utf8mb4 | 243 | | Yes | 8 | | utf8mb4_german2_ci | utf8mb4 | 244 | | Yes | 8 | | utf8mb4_croatian_ci | utf8mb4 | 245 | | Yes | 8 | | utf8mb4_unicode_520_ci | utf8mb4 | 246 | | Yes | 8 | | utf8mb4_vietnamese_ci | utf8mb4 | 247 | | Yes | 8 | | cp1251_bulgarian_ci | cp1251 | 14 | | Yes | 1 | | cp1251_ukrainian_ci | cp1251 | 23 | | Yes | 1 | | cp1251_bin | cp1251 | 50 | | Yes | 1 | | cp1251_general_ci | cp1251 | 51 | Yes | Yes | 1 | | cp1251_general_cs | cp1251 | 52 | | Yes | 1 | | utf16_general_ci | utf16 | 54 | Yes | Yes | 1 | | utf16_bin | utf16 | 55 | | Yes | 1 | | utf16_unicode_ci | utf16 | 101 | | Yes | 8 | | utf16_icelandic_ci | utf16 | 102 | | Yes | 8 | | utf16_latvian_ci | utf16 | 103 | | Yes | 8 | | utf16_romanian_ci | utf16 | 104 | | Yes | 8 | | utf16_slovenian_ci | utf16 | 105 | | Yes | 8 | | utf16_polish_ci | utf16 | 106 | | Yes | 8 | | utf16_estonian_ci | utf16 | 107 | | Yes | 8 | | utf16_spanish_ci | utf16 | 108 | | Yes | 8 | | utf16_swedish_ci | utf16 | 109 | | Yes | 8 | | utf16_turkish_ci | utf16 | 110 | | Yes | 8 | | utf16_czech_ci | utf16 | 111 | | Yes | 8 | | utf16_danish_ci | utf16 | 112 | | Yes | 8 | | utf16_lithuanian_ci | utf16 | 113 | | Yes | 8 | | utf16_slovak_ci | utf16 | 114 | | Yes | 8 | | utf16_spanish2_ci | utf16 | 115 | | Yes | 8 | | utf16_roman_ci | utf16 | 116 | | Yes | 8 | | utf16_persian_ci | utf16 | 117 | | Yes | 8 | | utf16_esperanto_ci | utf16 | 118 | | Yes | 8 | | utf16_hungarian_ci | utf16 | 119 | | Yes | 8 | | utf16_sinhala_ci | utf16 | 120 | | Yes | 8 | | utf16_german2_ci | utf16 | 121 | | Yes | 8 | | utf16_croatian_ci | utf16 | 122 | | Yes | 8 | | utf16_unicode_520_ci | utf16 | 123 | | Yes | 8 | | utf16_vietnamese_ci | utf16 | 124 | | Yes | 8 | | utf16le_general_ci | utf16le | 56 | Yes | Yes | 1 | | utf16le_bin | utf16le | 62 | | Yes | 1 | | cp1256_general_ci | cp1256 | 57 | Yes | Yes | 1 | | cp1256_bin | cp1256 | 67 | | Yes | 1 | | cp1257_lithuanian_ci | cp1257 | 29 | | Yes | 1 | | cp1257_bin | cp1257 | 58 | | Yes | 1 | | cp1257_general_ci | cp1257 | 59 | Yes | Yes | 1 | | utf32_general_ci | utf32 | 60 | Yes | Yes | 1 | | utf32_bin | utf32 | 61 | | Yes | 1 | | utf32_unicode_ci | utf32 | 160 | | Yes | 8 | | utf32_icelandic_ci | utf32 | 161 | | Yes | 8 | | utf32_latvian_ci | utf32 | 162 | | Yes | 8 | | utf32_romanian_ci | utf32 | 163 | | Yes | 8 | | utf32_slovenian_ci | utf32 | 164 | | Yes | 8 | | utf32_polish_ci | utf32 | 165 | | Yes | 8 | | utf32_estonian_ci | utf32 | 166 | | Yes | 8 | | utf32_spanish_ci | utf32 | 167 | | Yes | 8 | | utf32_swedish_ci | utf32 | 168 | | Yes | 8 | | utf32_turkish_ci | utf32 | 169 | | Yes | 8 | | utf32_czech_ci | utf32 | 170 | | Yes | 8 | | utf32_danish_ci | utf32 | 171 | | Yes | 8 | | utf32_lithuanian_ci | utf32 | 172 | | Yes | 8 | | utf32_slovak_ci | utf32 | 173 | | Yes | 8 | | utf32_spanish2_ci | utf32 | 174 | | Yes | 8 | | utf32_roman_ci | utf32 | 175 | | Yes | 8 | | utf32_persian_ci | utf32 | 176 | | Yes | 8 | | utf32_esperanto_ci | utf32 | 177 | | Yes | 8 | | utf32_hungarian_ci | utf32 | 178 | | Yes | 8 | | utf32_sinhala_ci | utf32 | 179 | | Yes | 8 | | utf32_german2_ci | utf32 | 180 | | Yes | 8 | | utf32_croatian_ci | utf32 | 181 | | Yes | 8 | | utf32_unicode_520_ci | utf32 | 182 | | Yes | 8 | | utf32_vietnamese_ci | utf32 | 183 | | Yes | 8 | | binary | binary | 63 | Yes | Yes | 1 | | geostd8_general_ci | geostd8 | 92 | Yes | Yes | 1 | | geostd8_bin | geostd8 | 93 | | Yes | 1 | | cp932_japanese_ci | cp932 | 95 | Yes | Yes | 1 | | cp932_bin | cp932 | 96 | | Yes | 1 | | eucjpms_japanese_ci | eucjpms | 97 | Yes | Yes | 1 | | eucjpms_bin | eucjpms | 98 | | Yes | 1 | | gb18030_chinese_ci | gb18030 | 248 | Yes | Yes | 2 | | gb18030_bin | gb18030 | 249 | | Yes | 1 | | gb18030_unicode_520_ci | gb18030 | 250 | | Yes | 8 | +--------------------------+----------+-----+---------+----------+---------+ 222 rows in set (0.01 sec) 6.å­—ç¬¦é›†è®¾ç½® mysqlæœ‰4ä¸ªçº§åˆ«çš„å­—ç¬¦é›† 1.æœåŠ¡å™¨çº§åˆ«(æ“ä½œç³»ç»Ÿçº§åˆ«) 2.æ•°æ®åº“çº§åˆ« 3.è¡¨çº§åˆ« 4.åˆ—çº§åˆ« 6.1æœåŠ¡å™¨çº§åˆ« 1.æ“ä½œç³»ç»Ÿçº§åˆ« #centOS7 [root@hwyun ~]# cat /etc/locale.conf LANG=en_US.UTF-8 #centOS6 [root@test1 ~]# cat /etc/sysconfig/i18n LANG=\"en_US.UTF-8\" SYSFONT=\"latarcyrheb-sun16\" [root@test1 ~]# echo $LANG en_US.UTF-8 2.æ“ä½œç³»ç»Ÿå®¢æˆ·ç«¯çº§åˆ« sshè¿æ¥å·¥å…·è®¾ç½® 3.mysqlå®ä¾‹çº§åˆ« æ–¹æ³•1ï¼šåœ¨ç¼–è¯‘å®‰è£…æ—¶å€™å°±æŒ‡å®šå¦‚ä¸‹æœåŠ¡å™¨ç«¯å­—ç¬¦é›†ã€‚ cmake . -DDEFAULT_CHARSET=utf8 \\ -DDEFAULT_COLLATION=utf8_general_ci \\ -DWITH_EXTRA_CHARSETS=all \\ æ–¹æ³•2ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®å­—ç¬¦é›† [mysqld] character-set-server=utf8 6.2æ•°æ®åº“çº§åˆ« mysql> create database æ•°æ®åº“å charset utf8 default collate = utf8_general_ci; 6.3è¡¨çº§åˆ« mysql> CREATE TABLE `test` ( `id` int(4) NOT NULL AUTO_INCREMENT, `name` char(20) NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=utf8; 6.4åˆ—çº§åˆ« ç±»å‹ä¸ºCHARã€VARCHARã€TEXTçš„åˆ—ï¼Œå¯ä»¥æŒ‡å®šå­—ç¬¦é›†/æ ¡éªŒè§„åˆ™ create table t1(id int,address char(30) character set utf8); 7.ç”Ÿäº§ç¯å¢ƒæ›´æ”¹æ•°æ®åº“(å«æ•°æ®)å­—ç¬¦é›†çš„æ–¹æ³• mysql> alter database æ•°æ®åº“å CHARACTER SET utf8 collate utf8_general_ci; mysql> alter table t1 CHARACTER SET utf8; æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/15.mysqlæ—¥å¿—.html":{"url":"db/mysql/mysqlåŸºç¡€/15.mysqlæ—¥å¿—.html","title":"10.mysqlæ—¥å¿—","keywords":"","body":"mysqlæ—¥å¿— 1.é”™è¯¯æ—¥å¿— 1.1yumå®‰è£…é»˜è®¤è·¯å¾„ /var/log/mysqld.log mysql> show variables like \"%log_error%\"; +---------------+---------------------+ | Variable_name | Value | +---------------+---------------------+ | log_error | /var/log/mysqld.log | +---------------+---------------------+ 1 row in set (0.01 sec) 1.2äºŒè¿›åˆ¶å®‰è£…ã€ç¼–è¯‘å®‰è£…è·¯å¾„ $MYSQL_HOME/data/ä¸»æœºå.err //ç¼–è¾‘é…ç½®æ–‡ä»¶ [root@db01 ~]# vim /etc/my.cnf [mysqld] log_error=/usr/local/mysql/data/error.log //æŸ¥çœ‹æ–¹å¼ mysql> show variables like 'log_error'; +---------------+---------------------------------+ | Variable_name | Value | +---------------+---------------------------------+ | log_error | /usr/local/mysql/data/error.log | +---------------+---------------------------------+ 1 row in set (0.00 sec) 2.äºŒè¿›åˆ¶æ—¥å¿— 2.1å«ä¹‰ binlogæ—¥å¿—ï¼Œè®°å½•å¯¹mysqlçš„æ‰€æœ‰æ›´æ–°çš„æ“ä½œï¼Œæ’å…¥çš„æ“ä½œ(å¢åˆ æ”¹æ“ä½œ) 2.2ä½œç”¨ æ¢å¤æ•°æ®ï¼ŒMySQL ABå¤åˆ¶ï¼Œè®°å½•æ‰€æœ‰å¯¹æ•°æ®åº“å‘ç”Ÿä¿®æ”¹çš„æ“ä½œ 2.3äºŒè¿›åˆ¶æ—¥å¿—æ¨¡å¼ statementï¼šè¯­å¥æ¨¡å¼ï¼Œä¸Šå›¾ä¸­å°†updateè¯­å¥è¿›è¡Œè®°å½•ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰ ä¼˜ç‚¹ ç®€å•æ˜äº†ï¼Œå®¹æ˜“è¢«çœ‹æ‡‚ï¼Œå°±æ˜¯sqlè¯­å¥ï¼Œè®°å½•æ—¶ä¸éœ€è¦å¤ªå¤šçš„ç£ç›˜ç©ºé—´ ç¼ºç‚¹ è®°å½•ä¸å¤Ÿä¸¥è°¨ rowï¼šè¡Œæ¨¡å¼ï¼Œå³æ•°æ®è¡Œçš„å˜åŒ–è¿‡ç¨‹ï¼Œä¸Šå›¾ä¸­Age=19ä¿®æ”¹æˆAge=20çš„è¿‡ç¨‹äº‹ä»¶ã€‚ mixedï¼šä»¥ä¸Šä¸¤è€…çš„æ··åˆæ¨¡å¼ã€‚ ä¼ä¸šæ¨èä½¿ç”¨rowæ¨¡å¼ ä¼˜ç‚¹ è®°å½•æ›´åŠ ä¸¥è°¨ ç¼ºç‚¹ æœ‰å¯èƒ½ä¼šéœ€è¦æ›´å¤šçš„ç£ç›˜ç©ºé—´ï¼Œä¸å¤ªå®¹æ˜“è¢«è¯»æ‡‚ 2.4å¼€å¯æ–¹å¼ //å¼€å¯äºŒè¿›åˆ¶æ—¥å¿— [root@db01 data]# vim /etc/my.cnf [mysqld] log-bin=mysql-bin binlog_format=row //æ³¨æ„:åœ¨mysql5.7ä¸­å¼€å¯binlogå¿…é¡»è¦åŠ ä¸Šserver-idã€‚ [root@db01 data]# vim /etc/my.cnf [mysqld] log-bin=mysql-bin binlog_format=row server_id=1 2.5äºŒè¿›åˆ¶æ—¥å¿—çš„æ“ä½œ //ç‰©ç†æŸ¥çœ‹ [root@db01 data]# ll /usr/local/mysql/data/ -rw-rw---- 1 mysql mysql 285 Mar 6 2017 mysql-bin.000001 //å‘½ä»¤è¡ŒæŸ¥çœ‹ mysql> show binary logs; +------------------+-----------+ | Log_name | File_size | +------------------+-----------+ | mysql-bin.000001 | 120 | +------------------+-----------+ 1 row in set (0.00 sec) mysql> show master status; +------------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+-------------------+ | mysql-bin.000001 | 120 | | | | +------------------+----------+--------------+------------------+-------------------+ 1 row in set (0.00 sec) //æŸ¥çœ‹binlogäº‹ä»¶ mysql> show binlog events in 'mysql-bin.000001'; +------------------+-----+-------------+-----------+-------------+---------------------------------------+ | Log_name | Pos | Event_type | Server_id | End_log_pos | Info | +------------------+-----+-------------+-----------+-------------+---------------------------------------+ | mysql-bin.000001 | 4 | Format_desc | 1 | 120 | Server ver: 5.6.40-log, Binlog ver: 4 | +------------------+-----+-------------+-----------+-------------+---------------------------------------+ 1 row in set (0.01 sec) 2.6äº‹ä»¶ 2.6.1äº‹ä»¶å«ä¹‰ 1.åœ¨binlogä¸­æœ€å°çš„è®°å½•å•å…ƒä¸ºevent 2.ä¸€ä¸ªäº‹åŠ¡ä¼šè¢«æ‹†åˆ†æˆå¤šä¸ªäº‹ä»¶ï¼ˆeventï¼‰ 2.6.2äº‹ä»¶ç‰¹æ€§ 1.æ¯ä¸ªeventéƒ½æœ‰ä¸€ä¸ªå¼€å§‹ä½ç½®ï¼ˆstart positionï¼‰å’Œç»“æŸä½ç½®ï¼ˆstop positionï¼‰ 2.æ‰€è°“çš„ä½ç½®å°±æ˜¯eventå¯¹æ•´ä¸ªäºŒè¿›åˆ¶çš„æ–‡ä»¶çš„ç›¸å¯¹ä½ç½® 3.å¯¹äºä¸€ä¸ªäºŒè¿›åˆ¶æ—¥å¿—ä¸­ï¼Œå‰120ä¸ªpositionæ˜¯æ–‡ä»¶æ ¼å¼ä¿¡æ¯é¢„ç•™ç©ºé—´ 4.MySQLç¬¬ä¸€ä¸ªè®°å½•çš„äº‹ä»¶ï¼Œéƒ½æ˜¯ä»120å¼€å§‹çš„ 2.6.3åˆ©ç”¨äºŒè¿›åˆ¶æ—¥å¿—æ¢å¤æ•°æ®ç¤ºä¾‹ 1.ä¿®æ”¹mysqläºŒè¿›åˆ¶æ—¥å¿—ä¸ºrowæ¨¡å¼ [root@db01 data]# vim /etc/my.cnf [mysqld] log-bin=mysql-bin binlog_format=row 2.æŸ¥çœ‹äºŒè¿›åˆ¶æ—¥å¿—æ ¼å¼ mysql> show variables like 'binlog_format'; +---------------+-------+ | Variable_name | Value | +---------------+-------+ | binlog_format | ROW | +---------------+-------+ 1 row in set (0.01 sec) 3.æŸ¥çœ‹binlogä¿¡æ¯ mysql> show master status; +------------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+-------------------+ | mysql-bin.000001 | 120 | | | | +------------------+----------+--------------+------------------+-------------------+ 1 row in set (0.05 sec) 4.å…ˆåˆ·æ–°ï¼Œç„¶åå†æŸ¥çœ‹binlogä¿¡æ¯ï¼Œæ­¤æ—¶ä½ç½®ä¸º120 mysql> flush logs; Query OK, 0 rows affected (0.01 sec) mysql> show master status; +------------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+-------------------+ | mysql-bin.000002 | 120 | | | | +------------------+----------+--------------+------------------+-------------------+ 1 row in set (0.00 sec) 5.åˆ›å»ºä¸€ä¸ªbinlogåº“ mysql> create database binlog; Query OK, 1 row affected (0.01 sec) 6.åˆ›å»ºä¸€ä¸ªè¡¨binlog_table mysql> use binlog; Database changed mysql> create table binlog_table(id int); Query OK, 0 rows affected (0.03 sec) 7.åˆ›å»ºåº“å’Œè¡¨åæŸ¥çœ‹binlogä¿¡æ¯ï¼Œæ­¤æ—¶binlogä½ç½®ä¸º331 mysql> show master status; +------------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+-------------------+ | mysql-bin.000003 | 331 | | | | +------------------+----------+--------------+------------------+-------------------+ 1 row in set (0.00 sec) 8.å‘è¡¨ä¸­æ’å…¥ä¸€æ¡æ•°æ®å¹¶æŸ¥çœ‹binlogä¿¡æ¯ï¼Œæ­¤æ—¶binlogä½ç½®ä¸º533 mysql> insert into binlog_table values(1); Query OK, 1 row affected (0.01 sec) mysql> show master status; +------------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+-------------------+ | mysql-bin.000003 | 533 | | | | +------------------+----------+--------------+------------------+-------------------+ 1 row in set (0.00 sec) 9.å‘è¡¨ä¸­æ’å…¥2æ¡æ•°æ®å¹¶æŸ¥çœ‹binlogä¿¡æ¯ï¼Œæ­¤æ—¶binlogä½ç½®ä¸º937 mysql> insert into binlog_table values(2); Query OK, 1 row affected (0.00 sec) mysql> insert into binlog_table values(3); Query OK, 1 row affected (0.01 sec) mysql> show master status; +------------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+-------------------+ | mysql-bin.000002 | 937 | | | | +------------------+----------+--------------+------------------+-------------------+ 1 row in set (0.00 sec) 10.åˆ é™¤ä¸€æ¡æ•°æ®ã€ç„¶ååˆ é™¤è¡¨ã€åº“ mysql> select * from binlog_table; +------+ | id | +------+ | 1 | | 2 | | 3 | +------+ 3 rows in set (0.00 sec) mysql> delete from binlog_table where id=1; Query OK, 1 row affected (0.02 sec) mysql> drop table binlog_table; Query OK, 0 rows affected (0.01 sec) mysql> drop database binlog; Query OK, 0 rows affected (0.01 sec) 11.å¼€å§‹æŸ¥æ‰¾è¦æˆªå–çš„æ®µï¼Œè¿™é‡Œè¦æ¢å¤åˆ é™¤çš„æ•°æ®åº“ mysqlbinlog --base64-output=decode-rows -vvv /usr/local/mysql/data/mysql-bin.000002 [root@db02 data]# mysqlbinlog --base64-output=decode-rows -vvv /usr/local/mysql/data/mysql-bin.000002 12.å¼€å§‹æ¢å¤ï¼Œæ¢å¤å‰ä¸€å®šè¦ä¸´æ—¶å…³é—­äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå¦åˆ™äºŒè¿›åˆ¶æ—¥å¿—ä¼šå¤šè®°å½• #ä¸´æ—¶å…³é—­äºŒè¿›åˆ¶æ—¥å¿— mysql> set sql_log_bin=0; Query OK, 0 rows affected (0.01 sec) #æˆªå–å¹¶å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ [root@db02 data]# mysqlbinlog --start-position=120 --stop-position=1011 /usr/local/mysql/data/mysql-bin.000002 >/tmp/binlog.sql #å¼€å§‹æ¢å¤ [root@db02 data]# mysql -uroot -p show databases; +--------------------+ | Database | +--------------------+ | information_schema | | binlog | | mysql | | performance_schema | | test | +--------------------+ 5 rows in set (0.00 sec) mysql> use binlog; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed mysql> show tables; +------------------+ | Tables_in_binlog | +------------------+ | binlog_table | +------------------+ 1 row in set (0.00 sec) mysql> select * from binlog_table; +------+ | id | +------+ | 1 | | 2 | | 3 | +------+ 3 rows in set (0.00 sec) 3.é€šç”¨æŸ¥è¯¢æ—¥å¿— /var/run/mysqld/mysqld.log #å¯¹MySQLæ‰€æœ‰å¢åˆ æ”¹æŸ¥éƒ½ä¼šè®°å½•ï¼Œé»˜è®¤å…³é—­ mysql> show variables like \"%general%\"; +------------------+----------------------------+ | Variable_name | Value | +------------------+----------------------------+ | general_log | OFF | | general_log_file | /var/run/mysqld/mysqld.log | +------------------+----------------------------+ 2 rows in set (0.00 sec) #å¼€å¯é€šç”¨æŸ¥è¯¢æ—¥å¿—åæ‰ä¼šæœ‰æ–‡ä»¶/var/run/mysqld/mysqld.log mysql> set global general_log=on; Query OK, 0 rows affected (0.00 sec) 4.æ…¢æŸ¥è¯¢æ—¥å¿— /var/run/mysqld/mysqld-slow.log #è®°å½•æŸ¥è¯¢æ—¶é—´é•¿çš„è¯­å¥ï¼Œç”¨æ¥ä¼˜åŒ–ï¼Œé»˜è®¤10sä¸ºæ…¢æŸ¥è¯¢ mysql> show variables like \"%slow%\"; +---------------------+---------------------------------+ | Variable_name | Value | +---------------------+---------------------------------+ | log_slow_queries | OFF | | slow_launch_time | 2 | | slow_query_log | OFF | | slow_query_log_file | /var/run/mysqld/mysqld-slow.log | +---------------------+---------------------------------+ 4 rows in set (0.00 sec) #è®¾ç½®æ…¢æŸ¥è¯¢æ—¥å¿—å­˜æ”¾è·¯å¾„ mysql>set global slow_query_log_file=è·¯å¾„ #å¼€å¯æ…¢æŸ¥è¯¢ mysql> set global slow_query_log=on; Query OK, 0 rows affected (0.00 sec) #è®¾ç½®æ…¢æŸ¥è¯¢è¶…æ—¶æ—¶é—´ mysql> set long_query_time=2; Query OK, 0 rows affected (0.00 sec) #æ¨¡æ‹Ÿæ…¢æŸ¥è¯¢æ—¶é—´ä¸º5s mysql> select sleep(5); +----------+ | sleep(5) | +----------+ | 0 | +----------+ 1 row in set (5.00 sec) #æ­¤æ—¶æŸ¥çœ‹MySQLæ…¢æŸ¥è¯¢æ—¥å¿—å°±å¯ä»¥çœ‹åˆ°è¶…æ—¶çš„è¯­å¥ [root@mysql ~]# less /var/run/mysqld/mysqld-slow.log /usr/libexec/mysqld, Version: 5.1.73 (Source distribution). started with: Tcp port: 3306 Unix socket: /var/lib/mysql/mysql.sock Time Id Command Argument # Time: 171123 9:58:55 # User@Host: root[root] @ mysql [] # Query_time: 5.001586 Lock_time: 0.000000 Rows_sent: 1 Rows_examined: 0 use DB1; SET timestamp=1511402335; select sleep(5); æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/16.mysqlè®¾ç½®å¯†ç åŠå¿˜è®°å¯†ç å¦‚ä½•è§£å†³.html":{"url":"db/mysql/mysqlåŸºç¡€/16.mysqlè®¾ç½®å¯†ç åŠå¿˜è®°å¯†ç å¦‚ä½•è§£å†³.html","title":"11.mysqlä¿®æ”¹å¯†ç åŠå¿˜è®°å¯†ç å¦‚ä½•è§£å†³","keywords":"","body":"mysqlè®¾ç½®å¯†ç åŠå¿˜è®°å¯†ç å¦‚ä½•è§£å†³ mysql5.6 æ–¹æ³•ä¸€ mysqladmin ä¿®æ”¹æŒ‡å®šç”¨æˆ·å¯†ç  mysqladmin -uç”¨æˆ·å -pæ—§å¯†ç  password æ–°å¯†ç  ç¤ºä¾‹ï¼šä½¿ç”¨mysqladminå‘½ä»¤ç»™rootè®¾ç½®å¯†ç  mysql5.7å’Œmysql8ä¸­åœ¨å‘½ä»¤è¡Œä½¿ç”¨å‘½ä»¤mysqladminä¼šæœ‰è­¦å‘Šä¿¡æ¯ï¼Œmysql5.6æ²¡æœ‰ $ mysqladmin -uroot -p password Enter password: New password: Confirm new password: Warning: Since password will be sent to server in plain text, use ssl connection to ensure password safety. æ–¹æ³•äºŒ set password ä¿®æ”¹æŒ‡å®šç”¨æˆ·å¯†ç  set password for ç”¨æˆ·å@localhost = password('æ–°å¯†ç '); é»˜è®¤ä¿®æ”¹rootå¯†ç  set password='æ–°å¯†ç ' æˆ– set password=password('æ–°å¯†ç '); æ–¹æ³•ä¸‰ updateæ›´æ–°userè¡¨ âš ï¸mysql5.6ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µæ˜¯password âš ï¸mysql5.7å’Œ8ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µæ˜¯authentication_string âš ï¸mysql8ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µauthentication_stringåè¾¹ç›´æ¥è·Ÿå­—ç¬¦ä¸²å³å¯ï¼Œä¸èƒ½å†™password mysql5.6 update mysql.user set password=password('æ–°å¯†ç ') where user='root' and host='localhost'; mysql5.7 update mysql.user set authentication_string=password('æ–°å¯†ç ') where user='root' and host='localhost'; mysql8 update mysql.user set authentication_string='æ–°å¯†ç ' where user='root' and host='localhost'; mysql5.7 æ–¹æ³•ä¸€ mysqladmin ä¿®æ”¹æŒ‡å®šç”¨æˆ·å¯†ç  mysqladmin -uç”¨æˆ·å -pæ—§å¯†ç  password æ–°å¯†ç  ç¤ºä¾‹ï¼šä½¿ç”¨mysqladminå‘½ä»¤ç»™rootè®¾ç½®å¯†ç  mysql5.7å’Œmysql8ä¸­åœ¨å‘½ä»¤è¡Œä½¿ç”¨å‘½ä»¤mysqladminä¼šæœ‰è­¦å‘Šä¿¡æ¯ï¼Œmysql5.6æ²¡æœ‰ $ mysqladmin -uroot -p password Enter password: New password: Confirm new password: Warning: Since password will be sent to server in plain text, use ssl connection to ensure password safety. æ–¹æ³•äºŒ set password ä¿®æ”¹æŒ‡å®šç”¨æˆ·å¯†ç  set password for ç”¨æˆ·å@localhost = password('æ–°å¯†ç '); é»˜è®¤ä¿®æ”¹rootå¯†ç  set password='æ–°å¯†ç ' æˆ– set password=password('æ–°å¯†ç '); æ–¹æ³•ä¸‰ updateæ›´æ–°userè¡¨ âš ï¸mysql5.6ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µæ˜¯password âš ï¸mysql5.7å’Œ8ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µæ˜¯authentication_string âš ï¸mysql8ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µauthentication_stringåè¾¹ç›´æ¥è·Ÿå­—ç¬¦ä¸²å³å¯ï¼Œä¸èƒ½å†™password mysql5.6 update mysql.user set password=password('æ–°å¯†ç ') where user='root' and host='localhost'; mysql5.7 update mysql.user set authentication_string=password('æ–°å¯†ç ') where user='root' and host='localhost'; mysql8 update mysql.user set authentication_string='æ–°å¯†ç ' where user='root' and host='localhost'; mysql8.0 æ–¹æ³•ä¸€ ä¿®æ”¹æŒ‡å®šç”¨æˆ·å¯†ç  mysqladmin -uç”¨æˆ·å -pæ—§å¯†ç  password æ–°å¯†ç  ç¤ºä¾‹ï¼šä½¿ç”¨mysqladminå‘½ä»¤ç»™rootè®¾ç½®å¯†ç  mysql5.7å’Œmysql8ä¸­åœ¨å‘½ä»¤è¡Œä½¿ç”¨å‘½ä»¤mysqladminä¼šæœ‰è­¦å‘Šä¿¡æ¯ï¼Œmysql5.6æ²¡æœ‰ $ mysqladmin -uroot -p password Enter password: New password: Confirm new password: Warning: Since password will be sent to server in plain text, use ssl connection to ensure password safety. æ–¹æ³•äºŒ set password âš ï¸mysql8ä¸­ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¸å¯ç”¨ set password=password('æ–°å¯†ç '); set password for root@localhost = password('æ–°å¯†ç '); åªèƒ½ç”¨å¦‚ä¸‹æ–¹æ³• set password='æ–°å¯†ç ' æ–¹æ³•ä¸‰ updateæ›´æ–°userè¡¨ âš ï¸mysql5.6ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µæ˜¯password âš ï¸mysql5.7å’Œ8ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µæ˜¯authentication_string âš ï¸mysql8ä¸­userè¡¨ä¸­å¯†ç çš„å­—æ®µauthentication_stringåè¾¹ç›´æ¥è·Ÿå­—ç¬¦ä¸²å³å¯ï¼Œä¸èƒ½å†™password mysql5.6 update mysql.user set password=password('æ–°å¯†ç ') where user='root' and host='localhost'; mysql5.7 update mysql.user set authentication_string=password('æ–°å¯†ç ') where user='root' and host='localhost'; mysql8 update mysql.user set authentication_string='æ–°å¯†ç ' where user='root' and host='localhost'; mysqlå¿˜è®°å¯†ç  ç¬¬ä¸€æ­¥ã€åœæ­¢mysqlæ•°æ®åº“ ç¬¬äºŒæ­¥ã€ç¼–è¾‘mysqlé…ç½®æ–‡ä»¶my.cnfï¼Œåœ¨[mysqld]ä¸‹åŠ å‚æ•°skip-grant-tables ç¬¬ä¸‰æ­¥ã€å¯åŠ¨mysqlæ•°æ®åº“ï¼Œè¿›å…¥æ•°æ®åº“ä¿®æ”¹å¯†ç ï¼Œä¿®æ”¹å®Œæˆä¹‹åæŠŠé…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°skip-grant-tablesæ³¨é‡Šæˆ–è€…åˆ é™¤ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/17.mysqlé€»è¾‘å¤‡ä»½ mysqldump.html":{"url":"db/mysql/mysqlåŸºç¡€/17.mysqlé€»è¾‘å¤‡ä»½ mysqldump.html","title":"12.mysqlé€»è¾‘å¤‡ä»½ mysqldump","keywords":"","body":"mysqlé€»è¾‘å¤‡ä»½ mysqldump mysql5.7å®˜æ–¹æ‰‹å†Œ mysql5.7å¤‡ä»½å’Œæ¢å¤å®˜æ–¹æ–‡æ¡£ ä¸€ã€mysqlå¤‡ä»½ 1.1 ä¸ºä»€ä¹ˆè¦å¤‡ä»½ â‘ é˜²æ­¢æ•°æ®ä¸¢å¤± â‘¡æ¢å¤æ•°æ®ï¼Œè¯¯æ“ä½œæœ€å¤š 1.2 æ•°æ®çš„å¤‡ä»½ç±»å‹ â‘ å®Œå…¨å¤‡ä»½-->å¤‡ä»½æ•´ä¸ªæ•°æ®åº“ â‘¡éƒ¨åˆ†å¤‡ä»½-->å¤‡ä»½éƒ¨åˆ†æ•°æ®åº“ï¼Œä¾‹å¦‚åªå¤‡ä»½ä¸€ä¸ªåº“ã€ä¸€å¼ è¡¨ â‘¢å¢é‡å¤‡ä»½-->å¤‡ä»½è‡ªä¸Šä¸€æ¬¡å¤‡ä»½ä»¥æ¥(å¢é‡æˆ–å®Œå…¨)ä»¥æ¥å˜åŒ–çš„æ•°æ® ç‰¹ç‚¹: èŠ‚çº¦ç©ºé—´ã€è¿˜åŸéº»çƒ¦ â‘£å·®å¼‚å¤‡ä»½-->å¤‡ä»½è‡ªä¸Šä¸€æ¬¡å®Œå…¨å¤‡ä»½ä»¥æ¥å˜åŒ–çš„æ•°æ® ç‰¹ç‚¹: æµªè´¹ç©ºé—´ã€è¿˜åŸæ¯”å¢é‡å¤‡ä»½ç®€å• 1.3 å¤‡ä»½æ–¹å¼ çƒ­å¤‡ä»½ çƒ­å¤‡ä»½æŒ‡çš„æ˜¯å½“æ•°æ®åº“è¿›è¡Œå¤‡ä»½æ—¶, æ•°æ®åº“çš„è¯»å†™æ“ä½œå‡ä¸æ˜¯å—å½±å“ æ¸©å¤‡ä»½ æ¸©å¤‡ä»½æŒ‡çš„æ˜¯å½“æ•°æ®åº“è¿›è¡Œå¤‡ä»½æ—¶, æ•°æ®åº“çš„è¯»æ“ä½œå¯ä»¥æ‰§è¡Œ, ä½†æ˜¯ä¸èƒ½æ‰§è¡Œå†™æ“ä½œ å†·å¤‡ä»½ å†·å¤‡ä»½æŒ‡çš„æ˜¯å½“æ•°æ®åº“è¿›è¡Œå¤‡ä»½æ—¶, æ•°æ®åº“ä¸èƒ½è¿›è¡Œè¯»å†™æ“ä½œ, å³æ•°æ®åº“è¦ä¸‹çº¿ MySQLä¸­è¿›è¡Œä¸åŒæ–¹å¼çš„å¤‡ä»½è¿˜è¦è€ƒè™‘å­˜å‚¨å¼•æ“æ˜¯å¦æ”¯æŒ MyISAM çƒ­å¤‡ Ã— æ¸©å¤‡ âˆš å†·å¤‡ âˆš InnoDB çƒ­å¤‡ âˆš æ¸©å¤‡ âˆš å†·å¤‡ âˆš 1.4 å¤‡ä»½å‘½ä»¤ mysqldumpï¼ˆé€»è¾‘ï¼‰ mysqlåŸç”Ÿè‡ªå¸¦å¾ˆå¥½ç”¨çš„é€»è¾‘å¤‡ä»½å·¥å…· mysqlbinlogï¼ˆé€»è¾‘ï¼‰ å®ç°binlogå¤‡ä»½çš„åŸç”Ÿæ€å‘½ä»¤ xtrabackupï¼ˆç‰©ç†ï¼‰ preconaå…¬å¸å¼€å‘çš„æ€§èƒ½å¾ˆé«˜çš„ç‰©ç†å¤‡ä»½å·¥å…· 1.5 mysqlå¤‡ä»½æ–¹å¼æ€»ç»“ å¤‡ä»½æ–¹æ³• å¤‡ä»½é€Ÿåº¦ æ¢å¤é€Ÿåº¦ ä¾¿æ·æ€§ åŠŸèƒ½ ä¸€èˆ¬ç”¨äº cp å¿« å¿« ä¸€èˆ¬ã€çµæ´»æ€§ä½ å¾ˆå¼± å°‘é‡æ•°æ®å¤‡ä»½ mysqldump æ…¢ æ…¢ ä¸€èˆ¬ã€å¯æ— è§†å­˜å‚¨å¼•æ“çš„å·®å¼‚ ä¸€èˆ¬ ä¸­å°å‹æ•°æ®é‡çš„å¤‡ä»½ lvm2å¿«ç…§ å¿« å¿« ä¸€èˆ¬ã€æ”¯æŒå‡ ä¹çƒ­å¤‡ã€é€Ÿåº¦å¿« ä¸€èˆ¬ ä¸­å°å‹æ•°æ®é‡çš„å¤‡ä»½ xtrabackup è¾ƒå¿« è¾ƒå¿« å®ç°innodbçƒ­å¤‡ã€å¯¹å­˜å‚¨å¼•æ“æœ‰è¦æ±‚ å¼ºå¤§ è¾ƒå¤§è§„æ¨¡çš„å¤‡ä»½ äºŒã€mysqldumpå¤‡ä»½ 2.0 åˆ©ç”¨å­˜å‚¨è¿‡ç¨‹ç”Ÿæˆå¤§é‡æ•°æ® #1.åˆ›å»ºæ•°æ®åº“ mysql> create database db1; Query OK, 1 row affected (0.00 sec) #2.åˆ›å»ºè¡¨ mysql> use db1; Database changed mysql> create table db1_t1( id int, name varchar(20), gender char(6), email varchar(50), first_name char(10), last_name char(10) ); Query OK, 0 rows affected (0.01 sec) #3.åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ mysql> delimiter $$ #å£°æ˜å­˜å‚¨è¿‡ç¨‹çš„ç»“æŸç¬¦å·ä¸º$$ mysql> create procedure auto_insert1() BEGIN declare i int default 1; while(i delimiter ; #é‡æ–°å£°æ˜åˆ†å·ä¸ºç»“æŸç¬¦å·ï¼Œæ³¨æ„æœ‰ç©ºæ ¼ #4.æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹ show create procedure auto_insert1\\G #5.è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ call auto_insert1(); #6.æŸ¥çœ‹æ•°æ® mysql> select count(*) from s1; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.04 sec) mysql> select * from s1 limit 10; +------+--------+--------+-------------+------------+-----------+ | id | name | gender | email | first_name | last_name | +------+--------+--------+-------------+------------+-----------+ | 1 | xboyww | man | xboyww1@qq | a1 | b1 | | 2 | xboyww | man | xboyww2@qq | a2 | b2 | | 3 | xboyww | man | xboyww3@qq | a3 | b3 | | 4 | xboyww | man | xboyww4@qq | a4 | b4 | | 5 | xboyww | man | xboyww5@qq | a5 | b5 | | 6 | xboyww | man | xboyww6@qq | a6 | b6 | | 7 | xboyww | man | xboyww7@qq | a7 | b7 | | 8 | xboyww | man | xboyww8@qq | a8 | b8 | | 9 | xboyww | man | xboyww9@qq | a9 | b9 | | 10 | xboyww | man | xboyww10@qq | a10 | b10 | +------+--------+--------+-------------+------------+-----------+ 10 rows in set (0.00 sec) #åˆ é™¤å­˜å‚¨è¿‡ç¨‹ DROP PROCEDURE auto_insert1; ç”Ÿæˆçš„æ•°æ®åº“å’Œè¡¨ db1 db1_t1 10ä¸‡æ¡æ•°æ® db1_t2 10ä¸‡æ¡æ•°æ® db2 db2_t1 10ä¸‡æ¡æ•°æ® db2_t2 10ä¸‡æ¡æ•°æ® mysqldumpè¿æ¥æœåŠ¡ç«¯å‚æ•° -u æŒ‡å®šç”¨æˆ· -p æŒ‡å®šå¯†ç  -S æŒ‡å®šå¥—æ¥å­—æ–‡ä»¶ -h æŒ‡å®šä¸»æœº -P æŒ‡å®šç«¯å£ mysqldumpçš„ä¸‰ç§è¯­æ³• shell> mysqldump [options] db_name [tbl_name ...] shell> mysqldump [options] --databases db_name ... shell> mysqldump [options] --all-databases 2.1 å…¨åº“å¤‡ä»½ -A,--all-databases mysqldump -uroot -p -A >all.sql 2.2 å•åº“ã€å¤šåº“å¤‡ä»½ -B,--databases å•åº“å¤‡ä»½ï¼Œå¯ä»¥ä¸åŠ é€‰é¡¹-B mysqldump -uroot -p -B db1 > db1.sql æˆ–è€… mysqldump -uroot -p db1 > db1.sql å¤šåº“å¤‡ä»½ï¼Œå¿…é¡»åŠ å‚æ•°-B mysqldump -uroot -p -B db1 db2 > db1_db2.sql 2.3 å•è¡¨ã€å¤šè¡¨å¤‡ä»½ ä¸éœ€è¦å‚æ•° å•è¡¨å¤‡ä»½ mysqldump -uroot -p db1 db1_t1 > db1.db1_t1.sql å¤šè¡¨å¤‡ä»½ mysqldump -uroot -p db1 db1_t1 db1_t2 > db1.db1_t1_t2.sql 2.4 å¤‡ä»½çš„ä¸€äº›é€‰é¡¹ 2.4.1 --master-data å¤‡ä»½æ—¶åŠ å…¥change masterè¯­å¥ï¼Œéœ€è¦å¼€å¯binlogæ—¥å¿— æœ‰3ä¸ªå‚æ•° 0 æ²¡æœ‰ 1 ä¸æ³¨é‡Š 2 æ³¨é‡Š å½“å‚æ•°=0æ—¶ï¼Œå¤‡ä»½çš„æ–‡ä»¶ä¸­æ˜¯æ²¡æœ‰change master toè¯­å¥çš„ mysqldump -uroot -p -B db1 --master-data=0 > db1.sql å½“å‚æ•°=1æ—¶ï¼Œå¤‡ä»½çš„æ–‡ä»¶ä¸­å°±ä¼šæœ‰change master toè¯­å¥ï¼Œå¹¶ä¸”æ²¡æœ‰æ³¨é‡Š mysqldump -uroot -p -B db1 --master-data=1 > db1.sql #å¤‡ä»½çš„sqlæ–‡ä»¶ä¸­ä¼šæœ‰change master toè¯­å¥ï¼Œå¹¶ä¸”æ²¡æœ‰æ³¨é‡Š $ grep 'CHANGE MASTER' db1.sql CHANGE MASTER TO MASTER_LOG_FILE='binlog.000004', MASTER_LOG_POS=154; å½“å‚æ•°=2æ—¶ï¼Œå¤‡ä»½çš„æ–‡ä»¶ä¸­å°±ä¼šæœ‰change master toè¯­å¥ï¼Œå¹¶ä¸”æ˜¯æ³¨é‡Šçš„ mysqldump -uroot -p -B db1 --master-data=2 > db1.sql #å¤‡ä»½çš„sqlæ–‡ä»¶ä¸­ä¼šæœ‰change master toè¯­å¥ï¼Œå¹¶ä¸”æ˜¯æ³¨é‡Šçš„ $ grep 'CHANGE MASTER' db1.sql -- CHANGE MASTER TO MASTER_LOG_FILE='binlog.000004', MASTER_LOG_POS=154; 2.4.2 -R, --routines å¤‡ä»½å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°æ•°æ® mysqldump -uroot -A -R --master-data=2 > all.sql 2.4.3 --triggers å¤‡ä»½è§¦å‘å™¨æ•°æ® é»˜è®¤å¯ç”¨ï¼Œä½¿ç”¨é€‰é¡¹--skip-triggersç¦ç”¨ mysqldump -uroot -A --triggers --master-data=2 > all.sql 2.4.4 --single-transaction å¿«ç…§å¤‡ä»½ï¼Œä»…å¯¹InnoDBå¼•æ“ç”Ÿæ•ˆ æ­¤é€‰é¡¹å°†äº‹åŠ¡éš”ç¦»æ¨¡å¼è®¾ç½®ä¸ºï¼Œ REPEATABLE READå¹¶START TRANSACTION mysqldump -uroot -A --single-transaction --master-data=2 > all.sql 2.4.5 --lock-all-tablesï¼Œ-x é”è¡¨å¤‡ä»½ é”å®šæ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ï¼Œæ­¤é€‰é¡¹å°†è‡ªåŠ¨å…³é—­ --single-transactionå’Œ --lock-tables mysqldump -uroot -A -x --master-data=2 > all.sql ä¸‰ã€mysqldumpæ¢å¤ #å…ˆä¸è®°å½•äºŒè¿›åˆ¶æ—¥å¿— mysql> set sql_log_bin=0; #åº“å†…æ¢å¤æ“ä½œ mysql> source /backup/all.sql #åº“å¤–æ¢å¤æ“ä½œ mysql -uroot -p mysqldumpæ¢å¤ç‰¹ç‚¹ mysqldumpåœ¨å¤‡ä»½å’Œæ¢å¤æ—¶éƒ½éœ€è¦MySQLå®ä¾‹å¯åŠ¨ä¸ºå‰æ ä¸€èˆ¬æ•°æ®é‡çº§100Gä»¥å†…ï¼Œå¤§çº¦15-30åˆ†é’Ÿå¯ä»¥æ¢å¤ï¼ˆPBã€EBå°±éœ€è¦è€ƒè™‘åˆ«çš„æ–¹å¼ï¼‰ mysqldumpæ˜¯ä»¥è¦†ç›–çš„å½¢å¼æ¢å¤æ•°æ®çš„ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlåŸºç¡€/18.mysqlç‰©ç†å¤‡ä»½ xtrabackup.html":{"url":"db/mysql/mysqlåŸºç¡€/18.mysqlç‰©ç†å¤‡ä»½ xtrabackup.html","title":"13.mysqlç‰©ç†å¤‡ä»½ xtrabackup","keywords":"","body":"mysqlç‰©ç†å¤‡ä»½ xtrabackup xtrabackup githubåœ°å€ xtrabackup2.4å®˜æ–¹æ–‡æ¡£ xtrabackup8.0å®˜æ–¹æ–‡æ¡£ xtrabackup2.4å®˜æ–¹ä¸‹è½½åœ°å€ xtrabackup8.0å®˜æ–¹ä¸‹è½½åœ°å€ xtrabackupå¤‡ä»½æ–¹å¼ï¼ˆç‰©ç†å¤‡ä»½ï¼‰ å¯¹äºéinnodbè¡¨ï¼ˆæ¯”å¦‚myisamï¼‰æ˜¯ç›´æ¥é”è¡¨cpæ•°æ®æ–‡ä»¶ï¼Œå±äºä¸€ç§æ¸©å¤‡ å¯¹äºinnodbçš„è¡¨ï¼ˆæ”¯æŒäº‹åŠ¡ï¼‰ï¼Œä¸é”è¡¨ï¼Œcpæ•°æ®é¡µæœ€ç»ˆä»¥æ•°æ®æ–‡ä»¶æ–¹å¼ä¿å­˜ä¸‹æ¥ï¼Œå¹¶ä¸”æŠŠredoå’Œundoä¸€å¹¶å¤‡èµ°ï¼Œå±äºçƒ­å¤‡æ–¹å¼ å¤‡ä»½æ—¶è¯»å–é…ç½®æ–‡ä»¶/etc/my.cnf ä¸€ã€å®‰è£…xtrabackup 1.1 ä¸‹è½½è½¯ä»¶åŒ…å¹¶å®‰è£… wget https://www.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.20/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.20-1.el7.x86_64.rpm yum -y localinstall percona-xtrabackup-24-2.4.20-1.el7.x86_64.rpm 1.2 æŸ¥çœ‹ç‰ˆæœ¬ $ xtrabackup -v xtrabackup: recognized server arguments: --datadir=/usr/local/mysql/data --server-id=1 --log_bin=binlog xtrabackup version 2.4.20 based on MySQL server 5.7.26 Linux (x86_64) (revision id: c8b4056) äºŒã€xtrabackupå…¨å¤‡ xtrabackup xtrabackupå¯ä»¥åœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹å¤‡ä»½innodbæ•°æ®è¡¨ï¼Œä¸è¿‡æ­¤å·¥å…·ä¸èƒ½æ“ä½œmyisamã€‚ innobackupex innobackupexæ˜¯ä¸€ä¸ªå°è£…äº†xtrabackupçš„è„šæœ¬ï¼Œèƒ½åŒæ—¶å¤„ç†innodbå’Œmyisamï¼Œä½†åœ¨å¤„ç†myisamæ—¶éœ€è¦åŠ ä¸€ä¸ªè¯»é”ã€‚ åˆ©ç”¨å­˜å‚¨è¿‡ç¨‹ç”Ÿæˆå¤§é‡æ•°æ® db1ã€db2æ¯ä¸ªåº“ä¸­æœ‰ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨10ä¸‡æ¡æ•°æ® #1.åˆ›å»ºæ•°æ®åº“ mysql> create database db1; Query OK, 1 row affected (0.00 sec) #2.åˆ›å»ºè¡¨ mysql> use db1; Database changed mysql> create table db1_t1( id int, name varchar(20), gender char(6), email varchar(50), first_name char(10), last_name char(10) ); Query OK, 0 rows affected (0.01 sec) #3.åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ mysql> delimiter $$ #å£°æ˜å­˜å‚¨è¿‡ç¨‹çš„ç»“æŸç¬¦å·ä¸º$$ mysql> create procedure auto_insert1() BEGIN declare i int default 1; while(i delimiter ; #é‡æ–°å£°æ˜åˆ†å·ä¸ºç»“æŸç¬¦å·ï¼Œæ³¨æ„æœ‰ç©ºæ ¼ #4.æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹ show create procedure auto_insert1\\G #5.è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ call auto_insert1(); #6.æŸ¥çœ‹æ•°æ® mysql> select count(*) from s1; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.04 sec) mysql> select * from s1 limit 10; +------+--------+--------+-------------+------------+-----------+ | id | name | gender | email | first_name | last_name | +------+--------+--------+-------------+------------+-----------+ | 1 | xboyww | man | xboyww1@qq | a1 | b1 | | 2 | xboyww | man | xboyww2@qq | a2 | b2 | | 3 | xboyww | man | xboyww3@qq | a3 | b3 | | 4 | xboyww | man | xboyww4@qq | a4 | b4 | | 5 | xboyww | man | xboyww5@qq | a5 | b5 | | 6 | xboyww | man | xboyww6@qq | a6 | b6 | | 7 | xboyww | man | xboyww7@qq | a7 | b7 | | 8 | xboyww | man | xboyww8@qq | a8 | b8 | | 9 | xboyww | man | xboyww9@qq | a9 | b9 | | 10 | xboyww | man | xboyww10@qq | a10 | b10 | +------+--------+--------+-------------+------------+-----------+ 10 rows in set (0.00 sec) #åˆ é™¤å­˜å‚¨è¿‡ç¨‹ DROP PROCEDURE auto_insert1; db3ï¼Œä¸€å¼ è¡¨ï¼Œä¸¤æ¡æ•°æ® mysql> create database db3; Query OK, 1 row affected (0.00 sec) mysql> create table t3(id int,name char(10)) engine=myisam; Query OK, 0 rows affected (0.01 sec) mysql> insert into t3 values(1,'xiaoming'),(2,'xiaohong'); Query OK, 2 rows affected (0.00 sec) Records: 2 Duplicates: 0 Warnings: 0 mysql> select * from t3; +------+----------+ | id | name | +------+----------+ | 1 | xiaoming | | 2 | xiaohong | +------+----------+ 2 rows in set (0.00 sec) 2.1 å…¨å¤‡ 2.1.1 å¤‡ä»½æ–¹æ³•ä¸€ xtrabackup --backup xtrabackup2.4 xtrabackupé€‰é¡¹ æ‰§è¡Œå¤‡ä»½å‘½ä»¤ xtrabackup -uroot -p --backup --target-dir=/data/backups/ /data/backupså¤‡ä»½ç›®å½•ä¸‹çš„å†…å®¹ $ ll æ€»ç”¨é‡ 12340 -rw-r----- 1 root root 487 7æœˆ 2 22:43 backup-my.cnf drwxr-x--- 2 root root 92 7æœˆ 2 22:43 db1 drwxr-x--- 2 root root 92 7æœˆ 2 22:43 db2 drwxr-x--- 2 root root 62 7æœˆ 2 22:43 db3 -rw-r----- 1 root root 646 7æœˆ 2 22:43 ib_buffer_pool -rw-r----- 1 root root 12582912 7æœˆ 2 22:43 ibdata1 drwxr-x--- 2 root root 4096 7æœˆ 2 22:43 mysql drwxr-x--- 2 root root 8192 7æœˆ 2 22:43 performance_schema drwxr-x--- 2 root root 8192 7æœˆ 2 22:43 sys -rw-r----- 1 root root 19 7æœˆ 2 22:43 xtrabackup_binlog_info -rw-r----- 1 root root 141 7æœˆ 2 22:43 xtrabackup_checkpoints -rw-r----- 1 root root 474 7æœˆ 2 22:43 xtrabackup_info -rw-r----- 1 root root 2560 7æœˆ 2 22:43 xtrabackup_logfile 2.1.2 å¤‡ä»½æ–¹æ³•äºŒ innobackupex xtrabackup2.4 innobackupexé€‰é¡¹ æ‰§è¡Œå¤‡ä»½å‘½ä»¤ -S /var/lib/mysql/mysql.sock -Sé€‰é¡¹å¯ä»¥ä¸åŠ ï¼Œä¼šä»mysqlé…ç½®æ–‡ä»¶/etc/my.cnfä¸­è¯»å–sockæ–‡ä»¶ä½ç½® innobackupex -uroot -p1 /backup å¤‡ä»½å®Œæˆåä¼šåœ¨/backupç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªä»¥æ—¶é—´å‘½ä»¤å¹¶ç²¾ç¡®åˆ°ç§’çš„ç›®å½• $ ls 2020-07-02_22-57-09 $ cd 2020-07-02_22-57-09/ $ ll æ€»ç”¨é‡ 12340 -rw-r----- 1 root root 487 7æœˆ 2 22:57 backup-my.cnf drwxr-x--- 2 root root 92 7æœˆ 2 22:57 db1 drwxr-x--- 2 root root 92 7æœˆ 2 22:57 db2 drwxr-x--- 2 root root 62 7æœˆ 2 22:57 db3 -rw-r----- 1 root root 646 7æœˆ 2 22:57 ib_buffer_pool -rw-r----- 1 root root 12582912 7æœˆ 2 22:57 ibdata1 drwxr-x--- 2 root root 4096 7æœˆ 2 22:57 mysql drwxr-x--- 2 root root 8192 7æœˆ 2 22:57 performance_schema drwxr-x--- 2 root root 8192 7æœˆ 2 22:57 sys -rw-r----- 1 root root 19 7æœˆ 2 22:57 xtrabackup_binlog_info -rw-r----- 1 root root 141 7æœˆ 2 22:57 xtrabackup_checkpoints -rw-r----- 1 root root 494 7æœˆ 2 22:57 xtrabackup_info -rw-r----- 1 root root 2560 7æœˆ 2 22:57 xtrabackup_logfile å¦‚æœæƒ³è¦è‡ªä¸»å‘½åå¤‡ä»½ç›®å½•çš„è¯ï¼Œéœ€è¦åŠ å‚æ•°--no-timestamp innobackupex -uroot -p1 --no-timestamp /backup/bak åœ¨å¤‡ä»½ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶xtrabackup_binlog_infoï¼Œè¿™ä¸ªæ–‡ä»¶è®°å½•äº†binlogæ–‡ä»¶åå’Œbinlogçš„ä½ç½®ç‚¹ $ cat xtrabackup_binlog_info binlog.000009 1061 åœ¨å¤‡ä»½ç›®å½•ä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶xtrabackup_infoï¼Œè¿™ä¸ªæ–‡ä»¶è®°å½•äº†å¤‡ä»½ä¿¡æ¯æ±‡æ€» $ cat xtrabackup_info uuid = c47c158f-bc74-11ea-82fa-001c42f33c78 name = tool_name = innobackupex tool_command = --user=root --password=... --no-timestamp /backup/bak tool_version = 2.4.20 ibbackup_version = 2.4.20 server_version = 5.7.28-log start_time = 2020-07-02 23:00:27 end_time = 2020-07-02 23:00:28 lock_time = 0 binlog_pos = filename 'binlog.000009', position '1061' innodb_from_lsn = 0 innodb_to_lsn = 332706000 partial = N incremental = N format = file compact = N compressed = N encrypted = N åœ¨å¤‡ä»½ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶xtrabackup_logfileï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯å¤‡ä»½çš„redo_logæ–‡ä»¶ $ ll xtrabackup_logfile -rw-r----- 1 root root 2560 7æœˆ 2 23:00 xtrabackup_logfile 2.2 å…¨å¤‡æ¢å¤ 2.2.1 æŸ¥çœ‹åŸæœ‰æ•°æ®åº“ æœ‰3ä¸ªåº“(db1ï¼Œdb2ï¼Œdb3)ï¼Œ mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | db1 | | db2 | | db3 | | mysql | | performance_schema | | sys | +--------------------+ 7 rows in set (0.00 sec) 2.2.2 åŸæœ‰æ•°æ®åº“ä¸­çš„è¡¨ #db1ï¼Œæœ‰ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨ä¸­æœ‰10ä¸‡æ¡æ•°æ® mysql> use db1; mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | db1_t1 | | db1_t2 | +---------------+ 2 rows in set (0.00 sec) mysql> select count(*) from db1_t1; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.04 sec) mysql> select count(*) from db1_t2; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.04 sec) #db2ï¼Œæœ‰ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨ä¸­æœ‰10ä¸‡æ¡æ•°æ® mysql> use db1; mysql> show tables; +---------------+ | Tables_in_db2 | +---------------+ | db2_t1 | | db2_t2 | +---------------+ 2 rows in set (0.00 sec) mysql> select count(*) from db2_t1; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.04 sec) mysql> select count(*) from db2_t2; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.03 sec) #db3ï¼Œæœ‰1å¼ è¡¨ï¼Œè¡¨ä¸­2è¡Œæ•°æ® mysql> use db3; mysql> show tables; +---------------+ | Tables_in_db3 | +---------------+ | t3 | +---------------+ 1 row in set (0.00 sec) mysql> select count(*) from t3; +----------+ | count(*) | +----------+ | 2 | +----------+ 1 row in set (0.00 sec) 2.2.3 è¿›è¡Œå…¨åº“å¤‡ä»½ innobackupex -uroot -p1 --no-timestamp /backup/bak 2.2.4 åˆ é™¤db1-3æ•°æ®åº“ mysql> drop database db1; Query OK, 2 rows affected (0.00 sec) mysql> drop database db2; Query OK, 2 rows affected (0.01 sec) mysql> drop database db3; Query OK, 1 row affected (0.00 sec) mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | sys | +--------------------+ 4 rows in set (0.00 sec) 2.2.5 å°†redoè¿›è¡Œé‡åšï¼Œå·²æäº¤çš„å†™åˆ°æ•°æ®æ–‡ä»¶ï¼Œæœªæäº¤çš„ä½¿ç”¨undoå›æ»šï¼Œæ¨¡æ‹ŸCSRçš„è¿‡ç¨‹ --apply-logå‚æ•°çš„ä½œç”¨æ˜¯åº”ç”¨ BACKUP-DIR ä¸­çš„ xtrabackup_logfile äº‹åŠ¡æ—¥å¿—æ–‡ä»¶ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨å¤‡ä»½å®Œæˆåï¼Œæ•°æ®å°šä¸”ä¸èƒ½ç”¨äºæ¢å¤æ“ä½œï¼Œå› ä¸ºå¤‡ä»½çš„æ•°æ®ä¸­å¯èƒ½ä¼šåŒ…å«å°šæœªæäº¤çš„äº‹åŠ¡æˆ–å·²ç»æäº¤ä½†å°šæœªåŒæ­¥è‡³æ•°æ®æ–‡ä»¶ä¸­çš„äº‹åŠ¡ã€‚å› æ­¤ï¼Œæ­¤æ—¶æ•°æ®æ–‡ä»¶ä»å¤„äºä¸ä¸€è‡´çŠ¶æ€ã€‚\"å‡†å¤‡\"çš„ä¸»è¦ä½œç”¨æ­£æ˜¯é€šè¿‡å›æ»šæœªæäº¤çš„äº‹åŠ¡åŠåŒæ­¥å·²ç»æäº¤çš„äº‹åŠ¡è‡³æ•°æ®æ–‡ä»¶ä½¿å¾—æ•°æ®æ–‡ä»¶å¤„äºä¸€è‡´æ€§çŠ¶æ€ã€‚ innobackupex -uroot -p1 --apply-log /backup/bak 2.2.6 åœæ­¢mysqlï¼Œåˆ é™¤åŸå…ˆæ•°æ®ç›®å½• åœæ­¢mysql $ /etc/init.d/mysqld stop Shutting down MySQL.... SUCCESS! 2.2.7 åˆ é™¤åŸå…ˆæ•°æ®ç›®å½•æˆ–è€…ä¿®æ”¹åç§° âš ï¸æ¢å¤æ•°æ®ä¹‹å‰éœ€è¦ä¿è¯æ•°æ®ç›®å½•æ˜¯ç©ºçš„çŠ¶æ€ mysqlå®‰è£…çš„æ•°æ®ç›®å½•ä¸º/usr/local/mysql/data #å¦‚æœåšåˆ é™¤æ“ä½œï¼Œæœ€å¥½å…ˆå¤‡ä»½ç„¶åå†åˆ é™¤ï¼Œè™½ç„¶æ•°æ®å·²ç»ä¸¢å¤±ä¸€éƒ¨åˆ†ï¼Œè¿™é‡Œé€‰æ‹©ä¿®æ”¹ç›®å½•åç§° mv /usr/local/mysql/data{,-bak} 2.2.8 è¿›è¡Œæ•°æ®æ¢å¤ è¿™é‡Œè¦æ³¨æ„ï¼Œæ¢å¤çš„æ—¶å€™mysqlé…ç½®æ–‡ä»¶[mysqld]ä¸‹ä¸€å®šè¦æŒ‡å®šmysql dataç›®å½• innobackupex -uroot -p1 --copy-back /backup/bak æˆ– xtrabackup -uroot p1 --copy-back --target-dir=/backup/bak 2.2.9 ç»™æ¢å¤çš„ç›®å½•é‡æ–°æˆæƒæ‰€æœ‰è€…ä¸ºmysql chown -R mysql.mysql /usr/local/mysql/data 2.2.10 å¯åŠ¨mysql $ /etc/init.d/mysqld start Starting MySQL.Logging to '/usr/local/mysql/data/error.log'. . SUCCESS! 2.2.11 éªŒè¯æ•°æ®æ¢å¤ éªŒè¯æ•°æ®åº“æ˜¯å¦è¿˜åŸ mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | db1 | | db2 | | db3 | | mysql | | performance_schema | | sys | +--------------------+ 7 rows in set (0.00 sec) éªŒè¯è¡¨ä¸­çš„æ•°æ®æ˜¯å¦è¿˜åŸ #db1ï¼Œæœ‰ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨ä¸­æœ‰10ä¸‡æ¡æ•°æ® mysql> use db1; mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | db1_t1 | | db1_t2 | +---------------+ 2 rows in set (0.00 sec) mysql> select count(*) from db1_t1; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.04 sec) mysql> select count(*) from db1_t2; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.04 sec) #db2ï¼Œæœ‰ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨ä¸­æœ‰10ä¸‡æ¡æ•°æ® mysql> use db1; mysql> show tables; +---------------+ | Tables_in_db2 | +---------------+ | db2_t1 | | db2_t2 | +---------------+ 2 rows in set (0.00 sec) mysql> select count(*) from db2_t1; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.04 sec) mysql> select count(*) from db2_t2; +----------+ | count(*) | +----------+ | 100000 | +----------+ 1 row in set (0.03 sec) #db3ï¼Œæœ‰1å¼ è¡¨ï¼Œè¡¨ä¸­2è¡Œæ•°æ® mysql> use db3; mysql> show tables; +---------------+ | Tables_in_db3 | +---------------+ | t3 | +---------------+ 1 row in set (0.00 sec) mysql> select count(*) from t3; +----------+ | count(*) | +----------+ | 2 | +----------+ 1 row in set (0.00 sec) ä¸‰ã€xtrabackupå¢é‡å¤‡ä»½ xtrabackup2.4 å¢é‡å¤‡ä»½å®˜æ–¹æ–‡æ¡£ 3.1 åšå…¨å¤‡ db1ã€db2ã€db3æ•°æ®åº“åŠè¡¨æ•°æ®è¯´æ˜ $ tree db1 db2 db3 db1 #ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨ä¸­10ä¸‡æ¡æ•°æ® â”œâ”€â”€ db1_t1.frm â”œâ”€â”€ db1_t1.ibd â”œâ”€â”€ db1_t2.frm â”œâ”€â”€ db1_t2.ibd â””â”€â”€ db.opt db2 #ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨ä¸­10ä¸‡æ¡æ•°æ® â”œâ”€â”€ db2_t1.frm â”œâ”€â”€ db2_t1.ibd â”œâ”€â”€ db2_t2.frm â”œâ”€â”€ db2_t2.ibd â””â”€â”€ db.opt db3 #ä¸€å¼ è¡¨ï¼Œ2æ¡æ•°æ® â”œâ”€â”€ db.opt â”œâ”€â”€ t3.frm â”œâ”€â”€ t3.MYD â””â”€â”€ t3.MYI åˆ é™¤ä¹‹å‰çš„å…¨å¤‡ï¼Œé‡æ–°åšå…¨å¤‡ innobackupex -uroot -p1 --no-timestamp /backup/bak æˆ– xtrabackup -uroot -p --backup --target-dir=/backup/bak åœ¨å¤‡ä»½ç›®å½•/backup/bakä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶xtrabackup_checkpointsï¼Œè¿™ä¸ªæ–‡ä»¶è®°å½•äº†å¤‡ä»½ç±»å‹ã€lsn(æ—¥å¿—åºåˆ—å·) $ cat xtrabackup_checkpoints backup_type = full-backuped from_lsn = 0 to_lsn = 332706875 last_lsn = 332706884 compact = 0 recover_binlog_info = 0 flushed_lsn = 332706884 3.2 å¼€å§‹å¢é‡å¤‡ä»½ 3.2.1 åŸºäºå…¨å¤‡çš„çš„å¢å¤‡ å¼€å§‹ç¬¬ä¸€æ¬¡å¢å¤‡ï¼Œåªè¦å…¨å¤‡å’Œå¤šä¸ªå¢å¤‡çš„LSNå·è¿ç»­ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€ä¸ªè¿›è¡Œæ¢å¤ã€‚å¯ä»¥åœ¨å¤‡ä»½ç›®å½•xtrabackup_checkpointsæ–‡ä»¶ä¸­çœ‹åˆ°ï¼Œå…¶ä¸­å…¨å¤‡çš„from_lsn=0,å¢å¤‡çš„from_lsnåº”è¯¥ç­‰äºä¸Šä¸€ä¸ªå¢å¤‡æˆ–è€…å…¨å¤‡çš„to_lsn $ cat xtrabackup_checkpoints backup_type = full-backuped from_lsn = 0 to_lsn = 332706875 last_lsn = 332706884 compact = 0 recover_binlog_info = 0 flushed_lsn = 332706884 3.2.1.1 æ’å…¥æ•°æ® db1ã€db2ã€db3æ¯ä¸ªæ•°æ®åº“ä¸­çš„è¡¨éƒ½æ’å…¥ä¸€æ¡æ•°æ® #db1 mysql> insert into db1_t1 values(100001,'xboyww','man',concat( 'xboyww',100001,'@qq'),concat('a',100001),concat('b',100001)); Query OK, 1 row affected (0.00 sec) mysql> insert into db1_t2 values(100001,'xboyww','man',concat( 'xboyww',100001,'@qq'),concat('a',100001),concat('b',100001)); Query OK, 1 row affected (0.00 sec) #db2 mysql> insert into db2_t1 values(100001,'xboyww','man',concat( 'xboyww',100001,'@qq'),concat('a',100001),concat('b',100001)); Query OK, 1 row affected (0.01 sec) mysql> insert into db2_t2 values(100001,'xboyww','man',concat( 'xboyww',100001,'@qq'),concat('a',100001),concat('b',100001)); Query OK, 1 row affected (0.00 sec) #db3 mysql> insert into t3 values(3,'dabai'); Query OK, 1 row affected (0.00 sec) æŸ¥çœ‹æ¯å¼ è¡¨çš„æ•°æ® æ¯å¼ è¡¨éƒ½åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€è¡Œæ•°æ® #db1çš„ä¸¤å¼ è¡¨ mysql> select count(*) from db1_t1; +----------+ | count(*) | +----------+ | 100001 | +----------+ 1 row in set (0.03 sec) mysql> select count(*) from db1_t2; +----------+ | count(*) | +----------+ | 100001 | +----------+ 1 row in set (0.04 sec) #db2çš„ä¸¤å¼ è¡¨ mysql> select count(*) from db2_t1; +----------+ | count(*) | +----------+ | 100001 | +----------+ 1 row in set (0.04 sec) mysql> select count(*) from db2_t2; +----------+ | count(*) | +----------+ | 100001 | +----------+ 1 row in set (0.04 sec) #db3çš„ä¸€å¼ è¡¨ mysql> select count(*) from t3; +----------+ | count(*) | +----------+ | 3 | +----------+ 1 row in set (0.00 sec) 3.2.1.2 æ‰§è¡Œå¢å¤‡å‘½ä»¤ å¢å¤‡å°±æ˜¯åœ¨å…¨å¤‡çš„å‘½ä»¤åŸºç¡€ä¸ŠåŠ ä¸€ä¸ªå‚æ•°--incremental-basedir=æŒ‡å®šå¢å¤‡çš„ç›®å½• innobackupex -uroot -p1 --no-timestamp --incremental /backup/bak_incr1 --incremental-basedir=/backup/bak æˆ– xtrabackup -uroot -p1 --backup --target-dir=/backup/bak_incr1 --incremental-basedir=/backup/bak è¯´æ˜ï¼š --incremental-basediræ˜¯ä¸Šæ¬¡å…¨å¤‡æˆ–è€…å¢å¤‡å‡ºæ¥çš„æ–‡ä»¶å¤¹ã€‚å½“ç¬¬ä¸€æ¬¡å¢å¤‡çš„æ—¶å€™ï¼Œä¸€èˆ¬å¡«ä¸Šæ¬¡å…¨å¤‡ï¼Œç¬¬äºŒæ¬¡å¢å¤‡çš„æ—¶å€™ï¼Œå¦‚æœ--incremental-basedirå¡«ä¸Šæ¬¡å…¨å¤‡ï¼Œé‚£ä¹ˆæœ¬æ¬¡å¢å¤‡å°±ä¼šåŒ…å«ä¸Šæ¬¡å…¨å¤‡åˆ°ç°åœ¨å˜åŒ–çš„å†…å®¹ï¼Œç›¸å½“äºoracleä¾æ¬¡åš1çº§ï¼Œ2çº§ï¼Œ3çº§ã€‚ã€‚ã€‚å¢å¤‡å¦‚æœ--incremental-basedirå¡«ç¬¬ä¸€æ¬¡å¢å¤‡çš„ç›®å½•ï¼Œé‚£ä¹ˆè¯¥æ¬¡å¢å¤‡åªåŒ…å«ç¬¬ä¸€æ¬¡å¢å¤‡åˆ°ç°åœ¨çš„å˜åŒ–ï¼Œæ–‡ä»¶ä¼šæ›´å°ï¼Œç›¸å½“äºoracle rmané‡Œé¢æ¯æ¬¡éƒ½åš1çº§å¢å¤‡ã€‚ 3.2.1.3 å¢å¤‡å®ŒæˆæŸ¥çœ‹å¤‡ä»½çš„æ•°æ®ç›®å½•å¤§å° $ pwd /backup $ du -sh * 90M bak 3.2M bak_incr1 #å…¨å¤‡çš„æ•°æ®å¤§å° $ du -sh * 4.0K backup-my.cnf 33M db1 33M db2 24K db3 4.0K ib_buffer_pool 12M ibdata1 12M mysql 1.1M performance_schema 680K sys 4.0K xtrabackup_binlog_info 4.0K xtrabackup_checkpoints 4.0K xtrabackup_info 4.0K xtrabackup_logfile #å¢å¤‡çš„æ•°æ®å¤§å° $ du -sh * 4.0K backup-my.cnf 100K db1 100K db2 24K db3 4.0K ib_buffer_pool 176K ibdata1.delta 4.0K ibdata1.meta 1.2M mysql 1.1M performance_schema 604K sys 4.0K xtrabackup_binlog_info 4.0K xtrabackup_checkpoints 4.0K xtrabackup_info 4.0K xtrabackup_logfile 3.2.1.4 å…¨å¤‡çš„xtrabackup_checkpointsä¸å¢å¤‡çš„xtrabackup_checkpointsæ–‡ä»¶å¯¹æ¯” å¯ä»¥çœ‹åˆ°å¢å¤‡ä¸­çš„from_lsn = 332706875ä¸å…¨å¤‡ä¸­çš„to_lsn = 332706875æ˜¯ç›¸åŒçš„ #å…¨å¤‡ $ cat xtrabackup_checkpoints backup_type = full-backuped from_lsn = 0 to_lsn = 332706875 last_lsn = 332706884 compact = 0 recover_binlog_info = 0 flushed_lsn = 332706884 #å¢å¤‡ $ cat xtrabackup_checkpoints backup_type = incremental from_lsn = 332706875 to_lsn = 332708551 last_lsn = 332708560 compact = 0 recover_binlog_info = 0 flushed_lsn = 332708560 3.2.2 åŸºäºå¢å¤‡çš„å¢å¤‡ 3.2.2.1 æ’å…¥æ•°æ® db1ã€db2ã€db3æ¯ä¸ªæ•°æ®åº“ä¸­çš„è¡¨éƒ½æ’å…¥ä¸€æ¡æ•°æ® #db1 mysql> insert into db1_t1 values(100002,'xboyww','man',concat( 'xboyww',100002,'@qq'),concat('a',100002),concat('b',100002)); Query OK, 1 row affected (0.00 sec) mysql> insert into db1_t2 values(100002,'xboyww','man',concat( 'xboyww',100002,'@qq'),concat('a',100002),concat('b',100002)); Query OK, 1 row affected (0.00 sec) #db2 mysql> insert into db2_t1 values(100002,'xboyww','man',concat( 'xboyww',100002,'@qq'),concat('a',100002),concat('b',100002)); Query OK, 1 row affected (0.01 sec) mysql> insert into db2_t2 values(100002,'xboyww','man',concat( 'xboyww',100002,'@qq'),concat('a',100002),concat('b',100002)); Query OK, 1 row affected (0.00 sec) #db3 mysql> insert into t3 values(4,'xixixi'); Query OK, 1 row affected (0.00 sec) æŸ¥çœ‹æ¯å¼ è¡¨çš„æ•°æ® æ¯å¼ è¡¨éƒ½åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€è¡Œæ•°æ® #db1çš„ä¸¤å¼ è¡¨ mysql> select count(*) from db1_t1; +----------+ | count(*) | +----------+ | 100002 | +----------+ 1 row in set (0.03 sec) mysql> select count(*) from db1_t2; +----------+ | count(*) | +----------+ | 100002 | +----------+ 1 row in set (0.04 sec) #db2çš„ä¸¤å¼ è¡¨ mysql> select count(*) from db2_t1; +----------+ | count(*) | +----------+ | 100002 | +----------+ 1 row in set (0.04 sec) mysql> select count(*) from db2_t2; +----------+ | count(*) | +----------+ | 100002 | +----------+ 1 row in set (0.04 sec) #db3çš„ä¸€å¼ è¡¨ mysql> select count(*) from t3; +----------+ | count(*) | +----------+ | 4 | +----------+ 1 row in set (0.00 sec) 3.2.2.2 æ‰§è¡Œå¢å¤‡å‘½ä»¤ innobackupex -uroot -p1 --no-timestamp --incremental /backup/bak_incr2 --incremental-basedir=/backup/bak_incr1 æˆ– xtrabackup -uroot -p1 --backup --target-dir=/backup/bak_incr2 --incremental-basedir=/backup/bak_incr1 3.2.2.3 å¢å¤‡å®ŒæˆæŸ¥çœ‹å¤‡ä»½çš„æ•°æ®ç›®å½•å¤§å° $ pwd /backup $ du -sh * 90M bak 3.2M bak_incr1 3.2M bak_incr2 #ç¬¬ä¸€æ¬¡å¢å¤‡çš„æ•°æ®å¤§å° $ du -sh * 4.0K backup-my.cnf 100K db1 100K db2 24K db3 4.0K ib_buffer_pool 176K ibdata1.delta 4.0K ibdata1.meta 1.2M mysql 1.1M performance_schema 604K sys 4.0K xtrabackup_binlog_info 4.0K xtrabackup_checkpoints 4.0K xtrabackup_info 4.0K xtrabackup_logfile #åŸºäºå¢å¤‡çš„æ•°æ®å¤§å° du -sh * 4.0K backup-my.cnf 100K db1 100K db2 24K db3 4.0K ib_buffer_pool 144K ibdata1.delta 4.0K ibdata1.meta 1.2M mysql 1.1M performance_schema 604K sys 4.0K xtrabackup_binlog_info 4.0K xtrabackup_checkpoints 4.0K xtrabackup_info 4.0K xtrabackup_logfile 3.2.2.4 åŸºäºå¢å¤‡çš„xtrabackup_checkpointsä¸å¢å¤‡çš„xtrabackup_checkpointsæ–‡ä»¶å¯¹æ¯” ä¹‹å‰å¢å¤‡ä¸­çš„from_lsn = 332706875ä¸å…¨å¤‡ä¸­çš„to_lsn = 332706875æ˜¯ç›¸åŒçš„ åŸºäºå¢å¤‡çš„å¢å¤‡from_lsn = 332708551ä¸åŸºäºå…¨å¤‡çš„å¢å¤‡ä¸­çš„to_lsn = 332708551æ˜¯ç›¸åŒçš„ #åŸºäºå…¨å¤‡çš„å¢å¤‡ $ cat xtrabackup_checkpoints backup_type = incremental from_lsn = 332706875 to_lsn = 332708551 last_lsn = 332708560 compact = 0 recover_binlog_info = 0 flushed_lsn = 332708560 #åŸºäºå¢å¤‡çš„å¢å¤‡ä»½ $ cat xtrabackup_checkpoints backup_type = incremental from_lsn = 332708551 to_lsn = 332710179 last_lsn = 332710188 compact = 0 recover_binlog_info = 0 flushed_lsn = 332710188 3.3 å¢å¤‡æ¢å¤ 3.3.1 å…ˆå‡†å¤‡ä¸€ä¸ªå…¨å¤‡ innobackupex -uroot -p1 --apply-log --redo-only /backup/bak æˆ– xtrabackup -uroot -p --backup --target-dir=/backup/bak 3.3.2 å°†å¢å¤‡1åº”ç”¨åˆ°å…¨å¤‡ä»½ å¢å¤‡1å°±æ˜¯åŸºäºå…¨å¤‡çš„å¢å¤‡ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡å¢å¤‡âš ï¸è¿™é‡Œè¦åŠ --redo-onlyå‚æ•° è¿™æ¬¡è¦åŠ å…¥--redo-onlyå‚æ•°ï¼Œå› ä¸ºåœ¨æ¯ä¸ªå¤‡ä»½è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šç¢°åˆ°ä¸€äº›äº‹åŠ¡è¿›æ¥æ‰§è¡Œï¼Œè€Œå¤‡ä»½ç»“æŸæ—¶å¯èƒ½æœ‰äº›äº‹åŠ¡å¹¶æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥åœ¨é»˜è®¤prepareä¸­è¿™äº›äº‹åŠ¡å°±ä¼šè¢«å›æ»šï¼ˆrollbackï¼‰ï¼Œè€ŒåŠ å…¥äº†--redo-onlyå°±ä¸ä¼šå›æ»šè¿™äº›äº‹åŠ¡ï¼Œè€Œæ˜¯ç­‰å¾…prepareä¸‹æ¬¡å¢å¤‡ã€‚ innobackupex -uroot -p1 --apply-log --redo-only /backup/bak --incremental-dir=/backup/bak_incr1 æˆ– xtrabackup -uroot -p1 --prepare --apply-log-only --target-dir=/backup/bak --incremental-dir=/backup/bak_incr1 3.3.3 å°†å¢å¤‡2åº”ç”¨åˆ°å…¨å¤‡ å¢å¤‡2å°±æ˜¯åŸºäºå¢å¤‡çš„å¢å¤‡ï¼Œâš ï¸è¿™é‡Œä¸è¦åŠ --redo-onlyå‚æ•° innobackupex -uroot -p1 --apply-log /backup/bak --incremental-dir=/backup/bak_incr2 æˆ– xtrabackup -uroot -p1 --prepare --target-dir=/backup/bak --incremental-dir=/backup/bak_incr2 3.3.4 æŠŠæ‰€æœ‰åˆåœ¨ä¸€èµ·çš„å®Œå…¨å¤‡ä»½æ•´ä½“è¿›è¡Œä¸€æ¬¡applyæ“ä½œï¼Œå›æ»šæœªæäº¤çš„æ•°æ® innobackupex -uroot -p1 --apply-log /backup/bak æˆ– xtrabackup --prepare --apply-log --target-dir=/backup/bak 3.3.5 åˆ é™¤db1-3æ•°æ®åº“ mysql> drop database db1; Query OK, 2 rows affected (0.00 sec) mysql> drop database db2; Query OK, 2 rows affected (0.01 sec) mysql> drop database db3; Query OK, 1 row affected (0.00 sec) mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | sys | +--------------------+ 4 rows in set (0.00 sec) 3.3.6 åœæ­¢mysqlï¼Œåˆ é™¤åŸå…ˆæ•°æ®ç›®å½• åœæ­¢mysql $ /etc/init.d/mysqld stop Shutting down MySQL.... SUCCESS! 3.3.7 åˆ é™¤åŸå…ˆæ•°æ®ç›®å½•æˆ–è€…ä¿®æ”¹åç§° âš ï¸æ¢å¤æ•°æ®ä¹‹å‰éœ€è¦ä¿è¯æ•°æ®ç›®å½•æ˜¯ç©ºçš„çŠ¶æ€ mysqlå®‰è£…çš„æ•°æ®ç›®å½•ä¸º/usr/local/mysql/data #å¦‚æœåšåˆ é™¤æ“ä½œï¼Œæœ€å¥½å…ˆå¤‡ä»½ç„¶åå†åˆ é™¤ï¼Œè™½ç„¶æ•°æ®å·²ç»ä¸¢å¤±ä¸€éƒ¨åˆ†ï¼Œè¿™é‡Œé€‰æ‹©ä¿®æ”¹ç›®å½•åç§° mv /usr/local/mysql/data{,-bak} 3.3.8 è¿›è¡Œæ•°æ®æ¢å¤ è¿™é‡Œè¦æ³¨æ„ï¼Œæ¢å¤çš„æ—¶å€™mysqlé…ç½®æ–‡ä»¶[mysqld]ä¸‹ä¸€å®šè¦æŒ‡å®šmysql dataç›®å½• innobackupex -uroot -p1 --copy-back /backup/bak æˆ– xtrabackup -uroot p1 --copy-back --target-dir=/backup/bak 3.3.9 ç»™æ¢å¤çš„ç›®å½•é‡æ–°æˆæƒæ‰€æœ‰è€…ä¸ºmysql chown -R mysql.mysql /usr/local/mysql/data 3.3.10 å¯åŠ¨mysql $ /etc/init.d/mysqld start Starting MySQL.Logging to '/usr/local/mysql/data/error.log'. . SUCCESS! 3.3.11 éªŒè¯æ•°æ®æ¢å¤ éªŒè¯æ•°æ®åº“æ˜¯å¦è¿˜åŸ mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | db1 | | db2 | | db3 | | mysql | | performance_schema | | sys | +--------------------+ 7 rows in set (0.00 sec) éªŒè¯è¡¨ä¸­çš„æ•°æ®æ˜¯å¦è¿˜åŸ #db1ï¼Œæœ‰ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨ä¸­æœ‰10ä¸‡é›¶2æ¡æ•°æ® mysql> use db1; mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | db1_t1 | | db1_t2 | +---------------+ 2 rows in set (0.00 sec) mysql> select count(*) from db1_t1; +----------+ | count(*) | +----------+ | 100002 | +----------+ 1 row in set (0.04 sec) mysql> select count(*) from db1_t2; +----------+ | count(*) | +----------+ | 100002 | +----------+ 1 row in set (0.04 sec) #db2ï¼Œæœ‰ä¸¤å¼ è¡¨ï¼Œæ¯å¼ è¡¨ä¸­æœ‰10ä¸‡é›¶2æ¡æ•°æ® mysql> use db1; mysql> show tables; +---------------+ | Tables_in_db2 | +---------------+ | db2_t1 | | db2_t2 | +---------------+ 2 rows in set (0.00 sec) mysql> select count(*) from db2_t1; +----------+ | count(*) | +----------+ | 100002 | +----------+ 1 row in set (0.04 sec) mysql> select count(*) from db2_t2; +----------+ | count(*) | +----------+ | 100002 | +----------+ 1 row in set (0.03 sec) #db3ï¼Œæœ‰1å¼ è¡¨ï¼Œè¡¨ä¸­4è¡Œæ•°æ® mysql> use db3; mysql> show tables; +---------------+ | Tables_in_db3 | +---------------+ | t3 | +---------------+ 1 row in set (0.00 sec) mysql> select count(*) from t3; +----------+ | count(*) | +----------+ | 4 | +----------+ 1 row in set (0.00 sec) innobackupexå‘½ä»¤ä¸xtrabackupå‘½ä»¤çš„åŒºåˆ« #å…¨å¤‡ innobackupex --user=root --password=1 backup xtrabackup -uroot -p --backup --target-dir=/data/backups/ #å¢å¤‡ innobackupex -uroot -p1 --no-timestamp --incremental /backup/bak_incr2 --incremental-basedir=/backup/bak_incr1 xtrabackup -uroot -p1 --backup --target-dir=/backup/bak_incr2 --incremental-basedir=/backup/bak_incr1 éœ€è¦æ³¨æ„çš„ç‚¹ xtrabackup --apply-log-onlyåˆå¹¶é™¤æœ€åä¸€ä¸ªä»¥å¤–çš„æ‰€æœ‰å¢é‡æ—¶ä½¿ç”¨ å¢é‡å¤‡ä»½çš„æ­¥éª¤ä¸å®Œå…¨å¤‡ä»½çš„æ­¥éª¤ä¸åŒã€‚åœ¨å®Œå…¨å¤‡ä»½ä¸­ï¼Œæ‰§è¡Œä¸¤ç§ç±»å‹çš„æ“ä½œä»¥ä½¿æ•°æ®åº“ä¿æŒä¸€è‡´ï¼šå·²æäº¤çš„äº‹åŠ¡ç›¸å¯¹äºæ•°æ®æ–‡ä»¶ä»æ—¥å¿—æ–‡ä»¶ä¸­é‡æ”¾ï¼Œæœªæäº¤çš„äº‹åŠ¡è¢«å›æ»šã€‚å‡†å¤‡å¢é‡å¤‡ä»½æ—¶ï¼Œå¿…é¡»è·³è¿‡æœªæäº¤äº‹åŠ¡çš„å›æ»šï¼Œå› ä¸ºåœ¨å¤‡ä»½æ—¶æœªæäº¤çš„äº‹åŠ¡å¯èƒ½æ­£åœ¨è¿›è¡Œä¸­ï¼Œå¹¶ä¸”å¾ˆæœ‰å¯èƒ½å°†åœ¨ä¸‹ä¸€æ¬¡å¢é‡å¤‡ä»½ä¸­æäº¤ã€‚æ‚¨åº”è¯¥ä½¿ç”¨è¯¥ é€‰é¡¹æ¥é˜²æ­¢å›æ»šé˜¶æ®µã€‚xtrabackup --apply-log-only âš ï¸å¦‚æœä¸ä½¿ç”¨è¯¥é€‰é¡¹xtrabackup --apply-log-onlyé˜»æ­¢å›æ»šé˜¶æ®µï¼Œåˆ™å¢é‡å¤‡ä»½å°†æ— ç”¨ã€‚äº‹åŠ¡å›æ»šåï¼Œä¸èƒ½å†åº”ç”¨å¢é‡å¤‡ä»½ å››ã€å¤‡ä»½è„šæœ¬ æˆæƒ CREATE USER 'bkpuser'@'localhost' IDENTIFIED BY 'bkpuser@1234'; GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT,super ON *.* TO 'bkpuser'@'localhost'; FLUSH PRIVILEGES; å…¨å¤‡è„šæœ¬ #!/bin/bash local_ip=\"$(/sbin/ifconfig ens160|grep 'inet'|grep -v '::'| awk '{print $2}')\" user='bkpuser' passwd='bkpuser@1234' config='/etc/my.cnf' backup_path='/tmsdata/xtrabackup_full' backup_date=`date +\"%Y%m%d_%H%M%S\"` backup_dir=\"$backup_path/$backup_date/\" backup_log=\"$backup_path/log\" #é‚®ä»¶è®¾ç½® title1='percona xtrabackup information(success)' title2='percona xtrabackup information(failed)' content1='Server_name:'$(hostname)' \\n Server_ip:'$local_ip' \\n '$(date +\"%y-%m-%d %H:%M:%S\")' \\n mysql full backup Success!' content2='Server_name:'$(hostname)' \\n Server_ip:'$local_ip' \\n '$(date +\"%y-%m-%d %H:%M:%S\")' \\n mysql full backup Faild!' #åˆ¤æ–­å¤‡ä»½ç›®å½•æ˜¯å¦å­˜åœ¨ if [ ! -d \"$backup_dir\" ] && [ ! -d \"$backup_log\" ];then mkdir -p $backup_dir && mkdir -p $backup_log fi #[[ -d $backup_dir ]] || mkdir -p $backup_dir #[[ -d $backup_log ]] || mkdir -p $backup_log echo \"=========================================Start to backup at $(date +%Y%m%d-%H:%M:%S)=========================================\" >> $backup_log/$backup_date.log #å¼€å§‹å¤‡ä»½ xtrabackup --defaults-file=$config --user=$user --password=\"$passwd\" --backup --target-dir=$backup_dir &>> $backup_log/$backup_date.log if [ $? -eq 0 ];then echo \"Backup is success! at $(date +%Y%m%d%H%M)\" echo \"Server_name:$(hostname) Server_ip:$local_ip $(date +\"%y-%m-%d %H:%M:%S\") mysql full backup Success!\" >> $backup_log/$backup_date.log echo \"$content1\" | mail -s \"$title1\" huangwb@fslgz.com else echo \"Backup is Fail! at $(date +%Y%m%d%H%M)\" echo \"Server_name:$(hostname) Server_ip:$local_ip $(date +\"%y-%m-%d %H:%M:%S\") mysql full backup Fail!\" >> $backup_log/$backup_date.log echo \"$content2\" | mail -s \"$title2\" huangwb@fslgz.com fi sleep 3 #xtrabackupä»è¯¥æ–‡ä»¶è¯»å–æœ€è¿‘ä¸€æ¬¡çš„å…¨å¤‡è·¯å¾„ egrep \".* Backup created in directory .*\" $backup_log/$backup_date.log >> $backup_path/complete.info #æ¸…é™¤è¶…è¿‡14å¤©çš„å¤‡ä»½ find $backup_path -mtime +14 -type d -exec rm -rf {} \\; echo \"Backup Process Done\" å¢å¤‡è„šæœ¬ #!/bin/bash local_ip=\"$(/sbin/ifconfig ens160|grep 'inet'|grep -v '::'| awk '{print $2}')\" user='bkpuser' passwd='bkpuser@1234' config='/etc/my.cnf' backup_full='/tmsdata/xtrabackup_full' backup_path='/tmsdata/xtrabackup_incr' backup_date=`date +\"%Y%m%d_%H%M%S\"` backup_dir=\"$backup_path/$backup_date/\" backup_log=\"$backup_path/log\" FULL_BASE_DIR=$(tail -1 $backup_full/complete.info | cut -d\\' -f2) #åˆ¤æ–­å¤‡ä»½ç›®å½•æ˜¯å¦å­˜åœ¨ if [ ! -d \"$backup_dir\" ] && [ ! -d \"$backup_log\" ];then mkdir -p $backup_dir && mkdir -p $backup_log fi #[[ -d $backup_dir ]] || mkdir -p $backup_dir #[[ -d $backup_log ]] || mkdir -p $backup_log echo \"========================================xtrabackupæ ¹æ®$FULL_BASE_DIRç›®å½•å¼€å§‹å¢å¤‡=========================================\" >> $backup_log/$backup_date.log #é‚®ä»¶è®¾ç½® title1='percona xtrabackup information(success)' title2='percona xtrabackup information(failed)' content1='Server_name:'$(hostname)' Server_ip:'$local_ip' '$(date +\"%y-%m-%d %H:%M:%S\")' mysql increment backup Success!' content2='Server_name:'$(hostname)' Server_ip:'$local_ip' '$(date +\"%y-%m-%d %H:%M:%S\")' mysql increment backup Faild!' echo \"=========================================Start to backup at $(date +%Y%m%d-%H:%M:%S)=========================================\" >> $backup_log/$backup_date.log #å¼€å§‹å¤‡ä»½ xtrabackup --defaults-file=$config --user=$user --password=\"$passwd\" --backup --target-dir=$backup_dir --incremental-basedir=$FULL_BASE_DIR &>> $backup_log/$backup_date.log if [ $? -eq 0 ];then echo \"Backup is success! at $(date +%Y%m%d%H%M)\" echo \"Server_name:$(hostname) Server_ip:$local_ip $(date +\"%y-%m-%d %H:%M:%S\") mysql full backup Success!\" >> $backup_log/$backup_date.log echo \"$content1\" | mail -s \"$title1\" huangwb@fslgz.com else echo \"Backup is Fail! at $(date +%Y%m%d%H%M)\" echo \"Server_name:$(hostname) Server_ip:$local_ip $(date +\"%y-%m-%d %H:%M:%S\") mysql full backup Fail!\" >> $backup_log/$backup_date.log echo \"$content2\" | mail -s \"$title2\" huangwb@fslgz.com fi #æ¸…é™¤è¶…è¿‡14å¤©çš„å¤‡ä»½ find $backup_path -mtime +14 -type d -exec rm -rf {} \\; echo \"Backup Process Done\" æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlè¿›é˜¶/1.mysqlå¤šå®ä¾‹-5.6.40.html":{"url":"db/mysql/mysqlè¿›é˜¶/1.mysqlå¤šå®ä¾‹-5.6.40.html","title":"5.6.40","keywords":"","body":"mysqlå¤šå®ä¾‹-5.6.40 1.mysqlå¤šå®ä¾‹ä»‹ç» 1.1ä»€ä¹ˆæ˜¯MySQLå¤šå®ä¾‹ MySQLå¤šå®ä¾‹å°±æ˜¯åœ¨ä¸€å°æœºå™¨ä¸Šå¼€å¯å¤šä¸ªä¸åŒçš„æœåŠ¡ç«¯å£ï¼ˆå¦‚ï¼š3306,3307ï¼‰ï¼Œè¿è¡Œå¤šä¸ªMySQLæœåŠ¡è¿›ç¨‹ï¼Œé€šè¿‡ä¸åŒçš„socketç›‘å¬ä¸åŒçš„æœåŠ¡ç«¯å£æ¥æä¾›å„è‡ªçš„æœåŠ¡ 1.2MySQLå¤šå®ä¾‹çš„ç‰¹ç‚¹æœ‰ä»¥ä¸‹å‡ ç‚¹ 1ï¼šæœ‰æ•ˆåˆ©ç”¨æœåŠ¡å™¨èµ„æºï¼Œå½“å•ä¸ªæœåŠ¡å™¨èµ„æºæœ‰å‰©ä½™æ—¶ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å‰©ä½™çš„èµ„æºæä¾›æ›´å¤šçš„æœåŠ¡ 2ï¼šèŠ‚çº¦æœåŠ¡å™¨èµ„æº 3ï¼šèµ„æºäº’ç›¸æŠ¢å é—®é¢˜ï¼Œå½“æŸä¸ªæœåŠ¡å®ä¾‹æœåŠ¡å¹¶å‘å¾ˆé«˜æ—¶æˆ–è€…å¼€å¯æ…¢æŸ¥è¯¢æ—¶ï¼Œä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€CPUã€ç£ç›˜IOèµ„æºï¼Œå¯¼è‡´æœåŠ¡å™¨ä¸Šçš„å…¶ä»–å®ä¾‹æä¾›æœåŠ¡çš„è´¨é‡ä¸‹é™ 1.3éƒ¨ç½²mysqlå¤šå®ä¾‹çš„ä¸¤ç§æ–¹å¼ ç¬¬ä¸€ç§æ˜¯ä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶å¯åŠ¨ä¸åŒçš„è¿›ç¨‹æ¥å®ç°å¤šå®ä¾‹ï¼Œè¿™ç§æ–¹å¼çš„ä¼˜åŠ¿é€»è¾‘ç®€å•ï¼Œé…ç½®ç®€å•ï¼Œç¼ºç‚¹æ˜¯ç®¡ç†èµ·æ¥ä¸å¤ªæ–¹ä¾¿ ç¬¬äºŒç§æ˜¯é€šè¿‡å®˜æ–¹è‡ªå¸¦çš„mysqld_multiä½¿ç”¨å•ç‹¬çš„é…ç½®æ–‡ä»¶æ¥å®ç°å¤šå®ä¾‹ï¼Œè¿™ç§æ–¹å¼å®šåˆ¶æ¯ä¸ªå®ä¾‹çš„é…ç½®ä¸å¤ªæ–¹é¢ï¼Œä¼˜ç‚¹æ˜¯ç®¡ç†èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œé›†ä¸­ç®¡ç† 1.4åŒä¸€å¼€å‘ç¯å¢ƒä¸‹å®‰è£…ä¸¤ä¸ªæ•°æ®åº“ï¼Œå¿…é¡»å¤„ç†ä»¥ä¸‹é—®é¢˜ é…ç½®æ–‡ä»¶å®‰è£…è·¯å¾„ä¸èƒ½ç›¸åŒ æ•°æ®åº“ç›®å½•ä¸èƒ½ç›¸åŒ å¯åŠ¨è„šæœ¬ä¸èƒ½åŒå ç«¯å£ä¸èƒ½ç›¸åŒ socketæ–‡ä»¶çš„ç”Ÿæˆè·¯å¾„ä¸èƒ½ç›¸åŒ 2.mysqlå¤šå®ä¾‹å®‰è£…è·¯å¾„è¯´æ˜ mysqlå®‰è£…è·¯å¾„ ç¬¬ä¸€ä¸ªå®ä¾‹ï¼š/data/mysql3306 ç¬¬äºŒä¸ªå®ä¾‹ï¼š/data/mysql3307 ç¬¬ä¸‰ä¸ªå®ä¾‹ï¼š/data/mysql3308 3.å®‰è£…éƒ¨ç½²è¿‡ç¨‹ 3.1å®‰è£…ä¾èµ–åŒ… yum -y install gcc gcc-c++ autoconf bison-devel ncurses-devel libaio-devel 3.2åˆ›å»ºmysqlç”¨æˆ·å’Œç»„ groupadd mysql && useradd -g mysql -s /sbin/nologin mysql 3.3ä¸‹è½½mysql-5.6.40äºŒè¿›åˆ¶åŒ… wget https://downloads.mysql.com/archives/get/file/mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz 3.4è§£å‹ç¼©å¹¶ä¿®æ”¹ç›®å½•åç§° tar xf mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz && \\ mv mysql-5.6.40-linux-glibc2.12-x86_64/ mysql-5.6.40 3.5ä¿®æ”¹ç›®å½•æ‰€æœ‰è€…ä¸ºmysql chown -R mysql.mysql mysql-5.6.40 3.6åˆ›å»º3ä¸ªmysqlå®‰è£…ç›®å½• mkdir -p /data/mysql330{6..8} 3.7å°†mysqlåŒ…åˆ†åˆ«æ‹·è´åˆ°3ä¸ªå®‰è£…ç›®å½• for i in {6..8};do cp -rp mysql-5.6.40 /data/mysql330$i ;done 3.8åšè½¯è¿æ¥ for i in {6..8};do ln -s /data/mysql330$i/mysql-5.6.40 /data/mysql330$i/mysql;done 3.9ç¼–è¾‘é…ç½®æ–‡ä»¶ basedirã€datadirã€log-errorã€portã€socketæ–‡ä»¶ä½ç½®ä¸åŒï¼Œå¦‚æœè¦åšä¸»ä»ï¼Œserveridè¦ä¸åŒ //å¤‡ä»½åŸæœ‰/etc/my.cnf mv /etc/my.cnf /etc/my.cnf.old //ç¼–è¾‘ç¬¬ä¸€ä¸ªå®ä¾‹é…ç½®æ–‡ä»¶ cat >/etc/my-3306.cnf/etc/my-3307.cnf/etc/my-3308.cnf 3.10æ‹·è´å¯åŠ¨è„šæœ¬ //åˆ†åˆ«æ‹·è´3ä¸ªå®ä¾‹å¯åŠ¨è„šæœ¬ for i in {6..8};do cp mysql-5.6.40/support-files/mysql.server /etc/init.d/mysqld330$i ;done //ä¿®æ”¹æ–‡ä»¶ sed -i.bak 's#/usr/local#/data/mysql3306#g' /etc/init.d/mysqld3306 /data/mysql3306/mysql/bin/mysqld_safe sed -i.bak 's#/usr/local#/data/mysql3307#g' /etc/init.d/mysqld3307 /data/mysql3307/mysql/bin/mysqld_safe sed -i.bak 's#/usr/local#/data/mysql3308#g' /etc/init.d/mysqld3308 /data/mysql3308/mysql/bin/mysqld_safe 3.11åˆå§‹åŒ–mysql //åˆå§‹åŒ–ç¬¬ä¸€ä¸ªå®ä¾‹ /data/mysql3306/mysql/scripts/mysql_install_db --user=mysql --basedir=/data/mysql3306/mysql --datadir=/data/mysql3306/mysql/data //åˆå§‹åŒ–ç¬¬äºŒä¸ªå®ä¾‹ /data/mysql3307/mysql/scripts/mysql_install_db --user=mysql --basedir=/data/mysql3307/mysql --datadir=/data/mysql3307/mysql/data //åˆå§‹åŒ–ç¬¬ä¸‰ä¸ªå®ä¾‹ /data/mysql3308/mysql/scripts/mysql_install_db --user=mysql --basedir=/data/mysql3308/mysql --datadir=/data/mysql3308/mysql/data 3.12æ·»åŠ mysqlå‘½ä»¤ç¯å¢ƒå˜é‡ //è¿™é‡Œåªéœ€è¦å¯¼å‡ºä¸€ä¸ªå³å¯ echo \"export PATH=/data/mysql3306/mysql/bin:$PATH\" > /etc/profile.d/mysql.sh source /etc/profile 3.13é…ç½®systemdç®¡ç†mysql //é…ç½®ç¬¬ä¸€ä¸ªå®ä¾‹ cat >/etc/systemd/system/mysqld3306.service/etc/systemd/system/mysqld3307.service/etc/systemd/system/mysqld3308.service 3.14å¯åŠ¨mysqlã€æ£€æŸ¥å¯åŠ¨ //å¯åŠ¨mysql systemctl start mysqld3306 ; systemctl enable mysqld3306 systemctl start mysqld3307 ; systemctl enable mysqld3307 systemctl start mysqld3308 ; systemctl enable mysqld3308 //æ£€æŸ¥å¯åŠ¨ netstat -ntpl|grep 330* tcp6 0 0 :::3306 :::* LISTEN 16413/mysqld tcp6 0 0 :::3307 :::* LISTEN 16422/mysqld tcp6 0 0 :::3308 :::* LISTEN 16463/mysqld 3.15è¿›å…¥mysqlï¼Œè®¾ç½®å¯†ç  //è®¾ç½®ç¬¬ä¸€ä¸ªå®ä¾‹å¯†ç  mysql -S /data/mysql3306/mysql/mysql.sock mysql> set password=password('3306'); mysql> flush privileges; //è®¾ç½®ç¬¬äºŒä¸ªå®ä¾‹å¯†ç  mysql -S /data/mysql3307/mysql/mysql.sock mysql> set password=password('3307'); mysql> flush privileges; //è®¾ç½®ç¬¬ä¸‰ä¸ªå®ä¾‹å¯†ç  mysql -S /data/mysql3308/mysql/mysql.sock mysql> set password=password('3308'); mysql> flush privileges; 3.16è®¾ç½®å¿«æ·ç™»é™† //åŸæœ‰ç™»é™†æ–¹å¼ï¼Œéœ€è¦æŒ‡å®šmysqlç”¨æˆ·åå¯†ç å’Œå¥—æ¥å­—æ–‡ä»¶ mysql -uroot -p3306 -S /data/mysql3306/mysql/mysql.sock è®¾ç½®å¿«æ·ç™»é™† //è®¾ç½®ç¬¬ä¸€ä¸ªå®ä¾‹ cat >/usr/bin/mysql3306/usr/bin/mysql3307/usr/bin/mysql3308 åˆ°æ­¤ï¼Œmysqlå¤šå®ä¾‹é…ç½®å®Œæˆï¼ï¼ï¼ æ‰©å±•ï¼šåŸºäºä»¥ä¸Šå¤šå®ä¾‹å®ç°mysqlä¸»ä»å¤åˆ¶ 3306ä¸ºä¸» 3307ã€3308ä¸ºä» 1.ç¼–è¾‘ä¸»åº“3306ï¼ˆmasterï¼‰é…ç½®æ–‡ä»¶/etc/my-3306.cnf vim /etc/my-3306.cnf #[mysqld]ä¸‹æ–¹å¢åŠ ä»¥ä¸‹3è¡Œ server_id=3306 log_bin=binlog log_bin_index=binlog.index //é‡å¯mysql systemctl restart mysqld3306 2.åˆ›å»ºä¸“ç”¨å¤åˆ¶ç”¨æˆ· mysql3306 mysql> grant replication slave on *.* to 'backup'@'10.0.0.%' identified by '3306'; Query OK, 0 rows affected (0.01 sec) 3.æŸ¥çœ‹masterçŠ¶æ€ mysql> show master status; +---------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +---------------+----------+--------------+------------------+-------------------+ | binlog.000001 | 327 | | | | +---------------+----------+--------------+------------------+-------------------+ 1 row in set (0.00 sec) 4.ç¼–è¾‘ä»åº“é…ç½®æ–‡ä»¶ //ç¼–è¾‘3307é…ç½®æ–‡ä»¶ [root@mysql ~]# vim /etc/my-3307.cnf #[mysqld]ä¸‹æ–¹å¢åŠ ä»¥ä¸‹3è¡Œ server_id=3307 relay_log=/data/mysql3307/mysql/relay_log relay_log_index=/data/mysql3307/mysql/relay_log.index //ç¼–è¾‘3308é…ç½®æ–‡ä»¶ [root@mysql ~]# vim /etc/my-3308.cnf #[mysqld]ä¸‹æ–¹å¢åŠ ä»¥ä¸‹3è¡Œ server_id=3308 relay_log=/data/mysql3308/mysql/relay_log relay_log_index=/data/mysql3308/mysql/relay_log.index //é‡å¯mysql [root@mysql ~]# systemctl restart mysqld3307 && systemctl restart mysqld3308 5.è®¾ç½®slaveä»masteræ‹‰å–binlogåŠæ‹‰å–çš„ä½ç½® //3307 mysql> change master to master_host='10.0.0.55',master_port=3306,master_user='backup',master_password='123',master_log_file='binlog.000001',master_log_pos=327; Query OK, 0 rows affected, 2 warnings (0.06 sec) //å¯åŠ¨slave mysql> start slave; Query OK, 0 rows affected (0.01 sec) //æŸ¥çœ‹slaveçŠ¶æ€ mysql> show slave status\\G #IOçº¿ç¨‹å’ŒSQLçº¿ç¨‹éƒ½å¿…é¡»ä¸ºYES Slave_IO_Running: Yes Slave_SQL_Running: Yes ------------------------------------------------------------------------------ //3308 mysql> change master to master_host='10.0.0.55',master_port=3306,master_user='backup',master_password='123',master_log_file='binlog.000001',master_log_pos=327; Query OK, 0 rows affected, 2 warnings (0.02 sec) //å¯åŠ¨slave mysql> start slave; Query OK, 0 rows affected (0.00 sec) //æŸ¥çœ‹slaveçŠ¶æ€ mysql> show slave status\\G #IOçº¿ç¨‹å’ŒSQLçº¿ç¨‹éƒ½å¿…é¡»ä¸ºYES Slave_IO_Running: Yes Slave_SQL_Running: Yes 6.éªŒè¯ï¼Œåœ¨3306ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œçœ‹3307å’Œ3308æ˜¯å¦ä¼šåŒæ­¥ //3306ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ mysql> create database bxb; Query OK, 1 row affected (0.00 sec) mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | DB3306 | | bxb | | mysql | | performance_schema | | test | +--------------------+ 6 rows in set (0.00 sec) //3307ä¸­æŸ¥çœ‹æ•°æ®åº“ mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | DB3307 | | bxb | | mysql | | performance_schema | | test | +--------------------+ 6 rows in set (0.00 sec) //3308ä¸­æŸ¥çœ‹æ•°æ®åº“ mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | DB3308 | | bxb | | mysql | | performance_schema | | test | +--------------------+ 6 rows in set (0.01 sec) åˆ°æ­¤ï¼ŒmysqlåŸºäºå¤šå®ä¾‹å®ç°ä¸»ä»å¤åˆ¶å®Œæˆï¼ï¼ï¼ å®éªŒè¿‡ç¨‹ä¸­é‡åˆ°çš„é”™è¯¯ åœ¨3308ï¼ˆç¬¬äºŒä¸ªå®ä¾‹ï¼‰ä¸Šå¯åŠ¨slaveæŠ¥é”™ //å¯åŠ¨slaveæŠ¥é”™ï¼Œä»å­˜å‚¨åº“åˆå§‹åŒ–ä¸­ç»§æ—¥å¿—ä¿¡æ¯ç»“æ„å¤±è´¥ mysql> start slave; ERROR 1872 (HY000): Slave failed to initialize relay log info structure from the repository è§£å†³æ–¹æ³•ï¼šå…ˆé‡ç½®slave,ç„¶ååœæ­¢slvaeå†é‡æ–°change master mysql> reset slave all; Query OK, 0 rows affected (0.02 sec) mysql> stop slave; æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlè¿›é˜¶/2.mysqlå¤šå®ä¾‹-5.7.23.html":{"url":"db/mysql/mysqlè¿›é˜¶/2.mysqlå¤šå®ä¾‹-5.7.23.html","title":"5.7.23","keywords":"","body":"mysqlå¤šå®ä¾‹-5.7.23 1.mysqlå¤šå®ä¾‹ä»‹ç» 1.1ä»€ä¹ˆæ˜¯MySQLå¤šå®ä¾‹ MySQLå¤šå®ä¾‹å°±æ˜¯åœ¨ä¸€å°æœºå™¨ä¸Šå¼€å¯å¤šä¸ªä¸åŒçš„æœåŠ¡ç«¯å£ï¼ˆå¦‚ï¼š3306,3307ï¼‰ï¼Œè¿è¡Œå¤šä¸ªMySQLæœåŠ¡è¿›ç¨‹ï¼Œé€šè¿‡ä¸åŒçš„socketç›‘å¬ä¸åŒçš„æœåŠ¡ç«¯å£æ¥æä¾›å„è‡ªçš„æœåŠ¡ 1.2MySQLå¤šå®ä¾‹çš„ç‰¹ç‚¹æœ‰ä»¥ä¸‹å‡ ç‚¹ 1ï¼šæœ‰æ•ˆåˆ©ç”¨æœåŠ¡å™¨èµ„æºï¼Œå½“å•ä¸ªæœåŠ¡å™¨èµ„æºæœ‰å‰©ä½™æ—¶ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å‰©ä½™çš„èµ„æºæä¾›æ›´å¤šçš„æœåŠ¡ 2ï¼šèŠ‚çº¦æœåŠ¡å™¨èµ„æº 3ï¼šèµ„æºäº’ç›¸æŠ¢å é—®é¢˜ï¼Œå½“æŸä¸ªæœåŠ¡å®ä¾‹æœåŠ¡å¹¶å‘å¾ˆé«˜æ—¶æˆ–è€…å¼€å¯æ…¢æŸ¥è¯¢æ—¶ï¼Œä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€CPUã€ç£ç›˜IOèµ„æºï¼Œå¯¼è‡´æœåŠ¡å™¨ä¸Šçš„å…¶ä»–å®ä¾‹æä¾›æœåŠ¡çš„è´¨é‡ä¸‹é™ 1.3éƒ¨ç½²mysqlå¤šå®ä¾‹çš„ä¸¤ç§æ–¹å¼ ç¬¬ä¸€ç§æ˜¯ä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶å¯åŠ¨ä¸åŒçš„è¿›ç¨‹æ¥å®ç°å¤šå®ä¾‹ï¼Œè¿™ç§æ–¹å¼çš„ä¼˜åŠ¿é€»è¾‘ç®€å•ï¼Œé…ç½®ç®€å•ï¼Œç¼ºç‚¹æ˜¯ç®¡ç†èµ·æ¥ä¸å¤ªæ–¹ä¾¿ ç¬¬äºŒç§æ˜¯é€šè¿‡å®˜æ–¹è‡ªå¸¦çš„mysqld_multiä½¿ç”¨å•ç‹¬çš„é…ç½®æ–‡ä»¶æ¥å®ç°å¤šå®ä¾‹ï¼Œè¿™ç§æ–¹å¼å®šåˆ¶æ¯ä¸ªå®ä¾‹çš„é…ç½®ä¸å¤ªæ–¹é¢ï¼Œä¼˜ç‚¹æ˜¯ç®¡ç†èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œé›†ä¸­ç®¡ç† 1.4åŒä¸€å¼€å‘ç¯å¢ƒä¸‹å®‰è£…ä¸¤ä¸ªæ•°æ®åº“ï¼Œå¿…é¡»å¤„ç†ä»¥ä¸‹é—®é¢˜ é…ç½®æ–‡ä»¶å®‰è£…è·¯å¾„ä¸èƒ½ç›¸åŒ æ•°æ®åº“ç›®å½•ä¸èƒ½ç›¸åŒ å¯åŠ¨è„šæœ¬ä¸èƒ½åŒå ç«¯å£ä¸èƒ½ç›¸åŒ socketæ–‡ä»¶çš„ç”Ÿæˆè·¯å¾„ä¸èƒ½ç›¸åŒ 2.mysqlå¤šå®ä¾‹å®‰è£…è·¯å¾„è¯´æ˜ mysqlå®‰è£…è·¯å¾„ ç¬¬ä¸€ä¸ªå®ä¾‹ï¼š/data/mysql3306 ç¬¬äºŒä¸ªå®ä¾‹ï¼š/data/mysql3307 ç¬¬ä¸‰ä¸ªå®ä¾‹ï¼š/data/mysql3308 3.å®‰è£…éƒ¨ç½²è¿‡ç¨‹ 3.1å®‰è£…ä¾èµ–åŒ… yum -y install gcc gcc-c++ autoconf bison-devel ncurses-devel libaio-devel 3.2åˆ›å»ºmysqlç”¨æˆ·å’Œç»„ groupadd mysql && useradd -g mysql -s /sbin/nologin mysql 3.3ä¸‹è½½mysql-5.7.23äºŒè¿›åˆ¶åŒ… wget https://downloads.mysql.com/archives/get/file/mysql-5.7.23-linux-glibc2.12-x86_64.tar.gz 3.4è§£å‹ç¼©å¹¶ä¿®æ”¹ç›®å½•åç§° tar xf mysql-5.7.23-linux-glibc2.12-x86_64.tar.gz && \\ mv mysql-5.7.23-linux-glibc2.12-x86_64/ mysql-5.7.23 3.5ä¿®æ”¹ç›®å½•æ‰€æœ‰è€…ä¸ºmysql chown -R mysql.mysql mysql-5.7.23 3.6åˆ›å»º3ä¸ªmysqlå®‰è£…ç›®å½• mkdir -p /data/mysql330{6..8} 3.7å°†mysqlåŒ…åˆ†åˆ«æ‹·è´åˆ°3ä¸ªå®‰è£…ç›®å½• for i in {6..8};do cp -rp mysql-5.7.23 /data/mysql330$i ;done 3.8åšè½¯è¿æ¥ for i in {6..8};do ln -s /data/mysql330$i/mysql-5.7.23 /data/mysql330$i/mysql;done 3.9ç¼–è¾‘é…ç½®æ–‡ä»¶ basedirã€datadirã€log-errorã€portã€socketæ–‡ä»¶ä½ç½®ä¸åŒï¼Œå¦‚æœè¦åšä¸»ä»ï¼Œserveridè¦ä¸åŒ //å¤‡ä»½åŸæœ‰/etc/my.cnf mv /etc/my.cnf /etc/my.cnf.old //ç¼–è¾‘ç¬¬ä¸€ä¸ªå®ä¾‹é…ç½®æ–‡ä»¶ cat >/etc/my-3306.cnf/etc/my-3307.cnf/etc/my-3308.cnf 3.10æ‹·è´å¯åŠ¨è„šæœ¬ //åˆ†åˆ«æ‹·è´3ä¸ªå®ä¾‹å¯åŠ¨è„šæœ¬ for i in {6..8};do cp mysql-5.7.23/support-files/mysql.server /etc/init.d/mysqld330$i ;done //ä¿®æ”¹æ–‡ä»¶ sed -i.bak 's#/usr/local#/data/mysql3306#g' /etc/init.d/mysqld3306 /data/mysql3306/mysql/bin/mysqld_safe sed -i.bak 's#/usr/local#/data/mysql3307#g' /etc/init.d/mysqld3307 /data/mysql3307/mysql/bin/mysqld_safe sed -i.bak 's#/usr/local#/data/mysql3308#g' /etc/init.d/mysqld3308 /data/mysql3308/mysql/bin/mysqld_safe 3.11åˆå§‹åŒ–mysql //åˆå§‹åŒ–ç¬¬ä¸€ä¸ªå®ä¾‹ /data/mysql3306/bin/mysqld --initialize-insecure --user=mysql --basedir=/data/mysql3306 --datadir=/data/mysql3306/data //åˆå§‹åŒ–ç¬¬äºŒä¸ªå®ä¾‹ /data/mysql3306/bin/mysqld --initialize-insecure --user=mysql --basedir=/data/mysql3306 --datadir=/data/mysql3306/data //åˆå§‹åŒ–ç¬¬ä¸‰ä¸ªå®ä¾‹ /data/mysql3306/bin/mysqld --initialize-insecure --user=mysql --basedir=/data/mysql3306 --datadir=/data/mysql3306/data 3.12æ·»åŠ mysqlå‘½ä»¤ç¯å¢ƒå˜é‡ //è¿™é‡Œåªéœ€è¦å¯¼å‡ºä¸€ä¸ªå³å¯ echo \"export PATH=/data/mysql3306/mysql/bin:$PATH\" > /etc/profile.d/mysql.sh source /etc/profile 3.13é…ç½®systemdç®¡ç†mysql //é…ç½®ç¬¬ä¸€ä¸ªå®ä¾‹ cat >/etc/systemd/system/mysqld3306.service/etc/systemd/system/mysqld3307.service/etc/systemd/system/mysqld3308.service 3.14å¯åŠ¨mysqlã€æ£€æŸ¥å¯åŠ¨ //å¯åŠ¨mysql systemctl start mysqld3306 ; systemctl enable mysqld3306 systemctl start mysqld3307 ; systemctl enable mysqld3307 systemctl start mysqld3308 ; systemctl enable mysqld3308 //æ£€æŸ¥å¯åŠ¨ netstat -ntpl|grep 330* tcp6 0 0 :::3306 :::* LISTEN 16413/mysqld tcp6 0 0 :::3307 :::* LISTEN 16422/mysqld tcp6 0 0 :::3308 :::* LISTEN 16463/mysqld 3.15è¿›å…¥mysqlï¼Œè®¾ç½®å¯†ç  //è®¾ç½®ç¬¬ä¸€ä¸ªå®ä¾‹å¯†ç  mysql -S /data/mysql3306/mysql/mysql.sock mysql> set password=password('3306'); mysql> flush privileges; //è®¾ç½®ç¬¬äºŒä¸ªå®ä¾‹å¯†ç  mysql -S /data/mysql3307/mysql/mysql.sock mysql> set password=password('3307'); mysql> flush privileges; //è®¾ç½®ç¬¬ä¸‰ä¸ªå®ä¾‹å¯†ç  mysql -S /data/mysql3308/mysql/mysql.sock mysql> set password=password('3308'); mysql> flush privileges; 3.16è®¾ç½®å¿«æ·ç™»é™† //åŸæœ‰ç™»é™†æ–¹å¼ï¼Œéœ€è¦æŒ‡å®šmysqlç”¨æˆ·åå¯†ç å’Œå¥—æ¥å­—æ–‡ä»¶ mysql -uroot -p3306 -S /data/mysql3306/mysql/mysql.sock è®¾ç½®å¿«æ·ç™»é™† //è®¾ç½®ç¬¬ä¸€ä¸ªå®ä¾‹ cat >/usr/bin/mysql3306/usr/bin/mysql3307/usr/bin/mysql3308 åˆ°æ­¤ï¼Œmysqlå¤šå®ä¾‹é…ç½®å®Œæˆï¼ï¼ï¼ æ‰©å±•ï¼šåŸºäºä»¥ä¸Šå¤šå®ä¾‹å®ç°mysqlä¸»ä»å¤åˆ¶ 3306ä¸ºä¸» 3307ã€3308ä¸ºä» 1.ç¼–è¾‘ä¸»åº“3306ï¼ˆmasterï¼‰é…ç½®æ–‡ä»¶/etc/my-3306.cnf vim /etc/my-3306.cnf #[mysqld]ä¸‹æ–¹å¢åŠ ä»¥ä¸‹3è¡Œ server_id=3306 log_bin=binlog log_bin_index=binlog.index //é‡å¯mysql systemctl restart mysqld3306 2.åˆ›å»ºä¸“ç”¨å¤åˆ¶ç”¨æˆ· mysql3306 mysql> grant replication slave on *.* to 'backup'@'10.0.0.%' identified by '3306'; Query OK, 0 rows affected (0.01 sec) 3.æŸ¥çœ‹masterçŠ¶æ€ mysql> show master status; +---------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +---------------+----------+--------------+------------------+-------------------+ | binlog.000001 | 327 | | | | +---------------+----------+--------------+------------------+-------------------+ 1 row in set (0.00 sec) 4.ç¼–è¾‘ä»åº“é…ç½®æ–‡ä»¶ //ç¼–è¾‘3307é…ç½®æ–‡ä»¶ [root@mysql ~]# vim /etc/my-3307.cnf #[mysqld]ä¸‹æ–¹å¢åŠ ä»¥ä¸‹3è¡Œ server_id=3307 relay_log=/data/mysql3307/mysql/relay_log relay_log_index=/data/mysql3307/mysql/relay_log.index //ç¼–è¾‘3308é…ç½®æ–‡ä»¶ [root@mysql ~]# vim /etc/my-3308.cnf #[mysqld]ä¸‹æ–¹å¢åŠ ä»¥ä¸‹3è¡Œ server_id=3308 relay_log=/data/mysql3308/mysql/relay_log relay_log_index=/data/mysql3308/mysql/relay_log.index //é‡å¯mysql [root@mysql ~]# systemctl restart mysqld3307 && systemctl restart mysqld3308 5.è®¾ç½®slaveä»masteræ‹‰å–binlogåŠæ‹‰å–çš„ä½ç½® //3307 mysql> change master to master_host='10.0.0.55',master_port=3306,master_user='backup',master_password='123',master_log_file='binlog.000001',master_log_pos=327; Query OK, 0 rows affected, 2 warnings (0.06 sec) //å¯åŠ¨slave mysql> start slave; Query OK, 0 rows affected (0.01 sec) //æŸ¥çœ‹slaveçŠ¶æ€ mysql> show slave status\\G #IOçº¿ç¨‹å’ŒSQLçº¿ç¨‹éƒ½å¿…é¡»ä¸ºYES Slave_IO_Running: Yes Slave_SQL_Running: Yes ------------------------------------------------------------------------------ //3308 mysql> change master to master_host='10.0.0.55',master_port=3306,master_user='backup',master_password='123',master_log_file='binlog.000001',master_log_pos=327; Query OK, 0 rows affected, 2 warnings (0.02 sec) //å¯åŠ¨slave mysql> start slave; Query OK, 0 rows affected (0.00 sec) //æŸ¥çœ‹slaveçŠ¶æ€ mysql> show slave status\\G #IOçº¿ç¨‹å’ŒSQLçº¿ç¨‹éƒ½å¿…é¡»ä¸ºYES Slave_IO_Running: Yes Slave_SQL_Running: Yes 6.éªŒè¯ï¼Œåœ¨3306ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œçœ‹3307å’Œ3308æ˜¯å¦ä¼šåŒæ­¥ //3306ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ mysql> create database bxb; Query OK, 1 row affected (0.00 sec) mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | DB3306 | | bxb | | mysql | | performance_schema | | test | +--------------------+ 6 rows in set (0.00 sec) //3307ä¸­æŸ¥çœ‹æ•°æ®åº“ mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | DB3307 | | bxb | | mysql | | performance_schema | | test | +--------------------+ 6 rows in set (0.00 sec) //3308ä¸­æŸ¥çœ‹æ•°æ®åº“ mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | DB3308 | | bxb | | mysql | | performance_schema | | test | +--------------------+ 6 rows in set (0.01 sec) åˆ°æ­¤ï¼ŒmysqlåŸºäºå¤šå®ä¾‹å®ç°ä¸»ä»å¤åˆ¶å®Œæˆï¼ï¼ï¼ å®éªŒè¿‡ç¨‹ä¸­é‡åˆ°çš„é”™è¯¯ åœ¨3308ï¼ˆç¬¬äºŒä¸ªå®ä¾‹ï¼‰ä¸Šå¯åŠ¨slaveæŠ¥é”™ //å¯åŠ¨slaveæŠ¥é”™ï¼Œä»å­˜å‚¨åº“åˆå§‹åŒ–ä¸­ç»§æ—¥å¿—ä¿¡æ¯ç»“æ„å¤±è´¥ mysql> start slave; ERROR 1872 (HY000): Slave failed to initialize relay log info structure from the repository è§£å†³æ–¹æ³•ï¼šå…ˆé‡ç½®slave,ç„¶ååœæ­¢slvaeå†é‡æ–°change master mysql> reset slave all; Query OK, 0 rows affected (0.02 sec) mysql> stop slave; æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlè¿›é˜¶/3.mysqlæ™®é€šä¸»ä»å¤åˆ¶.html":{"url":"db/mysql/mysqlè¿›é˜¶/3.mysqlæ™®é€šä¸»ä»å¤åˆ¶.html","title":"æ™®é€šä¸»ä»å¤åˆ¶","keywords":"","body":"mysqlæ™®é€šä¸»ä»å¤åˆ¶ 1.mysqlä¸»ä»å¤åˆ¶è¿‡ç¨‹ 1.masterå¼€å¯binlogï¼ˆäºŒè¿›åˆ¶ï¼‰æ—¥å¿—ã€æˆæƒslaveå¤åˆ¶ç”¨æˆ·ï¼Œslaveå¼€å¯relay-logï¼ˆä¸­ç»§ï¼‰æ—¥å¿— 2.slave IOçº¿ç¨‹ä¼šé€šè¿‡åœ¨masterä¸Šå·²ç»æˆæƒçš„å¤åˆ¶ç”¨æˆ·æƒé™è¯·æ±‚è¿æ¥masteræœåŠ¡å™¨ï¼Œå¸¦ç€change master toä¿¡æ¯ï¼ˆuserã€hostã€passwordã€binlogã€binlog_posã€portï¼‰å»é—®master dumpçº¿ç¨‹æœ‰æ²¡æœ‰slaveæŒ‡å®šçš„binlogã€binlog_pos,æœ‰åˆ™æ‹‰å–binlog 3.IOçº¿ç¨‹æ‹‰å–binlogåä¼šå…ˆå†™å…¥åˆ°TCP/IPç¼“å­˜ï¼ŒTCP/IPç¼“å­˜å®Œæˆåä¼šç»™IOçº¿ç¨‹è¿”å›ACKï¼Œå‘ŠçŸ¥IOçº¿ç¨‹ç¼“å­˜å®Œæˆï¼Œç„¶åå†å†™å…¥åˆ°relay-logä¸­ï¼Œrelay-logå†™å…¥å®Œæˆåç¼“å­˜å°±ä¼šæ¸…ç©ºï¼ŒåŒæ—¶ä¼šæŠŠè¿™ä¸€æ¬¡æ‹‰å–çš„binlogæ–‡ä»¶ã€binlog_posè®°å½•åˆ°master.infoä¸­ï¼Œä»¥ä¾¿äºä¸‹ä¸€æ¬¡å»æ‹‰å–çš„æ—¶å€™çŸ¥é“ä¸Šä¸€æ¬¡æ‹‰å–çš„ä½ç½® 4.SQLçº¿ç¨‹ä¼šä»relay-logä¸­è¯»å–binlogè§£ææˆsqlè¯­å¥æ‰§è¡Œï¼ŒåŒæ—¶ä¼šæŠŠä¸Šä¸€æ¬¡è¯»å–çš„relay-logä½ç½®è®°å½•åˆ°relay-log.infoï¼Œä»¥ä¾¿äºä¸‹ä¸€æ¬¡è¯»å–çš„æ—¶å€™çŸ¥é“ä»ä»€ä¹ˆä½ç½®è¯»å–ï¼Œå› ä¸ºSQLçº¿ç¨‹ä»relay-logä¸­è¯»å–binlogå¹¶ä¸æ˜¯ä¸€æ¬¡å…¨éƒ¨è¯»å®Œçš„ å®˜æ–¹ç¤ºæ„å›¾ 2.å®éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå mysqlç‰ˆæœ¬ master 10.0.0.100 db01 5.7.22 slave 10.0.0.101 db02 5.7.22 3.å®éªŒè¿‡ç¨‹ master10.0.0.100æ“ä½œ 1.masterç¼–è¾‘/etc/my.cnfï¼ŒæŒ‡å®šserveridï¼Œå¹¶å¼€å¯binlogå’Œbinlogç´¢å¼• [root@db01 ~]# vim /etc/my.cnf #åœ¨[mysqld]ä¸‹æ–¹å†™å…¥ä»¥ä¸‹3è¡Œ server_id=1 #æŒ‡å®šserveridï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šå¤§ log_bin=binlog #å¼€å¯binlogæ—¥å¿— log_bin_index=binlog.index #å¼€å¯binlogæ—¥å¿—ç´¢å¼• #é‡å¯mysql [root@db01 ~]# systemctl restart mysqld 2.åˆ›å»ºä¸“ç”¨å¤åˆ¶ç”¨æˆ·ï¼Œå…è®¸ä»slaveä¸Šè¿æ¥è¿‡æ¥çš„å¤åˆ¶ç”¨æˆ· mysql> grant replication slave on *.* to backup@'10.0.0.%' identified by '123'; 3.æŸ¥çœ‹masterå½“å‰çš„binlogæ—¥å¿—åŠä½ç½®ä¿¡æ¯ mysql> show master status; +---------------+----------+--------------+------------------+-------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +---------------+----------+--------------+------------------+-------------------+ | binlog.000001 | 154 | | | | +---------------+----------+--------------+------------------+-------------------+ 1 row in set (0.00 sec) slave10.0.0.101æ“ä½œ 1.slaveç¼–è¾‘é…ç½®æ–‡ä»¶/etc/my.cnfï¼ŒæŒ‡å®šserveridï¼Œå¹¶å¼€å¯ä¸­ç»§æ—¥å¿— [root@db02 ~]# vim /etc/my.cnf #åœ¨[mysqld]ä¸‹æ”¾å†™å…¥ä»¥ä¸‹3è¡Œ server_id=2 #æŒ‡å®šserveridï¼Œè¦æ¯”mysql-masterå¤§ relay_log=/var/lib/mysql/relay_log #å¼€å¯ä¸­ç»§æ—¥å¿— relay_log_index=/var/lib/mysql/relay_log.index #å¼€å¯ä¸­ç»§æ—¥å¿—ç´¢å¼• #é‡å¯mysql [root@db02 ~]# systemctl restart mysqld 2.è®¾ç½®slaveä»masteræ‹‰å–binlogï¼ŒåŠæ‹‰å–çš„ä½ç½® mysql> change master to master_host='10.0.0.100', \\ master_port=3306, \\ master_user='backup', \\ master_password='123', \\ master_log_file='binlog.000001', \\ master_log_pos=155; Query OK, 0 rows affected, 2 warnings (0.02 sec) mysql> show warnings; #ä¼šæœ‰è­¦å‘Šï¼Œä½†ä¸å½±å“ | Note | 1759 | Sending passwords in plain text without SSL/TLS is extremely insecure. | Note | 1760 | Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information. | æ²¡æœ‰SSL/TLSçš„çº¯æ–‡æœ¬å‘é€å¯†ç æ˜¯éå¸¸ä¸å®‰å…¨çš„ åœ¨ä¸»ä¿¡æ¯å­˜å‚¨åº“ä¸­å­˜å‚¨MySQLç”¨æˆ·åæˆ–å¯†ç ä¿¡æ¯æ˜¯ä¸å®‰å…¨çš„ï¼Œå› æ­¤ä¸å»ºè®®è¿™æ ·åšã€‚è¯·è€ƒè™‘ä½¿ç”¨ç”¨æˆ·å’Œå¯†ç è¿æ¥é€‰é¡¹å¯åŠ¨ä»;æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…MySQLæ‰‹å†Œä¸­çš„â€œå¼€å§‹ä»å±è¯­æ³•â€ã€‚ è¯­å¥è¯´æ˜ change master to master_host='10.0.0.100', #mysql-masterä¸»æœºIPåœ°å€ master_port=3306, #mysql-masterç«¯å£ master_user='backup', #slaveæ‹‰å–çš„ç”¨æˆ· master_password='123456', #slaveæ‹‰å»çš„ç”¨æˆ·çš„å¯†ç  master_log_file='binlog.000001', #mysql-masterçš„binlogæ–‡ä»¶ï¼Œåœ¨masterä¸­show master statusæŸ¥çœ‹ master_log_pos=155; 3.å¯åŠ¨slaveå¹¶æŸ¥çœ‹slaveçŠ¶æ€ //å¯åŠ¨slave mysql> start slave; //æŸ¥çœ‹slaveçŠ¶æ€ï¼ŒIOçº¿ç¨‹ã€SQLçº¿ç¨‹éƒ½ä¸ºyesæ‰ç®—æ­£ç¡® mysql> show slave status\\G Slave_IO_Running: Yes Slave_SQL_Running: Yes 4.éªŒè¯ï¼Œåœ¨masterä¸Šåˆ›å»ºæ•°æ®åº“å’Œè¡¨ï¼Œç„¶ååœ¨slaveä¸Šçœ‹æ˜¯å¦å¯ä»¥åŒæ­¥ //masteræ“ä½œ mysql> show databases; #æ­¤æ—¶mysql-masterä¸Šæœ‰4ä¸ªåº“ +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | sys | +--------------------+ 4 rows in set (0.01 sec) mysql> create database DB1; #åˆ›å»ºä¸€ä¸ªæ•°æ®åº“DB1 Query OK, 1 row affected (0.01 sec) //slaveéªŒè¯ mysql> show databases; #å¯ä»¥çœ‹åˆ°ï¼Œåœ¨masterä¸Šåˆ›å»ºçš„æ•°æ®åº“DB1å·²ç»åŒæ­¥è‡³slave +--------------------+ | Database | +--------------------+ | information_schema | | DB1 | | mysql | | performance_schema | | sys | +--------------------+ 5 rows in set (0.01 sec) 4.å»¶æ—¶ä»åº“ 4.1å»¶æ—¶ä»åº“ä¼˜ç‚¹ 1.è¯¯åˆ é™¤æ—¶ï¼Œèƒ½æ›´å¿«æ¢å¤æ•°æ®ã€‚ æœ‰æ—¶å€™æ‰‹æŠ–äº†ï¼ŒæŠŠçº¿ä¸Šæ•°æ®ç»™è¯¯åˆ é™¤äº†ï¼Œæˆ–è€…è¯¯åˆ é™¤åº“ã€è¡¨ã€å…¶ä»–å¯¹è±¡ï¼Œæˆ–ä¸åŠ WHEREæ¡ä»¶çš„æ›´æ–°ã€åˆ é™¤ï¼Œéƒ½å¯ä»¥è®©å»¶è¿Ÿä»åº“åœ¨è¯¯æ“ä½œå‰çš„æ—¶é—´ç‚¹åœä¸‹ï¼Œç„¶åè¿›è¡Œæ¢å¤ã€‚ 2.æŠŠå»¶è¿Ÿä»åº“ä½œä¸ºä¸“ç”¨çš„å¤‡ä»½èŠ‚ç‚¹ã€‚è™½ç„¶æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œä½†å¹¶ä¸å½±å“åˆ©ç”¨è¯¥èŠ‚ç‚¹ä½œä¸ºå¤‡ä»½è§’è‰²ï¼Œä¹Ÿä¸å½±å“ç”Ÿäº§èŠ‚ç‚¹æ•°æ®åº“åº“ã€‚ 3.è¿˜å¯ä»¥æŠŠå»¶è¿Ÿä»åº“å½“åšä¸€äº›é—®é¢˜ã€æ¡ˆä¾‹ç ”ç©¶çš„å¯¹è±¡ã€‚ä¸ªåˆ«æ—¶å€™ï¼Œå¯èƒ½æœ‰äº›binlog eventåœ¨æ™®é€šä»åº“ä¸Šä¼šæœ‰é—®é¢˜ï¼ˆä¾‹å¦‚æ—©æœŸç‰ˆæœ¬ä¸­æ— ä¸»é”®ä¼šå¯¼è‡´ä»åº“æ›´æ–°éå¸¸æ…¢çš„ç»å…¸é—®é¢˜ï¼‰ï¼Œè¿™æ—¶å°±æœ‰æ—¶é—´åœ¨å»¶è¿Ÿä»åº“ä¸Šæ…¢æ…¢ç¢ç£¨ç ”ç©¶äº†ã€‚ æ™®é€šä¸»ä»æœ€å¤§çš„ç¼ºç‚¹ï¼šä¸»åº“è¯¯åˆ é™¤æ•°æ®åä»åº“ä¸Šçš„æ•°æ®ä¹Ÿä¼šè¢«åŒæ­¥åˆ é™¤ 4.2é…ç½®å»¶æ—¶ä»åº“ ä»åº“10.0.0.101æ“ä½œ //åœæ­¢ä¸»ä» mysql>stop slave; //è®¾ç½®å»¶æ—¶ä¸º60ç§’ mysql>change master to master_delay = 60; //å¼€å¯ä¸»ä» mysql>start slave; //æŸ¥çœ‹çŠ¶æ€ mysql> show slave status \\G SQL_Delay: 60 #å»¶æ—¶ä»åº“åœæ­¢æ–¹æ³• //åœæ­¢ä¸»ä» mysql> stop slave; //è®¾ç½®å»¶æ—¶ä¸º0 mysql> CHANGE MASTER TO MASTER_DELAY = 0; //å¼€å¯ä¸»ä» mysql> start slave; æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlè¿›é˜¶/4.mysql-5.6.40 GTIDä¸»ä»å¤åˆ¶.html":{"url":"db/mysql/mysqlè¿›é˜¶/4.mysql-5.6.40 GTIDä¸»ä»å¤åˆ¶.html","title":"GTIDä¸»ä»å¤åˆ¶","keywords":"","body":"mysql-5.6.40 GTIDä¸»ä»å¤åˆ¶ 1.GTIDä¸»ä»å¤åˆ¶ç®€ä»‹ 1.1GTIDä¸»ä»å¤åˆ¶æ¦‚å¿µ åŸºäºGTIDçš„å¤åˆ¶æ˜¯ä»Mysql5.6å¼€å§‹æ”¯æŒçš„ä¸€ç§æ–°çš„å¤åˆ¶æ–¹å¼ï¼Œæ­¤æ–¹å¼ä¸ä¼ ç»ŸåŸºäºæ—¥å¿—çš„æ–¹å¼å­˜åœ¨å¾ˆå¤§çš„å·®å¼‚ï¼Œåœ¨åŸæ¥çš„åŸºäºæ—¥å¿—çš„å¤åˆ¶ä¸­ï¼Œä»æœåŠ¡å™¨è¿æ¥åˆ°ä¸»æœåŠ¡å™¨å¹¶å‘Šè¯‰ä¸»æœåŠ¡å™¨è¦ä»å“ªä¸ªäºŒè¿›åˆ¶æ—¥å¿—çš„åç§»é‡å¼€å§‹æ‰§è¡Œå¢é‡åŒæ­¥ï¼Œè¿™æ—¶æˆ‘ä»¬å¦‚æœæŒ‡å®šçš„æ—¥å¿—åç§»é‡ä¸å¯¹ï¼Œè¿™å¯èƒ½é€ æˆä¸»ä»æ•°æ®çš„ä¸ä¸€è‡´ï¼Œè€ŒåŸºäºGTIDçš„å¤åˆ¶ä¼šé¿å…è¿™ç§æƒ…å†µ 1.2GTIDå·¥ä½œè¿‡ç¨‹ â‘ é¦–å…ˆä»æœåŠ¡å™¨ä¼šå‘Šè¯‰ä¸»æœåŠ¡å™¨å·²ç»åœ¨ä»æœåŠ¡å™¨æ‰§è¡Œå®Œäº†å“ªäº›äº‹åŠ¡çš„GTIDå€¼ â‘¡ä¸»åº“ä¼šæŠŠæ‰€æœ‰æ²¡æœ‰åœ¨ä»åº“ä¸Šæ‰§è¡Œçš„äº‹åŠ¡ï¼Œå‘é€åˆ°ä»åº“ä¸Šè¿›è¡Œæ‰§è¡Œï¼Œå¹¶ä¸”ä½¿ç”¨GTIDçš„å¤åˆ¶å¯ä»¥ä¿è¯åŒä¸€ä¸ªäº‹åŠ¡åªåœ¨æŒ‡å®šçš„ä»åº“ä¸Šæ‰§è¡Œä¸€æ¬¡ï¼Œè¿™æ ·å¯ä»¥é¿å…ç”±äºåç§»é‡çš„é—®é¢˜é€ æˆæ•°æ®ä¸ä¸€è‡´ 1.3GTIDå«ä¹‰ å…¨å±€äº‹åŠ¡IDï¼Œå…¶ä¿è¯ä¸ºæ¯ä¸€ä¸ªåœ¨ä¸»æœåŠ¡å™¨ä¸Šæäº¤çš„äº‹åŠ¡åœ¨å¤åˆ¶é›†ç¾¤ä¸­å¯ä»¥ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ID 1.4GTIDç»„æˆ UUID+TID UUIDï¼šæ˜¯åœ¨mysqlæœåŠ¡é¦–æ¬¡å¯åŠ¨ç”Ÿæˆçš„ï¼Œä¿å­˜åœ¨æ•°æ®åº“çš„æ•°æ®ç›®å½•ä¸­ï¼Œåœ¨æ•°æ®ç›®å½•ä¸­æœ‰ä¸€ä¸ªauto.confæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¿å­˜äº†UUDIå€¼ TIDï¼šäº‹åŠ¡IDåˆ™æ˜¯ä»1å¼€å§‹è‡ªå¢çš„åºåˆ—ï¼Œè¡¨ç¤ºè¿™ä¸ªäº‹åŠ¡æ˜¯åœ¨ä¸»åº“ä¸Šæ‰§è¡Œçš„ç¬¬å‡ ä¸ªäº‹åŠ¡ï¼ŒMysqlä¼šä¿è¯è¿™ä¸ªäº‹åŠ¡å’ŒGTIDæ˜¯ä¸€æ¯”ä¸€çš„å…³ç³» 2.å®éªŒç¯å¢ƒ æœåŠ¡å™¨è§’è‰² ip ä¸»æœºå master 10.0.0.10 db01 slave1 10.0.0.11 db02 slave2 10.0.0.12 db03 3.åŸºäºGTIDä¸»ä»å‰ææ¡ä»¶ å…ˆå†³æ¡ä»¶ 1.ä¸»åº“å’Œä»åº“éƒ½è¦å¼€å¯binlog 2.ä¸»åº“å’Œä»åº“server-idä¸åŒ 3.è¦æœ‰ä¸»ä»å¤åˆ¶ç”¨æˆ· 4.å®éªŒè¿‡ç¨‹ ä¸»åº“10.0.0.10æ“ä½œ 1.ä¿®æ”¹é…ç½®æ–‡ä»¶ //ç¼–è¾‘ä¸»åº“é…ç½®æ–‡ä»¶/etc/my.cnfï¼Œåœ¨[mysqld]ä¸‹æ·»åŠ ä»¥ä¸‹å‡ è¡Œ [root@db01 ~]# vim /etc/my.cnf server_id=1 log_bin=mysql-bin gtid_mode=ON enforce_gtid_consistency log-slave-updates skip_name_resolve //é‡å¯mysql [root@db01 ~]# systemctl restart mysqld //ä¸»åº“æŸ¥çœ‹gitå¼€å¯æƒ…å†µï¼Œenforce_gtid_consistencyä¸gtid_modeéƒ½ä¸ºonå³ä¸ºæ­£ç¡® mysql> show global variables like '%gtid%'; +---------------------------------+----------------------------------------+ | Variable_name | Value | +---------------------------------+----------------------------------------+ | binlog_gtid_simple_recovery | OFF | | enforce_gtid_consistency | ON | | gtid_executed | e257d15f-ed9f-11e8-ab08-000c29b62ed9:1 | | gtid_mode | ON | | gtid_owned | | | gtid_purged | | | simplified_binlog_gtid_recovery | OFF | +---------------------------------+----------------------------------------+ 7 rows in set (0.01 sec) #å‚æ•°è¯´æ˜ server_id=1 #server idä¸»åº“å’Œä»åº“è¦ä¸ä¸€æ · log_bin=mysql-bin #å¼€å¯binlog gtid_mode=ON #å¼€å¯gtid enforce_gtid_consistency #æ‰§è¡ŒGTIDä¸€è‡´ log-slave-updates #é€šå¸¸æƒ…å†µï¼Œä»æœåŠ¡å™¨ä»ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ›´æ–°ä¸è®°å…¥å®ƒçš„äºŒè¿›åˆ¶æ—¥å¿—ã€‚ è¯¥é€‰é¡¹å‘Šè¯‰ä»æœåŠ¡å™¨å°†å…¶SQLçº¿ç¨‹æ‰§è¡Œçš„æ›´æ–°è®°å…¥åˆ°ä»æœåŠ¡å™¨è‡ªå·±çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼Œmysql-5.6å¿…é¡»åŠ è¿™ä¸ªå‚æ•°ï¼Œ 5.7å¯ä»¥ä¸åŠ  skip_name_resolve #è·³è¿‡mysqlåŸŸåè§£æ 2.ä¸»åº“åˆ›å»ºä¸»ä»å¤åˆ¶ç”¨æˆ· mysql> grant replication slave on *.* to backup@'10.0.0.%' identified by '123'; Query OK, 0 rows affected (0.02 sec) ä»åº“10.0.0.11ã€10.0.0.12æ“ä½œ 1.ä¿®æ”¹é…ç½®æ–‡ä»¶ //ä»åº“10.0.0.11ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/my.cnfï¼Œserver idè¦ä¸ä¸»åº“ä¸åŒ [mysqld] server_id=2 log-bin=mysql-bin gtid_mode=ON enforce_gtid_consistency log-slave-updates skip_name_resolve //é‡å¯mysql [root@db02 ~]# systemctl restart mysqld //æŸ¥çœ‹gtidå¼€å¯çŠ¶æ€ mysql> show variables like '%gtid%'; +---------------------------------+-----------+ | Variable_name | Value | +---------------------------------+-----------+ | binlog_gtid_simple_recovery | OFF | | enforce_gtid_consistency | ON | | gtid_executed | | | gtid_mode | ON | | gtid_next | AUTOMATIC | | gtid_owned | | | gtid_purged | | | simplified_binlog_gtid_recovery | OFF | +---------------------------------+-----------+ 8 rows in set (0.00 sec) ------------------------------------------------------- //ä»åº“10.0.0.12ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/my.cnfï¼Œserver idè¦ä¸ä¸»åº“ä¸åŒ [mysqld] server_id=3 log-bin=mysql-bin gtid_mode=ON enforce_gtid_consistency log-slave-updates skip_name_resolve //é‡å¯mysql [root@db03 ~]# systemctl restart mysqld //æŸ¥çœ‹gtidå¼€å¯çŠ¶æ€ mysql> show variables like '%gtid%'; +---------------------------------+-----------+ | Variable_name | Value | +---------------------------------+-----------+ | binlog_gtid_simple_recovery | OFF | | enforce_gtid_consistency | ON | | gtid_executed | | | gtid_mode | ON | | gtid_next | AUTOMATIC | | gtid_owned | | | gtid_purged | | | simplified_binlog_gtid_recovery | OFF | +---------------------------------+-----------+ 8 rows in set (0.00 sec) 2.ä»åº“æ‹‰å– //ä»åº“10.0.0.11æ‰§è¡Œæ‹‰å–è¯­å¥ mysql> change master to master_host='10.0.0.10', master_user='backup', master_password='123', master_auto_position=1; Query OK, 0 rows affected, 2 warnings (0.02 sec) //å¯åŠ¨IOã€SQLçº¿ç¨‹ mysql> start slave; //æŸ¥çœ‹slaveçŠ¶æ€ï¼ŒIOã€SQLçº¿ç¨‹éƒ½ä¸ºyesï¼Œauto_positionä¸ºyeså³ä¸ºæˆåŠŸ mysql> show slave status\\G Slave_IO_Running: Yes Slave_SQL_Running: Yes #ä»¥ä¸‹ä¸ºäº‹åŠ¡IDï¼Œ1-3è¡¨æ˜ä»åº“ä»ä¸»åº“åŒæ­¥äº†3æ¬¡ Retrieved_Gtid_Set: e257d15f-ed9f-11e8-ab08-000c29b62ed9:1-3 Executed_Gtid_Set: e257d15f-ed9f-11e8-ab08-000c29b62ed9:1-3 ------------------------------------------------------------ //ä»åº“10.0.0.12æ‰§è¡Œæ‹‰å–è¯­å¥ mysql> change master to master_host='10.0.0.10', master_user='backup', master_password='123', master_auto_position=1; Query OK, 0 rows affected, 2 warnings (0.02 sec) //å¯åŠ¨IOã€SQLçº¿ç¨‹ mysql> start slave; //æŸ¥çœ‹slaveçŠ¶æ€ï¼ŒIOã€SQLçº¿ç¨‹éƒ½ä¸ºyesï¼Œauto_positionä¸ºyeså³ä¸ºæˆåŠŸ mysql> show slave status\\G Slave_IO_Running: YesSlave_SQL_Running: Yes Auto_Position: 1 #ä»¥ä¸‹ä¸ºäº‹åŠ¡IDï¼Œ1-3è¡¨æ˜ä»åº“ä»ä¸»åº“åŒæ­¥äº†3æ¬¡ Retrieved_Gtid_Set: e257d15f-ed9f-11e8-ab08-000c29b62ed9:1-3 Executed_Gtid_Set: e257d15f-ed9f-11e8-ab08-000c29b62ed9:1-3 3.éªŒè¯ä¸»ä»åŒæ­¥ //ä¸»åº“åˆ›å»ºæ•°æ®åº“ mysql> create database GTID; Query OK, 1 row affected (0.00 sec) //ä»åº“æŸ¥çœ‹æ˜¯å¦åŒæ­¥ï¼Œå¯ä»¥çœ‹åˆ°GTIDåº“å·²ç»åŒæ­¥è¿‡æ¥ mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | GTID | | mysql | | performance_schema | | test | +--------------------+ 5 rows in set (0.00 sec) ä»¥ä¸Šè¿‡ç¨‹åŒæ ·é€‚ç”¨äºmysql-5.7 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlè¿›é˜¶/5.mysql5.7åŠåŒæ­¥å¤åˆ¶.html":{"url":"db/mysql/mysqlè¿›é˜¶/5.mysql5.7åŠåŒæ­¥å¤åˆ¶.html","title":"åŠåŒæ­¥å¤åˆ¶","keywords":"","body":"mysql5.7åŠåŒæ­¥å¤åˆ¶ ä¸€ã€å¤åˆ¶æ¶æ„è¡ç”Ÿå² åœ¨è°ˆè¿™ä¸ªç‰¹æ€§ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹MySQLçš„å¤åˆ¶æ¶æ„è¡ç”Ÿå²ã€‚ åœ¨2000å¹´ï¼ŒMySQL 3.23.15ç‰ˆæœ¬å¼•å…¥äº†Replicationã€‚Replicationä½œä¸ºä¸€ç§å‡†å®æ—¶åŒæ­¥æ–¹å¼ï¼Œå¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚è¿™ä¸ªæ—¶å€™çš„Replicatonçš„å®ç°æ¶‰åŠåˆ°ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªåœ¨Masterï¼Œä¸€ä¸ªåœ¨Slaveã€‚Slaveçš„I/Oå’ŒSQLåŠŸèƒ½æ˜¯ä½œä¸ºä¸€ä¸ªçº¿ç¨‹ï¼Œä»Masterè·å–åˆ°eventåç›´æ¥applyï¼Œæ²¡æœ‰relay logã€‚è¿™ç§æ–¹å¼ä½¿å¾—è¯»å–eventçš„é€Ÿåº¦ä¼šè¢«Slave replayé€Ÿåº¦æ‹–æ…¢ï¼Œå½“ä¸»å¤‡å­˜åœ¨è¾ƒå¤§å»¶è¿Ÿæ—¶å€™ï¼Œä¼šå¯¼è‡´å¤§é‡binary logæ²¡æœ‰å¤‡ä»½åˆ°Slaveç«¯ã€‚ åœ¨2002å¹´ï¼ŒMySQL 4.0.2ç‰ˆæœ¬å°†Slaveç«¯eventè¯»å–å’Œæ‰§è¡Œç‹¬ç«‹æˆä¸¤ä¸ªçº¿ç¨‹ï¼ˆIOçº¿ç¨‹å’ŒSQLçº¿ç¨‹ï¼‰ï¼ŒåŒæ—¶å¼•å…¥äº†relay logã€‚IOçº¿ç¨‹è¯»å–eventåå†™å…¥relay logï¼ŒSQLçº¿ç¨‹ä»relay logä¸­è¯»å–eventç„¶åæ‰§è¡Œã€‚è¿™æ ·å³ä½¿SQLçº¿ç¨‹æ‰§è¡Œæ…¢ï¼ŒMasterçš„binary logä¹Ÿä¼šå°½å¯èƒ½çš„åŒæ­¥åˆ°Slaveã€‚å½“Masterå®•æœºï¼Œåˆ‡æ¢åˆ°Slaveï¼Œä¸ä¼šå‡ºç°å¤§é‡æ•°æ®ä¸¢å¤±ã€‚ åœ¨2010å¹´MySQL 5.5ç‰ˆæœ¬ä¹‹å‰ï¼Œä¸€ç›´é‡‡ç”¨çš„æ˜¯è¿™ç§å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼ã€‚ä¸»åº“çš„äº‹åŠ¡æ‰§è¡Œä¸ä¼šç®¡å¤‡åº“çš„åŒæ­¥è¿›åº¦ï¼Œå¦‚æœå¤‡åº“è½åï¼Œä¸»åº“ä¸å¹¸crashï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚äºæ˜¯åœ¨MySQLåœ¨5.5ä¸­å°±é¡ºå…¶è‡ªç„¶åœ°å¼•å…¥äº†åŠåŒæ­¥å¤åˆ¶ï¼Œä¸»åº“åœ¨åº”ç­”å®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡å‰éœ€è¦ä¿è¯è‡³å°‘ä¸€ä¸ªä»åº“æ¥æ”¶å¹¶å†™åˆ°relay logä¸­ã€‚é‚£ä¹ˆåŠåŒæ­¥å¤åˆ¶æ˜¯å¦å¯ä»¥åšåˆ°ä¸ä¸¢å¤±æ•°æ®å‘¢ï¼Ÿä¸‹é¢åˆ†æã€‚ åœ¨2016å¹´ï¼ŒMySQLåœ¨5.7.17ä¸­å¼•å…¥äº†ä¸€ä¸ªå…¨æ–°çš„æŠ€æœ¯ï¼Œç§°ä¹‹ä¸ºInnoDB Group Replicationã€‚ç›®å‰å®˜æ–¹MySQL 5.7.17åŸºäºGroup replicationçš„å…¨åŒæ­¥æŠ€æœ¯å·²ç»é—®ä¸–ï¼Œå…¨åŒæ­¥æŠ€æœ¯å¸¦æ¥äº†æ›´å¤šçš„æ•°æ®ä¸€è‡´æ€§ä¿éšœã€‚ç›¸ä¿¡æ˜¯æœªæ¥åŒæ­¥æŠ€æœ¯ä¸€ä¸ªé‡è¦æ–¹å‘ï¼Œå€¼å¾—æœŸå¾…ã€‚MySQL 5.7 Group Replication æ ¹æ®ä¸Šé¢æåˆ°çš„è¿™å‡ ç§å¤åˆ¶åè®®ï¼Œåˆ†åˆ«å¯¹åº”MySQLå‡ ç§å¤åˆ¶ç±»å‹ï¼Œåˆ†åˆ«æ˜¯å¼‚æ­¥ã€åŠåŒæ­¥ã€å…¨åŒæ­¥ã€‚ å¯¹äºå¼‚æ­¥å¤åˆ¶ï¼Œä¸»åº“å°†äº‹åŠ¡Binlogäº‹ä»¶å†™å…¥åˆ°Binlogæ–‡ä»¶ä¸­ï¼Œæ­¤æ—¶ä¸»åº“åªä¼šé€šçŸ¥ä¸€ä¸‹Dumpçº¿ç¨‹å‘é€è¿™äº›æ–°çš„Binlogï¼Œç„¶åä¸»åº“å°±ä¼šç»§ç»­å¤„ç†æäº¤æ“ä½œï¼Œè€Œæ­¤æ—¶ä¸ä¼šä¿è¯è¿™äº›Binlogä¼ åˆ°ä»»ä½•ä¸€ä¸ªä»åº“èŠ‚ç‚¹ä¸Šã€‚ å¯¹äºå…¨åŒæ­¥å¤åˆ¶ï¼Œå½“ä¸»åº“æäº¤äº‹åŠ¡ä¹‹åï¼Œæ‰€æœ‰çš„ä»åº“èŠ‚ç‚¹å¿…é¡»æ”¶åˆ°ï¼ŒAPPLYå¹¶ä¸”æäº¤è¿™äº›äº‹åŠ¡ï¼Œç„¶åä¸»åº“çº¿ç¨‹æ‰èƒ½ç»§ç»­åšåç»­æ“ä½œã€‚è¿™é‡Œé¢æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ç¼ºç‚¹å°±æ˜¯ï¼Œä¸»åº“å®Œæˆä¸€ä¸ªäº‹åŠ¡çš„æ—¶é—´è¢«æ‹‰é•¿ï¼Œæ€§èƒ½é™ä½ã€‚ å¯¹äºåŠåŒæ­¥å¤åˆ¶ï¼Œæ˜¯ä»‹äºå…¨åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ä¹‹é—´çš„ä¸€ç§ï¼Œä¸»åº“åªéœ€è¦ç­‰å¾…è‡³å°‘ä¸€ä¸ªä»åº“èŠ‚ç‚¹æ”¶åˆ°å¹¶ä¸”Flush Binlogåˆ°Relay Logæ–‡ä»¶å³å¯ï¼Œä¸»åº“ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰ä»åº“ç»™ä¸»åº“åé¦ˆã€‚åŒæ—¶ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªæ”¶åˆ°çš„åé¦ˆï¼Œè€Œä¸æ˜¯å·²ç»å®Œå…¨æ‰§è¡Œå¹¶ä¸”æäº¤çš„åé¦ˆï¼Œè¿™æ ·å°±èŠ‚çœäº†å¾ˆå¤šæ—¶é—´ã€‚ äºŒã€åŠåŒæ­¥å¤åˆ¶æŠ€æœ¯ æˆ‘ä»¬ä»Šå¤©è°ˆè®ºç¬¬äºŒç§æ¶æ„ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæ™®é€šçš„replicationï¼Œå³MySQLçš„å¼‚æ­¥å¤åˆ¶ï¼Œä¾é MySQLäºŒè¿›åˆ¶æ—¥å¿—ä¹Ÿå³binary logè¿›è¡Œæ•°æ®å¤åˆ¶ã€‚æ¯”å¦‚ä¸¤å°æœºå™¨ï¼Œä¸€å°ä¸»æœºï¼ˆmasterï¼‰ï¼Œå¦å¤–ä¸€å°æ˜¯ä»æœºï¼ˆslaveï¼‰ã€‚ 1ï¼‰æ­£å¸¸çš„å¤åˆ¶ä¸ºï¼šäº‹åŠ¡ä¸€ï¼ˆt1ï¼‰å†™å…¥binlog bufferï¼›dumperçº¿ç¨‹é€šçŸ¥slaveæœ‰æ–°çš„äº‹åŠ¡t1ï¼›binlog bufferè¿›è¡Œcheckpointï¼›slaveçš„ioçº¿ç¨‹æ¥æ”¶åˆ°t1å¹¶å†™å…¥åˆ°è‡ªå·±çš„çš„relay logï¼›slaveçš„sqlçº¿ç¨‹å†™å…¥åˆ°æœ¬åœ°æ•°æ®åº“ã€‚ è¿™æ—¶ï¼Œmasterå’Œslaveéƒ½èƒ½çœ‹åˆ°è¿™æ¡æ–°çš„äº‹åŠ¡ï¼Œå³ä½¿masteræŒ‚äº†ï¼Œslaveå¯ä»¥æå‡ä¸ºæ–°çš„masterã€‚ 2ï¼‰å¼‚å¸¸çš„å¤åˆ¶ä¸ºï¼šäº‹åŠ¡ä¸€ï¼ˆt1ï¼‰å†™å…¥binlog bufferï¼›dumperçº¿ç¨‹é€šçŸ¥slaveæœ‰æ–°çš„äº‹åŠ¡t1ï¼›binlog bufferè¿›è¡Œcheckpointï¼›slaveå› ä¸ºç½‘ç»œä¸ç¨³å®šï¼Œä¸€ç›´æ²¡æœ‰æ”¶åˆ°t1ï¼›masteræŒ‚æ‰ï¼Œslaveæå‡ä¸ºæ–°çš„masterï¼Œt1ä¸¢å¤±ã€‚ 3ï¼‰å¾ˆå¤§çš„é—®é¢˜æ˜¯ï¼šä¸»æœºå’Œä»æœºäº‹åŠ¡æ›´æ–°çš„ä¸åŒæ­¥ï¼Œå°±ç®—æ˜¯æ²¡æœ‰ç½‘ç»œæˆ–è€…å…¶ä»–ç³»ç»Ÿçš„å¼‚å¸¸ï¼Œå½“ä¸šåŠ¡å¹¶å‘ä¸Šæ¥æ—¶ï¼Œslaveå› ä¸ºè¦é¡ºåºæ‰§è¡Œmasteræ‰¹é‡äº‹åŠ¡ï¼Œå¯¼è‡´å¾ˆå¤§çš„å»¶è¿Ÿã€‚ ä¸ºäº†å¼¥è¡¥ä»¥ä¸Šå‡ ç§åœºæ™¯çš„ä¸è¶³ï¼ŒMySQLä»5.5å¼€å§‹æ¨å‡ºäº†åŠåŒæ­¥å¤åˆ¶ã€‚ç›¸æ¯”å¼‚æ­¥å¤åˆ¶ï¼ŒåŠåŒæ­¥å¤åˆ¶æé«˜äº†æ•°æ®å®Œæ•´æ€§ï¼Œå› ä¸ºå¾ˆæ˜ç¡®çŸ¥é“ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡æäº¤æˆåŠŸä¹‹åï¼Œè¿™ä¸ªäº‹åŠ¡å°±è‡³å°‘ä¼šå­˜åœ¨äºä¸¤ä¸ªåœ°æ–¹ã€‚å³åœ¨masterçš„dumperçº¿ç¨‹é€šçŸ¥slaveåï¼Œå¢åŠ äº†ä¸€ä¸ªackï¼ˆæ¶ˆæ¯ç¡®è®¤ï¼‰ï¼Œå³æ˜¯å¦æˆåŠŸæ”¶åˆ°t1çš„æ ‡å¿—ç ï¼Œä¹Ÿå°±æ˜¯dumperçº¿ç¨‹é™¤äº†å‘é€t1åˆ°slaveï¼Œè¿˜æ‰¿æ‹…äº†æ¥æ”¶slaveçš„ackå·¥ä½œã€‚å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œæ²¡æœ‰æ”¶åˆ°ackï¼Œé‚£ä¹ˆå°†è‡ªåŠ¨é™çº§ä¸ºæ™®é€šçš„å¤åˆ¶ï¼Œç›´åˆ°å¼‚å¸¸ä¿®å¤ååˆä¼šè‡ªåŠ¨å˜ä¸ºåŠåŒæ­¥å¤åˆ¶ã€‚ åŠåŒæ­¥å¤åˆ¶å…·ä½“ç‰¹æ€§ï¼š ä»åº“ä¼šåœ¨è¿æ¥åˆ°ä¸»åº“æ—¶å‘Šè¯‰ä¸»åº“ï¼Œå®ƒæ˜¯ä¸æ˜¯é…ç½®äº†åŠåŒæ­¥ã€‚ å¦‚æœåŠåŒæ­¥å¤åˆ¶åœ¨ä¸»åº“ç«¯æ˜¯å¼€å¯äº†çš„ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªåŠåŒæ­¥å¤åˆ¶çš„ä»åº“èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¸»åº“çš„äº‹åŠ¡çº¿ç¨‹åœ¨æäº¤æ—¶ä¼šè¢«é˜»å¡å¹¶ç­‰å¾…ï¼Œç»“æœæœ‰ä¸¤ç§å¯èƒ½ï¼Œè¦ä¹ˆè‡³å°‘ä¸€ä¸ªä»åº“èŠ‚ç‚¹é€šçŸ¥å®ƒå·²ç»æ”¶åˆ°äº†æ‰€æœ‰è¿™ä¸ªäº‹åŠ¡çš„Binlogäº‹ä»¶ï¼Œè¦ä¹ˆä¸€ç›´ç­‰å¾…ç›´åˆ°è¶…è¿‡é…ç½®çš„æŸä¸€ä¸ªæ—¶é—´ç‚¹ä¸ºæ­¢ï¼Œè€Œæ­¤æ—¶ï¼ŒåŠåŒæ­¥å¤åˆ¶å°†è‡ªåŠ¨å…³é—­ï¼Œè½¬æ¢ä¸ºå¼‚æ­¥å¤åˆ¶ã€‚ ä»åº“èŠ‚ç‚¹åªæœ‰åœ¨æ¥æ”¶åˆ°æŸä¸€ä¸ªäº‹åŠ¡çš„æ‰€æœ‰Binlogï¼Œå°†å…¶å†™å…¥å¹¶Flushåˆ°Relay Logæ–‡ä»¶ä¹‹åï¼Œæ‰ä¼šé€šçŸ¥å¯¹åº”ä¸»åº“ä¸Šé¢çš„ç­‰å¾…çº¿ç¨‹ã€‚ å¦‚æœåœ¨ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œç­‰å¾…æ—¶é—´å·²ç»è¶…è¿‡äº†é…ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªä»èŠ‚ç‚¹é€šçŸ¥å½“å‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¸»åº“ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå¼‚æ­¥å¤åˆ¶ï¼Œå½“è‡³å°‘ä¸€ä¸ªåŠåŒæ­¥ä»èŠ‚ç‚¹èµ¶ä¸Šæ¥æ—¶ï¼Œä¸»åº“ä¾¿ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºåŠåŒæ­¥æ–¹å¼çš„å¤åˆ¶ã€‚ åŠåŒæ­¥å¤åˆ¶å¿…é¡»æ˜¯åœ¨ä¸»åº“å’Œä»åº“ä¸¤ç«¯éƒ½å¼€å¯æ—¶æ‰è¡Œï¼Œå¦‚æœåœ¨ä¸»åº“ä¸Šæ²¡æ‰“å¼€ï¼Œæˆ–è€…åœ¨ä¸»åº“ä¸Šå¼€å¯äº†è€Œåœ¨ä»åº“ä¸Šæ²¡æœ‰å¼€å¯ï¼Œä¸»åº“éƒ½ä¼šä½¿ç”¨å¼‚æ­¥æ–¹å¼å¤åˆ¶ã€‚ åŠåŒæ­¥å¤åˆ¶æ½œåœ¨é—®é¢˜ï¼š å…ˆçœ‹ä¸€ä¸‹åŠåŒæ­¥å¤åˆ¶åŸç†å›¾ï¼Œå¦‚ä¸‹ï¼š masterå°†æ¯ä¸ªäº‹åŠ¡å†™å…¥binlogï¼ˆsync_binlog=1ï¼‰ï¼Œä¼ é€’åˆ°slaveåˆ·æ–°åˆ°ç£ç›˜(sync_relay=1)ï¼ŒåŒæ—¶ä¸»åº“æäº¤äº‹åŠ¡ï¼ˆcommitï¼‰ã€‚masterç­‰å¾…slaveåé¦ˆæ”¶åˆ°relay logï¼Œåªæœ‰æ”¶åˆ°ACKåmasteræ‰å°†commit OKç»“æœåé¦ˆç»™å®¢æˆ·ç«¯ã€‚ åœ¨MySQL 5.5~5.6ä½¿ç”¨after_commitçš„æ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯äº‹åŠ¡åœ¨å­˜å‚¨å¼•æ“å±‚æäº¤åï¼Œåœ¨å¾—åˆ°ä»åº“ç¡®è®¤çš„è¿‡ç¨‹ä¸­ï¼Œä¸»åº“å®•æœºäº†ã€‚æ­¤æ—¶ï¼Œå³ä¸»åº“åœ¨ç­‰å¾…Slave ACKçš„æ—¶å€™ï¼Œè™½ç„¶æ²¡æœ‰è¿”å›å½“å‰å®¢æˆ·ç«¯ï¼Œä½†äº‹åŠ¡å·²ç»æäº¤ï¼Œå…¶ä»–å®¢æˆ·ç«¯ä¼šè¯»å–åˆ°å·²æäº¤äº‹åŠ¡ã€‚å¦‚æœSlaveç«¯è¿˜æ²¡æœ‰è¯»åˆ°è¯¥äº‹åŠ¡çš„eventsï¼ŒåŒæ—¶ä¸»åº“å‘ç”Ÿäº†crashï¼Œç„¶ååˆ‡æ¢åˆ°å¤‡åº“ã€‚é‚£ä¹ˆä¹‹å‰è¯»åˆ°çš„äº‹åŠ¡å°±ä¸è§äº†ï¼Œå‡ºç°äº†å¹»è¯»ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå›¾ç‰‡å¼•è‡ªLoss-less Semi-Synchronous Replication on MySQL 5.7.2ã€‚ å¦‚æœä¸»åº“æ°¸è¿œå¯åŠ¨ä¸äº†ï¼Œé‚£ä¹ˆå®é™…ä¸Šåœ¨ä¸»åº“å·²ç»æˆåŠŸæäº¤çš„äº‹åŠ¡ï¼Œåœ¨ä»åº“ä¸Šæ˜¯æ‰¾ä¸åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯æ•°æ®ä¸¢å¤±äº†ï¼Œè¿™æ˜¯MySQLä¸æ„¿æ„çœ‹åˆ°çš„ã€‚æ‰€ä»¥åœ¨MySQL 5.7ç‰ˆæœ¬ä¸­å¢åŠ äº†after_syncï¼ˆæ— æŸå¤åˆ¶ï¼‰å‚æ•°ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºé»˜è®¤åŠåŒæ­¥æ–¹å¼ï¼Œè§£å†³äº†æ•°æ®ä¸¢å¤±çš„é—®é¢˜ ä¸‰ã€MySQL 5.6åŠåŒæ­¥å¤åˆ¶é…ç½® åŠåŒæ­¥å¤åˆ¶çš„å‰ææ˜¯å·²ç»åšå¥½äº†æ™®é€šçš„ä¸»ä»å¤åˆ¶ Masteré…ç½® 3.1masterå®‰è£…åŠåŒæ­¥æ¨¡å—å¹¶å¯åŠ¨ æ­¤æ¨¡å—å°±åœ¨/usr/local/mysql/lib/plugin/semisync_master.so 1.å®‰è£…åŠåŒæ­¥æ¨¡å— mysql> install plugin rpl_semi_sync_master soname 'semisync_master.so'; Query OK, 0 rows affected (0.00 sec) 2.å¯åŠ¨æ’ä»¶ mysql> set global rpl_semi_sync_master_enabled = 1; Query OK, 0 rows affected (0.00 sec) 3.è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤ä¸º10000æ¯«ç§’å³10ç§’ mysql> set global rpl_semi_sync_master_timeout = 2000; Query OK, 0 rows affected (0.00 sec) 4.æŸ¥çœ‹é…ç½® mysql> show global variables like '%semi%'; +------------------------------------+-------+ | Variable_name | Value | +------------------------------------+-------+ | rpl_semi_sync_master_enabled | ON | #åŠåŒæ­¥å¼€å¯ | rpl_semi_sync_master_timeout | 2000 | #è¶…æ—¶æ—¶é—´ä¸º2ç§’ | rpl_semi_sync_master_trace_level | 32 | | rpl_semi_sync_master_wait_no_slave | ON | +------------------------------------+-------+ 4 rows in set (0.00 sec) 5.å†™å…¥mysqlé…ç½®æ–‡ä»¶ï¼Œæ°¸ä¹…ç”Ÿæ•ˆï¼Œåœ¨[mysqld]ä¸‹å†™å…¥ä»¥ä¸‹ä¸¤è¡Œå†…å®¹ rpl_semi_sync_master_enabled = 1; rpl_semi_sync_master_timeout = 2000; å®‰è£…åå¯åŠ¨å’Œå®šåˆ¶ä¸»ä»è¿æ¥é”™è¯¯çš„è¶…æ—¶æ—¶é—´é»˜è®¤æ˜¯10sï¼Œå¯æ”¹ä¸º2sï¼Œä¸€æ—¦æœ‰ä¸€æ¬¡è¶…æ—¶è‡ªåŠ¨é™çº§ä¸ºå¼‚æ­¥ slaveé…ç½® 3.2slaveå®‰è£…åŠåŒæ­¥æ¨¡å—å¹¶å¯åŠ¨ 1.å®‰è£…åŠåŒæ­¥æ¨¡å— mysql> install plugin rpl_semi_sync_slave soname 'semisync_slave.so'; Query OK, 0 rows affected (0.01 sec) 2.å¯åŠ¨æ’ä»¶ mysql> set global rpl_semi_sync_slave_enabled = 1; Query OK, 0 rows affected (0.00 sec) 3.é‡å¯IOçº¿ç¨‹ mysql> stop slave io_thread; Query OK, 0 rows affected (0.00 sec) mysql> start slave io_thread; Query OK, 0 rows affected (0.00 sec) 4.åœ¨masterä¸ŠæŸ¥çœ‹æ˜¯å¦å¯ç”¨äº†åŠåŒæ­¥ mysql> show global status like 'rpl%'; +--------------------------------------------+-------+ | Variable_name | Value | +--------------------------------------------+-------+ | Rpl_semi_sync_master_clients | 1 | #ä¸º1è¡¨æ˜å¼€å¯ | Rpl_semi_sync_master_net_avg_wait_time | 0 | | Rpl_semi_sync_master_net_wait_time | 0 | | Rpl_semi_sync_master_net_waits | 0 | | Rpl_semi_sync_master_no_times | 0 | | Rpl_semi_sync_master_no_tx | 0 | | Rpl_semi_sync_master_status | ON | #ä¸ºONè¡¨æ˜å¼€å¯ | Rpl_semi_sync_master_timefunc_failures | 0 | | Rpl_semi_sync_master_tx_avg_wait_time | 0 | | Rpl_semi_sync_master_tx_wait_time | 0 | | Rpl_semi_sync_master_tx_waits | 0 | | Rpl_semi_sync_master_wait_pos_backtraverse | 0 | | Rpl_semi_sync_master_wait_sessions | 0 | | Rpl_semi_sync_master_yes_tx | 0 | +--------------------------------------------+-------+ 14 rows in set (0.00 sec) ç°åœ¨åŠåŒæ­¥å·²ç»æ­£å¸¸å·¥ä½œäº†ï¼Œä¸»è¦çœ‹Rpl_semi_sync_master_clientsæ˜¯å¦ä¸ä¸º0ï¼ŒRpl_semi_sync_master_statusæ˜¯å¦ä¸ºONã€‚å¦‚æœRpl_semi_sync_master_statusä¸ºOFFï¼Œè¯´æ˜å‡ºç°äº†ç½‘ç»œå»¶è¿Ÿæˆ–Slave IOçº¿ç¨‹å»¶è¿Ÿã€‚ 3.3éªŒè¯åŠåŒæ­¥è¶…æ—¶ slaveä¸Šå…³é—­åŠåŒæ­¥å¹¶é‡å¯IOçº¿ç¨‹ mysql> set global rpl_semi_sync_slave_enabled = 0 ; Query OK, 0 rows affected (0.00 sec) mysql> stop slave io_thread; Query OK, 0 rows affected (0.00 sec) mysql> start slave io_thread; Query OK, 0 rows affected (0.00 sec) masterä¸Šåˆ›å»ºæ•°æ®åº“éªŒè¯ //masteråˆ›å»ºæ•°æ®åº“ mysql> create database dbtest; Query OK, 1 row affected (2.00 sec) mysql> create database dbtest01; Query OK, 1 row affected (0.00 sec) åˆ›å»ºç¬¬ä¸€ä¸ªæ•°æ®åº“èŠ±äº†2.00ç§’ï¼Œè€Œæˆ‘ä»¬å‰é¢è®¾ç½®çš„è¶…æ—¶æ—¶é—´æ˜¯2ç§’ï¼Œè€Œåˆ›å»ºç¬¬äºŒä¸ªæ•°æ®åº“èŠ±äº†0.00ç§’ï¼Œç”±æ­¤å¾—å‡ºç»“è®ºæ˜¯è¶…æ—¶è½¬æ¢ä¸ºå¼‚æ­¥ä¼ é€ã€‚ å¯ä»¥åœ¨Masterä¸ŠæŸ¥çœ‹åŠåŒæ­¥ç›¸å…³çš„å‚æ•°å€¼Rpl_semi_sync_master_clientså’ŒRpl_semi_sync_master_statusæ˜¯å¦æ­£å¸¸ã€‚ mysql> show global status like '%semi%'; +--------------------------------------------+-------+ | Variable_name | Value | +--------------------------------------------+-------+ | Rpl_semi_sync_master_clients | 0 | #ä¸º0è¡¨ç¤ºå…³é—­åŠåŒæ­¥ | Rpl_semi_sync_master_net_avg_wait_time | 0 | | Rpl_semi_sync_master_net_wait_time | 0 | | Rpl_semi_sync_master_net_waits | 0 | | Rpl_semi_sync_master_no_times | 1 | | Rpl_semi_sync_master_no_tx | 2 | | Rpl_semi_sync_master_status | OFF | #OFFè¡¨ç¤ºå…³é—­åŠåŒæ­¥ | Rpl_semi_sync_master_timefunc_failures | 0 | | Rpl_semi_sync_master_tx_avg_wait_time | 0 | | Rpl_semi_sync_master_tx_wait_time | 0 | | Rpl_semi_sync_master_tx_waits | 0 | | Rpl_semi_sync_master_wait_pos_backtraverse | 0 | | Rpl_semi_sync_master_wait_sessions | 0 | | Rpl_semi_sync_master_yes_tx | 0 | +--------------------------------------------+-------+ 14 rows in set (0.00 sec) å¯ä»¥çœ‹åˆ°éƒ½è‡ªåŠ¨å…³é—­äº†ï¼Œéœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œå½“Slaveå¼€å¯åŠåŒæ­¥åï¼Œæˆ–è€…å½“ä¸»ä»ä¹‹é—´ç½‘ç»œå»¶è¿Ÿæ¢å¤æ­£å¸¸çš„æ—¶å€™ï¼ŒåŠåŒæ­¥å¤åˆ¶ä¼šè‡ªåŠ¨ä»å¼‚æ­¥å¤åˆ¶åˆè½¬ä¸ºåŠåŒæ­¥å¤åˆ¶ï¼Œè¿˜æ˜¯ç›¸å½“æ™ºèƒ½çš„ã€‚ å¦å¤–ä¸ªäººåœ¨å®é™…ä½¿ç”¨ä¸­è¿˜ç¢°åˆ°ä¸€ç§æƒ…å†µä»åº“IOçº¿ç¨‹æœ‰å»¶è¿Ÿæ—¶ï¼Œä¸»åº“ä¼šè‡ªåŠ¨æŠŠåŠåŒæ­¥å¤åˆ¶é™ä¸ºå¼‚æ­¥å¤åˆ¶ï¼›å½“ä»åº“IOå»¶è¿Ÿæ²¡æœ‰æ—¶ï¼Œä¸»åº“åˆä¼šæŠŠå¼‚æ­¥å¤åˆ¶å‡çº§ä¸ºåŠåŒæ­¥å¤åˆ¶ã€‚å¯ä»¥è¿›è¡Œå‹æµ‹æ¨¡æ‹Ÿï¼Œä½†æ˜¯æ­¤æ—¶æŸ¥çœ‹Masterçš„çŠ¶æ€è·Ÿä¸Šé¢ç›´æ¥å…³é—­SlaveåŠåŒæ­¥æœ‰äº›ä¸åŒï¼Œä¼šå‘ç°Rpl_semi_sync_master_clientsä»ç„¶ç­‰äº1ï¼Œè€ŒRpl_semi_sync_master_statusç­‰äºOFFã€‚ éšç€MySQL 5.7ç‰ˆæœ¬çš„å‘å¸ƒï¼ŒåŠåŒæ­¥å¤åˆ¶æŠ€æœ¯å‡çº§ä¸ºå…¨æ–°çš„Loss-less Semi-Synchronous Replicationæ¶æ„ï¼Œå…¶æˆç†Ÿåº¦ã€æ•°æ®ä¸€è‡´æ€§ä¸æ‰§è¡Œæ•ˆç‡å¾—åˆ°æ˜¾è‘—çš„æå‡ã€‚ å››ã€MySQL 5.7åŠåŒæ­¥å¤åˆ¶çš„æ”¹è¿› ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåœ¨åŠåŒæ­¥ç¯å¢ƒä¸‹ï¼Œä¸»åº“æ˜¯åœ¨äº‹åŠ¡æäº¤ä¹‹åç­‰å¾…Slave ACKï¼Œæ‰€ä»¥æ‰ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚æ‰€ä»¥è¿™ä¸ªSlave ACKåœ¨ä»€ä¹ˆæ—¶é—´å»ç­‰å¾…ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„é—®é¢˜äº†ã€‚å› æ­¤MySQLé’ˆå¯¹åŠåŒæ­¥å¤åˆ¶çš„é—®é¢˜ï¼Œåœ¨5.7.2å¼•å…¥äº†Loss-less Semi-Synchronousï¼Œåœ¨è°ƒç”¨binlog syncä¹‹åï¼Œengineå±‚commitä¹‹å‰ç­‰å¾…Slave ACKã€‚è¿™æ ·åªæœ‰åœ¨ç¡®è®¤Slaveæ”¶åˆ°äº‹åŠ¡eventsåï¼Œäº‹åŠ¡æ‰ä¼šæäº¤ã€‚åœ¨commitä¹‹å‰ç­‰å¾…Slave ACKï¼ŒåŒæ—¶å¯ä»¥å †ç§¯äº‹åŠ¡ï¼Œåˆ©äºgroup commitï¼Œæœ‰åˆ©äºæå‡æ€§èƒ½ã€‚ 4.1masterå®‰è£…åŠåŒæ­¥æ¨¡å—å¹¶å¯åŠ¨ masteré…ç½® 1.å®‰è£…æ’ä»¶ mysql> install plugin rpl_semi_sync_master soname 'semisync_master.so'; Query OK, 0 rows affected (0.00 sec) 2.æŸ¥çœ‹åŠåŒæ­¥ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°é»˜è®¤ä¸º10000æ¯«ç§’å³10ç§’ mysql> show global variables like '%semi%'; +-------------------------------------------+------------+ | Variable_name | Value | +-------------------------------------------+------------+ | rpl_semi_sync_master_enabled | OFF | | rpl_semi_sync_master_timeout | 10000 | | rpl_semi_sync_master_trace_level | 32 | | rpl_semi_sync_master_wait_for_slave_count | 1 | | rpl_semi_sync_master_wait_no_slave | ON | | rpl_semi_sync_master_wait_point | AFTER_SYNC | +-------------------------------------------+------------+ 6 rows in set (0.00 sec) 3.å¯åŠ¨æ’ä»¶ mysql> set global rpl_semi_sync_master_enabled = 1; Query OK, 0 rows affected (0.00 sec) 4.è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º1ç§’ mysql> set global rpl_semi_sync_master_timeout = 1000; Query OK, 0 rows affected (0.00 sec) 5.æŸ¥çœ‹é…ç½® mysql> show global variables like '%semi%'; +-------------------------------------------+------------+ | Variable_name | Value | +-------------------------------------------+------------+ | rpl_semi_sync_master_enabled | ON | | rpl_semi_sync_master_timeout | 1000 | | rpl_semi_sync_master_trace_level | 32 | | rpl_semi_sync_master_wait_for_slave_count | 1 | | rpl_semi_sync_master_wait_no_slave | ON | | rpl_semi_sync_master_wait_point | AFTER_SYNC | +-------------------------------------------+------------+ 6 rows in set (0.00 sec) 6.å†™å…¥mysqlé…ç½®æ–‡ä»¶ï¼Œæ°¸ä¹…ç”Ÿæ•ˆï¼Œåœ¨[mysqld]ä¸‹å†™å…¥ä»¥ä¸‹ä¸¤è¡Œå†…å®¹ rpl_semi_sync_master_enabled = 1; rpl_semi_sync_master_timeout = 1000; 4.2slaveå®‰è£…åŠåŒæ­¥æ¨¡å—å¹¶å¯åŠ¨ 1.å®‰è£…åŠåŒæ­¥æ¨¡å— mysql> install plugin rpl_semi_sync_slave soname 'semisync_slave.so'; Query OK, 0 rows affected (0.01 sec) 2.å¯åŠ¨æ’ä»¶ mysql> set global rpl_semi_sync_slave_enabled = 1; Query OK, 0 rows affected (0.00 sec) 3.é‡å¯IOçº¿ç¨‹ mysql> stop slave io_thread; Query OK, 0 rows affected (0.00 sec) mysql> start slave io_thread; Query OK, 0 rows affected (0.00 sec) 4.åœ¨masterä¸ŠæŸ¥çœ‹æ˜¯å¦å¯ç”¨äº†åŠåŒæ­¥ mysql> show global status like 'rpl%'; +----------------------------+-------+ | Variable_name | Value | +----------------------------+-------+ | Rpl_semi_sync_slave_status | ON | +----------------------------+-------+ 1 row in set (0.00 sec) 4.3éªŒè¯åŠåŒæ­¥è¶…æ—¶ slaveä¸Šå…³é—­åŠåŒæ­¥å¹¶é‡å¯IOçº¿ç¨‹ mysql> set global rpl_semi_sync_slave_enabled = 0 ; Query OK, 0 rows affected (0.00 sec) mysql> stop slave io_thread; Query OK, 0 rows affected (0.00 sec) mysql> start slave io_thread; Query OK, 0 rows affected (0.00 sec) masterä¸Šåˆ›å»ºæ•°æ®åº“éªŒè¯ //masteråˆ›å»ºæ•°æ®åº“ mysql> create database dbtest; Query OK, 1 row affected (1.00 sec) mysql> create database dbtest01; Query OK, 1 row affected (0.00 sec) åˆ›å»ºç¬¬ä¸€ä¸ªæ•°æ®åº“èŠ±äº†1.00ç§’ï¼Œè€Œæˆ‘ä»¬å‰é¢è®¾ç½®çš„è¶…æ—¶æ—¶é—´æ˜¯1ç§’ï¼Œè€Œåˆ›å»ºç¬¬äºŒä¸ªæ•°æ®åº“èŠ±äº†0.00ç§’ï¼Œç”±æ­¤å¾—å‡ºç»“è®ºæ˜¯è¶…æ—¶è½¬æ¢ä¸ºå¼‚æ­¥ä¼ é€ã€‚ å¯ä»¥åœ¨Masterä¸ŠæŸ¥çœ‹åŠåŒæ­¥ç›¸å…³çš„å‚æ•°å€¼Rpl_semi_sync_master_clientså’ŒRpl_semi_sync_master_statusæ˜¯å¦æ­£å¸¸ã€‚ mysql> show global status like '%semi%'; +--------------------------------------------+-------+ | Variable_name | Value | +--------------------------------------------+-------+ | Rpl_semi_sync_master_clients | 0 | #ä¸º0è¡¨ç¤ºå…³é—­åŠåŒæ­¥ | Rpl_semi_sync_master_net_avg_wait_time | 0 | | Rpl_semi_sync_master_net_wait_time | 0 | | Rpl_semi_sync_master_net_waits | 0 | | Rpl_semi_sync_master_no_times | 1 | | Rpl_semi_sync_master_no_tx | 2 | | Rpl_semi_sync_master_status | OFF | #OFFè¡¨ç¤ºå…³é—­åŠåŒæ­¥ | Rpl_semi_sync_master_timefunc_failures | 0 | | Rpl_semi_sync_master_tx_avg_wait_time | 0 | | Rpl_semi_sync_master_tx_wait_time | 0 | | Rpl_semi_sync_master_tx_waits | 0 | | Rpl_semi_sync_master_wait_pos_backtraverse | 0 | | Rpl_semi_sync_master_wait_sessions | 0 | | Rpl_semi_sync_master_yes_tx | 0 | +--------------------------------------------+-------+ 14 rows in set (0.00 sec) å¯ä»¥çœ‹åˆ°éƒ½è‡ªåŠ¨å…³é—­äº† 4.4æ”¯æŒæ— æŸå¤åˆ¶(Loss-less Semi-Synchronous) åœ¨Loss-less Semi-Synchronousæ¨¡å¼ä¸‹ï¼Œmasteråœ¨è°ƒç”¨binlog syncä¹‹åï¼Œengineå±‚commitä¹‹å‰ç­‰å¾…Slave ACKï¼ˆéœ€è¦æ”¶åˆ°è‡³å°‘ä¸€ä¸ªSlaveèŠ‚ç‚¹å›å¤çš„ACKåï¼‰ã€‚è¿™æ ·åªæœ‰åœ¨ç¡®è®¤Slaveæ”¶åˆ°äº‹åŠ¡eventsåï¼Œmasteräº‹åŠ¡æ‰ä¼šæäº¤ï¼Œç„¶åæŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ­¤æ—¶æ­¤äº‹åŠ¡æ‰å¯¹å…¶ä»–äº‹åŠ¡å¯è§ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹è§£å†³äº†after_commitæ¨¡å¼å¸¦æ¥çš„å¹»è¯»å’Œæ•°æ®ä¸¢å¤±é—®é¢˜ï¼Œå› ä¸ºä¸»åº“æ²¡æœ‰æäº¤äº‹åŠ¡ã€‚ä½†ä¹Ÿä¼šæœ‰ä¸ªé—®é¢˜ï¼Œå‡è®¾ä¸»åº“åœ¨å­˜å‚¨å¼•æ“æäº¤ä¹‹å‰æŒ‚äº†ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾è¿™ä¸ªäº‹åŠ¡æ˜¯ä¸æˆåŠŸçš„ï¼Œä½†ç”±äºå¯¹åº”çš„Binlogå·²ç»åšäº†Syncæ“ä½œï¼Œä»åº“å·²ç»æ”¶åˆ°äº†è¿™äº›Binlogï¼Œå¹¶ä¸”æ‰§è¡ŒæˆåŠŸï¼Œç›¸å½“äºåœ¨ä»åº“ä¸Šå¤šäº†æ•°æ®ï¼Œä¹Ÿç®—æ˜¯æœ‰é—®é¢˜çš„ï¼Œä½†å¤šäº†æ•°æ®ï¼Œé—®é¢˜ä¸€èˆ¬ä¸ç®—ä¸¥é‡ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥è¿™æ ·ç†è§£ï¼Œä½œä¸ºMySQLï¼Œåœ¨æ²¡åŠæ³•è§£å†³åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œå®ƒèƒ½ä¿è¯çš„æ˜¯ä¸ä¸¢æ•°æ®ï¼Œå¤šäº†æ•°æ®æ€»æ¯”ä¸¢æ•°æ®è¦å¥½ã€‚ æ— æŸå¤åˆ¶å…¶å®å°±æ˜¯å¯¹semi syncå¢åŠ äº†rpl_semi_sync_master_wait_pointå‚æ•°ï¼Œæ¥æ§åˆ¶åŠåŒæ­¥æ¨¡å¼ä¸‹ä¸»åº“åœ¨è¿”å›ç»™ä¼šè¯äº‹åŠ¡æˆåŠŸä¹‹å‰æäº¤äº‹åŠ¡çš„æ–¹å¼ã€‚rpl_semi_sync_master_wait_pointè¯¥å‚æ•°æœ‰ä¸¤ä¸ªå€¼ï¼šAFTER_COMMITå’ŒAFTER_SYNC 4.4.1ç¬¬ä¸€ä¸ªå€¼ï¼šAFTER_COMMITï¼ˆ5.6é»˜è®¤å€¼ï¼‰ masterå°†æ¯ä¸ªäº‹åŠ¡å†™å…¥binlogï¼ˆsync_binlog=1ï¼‰ï¼Œä¼ é€’åˆ°slaveåˆ·æ–°åˆ°ç£ç›˜(sync_relay=1)ï¼ŒåŒæ—¶ä¸»åº“æäº¤äº‹åŠ¡ã€‚masterç­‰å¾…slaveåé¦ˆæ”¶åˆ°relay logï¼Œåªæœ‰æ”¶åˆ°ACKåmasteræ‰å°†commit OKç»“æœåé¦ˆç»™å®¢æˆ·ç«¯ã€‚ ç¬¬äºŒä¸ªå€¼ï¼šAFTER_SYNCï¼ˆ5.7é»˜è®¤å€¼ï¼Œä½†5.6ä¸­æ— æ­¤æ¨¡å¼ï¼‰ masterå°†æ¯ä¸ªäº‹åŠ¡å†™å…¥binlog , ä¼ é€’åˆ°slaveåˆ·æ–°åˆ°ç£ç›˜(relay log)ã€‚masterç­‰å¾…slaveåé¦ˆæ¥æ”¶åˆ°relay logçš„ackä¹‹åï¼Œå†æäº¤äº‹åŠ¡å¹¶ä¸”è¿”å›commit OKç»“æœç»™å®¢æˆ·ç«¯ã€‚ å³ä½¿ä¸»åº“crashï¼Œæ‰€æœ‰åœ¨ä¸»åº“ä¸Šå·²ç»æäº¤çš„äº‹åŠ¡éƒ½èƒ½ä¿è¯å·²ç»åŒæ­¥åˆ°slaveçš„relay logä¸­ã€‚ 4.5åŠåŒæ­¥å¤åˆ¶ä¸æ— æŸå¤åˆ¶çš„å¯¹æ¯” 4.5.1 ACKçš„æ—¶é—´ç‚¹ä¸åŒ åŠåŒæ­¥å¤åˆ¶åœ¨InnoDBå±‚çš„Commit Logåç­‰å¾…ACKï¼Œä¸»ä»åˆ‡æ¢ä¼šæœ‰æ•°æ®ä¸¢å¤±é£é™©ã€‚ æ— æŸå¤åˆ¶åœ¨MySQL Serverå±‚çš„Write binlogåç­‰å¾…ACKï¼Œä¸»ä»åˆ‡æ¢ä¼šæœ‰æ•°æ®å˜å¤šé£é™©ã€‚ 4.5.2 ä¸»ä»æ•°æ®ä¸€è‡´æ€§ åŠåŒæ­¥å¤åˆ¶æ„å‘³ç€åœ¨MasterèŠ‚ç‚¹ä¸Šï¼Œè¿™ä¸ªåˆšåˆšæäº¤çš„äº‹ç‰©å¯¹æ•°æ®åº“çš„ä¿®æ”¹ï¼Œå¯¹å…¶ä»–äº‹ç‰©æ˜¯å¯è§çš„ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨ç­‰å¾…Slave ACKçš„æ—¶å€™crashäº†ï¼Œé‚£ä¹ˆä¼šå¯¹å…¶ä»–äº‹åŠ¡å‡ºç°å¹»è¯»ï¼Œæ•°æ®ä¸¢å¤±ã€‚ æ— æŸå¤åˆ¶åœ¨write binlogå®Œæˆåï¼Œå°±ä¼ è¾“binlogï¼Œä½†è¿˜æ²¡æœ‰å»å†™commit logï¼Œæ„å‘³ç€å½“å‰è¿™ä¸ªäº‹ç‰©å¯¹æ•°æ®åº“çš„ä¿®æ”¹ï¼Œå…¶ä»–äº‹ç‰©ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚å› æ­¤ï¼Œä¸ä¼šå‡ºç°å¹»è¯»ï¼Œæ•°æ®ä¸¢å¤±é£é™©ã€‚ å› æ­¤5.7å¼•å…¥äº†æ— æŸå¤åˆ¶ï¼ˆafter_syncï¼‰æ¨¡å¼ï¼Œå¸¦æ¥çš„ä¸»è¦æ”¶ç›Šæ˜¯è§£å†³after_commitå¯¼è‡´çš„master crashåæ•°æ®ä¸¢å¤±é—®é¢˜ï¼Œå› æ­¤åœ¨å¼•å…¥after_syncæ¨¡å¼åï¼Œæ‰€æœ‰æäº¤çš„æ•°æ®å·²ç»éƒ½è¢«å¤åˆ¶ï¼Œæ•…éšœåˆ‡æ¢æ—¶æ•°æ®ä¸€è‡´æ€§å°†å¾—åˆ°æå‡ã€‚ æ€§èƒ½æå‡ï¼Œæ”¯æŒå‘é€binlogå’Œæ¥å—ackçš„å¼‚æ­¥åŒ– æ—§ç‰ˆæœ¬çš„semi syncå—é™äºdump thread ï¼ŒåŸå› æ˜¯dump threadæ‰¿æ‹…äº†ä¸¤ä»½ä¸åŒä¸”åˆååˆ†é¢‘ç¹çš„ä»»åŠ¡ï¼šä¼ é€binlogç»™slave ï¼Œè¿˜éœ€è¦ç­‰å¾…slaveåé¦ˆä¿¡æ¯ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œdump threadå¿…é¡»ç­‰å¾…slaveè¿”å›ä¹‹åæ‰ä¼šä¼ é€ä¸‹ä¸€ä¸ªeventsäº‹åŠ¡ã€‚dump threadå·²ç„¶æˆä¸ºæ•´ä¸ªåŠåŒæ­¥æé«˜æ€§èƒ½çš„ç“¶é¢ˆã€‚åœ¨é«˜å¹¶å‘ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œè¿™æ ·çš„æœºåˆ¶ä¼šå½±å“æ•°æ®åº“æ•´ä½“çš„TPS ã€‚ ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œåœ¨5.7ç‰ˆæœ¬çš„semi syncæ¡†æ¶ä¸­ï¼Œç‹¬ç«‹å‡ºä¸€ä¸ªAck Receiverçº¿ç¨‹ ï¼Œä¸“é—¨ç”¨äºæ¥æ”¶slaveè¿”å›çš„ackè¯·æ±‚ï¼Œè¿™å°†ä¹‹å‰dumpçº¿ç¨‹çš„å‘é€å’Œæ¥å—å·¥ä½œåˆ†ä¸ºäº†ä¸¤ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚è¿™æ ·masterä¸Šæœ‰ä¸¤ä¸ªçº¿ç¨‹ç‹¬ç«‹å·¥ä½œï¼Œå¯ä»¥åŒæ—¶å‘é€binlogåˆ°slaveï¼Œå’Œæ¥æ”¶slaveçš„ackä¿¡æ¯ã€‚å› æ­¤åŠåŒæ­¥å¤åˆ¶å¾—åˆ°äº†æå¤§çš„æ€§èƒ½æå‡ã€‚è¿™ä¹Ÿæ˜¯MySQL 5.7å‘å¸ƒæ—¶å·ç§°çš„Faster semi-sync replicationã€‚ ä½†æ˜¯åœ¨MySQL 5.7.17ä¹‹å‰ï¼Œè¿™ä¸ªAck Receiverçº¿ç¨‹é‡‡ç”¨äº†selectæœºåˆ¶æ¥ç›‘å¬slaveè¿”å›çš„ç»“æœï¼Œç„¶è€Œselectæœºåˆ¶ç›‘æ§çš„æ–‡ä»¶å¥æŸ„åªèƒ½æ˜¯0-1024ï¼Œå½“è¶…è¿‡1024æ—¶ï¼Œç”¨æˆ·åœ¨MySQLçš„é”™è¯¯æ—¥å¿—ä¸­æˆ–è®¸ä¼šæ”¶åˆ°ç±»ä¼¼å¦‚ä¸‹çš„æŠ¥é”™ï¼Œæ›´æœ‰ç”šè€…ä¼šå¯¼è‡´MySQLå‘ç”Ÿå®•æœºã€‚ semi-sync master failed on net_flush() before waiting for slave reply. MySQL 5.7.17ç‰ˆæœ¬å¼€å§‹ï¼Œå®˜æ–¹ä¿®å¤äº†è¿™ä¸ªbugï¼Œå¼€å§‹ä½¿ç”¨pollæœºåˆ¶æ¥æ›¿æ¢åŸæ¥çš„selectæœºåˆ¶ï¼Œä»è€Œå¯ä»¥é¿å…ä¸Šé¢çš„é—®é¢˜ã€‚å…¶å®pollè°ƒç”¨æœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯åœ¨I/Oå¥æŸ„æ•°ç†è®ºä¸Šæ²¡æœ‰ä¸Šé™äº†ï¼ŒåŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å­˜å‚¨çš„ã€‚ä½†æ˜¯åŒæ ·æœ‰ç¼ºç‚¹ï¼šæ¯”å¦‚å¤§é‡çš„fdçš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´ï¼Œè€Œä¸ç®¡è¿™æ ·çš„å¤åˆ¶æ˜¯ä¸æ˜¯æœ‰æ„ä¹‰ã€‚pollè¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯â€œæ°´å¹³è§¦å‘â€ï¼Œå¦‚æœæŠ¥å‘Šäº†fdåï¼Œæ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡pollæ—¶ä¼šå†æ¬¡æŠ¥å‘Šè¯¥fdã€‚ å…¶å®åœ¨é«˜æ€§èƒ½è½¯ä»¶ä¸­éƒ½æ˜¯ç”¨å¦å¤–ä¸€ç§è°ƒç”¨æœºåˆ¶ï¼Œåä¸ºepollï¼Œé«˜æ€§èƒ½çš„ä»£è¡¨ï¼Œæ¯”å¦‚Nginxï¼Œhaproxyç­‰éƒ½æ˜¯ä½¿ç”¨epollã€‚å¯èƒ½pollçš„å¤æ‚æ€§æ¯”epollä½ï¼Œå¦å¤–å¯¹äºack receiverçº¿ç¨‹æ¥è¯´å¯èƒ½pollè¶³çŸ£ã€‚ æ€§èƒ½æå‡ï¼Œæ§åˆ¶ä¸»åº“æ¥æ”¶slaveå†™äº‹åŠ¡æˆåŠŸåé¦ˆæ•°é‡ MySQL 5.7æ–°å¢äº†rpl_semi_sync_master_wait_slave_countå‚æ•°ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶ä¸»åº“æ¥å—å¤šå°‘ä¸ªslaveå†™äº‹åŠ¡æˆåŠŸåé¦ˆï¼Œç»™é«˜å¯ç”¨æ¶æ„åˆ‡æ¢æä¾›äº†çµæ´»æ€§ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œå½“countå€¼ä¸º2æ—¶ï¼Œmasteréœ€ç­‰å¾…ä¸¤ä¸ªslaveçš„ackã€‚ æ€§èƒ½æå‡ï¼ŒBinlogäº’æ–¥é”æ”¹è¿› æ—§ç‰ˆæœ¬åŠåŒæ­¥å¤åˆ¶åœ¨ä¸»æäº¤binlogçš„å†™ä¼šè¯å’Œdump threadè¯»binlogçš„æ“ä½œéƒ½ä¼šå¯¹binlogæ·»åŠ äº’æ–¥é”ï¼Œå¯¼è‡´binlogæ–‡ä»¶çš„è¯»å†™æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œå­˜åœ¨å¹¶å‘åº¦çš„é—®é¢˜ã€‚ MySQL 5.7å¯¹binlog lockè¿›è¡Œäº†ä»¥ä¸‹ä¸¤æ–¹é¢ä¼˜åŒ–: 1.ç§»é™¤äº†dump threadå¯¹binlogçš„äº’æ–¥é”ã€‚ 2.åŠ å…¥äº†å®‰å…¨è¾¹é™…ä¿è¯binlogçš„è¯»å®‰å…¨ã€‚ å¯ä»¥çœ‹åˆ°ä»replicationåŠŸèƒ½å¼•å…¥åï¼Œå®˜æ–¹MySQLä¸€ç›´åœ¨ä¸åœçš„å®Œå–„ï¼Œå‰è¿›ã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°å½“å‰åŸç”Ÿçš„MySQLä¸»å¤‡å¤åˆ¶å®ç°å®é™…ä¸Šå¾ˆéš¾åœ¨æ»¡è¶³æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹åšåˆ°é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlè¿›é˜¶/6.MHAåŸºäºæ™®é€šä¸»ä»å¤åˆ¶é«˜å¯ç”¨.html":{"url":"db/mysql/mysqlè¿›é˜¶/6.MHAåŸºäºæ™®é€šä¸»ä»å¤åˆ¶é«˜å¯ç”¨.html","title":"MHAåŸºäºæ™®é€šä¸»ä»å¤åˆ¶é«˜å¯ç”¨","keywords":"","body":"MHAåŸºäºæ™®é€šä¸»ä»å¤åˆ¶é«˜å¯ç”¨ MHA gIthubåœ°å€ MHA github wikiåœ°å€ ä¸€ã€MHAç®€ä»‹ MHAé€šå¸¸åœ¨10åˆ°30ç§’å†…ä»¥æœ€å°‘çš„åœæœºæ—¶é—´æ‰§è¡Œè‡ªåŠ¨çš„ä¸»æ•…éšœè½¬ç§»å’Œä»å‡çº§ã€‚MHAå¯ä»¥é˜²æ­¢å¤åˆ¶ä¸€è‡´æ€§é—®é¢˜ï¼Œå¹¶èŠ‚çœäº†å¿…é¡»è´­ä¹°å…¶ä»–æœåŠ¡å™¨çš„è´¹ç”¨ã€‚æ‰€æœ‰è¿™äº›éƒ½å…·æœ‰é›¶æ€§èƒ½ä¸‹é™ï¼Œæ— å¤æ‚æ€§ï¼ˆæ˜“äºå®‰è£…ï¼‰å¹¶ä¸”æ— éœ€æ›´æ”¹ç°æœ‰éƒ¨ç½²çš„æƒ…å†µã€‚ MHAè¿˜æä¾›äº†è®¡åˆ’çš„åœ¨çº¿ä¸»è®¾å¤‡åˆ‡æ¢ï¼Œå¯ä»¥åœ¨åœæœºï¼ˆä»…é˜»æ­¢å†™å…¥ï¼‰çš„å‡ ç§’é’Ÿï¼ˆ0.5-2ç§’ï¼‰å†…å°†å½“å‰æ­£åœ¨è¿è¡Œçš„ä¸»è®¾å¤‡å®‰å…¨åœ°æ›´æ”¹ä¸ºæ–°çš„ä¸»è®¾å¤‡ã€‚ MHAæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼Œåœ¨éœ€è¦é«˜å¯ç”¨æ€§ï¼Œæ•°æ®å®Œæ•´æ€§å’Œè¿‘ä¹ä¸é—´æ–­çš„ä¸»ç»´æŠ¤çš„è®¸å¤šéƒ¨ç½²ä¸­å¾ˆæœ‰ç”¨ã€‚ è‡ªåŠ¨åŒ–çš„ä¸»ç«™ç›‘è§†å’Œæ•…éšœè½¬ç§» MHAå¯ä»¥ç›‘è§†ç°æœ‰å¤åˆ¶ç¯å¢ƒä¸­çš„MySQLä¸»æœåŠ¡å™¨ï¼Œå¹¶åœ¨æ£€æµ‹åˆ°ä¸»æœåŠ¡å™¨æ•…éšœæ—¶æ‰§è¡Œè‡ªåŠ¨ä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§»ã€‚MHAé€šè¿‡è¯†åˆ«æ¥è‡ªæœ€æ–°ä»ç«™çš„å·®åˆ†ä¸­ç»§æ—¥å¿—äº‹ä»¶å¹¶å°†å…¶åº”ç”¨äºæ‰€æœ‰å…¶ä»–ä»ç«™ï¼ŒåŒ…æ‹¬é‚£äº›å°šæœªæ”¶åˆ°æœ€æ–°ä¸­ç»§æ—¥å¿—äº‹ä»¶çš„ä»ç«™ï¼Œæ¥ä¿è¯æ‰€æœ‰ä»ç«™çš„ä¸€è‡´æ€§ã€‚MHAé€šå¸¸å¯ä»¥åœ¨å‡ ç§’é’Ÿå†…æ‰§è¡Œæ•…éšœè½¬ç§»ï¼š9åˆ°12ç§’é’Ÿç”¨äºæ£€æµ‹ä¸»è®¾å¤‡æ•…éšœï¼Œå¯é€‰åœ°7åˆ°10ç§’é’Ÿç”¨äºå…³é—­ä¸»è®¡ç®—æœºç”µæºï¼Œä»¥é¿å…è„‘éƒ¨åˆ†è£‚ï¼›å‡ ç§’é’Ÿçš„æ—¶é—´å°†å·®åˆ†ä¸­ç»§æ—¥å¿—åº”ç”¨äºæ–°çš„ä¸»è®¾å¤‡ã€‚æ€»åœæœºæ—¶é—´é€šå¸¸ä¸º10-30ç§’ã€‚å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­å°†ç‰¹å®šä»ç«™æŒ‡å®šä¸ºå€™é€‰ä¸»ç«™ï¼ˆè®¾ç½®ä¼˜å…ˆçº§ï¼‰ã€‚ç”±äºMHAç»´æŠ¤ä»ç«™ä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œä»»ä½•å¥´éš¶éƒ½å¯ä»¥æ™‹å‡ä¸ºæ–°ä¸»äººã€‚é€šå¸¸ä¸ä¼šå¯¼è‡´çªç„¶çš„å¤åˆ¶å¤±è´¥çš„ä¸€è‡´æ€§é—®é¢˜å°†ä¸ä¼šå‘ç”Ÿã€‚ äº¤äº’å¼ï¼ˆæ‰‹åŠ¨å¯åŠ¨ï¼‰ä¸»æ•…éšœè½¬ç§» å¯ä»¥å°†MHAé…ç½®ä¸ºæ‰‹åŠ¨å¯åŠ¨ï¼ˆéè‡ªåŠ¨ï¼‰ï¼Œäº¤äº’å¼æ•…éšœè½¬ç§»ï¼Œè€Œæ— éœ€ç›‘è§†ä¸»æœåŠ¡å™¨ã€‚ éäº¤äº’å¼ä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§» è¿˜æ”¯æŒä¸ç›‘è§†ä¸»æœåŠ¡å™¨çš„éäº¤äº’å¼è‡ªåŠ¨ä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§»ã€‚å½“å·²ç»ä½¿ç”¨MySQLä¸»è½¯ä»¶ç›‘è§†æ—¶ï¼Œæ­¤åŠŸèƒ½ç‰¹åˆ«æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Pacemakerï¼ˆHeartbeatï¼‰æ£€æµ‹ä¸»æœåŠ¡å™¨æ•…éšœå’Œè™šæ‹ŸIPåœ°å€æ¥ç®¡ï¼Œè€Œä½¿ç”¨MHAè¿›è¡Œä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§»å’Œä»å±å‡çº§ã€‚ åœ¨çº¿å°†ä¸»æœåŠ¡å™¨åˆ‡æ¢åˆ°å…¶ä»–ä¸»æœº é€šå¸¸æœ‰å¿…è¦å°†ç°æœ‰çš„ä¸»æœåŠ¡å™¨è¿ç§»åˆ°å¦ä¸€å°è®¡ç®—æœºä¸Šï¼Œä¾‹å¦‚å½“å‰ä¸»æœåŠ¡å™¨å­˜åœ¨ç¡¬ä»¶RAIDæ§åˆ¶å™¨æˆ–RAMé—®é¢˜ï¼Œæˆ–è€…è¦ç”¨é€Ÿåº¦æ›´å¿«çš„è®¡ç®—æœºæ›¿æ¢å®ƒç­‰æ—¶ï¼Œè¿™ä¸æ˜¯ä¸»æœåŠ¡å™¨å´©æºƒï¼Œä½†éœ€è¦å®šæœŸè¿›è¡Œä¸»ç»´æŠ¤ã€‚è®¡åˆ’çš„ä¸»æœºç»´æŠ¤åº”å°½å¿«å®Œæˆï¼Œå› ä¸ºè¿™ä¼šå¯¼è‡´éƒ¨åˆ†åœæœºï¼ˆç¦ç”¨ä¸»æœºå†™å…¥ï¼‰ã€‚å¦ä¸€æ–¹é¢ï¼Œæ‚¨åº”è¯¥éå¸¸ä»”ç»†åœ°é˜»æ­¢/æ€æ­»å½“å‰æ­£åœ¨è¿è¡Œçš„ä¼šè¯ï¼Œå› ä¸ºä¸åŒçš„masterä¹‹é—´å¯èƒ½ä¼šå‘ç”Ÿä¸€è‡´æ€§é—®é¢˜ï¼ˆå³â€œæ›´æ–°master1ï¼Œæ›´æ–°master 2ï¼Œæäº¤master1ï¼Œåœ¨æäº¤master 2æ—¶å‡ºé”™â€ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼‰ã€‚å¿«é€Ÿä¸»å¼€å…³å’Œå¹³ç¨³é˜»æ­¢å†™å…¥éƒ½æ˜¯å¿…éœ€çš„ã€‚ MHAåœ¨å†™å…¥å™¨é˜»å¡åçš„0.5-2ç§’å†…æä¾›æ­£å¸¸çš„ä¸»è®¾å¤‡åˆ‡æ¢ã€‚é€šå¸¸å¯ä»¥æ¥å—0.5-2ç§’çš„å†™å…¥å™¨åœæœºæ—¶é—´ï¼Œå› æ­¤å³ä½¿ä¸åˆ†é…è®¡åˆ’çš„ç»´æŠ¤æ—¶æ®µï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ‡æ¢ä¸»æœºã€‚å‡çº§åˆ°æ›´é«˜ç‰ˆæœ¬ï¼Œæ›´å¿«çš„è®¡ç®—æœºç­‰æ“ä½œå˜å¾—æ›´åŠ å®¹æ˜“ã€‚ äºŒã€MHAæ¶æ„ MHAæ¶æ„å®˜æ–¹æ–‡æ¡£ æ­£å¸¸å·¥ä½œæ—¶æ¶æ„ ä¸»åº“downæœºæ—¶æ¶æ„ è¯¥è½¯ä»¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šMHA Managerï¼ˆç®¡ç†èŠ‚ç‚¹ï¼‰å’ŒMHA Nodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰ã€‚ MHA Managerå¯ä»¥å•ç‹¬éƒ¨ç½²åœ¨ä¸€å°ç‹¬ç«‹çš„æœºå™¨ä¸Šç®¡ç†å¤šä¸ªmaster-slaveé›†ç¾¤ï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨ä¸€å°slaveèŠ‚ç‚¹ä¸Šã€‚ MHA Nodeè¿è¡Œåœ¨æ¯å°MySQLæœåŠ¡å™¨ä¸Šï¼ŒMHA Managerä¼šå®šæ—¶æ¢æµ‹é›†ç¾¤ä¸­çš„masterèŠ‚ç‚¹ï¼Œå½“masterå‡ºç°æ•…éšœæ—¶ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨å°†æœ€æ–°æ•°æ®çš„slaveæå‡ä¸ºæ–°çš„masterï¼Œç„¶åå°†æ‰€æœ‰å…¶ä»–çš„slaveé‡æ–°æŒ‡å‘æ–°çš„masterã€‚æ•´ä¸ªæ•…éšœè½¬ç§»è¿‡ç¨‹å¯¹åº”ç”¨ç¨‹åºå®Œå…¨é€æ˜ã€‚ åœ¨MHAè‡ªåŠ¨æ•…éšœåˆ‡æ¢è¿‡ç¨‹ä¸­ï¼ŒMHAè¯•å›¾ä»å®•æœºçš„ä¸»æœåŠ¡å™¨ä¸Šä¿å­˜äºŒè¿›åˆ¶æ—¥å¿—ï¼Œæœ€å¤§ç¨‹åº¦çš„ä¿è¯æ•°æ®çš„ä¸ä¸¢å¤±(é…åˆmysqlåŠåŒæ­¥å¤åˆ¶æ•ˆæœæ›´ä½³)ï¼Œä½†è¿™å¹¶ä¸æ€»æ˜¯å¯è¡Œçš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸»æœåŠ¡å™¨ç¡¬ä»¶æ•…éšœæˆ–æ— æ³•é€šè¿‡sshè®¿é—®ï¼ŒMHAæ²¡æ³•ä¿å­˜äºŒè¿›åˆ¶æ—¥å¿—ï¼Œåªè¿›è¡Œæ•…éšœè½¬ç§»è€Œä¸¢å¤±äº†æœ€æ–°çš„æ•°æ®ã€‚ä½¿ç”¨MySQL 5.5çš„åŠåŒæ­¥å¤åˆ¶ï¼Œå¯ä»¥å¤§å¤§é™ä½æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚MHAå¯ä»¥ä¸åŠåŒæ­¥å¤åˆ¶ç»“åˆèµ·æ¥ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªslaveå·²ç»æ”¶åˆ°äº†æœ€æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ŒMHAå¯ä»¥å°†æœ€æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—åº”ç”¨äºå…¶ä»–æ‰€æœ‰çš„slaveæœåŠ¡å™¨ä¸Šï¼Œå› æ­¤å¯ä»¥ä¿è¯æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ã€‚ æ³¨æ„ï¼šç›®å‰MHAä¸»è¦æ”¯æŒä¸€ä¸»å¤šä»çš„æ¶æ„ï¼Œè¦æ­å»ºMHA,è¦æ±‚ä¸€ä¸ªå¤åˆ¶é›†ç¾¤ä¸­å¿…é¡»æœ€å°‘æœ‰ä¸‰å°æ•°æ®åº“æœåŠ¡å™¨ï¼Œä¸€ä¸»äºŒä»ï¼Œå³ä¸€å°å……å½“masterï¼Œä¸€å°å……å½“å¤‡ç”¨masterï¼Œå¦å¤–ä¸€å°å……å½“ä»åº“ï¼Œå› ä¸ºè‡³å°‘éœ€è¦ä¸‰å°æœåŠ¡å™¨ã€‚ å·¥ä½œè¿‡ç¨‹ï¼šmanagerèŠ‚ç‚¹å®šæ—¶æ£€æµ‹å¤åˆ¶é›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªnode,å¦‚æœmasterå®•æœºä¼šé€‰å‡ºæ•°æ®ä¸masteræœ€æ¥è¿‘çš„ä¸€å°slaveæ¥ä½œä¸ºæ–°masterï¼Œå»åˆ°æ—§masterä¸­æ‹·è´binlogåˆ°æ–°masterä¸­å¹¶åº”ç”¨binlogä»¥ä¿è¯æ–°masterä¸æ—§masteræ•°æ®ä¸€è‡´ï¼Œç„¶åå°†å‰©ä½™çš„slaveé‡æ–°changer master to,å°†slaveçš„ä¸»åˆ‡æ¢ä¸ºæ–°master ä¸‰ã€éƒ¨ç½²è¿‡ç¨‹ å®éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå ç³»ç»Ÿ æœºå™¨é…ç½® mysqlç‰ˆæœ¬ manager 10.0.0.130 mha centos7.8 2c4g 5.7.28 mysql-master 10.0.0.133 mysql01 centos7.8 2c4g 5.7.28 mysql-slave1 10.0.0.134 mysql02 centos7.8 2c4g 5.7.28 mysql-slave2 10.0.0.135 mysql03 centos7.8 2c4g 5.7.28 3.1 ä¸‹è½½å®‰è£…åŒ… MHA manager0.58ä¸‹è½½åœ°å€ MHA node0.58ä¸‹è½½åœ°å€ MHA 0.56 ä¸‹è½½åœ°å€ Managerå·¥å…·åŒ…ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå·¥å…·ï¼š åç§° å«ä¹‰ masterha_check_ssh æ£€æŸ¥MHAçš„SSHé…ç½®çŠ¶å†µ masterha_check_repl æ£€æŸ¥MySQLå¤åˆ¶çŠ¶å†µ masterha_manger å¯åŠ¨MHA masterha_check_status æ£€æµ‹å½“å‰MHAè¿è¡ŒçŠ¶æ€ masterha_master_monitor æ£€æµ‹masteræ˜¯å¦å®•æœº masterha_master_switch æ§åˆ¶æ•…éšœè½¬ç§»ï¼ˆè‡ªåŠ¨æˆ–è€…æ‰‹åŠ¨ï¼‰ masterha_conf_host æ·»åŠ æˆ–åˆ é™¤é…ç½®çš„serverä¿¡æ¯ Nodeå·¥å…·åŒ…ï¼ˆè¿™äº›å·¥å…·é€šå¸¸ç”±MHA Managerçš„è„šæœ¬è§¦å‘ï¼Œæ— éœ€äººä¸ºæ“ä½œï¼‰ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå·¥å…·ï¼š åç§° å«ä¹‰ save_binary_logs ä¿å­˜å’Œå¤åˆ¶masterçš„äºŒè¿›åˆ¶æ—¥å¿— apply_diff_relay_logs è¯†åˆ«å·®å¼‚çš„ä¸­ç»§æ—¥å¿—äº‹ä»¶å¹¶å°†å…¶å·®å¼‚çš„äº‹ä»¶åº”ç”¨äºå…¶ä»–çš„slave filter_mysqlbinlog å»é™¤ä¸å¿…è¦çš„ROLLBACKäº‹ä»¶ï¼ˆMHAå·²ä¸å†ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼‰ purge_relay_logs æ¸…é™¤ä¸­ç»§æ—¥å¿—ï¼ˆä¸ä¼šé˜»å¡SQLçº¿ç¨‹ï¼‰ 3.2 æ‰€æœ‰æœºå™¨åšç›¸äº’å…å¯†é’¥é…ç½® âš ï¸å¤åˆ¶é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¯èƒ½æˆä¸ºmasterï¼Œéƒ½å¾—å¼€å¯binlogå’Œsshå¯†é’¥è®¤è¯ï¼Œå› ä¸ºå½“æ—§masterå®•æœºåï¼Œmhaè¦æ‹·è´binlogåˆ°æ‰€æœ‰nodeèŠ‚ç‚¹ä¸Šï¼Œè€Œä¸”æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰å¯èƒ½æˆä¸ºmasterï¼Œæ•…æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦å½¼æ­¤å¯†é’¥è®¤è¯ lowBè„šæœ¬è¿è¡Œä¸€ä¸‹ #!/bin/bash file_path=/root file_name=host.txt file=$file_path/$file_name user=root pwd=1 ssh_file=~/.ssh/id_rsa yum -y install expect &> /dev/null #ç”Ÿæˆå¯†é’¥ [ -f \"$ssh_file\" ] || ssh-keygen -q -N \"\" -f ~/.ssh/id_rsa read -p \"è¯·è¾“å…¥å¼€å§‹æ•°å€¼: \" start_num read -p \"è¯·è¾“å…¥ç»“æŸæ•°å€¼: \" end_num read -p \"è¯·è¾“å…¥ç½‘æ®µ(ç±»ä¼¼æ ¼å¼ï¼š10.0.0.)ï¼š\" sub_net seq $start_num $end_num >$file #åœ¨æ–‡ä»¶å¼€å¤´åŠ ä¸Šç½‘æ®µï¼Œåœ¨æ–‡ä»¶æœ«å°¾åŠ ä¸Šç”¨æˆ·åå’Œå¯†ç  sed -i 's/^/'$sub_net'/g' $file sed -i 's/$/ '$user' '$pwd'/g' $file echo -e \"æ‰§è¡ŒæˆåŠŸï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:\\n`cat $file`\" while read line;do ip=`echo $line | awk '{print $1}'` username=`echo $line | awk '{print $2}'` password=`echo $line | awk '{print $3}'` expect 3.3 mysqlä¸»ä»é…ç½® è¿™é‡Œæ˜¯æŠŠ10.0.0.133(mysql01)ã€10.0.0.134(mysql02)ã€10.0.0.135(mysql03)æ­å»ºä¸ºABBï¼Œå³ä¸€ä¸»ä¸¤ä»ï¼Œå…¶ä¸­mysql01æ˜¯ä¸»åº“ï¼Œå…¶ä½™ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä»åº“ masteræ“ä½œ(mysql01 10.0.0.133) 3.3.1 ç¼–è¾‘/etc/my.cnfï¼ŒæŒ‡å®šserveridï¼Œå¹¶å¼€å¯binlog #æŒ‡å®šserveridï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šå¤§ server_id=1 #å¼€å¯binlogæ—¥å¿—ï¼Œä½ç½®åœ¨mysqlæ•°æ®ç›®å½•dataä¸‹ log_bin=binlog #å¼€å¯binlogæ—¥å¿—ç´¢å¼•ï¼Œä½ç½®åœ¨mysqlæ•°æ®ç›®å½•dataä¸‹ log_bin_index=binlog.index #å¼€å¯åŠåŒæ­¥å¤åˆ¶ log_slave_updates=1 é‡å¯mysql systemctl restart mysqld 3.3.2 åˆ›å»ºä¸“ç”¨å¤åˆ¶ç”¨æˆ·å’Œè®¾ç½®ç›‘æ§ç”¨æˆ· å…è®¸ä»slaveä¸Šè¿æ¥è¿‡æ¥çš„å¤åˆ¶ç”¨æˆ·ï¼Œ3å°mysqlæœåŠ¡å™¨éƒ½è¦åˆ›å»ºå¤åˆ¶ç”¨æˆ·å’Œç›‘æ§ç”¨æˆ·ï¼ï¼ï¼ âš ï¸å¤åˆ¶ç”¨æˆ·åç§°ä¸ºreplï¼Œå¦åœ¨åœ¨åç»­æ£€æµ‹mysqlé›†ç¾¤è¿æ¥æƒ…å†µä¼šæŠ¥é”™ï¼Œä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹å¤åˆ¶ç”¨æˆ· åˆ›å»ºä¸“ç”¨å¤åˆ¶ç”¨æˆ· mysql> grant replication slave on *.* to 'repl'@'10.0.0.%' identified by 'Bxb123.com'; Query OK, 0 rows affected, 1 warning (0.00 sec) è®¾ç½®ç›‘æ§ç”¨æˆ· âš ï¸æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œæˆæƒ mysql> grant all privileges on *.* to 'mha'@'10.0.0.%' identified by 'Bxb123.com'; Query OK, 0 rows affected, 1 warning (0.00 sec) mysql5.7ä¼šé»˜è®¤åŠ è½½validate_password æ¨¡å—ï¼Œæ˜¯æ¥æ§åˆ¶å¯†ç é•¿åº¦å’Œè§„åˆ™çš„ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œé¢å…³é—­è¯¥æ¨¡å—åŠ ä¸Švalidate_password = offï¼Œæˆ–è€…åœ¨mysqlå‘½ä»¤è¡Œæ‰§è¡Œset global validate_password_policy=0;æ¥ä¸´æ—¶å–æ¶ˆå¯†ç è§„åˆ™ ç¦ç”¨è‡ªåŠ¨åˆ é™¤relay logåŠŸèƒ½ set global relay_log_purge=0; æŸ¥çœ‹masterå½“å‰çš„binlogæ—¥å¿—åŠä½ç½®ä¿¡æ¯ mysql> show master status; slaveæ“ä½œ(mysql02ã€03 10.0.0.134ã€135) set global read_only=1; Query OK, 0 rows affected (0.00 sec) //ç¦ç”¨è‡ªåŠ¨åˆ é™¤relay log set global relay_log_purge=0; //æ‹‰å–binlog change master to master_host='10.0.0.133', \\ master_port=3306, \\ master_user='repl', \\ master_password='Bxb123.com', \\ master_log_file='binlog.000001', \\ master_log_pos=155; Query OK, 0 rows affected, 2 warnings (0.01 sec) ``` **å¯åŠ¨slaveå¹¶æŸ¥çœ‹slaveçŠ¶æ€** ```python //å¯åŠ¨slave mysql> start slave; Query OK, 0 rows affected (0.00 sec) //æŸ¥çœ‹slaveçŠ¶æ€ï¼ŒSQLå’ŒIOçº¿ç¨‹éƒ½ä¸ºYeså³ä¸ºæ­£ç¡® Slave_IO_Running: Yes Slave_SQL_Running: Yes #è¿™ä¸ªå€¼æ˜¯ä¸»ä»å»¶è¿Ÿï¼Œå³slaveè½åmasterçš„ç§’æ•°ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æŸ¥çœ‹ä¸»ä»æ˜¯å¦æ­£å¸¸çš„æ ‡å‡†å€¼ Seconds_Behind_Master: 0 ``` ### 3.3.5 éªŒè¯ä¸»ä»åŒæ­¥ **masteræ“ä½œ** ```python //åœ¨ä¸»åº“ä¸Šåˆ›å»ºä¸€ä¸ªæ•°æ®åº“db1 mysql> create database db1; Query OK, 1 row affected (0.00 sec) ``` **slaveæ“ä½œ** æŸ¥çœ‹ä¸»åº“ä¸Šåˆ›å»ºçš„æ•°æ®åº“æ˜¯å¦å·²ç»åŒæ­¥è¿‡æ¥ï¼ŒåŒæ­¥å®Œæˆå³ä¸ºæˆåŠŸ ```python mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | db1 | | mysql | | performance_schema | | sys | +--------------------+ 5 rows in set (0.00 sec) ``` ## 3.4 éƒ¨ç½²MHA node **æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ** ```python #ä¸‹è½½åŒ… wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58.tar.gz #ç¼–è¯‘å®‰è£… $ cd mha4mysql-node-0.58 $ ls AUTHORS bin COPYING debian inc lib Makefile.PL MANIFEST META.yml README rpm t $ perl Makefile.PL $ make && make install ``` **å®‰è£…å®Œæˆåæ‹·è´`mha4mysql-node-0.58/bin`ä¸‹çš„æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶åˆ°`/usr/local/bin`** > **apply_diff_relay_logs #è¯†åˆ«å·®å¼‚æ—¥å¿—å¹¶åº”ç”¨äºå…¶ä»–slave** > **save_binary_logs #ä¿å­˜å’Œå¤åˆ¶äºŒè¿›åˆ¶æ—¥å¿—** > **filter_mysqlbinlog #å»é™¤ä¸å¿…è¦çš„ROLLBACKäº‹ä»¶ï¼ˆMHAå·²ä¸å†ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼‰** > **purge_relay_logs #æ¸…é™¤ä¸­ç»§æ—¥å¿—** ## 3.5 éƒ¨ç½²MHA Manager manageræ“ä½œ(mha 10.0.0.130) 3.5.1 å¢åŠ epelæº wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo 3.5.2 å®‰è£…ä¾èµ–åŒ… yum -y install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker perl-ExtUtils-Embed perl-CPAN 3.5.3 å®‰è£…manager #ä¸‹è½½åŒ… wget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58.tar.gz #ç¼–è¯‘å®‰è£… $ cd cd mha4mysql-manager-0.58 $ ls AUTHORS bin COPYING debian inc lib Makefile.PL MANIFEST META.yml README rpm samples t tests $ perl Makefile.PL $ make && make install å®‰è£…å®Œæˆåä¼šæ‹·è´mha4mysql-manager-0.58/binä¸‹çš„æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶åˆ°/usr/local/bin masterha_manager #åœ¨ä¸»æœåŠ¡å™¨å…³é—­çš„æƒ…å†µä¸‹ï¼Œä¸»æœåŠ¡å™¨è‡ªåŠ¨ç›‘è§†å’Œè¿è¡Œæ•…éšœè½¬ç§» masterha_master_switch #æ‰‹åŠ¨æˆ–éäº¤äº’å¼ä¸»æ•…éšœè½¬ç§»æˆ–åœ¨çº¿ä¸»åº“ masterha_master_monitor #MHA Managerç›‘æ§ç¨‹åº masterha_stop #åœæ­¢MHA Manager masterha_check_repl #æ£€æŸ¥MySQLå¤åˆ¶è¿è¡ŒçŠ¶å†µ masterha_check_status #æ£€æŸ¥Manageræ˜¯å¦æ­£ç¡®ç›‘è§†MySQL master masterha_check_ssh #æ£€æŸ¥sshé…ç½® masterha_conf_host #ä¸€ä¸ªå¸®åŠ©ç¨‹åºè„šæœ¬ï¼Œç”¨äºä»é…ç½®æ–‡ä»¶æ·»åŠ /åˆ é™¤ä¸»æœºæ¡ç›® masterha_secondary_check #MHA ManageräºŒæ¬¡æ£€æŸ¥ 3.5.4 mysqlä¸»åº“èŠ‚ç‚¹é…ç½®eth0:0ç½‘å¡ï¼Œç”¨ä½œVIPï¼Œè¿™é‡Œè®¾ç½®ä¸º10.0.0.200 è¿™ä¸€æ­¥åœ¨mysqlä¸»åº“ä¸Š(10.0.0.133)æ‰§è¡Œ $ ifconfig eth0:0 10.0.0.200 $ ip a s eth0 eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:62:a8:c1 brd ff:ff:ff:ff:ff:ff inet 10.0.0.133/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet 10.0.0.200/8 brd 10.255.255.255 scope global eth0:0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fe62:a8c1/64 scope link valid_lft forever preferred_lft forever 3.5.5 ä½¿ç”¨è„šæœ¬ç®¡ç†vip âš ï¸éœ€è¦ä¿®æ”¹çš„æ˜¯VIPçš„åœ°å€å’Œç½‘å¡çš„åç§° VIPæ˜¯ç»‘å®šåœ¨ä¸»åº“ä¸Šçš„ï¼Œè¿™æ ·å½“ä¸»åº“å®•æœºåVIPæ‰ä¼šæ¼‚ç§»åˆ°æ–°ä¸»åº“ä¸Š cat > /usr/local/bin/master_ip_failover 'all'; use Getopt::Long; my ( $command, $ssh_user, $orig_master_host, $orig_master_ip, $orig_master_port, $new_master_host, $new_master_ip, $new_master_port ); #è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ eth1:$keyçš„æ„æ€æ˜¯ vipå¿…é¡»ç»‘å®šåœ¨ eth0:0ä¸Š my $vip = '10.0.0.200/24'; #æ­¤å¤„ä¸ºä½ è¦è®¾ç½®çš„è™šæ‹Ÿip my $key = '0'; my $ssh_start_vip = \"/usr//sbin/ifconfig eth0:$key $vip\"; #æ­¤å¤„æ”¹ä¸ºä½ çš„ç½‘å¡åç§° my $ssh_stop_vip = \"/usr/sbin/ifconfig eth0:$key down\"; GetOptions( 'command=s' => \\$command, 'ssh_user=s' => \\$ssh_user, 'orig_master_host=s' => \\$orig_master_host, 'orig_master_ip=s' => \\$orig_master_ip, 'orig_master_port=i' => \\$orig_master_port, 'new_master_host=s' => \\$new_master_host, 'new_master_ip=s' => \\$new_master_ip, 'new_master_port=i' => \\$new_master_port, ); exit &main(); sub main { print \"\\n\\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\\n\\n\"; if ( $command eq \"stop\" || $command eq \"stopssh\" ) { my $exit_code = 1; eval { print \"Disabling the VIP on old master: $orig_master_host \\n\"; &stop_vip(); $exit_code = 0; }; if ($@) { warn \"Got Error: $@\\n\"; exit $exit_code; } exit $exit_code; } elsif ( $command eq \"start\" ) { my $exit_code = 10; eval { print \"Enabling the VIP - $vip on the new master - $new_master_host \\n\"; &start_vip(); $exit_code = 0; }; if ($@) { warn $@; exit $exit_code; } exit $exit_code; } elsif ( $command eq \"status\" ) { print \"Checking the Status of the script.. OK \\n\"; exit 0; } else { &usage(); exit 1; } } sub start_vip() { `ssh $ssh_user\\@$new_master_host \\\" $ssh_start_vip \\\"`; } sub stop_vip() { return 0 unless ($ssh_user); `ssh $ssh_user\\@$orig_master_host \\\" $ssh_stop_vip \\\"`; } sub usage { print \"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\\n\"; } EOF ç»™è„šæœ¬èµ‹äºˆæ‰§è¡Œæƒé™ chmod +x /usr/local/bin/master_ip_failover 3.5.6 é…ç½®mhaé…ç½®æ–‡ä»¶ åˆ›å»ºmhaé…ç½®æ–‡ä»¶ç›®å½•åŠæ—¥å¿—ç›®å½• mkdir /etc/masterha mkdir -p /var/log/masterha/app1 ç¼–è¾‘mhaé…ç½®æ–‡ä»¶/etc/masterha/app1.conf mha4mysql-manager-0.58/samples/conf/app1.confæ˜¯mhaçš„é»˜è®¤é…ç½®æ–‡ä»¶ cat > /etc/masterha/app1.cnf ç¼–è¾‘å‘ç”Ÿåˆ‡æ¢åå‘é€æŠ¥è­¦çš„è„šæœ¬ï¼Œéœ€è¦è‡ªè¡Œé…ç½®é‚®ç®±è®¾ç½® cat > /etc/mha/send_report 'all'; use Mail::Sender; use Getopt::Long; #new_master_host and new_slave_hosts are set only when recovering master succeeded my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body ); my $smtp='smtpæœåŠ¡å™¨åœ°å€'; my $mail_from='å‘ä»¶äººé‚®ç®±'; my $mail_user='é‚®ç®±ç™»é™†ç”¨æˆ·å'; my $mail_pass='é‚®ç®±ç™»é™†å¯†ç '; my $mail_to=['æ”¶ä»¶äººåœ°å€']; GetOptions( 'orig_master_host=s' => \\$dead_master_host, 'new_master_host=s' => \\$new_master_host, 'new_slave_hosts=s' => \\$new_slave_hosts, 'subject=s' => \\$subject, 'body=s' => \\$body, ); mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body); sub mailToContacts { my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_; open my $DEBUG, \"> /tmp/monitormail.log\" or die \"Can't open the debug file:$!\\n\"; my $sender = new Mail::Sender { ctype => 'text/plain; charset=utf-8', encoding => 'utf-8', smtp => $smtp, from => $mail_from, auth => 'LOGIN', TLS_allowed => '0', authid => $user, authpwd => $passwd, to => $mail_to, subject => $subject, debug => $DEBUG }; $sender->MailMsg( { msg => $msg, debug => $DEBUG } ) or print $Mail::Sender::Error; return 1; } # Do whatever you want here exit 0; EOF 3.5.7 æµ‹è¯•MHA Manager 3.5.7.1 æµ‹è¯•sshè¿æ¥ $ masterha_check_ssh --conf=/etc/masterha/app1.cnf Sat Jun 6 10:27:32 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping. Sat Jun 6 10:27:32 2020 - [info] Reading application default configuration from /etc/mha/mha.conf.. Sat Jun 6 10:27:32 2020 - [info] Reading server configuration from /etc/mha/mha.conf.. Sat Jun 6 10:27:32 2020 - [info] Starting SSH connection tests.. Sat Jun 6 10:27:33 2020 - [debug] Sat Jun 6 10:27:32 2020 - [debug] Connecting via SSH from root@10.0.0.133(10.0.0.133:22) to root@10.0.0.134(10.0.0.134:22).. Sat Jun 6 10:27:32 2020 - [debug] ok. Sat Jun 6 10:27:32 2020 - [debug] Connecting via SSH from root@10.0.0.133(10.0.0.133:22) to root@10.0.0.135(10.0.0.135:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:33 2020 - [debug] Sat Jun 6 10:27:32 2020 - [debug] Connecting via SSH from root@10.0.0.134(10.0.0.134:22) to root@10.0.0.133(10.0.0.133:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:33 2020 - [debug] Connecting via SSH from root@10.0.0.134(10.0.0.134:22) to root@10.0.0.135(10.0.0.135:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:34 2020 - [debug] Sat Jun 6 10:27:33 2020 - [debug] Connecting via SSH from root@10.0.0.135(10.0.0.135:22) to root@10.0.0.133(10.0.0.133:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:33 2020 - [debug] Connecting via SSH from root@10.0.0.135(10.0.0.135:22) to root@10.0.0.134(10.0.0.134:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:34 2020 - [info] All SSH connection tests passed successfully. 3.5.7.2 æµ‹è¯•mysqlé›†ç¾¤è¿æ¥æƒ…å†µ $ masterha_check_repl --conf=/etc/masterha/app1.cnf Sat Jun 6 12:45:42 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping. Sat Jun 6 12:45:42 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf.. Sat Jun 6 12:45:42 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf.. Sat Jun 6 12:45:42 2020 - [info] MHA::MasterMonitor version 0.58. Sat Jun 6 12:45:43 2020 - [info] GTID failover mode = 0 Sat Jun 6 12:45:43 2020 - [info] Dead Servers: Sat Jun 6 12:45:43 2020 - [info] Alive Servers: Sat Jun 6 12:45:43 2020 - [info] 10.0.0.133(10.0.0.133:3306) Sat Jun 6 12:45:43 2020 - [info] 10.0.0.134(10.0.0.134:3306) Sat Jun 6 12:45:43 2020 - [info] 10.0.0.135(10.0.0.135:3306) Sat Jun 6 12:45:43 2020 - [info] Alive Slaves: Sat Jun 6 12:45:43 2020 - [info] 10.0.0.134(10.0.0.134:3306) Version=5.7.28-log (oldest major version between slaves) log-bin:enabled Sat Jun 6 12:45:43 2020 - [info] Replicating from 10.0.0.133(10.0.0.133:3306) Sat Jun 6 12:45:43 2020 - [info] Primary candidate for the new Master (candidate_master is set) Sat Jun 6 12:45:43 2020 - [info] 10.0.0.135(10.0.0.135:3306) Version=5.7.28-log (oldest major version between slaves) log-bin:enabled Sat Jun 6 12:45:43 2020 - [info] Replicating from 10.0.0.133(10.0.0.133:3306) Sat Jun 6 12:45:43 2020 - [info] Current Alive Master: 10.0.0.133(10.0.0.133:3306) Sat Jun 6 12:45:43 2020 - [info] Checking slave configurations.. Sat Jun 6 12:45:43 2020 - [info] read_only=1 is not set on slave 10.0.0.134(10.0.0.134:3306). Sat Jun 6 12:45:43 2020 - [warning] relay_log_purge=0 is not set on slave 10.0.0.134(10.0.0.134:3306). Sat Jun 6 12:45:43 2020 - [info] read_only=1 is not set on slave 10.0.0.135(10.0.0.135:3306). Sat Jun 6 12:45:43 2020 - [warning] relay_log_purge=0 is not set on slave 10.0.0.135(10.0.0.135:3306). Sat Jun 6 12:45:43 2020 - [info] Checking replication filtering settings.. Sat Jun 6 12:45:43 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Jun 6 12:45:43 2020 - [info] Replication filtering check ok. Sat Jun 6 12:45:43 2020 - [info] GTID (with auto-pos) is not supported Sat Jun 6 12:45:43 2020 - [info] Starting SSH connection tests.. Sat Jun 6 12:45:50 2020 - [info] All SSH connection tests passed successfully. Sat Jun 6 12:45:50 2020 - [info] Checking MHA Node version.. Sat Jun 6 12:45:51 2020 - [info] Version check ok. Sat Jun 6 12:45:51 2020 - [info] Checking SSH publickey authentication settings on the current master.. Sat Jun 6 12:45:51 2020 - [info] HealthCheck: SSH to 10.0.0.133 is reachable. Sat Jun 6 12:45:51 2020 - [info] Master MHA Node version is 0.58. Sat Jun 6 12:45:51 2020 - [info] Checking recovery script configurations on 10.0.0.133(10.0.0.133:3306).. Sat Jun 6 12:45:51 2020 - [info] Executing command: save_binary_logs --command=test --start_pos=4 --binlog_dir=/usr/local/mysql/data --output_file=/tmp/save_binary_logs_test --manager_version=0.58 --start_file=binlog.000001 Sat Jun 6 12:45:51 2020 - [info] Connecting to root@10.0.0.133(10.0.0.133:22).. Creating /tmp if not exists.. ok. Checking output directory is accessible or not.. ok. Binlog found at /usr/local/mysql/data, up to binlog.000001 Sat Jun 6 12:45:51 2020 - [info] Binlog setting check done. Sat Jun 6 12:45:51 2020 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers.. Sat Jun 6 12:45:51 2020 - [info] Executing command : apply_diff_relay_logs --command=test --slave_user='root' --slave_host=10.0.0.134 --slave_ip=10.0.0.134 --slave_port=3306 --workdir=/tmp --target_version=5.7.28-log --manager_version=0.58 --relay_log_info=/usr/local/mysql/data/relay-log.info --relay_dir=/usr/local/mysql/data/ --slave_pass=xxx Sat Jun 6 12:45:51 2020 - [info] Connecting to root@10.0.0.134(10.0.0.134:22).. Checking slave recovery environment settings.. Opening /usr/local/mysql/data/relay-log.info ... ok. Relay log found at /usr/local/mysql/data, up to mysql02-relay-bin.000002 Temporary relay log file is /usr/local/mysql/data/mysql02-relay-bin.000002 Checking if super_read_only is defined and turned on.. not present or turned off, ignoring. Testing mysql connection and privileges.. mysql: [Warning] Using a password on the command line interface can be insecure. done. Testing mysqlbinlog output.. done. Cleaning up test file(s).. done. Sat Jun 6 12:45:51 2020 - [info] Executing command : apply_diff_relay_logs --command=test --slave_user='root' --slave_host=10.0.0.135 --slave_ip=10.0.0.135 --slave_port=3306 --workdir=/tmp --target_version=5.7.28-log --manager_version=0.58 --relay_log_info=/usr/local/mysql/data/relay-log.info --relay_dir=/usr/local/mysql/data/ --slave_pass=xxx Sat Jun 6 12:45:51 2020 - [info] Connecting to root@10.0.0.135(10.0.0.135:22).. Checking slave recovery environment settings.. Opening /usr/local/mysql/data/relay-log.info ... ok. Relay log found at /usr/local/mysql/data, up to mysql03-relay-bin.000002 Temporary relay log file is /usr/local/mysql/data/mysql03-relay-bin.000002 Checking if super_read_only is defined and turned on.. not present or turned off, ignoring. Testing mysql connection and privileges.. mysql: [Warning] Using a password on the command line interface can be insecure. done. Testing mysqlbinlog output.. done. Cleaning up test file(s).. done. Sat Jun 6 12:45:52 2020 - [info] Slaves settings check done. Sat Jun 6 12:45:52 2020 - [info] 10.0.0.133(10.0.0.133:3306) (current master) +--10.0.0.134(10.0.0.134:3306) +--10.0.0.135(10.0.0.135:3306) Sat Jun 6 12:45:52 2020 - [info] Checking replication health on 10.0.0.134.. Sat Jun 6 12:45:52 2020 - [info] ok. Sat Jun 6 12:45:52 2020 - [info] Checking replication health on 10.0.0.135.. Sat Jun 6 12:45:52 2020 - [info] ok. Sat Jun 6 12:45:52 2020 - [info] Checking master_ip_failover_script status: Sat Jun 6 12:45:52 2020 - [info] /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=10.0.0.133 --orig_master_ip=10.0.0.133 --orig_master_port=3306 IN SCRIPT TEST====/usr/sbin/ifconfig eth1:1 down==/usr//sbin/ifconfig eth1:1 10.0.0.200/24=== Checking the Status of the script.. OK Sat Jun 6 12:45:52 2020 - [info] OK. Sat Jun 6 12:45:52 2020 - [warning] shutdown_script is not defined. Sat Jun 6 12:45:52 2020 - [info] Got exit code 0 (Not master dead). MySQL Replication Health is OK. 3.5.8 å¯åŠ¨mha å¯åŠ¨mha nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 & å¯åŠ¨å‚æ•°è¯´æ˜ --remove_dead_master_conf è¯¥å‚æ•°ä»£è¡¨å½“å‘ç”Ÿä¸»ä»åˆ‡æ¢åï¼Œè€çš„ä¸»åº“çš„ipå°†ä¼šä»é…ç½®æ–‡ä»¶ä¸­ç§»é™¤ã€‚ --manger_log æ—¥å¿—å­˜æ”¾ä½ç½® --ignore_last_failover åœ¨ç¼ºçœæƒ…å†µä¸‹ï¼Œå¦‚æœMHAæ£€æµ‹åˆ°è¿ç»­å‘ç”Ÿå®•æœºï¼Œä¸”ä¸¤æ¬¡å®•æœºé—´éš”ä¸è¶³8å°æ—¶çš„è¯ï¼Œåˆ™ä¸ä¼šè¿›è¡ŒFailoverï¼Œä¹‹æ‰€ä»¥è¿™æ ·é™åˆ¶æ˜¯ä¸ºäº†é¿å…ping-pongæ•ˆåº”ã€‚è¯¥å‚æ•°ä»£è¡¨å¿½ç•¥ä¸Šæ¬¡MHAè§¦å‘åˆ‡æ¢äº§ç”Ÿçš„æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒMHAå‘ç”Ÿåˆ‡æ¢åä¼šåœ¨æ—¥å¿—ç›®å½•ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æˆ‘è®¾ç½®çš„/dataäº§ç”Ÿapp1.failover.completeæ–‡ä»¶ï¼Œä¸‹æ¬¡å†æ¬¡åˆ‡æ¢çš„æ—¶å€™å¦‚æœå‘ç°è¯¥ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶å°†ä¸å…è®¸è§¦å‘åˆ‡æ¢ï¼Œé™¤éåœ¨ç¬¬ä¸€æ¬¡åˆ‡æ¢åæ”¶åˆ°åˆ é™¤è¯¥æ–‡ä»¶ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œè®¾ç½®ä¸º--ignore_last_failover æµ‹è¯•mhaçŠ¶æ€ $ masterha_check_status --conf=/etc/masterha/app1.cnf app1 (pid:2262) is running(0:PING_OK), master:10.0.0.133 åœæ­¢mha $ masterha_stop --conf=/etc/masterha/app1.cnf Stopped app1 successfully. [1]+ Exit 1 nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 é‡å¯mha masterha_stop --conf=/etc/masterha/app1.cnf && nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 & åˆ°æ­¤ï¼ŒMHAéƒ¨ç½²å®Œæˆï¼ 3.6 æµ‹è¯•MHA 3.6.1 æ‰‹åŠ¨å…³é—­ä¸»åº“ï¼Œæ¨¡æ‹Ÿå®•æœº 10.0.0.133 mysql01æ“ä½œ systemctl stop mysqld 3.6.2 éªŒè¯slave1ï¼Œå³10.0.0.134 å› ä¸ºåœ¨mhaé…ç½®æ–‡ä»¶/etc/masterha/app1.confä¸­å®šä¹‰äº†å‚æ•°candidate_master=1ï¼Œå³è®¾ç½®ä¸ºå€™é€‰masterï¼Œå¦‚æœè®¾ç½®è¯¥å‚æ•°ä»¥åï¼Œå‘ç”Ÿä¸»ä»åˆ‡æ¢ä»¥åå°†ä¼šå°†æ­¤ä»åº“æå‡ä¸ºä¸»åº“ï¼Œå³ä½¿è¿™ä¸ªä¸»åº“ä¸æ˜¯é›†ç¾¤ä¸­äº‹ä»¶æœ€æ–°çš„slaveï¼Œå› æ­¤ï¼Œå½“ä¸»åº“æŒ‚æ‰æ—¶ï¼Œslave1 10.0.0.134ä¼šæˆä¸ºæ–°çš„ä¸»åº“ 10.0.0.135 mysql02æ“ä½œ å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸»åº“10.0.0.133å®•æœºåï¼Œ10.0.0.134æˆä¸ºäº†æ–°çš„ä¸»åº“ $ show slave status\\G *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 10.0.0.134 Master_User: repl Master_Port: 3306 Connect_Retry: 60 Master_Log_File: binlog.000002 Read_Master_Log_Pos: 1331 Relay_Log_File: mysql03-relay-bin.000002 Relay_Log_Pos: 317 Relay_Master_Log_File: binlog.000002 Slave_IO_Running: Yes Slave_SQL_Running: Yes ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ éªŒè¯VIPæ˜¯å¦å·²ç»æ¼‚ç§» åœ¨æ–°ä¸»åº“ä¸Šèƒ½å¤Ÿçœ‹åˆ°VIPå³ä¸ºæˆåŠŸ $ ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:09:c2:b1 brd ff:ff:ff:ff:ff:ff inet 10.0.0.134/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet 10.0.0.200/24 brd 10.0.0.255 scope global secondary eth0:0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fe09:c2b1/64 scope link valid_lft forever preferred_lft forever å››ã€MHAå¸¸ç”¨å‘½ä»¤æ€»ç»“ 1ã€æ£€æŸ¥mhaçš„sshå…å¯†ç™»å½•çŠ¶æ€ masterha_check_ssh --conf=/etc/masterha/app1.cnf 2ã€æ£€æŸ¥mhaçš„è¿è¡ŒçŠ¶æ€ masterha_check_status --conf=/etc/masterha/app1.cnf 3ã€æ£€æŸ¥ä¸»å¤‡åº“çš„å¤åˆ¶æƒ…å†µ masterha_check_repl --conf=/etc/masterha/app1.cnf 4ã€åœæ­¢mha masterha_stop --conf=/etc/masterha/app1.cnf 5ã€å¯åŠ¨mha nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 & 6ã€mhaæ‰‹åŠ¨åˆ‡æ¢ä¸»åº“ masterha_master_switch --conf=/etc/masterha/app1.cnf --master_state=alive --new_master_host=10.0.0.135 --new_master_port=3106 --orig_master_is_new_slave 7ã€mhaé‡æ–°ç»‘å®šæ•°æ®åº“å®ä¾‹ master_ip_failover --command=status --ssh_user=root --orig_master_host=10.0.0.133 --orig_master_ip=10.0.0.200 --orig_master_port=3306 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlè¿›é˜¶/7.MHAåŸºäºGTIDä¸»ä»å¤åˆ¶é«˜å¯ç”¨.html":{"url":"db/mysql/mysqlè¿›é˜¶/7.MHAåŸºäºGTIDä¸»ä»å¤åˆ¶é«˜å¯ç”¨.html","title":"MHAåŸºäºGTIDä¸»ä»å¤åˆ¶é«˜å¯ç”¨","keywords":"","body":"MHAåŸºäºGTIDä¸»ä»å¤åˆ¶é«˜å¯ç”¨ MHA gIthubåœ°å€ MHA github wikiåœ°å€ ä¸€ã€MHAç®€ä»‹ MHAé€šå¸¸åœ¨10åˆ°30ç§’å†…ä»¥æœ€å°‘çš„åœæœºæ—¶é—´æ‰§è¡Œè‡ªåŠ¨çš„ä¸»æ•…éšœè½¬ç§»å’Œä»å‡çº§ã€‚MHAå¯ä»¥é˜²æ­¢å¤åˆ¶ä¸€è‡´æ€§é—®é¢˜ï¼Œå¹¶èŠ‚çœäº†å¿…é¡»è´­ä¹°å…¶ä»–æœåŠ¡å™¨çš„è´¹ç”¨ã€‚æ‰€æœ‰è¿™äº›éƒ½å…·æœ‰é›¶æ€§èƒ½ä¸‹é™ï¼Œæ— å¤æ‚æ€§ï¼ˆæ˜“äºå®‰è£…ï¼‰å¹¶ä¸”æ— éœ€æ›´æ”¹ç°æœ‰éƒ¨ç½²çš„æƒ…å†µã€‚ MHAè¿˜æä¾›äº†è®¡åˆ’çš„åœ¨çº¿ä¸»è®¾å¤‡åˆ‡æ¢ï¼Œå¯ä»¥åœ¨åœæœºï¼ˆä»…é˜»æ­¢å†™å…¥ï¼‰çš„å‡ ç§’é’Ÿï¼ˆ0.5-2ç§’ï¼‰å†…å°†å½“å‰æ­£åœ¨è¿è¡Œçš„ä¸»è®¾å¤‡å®‰å…¨åœ°æ›´æ”¹ä¸ºæ–°çš„ä¸»è®¾å¤‡ã€‚ MHAæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼Œåœ¨éœ€è¦é«˜å¯ç”¨æ€§ï¼Œæ•°æ®å®Œæ•´æ€§å’Œè¿‘ä¹ä¸é—´æ–­çš„ä¸»ç»´æŠ¤çš„è®¸å¤šéƒ¨ç½²ä¸­å¾ˆæœ‰ç”¨ã€‚ è‡ªåŠ¨åŒ–çš„ä¸»ç«™ç›‘è§†å’Œæ•…éšœè½¬ç§» MHAå¯ä»¥ç›‘è§†ç°æœ‰å¤åˆ¶ç¯å¢ƒä¸­çš„MySQLä¸»æœåŠ¡å™¨ï¼Œå¹¶åœ¨æ£€æµ‹åˆ°ä¸»æœåŠ¡å™¨æ•…éšœæ—¶æ‰§è¡Œè‡ªåŠ¨ä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§»ã€‚MHAé€šè¿‡è¯†åˆ«æ¥è‡ªæœ€æ–°ä»ç«™çš„å·®åˆ†ä¸­ç»§æ—¥å¿—äº‹ä»¶å¹¶å°†å…¶åº”ç”¨äºæ‰€æœ‰å…¶ä»–ä»ç«™ï¼ŒåŒ…æ‹¬é‚£äº›å°šæœªæ”¶åˆ°æœ€æ–°ä¸­ç»§æ—¥å¿—äº‹ä»¶çš„ä»ç«™ï¼Œæ¥ä¿è¯æ‰€æœ‰ä»ç«™çš„ä¸€è‡´æ€§ã€‚MHAé€šå¸¸å¯ä»¥åœ¨å‡ ç§’é’Ÿå†…æ‰§è¡Œæ•…éšœè½¬ç§»ï¼š9åˆ°12ç§’é’Ÿç”¨äºæ£€æµ‹ä¸»è®¾å¤‡æ•…éšœï¼Œå¯é€‰åœ°7åˆ°10ç§’é’Ÿç”¨äºå…³é—­ä¸»è®¡ç®—æœºç”µæºï¼Œä»¥é¿å…è„‘éƒ¨åˆ†è£‚ï¼›å‡ ç§’é’Ÿçš„æ—¶é—´å°†å·®åˆ†ä¸­ç»§æ—¥å¿—åº”ç”¨äºæ–°çš„ä¸»è®¾å¤‡ã€‚æ€»åœæœºæ—¶é—´é€šå¸¸ä¸º10-30ç§’ã€‚å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­å°†ç‰¹å®šä»ç«™æŒ‡å®šä¸ºå€™é€‰ä¸»ç«™ï¼ˆè®¾ç½®ä¼˜å…ˆçº§ï¼‰ã€‚ç”±äºMHAç»´æŠ¤ä»ç«™ä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œä»»ä½•å¥´éš¶éƒ½å¯ä»¥æ™‹å‡ä¸ºæ–°ä¸»äººã€‚é€šå¸¸ä¸ä¼šå¯¼è‡´çªç„¶çš„å¤åˆ¶å¤±è´¥çš„ä¸€è‡´æ€§é—®é¢˜å°†ä¸ä¼šå‘ç”Ÿã€‚ äº¤äº’å¼ï¼ˆæ‰‹åŠ¨å¯åŠ¨ï¼‰ä¸»æ•…éšœè½¬ç§» å¯ä»¥å°†MHAé…ç½®ä¸ºæ‰‹åŠ¨å¯åŠ¨ï¼ˆéè‡ªåŠ¨ï¼‰ï¼Œäº¤äº’å¼æ•…éšœè½¬ç§»ï¼Œè€Œæ— éœ€ç›‘è§†ä¸»æœåŠ¡å™¨ã€‚ éäº¤äº’å¼ä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§» è¿˜æ”¯æŒä¸ç›‘è§†ä¸»æœåŠ¡å™¨çš„éäº¤äº’å¼è‡ªåŠ¨ä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§»ã€‚å½“å·²ç»ä½¿ç”¨MySQLä¸»è½¯ä»¶ç›‘è§†æ—¶ï¼Œæ­¤åŠŸèƒ½ç‰¹åˆ«æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Pacemakerï¼ˆHeartbeatï¼‰æ£€æµ‹ä¸»æœåŠ¡å™¨æ•…éšœå’Œè™šæ‹ŸIPåœ°å€æ¥ç®¡ï¼Œè€Œä½¿ç”¨MHAè¿›è¡Œä¸»æœåŠ¡å™¨æ•…éšœè½¬ç§»å’Œä»å±å‡çº§ã€‚ åœ¨çº¿å°†ä¸»æœåŠ¡å™¨åˆ‡æ¢åˆ°å…¶ä»–ä¸»æœº é€šå¸¸æœ‰å¿…è¦å°†ç°æœ‰çš„ä¸»æœåŠ¡å™¨è¿ç§»åˆ°å¦ä¸€å°è®¡ç®—æœºä¸Šï¼Œä¾‹å¦‚å½“å‰ä¸»æœåŠ¡å™¨å­˜åœ¨ç¡¬ä»¶RAIDæ§åˆ¶å™¨æˆ–RAMé—®é¢˜ï¼Œæˆ–è€…è¦ç”¨é€Ÿåº¦æ›´å¿«çš„è®¡ç®—æœºæ›¿æ¢å®ƒç­‰æ—¶ï¼Œè¿™ä¸æ˜¯ä¸»æœåŠ¡å™¨å´©æºƒï¼Œä½†éœ€è¦å®šæœŸè¿›è¡Œä¸»ç»´æŠ¤ã€‚è®¡åˆ’çš„ä¸»æœºç»´æŠ¤åº”å°½å¿«å®Œæˆï¼Œå› ä¸ºè¿™ä¼šå¯¼è‡´éƒ¨åˆ†åœæœºï¼ˆç¦ç”¨ä¸»æœºå†™å…¥ï¼‰ã€‚å¦ä¸€æ–¹é¢ï¼Œæ‚¨åº”è¯¥éå¸¸ä»”ç»†åœ°é˜»æ­¢/æ€æ­»å½“å‰æ­£åœ¨è¿è¡Œçš„ä¼šè¯ï¼Œå› ä¸ºä¸åŒçš„masterä¹‹é—´å¯èƒ½ä¼šå‘ç”Ÿä¸€è‡´æ€§é—®é¢˜ï¼ˆå³â€œæ›´æ–°master1ï¼Œæ›´æ–°master 2ï¼Œæäº¤master1ï¼Œåœ¨æäº¤master 2æ—¶å‡ºé”™â€ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼‰ã€‚å¿«é€Ÿä¸»å¼€å…³å’Œå¹³ç¨³é˜»æ­¢å†™å…¥éƒ½æ˜¯å¿…éœ€çš„ã€‚ MHAåœ¨å†™å…¥å™¨é˜»å¡åçš„0.5-2ç§’å†…æä¾›æ­£å¸¸çš„ä¸»è®¾å¤‡åˆ‡æ¢ã€‚é€šå¸¸å¯ä»¥æ¥å—0.5-2ç§’çš„å†™å…¥å™¨åœæœºæ—¶é—´ï¼Œå› æ­¤å³ä½¿ä¸åˆ†é…è®¡åˆ’çš„ç»´æŠ¤æ—¶æ®µï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ‡æ¢ä¸»æœºã€‚å‡çº§åˆ°æ›´é«˜ç‰ˆæœ¬ï¼Œæ›´å¿«çš„è®¡ç®—æœºç­‰æ“ä½œå˜å¾—æ›´åŠ å®¹æ˜“ã€‚ äºŒã€MHAæ¶æ„ MHAæ¶æ„å®˜æ–¹æ–‡æ¡£ æ­£å¸¸å·¥ä½œæ—¶æ¶æ„ ä¸»åº“downæœºæ—¶æ¶æ„ è¯¥è½¯ä»¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šMHA Managerï¼ˆç®¡ç†èŠ‚ç‚¹ï¼‰å’ŒMHA Nodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰ã€‚ MHA Managerå¯ä»¥å•ç‹¬éƒ¨ç½²åœ¨ä¸€å°ç‹¬ç«‹çš„æœºå™¨ä¸Šç®¡ç†å¤šä¸ªmaster-slaveé›†ç¾¤ï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨ä¸€å°slaveèŠ‚ç‚¹ä¸Šã€‚ MHA Nodeè¿è¡Œåœ¨æ¯å°MySQLæœåŠ¡å™¨ä¸Šï¼ŒMHA Managerä¼šå®šæ—¶æ¢æµ‹é›†ç¾¤ä¸­çš„masterèŠ‚ç‚¹ï¼Œå½“masterå‡ºç°æ•…éšœæ—¶ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨å°†æœ€æ–°æ•°æ®çš„slaveæå‡ä¸ºæ–°çš„masterï¼Œç„¶åå°†æ‰€æœ‰å…¶ä»–çš„slaveé‡æ–°æŒ‡å‘æ–°çš„masterã€‚æ•´ä¸ªæ•…éšœè½¬ç§»è¿‡ç¨‹å¯¹åº”ç”¨ç¨‹åºå®Œå…¨é€æ˜ã€‚ åœ¨MHAè‡ªåŠ¨æ•…éšœåˆ‡æ¢è¿‡ç¨‹ä¸­ï¼ŒMHAè¯•å›¾ä»å®•æœºçš„ä¸»æœåŠ¡å™¨ä¸Šä¿å­˜äºŒè¿›åˆ¶æ—¥å¿—ï¼Œæœ€å¤§ç¨‹åº¦çš„ä¿è¯æ•°æ®çš„ä¸ä¸¢å¤±(é…åˆmysqlåŠåŒæ­¥å¤åˆ¶æ•ˆæœæ›´ä½³)ï¼Œä½†è¿™å¹¶ä¸æ€»æ˜¯å¯è¡Œçš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸»æœåŠ¡å™¨ç¡¬ä»¶æ•…éšœæˆ–æ— æ³•é€šè¿‡sshè®¿é—®ï¼ŒMHAæ²¡æ³•ä¿å­˜äºŒè¿›åˆ¶æ—¥å¿—ï¼Œåªè¿›è¡Œæ•…éšœè½¬ç§»è€Œä¸¢å¤±äº†æœ€æ–°çš„æ•°æ®ã€‚ä½¿ç”¨MySQL 5.5çš„åŠåŒæ­¥å¤åˆ¶ï¼Œå¯ä»¥å¤§å¤§é™ä½æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚MHAå¯ä»¥ä¸åŠåŒæ­¥å¤åˆ¶ç»“åˆèµ·æ¥ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªslaveå·²ç»æ”¶åˆ°äº†æœ€æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ŒMHAå¯ä»¥å°†æœ€æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—åº”ç”¨äºå…¶ä»–æ‰€æœ‰çš„slaveæœåŠ¡å™¨ä¸Šï¼Œå› æ­¤å¯ä»¥ä¿è¯æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ã€‚ æ³¨æ„ï¼šç›®å‰MHAä¸»è¦æ”¯æŒä¸€ä¸»å¤šä»çš„æ¶æ„ï¼Œè¦æ­å»ºMHA,è¦æ±‚ä¸€ä¸ªå¤åˆ¶é›†ç¾¤ä¸­å¿…é¡»æœ€å°‘æœ‰ä¸‰å°æ•°æ®åº“æœåŠ¡å™¨ï¼Œä¸€ä¸»äºŒä»ï¼Œå³ä¸€å°å……å½“masterï¼Œä¸€å°å……å½“å¤‡ç”¨masterï¼Œå¦å¤–ä¸€å°å……å½“ä»åº“ï¼Œå› ä¸ºè‡³å°‘éœ€è¦ä¸‰å°æœåŠ¡å™¨ã€‚ å·¥ä½œè¿‡ç¨‹ï¼šmanagerèŠ‚ç‚¹å®šæ—¶æ£€æµ‹å¤åˆ¶é›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªnode,å¦‚æœmasterå®•æœºä¼šé€‰å‡ºæ•°æ®ä¸masteræœ€æ¥è¿‘çš„ä¸€å°slaveæ¥ä½œä¸ºæ–°masterï¼Œå»åˆ°æ—§masterä¸­æ‹·è´binlogåˆ°æ–°masterä¸­å¹¶åº”ç”¨binlogä»¥ä¿è¯æ–°masterä¸æ—§masteræ•°æ®ä¸€è‡´ï¼Œç„¶åå°†å‰©ä½™çš„slaveé‡æ–°changer master to,å°†slaveçš„ä¸»åˆ‡æ¢ä¸ºæ–°master ä¸‰ã€éƒ¨ç½²è¿‡ç¨‹ å®éªŒç¯å¢ƒ è§’è‰² IP ä¸»æœºå ç³»ç»Ÿ æœºå™¨é…ç½® mysqlç‰ˆæœ¬ manager 10.0.0.130 mha centos7.8 2c4g 5.7.28 mysql-master 10.0.0.133 mysql01 centos7.8 2c4g 5.7.28 mysql-slave1 10.0.0.134 mysql02 centos7.8 2c4g 5.7.28 mysql-slave2 10.0.0.135 mysql03 centos7.8 2c4g 5.7.28 3.1 ä¸‹è½½å®‰è£…åŒ… MHA manager0.58ä¸‹è½½åœ°å€ MHA node0.58ä¸‹è½½åœ°å€ MHA 0.56 ä¸‹è½½åœ°å€ Managerå·¥å…·åŒ…ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå·¥å…·ï¼š åç§° å«ä¹‰ masterha_check_ssh æ£€æŸ¥MHAçš„SSHé…ç½®çŠ¶å†µ masterha_check_repl æ£€æŸ¥MySQLå¤åˆ¶çŠ¶å†µ masterha_manger å¯åŠ¨MHA masterha_check_status æ£€æµ‹å½“å‰MHAè¿è¡ŒçŠ¶æ€ masterha_master_monitor æ£€æµ‹masteræ˜¯å¦å®•æœº masterha_master_switch æ§åˆ¶æ•…éšœè½¬ç§»ï¼ˆè‡ªåŠ¨æˆ–è€…æ‰‹åŠ¨ï¼‰ masterha_conf_host æ·»åŠ æˆ–åˆ é™¤é…ç½®çš„serverä¿¡æ¯ Nodeå·¥å…·åŒ…ï¼ˆè¿™äº›å·¥å…·é€šå¸¸ç”±MHA Managerçš„è„šæœ¬è§¦å‘ï¼Œæ— éœ€äººä¸ºæ“ä½œï¼‰ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå·¥å…·ï¼š åç§° å«ä¹‰ save_binary_logs ä¿å­˜å’Œå¤åˆ¶masterçš„äºŒè¿›åˆ¶æ—¥å¿— apply_diff_relay_logs è¯†åˆ«å·®å¼‚çš„ä¸­ç»§æ—¥å¿—äº‹ä»¶å¹¶å°†å…¶å·®å¼‚çš„äº‹ä»¶åº”ç”¨äºå…¶ä»–çš„slave filter_mysqlbinlog å»é™¤ä¸å¿…è¦çš„ROLLBACKäº‹ä»¶ï¼ˆMHAå·²ä¸å†ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼‰ purge_relay_logs æ¸…é™¤ä¸­ç»§æ—¥å¿—ï¼ˆä¸ä¼šé˜»å¡SQLçº¿ç¨‹ï¼‰ 3.2 æ‰€æœ‰æœºå™¨åšç›¸äº’å…å¯†é’¥é…ç½® âš ï¸å¤åˆ¶é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¯èƒ½æˆä¸ºmasterï¼Œéƒ½å¾—å¼€å¯binlogå’Œsshå¯†é’¥è®¤è¯ï¼Œå› ä¸ºå½“æ—§masterå®•æœºåï¼Œmhaè¦æ‹·è´binlogåˆ°æ‰€æœ‰nodeèŠ‚ç‚¹ä¸Šï¼Œè€Œä¸”æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰å¯èƒ½æˆä¸ºmasterï¼Œæ•…æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦å½¼æ­¤å¯†é’¥è®¤è¯ lowBè„šæœ¬è¿è¡Œä¸€ä¸‹ #!/bin/bash file_path=/root file_name=host.txt file=$file_path/$file_name user=root pwd=1 ssh_file=~/.ssh/id_rsa yum -y install expect &> /dev/null #ç”Ÿæˆå¯†é’¥ [ -f \"$ssh_file\" ] || ssh-keygen -q -N \"\" -f ~/.ssh/id_rsa read -p \"è¯·è¾“å…¥å¼€å§‹æ•°å€¼: \" start_num read -p \"è¯·è¾“å…¥ç»“æŸæ•°å€¼: \" end_num read -p \"è¯·è¾“å…¥ç½‘æ®µ(ç±»ä¼¼æ ¼å¼ï¼š10.0.0.)ï¼š\" sub_net seq $start_num $end_num >$file #åœ¨æ–‡ä»¶å¼€å¤´åŠ ä¸Šç½‘æ®µï¼Œåœ¨æ–‡ä»¶æœ«å°¾åŠ ä¸Šç”¨æˆ·åå’Œå¯†ç  sed -i 's/^/'$sub_net'/g' $file sed -i 's/$/ '$user' '$pwd'/g' $file echo -e \"æ‰§è¡ŒæˆåŠŸï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:\\n`cat $file`\" while read line;do ip=`echo $line | awk '{print $1}'` username=`echo $line | awk '{print $2}'` password=`echo $line | awk '{print $3}'` expect 3.3 mysqlä¸»ä»é…ç½®-GTID è¿™é‡Œæ˜¯æŠŠ10.0.0.133(mysql01)ã€10.0.0.134(mysql02)ã€10.0.0.135(mysql03)æ­å»ºä¸ºABBï¼Œå³ä¸€ä¸»ä¸¤ä»ï¼Œå…¶ä¸­mysql01æ˜¯ä¸»åº“ï¼Œå…¶ä½™ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä»åº“ masteræ“ä½œ(mysql01 10.0.0.133) 3.3.1 ç¼–è¾‘/etc/my.cnfï¼ŒæŒ‡å®šserveridï¼Œå¹¶å¼€å¯binlog #æŒ‡å®šserver id server_id=1 #å¼€å¯binlogæ—¥å¿—ï¼Œä½ç½®åœ¨mysqlæ•°æ®ç›®å½•dataä¸‹ log_bin=binlog #å¼€å¯binlogæ—¥å¿—ç´¢å¼•ï¼Œä½ç½®åœ¨mysqlæ•°æ®ç›®å½•dataä¸‹ log_bin_index=binlog.index #å¼€å¯GTID gtid_mode=ON #å¼€å¯GTIDçš„ä¸€äº›å®‰å…¨é™åˆ¶ æ‰§è¡ŒGTIDä¸€è‡´ enforce_gtid_consistency #é€šå¸¸æƒ…å†µï¼Œä»æœåŠ¡å™¨ä»ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ›´æ–°ä¸è®°å…¥å®ƒçš„äºŒè¿›åˆ¶æ—¥å¿—ã€‚è¯¥é€‰é¡¹å‘Šè¯‰ä»æœåŠ¡å™¨å°†å…¶SQLçº¿ç¨‹æ‰§è¡Œçš„æ›´æ–°è®°å…¥åˆ°ä»æœåŠ¡å™¨è‡ªå·±çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼Œmysql-5.6å¿…é¡»åŠ è¿™ä¸ªå‚æ•°ï¼Œ5.7å¯ä»¥ä¸åŠ  log-slave-updates #ç¦æ­¢mysqlåŸŸåè§£æ skip_name_resolve é‡å¯mysql systemctl restart mysqld æŸ¥çœ‹gitå¼€å¯æƒ…å†µï¼Œenforce_gtid_consistencyä¸gtid_modeéƒ½ä¸ºonå³ä¸ºæ­£ç¡® mysql> show global variables like '%gtid%'; +----------------------------------+-------+ | Variable_name | Value | +----------------------------------+-------+ | binlog_gtid_simple_recovery | ON | | enforce_gtid_consistency | ON | | gtid_executed | | | gtid_executed_compression_period | 1000 | | gtid_mode | ON | | gtid_owned | | | gtid_purged | | | session_track_gtids | OFF | +----------------------------------+-------+ 8 rows in set (0.00 sec) 3.3.2 åˆ›å»ºä¸“ç”¨å¤åˆ¶ç”¨æˆ·å’Œè®¾ç½®ç›‘æ§ç”¨æˆ· å…è®¸ä»slaveä¸Šè¿æ¥è¿‡æ¥çš„å¤åˆ¶ç”¨æˆ·ï¼Œ3å°mysqlæœåŠ¡å™¨éƒ½è¦åˆ›å»ºå¤åˆ¶ç”¨æˆ·å’Œç›‘æ§ç”¨æˆ·ï¼ï¼ï¼ âš ï¸å¤åˆ¶ç”¨æˆ·åç§°ä¸ºreplï¼Œä¹Ÿå¯ä»¥åœ¨MHAé…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹å¤åˆ¶ç”¨æˆ· åˆ›å»ºä¸“ç”¨å¤åˆ¶ç”¨æˆ· mysql> grant replication slave on *.* to 'repl'@'10.0.0.%' identified by 'Bxb123.com'; Query OK, 0 rows affected, 1 warning (0.00 sec) è®¾ç½®ç›‘æ§ç”¨æˆ· âš ï¸æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œæˆæƒ mysql> grant all privileges on *.* to 'mha'@'10.0.0.%' identified by 'Bxb123.com'; Query OK, 0 rows affected, 1 warning (0.00 sec) mysql5.7ä¼šé»˜è®¤åŠ è½½validate_password æ¨¡å—ï¼Œæ˜¯æ¥æ§åˆ¶å¯†ç é•¿åº¦å’Œè§„åˆ™çš„ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œé¢å…³é—­è¯¥æ¨¡å—åŠ ä¸Švalidate_password = offï¼Œæˆ–è€…åœ¨mysqlå‘½ä»¤è¡Œæ‰§è¡Œset global validate_password_policy=0;æ¥ä¸´æ—¶å–æ¶ˆå¯†ç è§„åˆ™ ç¦ç”¨è‡ªåŠ¨åˆ é™¤relay logåŠŸèƒ½ set global relay_log_purge=0; slaveæ“ä½œ(mysql02ã€03 10.0.0.134ã€135) show variables like '%gtid%'; +----------------------------------+-----------+ | Variable_name | Value | +----------------------------------+-----------+ | binlog_gtid_simple_recovery | ON | | enforce_gtid_consistency | ON | | gtid_executed_compression_period | 1000 | | gtid_mode | ON | | gtid_next | AUTOMATIC | | gtid_owned | | | gtid_purged | | | session_track_gtids | OFF | +----------------------------------+-----------+ 8 rows in set (0.00 sec) ``` ### 3.3.4 ä»åº“æ‹‰å– ```python //è®¾ç½®åªè¯»ï¼Œä¸è¦åœ¨é…ç½®æ–‡ä»¶é‡Œå†™ mysql> set global read_only=1; Query OK, 0 rows affected (0.00 sec) //ç¦ç”¨è‡ªåŠ¨åˆ é™¤relay log set global relay_log_purge=0; //æ‹‰å– change master to \\ master_host='10.0.0.133', \\ master_user='repl', \\ master_password='Bxb123.com', \\ master_auto_position=1; Query OK, 0 rows affected, 2 warnings (0.00 sec) ``` **å¯åŠ¨slaveå¹¶æŸ¥çœ‹slaveçŠ¶æ€** ```python //å¯åŠ¨slave mysql> start slave; Query OK, 0 rows affected (0.00 sec) //æŸ¥çœ‹slaveçŠ¶æ€ï¼ŒSQLå’ŒIOçº¿ç¨‹éƒ½ä¸ºYeså¹¶ä¸”Auto_Positionä¸º1å³ä¸ºæ­£ç¡® Slave_IO_Running: Yes Slave_SQL_Running: Yes Auto_Position: 1 #è¿™ä¸ªå€¼æ˜¯ä¸»ä»å»¶è¿Ÿï¼Œå³slaveè½åmasterçš„ç§’æ•°ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æŸ¥çœ‹ä¸»ä»æ˜¯å¦æ­£å¸¸çš„æ ‡å‡†å€¼ Seconds_Behind_Master: 0 ``` ### 3.3.5 éªŒè¯ä¸»ä»åŒæ­¥ **masteræ“ä½œ** ```python //åœ¨ä¸»åº“ä¸Šåˆ›å»ºä¸€ä¸ªæ•°æ®åº“db1 mysql> create database db1; Query OK, 1 row affected (0.00 sec) ``` **slaveæ“ä½œ** æŸ¥çœ‹ä¸»åº“ä¸Šåˆ›å»ºçš„æ•°æ®åº“æ˜¯å¦å·²ç»åŒæ­¥è¿‡æ¥ï¼ŒåŒæ­¥å®Œæˆå³ä¸ºæˆåŠŸ ```python mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | db1 | | mysql | | performance_schema | | sys | +--------------------+ 5 rows in set (0.00 sec) ``` ## 3.4 éƒ¨ç½²MHA node **æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ** ```python #ä¸‹è½½åŒ… wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58.tar.gz #ç¼–è¯‘å®‰è£… $ cd mha4mysql-node-0.58 $ ls AUTHORS bin COPYING debian inc lib Makefile.PL MANIFEST META.yml README rpm t $ perl Makefile.PL $ make && make install ``` **å®‰è£…å®Œæˆåæ‹·è´`mha4mysql-node-0.58/bin`ä¸‹çš„æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶åˆ°`/usr/local/bin`** > **apply_diff_relay_logs #è¯†åˆ«å·®å¼‚æ—¥å¿—å¹¶åº”ç”¨äºå…¶ä»–slave** > **save_binary_logs #ä¿å­˜å’Œå¤åˆ¶äºŒè¿›åˆ¶æ—¥å¿—** > **filter_mysqlbinlog #å»é™¤ä¸å¿…è¦çš„ROLLBACKäº‹ä»¶ï¼ˆMHAå·²ä¸å†ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼‰** > **purge_relay_logs #æ¸…é™¤ä¸­ç»§æ—¥å¿—** --- manageræ“ä½œ(mha 10.0.0.130) 3.5 éƒ¨ç½²MHA Manager 3.5.1 å¢åŠ epelæº wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo 3.5.2 å®‰è£…ä¾èµ–åŒ… yum -y install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker perl-ExtUtils-Embed perl-CPAN 3.5.3 å®‰è£…manager #ä¸‹è½½åŒ… wget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58.tar.gz #ç¼–è¯‘å®‰è£… $ cd cd mha4mysql-manager-0.58 $ ls AUTHORS bin COPYING debian inc lib Makefile.PL MANIFEST META.yml README rpm samples t tests $ perl Makefile.PL $ make && make install å®‰è£…å®Œæˆåä¼šæ‹·è´mha4mysql-manager-0.58/binä¸‹çš„æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶åˆ°/usr/local/bin masterha_manager #åœ¨ä¸»æœåŠ¡å™¨å…³é—­çš„æƒ…å†µä¸‹ï¼Œä¸»æœåŠ¡å™¨è‡ªåŠ¨ç›‘è§†å’Œè¿è¡Œæ•…éšœè½¬ç§» masterha_master_switch #æ‰‹åŠ¨æˆ–éäº¤äº’å¼ä¸»æ•…éšœè½¬ç§»æˆ–åœ¨çº¿ä¸»åº“ masterha_master_monitor #MHA Managerç›‘æ§ç¨‹åº masterha_stop #åœæ­¢MHA Manager masterha_check_repl #æ£€æŸ¥MySQLå¤åˆ¶è¿è¡ŒçŠ¶å†µ masterha_check_status #æ£€æŸ¥Manageræ˜¯å¦æ­£ç¡®ç›‘è§†MySQL master masterha_check_ssh #æ£€æŸ¥sshé…ç½® masterha_conf_host #ä¸€ä¸ªå¸®åŠ©ç¨‹åºè„šæœ¬ï¼Œç”¨äºä»é…ç½®æ–‡ä»¶æ·»åŠ /åˆ é™¤ä¸»æœºæ¡ç›® masterha_secondary_check #MHA ManageräºŒæ¬¡æ£€æŸ¥ 3.5.4 mysqlä¸»åº“èŠ‚ç‚¹é…ç½®eth0:0ç½‘å¡ï¼Œç”¨ä½œVIPï¼Œè¿™é‡Œè®¾ç½®ä¸º10.0.0.200 è¿™ä¸€æ­¥åœ¨mysqlä¸»åº“ä¸Š(10.0.0.133)æ‰§è¡Œ $ ifconfig eth0:0 10.0.0.200 $ ip a s eth0 eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:62:a8:c1 brd ff:ff:ff:ff:ff:ff inet 10.0.0.133/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet 10.0.0.200/8 brd 10.255.255.255 scope global eth0:0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fe62:a8c1/64 scope link valid_lft forever preferred_lft forever 3.5.5 ä½¿ç”¨è„šæœ¬ç®¡ç†vip âš ï¸éœ€è¦ä¿®æ”¹çš„æ˜¯VIPçš„åœ°å€å’Œç½‘å¡çš„åç§° VIPæ˜¯ç»‘å®šåœ¨ä¸»åº“ä¸Šçš„ï¼Œè¿™æ ·å½“ä¸»åº“å®•æœºåVIPæ‰ä¼šæ¼‚ç§»åˆ°æ–°ä¸»åº“ä¸Š cat > /usr/local/bin/master_ip_failover 'all'; use Getopt::Long; my ( $command, $ssh_user, $orig_master_host, $orig_master_ip, $orig_master_port, $new_master_host, $new_master_ip, $new_master_port ); #è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ eth1:$keyçš„æ„æ€æ˜¯ vipå¿…é¡»ç»‘å®šåœ¨ eth0:0ä¸Š my $vip = '10.0.0.200/24'; #æ­¤å¤„ä¸ºä½ è¦è®¾ç½®çš„è™šæ‹Ÿip my $key = '0'; my $ssh_start_vip = \"/usr//sbin/ifconfig eth0:$key $vip\"; #æ­¤å¤„æ”¹ä¸ºä½ çš„ç½‘å¡åç§° my $ssh_stop_vip = \"/usr/sbin/ifconfig eth0:$key down\"; GetOptions( 'command=s' => \\$command, 'ssh_user=s' => \\$ssh_user, 'orig_master_host=s' => \\$orig_master_host, 'orig_master_ip=s' => \\$orig_master_ip, 'orig_master_port=i' => \\$orig_master_port, 'new_master_host=s' => \\$new_master_host, 'new_master_ip=s' => \\$new_master_ip, 'new_master_port=i' => \\$new_master_port, ); exit &main(); sub main { print \"\\n\\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\\n\\n\"; if ( $command eq \"stop\" || $command eq \"stopssh\" ) { my $exit_code = 1; eval { print \"Disabling the VIP on old master: $orig_master_host \\n\"; &stop_vip(); $exit_code = 0; }; if ($@) { warn \"Got Error: $@\\n\"; exit $exit_code; } exit $exit_code; } elsif ( $command eq \"start\" ) { my $exit_code = 10; eval { print \"Enabling the VIP - $vip on the new master - $new_master_host \\n\"; &start_vip(); $exit_code = 0; }; if ($@) { warn $@; exit $exit_code; } exit $exit_code; } elsif ( $command eq \"status\" ) { print \"Checking the Status of the script.. OK \\n\"; exit 0; } else { &usage(); exit 1; } } sub start_vip() { `ssh $ssh_user\\@$new_master_host \\\" $ssh_start_vip \\\"`; } sub stop_vip() { return 0 unless ($ssh_user); `ssh $ssh_user\\@$orig_master_host \\\" $ssh_stop_vip \\\"`; } sub usage { print \"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\\n\"; } EOF ç»™è„šæœ¬èµ‹äºˆæ‰§è¡Œæƒé™ chmod +x /usr/local/bin/master_ip_failover 3.5.6 é…ç½®mhaé…ç½®æ–‡ä»¶ åˆ›å»ºmhaé…ç½®æ–‡ä»¶ç›®å½•åŠæ—¥å¿—ç›®å½• mkdir /etc/masterha mkdir -p /var/log/masterha/app1 ç¼–è¾‘mhaé…ç½®æ–‡ä»¶/etc/masterha/app1.conf mha4mysql-manager-0.58/samples/conf/app1.confæ˜¯mhaçš„é»˜è®¤é…ç½®æ–‡ä»¶ cat > /etc/masterha/app1.cnf ç¼–è¾‘å‘ç”Ÿåˆ‡æ¢åå‘é€æŠ¥è­¦çš„è„šæœ¬ï¼Œéœ€è¦è‡ªè¡Œé…ç½®é‚®ç®±è®¾ç½® cat > /etc/masterha/send_report 'all'; use Mail::Sender; use Getopt::Long; #new_master_host and new_slave_hosts are set only when recovering master succeeded my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body ); my $smtp='smtpæœåŠ¡å™¨åœ°å€'; my $mail_from='å‘ä»¶äººé‚®ç®±'; my $mail_user='é‚®ç®±ç™»é™†ç”¨æˆ·å'; my $mail_pass='é‚®ç®±ç™»é™†å¯†ç '; my $mail_to=['æ”¶ä»¶äººåœ°å€']; GetOptions( 'orig_master_host=s' => \\$dead_master_host, 'new_master_host=s' => \\$new_master_host, 'new_slave_hosts=s' => \\$new_slave_hosts, 'subject=s' => \\$subject, 'body=s' => \\$body, ); mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body); sub mailToContacts { my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_; open my $DEBUG, \"> /tmp/monitormail.log\" or die \"Can't open the debug file:$!\\n\"; my $sender = new Mail::Sender { ctype => 'text/plain; charset=utf-8', encoding => 'utf-8', smtp => $smtp, from => $mail_from, auth => 'LOGIN', TLS_allowed => '0', authid => $user, authpwd => $passwd, to => $mail_to, subject => $subject, debug => $DEBUG }; $sender->MailMsg( { msg => $msg, debug => $DEBUG } ) or print $Mail::Sender::Error; return 1; } # Do whatever you want here exit 0; EOF 3.5.7 æµ‹è¯•MHA Manager 3.5.7.1 æµ‹è¯•sshè¿æ¥ $ masterha_check_ssh --conf=/etc/masterha/app1.cnf Sat Jun 6 10:27:32 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping. Sat Jun 6 10:27:32 2020 - [info] Reading application default configuration from /etc/mha/mha.conf.. Sat Jun 6 10:27:32 2020 - [info] Reading server configuration from /etc/mha/mha.conf.. Sat Jun 6 10:27:32 2020 - [info] Starting SSH connection tests.. Sat Jun 6 10:27:33 2020 - [debug] Sat Jun 6 10:27:32 2020 - [debug] Connecting via SSH from root@10.0.0.133(10.0.0.133:22) to root@10.0.0.134(10.0.0.134:22).. Sat Jun 6 10:27:32 2020 - [debug] ok. Sat Jun 6 10:27:32 2020 - [debug] Connecting via SSH from root@10.0.0.133(10.0.0.133:22) to root@10.0.0.135(10.0.0.135:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:33 2020 - [debug] Sat Jun 6 10:27:32 2020 - [debug] Connecting via SSH from root@10.0.0.134(10.0.0.134:22) to root@10.0.0.133(10.0.0.133:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:33 2020 - [debug] Connecting via SSH from root@10.0.0.134(10.0.0.134:22) to root@10.0.0.135(10.0.0.135:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:34 2020 - [debug] Sat Jun 6 10:27:33 2020 - [debug] Connecting via SSH from root@10.0.0.135(10.0.0.135:22) to root@10.0.0.133(10.0.0.133:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:33 2020 - [debug] Connecting via SSH from root@10.0.0.135(10.0.0.135:22) to root@10.0.0.134(10.0.0.134:22).. Sat Jun 6 10:27:33 2020 - [debug] ok. Sat Jun 6 10:27:34 2020 - [info] All SSH connection tests passed successfully. 3.5.7.2 æµ‹è¯•mysqlé›†ç¾¤è¿æ¥æƒ…å†µ $ masterha_check_repl --conf=/etc/masterha/app1.cnf Sat Jun 6 12:45:42 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping. Sat Jun 6 12:45:42 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf.. Sat Jun 6 12:45:42 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf.. Sat Jun 6 12:45:42 2020 - [info] MHA::MasterMonitor version 0.58. Sat Jun 6 12:45:43 2020 - [info] GTID failover mode = 0 Sat Jun 6 12:45:43 2020 - [info] Dead Servers: Sat Jun 6 12:45:43 2020 - [info] Alive Servers: Sat Jun 6 12:45:43 2020 - [info] 10.0.0.133(10.0.0.133:3306) Sat Jun 6 12:45:43 2020 - [info] 10.0.0.134(10.0.0.134:3306) Sat Jun 6 12:45:43 2020 - [info] 10.0.0.135(10.0.0.135:3306) Sat Jun 6 12:45:43 2020 - [info] Alive Slaves: Sat Jun 6 12:45:43 2020 - [info] 10.0.0.134(10.0.0.134:3306) Version=5.7.28-log (oldest major version between slaves) log-bin:enabled Sat Jun 6 12:45:43 2020 - [info] Replicating from 10.0.0.133(10.0.0.133:3306) Sat Jun 6 12:45:43 2020 - [info] Primary candidate for the new Master (candidate_master is set) Sat Jun 6 12:45:43 2020 - [info] 10.0.0.135(10.0.0.135:3306) Version=5.7.28-log (oldest major version between slaves) log-bin:enabled Sat Jun 6 12:45:43 2020 - [info] Replicating from 10.0.0.133(10.0.0.133:3306) Sat Jun 6 12:45:43 2020 - [info] Current Alive Master: 10.0.0.133(10.0.0.133:3306) Sat Jun 6 12:45:43 2020 - [info] Checking slave configurations.. Sat Jun 6 12:45:43 2020 - [info] read_only=1 is not set on slave 10.0.0.134(10.0.0.134:3306). Sat Jun 6 12:45:43 2020 - [warning] relay_log_purge=0 is not set on slave 10.0.0.134(10.0.0.134:3306). Sat Jun 6 12:45:43 2020 - [info] read_only=1 is not set on slave 10.0.0.135(10.0.0.135:3306). Sat Jun 6 12:45:43 2020 - [warning] relay_log_purge=0 is not set on slave 10.0.0.135(10.0.0.135:3306). Sat Jun 6 12:45:43 2020 - [info] Checking replication filtering settings.. Sat Jun 6 12:45:43 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Jun 6 12:45:43 2020 - [info] Replication filtering check ok. Sat Jun 6 12:45:43 2020 - [info] GTID (with auto-pos) is not supported Sat Jun 6 12:45:43 2020 - [info] Starting SSH connection tests.. Sat Jun 6 12:45:50 2020 - [info] All SSH connection tests passed successfully. Sat Jun 6 12:45:50 2020 - [info] Checking MHA Node version.. Sat Jun 6 12:45:51 2020 - [info] Version check ok. Sat Jun 6 12:45:51 2020 - [info] Checking SSH publickey authentication settings on the current master.. Sat Jun 6 12:45:51 2020 - [info] HealthCheck: SSH to 10.0.0.133 is reachable. Sat Jun 6 12:45:51 2020 - [info] Master MHA Node version is 0.58. Sat Jun 6 12:45:51 2020 - [info] Checking recovery script configurations on 10.0.0.133(10.0.0.133:3306).. Sat Jun 6 12:45:51 2020 - [info] Executing command: save_binary_logs --command=test --start_pos=4 --binlog_dir=/usr/local/mysql/data --output_file=/tmp/save_binary_logs_test --manager_version=0.58 --start_file=binlog.000001 Sat Jun 6 12:45:51 2020 - [info] Connecting to root@10.0.0.133(10.0.0.133:22).. Creating /tmp if not exists.. ok. Checking output directory is accessible or not.. ok. Binlog found at /usr/local/mysql/data, up to binlog.000001 Sat Jun 6 12:45:51 2020 - [info] Binlog setting check done. Sat Jun 6 12:45:51 2020 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers.. Sat Jun 6 12:45:51 2020 - [info] Executing command : apply_diff_relay_logs --command=test --slave_user='root' --slave_host=10.0.0.134 --slave_ip=10.0.0.134 --slave_port=3306 --workdir=/tmp --target_version=5.7.28-log --manager_version=0.58 --relay_log_info=/usr/local/mysql/data/relay-log.info --relay_dir=/usr/local/mysql/data/ --slave_pass=xxx Sat Jun 6 12:45:51 2020 - [info] Connecting to root@10.0.0.134(10.0.0.134:22).. Checking slave recovery environment settings.. Opening /usr/local/mysql/data/relay-log.info ... ok. Relay log found at /usr/local/mysql/data, up to mysql02-relay-bin.000002 Temporary relay log file is /usr/local/mysql/data/mysql02-relay-bin.000002 Checking if super_read_only is defined and turned on.. not present or turned off, ignoring. Testing mysql connection and privileges.. mysql: [Warning] Using a password on the command line interface can be insecure. done. Testing mysqlbinlog output.. done. Cleaning up test file(s).. done. Sat Jun 6 12:45:51 2020 - [info] Executing command : apply_diff_relay_logs --command=test --slave_user='root' --slave_host=10.0.0.135 --slave_ip=10.0.0.135 --slave_port=3306 --workdir=/tmp --target_version=5.7.28-log --manager_version=0.58 --relay_log_info=/usr/local/mysql/data/relay-log.info --relay_dir=/usr/local/mysql/data/ --slave_pass=xxx Sat Jun 6 12:45:51 2020 - [info] Connecting to root@10.0.0.135(10.0.0.135:22).. Checking slave recovery environment settings.. Opening /usr/local/mysql/data/relay-log.info ... ok. Relay log found at /usr/local/mysql/data, up to mysql03-relay-bin.000002 Temporary relay log file is /usr/local/mysql/data/mysql03-relay-bin.000002 Checking if super_read_only is defined and turned on.. not present or turned off, ignoring. Testing mysql connection and privileges.. mysql: [Warning] Using a password on the command line interface can be insecure. done. Testing mysqlbinlog output.. done. Cleaning up test file(s).. done. Sat Jun 6 12:45:52 2020 - [info] Slaves settings check done. Sat Jun 6 12:45:52 2020 - [info] 10.0.0.133(10.0.0.133:3306) (current master) +--10.0.0.134(10.0.0.134:3306) +--10.0.0.135(10.0.0.135:3306) Sat Jun 6 12:45:52 2020 - [info] Checking replication health on 10.0.0.134.. Sat Jun 6 12:45:52 2020 - [info] ok. Sat Jun 6 12:45:52 2020 - [info] Checking replication health on 10.0.0.135.. Sat Jun 6 12:45:52 2020 - [info] ok. Sat Jun 6 12:45:52 2020 - [info] Checking master_ip_failover_script status: Sat Jun 6 12:45:52 2020 - [info] /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=10.0.0.133 --orig_master_ip=10.0.0.133 --orig_master_port=3306 IN SCRIPT TEST====/usr/sbin/ifconfig eth1:1 down==/usr//sbin/ifconfig eth1:1 10.0.0.200/24=== Checking the Status of the script.. OK Sat Jun 6 12:45:52 2020 - [info] OK. Sat Jun 6 12:45:52 2020 - [warning] shutdown_script is not defined. Sat Jun 6 12:45:52 2020 - [info] Got exit code 0 (Not master dead). MySQL Replication Health is OK. 3.5.8 å¯åŠ¨mha å¯åŠ¨mha nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 & å¯åŠ¨å‚æ•°è¯´æ˜ --remove_dead_master_conf è¯¥å‚æ•°ä»£è¡¨å½“å‘ç”Ÿä¸»ä»åˆ‡æ¢åï¼Œè€çš„ä¸»åº“çš„ipå°†ä¼šä»é…ç½®æ–‡ä»¶ä¸­ç§»é™¤ã€‚ /var/log/masterha/app1/manager.log 2>&1 & æ‰“å°æ—¥å¿— --ignore_last_failover åœ¨ç¼ºçœæƒ…å†µä¸‹ï¼Œå¦‚æœMHAæ£€æµ‹åˆ°è¿ç»­å‘ç”Ÿå®•æœºï¼Œä¸”ä¸¤æ¬¡å®•æœºé—´éš”ä¸è¶³8å°æ—¶çš„è¯ï¼Œåˆ™ä¸ä¼šè¿›è¡ŒFailoverï¼Œä¹‹æ‰€ä»¥è¿™æ ·é™åˆ¶æ˜¯ä¸ºäº†é¿å…ping-pongæ•ˆåº”ã€‚è¯¥å‚æ•°ä»£è¡¨å¿½ç•¥ä¸Šæ¬¡MHAè§¦å‘åˆ‡æ¢äº§ç”Ÿçš„æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒMHAå‘ç”Ÿåˆ‡æ¢åä¼šåœ¨æ—¥å¿—ç›®å½•ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æˆ‘è®¾ç½®çš„/dataäº§ç”Ÿapp1.failover.completeæ–‡ä»¶ï¼Œä¸‹æ¬¡å†æ¬¡åˆ‡æ¢çš„æ—¶å€™å¦‚æœå‘ç°è¯¥ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶å°†ä¸å…è®¸è§¦å‘åˆ‡æ¢ï¼Œé™¤éåœ¨ç¬¬ä¸€æ¬¡åˆ‡æ¢åæ”¶åˆ°åˆ é™¤è¯¥æ–‡ä»¶ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œè®¾ç½®ä¸º--ignore_last_failover MHAåˆ‡æ¢æœºåˆ¶ 1ã€åˆ‡æ¢åä¼šç”Ÿæˆä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œåœ¨MHAçš„å·¥ä½œç›®å½•ä¸‹ 2ã€ä¸‹ä¸€æ¬¡åˆ‡æ¢ä¹‹å‰å…ˆç›‘æµ‹æ˜¯å¦å­˜åœ¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶ 3ã€å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¸åšåˆ‡æ¢ 4ã€å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ‡æ¢ 5ã€è¯¥ä¸´æ—¶æ–‡ä»¶å­˜åœ¨æ—¶é—´8å°æ—¶ æµ‹è¯•mhaçŠ¶æ€ $ masterha_check_status --conf=/etc/masterha/app1.cnf app1 (pid:2262) is running(0:PING_OK), master:10.0.0.133 åœæ­¢mha $ masterha_stop --conf=/etc/masterha/app1.cnf Stopped app1 successfully. [1]+ Exit 1 nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 é‡å¯mha masterha_stop --conf=/etc/masterha/app1.cnf && nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 & åˆ°æ­¤ï¼ŒMHAéƒ¨ç½²å®Œæˆï¼ 3.6 æµ‹è¯•MHA 3.6.1 æ‰‹åŠ¨å…³é—­ä¸»åº“ï¼Œæ¨¡æ‹Ÿå®•æœº 10.0.0.133 mysql01æ“ä½œ systemctl stop mysqld 3.6.2 éªŒè¯slave1ï¼Œå³10.0.0.134 å› ä¸ºåœ¨mhaé…ç½®æ–‡ä»¶/etc/masterha/app1.confä¸­å®šä¹‰äº†å‚æ•°candidate_master=1ï¼Œå³è®¾ç½®ä¸ºå€™é€‰masterï¼Œå¦‚æœè®¾ç½®è¯¥å‚æ•°ä»¥åï¼Œå‘ç”Ÿä¸»ä»åˆ‡æ¢ä»¥åå°†ä¼šå°†æ­¤ä»åº“æå‡ä¸ºä¸»åº“ï¼Œå³ä½¿è¿™ä¸ªä¸»åº“ä¸æ˜¯é›†ç¾¤ä¸­äº‹ä»¶æœ€æ–°çš„slaveï¼Œå› æ­¤ï¼Œå½“ä¸»åº“æŒ‚æ‰æ—¶ï¼Œslave1 10.0.0.134ä¼šæˆä¸ºæ–°çš„ä¸»åº“ 10.0.0.135 mysql02æ“ä½œ å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸»åº“10.0.0.133å®•æœºåï¼Œ10.0.0.134æˆä¸ºäº†æ–°çš„ä¸»åº“ $ show slave status\\G *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 10.0.0.134 Master_User: repl Master_Port: 3306 Connect_Retry: 60 Master_Log_File: binlog.000002 Read_Master_Log_Pos: 1331 Relay_Log_File: mysql03-relay-bin.000002 Relay_Log_Pos: 317 Relay_Master_Log_File: binlog.000002 Slave_IO_Running: Yes Slave_SQL_Running: Yes ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ éªŒè¯VIPæ˜¯å¦å·²ç»æ¼‚ç§» åœ¨æ–°ä¸»åº“ä¸Šèƒ½å¤Ÿçœ‹åˆ°VIPå³ä¸ºæˆåŠŸ $ ip a s eth0 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:09:c2:b1 brd ff:ff:ff:ff:ff:ff inet 10.0.0.134/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet 10.0.0.200/24 brd 10.0.0.255 scope global secondary eth0:0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fe09:c2b1/64 scope link valid_lft forever preferred_lft forever 3.7 ä¿®å¤å®•æœºä¸»åº“æ­¥éª¤ ç¬¬ä¸€æ­¥ã€ä¿®å¤å®•æœºä¸»åº“ ç”¨å„ç§æ–¹æ³•æŠŠå®•æ‰çš„æ—§ä¸»åº“æˆåŠŸå¯åŠ¨ ç¬¬äºŒæ­¥ã€ä»MHAé…ç½®æ–‡ä»¶/etc/masterha/app1.confä¸­çš„[server default]æ ‡ç­¾ä¸‹å®šä¹‰çš„manager_log=/var/log/masterha/app1/manager.logæ—¥å¿—æ–‡ä»¶ä¸­æ‰¾åˆ°change master toè¯­å¥ï¼Œä¿®æ”¹ä»åº“å¤åˆ¶ç”¨æˆ·çš„å¯†ç ï¼Œå¹¶ä¸”æŒ‡å®šä¸»åº“ä¸ºæ–°ä¸»åº“ MHAèŠ‚ç‚¹æ“ä½œ $ grep -i 'change master to' /var/log/masterha/app1/manager.log Sun Jun 7 13:17:49 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='10.0.0.134', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='xxx'; ç¬¬ä¸‰æ­¥ã€è¿æ¥æ—§ä¸»åº“ï¼Œæ‰§è¡Œä¸Šä¸€æ­¥æ‰¾åˆ°çš„change master toè¯­å¥å¹¶æ‰“å¼€IOã€SQLçº¿ç¨‹ 10.0.0.133 mysql01(æ—§ä¸»åº“)æ“ä½œ #æ‰§è¡Œchange master to mysql> CHANGE MASTER TO \\ MASTER_HOST='10.0.0.134', \\ MASTER_PORT=3306, \\ MASTER_AUTO_POSITION=1, \\ MASTER_USER='repl', \\ MASTER_PASSWORD='Bxb123.com'; Query OK, 0 rows affected, 2 warnings (0.01 sec) #å¯åŠ¨IOã€SQLçº¿ç¨‹ mysql> start slave; Query OK, 0 rows affected (0.01 sec) ç¬¬å››æ­¥ã€æŠŠæ—§ä¸»åº“çš„serveræ ‡ç­¾åœ¨MHAé…ç½®æ–‡ä»¶ä¸­æ·»åŠ å›æ¥ï¼ŒMHAæ‰§è¡Œåˆ‡æ¢åï¼Œä¼šæŠŠdownæœºçš„ä¸»æœºserveræ ‡ç­¾åˆ é™¤ ç¼–è¾‘MHAé…ç½®æ–‡ä»¶/etc/masterha/app1.cnfæ·»åŠ server1æ ‡ç­¾ [server1] hostname=10.0.0.133 port=3306 ç¬¬äº”æ­¥ã€å¯åŠ¨MHA nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 & å››ã€é…ç½®binlog-server mysql5.7å®˜æ–¹binlog-serveræ–‡æ¡£ MHAå®˜æ–¹å¯¹äºbinlog-serverçš„ç®€å•è¯´æ˜ ä»MHAç‰ˆæœ¬0.56å¼€å§‹ï¼ŒMHAæ”¯æŒnewéƒ¨åˆ†[binlogN]ã€‚åœ¨binlogéƒ¨åˆ†ï¼Œæ‚¨å¯ä»¥å®šä¹‰mysqlbinlogæµæœåŠ¡å™¨ã€‚å½“MHAè¿›è¡ŒåŸºäºGTIDçš„æ•…éšœè½¬ç§»æ—¶ï¼ŒMHAä¼šæ£€æŸ¥binlogæœåŠ¡å™¨ï¼Œå¹¶ä¸”å¦‚æœbinlogæœåŠ¡å™¨åœ¨å…¶ä»–ä»æœåŠ¡å™¨ä¹‹å‰ï¼Œåˆ™MHAä¼šåœ¨æ¢å¤ä¹‹å‰å°†å·®åˆ†binlogäº‹ä»¶åº”ç”¨äºæ–°çš„ä¸»æœåŠ¡å™¨ã€‚å½“MHAè¿›è¡ŒåŸºäºéGTIDçš„ï¼ˆä¼ ç»Ÿï¼‰æ•…éšœè½¬ç§»æ—¶ï¼ŒMHAå°†å¿½ç•¥äºŒè¿›åˆ¶æ—¥å¿—æœåŠ¡å™¨ã€‚ ä½œç”¨: é˜²æ­¢masteræ–­ç”µæˆ–å…¶ä»–åŸå› å¯¼è‡´binlogç¼ºå¤± å‰æ: mysqlä¸»ä»å¿…é¡»ä¸ºGTIDæ¨¡å¼ é…ç½®å¥½GTIDä¸»ä»åæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ 4.1 MHAé…ç½®æ–‡ä»¶/etc/masterha/app1.cnfåŠ å…¥binlog-serveré…ç½® è¿™é‡ŒæŠŠmysql03 10.0.0.135å½“ä½œbinlog-server [binlog1] #ä¸è®©è¿™ä¸ªæœºå™¨å½“ä¸»åº“ no_master=1 hostname=10.0.0.135 master_binlog_dir=/data/mysql/binlog åˆ›å»ºbinlogå¤‡ä»½ç›®å½• mkdir -p /data/mysql/binlog && chown mysql.mysql /data/mysql/binlog 4.2 æ‰‹åŠ¨å¤‡ä»½binlog âš ï¸å¤‡ä»½binlogï¼Œ--hoståçš„IPä¸€å®šè¦å¡«å†™VIPåœ°å€ âš ï¸ä¸€å®šè¦æ³¨æ„å†™å¯¹mysql binlogæ–‡ä»¶çš„åç§° #è¿›å…¥binlogå¤‡ä»½ç›®å½• cd /data/mysql/binlog #æ‰‹åŠ¨å¤‡ä»½ mysqlbinlog -R --host=10.0.0.200 --user=mha --password=Bxb123.com --raw --stop-never binlog.000001 & 4.3 å¯åŠ¨MHA nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 & 4.4 éªŒè¯ mysql masterèŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤flush logsåˆ·æ–°binlog masteråˆ·æ–°binlogï¼Œå¤šæ‰§è¡Œå‡ æ¬¡ mysql> flush logs; Query OK, 0 rows affected (0.01 sec) mysql03 10.0.0.135èŠ‚ç‚¹/data/mysql/binlogæŸ¥çœ‹binlogï¼Œä¼šåŒæ­¥masterä¸Šçš„binlog $ pwd /data/mysql/binlog $ ls binlog.000001 binlog.000002 binlog.000003 äº”ã€MHAå¸¸ç”¨å‘½ä»¤æ€»ç»“ 1ã€æ£€æŸ¥mhaçš„sshå…å¯†ç™»å½•çŠ¶æ€ masterha_check_ssh --conf=/etc/masterha/app1.cnf 2ã€æ£€æŸ¥mhaçš„è¿è¡ŒçŠ¶æ€ masterha_check_status --conf=/etc/masterha/app1.cnf 3ã€æ£€æŸ¥ä¸»å¤‡åº“çš„å¤åˆ¶æƒ…å†µ masterha_check_repl --conf=/etc/masterha/app1.cnf 4ã€åœæ­¢mha masterha_stop --conf=/etc/masterha/app1.cnf 5ã€å¯åŠ¨mha nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/masterha/app1/manager.log 2>&1 & 6ã€mhaæ‰‹åŠ¨åˆ‡æ¢ä¸»åº“ masterha_master_switch --conf=/etc/masterha/app1.cnf --master_state=alive --new_master_host=10.0.0.135 --new_master_port=3106 --orig_master_is_new_slave 7ã€mhaé‡æ–°ç»‘å®šæ•°æ®åº“å®ä¾‹ master_ip_failover --command=status --ssh_user=root --orig_master_host=10.0.0.133 --orig_master_ip=10.0.0.200 --orig_master_port=3306 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mysql/mysqlçŸ¥è¯†ç‚¹/mysqläº‹åŠ¡éš”ç¦»çº§åˆ«.html":{"url":"db/mysql/mysqlçŸ¥è¯†ç‚¹/mysqläº‹åŠ¡éš”ç¦»çº§åˆ«.html","title":"mysqläº‹åŠ¡éš”ç¦»çº§åˆ«","keywords":"","body":"mysqläº‹åŠ¡éš”ç¦»çº§åˆ« mysqläº‹åŠ¡ ä¸€èˆ¬æ¥è¯´ï¼Œäº‹åŠ¡æ˜¯å¿…é¡»æ»¡è¶³4ä¸ªæ¡ä»¶ï¼ˆACIDï¼‰ï¼šï¼šåŸå­æ€§ï¼ˆAtomicityï¼Œæˆ–ç§°ä¸å¯åˆ†å‰²æ€§ï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼Œåˆç§°ç‹¬ç«‹æ€§ï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰ã€‚ åŸå­æ€§ï¼šä¸€ä¸ªäº‹åŠ¡ï¼ˆtransactionï¼‰ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å®Œæˆï¼Œä¸ä¼šç»“æŸåœ¨ä¸­é—´æŸä¸ªç¯èŠ‚ã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¢«å›æ»šï¼ˆRollbackï¼‰åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»æ¥æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ã€‚ ä¸€è‡´æ€§ï¼šåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚è¿™è¡¨ç¤ºå†™å…¥çš„èµ„æ–™å¿…é¡»å®Œå…¨ç¬¦åˆæ‰€æœ‰çš„é¢„è®¾è§„åˆ™ï¼Œè¿™åŒ…å«èµ„æ–™çš„ç²¾ç¡®åº¦ã€ä¸²è”æ€§ä»¥åŠåç»­æ•°æ®åº“å¯ä»¥è‡ªå‘æ€§åœ°å®Œæˆé¢„å®šçš„å·¥ä½œã€‚ éš”ç¦»æ€§ï¼šæ•°æ®åº“å…è®¸å¤šä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶å¯¹å…¶æ•°æ®è¿›è¡Œè¯»å†™å’Œä¿®æ”¹çš„èƒ½åŠ›ï¼Œéš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ç”±äºäº¤å‰æ‰§è¡Œè€Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚äº‹åŠ¡éš”ç¦»åˆ†ä¸ºä¸åŒçº§åˆ«ï¼ŒåŒ…æ‹¬è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ã€è¯»æäº¤ï¼ˆread committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ã€‚ æŒä¹…æ€§ï¼šäº‹åŠ¡å¤„ç†ç»“æŸåï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹å°±æ˜¯æ°¸ä¹…çš„ï¼Œå³ä¾¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ mysql 4ç§äº‹åŠ¡éš”ç¦»çº§åˆ« çº§åˆ« symbol å¯¹åº”å€¼ å«ä¹‰ å­˜åœ¨é—®é¢˜ è¯»æœªæäº¤ READ-UNCOMMITTED 0 ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ® å­˜åœ¨è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»çš„é—®é¢˜ è¯»å·²æäº¤ READ-COMMITTED 1 ä¸€ä¸ªäº‹åŠ¡èƒ½è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡å·²æäº¤çš„æ•°æ® è§£å†³è„è¯»çš„é—®é¢˜ï¼Œå­˜åœ¨ä¸å¯é‡å¤è¯»ã€å¹»è¯»çš„é—®é¢˜ å¯é‡å¤è¯» REPEATABLE-READ 2 åŒä¸€äº‹åŠ¡çš„å¤šä¸ªå®ä¾‹åœ¨å¹¶å‘è¯»å–æ•°æ®æ—¶ï¼Œä¼šçœ‹åˆ°åŒæ ·çš„æ•°æ®è¡Œ mysqlé»˜è®¤çº§åˆ«ï¼Œè§£å†³è„è¯»ã€ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå­˜åœ¨å¹»è¯»çš„é—®é¢˜ã€‚ä½¿ç”¨ MMVCæœºåˆ¶ å®ç°å¯é‡å¤è¯» ä¸²è¡ŒåŒ– SERIALIZABLE 3 å¼ºåˆ¶äº‹åŠ¡æ’åºï¼Œä½¿ä¹‹ä¸å¯èƒ½ç›¸äº’å†²çª è§£å†³è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ï¼Œå¯ä¿è¯äº‹åŠ¡å®‰å…¨ï¼Œä½†å®Œå…¨ä¸²è¡Œæ‰§è¡Œï¼Œæ€§èƒ½æœ€ä½ å…³äºmysqläº‹åŠ¡çš„ä¸€äº›çŸ¥è¯†ç‚¹ æœ€å¼€å§‹çš„æ—¶å€™ï¼Œ5.1.5ä¹‹å‰çš„ç‰ˆæœ¬binlog formatåªæ”¯æŒstamentï¼Œå¹¶æ²¡æœ‰rowæ¨¡å¼ï¼Œåœ¨RCä¸€äº›åœºæ™¯ä¸‹ä¼šé€ æˆä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ‰€ä»¥é€‰æ‹©RRæ‰èƒ½æœ€å¤§é™åº¦ä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´æ€§ ä¹‹åçš„mysqlç›´æ¥ä½¿ç”¨RC+rowæ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ mysql5.7è¡¨çš„é»˜è®¤å­˜å‚¨å¼•æ“æ˜¯InnoDB mysql> show create table t1; +-------+---------------------------------------------------------------------------------------------------------------------------------------+ | Table | Create Table | +-------+---------------------------------------------------------------------------------------------------------------------------------------+ | t1 | CREATE TABLE `t1` ( `id` int(3) NOT NULL, `name` char(30) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 | +-------+---------------------------------------------------------------------------------------------------------------------------------------+ 1 row in set (0.05 sec) mysql5.7 InnoDBå­˜å‚¨å¼•æ“é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå…¨å±€å’Œå½“å‰ä¼šè¯éƒ½æ˜¯REPEATABLE-READ(å¯é‡å¤è¯») RRçš„å¹¶å‘æ€§æ²¡æœ‰RCå¥½ #mysql5.7.22 mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+-----------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+-----------------+ | REPEATABLE-READ | REPEATABLE-READ | +-----------------------+-----------------+ 1 row in set (0.02 sec) è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ« #é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼Œå¯é€‰å‚æ•° READ-UNCOMMITTEDã€READ-COMMITTEDã€REPEATABLE-READã€ SERIALIZABLE [mysqld] transaction-isolation = REPEATABLE-READ #è®¾ç½®å…¨å±€ SET @@global.tx_isolation = 0; SET @@global.tx_isolation = 'READ-UNCOMMITTED'; SET @@global.tx_isolation = 1; SET @@global.tx_isolation = 'READ-COMMITTED'; SET @@global.tx_isolation = 2; SET @@global.tx_isolation = 'REPEATABLE-READ'; SET @@global.tx_isolation = 3; SET @@global.tx_isolation = 'SERIALIZABLE'; #è®¾ç½®ä¼šè¯ SET @@session.tx_isolation = 0; SET @@session.tx_isolation = 'READ-UNCOMMITTED'; SET @@session.tx_isolation = 1; SET @@session.tx_isolation = 'READ-COMMITTED'; SET @@session.tx_isolation = 2; SET @@session.tx_isolation = 'REPEATABLE-READ'; SET @@session.tx_isolation = 3; SET @@session.tx_isolation = 'SERIALIZABLE'; mysqlæŸ¥çœ‹/è®¾ç½®è‡ªåŠ¨æäº¤ //æŸ¥çœ‹è‡ªåŠ¨æäº¤æ˜¯å¦å¼€å¯ï¼Œé»˜è®¤å¼€å¯ #æ–¹æ³•ä¸€ mysql> select @@autocommit; +--------------+ | @@autocommit | +--------------+ | 1 | +--------------+ 1 row in set (0.07 sec) #æ–¹æ³•äºŒ mysql> show variables like 'autocommit'; +---------------+-------+ | Variable_name | Value | +---------------+-------+ | autocommit | ON | +---------------+-------+ 1 row in set (0.09 sec) //å…³é—­è‡ªåŠ¨æäº¤ mysql> set autocommit = 0; Query OK, 0 rows affected (0.11 sec) ä»¥ä¸‹æ‰€æœ‰ç¤ºä¾‹éƒ½åŸºäºmysql5.7.22 å…ˆåˆ›å»ºä¸€å¼ ç¤ºä¾‹è¡¨t1 mysql> select version(); +-----------+ | version() | +-----------+ | 5.7.22 | +-----------+ mysql> create table t1(id int(3) primary key,name char(30)); mysql> insert into t1 values(1,'xiaoming'); mysql> select * from t1; +----+----------+ | id | name | +----+----------+ | 1 | xiaoming | +----+----------+ 1 è¯»æœªæäº¤ Read Uncommitted å«ä¹‰ï¼šä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼ ç¤ºä¾‹ï¼š 1.mysqlé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯RR å¯ç”¨å€¼2æ¥è®¾ç½® mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+-----------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+-----------------+ | REPEATABLE-READ | REPEATABLE-READ | +-----------------------+-----------------+ 1 row in set, 2 warnings (0.00 sec) 2.æ‰‹åŠ¨ä¿®æ”¹å½“å‰ä¼šè¯ä¸ºRU mysql> SET @@session.tx_isolation = 0; Query OK, 0 rows affected, 1 warning (0.12 sec) mysql> SELECT @@tx_isolation; +------------------+ | @@tx_isolation | +------------------+ | READ-UNCOMMITTED | +------------------+ 1 row in set, 1 warning (0.04 sec) 3.å…³é—­è‡ªåŠ¨æäº¤ mysql> set autocommit = 0; Query OK, 0 rows affected (0.08 sec) å¦‚å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªäº‹åŠ¡æ£€ç´¢çš„æ•°æ®è¢«å¦ä¸€ä¸ªæœªæäº¤çš„äº‹åŠ¡ç»™ä¿®æ”¹äº†ã€‚ å®˜ç½‘å¯¹è„è¯»å®šä¹‰çš„åœ°å€ å…¶å†…å®¹ä¸º dirty read An operation that retrieves unreliable data, data that was updated by another transaction but not yet committed. ç¿»è¯‘è¿‡æ¥å°±æ˜¯ æ£€ç´¢æ“ä½œå‡ºæ¥çš„æ•°æ®æ˜¯ä¸å¯é çš„ï¼Œæ˜¯å¯ä»¥è¢«å¦ä¸€ä¸ªæœªæäº¤çš„äº‹åŠ¡ä¿®æ”¹çš„ï¼ ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬çš„æ¼”ç¤ºç»“æœå’Œå®˜ç½‘å¯¹è„è¯»çš„å®šä¹‰ä¸€è‡´ã€‚æ ¹æ®æˆ‘ä»¬æœ€å¼€å§‹çš„æ¨ç†ï¼Œå¦‚æœå­˜åœ¨è„è¯»ï¼Œé‚£ä¹ˆä¸å¯é‡å¤è¯»å’Œå¹»è¯»ä¸€å®šæ˜¯å­˜åœ¨çš„ã€‚ 2 è¯»æäº¤ Read Committed å«ä¹‰ï¼šä¸€ä¸ªäº‹åŠ¡èƒ½è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡å·²æäº¤çš„æ•°æ® ç¤ºä¾‹ï¼š 1.mysqlé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯RR å¯ç”¨å€¼2æ¥è®¾ç½® mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+-----------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+-----------------+ | REPEATABLE-READ | REPEATABLE-READ | +-----------------------+-----------------+ 1 row in set, 2 warnings (0.00 sec) 2.æ‰‹åŠ¨ä¿®æ”¹å½“å‰ä¼šè¯ä¸ºRC mysql> SET @@session.tx_isolation = 1; Query OK, 0 rows affected, 1 warning (0.12 sec) mysql> select @@tx_isolation; +----------------+ | @@tx_isolation | +----------------+ | READ-COMMITTED | +----------------+ 1 row in set, 1 warning (0.04 sec) 3.å…³é—­è‡ªåŠ¨æäº¤ mysql> set autocommit = 0; Query OK, 0 rows affected (0.08 sec) å¦‚å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªäº‹åŠ¡æ£€ç´¢çš„æ•°æ®åªèƒ½è¢«å¦ä¸€ä¸ªå·²æäº¤çš„äº‹åŠ¡ä¿®æ”¹ã€‚ å®˜ç½‘å¯¹ä¸å¯é‡å¤è¯»å®šä¹‰çš„åœ°å€ å…¶å†…å®¹ä¸º non-repeatable read The situation when a query retrieves data, and a later query within the same transaction retrieves what should be the same data, but the queries return different results (changed by another transaction committing in the meantime). ç¿»è¯‘è¿‡æ¥å°±æ˜¯ ä¸€ä¸ªæŸ¥è¯¢è¯­å¥æ£€ç´¢æ•°æ®ï¼Œéšååˆæœ‰ä¸€ä¸ªæŸ¥è¯¢è¯­å¥åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ£€ç´¢æ•°æ®ï¼Œä¸¤ä¸ªæ•°æ®åº”è¯¥æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å®é™…æƒ…å†µè¿”å›äº†ä¸åŒçš„ç»“æœã€‚ï¼ ps:ä½œè€…æ³¨ï¼Œè¿™é‡Œçš„ä¸åŒç»“æœï¼ŒæŒ‡çš„æ˜¯åœ¨è¡Œä¸å˜çš„æƒ…å†µä¸‹(ä¸“ä¸šç‚¹è¯´ï¼Œä¸»é”®ç´¢å¼•æ²¡å˜)ï¼Œä¸»é”®ç´¢å¼•æŒ‡å‘çš„ç£ç›˜ä¸Šçš„æ•°æ®å†…å®¹å˜äº†ã€‚å¦‚æœä¸»é”®ç´¢å¼•å˜äº†ï¼Œæ¯”å¦‚æ–°å¢ä¸€æ¡æ•°æ®æˆ–è€…åˆ é™¤ä¸€æ¡æ•°æ®ï¼Œå°±ä¸æ˜¯ä¸å¯é‡å¤è¯»ã€‚ æ˜¾ç„¶ï¼Œæˆ‘ä»¬è¿™ä¸ªç°è±¡ç¬¦åˆä¸å¯é‡å¤è¯»çš„å®šä¹‰ã€‚ä¸‹é¢ï¼Œå¤§å®¶åšä¸€ä¸ªæ€è€ƒ: è¿™ä¸ªä¸å¯é‡å¤è¯»çš„å®šä¹‰ï¼Œæ”¾åˆ°è„è¯»çš„ç°è±¡é‡Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¯´çš„é€šã€‚æ˜¾ç„¶è„è¯»çš„ç°è±¡ï¼Œä¹Ÿå°±æ˜¯è¯»æœªæäº¤(READ_UNCOMMITTED)çš„é‚£ä¸ªä¾‹å­ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿç¬¦åˆåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­è¿”å›äº†ä¸åŒç»“æœï¼ ä½†æ˜¯åè¿‡æ¥å°±ä¸ä¸€å®šé€šäº†ï¼Œä¸€ä¸ªäº‹åŠ¡Aä¸­æŸ¥è¯¢ä¸¤æ¬¡çš„ç»“æœåœ¨è¢«å¦ä¸€ä¸ªäº‹åŠ¡Bæ”¹å˜çš„æƒ…å†µä¸‹ï¼Œå¦‚æœäº‹åŠ¡Bæœªæäº¤å°±æ”¹å˜äº†äº‹åŠ¡Açš„ç»“æœï¼Œå°±å±äºè„è¯»ï¼Œä¹Ÿå±äºä¸å¯é‡å¤è¯»ã€‚å¦‚æœè¯¥äº‹åŠ¡Bæäº¤äº†æ‰æ”¹å˜äº‹åŠ¡Açš„ç»“æœï¼Œå°±ä¸å±äºè„è¯»ï¼Œä½†å±äºä¸å¯é‡å¤è¯»ã€‚ 3 å¯é‡å¤è¯» Repeatable Read å®˜ç½‘å¯¹å¹»è¯»å®šä¹‰çš„åœ°å€ phantom A row that appears in the result set of a query, but not in the result set of an earlier query. For example, if a query is run twice within a transaction, and in the meantime, another transaction commits after inserting a new row or updating a row so that it matches the WHERE clause of the query. ç¿»è¯‘è¿‡æ¥å°±æ˜¯ åœ¨ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœé›†é‡Œå‡ºç°äº†æŸä¸€è¡Œæ•°æ®ï¼Œä½†æ˜¯è¯¥æ•°æ®å¹¶æœªå‡ºç°åœ¨æ›´æ—©çš„æŸ¥è¯¢ç»“æœé›†é‡Œã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€æ¬¡äº‹åŠ¡é‡Œè¿›è¡Œäº†ä¸¤æ¬¡æŸ¥è¯¢ï¼ŒåŒæ—¶å¦ä¸€ä¸ªäº‹åŠ¡æ’å…¥æŸä¸€è¡Œæˆ–æ›´æ–°æŸä¸€è¡Œæ•°æ®å(è¯¥æ•°æ®ç¬¦åˆæŸ¥è¯¢è¯­å¥é‡Œwhereåçš„æ¡ä»¶)ï¼Œå¹¶æäº¤äº†ï¼ å¹»è¯»(Phantom Read)è¯´æ˜ åŸå› ï¼šäº‹åŠ¡Aæ ¹æ®ç›¸åŒæ¡ä»¶ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œè™½ç„¶æŸ¥è¯¢ä¸åˆ°äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä½†æ˜¯ä¼šå½±å“äº‹åŠ¡Aä¹‹åçš„ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚ï¼šäº‹åŠ¡Aè¿›è¡Œäº†ä¸€æ¬¡select * from t1è¡¨æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å‡ºidä¸º1çš„æ•°æ®ï¼ŒåŒæ—¶äº‹åŠ¡Bè¿›è¡Œäº†ä¸€æ¬¡insert into t1 values(2,'xx')ï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶è¡¨ä¸­æœ‰äº†idä¸º2çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡Aä¸­å†æ¬¡è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œæ ¹æœ¬å°±æŸ¥ä¸åˆ°idä¸º2çš„æ•°æ®ï¼Œä½†æ˜¯å½“äº‹åŠ¡Aè¿›è¡Œinsert into t1 values(2,'xx')ï¼Œä¹Ÿæƒ³æ’å…¥idä¸º2çš„æ•°æ®çš„æ—¶å€™ï¼Œå‘ç°æŠ¥é”™äº†ï¼Œä½†æ˜¯äº‹åŠ¡Aæ€ä¹ˆæŸ¥ä¹ŸæŸ¥ä¸åˆ°æœ‰idä¸º2çš„æ•°æ®ï¼Œè¿™å°±è®©äº‹åŠ¡Açš„ä½¿ç”¨è€…å‡ºç°äº†å¹»è§‰ï¼Œwhat happendï¼ã€‚å¦‚æœä¸æƒ³å‡ºç°å¹»è¯»é—®é¢˜ï¼Œé‚£ä¹ˆè‡ªå·±åœ¨æŸ¥è¯¢è¯­å¥ä¸­æ‰‹åŠ¨åŠ é” for updateï¼Œå¦‚æœæŸ¥è¯¢çš„æ˜¯idä¸º2çš„æ•°æ®ï¼Œå³ä¾¿æ˜¯ç°åœ¨æ²¡æœ‰idä¸º2çš„æ•°æ®ï¼Œå…¶ä»–äº‹åŠ¡ä¹Ÿæ— æ³•å¯¹idä¸º2çš„ç´¢å¼•ä½ç½®è¿›è¡Œæ•°æ®çš„å¤„ç†ã€‚ å«ä¹‰ï¼šåŒä¸€äº‹åŠ¡çš„å¤šä¸ªå®ä¾‹åœ¨å¹¶å‘è¯»å–æ•°æ®æ—¶ï¼Œä¼šçœ‹åˆ°åŒæ ·çš„æ•°æ®è¡Œ ç¤ºä¾‹ï¼š 1.mysqlé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯RR å¯ç”¨å€¼2æ¥è®¾ç½® mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+-----------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+-----------------+ | REPEATABLE-READ | REPEATABLE-READ | +-----------------------+-----------------+ 1 row in set, 2 warnings (0.00 sec) æ˜¾ç„¶ï¼Œè¯¥ç°è±¡æ˜¯ç¬¦åˆå¹»è¯»çš„å®šä¹‰çš„ã€‚å³åŒä¸€äº‹åŠ¡çš„ä¸¤æ¬¡ç›¸åŒæŸ¥è¯¢å‡ºç°ä¸åŒè¡Œã€‚ å®˜ç½‘å¯¹è§£å†³å¹»è¯»æ–¹æ³•çš„åœ°å€ åŸæ–‡å†…å®¹å¦‚ä¸‹ By default, InnoDB operates in REPEATABLE READ transaction isolation level. In this case, InnoDB uses next-key locks for searches and index scans, which prevents phantom rows (see Section 14.7.4, â€œPhantom Rowsâ€). ç¿»è¯‘è¿‡æ¥å°±æ˜¯ InnoDBé»˜è®¤ç”¨äº†REPEATABLE READã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨next-key locksè§£å†³å¹»è¯»é—®é¢˜ï¼ ä»¥ä¸‹ä¸¤æ­¥å‡åœ¨session2ä¸­æ‰§è¡Œï¼Œæ­£ç¡®ç»“æœæ˜¯idä¸º1çš„æ•°æ®nameå·²ç»æ”¹ä¸ºabc ä¸åŠ next-key locksæ˜¯å¿«ç…§è¯»ï¼Œæ ¹æœ¬ä¸èƒ½è§£å†³å¹»è¯»é—®é¢˜ mysql> select * from t1; +----+----------+ | id | name | +----+----------+ | 1 | xiaoming | | 2 | hehe | +----+----------+ 2 rows in set (0.09 sec) åŠ ä¸Šnext-key lockså°±èƒ½è§£å†³å¹»è¯»é—®é¢˜ mysql> select * from t1 lock in share mode; +----+------+ | id | name | +----+------+ | 1 | abc | | 2 | hehe | +----+------+ 2 rows in set (0.05 sec) 4 ä¸²è¡ŒåŒ– Serializable Read åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ‰€æœ‰çš„selectè¯­å¥åéƒ½è‡ªåŠ¨åŠ ä¸Šlock in share modeã€‚å› æ­¤ï¼Œåœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ— è®ºä½ å¦‚ä½•è¿›è¡ŒæŸ¥è¯¢ï¼Œéƒ½ä¼šä½¿ç”¨next-key locksã€‚æ‰€æœ‰çš„selectæ“ä½œå‡ä¸ºå½“å‰è¯»! å«ä¹‰ï¼šå¼ºåˆ¶äº‹åŠ¡æ’åºï¼Œä½¿ä¹‹ä¸å¯èƒ½ç›¸äº’å†²çª ç¤ºä¾‹ï¼š 1.mysqlé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯RR å¯ç”¨å€¼2æ¥è®¾ç½® mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+-----------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+-----------------+ | REPEATABLE-READ | REPEATABLE-READ | +-----------------------+-----------------+ 1 row in set, 2 warnings (0.00 sec) 2.æ‰‹åŠ¨ä¿®æ”¹å½“å‰ä¼šè¯ä¸ºä¸²è¡Œè¯» mysql> SET @@session.tx_isolation = 3; Query OK, 0 rows affected, 1 warning (0.12 sec) mysql> select @@tx_isolation; +----------------+ | @@tx_isolation | +----------------+ | READ-COMMITTED | +----------------+ 1 row in set, 1 warning (0.04 sec) 3.å…³é—­è‡ªåŠ¨æäº¤ mysql> set autocommit = 0; Query OK, 0 rows affected (0.08 sec) OK,æ³¨æ„çœ‹ä¸Šè¡¨çº¢è‰²éƒ¨åˆ†ï¼å°±æ˜¯å› ä¸ºä½¿ç”¨äº†next-key locks,innodbå°†PiD=1è¿™æ¡ç´¢å¼•è®°å½•ï¼Œå’Œ(1,++âˆ)è¿™ä¸ªé—´éš™é”ä½äº†ã€‚å…¶ä»–äº‹åŠ¡è¦åœ¨è¿™ä¸ªé—´éš™ä¸Šæ’æ•°æ®ï¼Œå°±ä¼šé˜»å¡ï¼Œä»è€Œé˜²æ­¢å¹»è¯»å‘ç”Ÿ! æœ‰çš„äººä¼šè¯´ï¼Œä½ è¿™ç¬¬äºŒæ¬¡æŸ¥è¯¢çš„ç»“æœï¼Œä¹Ÿå˜äº†å•Šï¼Œæ˜æ˜¾å’Œç¬¬ä¸€æ¬¡æŸ¥è¯¢ç»“æœä¸ä¸€æ ·å•Šï¼Ÿä½†æ˜¯è¿™æ˜¯è¢«è‡ªå·±çš„äº‹åŠ¡æ”¹çš„ï¼Œä¸æ˜¯è¢«å…¶ä»–äº‹ç‰©ä¿®æ”¹çš„ã€‚è¿™ä¸ç®—æ˜¯å¹»è¯»ï¼Œä¹Ÿä¸æ˜¯ä¸å¯é‡å¤è¯»ã€‚ è„è¯»ã€ä¸å¯é‡å¤åº¦ã€å¹»è¯» æ ¹æ®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ä¸åŒï¼Œä¼šæœ‰ä¸‰ç§æƒ…å†µå‘ç”Ÿï¼Œå³è„è¯»ã€ä¸å¯é‡å¤åº¦ã€å¹»è¯»ï¼Œè¿™ä¸‰ç§æƒ…å†µæœ‰å¦‚ä¸‹åŒ…å«å…³ç³» å¯¹ä¸Šå›¾è§£é‡Š å¦‚æœå‘ç”Ÿäº†è„è¯»ï¼Œé‚£ä¹ˆä¸å¯é‡å¤è¯»å’Œå¹»è¯»æ˜¯ä¸€å®šå‘ç”Ÿçš„ã€‚å› ä¸ºæ‹¿è„è¯»çš„ç°è±¡ï¼Œç”¨ä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»çš„å®šä¹‰ä¹Ÿèƒ½è§£é‡Šçš„é€šã€‚ä½†æ˜¯åè¿‡æ¥ï¼Œæ‹¿ä¸å¯é‡å¤è¯»çš„ç°è±¡ï¼Œç”¨è„è¯»çš„å®šä¹‰å°±ä¸ä¸€å®šè§£é‡Šçš„é€šäº†ï¼ mysqläº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹åº”çš„ç°è±¡ éš”ç¦»çº§åˆ« å¯¹åº”å€¼ è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» READ-UNCOMMITTEDï¼ˆè¯»æœªæäº¤ï¼‰ 0 âˆš âˆš âˆš READ-COMMITTEDï¼ˆè¯»æäº¤ï¼‰ 1 Ã— âˆš âˆš REPEATABLE-READï¼ˆå¯é‡å¤è¯»ï¼‰ 2 Ã— Ã— âˆš SERIALIZABLE ï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰ 3 Ã— Ã— Ã— è„è¯» å®šä¹‰ å®˜ç½‘å¯¹è„è¯»å®šä¹‰çš„åœ°å€ å…¶å†…å®¹ä¸º dirty read An operation that retrieves unreliable data, data that was updated by another transaction but not yet committed. ç¿»è¯‘è¿‡æ¥å°±æ˜¯ æ£€ç´¢æ“ä½œå‡ºæ¥çš„æ•°æ®æ˜¯ä¸å¯é çš„ï¼Œæ˜¯å¯ä»¥è¢«å¦ä¸€ä¸ªæœªæäº¤çš„äº‹åŠ¡ä¿®æ”¹çš„ï¼ æ ¹æ®æˆ‘ä»¬æœ€å¼€å§‹çš„æ¨ç†ï¼Œå¦‚æœå­˜åœ¨è„è¯»ï¼Œé‚£ä¹ˆä¸å¯é‡å¤è¯»å’Œå¹»è¯»ä¸€å®šæ˜¯å­˜åœ¨çš„ã€‚ ç¤ºä¾‹ æ–°å»ºä¸€å¼ è¡¨ï¼Œå¹¶ä¸”éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºè¯»æœªæäº¤ READ-UNCOMMITTED 1.æ–°å»ºè¡¨t1 mysql> create table t1(id int primary key,name char(30),money double); Query OK, 0 rows affected (0.01 sec) 2.æ’å…¥æ•°æ® mysql> insert into t1 values(1,'xiaoming',100); Query OK, 1 row affected (0.00 sec) 3.è®¾ç½®å½“å‰ä¼šè¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºè¯»æœªæäº¤ READ-UNCOMMITTED mysql> SET @@session.tx_isolation = 'READ-UNCOMMITTED'; Query OK, 0 rows affected, 1 warning (0.00 sec) 4.æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ« globalæ˜¯å…¨å±€ sessionæ˜¯ä¼šè¯ mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+------------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+------------------+ | REPEATABLE-READ | READ-UNCOMMITTED | +-----------------------+------------------+ 1 row in set, 2 warnings (0.00 sec) 5.å…³é—­è‡ªåŠ¨æäº¤ mysql> set @@autocommit = 0; Query OK, 0 rows affected (0.00 sec) 6.æŸ¥çœ‹è‡ªåŠ¨æäº¤æ˜¯å¦å…³é—­ï¼Œ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ mysql> select @@autocommit; +--------------+ | @@autocommit | +--------------+ | 0 | +--------------+ 1 row in set (0.00 sec) è„è¯»å®šä¹‰ æ£€ç´¢æ“ä½œå‡ºæ¥çš„æ•°æ®æ˜¯ä¸å¯é çš„ï¼Œæ˜¯å¯ä»¥è¢«å¦ä¸€ä¸ªæœªæäº¤çš„äº‹åŠ¡ä¿®æ”¹çš„ï¼ ä¸Šå›¾ä¸­çš„ç¤ºä¾‹session2ä¸­æŸ¥è¯¢çš„æ•°æ®æ˜¯ä¸å¯é çš„ï¼Œè¢«æœªæäº¤çš„äº‹ç‰©session1ä¿®æ”¹äº†ï¼Œè¿™å°±æ˜¯è„è¯» ä¸¾ä¸ªä¾‹å­æè¿°ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œè´¢åŠ¡(session1)ç»™å°æ˜(session2)å‘äº†100å…ƒå·¥èµ„ï¼Œç„¶åå°æ˜æŸ¥è¯¢è‡ªå·±çš„è´¦æˆ·ï¼Œæœç„¶æ˜¯å¤šäº†100å…ƒï¼Œå˜æˆäº†200å…ƒï¼Œä½†æ˜¯è´¢åŠ¡å‘ç°æ“ä½œæœ‰è¯¯ï¼Œé€‰æ‹©äº†äº‹åŠ¡å›æ»šï¼Œè¿™ä¸ªæ—¶å€™å½“å°æ˜å†æŸ¥è¯¢è‡ªå·±è´¦æˆ·çš„æ—¶å€™ï¼Œå‘ç°è´¦æˆ·å˜æˆäº†100å…ƒ ä¸å¯é‡å¤è¯» å®šä¹‰ å®˜ç½‘å¯¹ä¸å¯é‡å¤è¯»å®šä¹‰çš„åœ°å€ å…¶å†…å®¹ä¸º non-repeatable read The situation when a query retrieves data, and a later query within the same transaction retrieves what should be the same data, but the queries return different results (changed by another transaction committing in the meantime). ç¿»è¯‘è¿‡æ¥å°±æ˜¯ ä¸€ä¸ªæŸ¥è¯¢è¯­å¥æ£€ç´¢æ•°æ®ï¼Œéšååˆæœ‰ä¸€ä¸ªæŸ¥è¯¢è¯­å¥åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ£€ç´¢æ•°æ®ï¼Œä¸¤ä¸ªæ•°æ®åº”è¯¥æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å®é™…æƒ…å†µè¿”å›äº†ä¸åŒçš„ç»“æœã€‚ï¼ ps:ä½œè€…æ³¨ï¼Œè¿™é‡Œçš„ä¸åŒç»“æœï¼ŒæŒ‡çš„æ˜¯åœ¨è¡Œä¸å˜çš„æƒ…å†µä¸‹(ä¸“ä¸šç‚¹è¯´ï¼Œä¸»é”®ç´¢å¼•æ²¡å˜)ï¼Œä¸»é”®ç´¢å¼•æŒ‡å‘çš„ç£ç›˜ä¸Šçš„æ•°æ®å†…å®¹å˜äº†ã€‚å¦‚æœä¸»é”®ç´¢å¼•å˜äº†ï¼Œæ¯”å¦‚æ–°å¢ä¸€æ¡æ•°æ®æˆ–è€…åˆ é™¤ä¸€æ¡æ•°æ®ï¼Œå°±ä¸æ˜¯ä¸å¯é‡å¤è¯»ã€‚ æ˜¾ç„¶ï¼Œæˆ‘ä»¬è¿™ä¸ªç°è±¡ç¬¦åˆä¸å¯é‡å¤è¯»çš„å®šä¹‰ã€‚ä¸‹é¢ï¼Œå¤§å®¶åšä¸€ä¸ªæ€è€ƒ: è¿™ä¸ªä¸å¯é‡å¤è¯»çš„å®šä¹‰ï¼Œæ”¾åˆ°è„è¯»çš„ç°è±¡é‡Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¯´çš„é€šã€‚æ˜¾ç„¶è„è¯»çš„ç°è±¡ï¼Œä¹Ÿå°±æ˜¯è¯»æœªæäº¤(READ_UNCOMMITTED)çš„é‚£ä¸ªä¾‹å­ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿç¬¦åˆåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­è¿”å›äº†ä¸åŒç»“æœï¼ ä½†æ˜¯åè¿‡æ¥å°±ä¸ä¸€å®šé€šäº†ï¼Œä¸€ä¸ªäº‹åŠ¡Aä¸­æŸ¥è¯¢ä¸¤æ¬¡çš„ç»“æœåœ¨è¢«å¦ä¸€ä¸ªäº‹åŠ¡Bæ”¹å˜çš„æƒ…å†µä¸‹ï¼Œå¦‚æœäº‹åŠ¡Bæœªæäº¤å°±æ”¹å˜äº†äº‹åŠ¡Açš„ç»“æœï¼Œå°±å±äºè„è¯»ï¼Œä¹Ÿå±äºä¸å¯é‡å¤è¯»ã€‚å¦‚æœè¯¥äº‹åŠ¡Bæäº¤äº†æ‰æ”¹å˜äº‹åŠ¡Açš„ç»“æœï¼Œå°±ä¸å±äºè„è¯»ï¼Œä½†å±äºä¸å¯é‡å¤è¯»ã€‚ ç¤ºä¾‹-è¯»æäº¤ æ–°å»ºä¸€å¼ è¡¨ï¼Œå¹¶ä¸”éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºè¯»æäº¤ READ-COMMITTED 1.æ–°å»ºè¡¨t1 mysql> create table t1(id int primary key,name char(30),money double); Query OK, 0 rows affected (0.01 sec) 2.æ’å…¥æ•°æ® mysql> insert into t1 values(1,'xiaoming',100); Query OK, 1 row affected (0.00 sec) 3.è®¾ç½®å½“å‰ä¼šè¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºè¯»æäº¤ READ-COMMITTED mysql> SET @@session.tx_isolation = 'READ-COMMITTED'; Query OK, 0 rows affected, 1 warning (0.00 sec) 4.æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ« globalæ˜¯å…¨å±€ sessionæ˜¯ä¼šè¯ mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+----------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+----------------+ | REPEATABLE-READ | READ-COMMITTED | +-----------------------+----------------+ 1 row in set, 2 warnings (0.00 sec) 5.å…³é—­è‡ªåŠ¨æäº¤ mysql> set @@autocommit = 0; Query OK, 0 rows affected (0.00 sec) 6.æŸ¥çœ‹è‡ªåŠ¨æäº¤æ˜¯å¦å…³é—­ï¼Œ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ mysql> select @@autocommit; +--------------+ | @@autocommit | +--------------+ | 0 | +--------------+ 1 row in set (0.00 sec) ä¸å¯é‡å¤è¯»æ˜¯æŒ‡åœ¨äº‹åŠ¡1å†…ï¼Œè¯»å–äº†ä¸€ä¸ªæ•°æ®ï¼Œäº‹åŠ¡1è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œäº‹åŠ¡2ä¹Ÿè®¿é—®äº†è¿™ä¸ªæ•°æ®ï¼Œä¿®æ”¹äº†è¿™ä¸ªæ•°æ®ï¼Œå¹¶æäº¤ã€‚ç´§æ¥ç€ï¼Œäº‹åŠ¡1åˆè¯»è¿™ä¸ªæ•°æ®ã€‚ç”±äºäº‹åŠ¡2çš„ä¿®æ”¹ï¼Œé‚£ä¹ˆäº‹åŠ¡1ä¸¤æ¬¡è¯»åˆ°çš„çš„æ•°æ®å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› æ­¤ç§°ä¸ºæ˜¯ä¸å¯é‡å¤è¯»ã€‚ ç¤ºä¾‹-å¯é‡å¤è¯» æ–°å»ºä¸€å¼ è¡¨ï¼Œå¹¶ä¸”éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºå¯é‡å¤è¯» REPEATABLE-READ 1.æ–°å»ºè¡¨t1 mysql> create table t1(id int primary key,name char(30),money double); Query OK, 0 rows affected (0.01 sec) 2.æ’å…¥æ•°æ® mysql> insert into t1 values(1,'xiaoming',100); Query OK, 1 row affected (0.00 sec) 3.è®¾ç½®å½“å‰ä¼šè¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯» REPEATABLE-READ mysql> SET @@session.tx_isolation = 'REPEATABLE-READ'; Query OK, 0 rows affected, 1 warning (0.00 sec) 4.æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ« globalæ˜¯å…¨å±€ sessionæ˜¯ä¼šè¯ mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+-----------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+-----------------+ | REPEATABLE-READ | REPEATABLE-READ | +-----------------------+-----------------+ 1 row in set, 2 warnings (0.00 sec) 5.å…³é—­è‡ªåŠ¨æäº¤ mysql> set @@autocommit = 0; Query OK, 0 rows affected (0.00 sec) 6.æŸ¥çœ‹è‡ªåŠ¨æäº¤æ˜¯å¦å…³é—­ï¼Œ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ mysql> select @@autocommit; +--------------+ | @@autocommit | +--------------+ | 0 | +--------------+ 1 row in set (0.00 sec) ä¸Šè¿°ç¤ºä¾‹è¯´æ˜å½“æˆ‘ä»¬å°†å½“å‰ä¼šè¯çš„éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºå¯é‡å¤è¯»çš„æ—¶å€™ï¼Œå½“å‰ä¼šè¯å¯ä»¥é‡å¤è¯»ï¼Œå°±æ˜¯æ¯æ¬¡è¯»å–çš„ç»“æœé›†éƒ½ç›¸åŒï¼Œè€Œä¸ç®¡å…¶ä»–äº‹åŠ¡æœ‰æ²¡æœ‰æäº¤ã€‚ å½“session1 commitçš„æ—¶å€™ï¼Œæ‰èƒ½çœ‹åˆ°æœ€ç»ˆçš„æ­£ç¡®ç»“æœï¼Œè¿™ä¼šäº§ç”Ÿå¹»è¯» å¹»è¯» å®šä¹‰ å®˜ç½‘å¯¹å¹»è¯»å®šä¹‰çš„åœ°å€ phantom A row that appears in the result set of a query, but not in the result set of an earlier query. For example, if a query is run twice within a transaction, and in the meantime, another transaction commits after inserting a new row or updating a row so that it matches the WHERE clause of the query. ç¿»è¯‘è¿‡æ¥å°±æ˜¯ åœ¨ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœé›†é‡Œå‡ºç°äº†æŸä¸€è¡Œæ•°æ®ï¼Œä½†æ˜¯è¯¥æ•°æ®å¹¶æœªå‡ºç°åœ¨æ›´æ—©çš„æŸ¥è¯¢ç»“æœé›†é‡Œã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€æ¬¡äº‹åŠ¡é‡Œè¿›è¡Œäº†ä¸¤æ¬¡æŸ¥è¯¢ï¼ŒåŒæ—¶å¦ä¸€ä¸ªäº‹åŠ¡æ’å…¥æŸä¸€è¡Œæˆ–æ›´æ–°æŸä¸€è¡Œæ•°æ®å(è¯¥æ•°æ®ç¬¦åˆæŸ¥è¯¢è¯­å¥é‡Œwhereåçš„æ¡ä»¶)ï¼Œå¹¶æäº¤äº†ï¼ å¤§ç™½è¯è¯´æ˜ä¸€ä¸‹ æ‰€è°“å¹»è¯»ï¼ŒæŒ‡çš„æ˜¯å½“æŸä¸ªäº‹åŠ¡åœ¨è¯»å–æŸä¸ªèŒƒå›´å†…çš„è®°å½•æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡åˆåœ¨è¯¥èŒƒå›´å†…æ’å…¥äº†æ–°çš„è®°å½•ï¼Œå½“ä¹‹å‰çš„äº‹åŠ¡å†æ¬¡è¯»å–è¯¥èŒƒå›´çš„è®°å½•æ—¶ï¼Œä¼šäº§ç”Ÿå¹»è¯» å°±æ˜¯äº‹åŠ¡1æŸ¥è¯¢id å¹»è¯»(Phantom Read)åŸå›  åŸå› ï¼šäº‹åŠ¡Aæ ¹æ®ç›¸åŒæ¡ä»¶ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œè™½ç„¶æŸ¥è¯¢ä¸åˆ°äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä½†æ˜¯ä¼šå½±å“äº‹åŠ¡Aä¹‹åçš„ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚ï¼šäº‹åŠ¡Aè¿›è¡Œäº†ä¸€æ¬¡select * from t1è¡¨æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å‡ºidä¸º1çš„æ•°æ®ï¼ŒåŒæ—¶äº‹åŠ¡Bè¿›è¡Œäº†ä¸€æ¬¡insert into t1 values(2,'xx')ï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶è¡¨ä¸­æœ‰äº†idä¸º2çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡Aä¸­å†æ¬¡è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œæ ¹æœ¬å°±æŸ¥ä¸åˆ°idä¸º2çš„æ•°æ®ï¼Œä½†æ˜¯å½“äº‹åŠ¡Aè¿›è¡Œinsert into t1 values(2,'xx')ï¼Œä¹Ÿæƒ³æ’å…¥idä¸º2çš„æ•°æ®çš„æ—¶å€™ï¼Œå‘ç°æŠ¥é”™äº†ï¼Œä½†æ˜¯äº‹åŠ¡Aæ€ä¹ˆæŸ¥ä¹ŸæŸ¥ä¸åˆ°æœ‰idä¸º2çš„æ•°æ®ï¼Œè¿™å°±è®©äº‹åŠ¡Açš„ä½¿ç”¨è€…å‡ºç°äº†å¹»è§‰ï¼Œwhat happendï¼ã€‚å¦‚æœä¸æƒ³å‡ºç°å¹»è¯»é—®é¢˜ï¼Œé‚£ä¹ˆè‡ªå·±åœ¨æŸ¥è¯¢è¯­å¥ä¸­æ‰‹åŠ¨åŠ é” for updateï¼Œå¦‚æœæŸ¥è¯¢çš„æ˜¯idä¸º2çš„æ•°æ®ï¼Œå³ä¾¿æ˜¯ç°åœ¨æ²¡æœ‰idä¸º2çš„æ•°æ®ï¼Œå…¶ä»–äº‹åŠ¡ä¹Ÿæ— æ³•å¯¹idä¸º2çš„ç´¢å¼•ä½ç½®è¿›è¡Œæ•°æ®çš„å¤„ç†ã€‚ å®˜ç½‘å¯¹è§£å†³å¹»è¯»æ–¹æ³•çš„åœ°å€ åŸæ–‡å†…å®¹å¦‚ä¸‹ By default, InnoDB operates in REPEATABLE READ transaction isolation level. In this case, InnoDB uses next-key locks for searches and index scans, which prevents phantom rows (see Section 14.7.4, â€œPhantom Rowsâ€). ç¿»è¯‘è¿‡æ¥å°±æ˜¯ InnoDBé»˜è®¤ç”¨äº†REPEATABLE READã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨next-key locksè§£å†³å¹»è¯»é—®é¢˜ï¼ ç¤ºä¾‹ æ–°å»ºä¸€å¼ è¡¨ï¼Œå¹¶ä¸”éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºå¯é‡å¤è¯» REPEATABLE-READ 1.æ–°å»ºè¡¨t1 mysql> create table t1(id int primary key,name char(30),money double); Query OK, 0 rows affected (0.01 sec) 2.æ’å…¥æ•°æ® mysql> insert into t1 values(1,'xiaoming',100); Query OK, 1 row affected (0.00 sec) 3.è®¾ç½®å½“å‰ä¼šè¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯» REPEATABLE-READ mysql> SET @@session.tx_isolation = 'REPEATABLE-READ'; Query OK, 0 rows affected, 1 warning (0.00 sec) 4.æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ« globalæ˜¯å…¨å±€ sessionæ˜¯ä¼šè¯ mysql> SELECT @@global.tx_isolation, @@tx_isolation; +-----------------------+-----------------+ | @@global.tx_isolation | @@tx_isolation | +-----------------------+-----------------+ | REPEATABLE-READ | REPEATABLE-READ | +-----------------------+-----------------+ 1 row in set, 2 warnings (0.00 sec) 5.å…³é—­è‡ªåŠ¨æäº¤ mysql> set @@autocommit = 0; Query OK, 0 rows affected (0.00 sec) 6.æŸ¥çœ‹è‡ªåŠ¨æäº¤æ˜¯å¦å…³é—­ï¼Œ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ mysql> select @@autocommit; +--------------+ | @@autocommit | +--------------+ | 0 | +--------------+ 1 row in set (0.00 sec) ä¸åŠ next-key locksæ˜¯å¿«ç…§è¯»ï¼Œæ ¹æœ¬ä¸èƒ½è§£å†³å¹»è¯»é—®é¢˜ mysql> select * from t1; +----+----------+-------+ | id | name | money | +----+----------+-------+ | 1 | xiaoming | 100 | +----+----------+-------+ 1 row in set (0.00 sec) åŠ ä¸Šnext-key lockså°±èƒ½è§£å†³å¹»è¯»é—®é¢˜ mysql> select * from t1 lock in share mode; +----+----------+-------+ | id | name | money | +----+----------+-------+ | 1 | xiaoming | 100 | | 2 | dahong | 500 | +----+----------+-------+ 2 rows in set (0.00 sec) mysql> select * from t1 for update; +----+----------+-------+ | id | name | money | +----+----------+-------+ | 1 | xiaoming | 100 | | 2 | dahong | 500 | +----+----------+-------+ 2 rows in set (0.00 sec) å¾ˆå¤šäººå®¹æ˜“ææ··ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼Œç¡®å®è¿™ä¸¤è€…æœ‰äº›ç›¸ä¼¼ã€‚ä½†ä¸å¯é‡å¤è¯»é‡ç‚¹åœ¨äºupdateå’Œdeleteï¼Œè€Œå¹»è¯»çš„é‡ç‚¹åœ¨äºinsertã€‚ æ€»çš„æ¥è¯´å¹»è¯»å°±æ˜¯äº‹åŠ¡Aå¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼Œäº‹åŠ¡Bè¿˜æ˜¯å¯ä»¥ç”¨insertæ’å…¥æ•°æ®çš„ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯è¡Œé”ï¼Œè¿™æ ·å¯¼è‡´çš„å„ç§å¥‡è‘©é—®é¢˜å°±æ˜¯å¹»è¯» æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/1.CentOS7.5å®‰è£…redis-5.0.7.html":{"url":"db/redis/1.CentOS7.5å®‰è£…redis-5.0.7.html","title":"rediså®‰è£…","keywords":"","body":"CentOS7.5å®‰è£…redis-5.0.7 rediså®˜ç½‘ å®˜ç½‘ä¸‹è½½åœ°å€ ä¸€ã€ä¸‹è½½redis wget http://download.redis.io/releases/redis-5.0.7.tar.gz äºŒã€ç¼–è¯‘å®‰è£…redis //å°†ä¸‹è½½çš„redisåŒ…è§£å‹åˆ°/usr/local tar xf redis-5.0.7.tar.gz -C /usr/local //è¿›å…¥è§£å‹åçš„redisç›®å½•è¿›è¡Œç¼–è¯‘å®‰è£… cd /usr/local/redis-5.0.7 make //æ·»åŠ ç¯å¢ƒå˜é‡ cat >/etc/profile.d/redis.sh ä¸‰ã€é…ç½®redis //åˆ›å»ºrediså·¥ä½œç›®å½• mkdir -p /etc/redis/6379 mkdir -p /var/log/redis/6379 mkdir -p /var/run/redis/6379 //åˆ›å»ºredisé…ç½®æ–‡ä»¶ cat >/etc/redis/6379/redis.conf å››ã€ä½¿ç”¨systemdç®¡ç†redis âš ï¸#ä½¿ç”¨redisäºŒè¿›åˆ¶å‘½ä»¤å¯åŠ¨redis /usr/local/redis-5.0.7/src/redis-server & //ç¼–è¾‘æ–‡ä»¶ cat >/usr/lib/systemd/system/redis.service è¿™è¾¹å¹¶æ²¡æœ‰ä½¿ç”¨ ExecStop=/bin/kill -s QUIT $MAINPID è¿™æ ·çš„å‘½ä»¤æ¥åœæ­¢redis, å› ä¸ºä½¿ç”¨è¿™ä¸ªè¯­å¥åœ¨è¿è¡Œsystemctl stop rediså, rediså¹¶æœªæ‰§è¡Œå…³é—­åŠ¨ä½œ, è€Œæ˜¯ç›´æ¥é€€å‡º. è¿™æ—¶å€™ç”¨ systemctl status redis æŸ¥çœ‹çŠ¶æ€æ˜¯failed. åªæœ‰ç”¨ExecStop=/install_path/bin/redis-cli -p 16379 shutdown æ‰èƒ½æ­£ç¡®åœæ­¢redis äº”ã€ä½¿ç”¨systemdç®¡ç†redisé‡åˆ°çš„é—®é¢˜ é—®é¢˜ä¸€ï¼šé‡è½½ç³»ç»ŸæœåŠ¡åå¯åŠ¨rediså¡ä½ä¸åŠ¨ è§£å†³æ–¹æ³• æ³¨é‡Š/usr/lib/systemd/system/redis.serviceType=forkingä¸€é¡¹ ç½‘ä¸Šè§£é‡ŠåŸå›  If set to forking, it is expected that the process configured with ExecStart= will call fork() as part of its start-up. The parent process is expected to exit when start-up is complete and all communication channels are set up. The child continues to run as the main daemon process. This is the behavior of traditional UNIX daemons. If this setting is used, it is recommended to also use the PIDFile= option, so that systemd can identify the main process of the daemon. systemd will proceed with starting follow-up units as soon as the parent process exits. å¦‚æœè®¾ç½®ä¸ºforkï¼Œåˆ™ä½¿ç”¨ExecStart=é…ç½®çš„è¿›ç¨‹å°†è°ƒç”¨fork()ä½œä¸ºå¯åŠ¨çš„ä¸€éƒ¨åˆ†ã€‚å¯åŠ¨å®Œæˆå¹¶è®¾ç½®å¥½æ‰€æœ‰é€šä¿¡é€šé“åï¼Œçˆ¶è¿›ç¨‹å°†é€€å‡ºã€‚å­è¿›ç¨‹ç»§ç»­ä½œä¸ºä¸»å®ˆæŠ¤è¿›ç¨‹è¿è¡Œã€‚è¿™æ˜¯ä¼ ç»ŸUNIXå®ˆæŠ¤è¿›ç¨‹çš„è¡Œä¸ºã€‚å¦‚æœä½¿ç”¨äº†è¯¥è®¾ç½®ï¼Œå»ºè®®è¿˜ä½¿ç”¨PIDFile=é€‰é¡¹ï¼Œä»¥ä¾¿systemdèƒ½å¤Ÿè¯†åˆ«å®ˆæŠ¤è¿›ç¨‹çš„ä¸»è¿›ç¨‹ã€‚ä¸€æ—¦çˆ¶è¿›ç¨‹é€€å‡ºï¼Œsystemdå°†å¼€å§‹å¯åŠ¨åç»­å•å…ƒã€‚ é—®é¢˜äºŒï¼špidåŸå…ˆè·¯å¾„ä¸º/var/run/redis_6379.pidï¼ŒæŠ¥é”™Failed at step EXEC spawning /usr/local/redis-5.0.7/src: Permission denied è§£å†³æ–¹æ³•ï¼š å°†pidè·¯å¾„æ”¹ä¸º/var/run/redis/redis_6379.pidå°±å¯ä»¥äº†ï¼ŒåŸå› æœªçŸ¥ å…­ã€rediså®‰å…¨é…ç½® protected-mode ä¿æŠ¤æ¨¡å¼ï¼Œæ˜¯å¦åªå…è®¸æœ¬åœ°è®¿é—®ï¼Œé»˜è®¤æ˜¯yes protected-mode no bind æŒ‡å®šIPè¿›è¡Œç›‘å¬ bind 127.0.0.1 requirepass å¢åŠ å¯†ç  requirepass 1 #è¿æ¥æ–¹å¼1 $ redis-cli 127.0.0.1:6379> set name xiaoming (error) NOAUTH Authentication required. 127.0.0.1:6379> AUTH 1 OK 127.0.0.1:6379> set name xiaoming OK #è¿æ¥æ–¹å¼2 $ redis-cli -a 1 Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe. 127.0.0.1:6379> set name xiaoliang OK æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/redisæŒä¹…åŒ–.html":{"url":"db/redis/redisæŒä¹…åŒ–.html","title":"redisæŒä¹…åŒ–","keywords":"","body":"redisæŒä¹…åŒ– ä¸€ã€ä»€ä¹ˆæ˜¯æŒä¹…åŒ–ï¼Ÿ æŒä¹…åŒ–ï¼šå°±æ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®ï¼Œå†™å…¥åˆ°ç£ç›˜ä¸Šï¼Œå¹¶ä¸”æ°¸ä¹…å­˜åœ¨ äºŒã€redisæŒä¹…åŒ–ç±»å‹ RDB AOF RDBå’ŒAOFå¯¹æ¯” å®šä¹‰å¯¹æ¯” ä¼˜ç¼ºç‚¹å¯¹æ¯” å·¥ä½œæ–¹å¼å¯¹æ¯” 2.1RDBæŒä¹…åŒ– 2.1.1 RDBæŒä¹…åŒ–ä»‹ç» å¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…ç”Ÿæˆæ•°æ®é›†çš„æ—¶é—´ç‚¹å¿«ç…§ï¼ˆpoint-in-time snapshotï¼‰ 2.1.2 RDBæŒä¹…åŒ–ä¼˜ç‚¹ RDBæ˜¯ä¸€ç§è¡¨ç¤ºæŸä¸ªå³æ—¶ç‚¹çš„Redisæ•°æ®çš„ç´§å‡‘æ–‡ä»¶ã€‚RDBæ–‡ä»¶é€‚åˆç”¨äºå¤‡ä»½ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æƒ³è¦æ¯å°æ—¶å½’æ¡£æœ€è¿‘24å°æ—¶çš„RDBæ–‡ä»¶ï¼Œæ¯å¤©ä¿å­˜è¿‘30å¤©çš„RDBå¿«ç…§ã€‚è¿™å…è®¸ä½ å¾ˆå®¹æ˜“çš„æ¢å¤ä¸åŒç‰ˆæœ¬çš„æ•°æ®é›†ä»¥å®¹ç¾ RDBéå¸¸é€‚åˆäºç¾éš¾æ¢å¤ï¼Œä½œä¸ºä¸€ä¸ªç´§å‡‘çš„å•ä¸€æ–‡ä»¶ï¼Œå¯ä»¥è¢«ä¼ è¾“åˆ°è¿œç¨‹çš„æ•°æ®ä¸­å¿ƒ RDBæœ€å¤§åŒ–äº†Redisçš„æ€§èƒ½ï¼Œå› ä¸ºRedisçˆ¶è¿›ç¨‹æŒä¹…åŒ–æ—¶å”¯ä¸€éœ€è¦åšçš„æ˜¯å¯åŠ¨(fork)ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç”±å­è¿›ç¨‹å®Œæˆæ‰€æœ‰å‰©ä½™å·¥ä½œã€‚çˆ¶è¿›ç¨‹å®ä¾‹ä¸éœ€è¦æ‰§è¡Œåƒç£ç›˜IOè¿™æ ·çš„æ“ä½œ RDBåœ¨é‡å¯ä¿å­˜äº†å¤§æ•°æ®é›†çš„å®ä¾‹æ—¶æ¯”AOFè¦å¿« 2.1.3 RDBæŒä¹…åŒ–ç¼ºç‚¹ å½“ä½ éœ€è¦åœ¨Redisåœæ­¢å·¥ä½œ(ä¾‹å¦‚åœç”µ)æ—¶æœ€å°åŒ–æ•°æ®ä¸¢å¤±ï¼ŒRDBå¯èƒ½ä¸å¤ªå¥½ã€‚ä½ å¯ä»¥é…ç½®ä¸åŒçš„ä¿å­˜ç‚¹(save point)æ¥ä¿å­˜RDBæ–‡ä»¶(ä¾‹å¦‚ï¼Œè‡³å°‘5åˆ†é’Ÿå’Œå¯¹æ•°æ®é›†100æ¬¡å†™ä¹‹åï¼Œä½†æ˜¯ä½ å¯ä»¥æœ‰å¤šä¸ªä¿å­˜ç‚¹)ã€‚ç„¶è€Œï¼Œä½ é€šå¸¸æ¯éš”5åˆ†é’Ÿæˆ–æ›´ä¹…åˆ›å»ºä¸€ä¸ªRDBå¿«ç…§ï¼Œæ‰€ä»¥ä¸€æ—¦Rediså› ä¸ºä»»ä½•åŸå› æ²¡æœ‰æ­£ç¡®å…³é—­è€Œåœæ­¢å·¥ä½œï¼Œä½ å°±å¾—åšå¥½æœ€è¿‘å‡ åˆ†é’Ÿæ•°æ®ä¸¢å¤±çš„å‡†å¤‡äº† RDBéœ€è¦ç»å¸¸è°ƒç”¨fork()å­è¿›ç¨‹æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å¦‚æœæ•°æ®é›†å¾ˆå¤§çš„è¯ï¼Œfork()æ¯”è¾ƒè€—æ—¶ï¼Œç»“æœå°±æ˜¯ï¼Œå½“æ•°æ®é›†éå¸¸å¤§å¹¶ä¸”CPUæ€§èƒ½ä¸å¤Ÿå¼ºå¤§çš„è¯ï¼ŒRedisä¼šåœæ­¢æœåŠ¡å®¢æˆ·ç«¯å‡ æ¯«ç§’ç”šè‡³ä¸€ç§’ã€‚AOFä¹Ÿéœ€è¦fork()ï¼Œä½†æ˜¯ä½ å¯ä»¥è°ƒæ•´å¤šä¹…é¢‘ç‡é‡å†™æ—¥å¿—è€Œä¸ä¼šæœ‰æŸ(trade-off)æŒä¹…æ€§(durability) 2.1.4 RDBæŒä¹…åŒ–ä¼˜ç¼ºç‚¹æ€»ç»“ ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ï¼Œé€‚åˆäºç”¨ä½œå¤‡ä»½ï¼Œä¸»ä»å¤åˆ¶ä¹Ÿæ˜¯åŸºäºRDBæŒä¹…åŒ–åŠŸèƒ½å®ç°çš„ ç¼ºç‚¹ï¼šä¼šæœ‰æ•°æ®ä¸¢å¤±ã€å¯¼è‡´æœåŠ¡åœæ­¢å‡ ç§’ 2.1.5 RDBæŒä¹…åŒ–é…ç½®å‚æ•° RDBæŒä¹…åŒ–æ ¸å¿ƒé…ç½®å‚æ•° #æŒä¹…åŒ–æ•°æ®æ–‡ä»¶å­˜å‚¨ä½ç½® dir /etc/redis/6379 #rdbæŒä¹…åŒ–æ•°æ®æ–‡ä»¶å dbfilename dump.rdb #900ç§’ï¼ˆ15åˆ†é’Ÿï¼‰å†…æœ‰1ä¸ªæ›´æ”¹ save 900 1 #300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰å†…æœ‰10ä¸ªæ›´æ”¹ save 300 10 #60ç§’ï¼ˆ1åˆ†é’Ÿï¼‰å†…æœ‰10000ä¸ªæ›´æ”¹ save 60 10000 é…ç½®RDBæŒä¹…åŒ– âš ï¸saveè¿™é‡Œè¿™æ˜¯åšæ¼”ç¤ºï¼Œè¿˜æ˜¯è¦æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè¿›è¡Œä¿®æ”¹ï¼Œä¾‹å¦‚æˆ‘ä»¬çº¿ä¸Šä¸»æµçš„é…ç½®æ˜¯ 7200 10 1.ç¼–è¾‘é…ç½®æ–‡ä»¶ cat > /etc/redis/6379/redis.conf SHUTDOWN not connected> #æŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨ redis-server /etc/redis/6379/redis.conf 3.å†™å…¥æ•°æ® #è¿æ¥redisï¼Œå¦‚æœè®¾ç½®äº†å¯†ç ï¼Œä½¿ç”¨-aå‚æ•° redis-cli 127.0.0.1:6379> set a 1 OK 127.0.0.1:6379> set b 2 OK 4.æ‰‹åŠ¨ä¿å­˜RDBæŒä¹…åŒ– 127.0.0.1:6379> BGSAVE Background saving started 5.æŸ¥çœ‹RDBæŒä¹…åŒ–æ–‡ä»¶ dump.rdbå°±æ˜¯RDBæŒä¹…åŒ–æ–‡ä»¶ $ ll total 16 -rw-r--r-- 1 root root 92 Dec 10 19:31 dump.rdb -rw-r--r-- 1 root root 410 Dec 10 19:22 redis.conf -rw-r--r-- 1 root root 4314 Dec 10 19:31 redis.log 2.2AOFæŒä¹…åŒ– 2.2.1 AOFæŒä¹…åŒ–ä»‹ç» AOFï¼ˆappend only fileï¼‰åªè¿½åŠ æ–‡ä»¶ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™æ“ä½œå‘½ä»¤ï¼Œå¹¶åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œé€šè¿‡é‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥è¿˜åŸæ•°æ®é›†ã€‚ AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤å…¨éƒ¨ä»¥ Redis åè®®çš„æ ¼å¼æ¥ä¿å­˜ï¼Œæ–°å‘½ä»¤ä¼šè¢«è¿½åŠ åˆ°æ–‡ä»¶çš„æœ«å°¾ AOFæŒä¹…åŒ–åŸç† 2.2.2 AOFæŒä¹…åŒ–ä¼˜ç‚¹ ä½¿ç”¨AOF Redisä¼šæ›´å…·æœ‰å¯æŒä¹…æ€§(durable)ï¼šä½ å¯ä»¥æœ‰å¾ˆå¤šä¸åŒçš„fsyncç­–ç•¥ï¼šæ²¡æœ‰fsyncï¼Œæ¯ç§’fsyncï¼Œæ¯æ¬¡è¯·æ±‚æ—¶fsyncã€‚ä½¿ç”¨é»˜è®¤çš„æ¯ç§’fsyncç­–ç•¥ï¼Œå†™æ€§èƒ½ä¹Ÿä»ç„¶å¾ˆä¸é”™(fsyncæ˜¯ç”±åå°çº¿ç¨‹å®Œæˆçš„ï¼Œä¸»çº¿ç¨‹ç»§ç»­åŠªåŠ›åœ°æ‰§è¡Œå†™è¯·æ±‚)ï¼Œå³ä¾¿ä½ ä¹Ÿå°±ä»…ä»…åªæŸå¤±ä¸€ç§’é’Ÿçš„å†™æ•°æ® AOFæ—¥å¿—æ˜¯ä¸€ä¸ªè¿½åŠ æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸éœ€è¦å®šä½ï¼Œåœ¨æ–­ç”µæ—¶ä¹Ÿæ²¡æœ‰æŸåé—®é¢˜ã€‚å³ä½¿ç”±äºæŸç§åŸå› æ–‡ä»¶æœ«å°¾æ˜¯ä¸€ä¸ªå†™åˆ°ä¸€åŠçš„å‘½ä»¤(ç£ç›˜æ»¡æˆ–è€…å…¶ä»–åŸå› ),redis-check-aofå·¥å…·ä¹Ÿå¯ä»¥å¾ˆè½»æ˜“çš„ä¿®å¤ å½“AOFæ–‡ä»¶å˜å¾—å¾ˆå¤§æ—¶ï¼ŒRedisä¼šè‡ªåŠ¨åœ¨åå°è¿›è¡Œé‡å†™ã€‚é‡å†™æ˜¯ç»å¯¹å®‰å…¨çš„ï¼Œå› ä¸ºRedisç»§ç»­å¾€æ—§çš„æ–‡ä»¶ä¸­è¿½åŠ ï¼Œä½¿ç”¨åˆ›å»ºå½“å‰æ•°æ®é›†æ‰€éœ€çš„æœ€å°æ“ä½œé›†åˆæ¥åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æ–‡ä»¶ï¼Œä¸€æ—¦ç¬¬äºŒä¸ªæ–‡ä»¶åˆ›å»ºå®Œæ¯•ï¼ŒRediså°±ä¼šåˆ‡æ¢è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¹¶å¼€å§‹å¾€æ–°æ–‡ä»¶è¿½åŠ  AOFæ–‡ä»¶é‡Œé¢åŒ…å«ä¸€ä¸ªæ¥ä¸€ä¸ªçš„æ“ä½œï¼Œä»¥æ˜“äºç†è§£å’Œè§£æçš„æ ¼å¼å­˜å‚¨ã€‚ä½ ä¹Ÿå¯ä»¥è½»æ˜“çš„å¯¼å‡ºä¸€ä¸ªAOFæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå³ä½¿ä½ ä¸å°å¿ƒé”™è¯¯åœ°ä½¿ç”¨FLUSHALLå‘½ä»¤æ¸…ç©ºä¸€åˆ‡ï¼Œå¦‚æœæ­¤æ—¶å¹¶æ²¡æœ‰æ‰§è¡Œé‡å†™ï¼Œä½ ä»ç„¶å¯ä»¥ä¿å­˜ä½ çš„æ•°æ®é›†ï¼Œä½ åªè¦åœæ­¢æœåŠ¡å™¨ï¼Œåˆ é™¤æœ€åä¸€æ¡å‘½ä»¤ï¼Œç„¶åé‡å¯Rediså°±å¯ä»¥ 2.2.3 AOFæŒä¹…åŒ–ç¼ºç‚¹ å¯¹åŒæ ·çš„æ•°æ®é›†ï¼ŒAOFæ–‡ä»¶é€šå¸¸è¦å¤§äºç­‰ä»·çš„RDBæ–‡ä»¶ AOFå¯èƒ½æ¯”RDBæ…¢ï¼Œè¿™å–å†³äºå‡†ç¡®çš„fsyncç­–ç•¥ã€‚é€šå¸¸fsyncè®¾ç½®ä¸ºæ¯ç§’ä¸€æ¬¡çš„è¯æ€§èƒ½ä»ç„¶å¾ˆé«˜ï¼Œå¦‚æœå…³é—­fsyncï¼Œå³ä½¿åœ¨å¾ˆé«˜çš„è´Ÿè½½ä¸‹ä¹Ÿå’ŒRDBä¸€æ ·çš„å¿«ã€‚ä¸è¿‡ï¼Œå³ä½¿åœ¨å¾ˆå¤§çš„å†™è´Ÿè½½æƒ…å†µä¸‹ï¼ŒRDBè¿˜æ˜¯èƒ½æä¾›èƒ½å¥½çš„æœ€å¤§å»¶è¿Ÿä¿è¯ åœ¨è¿‡å»ï¼Œæˆ‘ä»¬ç»å†äº†ä¸€äº›é’ˆå¯¹ç‰¹æ®Šå‘½ä»¤(ä¾‹å¦‚ï¼ŒåƒBRPOPLPUSHè¿™æ ·çš„é˜»å¡å‘½ä»¤)çš„ç½•è§bugï¼Œå¯¼è‡´åœ¨æ•°æ®åŠ è½½æ—¶æ— æ³•æ¢å¤åˆ°ä¿å­˜æ—¶çš„æ ·å­ã€‚è¿™äº›bugå¾ˆç½•è§ï¼Œæˆ‘ä»¬ä¹Ÿåœ¨æµ‹è¯•å¥—ä»¶ä¸­è¿›è¡Œäº†æµ‹è¯•ï¼Œè‡ªåŠ¨éšæœºåˆ›é€ å¤æ‚çš„æ•°æ®é›†ï¼Œç„¶ååŠ è½½å®ƒä»¬ä»¥æ£€æŸ¥ä¸€åˆ‡æ˜¯å¦æ­£å¸¸ï¼Œä½†æ˜¯ï¼Œè¿™ç±»bugå‡ ä¹ä¸å¯èƒ½å‡ºç°åœ¨RDBæŒä¹…åŒ–ä¸­ã€‚ä¸ºäº†è¯´å¾—æ›´æ¸…æ¥šä¸€ç‚¹ï¼šRedis AOFæ˜¯é€šè¿‡é€’å¢åœ°æ›´æ–°ä¸€ä¸ªå·²ç»å­˜åœ¨çš„çŠ¶æ€ï¼ŒåƒMySQLæˆ–è€…MongoDBä¸€æ ·ï¼Œè€ŒRDBå¿«ç…§æ˜¯ä¸€æ¬¡åˆä¸€æ¬¡åœ°ä»å¤´å¼€å§‹åˆ›é€ ä¸€åˆ‡ï¼Œæ¦‚å¿µä¸Šæ›´å¥å£®ã€‚ä½†æ˜¯ï¼Œè¦æ³¨æ„Redisæ¯æ¬¡é‡å†™AOFæ—¶éƒ½æ˜¯ä»¥å½“å‰æ•°æ®é›†ä¸­çš„çœŸå®æ•°æ®ä»å¤´å¼€å§‹ï¼Œç›¸å¯¹äºä¸€ç›´è¿½åŠ çš„AOFæ–‡ä»¶(æˆ–è€…ä¸€æ¬¡é‡å†™è¯»å–è€çš„AOFæ–‡ä»¶è€Œä¸æ˜¯è¯»å†…å­˜ä¸­çš„æ•°æ®)å¯¹bugçš„å…ç–«åŠ›æ›´å¼ºã€‚æˆ‘ä»¬è¿˜æ²¡æœ‰æ”¶åˆ°ä¸€ä»½ç”¨æˆ·åœ¨çœŸå®ä¸–ç•Œä¸­æ£€æµ‹åˆ°å´©æºƒçš„æŠ¥å‘Š 2.2.4 AOFæŒä¹…åŒ–ä¼˜ç¼ºç‚¹æ€»ç»“ ä¼˜ç‚¹ï¼šå¯ä»¥æœ€å¤§ç¨‹åº¦ä¿è¯æ•°æ®ä¸ä¸¢å¤± ç¼ºç‚¹ï¼šæ—¥å¿—è®°å½•é‡çº§æ¯”è¾ƒå¤§ 2.2.5 AOFæŒä¹…åŒ–é…ç½®å‚æ•° AOFæŒä¹…åŒ–æ ¸å¿ƒé…ç½®å‚æ•° #æ˜¯å¦æ‰“å¼€AOFæ—¥å¿—åŠŸèƒ½ appendonly yes/no ä»¥ä¸‹ä¸‰ç§æ–¹æ³•åªèƒ½åŒæ—¶æ‰“å¼€ä¸€ç§ #æ¯ä¸€æ¡å‘½ä»¤éƒ½ç«‹å³åŒæ­¥åˆ°AOF appendfsync always #æ¯ç§’å†™ä¸€æ¬¡ appendfsync everysec #å†™å…¥å·¥ä½œäº¤ç»™æ“ä½œç³»ç»Ÿ,ç”±æ“ä½œç³»ç»Ÿåˆ¤æ–­ç¼“å†²åŒºå¤§å°,ç»Ÿä¸€å†™å…¥åˆ°AOF appendfsync no é…ç½®AOFæŒä¹…åŒ– 1.ç¼–è¾‘é…ç½®æ–‡ä»¶ cat >/etc/redis/6379/redis.conf SHUTDOWN not connected> #æŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨ redis-server /etc/redis/6379/redis.conf 3.å†™å…¥æ•°æ® #è¿æ¥redisï¼Œå¦‚æœè®¾ç½®äº†å¯†ç ï¼Œä½¿ç”¨-aå‚æ•° redis-cli 127.0.0.1:6379> set name hehe OK 4.æŸ¥çœ‹AOFæ–‡ä»¶ appendonly.aofå°±æ˜¯AOFæŒä¹…åŒ–æ—¥å¿—æ–‡ä»¶ $ ll /etc/redis/6379/ total 20 -rw-r--r-- 1 root root 56 Dec 10 19:49 appendonly.aof -rw-r--r-- 1 root root 92 Dec 10 19:49 dump.rdb -rw-r--r-- 1 root root 182 Dec 10 19:49 redis.conf -rw-r--r-- 1 root root 6358 Dec 10 19:49 redis.log 5.AOFæ–‡ä»¶å†…å®¹ $ cat /etc/redis/6379/appendonly.aof *2 $6 SELECT $1 0 *3 $3 set $4 name $4 hehe *3 $3 set $4 test $4 test ä¸‰ã€å¦‚ä½•é€‰æ‹©RDBå’ŒAOF 1.ä¸€èˆ¬æ¥è¯´,å¦‚æœæƒ³è¾¾åˆ°è¶³ä»¥åª²ç¾ PostgreSQL çš„æ•°æ®å®‰å…¨æ€§ï¼Œ ä½ åº”è¯¥åŒæ—¶ä½¿ç”¨ä¸¤ç§æŒä¹…åŒ–åŠŸèƒ½ 2.å¦‚æœä½ éå¸¸å…³å¿ƒä½ çš„æ•°æ®,ä½†ä»ç„¶å¯ä»¥æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œ é‚£ä¹ˆä½ å¯ä»¥åªä½¿ç”¨ RDB æŒä¹…åŒ– 3.æœ‰å¾ˆå¤šç”¨æˆ·å•ç‹¬ä½¿ç”¨AOFï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸é¼“åŠ±è¿™æ ·ï¼Œå› ä¸ºæ—¶å¸¸è¿›è¡ŒRDBå¿«ç…§éå¸¸æ–¹ä¾¿äºæ•°æ®åº“å¤‡ä»½ï¼Œå¯åŠ¨é€Ÿåº¦ä¹Ÿè¾ƒä¹‹å¿«ï¼Œè¿˜é¿å…äº†AOFå¼•æ“çš„bug 4.åœ¨ä¼ä¸šä¸­ï¼Œé€šå¸¸éƒ½ä½¿ç”¨RDBæ¥åšæŒä¹…åŒ–ï¼Œå› ä¸ºä¸€èˆ¬redisæ˜¯åœ¨åšMySQLçš„ç¼“å­˜ï¼Œå°±ç®—ç¼“å­˜æ•°æ®ä¸¢å¤±ï¼ŒçœŸå®çš„æ•°æ®è¿˜æ˜¯åœ¨MySQLä¸­ï¼Œä¹‹æ‰€ä»¥ç”¨ç¼“å­˜æ˜¯ä¸ºäº†é€Ÿåº¦ï¼Œæ€§èƒ½è€Œè€ƒè™‘ï¼Œæ‰€ä»¥è¿˜æ˜¯å»ºè®®ä½¿ç”¨RDBæŒä¹…åŒ–ï¼Œç›¸å¯¹æ¥è¯´ä¼šå¥½ä¸€äº›ï¼Œé™¤éä¸“é—¨ç”¨redisæ¥åšä¸€ä¸ªkey:valueçš„æ•°æ®åº“ï¼Œè€Œä¸”æ•°æ®å¾ˆé‡è¦ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨AOF æ³¨æ„ï¼šåŸºäºè¿™äº›åŸå› ï¼Œå°†æ¥æˆ‘ä»¬å¯èƒ½ä¼šç»Ÿä¸€AOFå’ŒRDBä¸ºä¸€ç§å•ä¸€çš„æŒä¹…åŒ–æ¨¡å‹(é•¿è¿œè®¡åˆ’) RDBå’ŒAOFæŒä¹…åŒ–å¯¹æ¯” å››ã€RDBä¸AOFå·¥ä½œæ–¹å¼ 4.1 RDB 4.1.1 RDBå¿«ç…§å·¥ä½œæ–¹å¼ 1.é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedisä¿å­˜æ•°æ®é›†å¿«ç…§åˆ°ç£ç›˜ï¼Œåä¸ºdump.rdbçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ä½ å¯ä»¥è®¾ç½®è®©Redisåœ¨Nç§’å†…è‡³å°‘æœ‰Mæ¬¡æ•°æ®é›†æ”¹åŠ¨æ—¶ä¿å­˜æ•°æ®é›†ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨SAVEæˆ–è€…BGSAVEå‘½ä»¤ 2.åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬å·²ç»åœ¨é…ç½®æ–‡ä»¶ä¸­åšè¿‡å¯¹åº”çš„é…ç½®ï¼š ä¾‹å¦‚ï¼Œè¿™ä¸ªé…ç½®ä¼šè®©Redisåœ¨æ¯ä¸ª60ç§’å†…è‡³å°‘æœ‰1000æ¬¡é”®æ”¹åŠ¨æ—¶è‡ªåŠ¨è½¬å‚¨æ•°æ®é›†åˆ°ç£ç›˜ï¼š save 60 1000 3.å½“ Redis éœ€è¦ä¿å­˜ dump.rdb æ–‡ä»¶æ—¶ï¼ŒæœåŠ¡å™¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š Redis è°ƒç”¨ fork() ï¼ŒåŒæ—¶æ‹¥æœ‰çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ å­è¿›ç¨‹å°†æ•°æ®é›†å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶çš„ RDB æ–‡ä»¶ä¸­ã€‚å½“å­è¿›ç¨‹å®Œæˆå¯¹æ–° RDB æ–‡ä»¶çš„å†™å…¥æ—¶ï¼Œ Redis ç”¨æ–°RDB æ–‡ä»¶æ›¿æ¢åŸæ¥çš„ RDB æ–‡ä»¶ï¼Œå¹¶åˆ é™¤æ—§çš„ RDB æ–‡ä»¶ 4.è¿™ç§æ–¹å¼ä½¿å¾— Redis å¯ä»¥ä»å†™æ—¶å¤åˆ¶æœºåˆ¶ä¸­è·ç›Š RDBæ˜¯å…ˆå°†æ•°æ®é›†å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå½“ä¸´æ—¶æ–‡ä»¶å…¨éƒ¨å†™å®Œæ—¶ï¼Œå†è¦†ç›–dump.rdbæ–‡ä»¶ 4.1.2 RDBæŒä¹…åŒ–æ–¹å¼ saveã€bgsaveã€è‡ªåŠ¨åŒ– save è¯¥å‘½ä»¤ä¼šé˜»å¡å½“å‰RedisæœåŠ¡å™¨ï¼Œæ‰§è¡Œsaveå‘½ä»¤æœŸé—´ï¼ŒRedisä¸èƒ½å¤„ç†å…¶ä»–å‘½ä»¤ï¼Œç›´åˆ°RDBè¿‡ç¨‹å®Œæˆä¸ºæ­¢ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š bgsave æ‰§è¡Œè¯¥å‘½ä»¤æ—¶ï¼ŒRedisä¼šåœ¨åå°å¼‚æ­¥è¿›è¡Œå¿«ç…§æ“ä½œï¼Œå¿«ç…§åŒæ—¶è¿˜å¯ä»¥å“åº”å®¢æˆ·ç«¯è¯·æ±‚ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š è‡ªåŠ¨åŒ– è‡ªåŠ¨è§¦å‘æ˜¯ç”±æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æ¥å®Œæˆçš„ã€‚åœ¨redis.confé…ç½®æ–‡ä»¶ä¸­ï¼Œé‡Œé¢æœ‰å¦‚ä¸‹é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å»è®¾ç½®ï¼š â‘ saveï¼šè¿™é‡Œæ˜¯ç”¨æ¥é…ç½®è§¦å‘ Redisçš„ RDB æŒä¹…åŒ–æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆæ—¶å€™å°†å†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åˆ°ç¡¬ç›˜ã€‚æ¯”å¦‚save m nã€‚è¡¨ç¤ºmç§’å†…æ•°æ®é›†å­˜åœ¨næ¬¡ä¿®æ”¹æ—¶ï¼Œè‡ªåŠ¨è§¦å‘bgsaveã€‚ é»˜è®¤å¦‚ä¸‹é…ç½®ï¼š save 900 1 è¡¨ç¤º900 ç§’å†…å¦‚æœè‡³å°‘æœ‰ 1 ä¸ª key çš„å€¼å˜åŒ–ï¼Œåˆ™ä¿å­˜save 900 1 save 300 10 è¡¨ç¤º300 ç§’å†…å¦‚æœè‡³å°‘æœ‰ 10 ä¸ª key çš„å€¼å˜åŒ–ï¼Œåˆ™ä¿å­˜save 300 10 save 60 10000 è¡¨ç¤º60 ç§’å†…å¦‚æœè‡³å°‘æœ‰ 10000 ä¸ª key çš„å€¼å˜åŒ–ï¼Œåˆ™ä¿å­˜save 60 10000 ä¸éœ€è¦æŒä¹…åŒ–ï¼Œé‚£ä¹ˆä½ å¯ä»¥æ³¨é‡Šæ‰æ‰€æœ‰çš„ save è¡Œæ¥åœç”¨ä¿å­˜åŠŸèƒ½ã€‚ â‘¡stop-writes-on-bgsave-error ï¼šé»˜è®¤å€¼ä¸ºyesã€‚å½“å¯ç”¨äº†RDBä¸”æœ€åä¸€æ¬¡åå°ä¿å­˜æ•°æ®å¤±è´¥ï¼ŒRedisæ˜¯å¦åœæ­¢æ¥æ”¶æ•°æ®ã€‚è¿™ä¼šè®©ç”¨æˆ·æ„è¯†åˆ°æ•°æ®æ²¡æœ‰æ­£ç¡®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œå¦åˆ™æ²¡æœ‰äººä¼šæ³¨æ„åˆ°ç¾éš¾ï¼ˆdisasterï¼‰å‘ç”Ÿäº†ã€‚å¦‚æœRedisé‡å¯äº†ï¼Œé‚£ä¹ˆåˆå¯ä»¥é‡æ–°å¼€å§‹æ¥æ”¶æ•°æ®äº† â‘¢rdbcompression ï¼›é»˜è®¤å€¼æ˜¯yesã€‚å¯¹äºå­˜å‚¨åˆ°ç£ç›˜ä¸­çš„å¿«ç…§ï¼Œå¯ä»¥è®¾ç½®æ˜¯å¦è¿›è¡Œå‹ç¼©å­˜å‚¨ã€‚ â‘£rdbchecksum ï¼šé»˜è®¤å€¼æ˜¯yesã€‚åœ¨å­˜å‚¨å¿«ç…§åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®©redisä½¿ç”¨CRC64ç®—æ³•æ¥è¿›è¡Œæ•°æ®æ ¡éªŒï¼Œä½†æ˜¯è¿™æ ·åšä¼šå¢åŠ å¤§çº¦10%çš„æ€§èƒ½æ¶ˆè€—ï¼Œå¦‚æœå¸Œæœ›è·å–åˆ°æœ€å¤§çš„æ€§èƒ½æå‡ï¼Œå¯ä»¥å…³é—­æ­¤åŠŸèƒ½ã€‚ â‘¤dbfilename ï¼šè®¾ç½®å¿«ç…§çš„æ–‡ä»¶åï¼Œé»˜è®¤æ˜¯ dump.rdb â‘¥dirï¼šè®¾ç½®å¿«ç…§æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„ï¼Œè¿™ä¸ªé…ç½®é¡¹ä¸€å®šæ˜¯ä¸ªç›®å½•ï¼Œè€Œä¸èƒ½æ˜¯æ–‡ä»¶åã€‚ saveäºbgsaveå¯¹æ¯” 4.2 AOF 4.2.1 AOFé‡å†™åŠŸèƒ½ 1.å› ä¸º AOF çš„è¿ä½œæ–¹å¼æ˜¯ä¸æ–­åœ°å°†å‘½ä»¤è¿½åŠ åˆ°æ–‡ä»¶çš„æœ«å°¾ï¼Œæ‰€ä»¥éšç€å†™å…¥å‘½ä»¤çš„ä¸æ–­å¢åŠ ï¼Œ AOF æ–‡ä»¶çš„ä½“ç§¯ä¹Ÿå˜å¾—è¶Šæ¥è¶Šå¤§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ å¯¹ä¸€ä¸ªè®¡æ•°å™¨è°ƒç”¨äº† 100 æ¬¡ INCR ï¼Œé‚£ä¹ˆä»…ä»…æ˜¯ä¸ºäº†ä¿å­˜è¿™ä¸ªè®¡æ•°å™¨çš„å½“å‰å€¼ï¼Œ AOF æ–‡ä»¶å°±éœ€è¦ä½¿ç”¨ 100 æ¡è®°å½•ã€‚ç„¶è€Œåœ¨å®é™…ä¸Šï¼Œåªä½¿ç”¨ä¸€æ¡ SET å‘½ä»¤å·²ç»è¶³ä»¥ä¿å­˜è®¡æ•°å™¨çš„å½“å‰å€¼äº†ï¼Œå…¶ä½™ 99 æ¡è®°å½•å®é™…ä¸Šéƒ½æ˜¯å¤šä½™çš„ 2.ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼Œ Redis æ”¯æŒä¸€ç§æœ‰è¶£çš„ç‰¹æ€§ï¼šå¯ä»¥åœ¨ä¸æ–­æœåŠ¡å®¢æˆ·ç«¯çš„æƒ…å†µä¸‹ï¼Œå¯¹ AOF æ–‡ä»¶è¿›è¡Œé‡å»ºã€‚æ‰§è¡Œ BGREWRITEAOF å‘½ä»¤ï¼Œ Redis å°†ç”Ÿäº§ä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«é‡å»ºå½“å‰æ•°æ®é›†æ‰€éœ€çš„æœ€å°‘å‘½ä»¤ AOFé‡å†™åŸç† 4.2.2 AOFæœ‰å¤šæŒä¹… ä½ å¯ä»¥é…ç½® Redis å¤šä¹…æ‰å°†æ•°æ® fsync åˆ°ç£ç›˜ä¸€æ¬¡ã€‚ æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š alwaysï¼šæ¯æ¬¡æœ‰æ–°å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æ—¶å°±æ‰§è¡Œä¸€æ¬¡ fsync ï¼šéå¸¸æ…¢ï¼Œä¹Ÿéå¸¸å®‰å…¨ã€‚ everysecï¼šæ¯ç§’ fsync ä¸€æ¬¡ï¼šè¶³å¤Ÿå¿«ï¼ˆå’Œä½¿ç”¨ RDB æŒä¹…åŒ–å·®ä¸å¤šï¼Œï¼‰å¹¶ä¸”åœ¨æ•…éšœæ—¶åªä¼šä¸¢å¤±1ç§’é’Ÿçš„æ•°æ®ã€‚ noï¼šä»ä¸ fsyncï¼Œå°†æ•°æ®äº¤ç»™æ“ä½œç³»ç»Ÿæ¥å¤„ç†ã€‚æ›´å¿«ï¼Œä¹Ÿæ›´ä¸å®‰å…¨çš„é€‰æ‹©ã€‚ æ¨èï¼ˆå¹¶ä¸”ä¹Ÿæ˜¯é»˜è®¤ï¼‰çš„æªæ–½ä¸ºæ¯ç§’ fsync ä¸€æ¬¡ï¼Œè¿™ç§ fsync ç­–ç•¥å¯ä»¥å…¼é¡¾é€Ÿåº¦å’Œå®‰å…¨æ€§ã€‚ æ€»ä¹‹fsync çš„ç­–ç•¥åœ¨å®é™…ä½¿ç”¨ä¸­éå¸¸æ…¢ï¼Œå³ä½¿åœ¨ Redis2.0 å¯¹ç›¸å…³çš„ç¨‹åºè¿›è¡Œäº†æ”¹è¿›ä¹‹åä»æ˜¯å¦‚æ­¤ã€‚é¢‘ç¹è°ƒç”¨ fsync æ³¨å®šäº†è¿™ç§ç­–ç•¥ä¸å¯èƒ½å¿«å¾—èµ·æ¥ã€‚ 4.2.3 AOFæ–‡ä»¶å‡ºé”™è§£å†³æ–¹æ³• æœåŠ¡å™¨å¯èƒ½åœ¨ç¨‹åºæ­£åœ¨å¯¹AOFæ–‡ä»¶è¿›è¡Œå†™å…¥æ—¶åœæœºï¼Œå¦‚æœåœæœºé€ æˆäº†AOFæ–‡ä»¶å‡ºé”™ï¼Œé‚£ä¹ˆ Redis åœ¨é‡å¯æ—¶ä¼šæ‹’ç»è½½å…¥è¿™ä¸ª AOF æ–‡ä»¶ï¼Œä»è€Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ä¸ä¼šè¢«ç ´å å½“å‘ç”Ÿ AOF æ–‡ä»¶å‡ºé”™æ—¶ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•æ¥ä¿®å¤å‡ºé”™çš„ AOF æ–‡ä»¶ï¼š 1.ä¸ºç°æœ‰çš„ AOF æ–‡ä»¶åˆ›å»ºä¸€ä¸ªå¤‡ä»½ 2.ä½¿ç”¨ Redis é™„å¸¦çš„ redis-check-aof ç¨‹åºï¼Œå¯¹åŸæ¥çš„AOFæ–‡ä»¶è¿›è¡Œä¿®å¤ã€‚redis-check-aof --fix 3.ä½¿ç”¨ diff -u å¯¹æ¯”ä¿®å¤åçš„ AOF æ–‡ä»¶å’ŒåŸå§‹ AOF æ–‡ä»¶çš„å¤‡ä»½ï¼ŒæŸ¥çœ‹ä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´çš„ä¸åŒä¹‹å¤„ 4.é‡å¯ Redis æœåŠ¡å™¨ï¼Œç­‰å¾…æœåŠ¡å™¨è½½å…¥ä¿®å¤åçš„ AOF æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œæ•°æ®æ¢å¤ 4.3 RDBå’ŒAOFä¹‹é—´çš„ç›¸äº’ä½œç”¨ åœ¨ç‰ˆæœ¬å·å¤§äºç­‰äº 2.4 çš„ Redis ä¸­ï¼Œ BGSAVE æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸å¯ä»¥æ‰§è¡Œ BGREWRITEAOF ã€‚ åè¿‡æ¥è¯´ï¼Œåœ¨ BGREWRITEAOF æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¸å¯ä»¥æ‰§è¡Œ BGSAVE è¿™å¯ä»¥é˜²æ­¢ä¸¤ä¸ª Redis åå°è¿›ç¨‹åŒæ—¶å¯¹ç£ç›˜è¿›è¡Œå¤§é‡çš„ I/O æ“ä½œã€‚å¦‚æœ BGSAVE æ­£åœ¨æ‰§è¡Œï¼Œå¹¶ä¸”ç”¨æˆ·æ˜¾ç¤ºåœ°è°ƒç”¨ BGREWRITEAOF å‘½ä»¤ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†å‘ç”¨æˆ·å›å¤ä¸€ä¸ª OK çŠ¶æ€ï¼Œå¹¶å‘ŠçŸ¥ç”¨æˆ·ï¼Œ BGREWRITEAOF å·²ç»è¢«é¢„å®šæ‰§è¡Œï¼› ä¸€æ—¦ BGSAVE æ‰§è¡Œå®Œæ¯•ï¼Œ BGREWRITEAOF å°±ä¼šæ­£å¼å¼€å§‹ å½“ Redis å¯åŠ¨æ—¶ï¼Œå¦‚æœ RDB æŒä¹…åŒ–å’Œ AOF æŒä¹…åŒ–éƒ½è¢«æ‰“å¼€äº†ï¼Œé‚£ä¹ˆç¨‹åºä¼šä¼˜å…ˆä½¿ç”¨ AOF æ–‡ä»¶æ¥æ¢å¤æ•°æ®é›†ï¼Œå› ä¸º AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®é€šå¸¸æ˜¯æœ€å®Œæ•´çš„ äº”ã€rediså¤‡ä»½ 5.1 å¤‡ä»½ç­–ç•¥ 1.Redis å¯¹äºæ•°æ®å¤‡ä»½æ˜¯éå¸¸å‹å¥½çš„ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨æœåŠ¡å™¨è¿è¡Œçš„æ—¶å€™å¯¹ RDB æ–‡ä»¶è¿›è¡Œå¤åˆ¶ï¼š RDB æ–‡ä»¶ä¸€æ—¦è¢«åˆ›å»ºï¼Œå°±ä¸ä¼šè¿›è¡Œä»»ä½•ä¿®æ”¹ 2.å½“æœåŠ¡å™¨è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ RDB æ–‡ä»¶æ—¶ï¼Œå®ƒå…ˆå°†æ–‡ä»¶çš„å†…å®¹ä¿å­˜åœ¨ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶é‡Œé¢ï¼Œå½“ä¸´æ—¶æ–‡ä»¶å†™å…¥å®Œæ¯•æ—¶ï¼Œç¨‹åºæ‰ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢åŸæ¥çš„ RDB æ–‡ä»¶ 3.è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œæ— è®ºä½•æ—¶ï¼Œ å¤åˆ¶ RDB æ–‡ä»¶éƒ½æ˜¯ç»å¯¹å®‰å…¨çš„ ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„å»ºè®®ï¼š åˆ›å»ºä¸€ä¸ªå®šæœŸä»»åŠ¡ï¼ˆcron jobï¼‰ï¼Œ æ¯å°æ—¶å°†ä¸€ä¸ª RDB æ–‡ä»¶å¤‡ä»½åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œ å¹¶ä¸”æ¯å¤©å°†ä¸€ä¸ª RDB æ–‡ä»¶å¤‡ä»½åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹ ç¡®ä¿å¿«ç…§çš„å¤‡ä»½éƒ½å¸¦æœ‰ç›¸åº”çš„æ—¥æœŸå’Œæ—¶é—´ä¿¡æ¯ï¼Œ æ¯æ¬¡æ‰§è¡Œå®šæœŸä»»åŠ¡è„šæœ¬æ—¶ï¼Œ ä½¿ç”¨ find å‘½ä»¤æ¥åˆ é™¤è¿‡æœŸçš„å¿«ç…§ï¼š æ¯”å¦‚è¯´ï¼Œ ä½ å¯ä»¥ä¿ç•™æœ€è¿‘ 48 å°æ—¶å†…çš„æ¯å°æ—¶å¿«ç…§ï¼Œ è¿˜å¯ä»¥ä¿ç•™æœ€è¿‘ä¸€ä¸¤ä¸ªæœˆçš„æ¯æ—¥å¿«ç…§ è‡³å°‘æ¯å¤©ä¸€æ¬¡ï¼Œ å°† RDB å¤‡ä»½åˆ°ä½ çš„æ•°æ®ä¸­å¿ƒä¹‹å¤–ï¼Œ æˆ–è€…è‡³å°‘æ˜¯å¤‡ä»½åˆ°ä½ è¿è¡Œ Redis æœåŠ¡å™¨çš„ç‰©ç†æœºå™¨ä¹‹å¤– 5.2 rediså¤‡ä»½ã€æ¢å¤ redisæŒä¹…åŒ–å°±æ˜¯rediså¤‡ä»½ å°†å¤‡ä»½æ–‡ä»¶ (dump.rdb) ç§»åŠ¨åˆ° redis å®‰è£…ç›®å½•å¹¶å¯åŠ¨æœåŠ¡å³å¯ï¼Œä½¿ç”¨CONFIG GET dirå‘½ä»¤è·å–redisç›®å½• å…­ã€redisæŒä¹…åŒ–é«˜çº§é…ç½® RDBæŒä¹…åŒ–é«˜çº§é…ç½® #åå°å¤‡ä»½è¿›ç¨‹å‡ºé”™æ—¶,ä¸»è¿›ç¨‹åœä¸åœæ­¢å†™å…¥? ä¸»è¿›ç¨‹ä¸åœæ­¢å®¹æ˜“é€ æˆæ•°æ®ä¸ä¸€è‡´ stop-writes-on-bgsave-error yes #å¯¼å‡ºçš„rdbæ–‡ä»¶æ˜¯å¦å‹ç¼© å¦‚æœrdbçš„å¤§å°å¾ˆå¤§çš„è¯å»ºè®®è¿™ä¹ˆåš rdbcompression yes #å¯¼å…¥rbdæ¢å¤æ•°æ®æ—¶,è¦ä¸è¦æ£€éªŒrdbçš„å®Œæ•´æ€§ éªŒè¯ç‰ˆæœ¬æ˜¯ä¸æ˜¯ä¸€è‡´ rdbchecksum yes AOFæŒä¹…åŒ–é«˜çº§é…ç½® #æ­£åœ¨å¯¼å‡ºrdbå¿«ç…§çš„è¿‡ç¨‹ä¸­,è¦ä¸è¦åœæ­¢åŒæ­¥aof no-appendfsync-on-rewrite yes/no #aofæ–‡ä»¶å¤§å°æ¯”èµ·ä¸Šæ¬¡é‡å†™æ—¶çš„å¤§å°,å¢é•¿ç‡100%æ—¶é‡å†™,ç¼ºç‚¹:ä¸šåŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œä¼šé‡å¤é‡å†™å¤šæ¬¡ auto-aof-rewrite-percentage 100 #aofæ–‡ä»¶,è‡³å°‘è¶…è¿‡64Mæ—¶,é‡å†™ auto-aof-rewrite-min-size 64mb æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/rediså‘½ä»¤.html":{"url":"db/redis/rediså‘½ä»¤.html","title":"rediså‘½ä»¤","keywords":"","body":"rediså‘½ä»¤ rediså‘½ä»¤å®˜æ–¹æ–‡æ¡£ âš ï¸ keys * å‘½ä»¤ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼ï¼ï¼ è¿™é‡Œä»…ä»…æ˜¯ä¸ºäº†å®éªŒä½¿ç”¨è¿™ä¸ªå‘½ä»¤ redis-cli è¯­æ³• redis-cli é€‰é¡¹ -h æŒ‡å®šè¿æ¥çš„redisæœåŠ¡ç«¯IPåœ°å€ï¼Œä¸å†™é»˜è®¤æœ¬æœº -p æŒ‡å®šç«¯å£ -a æŒ‡å®šå¯†ç  ç¤ºä¾‹ redisæ²¡æœ‰é…ç½®å¯†ç  $ redis-cli 127.0.0.1:6379> redisé…ç½®äº†å¯†ç  redis-cli -h 127.0.0.1 -p 6379 -a \"mypass\" redisè®¾ç½®å¯†ç  #æ–¹æ³•ä¸€ é…ç½®æ–‡ä»¶ åœ¨redisçš„é…ç½®æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹ä¸€è¡Œå³ä¸ºè®¾ç½®rediså¯†ç  requirepass password #æ–¹æ³•äºŒ å‘½ä»¤è¡Œè®¾ç½®å¯†ç ï¼Œå¦‚æœéœ€è¦å–æ¶ˆå¯†ç åˆ™è®¾ç½®ä¸ºç©ºå³å¯ CONFIG set requirepass \"password\" å‘½ä»¤è¡Œè®¾ç½®rediså¯†ç åé€šè¿‡redis-cliå‘½ä»¤è¿›å…¥rediså°±éœ€è¦è¾“å…¥authå‘½ä»¤è¿›è¡ŒéªŒè¯ redis-server ç¤ºä¾‹ï¼šæŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨redis redis-server /etc/redis/6379/redis.conf keyså‘½ä»¤ del key å«ä¹‰ï¼šè¯¥å‘½ä»¤ç”¨äºåœ¨keyå­˜åœ¨æ—¶åˆ é™¤ key ç¤ºä¾‹ï¼š 127.0.0.1:6379> get str \"6abc\" 127.0.0.1:6379> DEL str (integer) 1 127.0.0.1:6379> get str (nil) dump key å«ä¹‰ï¼šåºåˆ—åŒ–keyï¼Œå¹¶è¿”å›è¢«åºåˆ—åŒ–çš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"abc\" 127.0.0.1:6379> DUMP str \"\\x00\\x03abc\\a\\x00&\\x9e\\xe5\\xceI\\xb8w\\xf8\" exists key å«ä¹‰ï¼šæ£€æŸ¥æŒ‡å®škeyæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨è¿”å›1ï¼Œä¸å­˜åœ¨è¿”å›0 ç¤ºä¾‹ï¼š 127.0.0.1:6379> EXISTS str (integer) 1 127.0.0.1:6379> EXISTS str1 (integer) 0 expire key seconds å«ä¹‰ï¼šä¸ºç»™å®škeyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"abc\" 127.0.0.1:6379> EXPIRE str 5 (integer) 1 127.0.0.1:6379> GET str \"abc\" 127.0.0.1:6379> GET str \"abc\" 127.0.0.1:6379> GET str (nil) expireat key timestamp å«ä¹‰ï¼šEXPIREAT çš„ä½œç”¨å’Œ EXPIRE ç±»ä¼¼ï¼Œéƒ½ç”¨äºä¸ºkeyè®¾ç½®è¿‡æœŸæ—¶é—´ã€‚ ä¸åŒåœ¨äº EXPIREAT å‘½ä»¤æ¥å—çš„æ—¶é—´å‚æ•°æ˜¯ UNIX æ—¶é—´æˆ³(unix timestamp) ç¤ºä¾‹ï¼š 127.0.0.1:6379> EXPIREAT str 1688666880 (integer) 0 1688666880æ˜¯unixæ—¶é—´æˆ³ç§’ï¼Œå¯¹åº”çš„æ—¶é—´æ˜¯ 2023/7/7 2:8:0 pexpire key milliseconds å«ä¹‰ï¼šè®¾ç½®keyçš„è¿‡æœŸæ—¶é—´ä»¥æ¯«ç§’è®¡ ç¤ºä¾‹ï¼š 127.0.0.1:6379> PEXPIRE str 3000 (integer) 1 127.0.0.1:6379> GET str \"abc\" 127.0.0.1:6379> GET str (nil) pexpireat key milliseconds-timestamp å«ä¹‰ï¼šè®¾ç½®keyè¿‡æœŸæ—¶é—´çš„æ—¶é—´æˆ³(unix timestamp) ä»¥æ¯«ç§’è®¡ ç¤ºä¾‹ï¼š 127.0.0.1:6379> PEXPIREAT str 1655555555005 (integer) 1 1655555555005æ˜¯unixæ—¶é—´æˆ³æ¯«ç§’ï¼Œå¯¹åº”çš„æ—¶é—´æ˜¯ 2022/6/18 20:32:35 keys pattern å«ä¹‰ï¼šæŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆç»™å®šæ¨¡å¼( pattern)çš„ key ç¤ºä¾‹ï¼š 127.0.0.1:6379> SET str1 aaa OK 127.0.0.1:6379> SET str2 bbb OK 127.0.0.1:6379> SET str3 ccc OK #æŸ¥æ‰¾ä»¥strå¼€å¤´çš„key 127.0.0.1:6379> KEYS str* 1) \"str1\" 2) \"str3\" 3) \"str2\" move key db å«ä¹‰ï¼šå°†å½“å‰æ•°æ®åº“çš„keyç§»åŠ¨åˆ°ç»™å®šçš„æ•°æ®åº“dbå½“ä¸­ ç¤ºä¾‹ï¼š âš ï¸å½“ä»ä¸€ä¸ªæ•°æ®åº“ç§»åŠ¨ä¸€ä¸ªä¸å­˜åœ¨çš„keyåˆ°å¦ä¸€ä¸ªæ•°æ®åº“æ—¶ä¼šå¤±è´¥ âš ï¸å½“ä¸¤ä¸ªæ•°æ®åº“å­˜åœ¨ç›¸åŒçš„keyæ—¶ï¼Œåˆ™æ— æ³•ç§»åŠ¨ #redisé»˜è®¤ä½¿ç”¨æ•°æ®åº“0ï¼Œè¿™é‡Œå†æ˜¾ç¤ºæŒ‡å®šä¸€æ¬¡ 127.0.0.1:6379> SELECT 0 OK 127.0.0.1:6379> SET str aaa OK #æŠŠstrç§»åŠ¨åˆ°æ•°æ®åº“1 127.0.0.1:6379> MOVE str 1 (integer) 1 #åœ¨æ•°æ®åº“0æ£€æŸ¥stræ˜¯å¦å­˜åœ¨ï¼Œè¿”å›0è¡¨ç¤ºä¸å­˜åœ¨ 127.0.0.1:6379> EXISTS str (integer) 0 #åˆ‡æ¢åˆ°åº“1ï¼Œç„¶åæ£€æŸ¥stræ˜¯å¦å­˜åœ¨ 127.0.0.1:6379> SELECT 1 OK 127.0.0.1:6379[1]> EXISTS str (integer) 1 persist key å«ä¹‰ï¼šç§»é™¤keyçš„è¿‡æœŸæ—¶é—´ï¼Œkeyå°†æŒä¹…ä¿æŒ ç¤ºä¾‹ï¼š #è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º10ç§’ 127.0.0.1:6379> EXPIRE str 10 (integer) 1 #å–æ¶ˆè¿‡æœŸæ—¶é—´ï¼Œè¿”å›å€¼ä¸º1è¡¨ç¤ºå–æ¶ˆæˆåŠŸ 127.0.0.1:6379> PERSIST str (integer) 1 pttl key å«ä¹‰ï¼šä»¥æ¯«ç§’ä¸ºå•ä½è¿”å›keyçš„å‰©ä½™çš„è¿‡æœŸæ—¶é—´ ç¤ºä¾‹ï¼š #è®¾ç½®è¿‡æœŸæ—¶é—´ 127.0.0.1:6379> EXPIRE str 10 (integer) 1 #è¿”å›ç»“æœä¸ºè¿˜æœ‰7109æ¯«ç§’è¿‡æœŸ 127.0.0.1:6379> PTTL str (integer) 7109 ttl key å«ä¹‰ï¼šä»¥ç§’ä¸ºå•ä½ï¼Œè¿”å›ç»™å®š key çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´(TTL, time to live) ç¤ºä¾‹ï¼š 127.0.0.1:6379> EXPIRE str 10 (integer) 1 127.0.0.1:6379> TTL str (integer) 8 randomkey å«ä¹‰ï¼šä»å½“å‰æ•°æ®åº“ä¸­éšæœºè¿”å›ä¸€ä¸ª key ç¤ºä¾‹ï¼š 127.0.0.1:6379> MSET str1 a str2 b str3 c OK 127.0.0.1:6379> RANDOMKEY \"str1\" 127.0.0.1:6379> RANDOMKEY \"str2\" 127.0.0.1:6379> RANDOMKEY \"str1\" 127.0.0.1:6379> RANDOMKEY \"str2\" 127.0.0.1:6379> RANDOMKEY \"str1\" 127.0.0.1:6379> RANDOMKEY \"str1\" 127.0.0.1:6379> RANDOMKEY \"str3\" pename key newkey å«ä¹‰ï¼šä¿®æ”¹keyçš„åç§° ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"aaa\" 127.0.0.1:6379> RENAME str str1 OK 127.0.0.1:6379> KEYS * 1) \"str1\" renamenx key newkey å«ä¹‰ï¼šä»…å½“newkeyä¸å­˜åœ¨æ—¶ï¼Œå°†keyæ”¹åä¸ºnewkey ç¤ºä¾‹ï¼š 127.0.0.1:6379> KEYS * 1) \"str2\" 127.0.0.1:6379> RENAMENX str2 str3 (integer) 1 127.0.0.1:6379> KEYS * 1) \"str3\" type key å«ä¹‰ï¼šè¿”å›keyæ‰€å­˜å‚¨å€¼çš„ç±»å‹ ç¤ºä¾‹ï¼š 127.0.0.1:6379> type str3 string æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/rediså±é™©å‘½ä»¤.html":{"url":"db/redis/rediså±é™©å‘½ä»¤.html","title":"rediså±é™©å‘½ä»¤","keywords":"","body":"rediså±é™©å‘½ä»¤ keys * è™½ç„¶å…¶æ¨¡ç³ŠåŒ¹é…åŠŸèƒ½ä½¿ç”¨éå¸¸æ–¹ä¾¿ä¹Ÿå¾ˆå¼ºå¤§ï¼Œåœ¨å°æ•°æ®é‡æƒ…å†µä¸‹ä½¿ç”¨æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œæ•°æ®é‡å¤§ä¼šå¯¼è‡´ Redis é”ä½åŠ CPU é£™å‡ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒå»ºè®®ç¦ç”¨æˆ–è€…é‡å‘½åï¼ flushdb åˆ é™¤Redisä¸­å½“å‰æ‰€åœ¨æ•°æ®åº“ä¸­çš„æ‰€æœ‰è®°å½•ï¼Œå¹¶ä¸”è¯¥å‘½ä»¤æ˜¯åŸå­æ€§çš„ï¼Œä¸ä¼šç»ˆæ­¢æ‰§è¡Œï¼Œä¸€æ—¦æ‰§è¡Œï¼Œå°†ä¸ä¼šæ‰§è¡Œå¤±è´¥ã€‚ flushall åˆ é™¤Redisä¸­æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰è®°å½•ï¼Œå¹¶ä¸”è¯¥å‘½ä»¤æ˜¯åŸå­æ€§çš„ï¼Œä¸ä¼šç»ˆæ­¢æ‰§è¡Œï¼Œä¸€æ—¦æ‰§è¡Œï¼Œå°†ä¸ä¼šæ‰§è¡Œå¤±è´¥ã€‚ config ä¿®æ”¹redisé…ç½®å‘½ä»¤ï¼Œä¸€èˆ¬åœ¨redisé…ç½®æ–‡ä»¶ä¸­åšé…ç½® ç¦ç”¨rediså±é™©å‘½ä»¤ ç¼–è¾‘redisé…ç½®æ–‡ä»¶ï¼Œå¼•å·ä¸­å†…å®¹ä¸ºç©ºåˆ™ä¸ºç¦ç”¨å‘½ä»¤ï¼Œæœ‰å†…å®¹åˆ™ä¸ºç»™å‘½ä»¤èµ·åˆ«å rename-command KEYS \"\" rename-command FLUSHALL \"\" rename-command FLUSHDB \"\" rename-command CONFIG \"\" ç¤ºä¾‹ #ç¦ç”¨keys * 127.0.0.1:6379> KEYS * (error) ERR unknown command 'KEYS' #ä½¿ç”¨å‘½ä»¤åˆ«åï¼Œkeyså‘½ä»¤åˆ«åè®¾ç½®ä¸ºäº†hehe 127.0.0.1:6379> hehe * 1) \"str2\" 2) \"str1\" 3) \"str3\" æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/redisæ•°æ®ç±»å‹/1.redisæ•°æ®ç±»å‹-stringå­—ç¬¦ä¸².html":{"url":"db/redis/redisæ•°æ®ç±»å‹/1.redisæ•°æ®ç±»å‹-stringå­—ç¬¦ä¸².html","title":"string å­—ç¬¦ä¸²","keywords":"","body":"redisæ•°æ®ç±»å‹ string å­—ç¬¦ä¸² rediså‘½ä»¤å®˜æ–¹æ–‡æ¡£ string(å­—ç¬¦ä¸²) ç®€ä»‹ï¼š å­—ç¬¦ä¸² å¯ä»¥å­˜å‚¨çš„å€¼ï¼š å­—ç¬¦ä¸²ï¼Œæ•´æ•°æˆ–è€…æµ®ç‚¹æ•°ï¼Œè¿˜æœ‰jpgå›¾ç‰‡æˆ–è€…åºåˆ—åŒ–å¯¹è±¡ æ“ä½œï¼š å¯¹æ•´ä¸ªå­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²çš„å…¶ä¸­ä¸€éƒ¨åˆ†æ‰§è¡Œæ“ä½œï¼Œå¯¹æ•´æ•°å’Œæµ®ç‚¹æ•°æ‰§è¡Œè‡ªå¢æˆ–è€…è‡ªå‡æ“ä½œ åº”ç”¨åœºæ™¯ï¼š åšç®€å•çš„é”®å€¼å¯¹ç¼“å­˜ ä½¿ç”¨ç¤ºä¾‹ï¼š 127.0.0.1:6379> set a 1 OK 127.0.0.1:6379> get a \"1\" 127.0.0.1:6379> del a (integer) 1 127.0.0.1:6379> get a (nil) rediså­—ç¬¦ä¸²å¸¸ç”¨å‘½ä»¤ set key value å«ä¹‰ï¼šè®¾ç½®æŒ‡å®škeyçš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> SET str a OK get key å«ä¹‰ï¼šè·å–æŒ‡å®škeyçš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"a\" setrange key offset value å«ä¹‰ï¼šç”¨valueå‚æ•°è¦†å†™ç»™å®škeyæ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œä»åç§»é‡offsetå¼€å§‹ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"abc\" 127.0.0.1:6379> SETRANGE str 1 123 (integer) 4 127.0.0.1:6379> GET str \"a123\" getrange key start end å«ä¹‰ï¼šè¿”å›keyä¸­å­—ç¬¦ä¸²å€¼çš„å­å­—ç¬¦ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"abcdef\" 127.0.0.1:6379> GETRANGE str 0 3 \"abcd\" getset key value å«ä¹‰ï¼šå°†ç»™å®škeyçš„å€¼è®¾ä¸ºvalue ï¼Œå¹¶è¿”å›keyçš„æ—§å€¼(old value) ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"abcdef\" 127.0.0.1:6379> GETSET str 123 \"abcdef\" 127.0.0.1:6379> GET str \"123\" getbit key offset å«ä¹‰ï¼šå¯¹keyæ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œè·å–æŒ‡å®šåç§»é‡ä¸Šçš„ä½(bit) ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"abcd\" 127.0.0.1:6379> GETBIT str 0 (integer) 0 127.0.0.1:6379> GETBIT str 1 (integer) 1 127.0.0.1:6379> GETBIT str 2 (integer) 1 127.0.0.1:6379> GETBIT str 3 (integer) 0 setbit key offset value å«ä¹‰ï¼šå¯¹keyæ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œè®¾ç½®æˆ–æ¸…é™¤æŒ‡å®šåç§»é‡ä¸Šçš„ä½(bit) ç¤ºä¾‹ï¼š 27.0.0.1:6379> GET str \"abcd\" 127.0.0.1:6379> GETBIT str 0 (integer) 0 127.0.0.1:6379> GETBIT str 1 (integer) 1 127.0.0.1:6379> GETBIT str 2 (integer) 1 127.0.0.1:6379> GETBIT str 3 (integer) 0 127.0.0.1:6379> SETBIT str 0 1 (integer) 0 127.0.0.1:6379> GETBIT str 0 (integer) 1 mset key value [key value] å«ä¹‰ï¼šåŒæ—¶è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªkey-valueå¯¹ ç¤ºä¾‹ï¼š 127.0.0.1:6379> MSET str1 aaa str2 bbb OK mget key1 [key2] å«ä¹‰ï¼šè·å–æ‰€æœ‰(ä¸€ä¸ªæˆ–å¤šä¸ª)ç»™å®škeyçš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> MGET str1 str2 1) \"a\" 2) \"b\" setex key seconds value å«ä¹‰ï¼šå°†å€¼valueå…³è”åˆ°key ï¼Œå¹¶å°†keyçš„è¿‡æœŸæ—¶é—´è®¾ä¸ºseconds (ä»¥ç§’ä¸ºå•ä½) ç¤ºä¾‹ï¼š 127.0.0.1:6379> SETEX str 10 abc OK #10ç§’åstrçš„å€¼å¤±æ•ˆ 127.0.0.1:6379> GEt str (nil) setnx key value å«ä¹‰ï¼šåªæœ‰åœ¨keyä¸å­˜åœ¨æ—¶è®¾ç½®keyçš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"abc\" 127.0.0.1:6379> SETNX str 123 (integer) 0 127.0.0.1:6379> GET str \"abc\" 127.0.0.1:6379> SETNX str2 123 (integer) 1 127.0.0.1:6379> GET str2 \"123\" msetnx key value [key value] å«ä¹‰ï¼šåŒæ—¶è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªkey-valueå¯¹ï¼Œå½“ä¸”ä»…å½“æ‰€æœ‰ç»™å®škeyéƒ½ä¸å­˜åœ¨ï¼Œå¦‚æœkeyå­˜åœ¨åˆ™ä¸æ”¹å˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> MSETNX str5 5 str6 6 (integer) 1 127.0.0.1:6379> MGET str5 str6 1) \"5\" 2) \"6\" psetex key milliseconds value å«ä¹‰ï¼šè¿™ä¸ªå‘½ä»¤å’Œ SETEX å‘½ä»¤ç›¸ä¼¼ï¼Œä½†å®ƒä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½®keyçš„ç”Ÿå­˜æ—¶é—´ï¼Œè€Œä¸æ˜¯åƒ SETEX å‘½ä»¤é‚£æ ·ï¼Œä»¥ç§’ä¸ºå•ä½ ç¤ºä¾‹ï¼š 127.0.0.1:6379> PSETEX str 3000 a123 OK #str 3000æ¯«ç§’(3ç§’)åå¤±æ•ˆ 127.0.0.1:6379> GET str (nil) incr key å«ä¹‰ï¼šå°†keyä¸­å‚¨å­˜çš„æ•°å­—å€¼å¢ä¸€ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"10\" 127.0.0.1:6379> INCR str (integer) 11 127.0.0.1:6379> GET str \"11\" incrby key increment å«ä¹‰ï¼šå°†keyæ‰€å‚¨å­˜çš„å€¼åŠ ä¸Šç»™å®šçš„å¢é‡å€¼ï¼ˆincrementï¼‰ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"11\" 127.0.0.1:6379> INCRBY str 2 (integer) 13 127.0.0.1:6379> GET str \"13\" incrbyfloat key increment å«ä¹‰ï¼šå°†keyæ‰€å‚¨å­˜çš„å€¼åŠ ä¸Šç»™å®šçš„æµ®ç‚¹å¢é‡å€¼ï¼ˆincrementï¼‰ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"13\" 127.0.0.1:6379> INCRBYFLOAT str 0.5 \"13.5\" 127.0.0.1:6379> GET str \"13.5\" decr key å«ä¹‰ï¼šå°†keyä¸­å‚¨å­˜çš„æ•°å­—å€¼å‡ä¸€ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"10\" 127.0.0.1:6379> DECR str (integer) 9 127.0.0.1:6379> GET str \"9\" decrby key decrement å«ä¹‰ï¼škeyæ‰€å‚¨å­˜çš„å€¼å‡å»ç»™å®šçš„å‡é‡å€¼ï¼ˆdecrementï¼‰ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"9\" 127.0.0.1:6379> DECRBY str 3 (integer) 6 127.0.0.1:6379> GET str \"6\" append key value å«ä¹‰ï¼šå¦‚æœkeyå·²ç»å­˜åœ¨å¹¶ä¸”æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œ APPEND å‘½ä»¤å°†æŒ‡å®šçš„valueè¿½åŠ åˆ°è¯¥keyåŸæ¥å€¼ï¼ˆvalueï¼‰çš„æœ«å°¾ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"6\" 127.0.0.1:6379> APPEND str abc (integer) 4 127.0.0.1:6379> GET str \"6abc\" strlen key å«ä¹‰ï¼šè¿”å›keyæ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼çš„é•¿åº¦ ç¤ºä¾‹ï¼š 127.0.0.1:6379> GET str \"6abc\" 127.0.0.1:6379> STRLEN str (integer) 4 åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨``keys *`` è¿™ä¸ªå‘½ä»¤ä¹‹åä¼šæœ‰æ„æƒ³ä¸åˆ°çš„ç»“æœ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/redisæ•°æ®ç±»å‹/2.redisæ•°æ®ç±»å‹-liståˆ—è¡¨.html":{"url":"db/redis/redisæ•°æ®ç±»å‹/2.redisæ•°æ®ç±»å‹-liståˆ—è¡¨.html","title":"list åˆ—è¡¨","keywords":"","body":"redisæ•°æ®ç±»å‹ list åˆ—è¡¨ list(åˆ—è¡¨) ç®€ä»‹ï¼š é“¾è¡¨ï¼ˆåŒå‘é“¾è¡¨ï¼‰ å¯ä»¥å­˜å‚¨çš„å€¼ï¼š åˆ—è¡¨ æ“ä½œï¼š ä»ä¸¤ç«¯å‹å…¥æˆ–è€…å¼¹å‡ºå…ƒç´ ï¼Œå¯¹å•ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ è¿›è¡Œä¿®æ”¹ï¼Œåªä¿ç•™ä¸€ä¸ªèŒƒå›´å†…çš„å…ƒç´  åº”ç”¨åœºæ™¯ï¼šæœ€æ–°æ¶ˆæ¯æ’è¡Œï¼›æ¶ˆæ¯é˜Ÿåˆ— èŒƒå›´ï¼šä¸€ä¸ªåˆ—è¡¨æœ€å¤šå¯ä»¥åŒ…å« 2^32 - 1 ä¸ªå…ƒç´  (4294967295, æ¯ä¸ªåˆ—è¡¨è¶…è¿‡40äº¿ä¸ªå…ƒç´ ) ä½¿ç”¨ç¤ºä¾‹ï¼š 127.0.0.1:6379> LPUSH test a (integer) 1 127.0.0.1:6379> LPUSH test b (integer) 2 127.0.0.1:6379> LPUSH test c (integer) 3 127.0.0.1:6379> LRANGE test 0 -1 1) \"c\" 2) \"b\" 3) \"a\" 127.0.0.1:6379> LPOP test \"c\" redisåˆ—è¡¨å¸¸ç”¨å‘½ä»¤ lpush/rpush key value1 [value2] å«ä¹‰ï¼šä»å·¦/ä»å³å‘åˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå€¼ ç¤ºä¾‹ï¼š lpush ä»å·¦è¾¹å¼€å§‹æ’å…¥å€¼ï¼Œå…ˆæ’å…¥çš„å€¼åœ¨åè¾¹ 127.0.0.1:6379> LPUSH lst a (integer) 1 127.0.0.1:6379> LPUSH lst b (integer) 2 127.0.0.1:6379> LPUSH lst c (integer) 3 127.0.0.1:6379> LRANGE lst 0 -1 1) \"c\" 2) \"b\" 3) \"a\" rpush ä»å³è¾¹å¼€å§‹æ’å…¥å€¼ï¼Œå…ˆæ’å…¥çš„å€¼åœ¨å‰è¾¹ 127.0.0.1:6379> RPUSH l a (integer) 1 127.0.0.1:6379> RPUSH l b (integer) 2 127.0.0.1:6379> RPUSH l c (integer) 3 127.0.0.1:6379> LRANGE l 0 -1 1) \"a\" 2) \"b\" 3) \"c\" blpop key1 [key2] timeout å«ä¹‰ï¼šç§»å‡ºå¹¶è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢ ç¤ºä¾‹ï¼š 127.0.0.1:6379> LPUSH lst a b c (integer) 3 127.0.0.1:6379> BLPOP lst 3 1) \"lst\" 2) \"c\" brpoplpush source destination timeout å«ä¹‰ï¼šä»åˆ—è¡¨ä¸­å¼¹å‡ºä¸€ä¸ªå€¼ï¼Œå°†å¼¹å‡ºçš„å…ƒç´ æ’å…¥åˆ°å¦å¤–ä¸€ä¸ªåˆ—è¡¨ä¸­å¹¶è¿”å›å®ƒï¼› å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢ ç¤ºä¾‹ï¼š #ä»åˆ—è¡¨lstä¸­å¼¹å‡ºä¸€ä¸ªå€¼æ’å…¥åˆ°lst1ä¸­ï¼Œå¹¶ä¸”è¿”å›lstä¸­çš„è¿™ä¸ªå€¼ 127.0.0.1:6379> BRPOPLPUSH lst lst1 3 \"a\" #å¼¹å‡ºlst1ä¸­çš„å€¼ 127.0.0.1:6379> LPOP lst1 \"a\" 127.0.0.1:6379> LPOP lst1 (nil) lindex key index å«ä¹‰ï¼šé€šè¿‡ç´¢å¼•è·å–åˆ—è¡¨ä¸­çš„å…ƒç´  ç¤ºä¾‹ï¼š 127.0.0.1:6379> LPUSH lst a b c (integer) 3 127.0.0.1:6379> LINDEX lst 0 \"c\" linsert key befor|after pivot value å«ä¹‰ï¼šåœ¨åˆ—è¡¨çš„å…ƒç´ å‰æˆ–è€…åæ’å…¥å…ƒç´  ç¤ºä¾‹ï¼š #å‘åˆ—è¡¨lstä¸­æ’å…¥3ä¸ªå€¼ï¼Œå› ä¸ºæ˜¯lpushï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯c 127.0.0.1:6379> LPUSH lst a b c (integer) 3 #åœ¨å…ƒç´ cä¹‹å‰æ’å…¥d 127.0.0.1:6379> LINSERT lst before c d (integer) 4 #åŸå…ˆcæ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç°åœ¨ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯d 127.0.0.1:6379> LINDEX lst 0 \"d\" llen key å«ä¹‰ï¼šè·å–åˆ—è¡¨é•¿åº¦ ç¤ºä¾‹ï¼š 127.0.0.1:6379> LLEN lst (integer) 4 lpop key å«ä¹‰ï¼šç§»å‡ºå¹¶è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´  ç¤ºä¾‹ï¼š 127.0.0.1:6379> RPUSH lst a b c d e f (integer) 6 127.0.0.1:6379> LPOP lst \"a\" rpop key å«ä¹‰ï¼šç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œè¿”å›å€¼ä¸ºç§»é™¤çš„å…ƒç´  ç¤ºä¾‹ï¼š 127.0.0.1:6379> RPUSH lst a b c d e f (integer) 6 127.0.0.1:6379> RPOP lst \"f\" lpush key value1 [value2] å«ä¹‰ï¼šå°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ°åˆ—è¡¨å¤´éƒ¨ ç¤ºä¾‹ï¼š 127.0.0.1:6379> LPUSH lst aaa bbb (integer) 5 lpushx key value å«ä¹‰ï¼šå°†ä¸€ä¸ªå€¼æ’å…¥åˆ°å·²å­˜åœ¨çš„åˆ—è¡¨å¤´éƒ¨ ç¤ºä¾‹ï¼š 127.0.0.1:6379> LPUSHX lst 123 (integer) 6 #æ’å…¥ä¸€ä¸ªä¸å­˜åœ¨çš„åˆ—è¡¨ï¼Œè¿”å›å€¼ä¸º0 127.0.0.1:6379> LPUSHX lst1 123 (integer) 0 lrange key start stop å«ä¹‰ï¼šè·å–åˆ—è¡¨æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼Œä¸‹æ ‡ä»0å¼€å§‹ ç¤ºä¾‹ï¼š 127.0.0.1:6379> LRANGE lst 1 3 1) \"bbb\" 2) \"aaa\" 3) \"c\" 127.0.0.1:6379> LRANGE lst 0 3 1) \"123\" 2) \"bbb\" 3) \"aaa\" 4) \"c\" lrem key count value å«ä¹‰ï¼šç§»é™¤åˆ—è¡¨å…ƒç´  countçš„å€¼ count > 0 : ä»è¡¨å¤´å¼€å§‹å‘è¡¨å°¾æœç´¢ï¼Œç§»é™¤ä¸ VALUE ç›¸ç­‰çš„å…ƒç´ ï¼Œæ•°é‡ä¸º COUNT ã€‚ count count = 0 : ç§»é™¤è¡¨ä¸­æ‰€æœ‰ä¸ VALUE ç›¸ç­‰çš„å€¼ã€‚ ç¤ºä¾‹ï¼š #rpushæ’å…¥å…ƒç´ ï¼Œå› æ­¤å…ƒç´ ä»å·¦å¾€å³ä¸ºa b c a b c 127.0.0.1:6379> RPUSH lst a b c a b c (integer) 6 #ä»è¡¨å¤´å¼€å§‹å‘è¡¨å°¾æœç´¢ï¼Œç§»é™¤2ä¸ªä¸aç›¸ç­‰çš„å…ƒç´ ï¼Œæ‰€ä»¥åˆ—è¡¨ä¸­å‰©ä¸‹çš„å…ƒç´ æ˜¯b c b c 127.0.0.1:6379> LREM lst 2 a (integer) 2 127.0.0.1:6379> LRANGE lst 0 -1 1) \"b\" 2) \"c\" 3) \"b\" 4) \"c\" lset key index value å«ä¹‰ï¼šé€šè¿‡ç´¢å¼•è®¾ç½®åˆ—è¡¨å…ƒç´ çš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> RPUSH lst a b c a b c (integer) 6 127.0.0.1:6379> LSET lst 0 hehe OK 127.0.0.1:6379> LRANGE lst 0 -1 1) \"hehe\" 2) \"b\" 3) \"c\" 4) \"a\" 5) \"b\" 6) \"c\" ltrim key start stop å«ä¹‰ï¼šå¯¹ä¸€ä¸ªåˆ—è¡¨è¿›è¡Œä¿®å‰ª(trim)ï¼Œå°±æ˜¯è¯´ï¼Œè®©åˆ—è¡¨åªä¿ç•™æŒ‡å®šåŒºé—´å†…çš„å…ƒç´ ï¼Œä¸åœ¨æŒ‡å®šåŒºé—´ä¹‹å†…çš„å…ƒç´ éƒ½å°†è¢«åˆ é™¤ ç¤ºä¾‹ï¼š #æ’å…¥å…ƒç´  127.0.0.1:6379> RPUSH lst a b c d e f (integer) 6 #ä¿ç•™ä»ä¸‹æ ‡1å¼€å§‹åˆ°ç»“å°¾ï¼Œå³æŠŠä¸‹æ ‡ä¸º0çš„ç¬¬ä¸€ä¸ªå…ƒç´ åˆ é™¤ 127.0.0.1:6379> LTRIM lst 1 -1 OK #ä¸‹æ ‡ä¸º0çš„å…ƒç´ è¢«åˆ é™¤ 127.0.0.1:6379> LRANGE lst 0 -1 1) \"b\" 2) \"c\" 3) \"d\" 4) \"e\" 5) \"f\" RPOPLPUSH source destination å«ä¹‰ï¼šç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°†è¯¥å…ƒç´ æ·»åŠ åˆ°å¦ä¸€ä¸ªåˆ—è¡¨å¹¶è¿”å› ç¤ºä¾‹ï¼š 127.0.0.1:6379> RPUSH lst1 aaa (integer) 1 127.0.0.1:6379> RPUSH lst2 bbb ccc (integer) 2 127.0.0.1:6379> RPOPLPUSH lst1 lst2 \"aaa\" 127.0.0.1:6379> LRANGE lst2 0 -1 1) \"aaa\" 2) \"bbb\" 3) \"ccc\" rpushx key value å«ä¹‰ï¼šä¸ºå·²å­˜åœ¨çš„åˆ—è¡¨æ·»åŠ å€¼ï¼Œæ¯æ¬¡åªèƒ½æ·»åŠ ä¸€ä¸ªå€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> RPUSH lst a b c (integer) 3 127.0.0.1:6379> RPUSHX lst d (integer) 4 127.0.0.1:6379> LRANGE lst 0 -1 1) \"a\" 2) \"b\" 3) \"c\" 4) \"d\" æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/redisæ•°æ®ç±»å‹/3.redisæ•°æ®ç±»å‹-hashå­—å…¸.html":{"url":"db/redis/redisæ•°æ®ç±»å‹/3.redisæ•°æ®ç±»å‹-hashå­—å…¸.html","title":"hash å­—å…¸","keywords":"","body":"redisæ•°æ®ç±»å‹ hash å­—å…¸ hash(å­—å…¸) ç®€ä»‹ï¼š é”®å€¼å¯¹é›†åˆï¼Œå³ç¼–ç¨‹è¯­è¨€ä¸­çš„mapç±»å‹ å¯ä»¥å­˜å‚¨çš„å€¼ï¼š é€‚åˆå­˜å‚¨å¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥åƒæ•°æ®åº“ä¸­çš„updateä¸€æ ·ï¼Œåªä¿®æ”¹æŸä¸€é¡¹çš„å±æ€§å€¼ æ“ä½œï¼š æ·»åŠ ã€è·å–ã€ç§»é™¤å•ä¸ªé”®å€¼å¯¹ï¼Œè·å–æ‰€æœ‰é”®å€¼å¯¹ï¼Œæ£€æŸ¥æŸä¸ªé”®æ˜¯å¦å­˜åœ¨ åº”ç”¨åœºæ™¯ï¼š å­˜å‚¨ã€è¯»å–ã€ä¿®æ”¹ç”¨æˆ·å±æ€§ èŒƒå›´ï¼šRedis ä¸­æ¯ä¸ª hash å¯ä»¥å­˜å‚¨ 2^32 - 1 é”®å€¼å¯¹ï¼ˆ40å¤šäº¿ï¼‰ ä½¿ç”¨ç¤ºä¾‹: #å®šä¹‰ä¸€ä¸ªå“ˆå¸Œmanï¼Œæœ‰åå­—ã€å¹´é¾„ã€ä½“é‡æè¿°ä¿¡æ¯ 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HGETALL man 1) \"name\" 2) \"xiaoming\" 3) \"age\" 4) \"18\" 5) \"weight\" 6) \"60kg\" rediså“ˆå¸Œå¸¸ç”¨å‘½ä»¤ hdel key field1 [field2] å«ä¹‰ï¼šåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå“ˆå¸Œè¡¨å­—æ®µ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HGETALL man 1) \"name\" 2) \"xiaoming\" 3) \"age\" 4) \"18\" 5) \"weight\" 6) \"60kg\" #åˆ é™¤å“ˆå¸Œä¸­çš„weightå­—æ®µ 127.0.0.1:6379> HDEL man weight (integer) 1 127.0.0.1:6379> HGETALL man 1) \"name\" 2) \"xiaoming\" 3) \"age\" 4) \"18\" hexists key field å«ä¹‰ï¼šæŸ¥çœ‹å“ˆå¸Œè¡¨keyä¸­ï¼ŒæŒ‡å®šçš„å­—æ®µæ˜¯å¦å­˜åœ¨ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HEXISTS man name (integer) 1 127.0.0.1:6379> HEXISTS man sex (integer) 0 hget key fidle å«ä¹‰ï¼šè·å–å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®šå­—æ®µçš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HGET man name \"xiaoming\" hincrby key fidle increment å«ä¹‰ï¼šä¸ºå“ˆå¸Œè¡¨keyä¸­çš„æŒ‡å®šå­—æ®µçš„æ•´æ•°å€¼åŠ ä¸Šå¢é‡ increment ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HINCRBY man age 2 (integer) 20 127.0.0.1:6379> HGET man age \"20\" hincrbyfloat key field increment å«ä¹‰ï¼šä¸ºå“ˆå¸Œè¡¨keyä¸­çš„æŒ‡å®šå­—æ®µçš„æµ®ç‚¹æ•°å€¼åŠ ä¸Šå¢é‡ increment ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HINCRBYFLOAT man age 0.5 \"18.5\" 127.0.0.1:6379> HGET man age \"18.5\" hkeys key å«ä¹‰ï¼šè·å–æ‰€æœ‰å“ˆå¸Œè¡¨ä¸­çš„å­—æ®µ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HKEYS man 1) \"name\" 2) \"age\" 3) \"weight\" hvals key å«ä¹‰ï¼šè·å–å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HVALS man 1) \"xiaoming\" 2) \"18\" 3) \"60kg\" hlen key å«ä¹‰ï¼šè·å–å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HLEN man (integer) 3 hmget key field1 [field2] å«ä¹‰ï¼šè·å–æ‰€æœ‰ç»™å®šå­—æ®µçš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK 127.0.0.1:6379> HMGET man name age 1) \"xiaoming\" 2) \"18\" hmset key field1 value1 [field2 value2] å«ä¹‰ï¼šåŒæ—¶å°†å¤šä¸ªfield-value (åŸŸ-å€¼)å¯¹è®¾ç½®åˆ°å“ˆå¸Œè¡¨keyä¸­ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HMSET man name \"xiaoming\" age 18 weight \"60kg\" OK hset key field value å«ä¹‰ï¼šå°†å“ˆå¸Œè¡¨keyä¸­çš„å­—æ®µfieldçš„å€¼è®¾ä¸º value ç¤ºä¾‹ï¼š 127.0.0.1:6379> HSET man name \"xiaoming\" (integer) 1 hsetnx key field value å«ä¹‰ï¼šåªæœ‰åœ¨å­—æ®µfieldä¸å­˜åœ¨æ—¶ï¼Œè®¾ç½®å“ˆå¸Œè¡¨å­—æ®µçš„å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> HSETNX hehe name \"hehe\" (integer) 1 scanã€sscanã€hscanã€zscan SSCAN å‘½ä»¤ã€ HSCAN å‘½ä»¤å’Œ ZSCAN å‘½ä»¤çš„ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯ä¸€ä¸ªæ•°æ®åº“é”®ã€‚ è€Œ SCAN å‘½ä»¤åˆ™ä¸éœ€è¦åœ¨ç¬¬ä¸€ä¸ªå‚æ•°æä¾›ä»»ä½•æ•°æ®åº“é”® â€”â€” å› ä¸ºå®ƒè¿­ä»£çš„æ˜¯å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®åº“é”®ã€‚ scan cursor [MATCH pattern] [COUNT count] å«ä¹‰ï¼šç”¨äºè¿­ä»£å½“å‰æ•°æ®åº“ä¸­çš„æ•°æ®åº“é”® ç¤ºä¾‹ï¼š sscan å«ä¹‰ï¼šç”¨äºè¿­ä»£é›†åˆé”®ä¸­çš„å…ƒç´  ç¤ºä¾‹ï¼š hscan å«ä¹‰ï¼šç”¨äºè¿­ä»£å“ˆå¸Œé”®ä¸­çš„é”®å€¼å¯¹ ç¤ºä¾‹ï¼š zscan å«ä¹‰ï¼šç”¨äºè¿­ä»£æœ‰åºé›†åˆä¸­çš„å…ƒç´ ï¼ˆåŒ…æ‹¬å…ƒç´ æˆå‘˜å’Œå…ƒç´ åˆ†å€¼ï¼‰ ç¤ºä¾‹ï¼š æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/redisæ•°æ®ç±»å‹/4.redisæ•°æ®ç±»å‹-seté›†åˆ.html":{"url":"db/redis/redisæ•°æ®ç±»å‹/4.redisæ•°æ®ç±»å‹-seté›†åˆ.html","title":"set é›†åˆ","keywords":"","body":"redisæ•°æ®ç±»å‹ set é›†åˆ ç®€ä»‹ï¼š hashè¡¨å®ç°ï¼Œå…ƒç´ ä¸é‡å¤ å¯ä»¥å­˜å‚¨çš„å€¼ï¼š æ— åºé›†åˆ æ“ä½œï¼š æ·»åŠ ã€è·å–ã€ç§»é™¤å•ä¸ªå…ƒç´ ï¼Œæ£€æŸ¥ä¸€ä¸ªå…ƒç´ æ˜¯å¦å·²ç»å­˜åœ¨äºé›†åˆä¸­ï¼Œè®¡ç®—äº¤é›†ã€å¹¶é›†ã€å·®é›†ä»é›†åˆé‡Œé¢éšæœºè·å–å…ƒç´  åº”ç”¨åœºæ™¯ï¼š å…±åŒå¥½å‹ï¼›åˆ©ç”¨å”¯ä¸€æ€§ï¼Œç»Ÿè®¡è®¿é—®ç½‘ç«™çš„æ‰€æœ‰IP èŒƒå›´ï¼šé›†åˆä¸­æœ€å¤§çš„æˆå‘˜æ•°ä¸º 2^32 - 1 (4294967295, æ¯ä¸ªé›†åˆå¯å­˜å‚¨40å¤šäº¿ä¸ªæˆå‘˜) ä½¿ç”¨ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s a (integer) 1 127.0.0.1:6379> SADD s b (integer) 1 127.0.0.1:6379> SADD s c (integer) 1 127.0.0.1:6379> SMEMBERS s 1) \"b\" 2) \"c\" 3) \"a\" redisé›†åˆå¸¸ç”¨å‘½ä»¤ sadd key member1 [member2] å«ä¹‰ï¼šå‘é›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s aaa bbb ccc (integer) 3 scard key å«ä¹‰ï¼šè·å–é›†åˆçš„æˆå‘˜æ•° ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s aaa bbb ccc (integer) 3 127.0.0.1:6379> SCARD s (integer) 3 sdiff key1 [key2] å«ä¹‰ï¼šè¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„å·®é›†ï¼Œâš ï¸è¿”å›çš„å·®é›†æ¥è‡ªç¬¬ä¸€ä¸ªkeyï¼Œè€Œä¸æ˜¯åè¾¹çš„key ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s aaa bbb ccc (integer) 3 127.0.0.1:6379> SADD s1 aaa ccc ddd eee fff (integer) 5 127.0.0.1:6379> SDIFF s s1 1) \"bbb\" #å·®é›†ç»“æœæ˜¯bbbï¼Œsåœ¨s1ä¸­æœ‰çš„å…ƒç´ æ˜¯aaa cccï¼Œæ²¡æœ‰bbbï¼Œå› ä¸ºå·®é›†ç»“æœæ¥è‡ªç¬¬ä¸€ä¸ªkeyï¼Œä¹Ÿå°±æ˜¯sï¼Œå³aaa bbb cccï¼Œè‚¯å®šæ˜¯è¿™3ä¸ªå…ƒç´ ä¸­çš„æŸä¸€ä¸ªæˆ–è€…å¤šä¸ªæˆ–è€…æ²¡æœ‰ 127.0.0.1:6379> SDIFF s s1 1) \"bbb\" sdiffstore destination key1 [key2] å«ä¹‰ï¼šè¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„å·®é›†å¹¶å­˜å‚¨åœ¨ destination ä¸­ ç¤ºä¾‹ï¼š #å‘é›†åˆs1ã€s2ä¸­æ’å…¥å…ƒç´  127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SADD s2 aaa ccc ddd (integer) 3 #æŠŠs1å’Œs2çš„å·®é›†å­˜å‚¨åœ¨s3ä¸­ 127.0.0.1:6379> SDIFFSTORE s3 s1 s2 (integer) 1 127.0.0.1:6379> SMEMBERS s3 1) \"bbb\" sinter key1 [key2] å«ä¹‰ï¼šè¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„äº¤é›† ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SADD s2 bbb ddd fff (integer) 3 127.0.0.1:6379> SADD s3 ggg bbb kkk (integer) 3 127.0.0.1:6379> SINTER s1 s2 s3 1) \"bbb\" sinterstore destination key1 å«ä¹‰ï¼šè¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åœ¨ destination ä¸­ ç¤ºä¾‹ï¼š 27.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SADD s2 bbb ddd fff (integer) 3 127.0.0.1:6379> SADD s3 ggg bbb kkk (integer) 3 127.0.0.1:6379> SINTERSTORE s4 s1 s2 s3 (integer) 1 127.0.0.1:6379> SMEMBERS s4 1) \"bbb\" sismember key member å«ä¹‰ï¼šåˆ¤æ–­memberå…ƒç´ æ˜¯å¦æ˜¯é›†åˆ key çš„æˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SISMEMBER s1 bbb (integer) 1 127.0.0.1:6379> SISMEMBER s1 ddd (integer) 0 smembers key å«ä¹‰ï¼šè¿”å›é›†åˆä¸­çš„æ‰€æœ‰æˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SMEMBERS s1 1) \"bbb\" 2) \"ccc\" 3) \"aaa\" smove source destination member å«ä¹‰ï¼šå°†memberå…ƒç´ ä»sourceé›†åˆç§»åŠ¨åˆ°destinationé›†åˆ ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SMOVE s1 s2 bbb (integer) 1 127.0.0.1:6379> SMEMBERS s1 1) \"ccc\" 2) \"aaa\" 127.0.0.1:6379> SMEMBERS s2 1) \"bbb\" spop key å«ä¹‰ï¼šç§»é™¤å¹¶è¿”å›é›†åˆä¸­çš„ä¸€ä¸ªéšæœºå…ƒç´  ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SPOP s1 \"bbb\" 127.0.0.1:6379> SPOP s1 \"aaa\" 127.0.0.1:6379> SPOP s1 \"ccc\" 127.0.0.1:6379> SPOP s1 (nil) srandmember key [count] å«ä¹‰ï¼šè¿”å›é›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªéšæœºæ•°ï¼Œcountä¸å†™é»˜è®¤è¿”å›ä¸€ä¸ª ç¤ºä¾‹ï¼š 127.0.0.1:6379> SRANDMEMBER s1 2 1) \"bbb\" 2) \"ccc\" 127.0.0.1:6379> SRANDMEMBER s1 \"bbb\" srem key member1 [member2] å«ä¹‰ï¼šç§»é™¤é›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SREM s1 aaa (integer) 1 127.0.0.1:6379> SMEMBERS s1 1) \"bbb\" 2) \"ccc\" sunion key1 [key2] å«ä¹‰ï¼šè¿”å›æ‰€æœ‰ç»™å®šé›†åˆçš„å¹¶é›† ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SADD s2 ccc ddd eee (integer) 3 127.0.0.1:6379> SUNION s1 s2 1) \"aaa\" 2) \"ccc\" 3) \"bbb\" 4) \"eee\" 5) \"ddd\" sunionstore destination key1 [key2] å«ä¹‰ï¼šæ‰€æœ‰ç»™å®šé›†åˆçš„å¹¶é›†å­˜å‚¨åœ¨destinationé›†åˆä¸­ ç¤ºä¾‹ï¼š 127.0.0.1:6379> SADD s1 aaa bbb ccc (integer) 3 127.0.0.1:6379> SADD s2 ccc ddd eee (integer) 3 127.0.0.1:6379> SUNIONSTORE s3 s1 s2 (integer) 5 127.0.0.1:6379> SMEMBERS s3 1) \"aaa\" 2) \"ccc\" 3) \"bbb\" 4) \"eee\" 5) \"ddd\" SSCAN key cursor [MATCH pattern] [COUNT count å«ä¹‰ï¼šè¿­ä»£é›†åˆä¸­çš„å…ƒç´  ç¤ºä¾‹ï¼š æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/redis/redisæ•°æ®ç±»å‹/5.redisæ•°æ®ç±»å‹-zsetæœ‰åºé›†åˆ.html":{"url":"db/redis/redisæ•°æ®ç±»å‹/5.redisæ•°æ®ç±»å‹-zsetæœ‰åºé›†åˆ.html","title":"zset æœ‰åºé›†åˆ","keywords":"","body":"redisæ•°æ®ç±»å‹ zset æœ‰åºé›†åˆ ç®€ä»‹ï¼š å°† set ä¸­çš„å…ƒç´ å¢åŠ ä¸€ä¸ªæƒé‡å‚æ•°scoreï¼Œå…ƒç´ æŒ‰scoreæœ‰åºæ’åˆ— å¯ä»¥å­˜å‚¨çš„å€¼ï¼š æœ‰åºé›†åˆ æ“ä½œï¼š æ·»åŠ ã€è·å–ã€åˆ é™¤å…ƒç´ ï¼Œæ ¹æ®åˆ†å€¼èŒƒå›´æˆ–è€…æˆå‘˜æ¥è·å–å…ƒç´ ï¼Œè®¡ç®—ä¸€ä¸ªé”®çš„æ’å åº”ç”¨åœºæ™¯ï¼š æ’è¡Œæ¦œï¼›å¸¦æƒé‡çš„æ¶ˆæ¯é˜Ÿåˆ— èŒƒå›´ï¼šé›†åˆä¸­æœ€å¤§çš„æˆå‘˜æ•°ä¸º 2^32 - 1 (4294967295, æ¯ä¸ªé›†åˆå¯å­˜å‚¨40å¤šäº¿ä¸ªæˆå‘˜)ã€‚ ç‰¹ç‚¹ï¼šæ¯ä¸ªå…ƒç´ éƒ½ä¼šå…³è”ä¸€ä¸ªdoubleç±»å‹çš„åˆ†æ•°ã€‚redisæ­£æ˜¯é€šè¿‡åˆ†æ•°æ¥ä¸ºé›†åˆä¸­çš„æˆå‘˜è¿›è¡Œä»å°åˆ°å¤§çš„æ’åºã€‚æœ‰åºé›†åˆçš„æˆå‘˜æ˜¯å”¯ä¸€çš„ï¼Œä½†åˆ†æ•°(score)å´å¯ä»¥é‡å¤ã€‚ ä½¿ç”¨ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 aaa (integer) 1 127.0.0.1:6379> ZADD z1 2 bbb (integer) 1 127.0.0.1:6379> ZADD z1 3 ccc (integer) 1 127.0.0.1:6379> ZRANGE z1 0 -1 1) \"aaa\" 2) \"bbb\" 3) \"ccc\" redisæœ‰åºé›†åˆå¸¸ç”¨å‘½ä»¤ zadd key score1 member1 å«ä¹‰ï¼šå‘æœ‰åºé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ï¼Œæˆ–è€…æ›´æ–°å·²å­˜åœ¨æˆå‘˜çš„åˆ†æ•° ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c (integer) 3 127.0.0.1:6379> ZRANGE z1 0 -1 1) \"a\" 2) \"b\" 3) \"c\" zcard key å«ä¹‰ï¼šè·å–æœ‰åºé›†åˆçš„æˆå‘˜æ•° ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c (integer) 3 127.0.0.1:6379> ZCARD z1 (integer) 3 zcount key min max å«ä¹‰ï¼šè®¡ç®—åœ¨æœ‰åºé›†åˆä¸­æŒ‡å®šåŒºé—´åˆ†æ•°çš„æˆå‘˜æ•° ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 aaa (integer) 1 127.0.0.1:6379> ZADD z1 1 bbb (integer) 1 127.0.0.1:6379> ZADD z1 2 ccc (integer) 1 127.0.0.1:6379> ZADD z1 3 ddd (integer) 1 127.0.0.1:6379> ZADD z1 4 eee (integer) 1 127.0.0.1:6379> ZCOUNT z1 1 3 (integer) 4 zincrby key increment member å«ä¹‰ï¼šæœ‰åºé›†åˆä¸­å¯¹æŒ‡å®šæˆå‘˜çš„åˆ†æ•°åŠ ä¸Šå¢é‡ increment ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 aaa (integer) 1 127.0.0.1:6379> ZINCRBY z1 5 1 \"5\" zinterstore destination numkeys key [key ...] å«ä¹‰ï¼šè®¡ç®—ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰åºé›†çš„äº¤é›†å¹¶å°†ç»“æœé›†å­˜å‚¨åœ¨æ–°çš„æœ‰åºé›†åˆ key ä¸­ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 aaa 2 bbb 3 ccc 4 ddd 5 eee 6 fff (integer) 6 127.0.0.1:6379> ZADD z2 1 aaa 2 bbb 3 ccc 5 hhh 6 ttt 9 wwww (integer) 6 #è¿™é‡Œå¿…é¡»è¦æŒ‡å®šä¸€ä¸‹æœ‰åºé›†åˆçš„ä¸ªæ•° 127.0.0.1:6379> ZINTERSTORE z3 2 z1 z2 (integer) 3 127.0.0.1:6379> ZRANGE z3 0 -1 1) \"aaa\" 2) \"bbb\" 3) \"ccc\" zlexcount key min max å«ä¹‰ï¼šåœ¨æœ‰åºé›†åˆä¸­è®¡ç®—æŒ‡å®šå­—å…¸åŒºé—´å†…æˆå‘˜æ•°é‡ ç¤ºä¾‹ï¼š zrange key start stop [WITHSCORES] å«ä¹‰ï¼šé€šè¿‡ç´¢å¼•åŒºé—´è¿”å›æœ‰åºé›†åˆæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c (integer) 3 127.0.0.1:6379> ZRANGE z1 0 -1 1) \"a\" 2) \"b\" 3) \"c\" zrangebylex key min max [LIMIT offset count] å«ä¹‰ï¼šé€šè¿‡å­—å…¸åŒºé—´è¿”å›æœ‰åºé›†åˆçš„æˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZRANGEBYLEX z1 [b [e 1) \"b\" 2) \"c\" 3) \"d\" 4) \"e\" zrangebyscore key min max [WITHSCORES] [LIMIT] å«ä¹‰ï¼šé€šè¿‡åˆ†æ•°è¿”å›æœ‰åºé›†åˆæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZRANGEBYSCORE z1 2 5 1) \"b\" 2) \"c\" 3) \"d\" 4) \"e\" zrank key member å«ä¹‰ï¼šè¿”å›æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜çš„ç´¢å¼• ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZRANGE z1 0 3 1) \"a\" 2) \"b\" 3) \"c\" 4) \"d\" zrem key member1 [member2 ...] å«ä¹‰ï¼šç§»é™¤æœ‰åºé›†åˆä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZREM z1 a c (integer) 2 127.0.0.1:6379> ZRANGE z1 0 -1 1) \"b\" 2) \"d\" 3) \"e\" 4) \"f\" zremrangebylex key min max å«ä¹‰ï¼šç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„å­—å…¸åŒºé—´çš„æ‰€æœ‰æˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZREMRANGEBYLEX z1 [c [e (integer) 3 127.0.0.1:6379> ZRANGE z1 0 -1 1) \"a\" 2) \"b\" 3) \"f\" zremrangebyrank key start stop å«ä¹‰ï¼šç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„æ’ååŒºé—´ï¼ˆä¸‹æ ‡ï¼‰çš„æ‰€æœ‰æˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZREMRANGEBYRANK z1 0 3 (integer) 4 127.0.0.1:6379> ZRANGE z1 0 -1 1) \"e\" 2) \"f\" zremrangebyscore key min max å«ä¹‰ï¼šç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„åˆ†æ•°åŒºé—´çš„æ‰€æœ‰æˆå‘˜ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZREMRANGEBYSCORE z1 2 5 (integer) 4 127.0.0.1:6379> ZRANGE z1 0 -1 1) \"a\" 2) \"f\" zrevrange key start stop [WITHSCORES] å«ä¹‰ï¼šè¿”å›æœ‰åºé›†åˆä¸­æŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ï¼Œé€šè¿‡ç´¢å¼•ï¼Œåˆ†æ•°ä»é«˜åˆ°ä½ï¼Œç´¢å¼•ä¸º0çš„å…ƒç´ åœ¨æœ€å ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 #è¿™é‡Œçš„ä¸‹æ ‡ä¹Ÿæ˜¯ä»0å¼€å§‹ï¼Œä½†æ˜¯ä¸‹æ ‡ä¸º0çš„å…ƒç´ åœ¨æœ€å 127.0.0.1:6379> ZREVRANGE z1 1 3 1) \"e\" 2) \"d\" 3) \"c\" 127.0.0.1:6379> ZREVRANGE z1 0 1 1) \"f\" 2) \"e\" zrevrangebyscore key max min [WITHSCORES] å«ä¹‰ï¼šè¿”å›æœ‰åºé›†ä¸­æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æˆå‘˜ï¼Œåˆ†æ•°ä»é«˜åˆ°ä½æ’åº ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZREVRANGEBYSCORE z1 3 1 1) \"c\" 2) \"b\" 3) \"a\" zrevrank key member å«ä¹‰ï¼šè¿”å›æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜çš„æ’åï¼Œæœ‰åºé›†æˆå‘˜æŒ‰åˆ†æ•°å€¼é€’å‡(ä»å¤§åˆ°å°)æ’åº ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZREVRANK z1 c (integer) 3 zscore key member å«ä¹‰ï¼šè¿”å›æœ‰åºé›†ä¸­ï¼Œæˆå‘˜çš„åˆ†æ•°å€¼ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 a 2 b 3 c 4 d 5 e 6 f (integer) 6 127.0.0.1:6379> ZSCORE z1 f \"6\" zunionstore destination numkeys key1 [key2 ...] å«ä¹‰ï¼šè®¡ç®—ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰åºé›†çš„å¹¶é›†ï¼Œå¹¶å­˜å‚¨åœ¨æ–°çš„ key ä¸­ ç¤ºä¾‹ï¼š 127.0.0.1:6379> ZADD z1 1 aaa 2 bbb 3 ccc (integer) 3 127.0.0.1:6379> ZADD z2 1 aaa 2 ttt 3 vvv (integer) 3 127.0.0.1:6379> ZUNIONSTORE z3 2 z1 z2 (integer) 5 127.0.0.1:6379> ZRANGE z3 0 -1 1) \"aaa\" 2) \"bbb\" 3) \"ttt\" 4) \"ccc\" 5) \"vvv\" zscan key cursor [MATCH pattern] [COUNT count] å«ä¹‰ï¼šè¿­ä»£æœ‰åºé›†åˆä¸­çš„å…ƒç´ ï¼ˆåŒ…æ‹¬å…ƒç´ æˆå‘˜å’Œå…ƒç´ åˆ†å€¼ï¼‰ ç¤ºä¾‹ï¼š æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"db/mongodb/centos7å®‰è£…mongodb.html":{"url":"db/mongodb/centos7å®‰è£…mongodb.html","title":"centos7å®‰è£…mongodb","keywords":"","body":"centos7å®‰è£…mongodb mongodbå®˜ç½‘ mongodbå®˜æ–¹æ–‡æ¡£ mongodbç¤¾åŒºç‰ˆå®˜æ–¹ä¸‹è½½åœ°å€ mongodb githubåœ°å€ ä¸€ã€yumå®‰è£… 1.1 æ·»åŠ æ¸…åyumæº cat > /etc/yum.repos.d/mongodb.repo yum makecache 1.2 å®‰è£…ç¤¾åŒºç‰ˆmongodb å®‰è£…æœ€æ–°ç‰ˆ yum -y install mongodb-org å®‰è£…æŒ‡å®šç‰ˆæœ¬ yum -y install mongodb-org-4.2.8 mongodb-org-server-4.2.8 mongodb-org-shell-4.2.8 mongodb-org-mongos-4.2.8 mongodb-org-tools-4.2.8 1.3 å¯åŠ¨mongodb systemctl enable mongod && systemctl start mongod mongodbç›‘å¬tcp/27017 $ netstat -ntpl|grep 27017 tcp 0 0 127.0.0.1:27017 0.0.0.0:* LISTEN 17976/mongod mongodbé»˜è®¤ä»¥mongodç”¨è¿è¡Œ $ ps aux|grep [m]ongo mongod 17976 0.6 7.8 1552904 78904 ? Sl 22:04 0:00 /usr/bin/mongod -f /etc/mongod.conf 1.4 mongodbç›¸å…³ç›®å½•æ–‡ä»¶ mongodbé…ç½®æ–‡ä»¶/etc/mongod.conf mongodbæ—¥å¿—æ–‡ä»¶/var/log/mongodb/mongod.log mongodb PIDæ–‡ä»¶/run/mongodb/mongod.pid mongodb SOCKETæ–‡ä»¶/tmp/mongodb-27017.sock mongodbæ•°æ®ç›®å½•/var/lib/mongo/ äºŒã€äºŒè¿›åˆ¶å®‰è£… mongodb4.2äºŒè¿›åˆ¶å®‰è£…å®˜æ–¹æ–‡æ¡£ 2.1 å®‰è£…ä¾èµ–åŒ… yum -y install libcurl openssl 2.2 ä¸‹è½½äºŒè¿›åˆ¶åŒ… wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.2.8.tgz 2.3 è§£å‹ç¼©åŒ… tar xf mongodb-linux-x86_64-rhel70-4.2.8.tgz -C /usr/local/ 2.4 åšè½¯è¿æ¥ ln -s /usr/local/mongodb-linux-x86_64-rhel70-4.2.8/ /usr/local/mongodb-4.2.8 2.5 å¯¼å‡ºPATHç¯å¢ƒå˜é‡ echo 'export PATH=/usr/local/mongodb-4.2.8/bin:$PATH' >/etc/profile.d/mongodb.sh && source /etc/profile 2.6 åˆ›å»ºç›¸å…³ç›®å½• #åˆ›å»ºæ•°æ®ã€æ—¥å¿—ã€pidã€é…ç½®æ–‡ä»¶ç›®å½• mkdir -p /data/db/mongodb/{data,log,pid,conf} 2.7 åˆ›å»ºmongodç”¨æˆ· useradd mongod -s /sbin/nologin -M 2.8 ç¼–è¾‘mongodbé…ç½®æ–‡ä»¶ cat > /data/db/mongodb/conf/mongod.conf 2.9 è®¾ç½®ç›®å½•æ‰€æœ‰è€…ä¸ºmongod chown -R mongod:mongod /data/db/mongodb 2.10 ä½¿ç”¨supervisorç®¡ç†mongodb cat >/etc/supervisor/config.d/mongodb.ini $ supervisorctl update mongodb mongodb: added process group 2.11 æŸ¥çœ‹mongodbè¿è¡ŒçŠ¶æ€ æŸ¥çœ‹mongodbè¿›ç¨‹ $ ps aux|grep [m]ongodb mongod 30352 1.5 2.2 1550840 89140 ? Sl 20:18 0:00 /usr/local/mongodb-4.2.8/bin/mongod -f /data/db/mongodb/conf/mongod.conf mongodbç›‘å¬TCP/27010ç«¯å£ $ netstat -ntpl|grep mongod tcp 0 0 10.0.0.31:27010 0.0.0.0:* LISTEN 30352/mongod 2.12 è¿æ¥mongodb $ mongo 10.0.0.31:27010 MongoDB shell version v4.2.8 connecting to: mongodb://10.0.0.31:27010/test?compressors=disabled&gssapiServiceName=mongodb Implicit session: session { \"id\" : UUID(\"f87cbfff-d5b5-4f72-b378-15547f61fdca\") } MongoDB server version: 4.2.8 Server has startup warnings: 2020-07-01T20:18:05.560+0800 I CONTROL [initandlisten] 2020-07-01T20:18:05.560+0800 I CONTROL [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is 'always'. 2020-07-01T20:18:05.560+0800 I CONTROL [initandlisten] ** We suggest setting it to 'never' 2020-07-01T20:18:05.560+0800 I CONTROL [initandlisten] 2020-07-01T20:18:05.560+0800 I CONTROL [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is 'always'. 2020-07-01T20:18:05.560+0800 I CONTROL [initandlisten] ** We suggest setting it to 'never' 2020-07-01T20:18:05.560+0800 I CONTROL [initandlisten] --- Enable MongoDB's free cloud-based monitoring service, which will then receive and display metrics about your deployment (disk utilization, CPU, operation statistics, etc). The monitoring data will be available on a MongoDB website with a unique URL accessible to you and anyone you share the URL with. MongoDB may use this information to make product improvements and to suggest MongoDB products and deployment options to you. To enable free monitoring, run the following command: db.enableFreeMonitoring() To permanently disable this reminder, run the following command: db.disableFreeMonitoring() --- > show databases admin 0.000GB config 0.000GB local 0.000GB ç”Ÿäº§ç¯å¢ƒé…ç½® bind_ip = 172.20.1.40 logpath = /data/db/mongodb/logs/mongod.log logappend = true pidfilepath = /data/db/mongodb/pid/mongod.pid dbpath = /data/db/mongodb/data storageEngine = wiredTiger directoryperdb = true #replSet = replset #rest = true oplogSize = 61440 #fork = true auth = false shardsvr = true port = 27010 journal = true maxConns = 30000 master = true #slave = true #source = 10.31.133.145:27010 #source = 10.47.125.99:27010 autoresync=true æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/1.shellç®€ä»‹.html":{"url":"linux/shell/1.shellç®€ä»‹.html","title":"shellç®€ä»‹","keywords":"","body":"shellç®€ä»‹ ä¸€ã€ä»€ä¹ˆæ˜¯shell Shell æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€ç¼–å†™çš„ç¨‹åºï¼Œå®ƒæ˜¯ç”¨æˆ·ä½¿ç”¨ Linux çš„æ¡¥æ¢ã€‚Shell æ—¢æ˜¯ä¸€ç§å‘½ä»¤è¯­è¨€ï¼Œåˆæ˜¯ä¸€ç§ç¨‹åºè®¾è®¡è¯­è¨€ã€‚ Shell æ˜¯æŒ‡ä¸€ç§åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ä¸ªç•Œé¢ï¼Œç”¨æˆ·é€šè¿‡è¿™ä¸ªç•Œé¢è®¿é—®æ“ä½œç³»ç»Ÿå†…æ ¸çš„æœåŠ¡ã€‚ Ken Thompson çš„ sh æ˜¯ç¬¬ä¸€ç§ Unix Shellï¼ŒWindows Explorer æ˜¯ä¸€ä¸ªå…¸å‹çš„å›¾å½¢ç•Œé¢Shellã€‚ kernelï¼šä¸ºè½¯ä»¶æœåŠ¡ï¼Œæ¥æ”¶ç”¨æˆ·æˆ–è½¯ä»¶æŒ‡ä»¤é©±åŠ¨ç¡¬ä»¶ï¼Œå®Œæˆå·¥ä½œ shellï¼šå‘½ä»¤è§£é‡Šå™¨ userï¼šç”¨æˆ·æ¥å£ï¼Œå¯¹æ¥ç”¨æˆ· ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œshellåœ¨æ“ä½œç³»ç»Ÿä¸­èµ·åˆ°äº†æ‰¿æ¥ç”¨æˆ·å’Œç³»ç»Ÿå†…æ ¸çš„ä½œç”¨ã€‚é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨æˆ·å¯¹å†…æ ¸å‘¢ï¼Ÿ åŸå› å¾ˆç®€å•ï¼Œå› ä¸ºå†…æ ¸å¤„ç†çš„éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œè€Œç”¨æˆ·å¤„ç†çš„éƒ½æ˜¯é«˜çº§è¯­è¨€ã€‚ Shell è„šæœ¬ Shell è„šæœ¬ï¼ˆshell scriptï¼‰ï¼Œæ˜¯ä¸€ç§ä¸º shell ç¼–å†™çš„è„šæœ¬ç¨‹åºã€‚ ä¸šç•Œæ‰€è¯´çš„ shell é€šå¸¸éƒ½æ˜¯æŒ‡ shell è„šæœ¬ï¼Œä½†æ˜¯shell å’Œ shell script æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µã€‚ Shell ç¯å¢ƒ Shell ç¼–ç¨‹è·Ÿ JavaScriptã€php ç¼–ç¨‹ä¸€æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªèƒ½ç¼–å†™ä»£ç çš„æ–‡æœ¬ç¼–è¾‘å™¨å’Œä¸€ä¸ªèƒ½è§£é‡Šæ‰§è¡Œçš„è„šæœ¬è§£é‡Šå™¨å°±å¯ä»¥äº†ã€‚ Linux çš„ Shell ç§ç±»ä¼—å¤šï¼Œå¸¸è§çš„æœ‰ï¼š Bourne Shellï¼ˆ/usr/bin/shæˆ–/bin/shï¼‰ Bourne Again Shellï¼ˆ/bin/bashï¼‰ C Shellï¼ˆ/usr/bin/cshï¼‰ K Shellï¼ˆ/usr/bin/kshï¼‰ Shell for Rootï¼ˆ/sbin/shï¼‰ â€¦â€¦ åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œäººä»¬å¹¶ä¸åŒºåˆ† Bourne Shell å’Œ Bourne Again Shellï¼Œæ‰€ä»¥ï¼Œåƒ #!/bin/shï¼Œå®ƒåŒæ ·ä¹Ÿå¯ä»¥æ”¹ä¸º #!/bin/bashã€‚ #! æ˜¯å‘Šè¯‰ç³»ç»Ÿå…¶åè·¯å¾„æ‰€æŒ‡å®šçš„ç¨‹åºå³æ˜¯è§£é‡Šæ­¤è„šæœ¬æ–‡ä»¶çš„ Shell ç¨‹åºã€‚ äºŒã€shellåˆ†ç±» 2.1 äº¤äº’åˆ†ç±» 2.1.1 äº¤äº’å¼shell äº¤äº’å¼ï¼šé¡¾åæ€ä¹‰å°±æ˜¯ shell ä¸ç”¨æˆ·å­˜åœ¨äº¤äº’ï¼Œ ç”¨æˆ·ç™»å½•åï¼Œåœ¨ç»ˆç«¯ä¸Šè¾“å…¥å‘½ä»¤ï¼Œshell ç«‹å³æ‰§è¡Œç”¨æˆ·æäº¤çš„å‘½ä»¤ã€‚ å½“ç”¨æˆ·é€€å‡ºåï¼Œshell ä¹Ÿç»ˆæ­¢äº†ã€‚ 2.1.2 éäº¤äº’å¼shell éäº¤äº’å¼ï¼šå³ shell ä¸ç”¨æˆ·ä¸å­˜åœ¨äº¤äº’ï¼Œè€Œæ˜¯ä»¥ shell script çš„æ–¹å¼æ‰§è¡Œçš„ã€‚ shell è¯»å–å­˜æ”¾åœ¨æ–‡ä»¶ä¸­çš„å‘½ä»¤, å¹¶ä¸”æ‰§è¡Œå®ƒä»¬ï¼Œç±»ä¼¼å¦‚ä¸‹ cat > test.sh 2.2 ç™»é™†åˆ†ç±» 2.2.1 ç™»é™†å¼shell ç™»å½• shell æ˜¯æŒ‡éœ€è¦ç”¨æˆ·åã€å¯†ç ç™»å½•åè¿›å…¥çš„ shellï¼Œæˆ–è€…é€šè¿‡ --login é€‰é¡¹ç”Ÿæˆçš„ shell su - username 2.2.2 éç™»é™†å¼shell éç™»å½•å¼ shell æ˜¯æŒ‡ä¸éœ€è¦è¾“å…¥ç”¨æˆ·åå’Œå¯†ç å³å¯æ‰“å¼€çš„ shellï¼Œæ¯”å¦‚è¾“å…¥å‘½ä»¤ bashæˆ–è€…sh å°±èƒ½è¿›å…¥ä¸€ä¸ªå…¨æ–°çš„éç™»å½• shell å›¾å½¢ç»ˆç«¯ä¸‹æ‰“å¼€çš„å‘½ä»¤çª—å£ è‡ªåŠ¨æ‰§è¡Œçš„shellè„šæœ¬ su username 2.2.3 åŒºåˆ†ç™»é™†å¼shellå’Œéç™»é™†å¼shell åŒºåˆ†æ–¹æ³•ä¸€ å¯ä»¥é€šè¿‡æŸ¥çœ‹ $0 çš„å€¼ï¼Œç™»å½•å¼ shell è¿”å› -bashï¼Œè€Œéç™»å½•å¼ shell è¿”å›çš„æ˜¯ bash #é€šè¿‡ç»ˆç«¯è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ç™»å½•çš„ç™»é™†å¼shell $ echo $0 -bash #é€šè¿‡su usernameç™»é™†çš„éç™»é™†å¼shell $ su www $ echo $0 bash åŒºåˆ†æ–¹æ³•äºŒ æ‰§è¡Œexitå‘½ä»¤å’Œlogoutå‘½ä»¤ æ‰§è¡Œ exit å‘½ä»¤ï¼Œ é€€å‡ºçš„ shell å¯ä»¥æ˜¯ç™»å½•å¼shell æˆ–è€… éç™»å½•å¼ shell ï¼› æ‰§è¡Œ logout å‘½ä»¤ï¼Œåˆ™åªèƒ½é€€å‡ºç™»å½•å¼ shellï¼Œä¸èƒ½é€€å‡ºéç™»å½•å¼ shell æ‰§è¡Œexitå‘½ä»¤ #é€šè¿‡ç»ˆç«¯è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ç™»å½•çš„ç™»é™†å¼shell $ exit ç™»å‡º Connection to 10.0.0.10 closed. #é€šè¿‡su usernameç™»é™†çš„éç™»é™†å¼shell $ su www [www@test1 root]$ exit exit æ‰§è¡Œlogoutå‘½ä»¤ #é€šè¿‡ç»ˆç«¯è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ç™»å½•çš„ç™»é™†å¼shell $ logout Connection to 10.0.0.10 closed. #é€šè¿‡su usernameç™»é™†çš„éç™»é™†å¼shell $ logout bash: logout: ä¸æ˜¯ç™»å½•shell: ä½¿ç”¨ `exit' ä¸‰ã€shellçš„é…ç½®æ–‡ä»¶ ç™»å½•å¼shell è¯»å–é…ç½® æ–‡ä»¶è¿‡ç¨‹ï¼š /etc/profile â€“> /etc/profile.d/*.sh â€“> ~ /.bash_profile â€“> ~ /bashrc â€“> /etc/bashrc éç™»å½•å¼shell è¯»å–é…ç½® æ–‡ä»¶è¿‡ç¨‹ï¼š ~ /.bashrc â€“> /etc/bashrc â€“> /etc/prodile.d/*.sh 3.1 bashçš„é…ç½®æ–‡ä»¶ å…¨å±€é…ç½®æ–‡ä»¶ /etc/profile /etc/profile.d/* /etc/bashrc ä¸ªäººé…ç½®æ–‡ä»¶ ~/.bash_profile ~/.bashrc profileç±»æ–‡ä»¶ä½œç”¨ 1.è®¾å®šç¯å¢ƒå˜é‡ 2.è¿è¡Œå‘½ä»¤æˆ–è„šæœ¬ï¼ˆç™»å½•æ—¶è¿è¡Œçš„è„šæœ¬ï¼‰ bashrcç±»æ–‡ä»¶é…ç½®ä½œç”¨ 1.è®¾å®šæœ¬åœ°å˜é‡ 2.å®šä¹‰å‘½ä»¤åˆ«å 3.2 å„shellè¯»å–é…ç½®æ–‡ä»¶è¿‡ç¨‹ 3.2.1 bash 1ã€äº¤äº’å¼çš„ç™»å½•shell ï¼ˆbash â€“il test.shï¼‰ è½½å…¥çš„ä¿¡æ¯ï¼š /etc/profile ~/.bash_profileï¼ˆ -> ~/.bashrc -> /etc/bashrcï¼‰ ~/.bash_login ~/.profile 2ã€éäº¤äº’å¼çš„ç™»å½•shell ï¼ˆbash â€“l test.shï¼‰ è½½å…¥çš„ä¿¡æ¯ï¼š /etc/profile ~/.bash_profile ï¼ˆ -> ~/.bashrc -> /etc/bashrcï¼‰ ~/.bash_login ~/.profile $BASH_ENV 3ã€äº¤äº’å¼çš„éç™»å½•shell ï¼ˆbash â€“i test.shï¼‰ è½½å…¥çš„ä¿¡æ¯ï¼š ~/.bashrc ï¼ˆ -> /etc/bashrcï¼‰ 4ã€éäº¤äº’å¼çš„éç™»å½•shell ï¼ˆbash test.shï¼‰ è½½å…¥çš„ä¿¡æ¯ï¼š $BASH_ENV 3.2.2 sh 1ã€äº¤äº’å¼çš„ç™»å½•shell ï¼ˆsh â€“il test.shï¼‰ è½½å…¥çš„ä¿¡æ¯ï¼š /etc/profile ~/.profile 2ã€éäº¤äº’å¼çš„ç™»å½•shell ï¼ˆsh â€“l test.shï¼‰ è½½å…¥çš„ä¿¡æ¯ï¼š /etc/profile ~/.profile 3ã€äº¤äº’å¼çš„éç™»å½•shell ï¼ˆsh â€“i test.shï¼‰ è½½å…¥çš„ä¿¡æ¯ï¼š $ENV 4ã€éäº¤äº’å¼çš„éç™»å½•shell ï¼ˆsh test.shï¼‰ è½½å…¥çš„ä¿¡æ¯ï¼š nothing ç»¼ä¸Šå¯çŸ¥ï¼Œ äº¤äº’/éäº¤äº’/ç™»å½•/éç™»å½•ï¼Œè¿™å››ç§ shell ä¸»è¦åŒºåˆ«åœ¨äºï¼šæ˜¯å¦è½½å…¥ç›¸å…³é…ç½®æ–‡ä»¶ï¼ è¿™äº›é…ç½®çš„è½½å…¥ä¸å¦ï¼Œå¯¼è‡´äº† Linux å¾ˆå¤šé»˜è®¤é€‰é¡¹çš„å·®å¼‚ã€‚ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/2.1shellå˜é‡ç»¼è¿°.html":{"url":"linux/shell/2.1shellå˜é‡ç»¼è¿°.html","title":"shellå˜é‡ç»¼è¿°","keywords":"","body":"shellå˜é‡ç»¼è¿° ä¸€ã€shellå˜é‡åˆ†ç±» ç¯å¢ƒå˜é‡ï¼ˆå…¨å±€å˜é‡ï¼‰ å¯ä»¥åœ¨å½“å‰shellåŠå­shellä¸­ä½¿ç”¨ æœ¬åœ°å˜é‡ï¼ˆå±€éƒ¨å˜é‡ï¼‰ åªèƒ½åœ¨å­shellä¸­ä½¿ç”¨ äºŒã€shellæŸ¥çœ‹å˜é‡ set è¾“å‡ºæ‰€æœ‰çš„å˜é‡ï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡å’Œæœ¬åœ°å˜é‡ env åªæ˜¾ç¤ºå…¨å±€å˜é‡ declare è¾“å‡ºæ‰€æœ‰çš„å˜é‡ã€å‡½æ•°ã€æ•´æ•°å’Œå·²ç»å¯¼å‡ºçš„å˜é‡ ä¸‰ã€è®¾ç½®ç¯å¢ƒå˜é‡ 3.1è®¾ç½®ä¸´æ—¶æ€§ç¯å¢ƒå˜é‡ export å˜é‡å=value å˜é‡å=value;export å˜é‡å declare -x å˜é‡å=value 3.2 è®¾ç½®æ°¸ä¹…æ€§ç¯å¢ƒå˜é‡ å†™å…¥/etc/profileä¸­ ç„¶åä½¿ç”¨sourceå‘½ä»¤ç”Ÿæ•ˆ 3.3 å–æ¶ˆå˜é‡ unset å˜é‡å å››ã€ç¯å¢ƒå˜é‡ç”Ÿæ•ˆé¡ºåº /etc/profile ~/.bashrc_profile ~/.bashrc /etc/bashrc äº”ã€shellç‰¹æ®Šä½ç½®ç¯å¢ƒå˜é‡ å˜é‡ å«ä¹‰ $0 è„šæœ¬åç§° $n ä½ç½®å˜é‡ï¼Œnä»£è¡¨æ•°å­—ï¼Œè¶…è¿‡10è¦ç”¨{}æ‹¬èµ·æ¥ $# å‚æ•°ä¸ªæ•° $*ã€$@ åˆ—å‡ºå‚æ•° $? ä¸Šä¸€ä¸ªå‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›å€¼ $() è¡¨ç¤ºå…ˆæ‰§è¡Œé‡Œè¾¹çš„å†…å®¹ ${} \"é‡‘åº¸æ–°è‘—\" å’Œ \"é‡‘åº¸æ–°\"è‘— ç”¨äºåŒºåˆ†å˜é‡ $! è·å–ä¸Šä¸€ä¸ªè„šæœ¬çš„PID $_ è·å–ä¸Šä¸€ä¸ªè„šæœ¬çš„æœ€åä¸€ä¸ªå‚æ•° $- æ˜¾ç¤ºshellä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸setå‘½ä»¤åŠŸèƒ½ç›¸åŒ $0 å½“å‰è„šæœ¬çš„æ–‡ä»¶åï¼Œå¦‚æœæ‰§è¡Œè„šæœ¬åŒ…å«äº†è·¯å¾„ï¼Œé‚£ä¹ˆå°±åŒ…æ‹¬è„šæœ¬è·¯å¾„ #ç¼–è¾‘è„šæœ¬å†…å®¹ $ cat >a.sh $n ä½ç½®å˜é‡ï¼Œè·å–å½“å‰æ‰§è¡Œçš„è„šæœ¬çš„ç¬¬nä¸ªå‚æ•°ï¼Œn=1..9,å¦‚æœnå¤§äº9ï¼Œç”¨å¤§æ‹¬å·æ‹¬èµ·æ¥${10} #ç¼–è¾‘è„šæœ¬å†…å®¹ $ cat > b.sh $# è·å–å½“å‰æ‰§è¡Œè„šæœ¬åæ¥çš„å‚æ•°æ€»ä¸ªæ•° #ç¼–è¾‘è„šæœ¬å†…å®¹ $ cat > c.sh $*å’ŒÂ¥@ åˆ—å‡ºæ‰€æœ‰å‚æ•° $* ä»¥\"å‚æ•°1 å‚æ•°2 å‚æ•°3 ...\"çš„å½¢å¼åˆ—å‡ºæ‰€æœ‰å‚æ•° $@ ä»¥\"å‚æ•°1\" \"å‚æ•°2\" \"å‚æ•°3\"çš„å½¢å¼åˆ—å‡ºæ‰€æœ‰å‚æ•° ä¸åŠ å¼•å·æ—¶ï¼Œ$*å’Œ$@è¾“å‡ºä¸€æ · #$* $ set -- a b c $ for i in $*;do echo $i;done a b c #$@ $ set -- a b c $ for i in $@;do echo $i;done a b c åŠ å…¥å¼•å·æ—¶ï¼Œ$*å’Œ$@è¾“å‡ºä¸ä¸€æ · #$* $ set -- a b c $ for i in \"$*\";do echo $i;done a b c #$@ $ set -- a b c $ for i in \"$@\";do echo $i;done a b c $? ä¸Šä¸€ä¸ªå‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›å€¼ å¸¸è§è¿”å›å€¼ #å‘½ä»¤é”™è¯¯ï¼Œè¿”å›å€¼127 $ lp -bash: lp: æœªæ‰¾åˆ°å‘½ä»¤ $ echo $? 127 #å‚æ•°ä¸æ­£ç¡®æˆ–è€…æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨ $ ls -e lsï¼šæ— æ•ˆé€‰é¡¹ -- e Try 'ls --help' for more information. $ echo $? 2 #æƒé™æ‹’ç»ï¼Œä¸æ˜¯ç›®å½•æˆ–æ–‡ä»¶ç­‰ç­‰ $ touch /opt/txt touch: cannot touch â€˜/opt/txtâ€™: Permission denied $ echo $? 1 #å‘½ä»¤æ­£ç¡®æ‰§è¡Œ $ ls $ echo $? 0 $() è¡¨ç¤ºå…ˆæ‰§è¡Œé‡Œè¾¹çš„å†…å®¹ $()ç­‰åŒäº`` #è„šæœ¬ä¸­æƒ³è¦æŠŠä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºå¤å€¼ç»™ä¸€ä¸ªå˜é‡ $ ip=$(ip a s eth0|awk -F'[ /]'+ 'NR==3{print $3}') $ echo $ip 10.0.0.10 ${} \"é‡‘åº¸æ–°è‘—\" å’Œ \"é‡‘åº¸æ–°\"è‘— ç”¨äºåŒºåˆ†å˜é‡ #æƒ³è¦è¾“å‡ºä½ å¥½aï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰åŠ {}ï¼Œæ‰€ä»¥aaå°±æˆäº†æœ€ç»ˆçš„å˜é‡ï¼Œä½†æ˜¯å˜é‡åæ˜¯a $ a='ä½ å¥½' $ echo $aa è¾“å‡ºå†…å®¹ä¸ºç©º #ç”¨{}è§£å†³ä»¥ä¸Šé—®é¢˜ $ a='ä½ å¥½' $ echo ${a}a ä½ å¥½a $! è·å–æœ€åè¿è¡Œçš„åå°è¿›ç¨‹çš„PID âš ï¸å¿…é¡»æ˜¯åå°è¿›ç¨‹ #ä¸‹è½½nginxå®˜æ–¹çš„ä¸€å¼ å›¾ç‰‡ $ nohup wget nginx.org/nginx.png & $ echo $! 1065 $_ è·å–ä¸Šä¸€ä¸ªè„šæœ¬çš„æœ€åä¸€ä¸ªå‚æ•° #ç¼–è¾‘è„šæœ¬å†…å®¹ $ cat > b.sh $- æ˜¾ç¤ºshellä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸setå‘½ä»¤åŠŸèƒ½ç›¸åŒ #shellé»˜è®¤é€‰é¡¹æ˜¯himBH $ echo $- himBH # $ set -x ++ printf '\\033]0;%s@%s:%s\\007' root test1 '~' $ echo $- + echo himxBH himxBH ++ printf '\\033]0;%s@%s:%s\\007' root test1 '~' shellé»˜è®¤é€‰é¡¹himBHï¼Œæ¯ä¸ªå­—æ¯éƒ½ä»£è¡¨äº†ä¸€ä¸ª shell é€‰é¡¹ h - hashall i - interactive-comments m - monitor B - braceexpand H- history âš ï¸âš ï¸âš ï¸æ³¨æ„è¿™é‡Œçš„ \"è®¾ç½®-\" å’Œ \"å–æ¶ˆ+\" æ˜¯åäººç±»çš„ï¼šè®¾ç½®ç”¨ -ï¼Œå…³é—­åè€Œæ˜¯ç”¨ + h - hashall bash çš„ hash åŠŸèƒ½ï¼Œå¯ä»¥å®ç°è®©æŸäº› command å’Œ å…·ä½“è·¯å¾„ ç»‘å®šåœ¨ä¸€èµ· æŸ¥çœ‹é»˜è®¤é€‰é¡¹ $ echo $- himBH $ hash -p /tmp/aaadate date $ hash -l |grep aaadate builtin hash -p /tmp/aaadate date #æ­¤æ—¶å†æ‰§è¡Œå‘½ä»¤dateï¼Œä¼šå‘ç°åŸå…ˆçš„/usr/bin/dateå˜æˆäº†/tmpaaadate $ date -bash: /tmp/aaadate: No such file or directory #æ‰§è¡Œset +h +hè¡¨ç¤ºå»æ‰hï¼Œä¹Ÿå°±æ˜¯imBH å‘½ä»¤ä¸èƒ½å’Œå…·ä½“è·¯å¾„ç»‘å®šï¼Œå› æ­¤dateå‘½ä»¤èƒ½æ­£ç¡®æ‰§è¡Œ $ set +h $ echo $- imBH $ date 2020å¹´ 06æœˆ 24æ—¥ æ˜ŸæœŸä¸‰ 00:26:50 CST #åŠ ä¸Šh å‘½ä»¤å¯ä»¥å’Œå…·ä½“è·¯å¾„ç»‘å®š $ set -h $ echo $- himBH $ date -bash: /tmp/aaadate: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½• #æ¢å¤ $ hash -d date $ date 2020å¹´ 06æœˆ 24æ—¥ æ˜ŸæœŸä¸‰ 00:29:14 CST i - interactive-comments é…ç½®åœ¨äº¤äº’ shell æ¨¡å¼ä¸‹ï¼Œæ˜¯å¦å…è®¸æ³¨é‡Š æ¢å¤é»˜è®¤é€‰é¡¹ $ echo $- himBH å¿…é¡»ä½¿ç”¨set +o interactive-commentsï¼Œset +iä¸å¥½ä½¿ï¼ŒåŸå› æœªçŸ¥ #è®¾ç½®å‘½ä»¤è¡Œä¸å…è®¸æ³¨é‡Š $ set +o interactive-comments $ echo $- himBH #åœ¨å‘½ä»¤è¡ŒåŠ ä¸Š# æ­¤æ—¶æ˜¯ä¸è¢«å…è®¸çš„ $ #testcomment -bash: #testcomment: æœªæ‰¾åˆ°å‘½ä»¤ #å–æ¶ˆè®¾ç½® $ set -o interactive-comments $ echo $- himBH $ #testcomment m - monitor é…ç½®æ˜¯å¦æ‰“å¼€æ§åˆ¶ Job control åŠŸèƒ½ æ¢å¤é»˜è®¤é€‰é¡¹ $ echo $- himBH Job control æ˜¯ä»€ä¹ˆï¼Ÿ å³å¯ä»¥æ§åˆ¶è¿›ç¨‹çš„åœæ­¢ã€ç»§ç»­ï¼Œåå°æˆ–è€…å‰å°æ‰§è¡Œç­‰ã€‚ å¼€å¯ job control åï¼Œå¦‚æœæ‰§è¡Œäº†ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„å‘½ä»¤ï¼Œå¯ä»¥æŒ‰ä¸‹ CTRL+Z è®©å®ƒåœ¨åå°è¿è¡Œï¼š $ sleep 50 ^Z [1]+ å·²åœæ­¢ sleep 50 ç„¶åï¼Œ å¯ä»¥ç”¨ fg å‘½ä»¤å°†åå°è¿è¡Œçš„ä»»åŠ¡æ¢å¤åˆ°å‰å°æ‰§è¡Œ $ fg 1 sleep 50 å¦‚æœå…³é—­è¿™ä¸ªé€‰é¡¹ï¼Œå°±ä¼šå¤±å»æ§åˆ¶ Job çš„èƒ½åŠ› $ set +m $ echo $- hiBH #æ­¤æ—¶ä½¿ç”¨ctrl+zä¸ç®¡ç”¨ $ sleep 50 ^Z^Z^Z^Z^Z^C $ fg -bash: fg: æ— ä»»åŠ¡æ§åˆ¶ B - braceexpand å…³äºå¤§æ‹¬å·ä½¿ç”¨çš„flagï¼Œæ‰“å¼€åå¯ä»¥å¿«æ·åœ°å®ç°æŸäº›æ•ˆæœ æ¢å¤é»˜è®¤é€‰é¡¹ $ echo $- himBH åˆ©ç”¨å¤§æ‹¬å·è¾“å‡ºæ–‡ä»¶ echo {1..5}.txt 1.txt 2.txt 3.txt 4.txt 5.txt å…³é—­å¤§æ‹¬å·æ•ˆæœ $ set +B $ echo $- himH å†æ¬¡æ‰§è¡Œå‘½ä»¤å‘ç°{}ä¸ç”Ÿæ•ˆäº† echo {1..5}.txt {1..5}.txt H - histexpand æ˜¯å¦å…è¨±ç”¨ \"æ„Ÿå¹å· ï¼+ history number\" æ¥æ‰§è¡Œå†å²å‘½ä»¤ !! è¿”å›å¹¶æ‰§è¡Œæœ€è¿‘çš„ä¸€ä¸ªå†å²å‘½ä»¤ !n è¿”å›å¹¶æ‰§è¡Œç¬¬ n ä¸ªå†å²å‘½ä»¤ æ¢å¤é»˜è®¤é€‰é¡¹ $ echo $- himBH #æ‰§è¡Œå‘½ä»¤ $ ls /tmp/ ks-script-2R8Xnq yum.log #ä½¿ç”¨!è¿è¡Œä¸Šä¸€æ¬¡ä»¥lå¼€å¤´çš„å‘½ä»¤ $ !l ls /tmp/ ks-script-2R8Xnq yum.log #å–æ¶ˆ!åŠŸèƒ½ $ set +H #å†æ¬¡æ‰§è¡Œå°±ä¼šæŠ¥é”™ $ !l -bash: !l: æœªæ‰¾åˆ°å‘½ä»¤ é—®é¢˜ ç”±äº histexpand æ‰“å¼€çš„æ—¶å€™ï¼Œ\"!\" å¸¦ç‰¹æ®Šå«ä¹‰ï¼› å› æ­¤ histexpand æ‰“å¼€çŠ¶æ€ä¸‹ï¼Œ\"!\" ä¸èƒ½å‡ºç°åœ¨åŒå¼•å·ä¸­ï¼Œ å¦åˆ™ä¼šæŠ¥é”™ -bash: !\": event not found $ echo $- himBH #æƒ³è¦è¾“å‡ºhehe!ï¼Œä½†æ˜¯å´æŠ¥é”™äº†ï¼ŒåŸå› æ˜¯å‘½ä»¤è¡Œä¸‹ï¼ŒåŒå¼•å·é‡Œé¢ç”¨äº†!çš„è¯ï¼ŒShell ä¼šä»¥ä¸ºè¦æ‰§è¡Œå†å²å±•å¼€ï¼Œä»è€Œå¯¼è‡´æŠ¥é”™ $ echo \"hehe!\" -bash: !\": event not found è§£å†³æ–¹æ³•ä¸€ å…³é—­histexpand $ echo $- himBH $ set +H $ echo $- himB $ echo \"hehe!\" hehe! è§£å†³æ–¹æ³•äºŒ ä½¿ç”¨å•å¼•å· $ echo $- himBH $ echo 'hehe!' hehe! å…­ã€ç¯å¢ƒå˜é‡æ€»ç»“ å˜é‡åé€šå¸¸è¦å¤§å†™ å˜é‡å¯ä»¥åœ¨è‡ªèº«çš„shellåŠå­shellä¸­ä½¿ç”¨ å¸¸ç”¨exportæ¥å®šä¹‰ç¯å¢ƒå˜é‡ æ‰§è¡Œenvé»˜è®¤å¯ä»¥æ˜¾ç¤ºæ‰€æœ‰çš„ç¯å¢ƒå˜é‡åç§°åŠå¯¹åº”çš„å€¼ è¾“å‡ºæ—¶ç”¨\"$å˜é‡å\"ï¼Œå–æ¶ˆæ—¶ç”¨\"unset å˜é‡å\" ä¹¦å†™crondå®šæ—¶ä»»åŠ¡æ˜¯è¦æ³¨æ„ï¼Œè„šæœ¬è¦ç”¨åˆ°çš„ç¯å¢ƒå˜é‡æœ€å¥½å…ˆåœ¨æ‰€æ‰§è¡Œçš„shellè„šæœ¬ä¸­é‡æ–°å®šä¹‰ å¦‚æœå¸Œæœ›ç¯å¢ƒå˜é‡æ°¸ä¹…ç”Ÿæ•ˆï¼Œåˆ™å¯ä»¥å°†å…¶æ”¾åœ¨ç”¨æˆ·ç¯å¢ƒå˜é‡æ–‡ä»¶æˆ–å…¨å±€ç¯å¢ƒå˜é‡æ–‡ä»¶ä¸­ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/2.2shellå˜é‡å­ä¸².html":{"url":"linux/shell/2.2shellå˜é‡å­ä¸².html","title":"shellå˜é‡å­ä¸²","keywords":"","body":"shellå˜é‡å­ä¸² 1.è¿”å›å˜é‡ ${var} è¿”å›å˜é‡varçš„å†…å®¹ $ a=10 $ echo ${a} 10 2.è¿”å›å­—ç¬¦é•¿åº¦ ${#var} è¿”å›å˜é‡varçš„é•¿åº¦ï¼ŒæŒ‰ç…§å­—ç¬¦ a=10 $ echo ${#a} 2 3.æˆªå–å­ä¸² ${var:n} åœ¨å˜é‡varä¸­ï¼Œä»ä½ç½®n(nä¸ºæ•°å­—)ä¹‹åå¼€å§‹æå–å­ä¸²åˆ°ç»“å°¾ $ a=\"i am boy\" $ echo ${a:3} m boy ${var:n:length} åœ¨å˜é‡varä¸­ï¼Œä»ä½ç½®nä¹‹åå¼€å§‹æå–é•¿åº¦ä¸ºlengthçš„å­ä¸² $ a=\"i am boy\" $ echo ${a:3:3} m b 4.åˆ é™¤å­ä¸² 4.1 ä»å¼€å¤´åˆ é™¤ 4.1.1 æœ€çŸ­åŒ¹é… ${var#word} ä»å˜é‡varå¼€å¤´å¼€å§‹åˆ é™¤æœ€çŸ­åŒ¹é…çš„wordå­ä¸² $ a=abc123ABCabc123ABC $ echo ${a#a*b} c123ABCabc123ABC #åŒ¹é…äº†abï¼Œæœ€çŸ­åŒ¹é… $ echo ${a#a*C} abc123ABC #åŒ¹é…äº†abc123ABC 4.1.2 æœ€é•¿åŒ¹é… ${var##word} ä»å˜é‡varå¼€å¤´å¼€å§‹åˆ é™¤æœ€é•¿åŒ¹é…çš„wordå­ä¸² $ a=abc123ABCabc123ABC $ echo ${a##a*b} c123ABC #åŒ¹é…äº†abc123ABCabï¼Œæœ€é•¿åŒ¹é… $ echo ${a##a*C} #å…¨éƒ¨åŒ¹é…ï¼Œå…¨éƒ¨åˆ é™¤ 4.2 ä»ç»“å°¾åˆ é™¤ 4.2.1 æœ€çŸ­åŒ¹é… ${var%word} ä»å˜é‡varç»“å°¾å¼€å§‹åˆ é™¤æœ€çŸ­åŒ¹é…çš„wordå­ä¸² $ a=abc123ABCabc123ABC $ echo ${a%1*C} abc123ABCabc #ä»ç»“å°¾å¼€å§‹åŒ¹é…äº†123ABC 4.2.2 æœ€é•¿åŒ¹é… ${var%%word} ä»å˜é‡varç»“å°¾å¼€å§‹åˆ é™¤æœ€é•¿åŒ¹é…çš„wordå­ä¸² $ a=abc123ABCabc123ABC $ echo ${a%%1*C} abc #ä»ç»“å°¾åŒ¹é…äº†123ABCabc123ABC 5.æ›¿æ¢å­ä¸² ${var/A/B} ç”¨Bä»£æ›¿ç¬¬ä¸€ä¸ªåŒ¹é…çš„A $ a=abc111 $ echo ${a/1/9} abc911 ${var//A/B} ç”¨Bä»£æ›¿æ‰€æœ‰åŒ¹é…çš„A $ a=abc111 $ echo ${a//1/9} abc999 6.ç‰¹æ®Šæ‰©å±•å˜é‡ 6.1 ${var:-word} ${var:-word},å†’å·å¯ä»¥å¿½ç•¥ å¦‚æœvarçš„å˜é‡å€¼ä¸ºç©ºæˆ–ä¸ºæœªèµ‹å€¼ï¼Œåˆ™ä¼šè¿”å›wordå­—ç¬¦ä¸²å¹¶æ›¿ä»£å˜é‡çš„å€¼ $ echo $C #å˜é‡Cæ²¡æœ‰èµ‹å€¼ï¼Œæ‰€ä»¥ä¸ºç©º $ B=${C:-hehe} #å¦‚æœCæ²¡æœ‰èµ‹å€¼ï¼Œåˆ™å°†heheèµ‹å€¼ç»™B $ echo $B hehe $ A=abc $ B=${A:-haha} #å› ä¸ºå˜é‡Aæœ‰å€¼ï¼Œæ‰€ä»¥å°†å˜é‡Açš„å€¼èµ‹äºˆB $ echo $B abc #å†’å·å¯ä»¥ä¸å†™ $ echo $D $ E=${D-hehe} $ echo $E hehe 6.2 ${var:=word} ${var:=word}ï¼Œå†’å·å¯ä»¥å¿½ç•¥ å¦‚æœvarçš„å˜é‡å€¼ä¸ºç©ºæˆ–æœªèµ‹å€¼ï¼Œåˆ™è®¾ç½®è¿™ä¸ªå˜é‡å€¼ä¸ºword,å¹¶è¿”å›å…¶å€¼ $ echo $A #å˜é‡Aæ²¡æœ‰èµ‹å€¼ $ B=${A=hehe} #å¦‚æœå˜é‡Aä¸ºç©ºæˆ–æœªèµ‹å€¼ï¼Œåˆ™è®¾ç½®å˜é‡Açš„å€¼ä¸ºhehe $ echo $A hehe #ä¸var-wordä¸åŒï¼Œå˜é‡Aä¹Ÿä¼šæœ‰å€¼ $ echo $B hehe 6.3 ${var:?word} ${var:?word}ï¼Œå†’å·å¯ä»¥å¿½ç•¥ å¦‚æœvarçš„å˜é‡å€¼ä¸ºç©ºæˆ–æœªèµ‹å€¼ï¼Œé‚£ä¹ˆwordå­—ç¬¦ä¸²å°†è¢«ä½œä¸ºæ ‡å‡†é”™è¯¯è¾“å‡ºï¼Œå¦åˆ™è¾“å‡ºå˜é‡çš„å€¼ $ echo $A #å˜é‡Aä¸ºç©ºæˆ–æœªèµ‹å€¼ $ echo ${A?hehe} -bash: A: hehe #å°†heheä½œä¸ºæ ‡å‡†é”™è¯¯è¾“å‡º $ A=abc $ echo ${A?hehe} abc #å› ä¸ºå˜é‡Aæœ‰å€¼ï¼Œæ‰€ä»¥è¾“å‡ºå˜é‡Açš„å€¼ 6.4 ${var:+word} ${vrt:+word}ï¼Œå†’å·å¯ä»¥å¿½ç•¥ å¦‚æœvarå˜é‡å€¼ä¸ºç©ºæˆ–æœªèµ‹å€¼ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™wordå­—ç¬¦ä¸²å°†æ›¿ä»£å˜é‡çš„å€¼ $ echo $A #å˜é‡Aä¸ºç©ºæˆ–æœªèµ‹å€¼ $ echo ${A+hehe} #ä¸åšä»»ä½•æ“ä½œ $ A=abc $ echo ${A+hehe} hehe #å› ä¸ºå˜é‡Aæœ‰å€¼ï¼Œæ‰€ä»¥ç”¨heheæ›¿ä»£å˜é‡Açš„å€¼ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/2.3shellå˜é‡è‡ªå¢.html":{"url":"linux/shell/2.3shellå˜é‡è‡ªå¢.html","title":"shellå˜é‡è‡ªå¢","keywords":"","body":"shellå˜é‡è‡ªå¢ a++æ˜¯å…ˆæ‰§è¡Œè¡¨è¾¾å¼åå†è‡ªå¢ï¼Œæ‰§è¡Œè¡¨è¾¾å¼æ—¶ä½¿ç”¨çš„æ˜¯açš„åŸå€¼ ++aæ˜¯å…ˆè‡ªå¢å†æ‰§è¡Œè¡¨è¾¾ç¤ºï¼Œæ‰§è¡Œè¡¨è¾¾å¼æ—¶ä½¿ç”¨çš„æ˜¯è‡ªå¢åçš„a a++ç¤ºä¾‹ $ a=1 $ let num=a++ #a++ å…ˆæ‰§è¡Œè¡¨è¾¾å¼ï¼Œnum=aï¼Œæ‰€ä»¥numçš„å€¼ä¸º1ï¼Œç„¶åaå†è‡ªå¢ï¼Œå€¼ä¸º2 $ echo $num 1 $ echo $a 2 ++aç¤ºä¾‹ $ a=1 $ let num=++a #aå…ˆè‡ªå¢ï¼Œå› æ­¤açš„å€¼ä¸º2ï¼Œç„¶åæ‰§è¡Œè¡¨è¾¾å¼ï¼Œnum=2ï¼Œæ‰€ä»¥numçš„å€¼ä¸º2 $ echo $num 2 $ echo $a 2 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/2.4shellç‰¹æ®Šä½ç½®ç¯å¢ƒå˜é‡.html":{"url":"linux/shell/2.4shellç‰¹æ®Šä½ç½®ç¯å¢ƒå˜é‡.html","title":"shellç‰¹æ®Šä½ç½®ç¯å¢ƒå˜é‡","keywords":"","body":"shellç‰¹æ®Šä½ç½®ç¯å¢ƒå˜é‡ å˜é‡ å«ä¹‰ $0 è„šæœ¬åç§° $n ä½ç½®å˜é‡ï¼Œnä»£è¡¨æ•°å­—ï¼Œè¶…è¿‡10è¦ç”¨{}æ‹¬èµ·æ¥ $# å‚æ•°ä¸ªæ•° $*ã€$@ åˆ—å‡ºå‚æ•° $? ä¸Šä¸€ä¸ªå‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›å€¼ $() è¡¨ç¤ºå…ˆæ‰§è¡Œé‡Œè¾¹çš„å†…å®¹ ${} \"é‡‘åº¸æ–°è‘—\" å’Œ \"é‡‘åº¸æ–°\"è‘— ç”¨äºåŒºåˆ†å˜é‡ $! è·å–ä¸Šä¸€ä¸ªè„šæœ¬çš„PID $_ è·å–ä¸Šä¸€ä¸ªè„šæœ¬çš„æœ€åä¸€ä¸ªå‚æ•° $- æ˜¾ç¤ºshellä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸setå‘½ä»¤åŠŸèƒ½ç›¸åŒ $0 å½“å‰è„šæœ¬çš„æ–‡ä»¶åï¼Œå¦‚æœæ‰§è¡Œè„šæœ¬åŒ…å«äº†è·¯å¾„ï¼Œé‚£ä¹ˆå°±åŒ…æ‹¬è„šæœ¬è·¯å¾„ #ç¼–è¾‘è„šæœ¬å†…å®¹ $ cat >a.sh $n ä½ç½®å˜é‡ï¼Œè·å–å½“å‰æ‰§è¡Œçš„è„šæœ¬çš„ç¬¬nä¸ªå‚æ•°ï¼Œn=1..9,å¦‚æœnå¤§äº9ï¼Œç”¨å¤§æ‹¬å·æ‹¬èµ·æ¥${10} #ç¼–è¾‘è„šæœ¬å†…å®¹ $ cat > b.sh $# è·å–å½“å‰æ‰§è¡Œè„šæœ¬åæ¥çš„å‚æ•°æ€»ä¸ªæ•° #ç¼–è¾‘è„šæœ¬å†…å®¹ $ cat > c.sh $*å’ŒÂ¥@ åˆ—å‡ºæ‰€æœ‰å‚æ•° $* ä»¥\"å‚æ•°1 å‚æ•°2 å‚æ•°3 ...\"çš„å½¢å¼åˆ—å‡ºæ‰€æœ‰å‚æ•° $@ ä»¥\"å‚æ•°1\" \"å‚æ•°2\" \"å‚æ•°3\"çš„å½¢å¼åˆ—å‡ºæ‰€æœ‰å‚æ•° ä¸åŠ å¼•å·æ—¶ï¼Œ$*å’Œ$@è¾“å‡ºä¸€æ · #$* $ set -- a b c $ for i in $*;do echo $i;done a b c #$@ $ set -- a b c $ for i in $@;do echo $i;done a b c åŠ å…¥å¼•å·æ—¶ï¼Œ$*å’Œ$@è¾“å‡ºä¸ä¸€æ · #$* $ set -- a b c $ for i in \"$*\";do echo $i;done a b c #$@ $ set -- a b c $ for i in \"$@\";do echo $i;done a b c $? ä¸Šä¸€ä¸ªå‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›å€¼ å¸¸è§è¿”å›å€¼ #å‘½ä»¤é”™è¯¯ï¼Œè¿”å›å€¼127 $ lp -bash: lp: æœªæ‰¾åˆ°å‘½ä»¤ $ echo $? 127 #å‚æ•°ä¸æ­£ç¡®æˆ–è€…æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨ $ ls -e lsï¼šæ— æ•ˆé€‰é¡¹ -- e Try 'ls --help' for more information. $ echo $? 2 #æƒé™æ‹’ç»ï¼Œä¸æ˜¯ç›®å½•æˆ–æ–‡ä»¶ç­‰ç­‰ $ touch /opt/txt touch: cannot touch â€˜/opt/txtâ€™: Permission denied $ echo $? 1 #å‘½ä»¤æ­£ç¡®æ‰§è¡Œ $ ls $ echo $? 0 $() è¡¨ç¤ºå…ˆæ‰§è¡Œé‡Œè¾¹çš„å†…å®¹ $()ç­‰åŒäº`` #è„šæœ¬ä¸­æƒ³è¦æŠŠä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºå¤å€¼ç»™ä¸€ä¸ªå˜é‡ $ ip=$(ip a s eth0|awk -F'[ /]'+ 'NR==3{print $3}') $ echo $ip 10.0.0.10 ${} \"é‡‘åº¸æ–°è‘—\" å’Œ \"é‡‘åº¸æ–°\"è‘— ç”¨äºåŒºåˆ†å˜é‡ #æƒ³è¦è¾“å‡ºä½ å¥½aï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰åŠ {}ï¼Œæ‰€ä»¥aaå°±æˆäº†æœ€ç»ˆçš„å˜é‡ï¼Œä½†æ˜¯å˜é‡åæ˜¯a $ a='ä½ å¥½' $ echo $aa è¾“å‡ºå†…å®¹ä¸ºç©º #ç”¨{}è§£å†³ä»¥ä¸Šé—®é¢˜ $ a='ä½ å¥½' $ echo ${a}a ä½ å¥½a $! è·å–æœ€åè¿è¡Œçš„åå°è¿›ç¨‹çš„PID âš ï¸å¿…é¡»æ˜¯åå°è¿›ç¨‹ #ä¸‹è½½nginxå®˜æ–¹çš„ä¸€å¼ å›¾ç‰‡ $ nohup wget nginx.org/nginx.png & $ echo $! 1065 $_ è·å–ä¸Šä¸€ä¸ªè„šæœ¬çš„æœ€åä¸€ä¸ªå‚æ•° #ç¼–è¾‘è„šæœ¬å†…å®¹ $ cat > b.sh $- æ˜¾ç¤ºshellä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸setå‘½ä»¤åŠŸèƒ½ç›¸åŒ #shellé»˜è®¤é€‰é¡¹æ˜¯himBH $ echo $- himBH # $ set -x ++ printf '\\033]0;%s@%s:%s\\007' root test1 '~' $ echo $- + echo himxBH himxBH ++ printf '\\033]0;%s@%s:%s\\007' root test1 '~' shellé»˜è®¤é€‰é¡¹himBHï¼Œæ¯ä¸ªå­—æ¯éƒ½ä»£è¡¨äº†ä¸€ä¸ª shell é€‰é¡¹ h - hashall i - interactive-comments m - monitor B - braceexpand H- history âš ï¸âš ï¸âš ï¸æ³¨æ„è¿™é‡Œçš„ \"è®¾ç½®-\" å’Œ \"å–æ¶ˆ+\" æ˜¯åäººç±»çš„ï¼šè®¾ç½®ç”¨ -ï¼Œå…³é—­åè€Œæ˜¯ç”¨ + h - hashall bash çš„ hash åŠŸèƒ½ï¼Œå¯ä»¥å®ç°è®©æŸäº› command å’Œ å…·ä½“è·¯å¾„ ç»‘å®šåœ¨ä¸€èµ· æŸ¥çœ‹é»˜è®¤é€‰é¡¹ $ echo $- himBH $ hash -p /tmp/aaadate date $ hash -l |grep aaadate builtin hash -p /tmp/aaadate date #æ­¤æ—¶å†æ‰§è¡Œå‘½ä»¤dateï¼Œä¼šå‘ç°åŸå…ˆçš„/usr/bin/dateå˜æˆäº†/tmpaaadate $ date -bash: /tmp/aaadate: No such file or directory #æ‰§è¡Œset +h +hè¡¨ç¤ºå»æ‰hï¼Œä¹Ÿå°±æ˜¯imBH å‘½ä»¤ä¸èƒ½å’Œå…·ä½“è·¯å¾„ç»‘å®šï¼Œå› æ­¤dateå‘½ä»¤èƒ½æ­£ç¡®æ‰§è¡Œ $ set +h $ echo $- imBH $ date 2020å¹´ 06æœˆ 24æ—¥ æ˜ŸæœŸä¸‰ 00:26:50 CST #åŠ ä¸Šh å‘½ä»¤å¯ä»¥å’Œå…·ä½“è·¯å¾„ç»‘å®š $ set -h $ echo $- himBH $ date -bash: /tmp/aaadate: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½• #æ¢å¤ $ hash -d date $ date 2020å¹´ 06æœˆ 24æ—¥ æ˜ŸæœŸä¸‰ 00:29:14 CST i - interactive-comments é…ç½®åœ¨äº¤äº’ shell æ¨¡å¼ä¸‹ï¼Œæ˜¯å¦å…è®¸æ³¨é‡Š æ¢å¤é»˜è®¤é€‰é¡¹ $ echo $- himBH å¿…é¡»ä½¿ç”¨set +o interactive-commentsï¼Œset +iä¸å¥½ä½¿ï¼ŒåŸå› æœªçŸ¥ #è®¾ç½®å‘½ä»¤è¡Œä¸å…è®¸æ³¨é‡Š $ set +o interactive-comments $ echo $- himBH #åœ¨å‘½ä»¤è¡ŒåŠ ä¸Š# æ­¤æ—¶æ˜¯ä¸è¢«å…è®¸çš„ $ #testcomment -bash: #testcomment: æœªæ‰¾åˆ°å‘½ä»¤ #å–æ¶ˆè®¾ç½® $ set -o interactive-comments $ echo $- himBH $ #testcomment m - monitor é…ç½®æ˜¯å¦æ‰“å¼€æ§åˆ¶ Job control åŠŸèƒ½ æ¢å¤é»˜è®¤é€‰é¡¹ $ echo $- himBH Job control æ˜¯ä»€ä¹ˆï¼Ÿ å³å¯ä»¥æ§åˆ¶è¿›ç¨‹çš„åœæ­¢ã€ç»§ç»­ï¼Œåå°æˆ–è€…å‰å°æ‰§è¡Œç­‰ã€‚ å¼€å¯ job control åï¼Œå¦‚æœæ‰§è¡Œäº†ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„å‘½ä»¤ï¼Œå¯ä»¥æŒ‰ä¸‹ CTRL+Z è®©å®ƒåœ¨åå°è¿è¡Œï¼š $ sleep 50 ^Z [1]+ å·²åœæ­¢ sleep 50 ç„¶åï¼Œ å¯ä»¥ç”¨ fg å‘½ä»¤å°†åå°è¿è¡Œçš„ä»»åŠ¡æ¢å¤åˆ°å‰å°æ‰§è¡Œ $ fg 1 sleep 50 å¦‚æœå…³é—­è¿™ä¸ªé€‰é¡¹ï¼Œå°±ä¼šå¤±å»æ§åˆ¶ Job çš„èƒ½åŠ› $ set +m $ echo $- hiBH #æ­¤æ—¶ä½¿ç”¨ctrl+zä¸ç®¡ç”¨ $ sleep 50 ^Z^Z^Z^Z^Z^C $ fg -bash: fg: æ— ä»»åŠ¡æ§åˆ¶ B - braceexpand å…³äºå¤§æ‹¬å·ä½¿ç”¨çš„flagï¼Œæ‰“å¼€åå¯ä»¥å¿«æ·åœ°å®ç°æŸäº›æ•ˆæœ æ¢å¤é»˜è®¤é€‰é¡¹ $ echo $- himBH åˆ©ç”¨å¤§æ‹¬å·è¾“å‡ºæ–‡ä»¶ echo {1..5}.txt 1.txt 2.txt 3.txt 4.txt 5.txt å…³é—­å¤§æ‹¬å·æ•ˆæœ $ set +B $ echo $- himH å†æ¬¡æ‰§è¡Œå‘½ä»¤å‘ç°{}ä¸ç”Ÿæ•ˆäº† echo {1..5}.txt {1..5}.txt H - histexpand æ˜¯å¦å…è¨±ç”¨ \"æ„Ÿå¹å· ï¼+ history number\" æ¥æ‰§è¡Œå†å²å‘½ä»¤ !! è¿”å›å¹¶æ‰§è¡Œæœ€è¿‘çš„ä¸€ä¸ªå†å²å‘½ä»¤ !n è¿”å›å¹¶æ‰§è¡Œç¬¬ n ä¸ªå†å²å‘½ä»¤ æ¢å¤é»˜è®¤é€‰é¡¹ $ echo $- himBH #æ‰§è¡Œå‘½ä»¤ $ ls /tmp/ ks-script-2R8Xnq yum.log #ä½¿ç”¨!è¿è¡Œä¸Šä¸€æ¬¡ä»¥lå¼€å¤´çš„å‘½ä»¤ $ !l ls /tmp/ ks-script-2R8Xnq yum.log #å–æ¶ˆ!åŠŸèƒ½ $ set +H #å†æ¬¡æ‰§è¡Œå°±ä¼šæŠ¥é”™ $ !l -bash: !l: æœªæ‰¾åˆ°å‘½ä»¤ é—®é¢˜ ç”±äº histexpand æ‰“å¼€çš„æ—¶å€™ï¼Œ\"!\" å¸¦ç‰¹æ®Šå«ä¹‰ï¼› å› æ­¤ histexpand æ‰“å¼€çŠ¶æ€ä¸‹ï¼Œ\"!\" ä¸èƒ½å‡ºç°åœ¨åŒå¼•å·ä¸­ï¼Œ å¦åˆ™ä¼šæŠ¥é”™ -bash: !\": event not found $ echo $- himBH #æƒ³è¦è¾“å‡ºhehe!ï¼Œä½†æ˜¯å´æŠ¥é”™äº†ï¼ŒåŸå› æ˜¯å‘½ä»¤è¡Œä¸‹ï¼ŒåŒå¼•å·é‡Œé¢ç”¨äº†!çš„è¯ï¼ŒShell ä¼šä»¥ä¸ºè¦æ‰§è¡Œå†å²å±•å¼€ï¼Œä»è€Œå¯¼è‡´æŠ¥é”™ $ echo \"hehe!\" -bash: !\": event not found è§£å†³æ–¹æ³•ä¸€ å…³é—­histexpand $ echo $- himBH $ set +H $ echo $- himB $ echo \"hehe!\" hehe! è§£å†³æ–¹æ³•äºŒ ä½¿ç”¨å•å¼•å· $ echo $- himBH $ echo 'hehe!' hehe! æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/3.1shelläº§ç”Ÿéšæœºæ•°æ–¹æ³•.html":{"url":"linux/shell/3.1shelläº§ç”Ÿéšæœºæ•°æ–¹æ³•.html","title":"shelläº§ç”Ÿéšæœºæ•°æ–¹æ³•","keywords":"","body":"shelläº§ç”Ÿéšæœºæ•°æ–¹æ³• æ–¹æ³•1ï¼šé€šè¿‡ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆ$RANDOMï¼‰å®ç° ç¤ºä¾‹ $ echo $RANDOM 9010 $ echo $RANDOM 21762 $ echo $RANDOM 10826 RANDOMçš„éšæœºæ•°èŒƒå›´ä¸º0-32767ï¼Œå› æ­¤ï¼ŒåŠ å¯†æ€§ä¸å¥½ï¼Œå¯ä»¥é€šè¿‡åœ¨è¾“å‡ºçš„éšæœºæ•°åå¢åŠ åŠ å¯†å­—ç¬¦ä¸²ï¼ˆå°±æ˜¯å’Œå¯†ç ç”Ÿæˆæœ‰å…³çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰çš„æ–¹å¼è§£å†³ï¼Œæœ€åå†ä¸€èµ·æ‰§è¡Œmd5sumæ“ä½œå¹¶æˆªå–ç»“æœçš„ånä½ï¼Œè¿™æ ·å®‰å…¨æ€§å°±æé«˜äº† $ echo hehe$RANDOM|md5sum a0c30ca1ee50e4ad15a103d18b59bd16 - æ–¹æ³•2ï¼šé€šè¿‡openssläº§ç”Ÿéšæœºæ•° -base64 ä½¿ç”¨-base64ä½ç¼–ç æ ¼å¼ åè¾¹çš„æ•°å­—ä¸çŸ¥é“æ˜¯ä»€ä¹ˆ $ openssl rand -base64 1 Og== $ openssl rand -base64 2 49U= $ openssl rand -base64 3 ii94 $ openssl rand -base64 4 ZdFgGQ== $ openssl rand -base64 5 g+6lQaw= $ openssl rand -base64 6 6TL7NHBd $ openssl rand -base64 7 vI3vCFMJzA== $ openssl rand -base64 8 dE+LENuXc3Y= $ openssl rand -base64 9 ciL/KwjUQnR5 $ openssl rand -base64 10 nAFsTVLvVBtREw== æ–¹æ³•3ï¼šé€šè¿‡dateè·å¾—éšæœºæ•° ç¤ºä¾‹ $ date +%N Nè¡¨ç¤ºçº³ç§’ 519916150 $ date +%N 660161239 $ date +%N 352563239 $ date +%N 198867394 $ date +%N 872287833 $ date +%N 698481118 $ date +%N 988858815 æ–¹æ³•4ï¼šé€šè¿‡/dev/urandomé…åˆchksumç”Ÿæˆéšæœºæ•° /dev/randomè®¾å¤‡å­˜å‚¨ç€ç³»ç»Ÿå½“å‰è¿è¡Œç¯å¢ƒçš„å®æ—¶æ•°æ®ï¼Œå®ƒå¯ä»¥çœ‹ä½œç³»ç»Ÿåœ¨æŸä¸ªæ—¶å€™çš„å”¯ä¸€å€¼ï¼Œå› æ­¤å¯ä»¥ç”¨ä½œéšæœºæ•°å…ƒæ•°æ®ï¼Œå¯ä»¥é€šè¿‡æ–‡ä»¶è¯»å–çš„æ–¹å¼è¯»åˆ°é‡Œé¢çš„æ•°æ®ï¼Œ/dev/urandomè¿™ä¸ªè®¾å¤‡çš„æ•°æ®ä¸randomé‡Œçš„ä¸€æ ·ï¼Œåªæ˜¯å®ƒæ˜¯éé˜»å¡çš„éšæœºæ•°å‘ç”Ÿå™¨ï¼Œè¯»å–æ“ä½œä¸ä¼šä¸ä¼šäº§ç”Ÿé˜»å¡ ç¤ºä¾‹ $ head /dev/urandom | cksum 185767657 2818 $ head /dev/urandom | cksum 2888724895 3156 $ head /dev/urandom | cksum 1734919599 1634 $ head /dev/urandom | cksum 3186002271 2797 $ head /dev/urandom | cksum 3511808856 1282 æ–¹æ³•5ï¼šé€šè¿‡UUIDç”Ÿæˆéšæœºæ•° UUIDç å…¨ç§°æ˜¯é€šç”¨å”¯ä¸€æ ‡è¯†ç ï¼ˆUniversally Unique Identifier,UUIDï¼‰,å®ƒæ˜¯ä¸€ä¸ªè½¯ä»¶å»ºåº“çš„æ ‡å‡†ï¼Œäº¦ä¸ºè‡ªç”±è½¯ä»¶åŸºé‡‘ä¼šï¼ˆOpen Software Foundation,OSFï¼‰çš„ç»„ç»‡åœ¨åˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒï¼ˆDistributed Computing Enviroment,DCEï¼‰é¢†åŸŸçš„ä¸€éƒ¨åˆ†ï¼ŒUUIDçš„ç›®çš„æ˜¯è®©åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½èƒ½æœ‰å”¯ä¸€çš„çš„è¾¨è¯†ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦é€šè¿‡ä¸­å¤®æ§åˆ¶ç«¯æ¥åšè¾¨è¯†ä¿¡æ¯çš„æŒ‡å®š ç¤ºä¾‹ $ cat /proc/sys/kernel/random/uuid f541c0ee-bbe7-4257-8733-2f58cc0ef27f $ cat /proc/sys/kernel/random/uuid 9a136a5c-5397-40df-bea4-d6cf60db5d78 $ cat /proc/sys/kernel/random/uuid 6548c058-7d40-4013-9ce2-a6503c3010a4 æ–¹æ³•6ï¼šä½¿ç”¨expecté™„å¸¦çš„mkpasswdç”Ÿæˆéšæœºæ•° mkpasswdä¾èµ–äºåŒ…expectï¼Œå› æ­¤éœ€è¦å…ˆå®‰è£…expectåŒ… mkpasswd -l æŒ‡å®šå¯†ç é•¿åº¦ -d æŒ‡å®šå¯†ç ä¸­æ•°å­—çš„æ•°é‡ -c æŒ‡å®šå¯†ç ä¸­å°å†™å­—æ¯çš„æ•°é‡ -C æŒ‡å®šå¯†ç ä¸­å¤§å†™å­—æ¯çš„æ•°é‡ -s æŒ‡å®šå¯†ç ä¸­ç‰¹æ®Šå­—ç¬¦çš„æ•°é‡ ç¤ºä¾‹ $ mkpasswd -l 10 -d 2 -c 2 -C 2 -s 2 Ly6Jl7|kq{ $ mkpasswd -l 10 -d 2 -c 2 -C 2 -s 2 raBT2x?4c) $ mkpasswd -l 10 -d 2 -c 2 -C 2 -s 2 Ata$\"P03op æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/3.2shellè·å–å¥‡æ•°è¡Œå’Œå¶æ•°è¡Œ.html":{"url":"linux/shell/3.2shellè·å–å¥‡æ•°è¡Œå’Œå¶æ•°è¡Œ.html","title":"shellè·å–å¥‡æ•°è¡Œå’Œå¶æ•°è¡Œ","keywords":"","body":"shellè·å–å¥‡æ•°è¡Œå’Œå¶æ•°è¡Œ æ–¹æ³•ä¸€ awk æ–‡ä»¶å†…å®¹ $ cat test.txt 1 2 3 4 5 6 è·å–å¥‡æ•°è¡Œ æ–¹æ³•ä¸€ NRä¸ºè¡Œï¼Œæ¯ä¸€è¡Œä¸2å–æ¨¡ï¼Œå¥‡æ•°ä¸2å–æ¨¡ç»“æœä¸º1ï¼Œ1ä¸ºçœŸï¼Œæ‰€ä»¥è¾“å‡ºå¥‡æ•°è¡Œ $ awk 'NR%2' test.txt 1 3 5 æ–¹æ³•äºŒ ++iè¡¨ç¤ºiå…ˆè‡ªåŠ 1ï¼Œå› æ­¤içš„å€¼ä¸º1 $ awk '++i%2' test.txt 1 3 5 æ–¹æ³•ä¸‰ è¡Œæ•°ä¸2å–æ¨¡ï¼Œç­‰äº1çš„å°±æ˜¯å¥‡æ•°è¡Œ $ awk '{if(NR%2==1)print $0}' test.txt 1 3 5 è·å–å¶æ•°è¡Œ æ–¹æ³•ä¸€ NRä¸ºè¡Œï¼Œæ¯ä¸€è¡Œä¸2å–æ¨¡ï¼Œå¥‡æ•°ä¸2å–æ¨¡ç»“æœä¸º1ï¼Œ1ä¸ºçœŸï¼Œæ‰€ä»¥è¾“å‡ºå¥‡æ•°è¡Œï¼Œå–ååˆ™è¾“å‡ºå¶æ•°è¡Œ $ awk '!(NR%2)' test.txt 2 4 6 æ–¹æ³•äºŒ i++è¡¨ç¤ºå…ˆèµ‹å€¼å†è‡ªåŠ ï¼Œå› æ­¤içš„å€¼ä¸º0 $ awk 'i++%2' test.txt 2 4 6 æ–¹æ³•ä¸‰ è¡Œæ•°ä¸2å–æ¨¡ï¼Œç­‰äº0çš„å°±æ˜¯å¶æ•°è¡Œ $ awk '{if(NR%2==0)print $0}' test.txt 2 4 6 æ–¹æ³•äºŒ sed è·å–å¥‡æ•°è¡Œ nè¡¨ç¤ºæ¢è¡Œï¼Œæ­¤å‘½ä»¤ä¸ºå…ˆæ‰“å°Pï¼Œç„¶åå†æ¢è¡Œï¼Œä¼šæŠŠä¸‹ä¸€è¡Œè¦†ç›–ï¼Œå› æ­¤ä¸ºå…ˆæ‰“å°1è¡Œï¼Œç„¶åæ¢è¡Œï¼Œè¦†ç›–ç¬¬äºŒè¡Œï¼Œå†æ‰“å°ç¬¬3è¡Œï¼Œè¦†ç›–ç¬¬å››è¡Œã€‚ã€‚ã€‚ $ sed -n '1,$p;n' test.txt 1 3 5 è·å–å¶æ•°è¡Œ ä¸å¥‡æ•°è¡Œç›¸åï¼Œå…ˆæ¢è¡Œï¼Œè¦†ç›–ç¬¬ä¸€è¡Œï¼Œå†æ‰“å°ï¼Œæ‰“å°ç¬¬äºŒè¡Œï¼Œç„¶åå†æ¢è¡Œï¼Œè¦†ç›–ç¬¬ä¸‰è¡Œï¼Œç„¶åå†æ‰“å°ï¼Œæ‰“å°ç¬¬å››è¡Œã€‚ã€‚ã€‚ $ sed -n '1,$n;p' test.txt 2 4 6 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/3.3shellè„šæœ¬å°æ“ä½œ.html":{"url":"linux/shell/3.3shellè„šæœ¬å°æ“ä½œ.html","title":"shellè„šæœ¬å°æ“ä½œ","keywords":"","body":"shellè„šæœ¬å°æ“ä½œ ä¸€ã€è·å–æœ¬æœºå…¬ç½‘IP åœºæ™¯ï¼š äº‘ä¸»æœºä½¿ç”¨ipæˆ–è€…ifconfigå‘½ä»¤æ˜¯çœ‹ä¸åˆ°æœ¬æœºå…¬ç½‘IPçš„ï¼Œæƒ³è¦è·å–æœ¬æœºå…¬ç½‘IP è·å–æœ¬åœ°ç½‘ç»œå…¬ç½‘IP curl ifconfig.me $ curl ifconfig.me 8.8.8.8 curl icanhazip.com $ curl icanhazip.com 8.8.8.8 curl ident.me $ curl ident.me 8.8.8.8 curl ipecho.net/plain $ curl ipecho.net/plain 8.8.8.8 curl whatismyip.akamai.com $ curl whatismyip.akamai.com 8.8.8.8 curl myip.dnsomatic.com $ curl myip.dnsomatic.com 8.8.8.8 curl myip.dnsomatic.com $ curl myip.dnsomatic.com 8.8.8.8 äºŒã€è·å–è„šæœ¬ç»å¯¹è·¯å¾„ #ç¼–è¾‘è„šæœ¬ $ cat >/usr/src/test.sh ä¸‰ã€è·å–è„šæœ¬æ‰§è¡Œæ—¶é—´ #ç¼–è¾‘è„šæœ¬ $ cat >/opt/test.sh å››ã€shellè„šæœ¬ä¸­ç²¾å‡†è¿‡æ»¤è¿›ç¨‹ ç¤ºä¾‹ï¼šè¿‡æ»¤crondè¿›ç¨‹ï¼Œä¼šæŠŠgrepå‘½ä»¤åŒæ ·æ˜¾ç¤ºå‡ºæ¥ $ ps aux|grep crond root 771 0.0 0.0 126388 1616 ? Ss 08:57 0:00 /usr/sbin/crond -n root 20996 0.0 0.0 112828 980 pts/0 S+ 21:11 0:00 grep --color=auto crond ç²¾å‡†è¿‡æ»¤ $ ps aux|grep '[c]rond' root 771 0.0 0.0 126388 1616 ? Ss 08:57 0:00 /usr/sbin/crond -n $ ps aux|grep crond |grep -v grep root 771 0.0 0.0 126388 1616 ? Ss 08:57 0:00 /usr/sbin/crond -n äº”ã€shellæ˜¾ç¤ºokæˆ–è€…faild #ç¼–è¾‘è„šæœ¬ $ cat >test.sh æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/3.4shellè„šæœ¬æ‰§è¡Œæ–¹æ³•.html":{"url":"linux/shell/3.4shellè„šæœ¬æ‰§è¡Œæ–¹æ³•.html","title":"shellè„šæœ¬æ‰§è¡Œæ–¹æ³•","keywords":"","body":"shellè„šæœ¬æ‰§è¡Œæ–¹æ³• shellè„šæœ¬5ç§æ‰§è¡Œæ–¹æ³• æ‰§è¡Œæ–¹æ³• æ˜¯å¦éœ€è¦æ‰§è¡Œæƒé™ æ˜¯å¦åœ¨å½“å‰è¿›ç¨‹æ‰§è¡Œ . ä¸éœ€è¦ å½“å‰è¿›ç¨‹ source ä¸éœ€è¦ å½“å‰è¿›ç¨‹ ./ éœ€è¦ å­è¿›ç¨‹ï¼Œä¸èƒ½è¯»å–å½“å‰shellä¸­çš„å˜é‡ sh ä¸éœ€è¦ å­è¿›ç¨‹ï¼Œä¸èƒ½è¯»å–å½“å‰shellä¸­çš„å˜é‡ bash ä¸éœ€è¦ å­è¿›ç¨‹ï¼Œä¸èƒ½è¯»å–å½“å‰shellä¸­çš„å˜é‡ è„šæœ¬å†…å®¹ cat >test.sh æ‰§è¡Œè„šæœ¬ $ pwd /root $ sh test.sh $ pwd #ä¼šå‘ç°ä½¿ç”¨shæ‰§è¡Œè„šæœ¬åˆ‡æ¢è·¯å¾„æœªç”Ÿæ•ˆ /root é—®é¢˜ï¼šæ‰§è¡Œè„šæœ¬åï¼Œç†åº”åˆ‡æ¢åˆ°/optï¼Œä½†æ˜¯å®é™…å¹¶æ²¡æœ‰ åŸå› ï¼šæ‰§è¡Œè„šæœ¬çš„æ—¶å€™ï¼Œåªæ˜¯åœ¨å½“å‰çš„shellä¸‹å¼€äº†ä¸€ä¸ªå­è¿›ç¨‹ï¼Œåˆ‡æ¢ç›®å½•çš„æ“ä½œåªå¯¹è¯¥è¿›ç¨‹ä¸­ç›¸å…³åç»­æŒ‡ä»¤æœ‰æ•ˆï¼Œä½†æ”¹å˜ä¸äº†çˆ¶è¿›ç¨‹çš„ç›®å½• è§£å†³æ–¹æ³•ï¼šä½¿ç”¨.æˆ–è€…sourceæ‰§è¡Œè„šæœ¬ è„šæœ¬çš„æ‰§è¡Œæ–¹æ³• . source è„šæœ¬å¯ä»¥æ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œä¼šåœ¨å½“å‰è¿›ç¨‹ä¸­æ‰§è¡Œ ./ sh bash æ‰§è¡Œè„šæœ¬æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹æ¥è¿è¡Œè„šæœ¬ï¼Œä¸èƒ½è¯»å–å½“å‰shellä¸­çš„å˜é‡ ä»¥ä¸Šäº”ç§æ–¹æ³•ä¸­ï¼Œåªæœ‰./éœ€è¦è„šæœ¬æœ‰æ‰§è¡Œæƒé™ï¼Œå…¶ä»–å››ç§ä¸éœ€è¦ æµ‹è¯• . åˆ‡æ¢ç›®å½•æˆåŠŸ $ pwd /root $ . test.sh $ pwd /opt source åˆ‡æ¢ç›®å½•æˆåŠŸ $ pwd /root $ source test.sh $ pwd /opt ./ åˆ‡æ¢ç›®å½•å¤±è´¥ $ pwd /root $ ./test.sh $ pwd /root sh åˆ‡æ¢ç›®å½•å¤±è´¥ $ pwd /root $ sh test.sh $ pwd /root bash åˆ‡æ¢ç›®å½•å¤±è´¥ $ pwd /root $ bash test.sh $ pwd /root æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/3.5shellæ‰“å°å­—ç¬¦é•¿åº¦.html":{"url":"linux/shell/3.5shellæ‰“å°å­—ç¬¦é•¿åº¦.html","title":"shellæ‰“å°å­—ç¬¦ä¸²é•¿åº¦","keywords":"","body":"shellæ‰“å°å­—ç¬¦é•¿åº¦ ç¼–å†™shellè„šæœ¬ä»¥æ‰“å°ä¸‹é¢è¯­å¥ä¸­å­—ç¬¦æ•°å°äº6çš„å•è¯ã€‚ The hard part isnâ€™t making the decision. Itâ€™s living with it. æ€è·¯ï¼šé¦–å…ˆå–å‡ºæ‰€æœ‰å•è¯ï¼Œè®¡ç®—æ¯ä¸ªå•è¯çš„é•¿åº¦ï¼Œç„¶åä¾æ¬¡è¿›è¡Œåˆ¤æ–­ è®¡ç®—å˜é‡å†…å®¹çš„é•¿åº¦ï¼Œå¸¸è§çš„æ–¹æ³•æœ‰å››ç§ï¼š 1.å˜é‡è‡ªå¸¦çš„è·å–é•¿åº¦çš„æ–¹æ³• echo $ $ str=abc $ echo ${#str} 3 2.ç®¡é“åŠ wc -Læ–¹æ³• $ str=abc #-L æ‰“å°è¡Œé•¿åº¦ $ echo $str|wc -L 3 3.åˆ©ç”¨exprè‡ªå¸¦çš„lengthæ–¹æ³• $ str=abc $ expr length $str 3 4.åˆ©ç”¨awkè‡ªå¸¦çš„lengthå‡½æ•°æ–¹æ³• $ str=abc $ echo $str|awk '{print length ($0)}' 3 ç»“åˆforå¾ªç¯æˆªå–å­—ç¬¦ä¸² ç»“åˆforå¾ªç¯æˆªå–å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚æˆªå–ç»™å®šå­—ç¬¦ä¸²ä¸­é•¿åº¦å¤§äºæŸä¸€ä¸ªå€¼æˆ–å°äºæŸä¸€ä¸ªå€¼ ä¾‹å¥ï¼šThe hard part isn't making the decision. It's living with it. æˆªå–ä¾‹å¥ä¸­å•è¯é•¿åº¦å¤§äº5çš„å•è¯ æ–¹æ³•ä¸€ $ #ç¼–è¾‘è„šæœ¬ cat >test.sh æ–¹æ³•äºŒ wc -L #ç¼–è¾‘è„šæœ¬ cat >test.sh æ–¹æ³•ä¸‰ åˆ©ç”¨exprè‡ªå¸¦çš„lengthæ–¹æ³• #ç¼–è¾‘è„šæœ¬ cat >test.sh æ–¹æ³•å›› åˆ©ç”¨awkè‡ªå¸¦çš„lengthå‡½æ•°æ–¹æ³• #ç¼–è¾‘è„šæœ¬ cat >test.sh æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/4.shellè„šæœ¬æ¡ä»¶æµ‹è¯•.html":{"url":"linux/shell/4.shellè„šæœ¬æ¡ä»¶æµ‹è¯•.html","title":"shellè„šæœ¬æ¡ä»¶æµ‹è¯•","keywords":"","body":"shellè„šæœ¬æ¡ä»¶æµ‹è¯• ä¸€ã€sehllè„šæœ¬çš„æ¡ä»¶æµ‹è¯• æ¡ä»¶æµ‹è¯•è¯­æ³• è¯´æ˜ test æµ‹è¯•è¡¨è¾¾å¼ testå‘½ä»¤å’Œæµ‹è¯•è¡¨è¾¾å¼ä¹‹é—´è‡³å°‘æœ‰ä¸€ä¸ªç©ºæ ¼ [ æµ‹è¯•è¡¨è¾¾å¼ ] []è¾¹ç•Œå’Œå†…å®¹ä¹‹é—´è‡³å°‘æœ‰ä¸€ä¸ªç©ºæ ¼ [[ æµ‹è¯•è¡¨è¾¾å¼ ]] [[]]è¾¹ç•Œå’Œå†…å®¹ä¹‹é—´è‡³å°‘æœ‰ä¸€ä¸ªç©ºæ ¼ ((æµ‹è¯•è¡¨è¾¾å¼)) ä¸€èˆ¬ç”¨äºifè¯­å¥é‡Œ,(())ä¿©è¾¹ä¸éœ€è¦æœ‰ç©ºæ ¼ &&ã€||ã€>ã€ç­‰æ“ä½œç¬¦å¯ä»¥åº”ç”¨äº[[]]ä¸­ï¼Œä½†ä¸èƒ½åº”ç”¨äº[]ä¸­ï¼Œåœ¨[]ä¸­ä¸€èˆ¬ç”¨-aã€-oã€-gtã€-ltä»£æ›¿ä¸Šè¿°æ“ä½œ äºŒã€æ–‡ä»¶æµ‹è¯•è¡¨è¾¾å¼ æ–‡ä»¶æµ‹è¯•æ“ä½œç¬¦ è¯´æ˜ -d (directory) æ˜¯å¦ä¸ºç›®å½• -f (file) æ˜¯å¦ä¸ºæ–‡ä»¶ -e (exist) æ–‡ä»¶æ˜¯å¦å­˜åœ¨ -r (read) æ˜¯å¦åªè¯» -w (write) æ˜¯å¦å¯å†™ -x (executable) æ˜¯å¦å¯æ‰§è¡Œ -s (size) æ–‡ä»¶å¤§å°ä¸ä¸º0 -L (link) æ˜¯å¦ä¸ºé“¾æ¥æ–‡ä»¶ -nt (new than) f1 -nt f2 æ–‡ä»¶f1æ˜¯å¦æ¯”f2æ–° -ot (older than) f1 -ot f2 æ–‡ä»¶f1æ˜¯å¦æ¯”f2æ—§ -rå’Œ-wéƒ½æ˜¯åˆ¤æ–­æ–‡ä»¶å±ä¸»æ˜¯å¦æœ‰æƒé™(rootç”¨æˆ·ä¸‹éƒ½ä¼šè¿”å›1)ï¼Œå±ç»„å’Œå…¶ä»–äººå³ä½¿æœ‰æƒé™ä¹Ÿè¿”å›0 -x æ™®é€šç”¨æˆ·ä¸‹åˆ¤æ–­å±ä¸»æ˜¯å¦æœ‰æ‰§è¡Œæƒé™ï¼Œå³ä½¿å±ç»„å’Œå…¶ä»–äººæœ‰æƒé™ä¹Ÿè¿”å›0 -x rootç”¨æˆ·ä¸‹åªè¦æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™å°±è¿”å›1 æ–‡ä»¶æµ‹è¯•è¡¨è¾¾å¼ç¤ºä¾‹ åˆ¤æ–­æ–‡ä»¶å±ä¸»æ˜¯å¦æœ‰è¯»æƒé™ #åˆ›å»ºæ–‡ä»¶ $ touch hehe $ ll hehe -rw-r--r-- 1 root root 0 Nov 22 13:30 hehe #å°†heheçš„æƒé™æ”¹ä¸º000 $ chmod 000 hehe $ ll hehe ---------- 1 root root 0 Nov 22 13:30 hehe #åˆ¤æ–­æ–‡ä»¶æ˜¯å¦åªè¯» $ [ -r hehe ] && echo 1 || echo 0 #æ–‡ä»¶heheæ²¡æœ‰ä»»ä½•æƒé™ï¼Œä½†æ˜¯è¿”å›äº†1ï¼Œå› ä¸ºå½“å‰ç”¨æˆ·æ˜¯root 1 #åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·æµ‹è¯• $ su - www $ touch hehe $ chmod 000 hehe $ ll total 0 ---------- 1 www www 0 Jun 25 10:14 hehe #æ™®é€šç”¨æˆ·ä¸‹ï¼Œå½“æ–‡ä»¶æ²¡æœ‰è¯»æƒé™çš„æ—¶å€™è¿”å›æ˜¯0 $ [ -r hehe ] && echo 1 || echo 0 0 åˆ¤æ–­æ–‡ä»¶å±ä¸»æ˜¯å¦æœ‰å†™æƒé™ #åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯å†™ $ [ -w hehe ] && echo 1 || echo 0 #æ–‡ä»¶heheæ²¡æœ‰ä»»ä½•æƒé™ï¼Œä½†æ˜¯è¿”å›äº†1ï¼Œå› ä¸ºå½“å‰ç”¨æˆ·æ˜¯root 1 #åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·æµ‹è¯• $ su - www $ touch hehe $ chmod 000 hehe $ ll total 0 ---------- 1 www www 0 Jun 25 10:14 hehe #æ™®é€šç”¨æˆ·ä¸‹ï¼Œå½“æ–‡ä»¶æ²¡æœ‰å†™æƒé™çš„æ—¶å€™è¿”å›æ˜¯0 $ [ -w hehe ] && echo 1 || echo 0 0 åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æœ‰æ‰§è¡Œæƒé™ #åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ $ [ -x hehe ] && echo 1 || echo 0 #æ–‡ä»¶æ‰€æœ‰è€…æ˜¯rootçš„æƒ…å†µä¸‹ï¼Œåªæœ‰æ‰§è¡Œæƒé™æ²¡æœ‰çš„æ—¶å€™ä¼šè¿”å›0ï¼Œè¯»å†™æƒé™å³ä½¿æ²¡æœ‰ä¹Ÿä¼šè¿”å›1 0 -fç¤ºä¾‹ $ echo $hehe #å˜é‡heheä¸ºç©º $ [ -f $hehe ] && echo 1 || echo 0 1 #ä¸åŠ å¼•å·è¿”å›çš„ç»“æœä¸æ­£ç¡® $ [ -f \"$hehe\" ] && echo 1 || echo 0 0 #åŠ å¼•å·è¿”å›æ‰æ­£ç¡® ä¸‰ã€å­—ç¬¦ä¸²æµ‹è¯•è¡¨è¾¾å¼ å­—ç¬¦ä¸²æµ‹è¯•æ“ä½œç¬¦ è¯´æ˜ -n å­—ç¬¦ä¸² è‹¥å­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º0ï¼Œåˆ™ä¸ºçœŸ no zero -z å­—ç¬¦ä¸² è‹¥å­—ç¬¦ä¸²é•¿åº¦ä¸º0ï¼Œåˆ™ä¸ºçœŸ zero å­—ç¬¦ä¸²1=å­—ç¬¦ä¸²2 è‹¥å­—ç¬¦ä¸²1ç­‰äºå­—ç¬¦ä¸²2ï¼Œåˆ™ä¸ºçœŸ å­—ç¬¦ä¸²1!=å­—ç¬¦ä¸²2 è‹¥å­—ç¬¦ä¸²1ä¸ç­‰äºå­—ç¬¦ä¸²2ï¼Œåˆ™ä¸ºçœŸ å­—ç¬¦ä¸²æµ‹è¯•è¡¨è¾¾å¼ç‰¹æ®Šç¤ºä¾‹ ç¤ºä¾‹1 $ [ \"abc\"=\"1\" ] && echo 1 || echo 0 1 #ç»“æœä¸æ­£ç¡®ï¼Œè¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒæ—¶ï¼Œç­‰å·ä¸¤ç«¯å¦‚æœæ²¡æœ‰ç©ºæ ¼åˆ™ä¼šé”™è¯¯ $ [ \"abc\" = \"1\" ] && echo 1 || echo 0 0 ç¤ºä¾‹2 $ var=\"\" $ echo $var $ [ -n \"$var\" ] && echo 1 || echo 0 0 $ [ -n $var ] && echo 1 || echo 0 1 #ç»“æœä¸æ­£ç¡®ï¼Œå› ä¸ºå˜é‡varä¸ºç©ºï¼Œå­—ç¬¦ä¸²æ¯”è¾ƒæ—¶ï¼Œå¦‚æœä¸åŠ åŒå¼•å·åˆ™ç»“æœä¸æ­£ç¡® ç¤ºä¾‹3 (å¤§äºå·)åœ¨[]ä¸­ä½¿ç”¨æ—¶ï¼Œéœ€è¦ç”¨\\è½¬ä¹‰ $ [ 1 å››ã€æ•´æ•°äºŒå…ƒæ¯”è¾ƒæ“ä½œç¬¦ æ•´æ•°äºŒå…ƒæ¯”è¾ƒæ“ä½œç¬¦ è¯´æ˜ -eq ç›¸ç­‰ equal -ne ä¸ç›¸ç­‰ not equal -gt å¤§äº granter than -ge å¤§äºç­‰äº granter equal -lt å°äº less than -le å°äºç­‰äº less equal äº”ã€é€»è¾‘æ“ä½œç¬¦ åœ¨[]å’Œtestä¸­ä½¿ç”¨çš„æ“ä½œç¬¦ åœ¨[[]]å’Œ(())ä¸­ä½¿ç”¨çš„æ“ä½œç¬¦ è¯´æ˜ -a && and,ä¸ ä¿©ç«¯éƒ½ä¸ºçœŸåˆ™ç»“æœä¸ºçœŸ -o **\\ \\ ** or,æˆ– ä¿©ç«¯æœ‰ä¸€ä¸ªä¸ºçœŸåˆ™ä¸ºçœŸ ï¼ ï¼ not,é ä¿©ç«¯ç›¸ååˆ™ä¸ºçœŸ é€»è¾‘è¿ç®—ç¬¦ç¤ºä¾‹ -a -oä¸èƒ½ç”¨åœ¨[[]]ä¸­ï¼Œ&& ||ç­‰ä¸èƒ½ç”¨åœ¨[]ä¸­ #&&ä¸èƒ½ç”¨åœ¨[]ä¸­ï¼Œéœ€è¦ä½¿ç”¨-a $ [ -f /etc/hosts && -f /etc/services ] && echo 1 || echo 0 #bash: [: missing `]' 0 $ [ -f /etc/hosts -a -f /etc/services ] && echo 1 || echo 0 1 #-aä¸èƒ½ç”¨åœ¨[[]]ä¸­ï¼Œéœ€è¦ä½¿ç”¨&& $ [[ -f /etc/hosts -a -f /etc/services ]] && echo 1 || echo 0 -bash: syntax error in conditional expression #-bash: syntax error near `-a' $ [[ -f /etc/hosts && -f /etc/services ]] && echo 1 || echo 0 1 å…­ã€æµ‹è¯•è¡¨è¾¾å¼testã€[]ã€[[]]ã€(())çš„åŒºåˆ«æ€»ç»“ å…¶ä¸­[]æœ€ä¸ºå¸¸ç”¨ æµ‹è¯•è¡¨è¾¾å¼ç¬¦å· è¾¹ç•Œæ˜¯å¦éœ€è¦ç©ºæ ¼ é€»è¾‘æ“ä½œç¬¦ æ•´æ•°æ¯”è¾ƒæ“ä½œç¬¦ å­—ç¬¦ä¸²æ¯”è¾ƒæ“ä½œç¬¦ æ˜¯å¦æ”¯æŒé€šé…ç¬¦åŒ¹é… test éœ€è¦ !ã€-aã€-o -eqã€-gtã€-ltã€geã€-le =ã€==ã€!= ä¸æ”¯æŒ [] éœ€è¦ !ã€-aã€-o -eqã€-gtã€-ltã€geã€-le =ã€==ã€!= ä¸æ”¯æŒ [[]] éœ€è¦ **!ã€&&ã€\\ \\ ** -eqã€-gtã€-ltã€geã€-leæˆ–=ã€>ã€=ã€ =ã€==ã€!= æ”¯æŒ (()) ä¸éœ€è¦ !ã€&&ã€ =ã€>ã€=ã€ =ã€==ã€!= ä¸æ”¯æŒ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/5.shellæ•°å€¼è¿ç®—.html":{"url":"linux/shell/5.shellæ•°å€¼è¿ç®—.html","title":"shellæ•°å€¼è¿ç®—","keywords":"","body":"shellæ•°å€¼è¿ç®— ä¸€ã€ç®—æœ¯è¿ç®—ç¬¦è¡¨ ç®—æœ¯è¿ç®—ç¬¦ å«ä¹‰ + - åŠ æ³•ã€å‡æ³• * / % ä¹˜æ³•ã€é™¤æ³•ã€å–æ¨¡ ** å¹‚è¿ç®— ++ -- å¢åŠ ã€å‡å°‘ **ï¼ && \\ \\ ** é€»è¾‘éã€ä¸ã€æˆ– >= å°äºã€å°äºç­‰äºã€å¤§äºã€å¤§äºç­‰äº == != = ç›¸ç­‰ã€ä¸ç›¸ç­‰ã€å¯¹äºå­—ç¬¦ä¸²\"=\"è¡¨ç¤ºç›¸å½“äº > å‘å·¦ç§»ä½ã€å‘å³ç§»ä½ **~ \\ & ^** æŒ‰ä½å–åã€æŒ‰ä½å¼‚æˆ–ã€æŒ‰ä½ä¸ã€æŒ‰ä½æˆ– = += -= *= /= %= èµ‹å€¼è¿ç®—ç¬¦,ä¾‹å¦‚a+=1ç›¸å½“äºa=a+1 äºŒã€è¿ç®—æ“ä½œç¬¦ä¸è¿ç®—å‘½ä»¤ è¿ç®—æ“ä½œç¬¦ä¸è¿ç®—å‘½ä»¤ å«ä¹‰ (()) ç”¨äºæ•´æ•°è¿ç®—çš„å¸¸ç”¨è¿ç®—ç¬¦ï¼Œæ•ˆç‡æœ€é«˜ let ç”¨äºæ•´æ•°è¿ç®—,ç±»ä¼¼äº\"(())\" expr å¯ç”¨äºæ•´æ•°è¿ç®—,ä½†è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„é¢å¤–åŠŸèƒ½ bc linuxä¸‹çš„ä¸€ä¸ªè®¡ç®—å™¨ç¨‹åº $[] ç”¨äºæ•´æ•°è¿ç®— awk awkæ—¢å¯ä»¥ç”¨äºæ•´æ•°è¿ç®—,ä¹Ÿå¯ä»¥ç”¨äºå°æ•°è¿ç®— declare å®šä¹‰å˜é‡å€¼å’Œå±æ€§,-i å‚æ•°å¯ä»¥ç”¨äºå®šä¹‰æ•´å‹å˜é‡ï¼Œåšè¿ç®— ä¸‰ã€åŒå°æ‹¬å·\"(())\"æ•°å€¼è¿ç®— ç¤ºä¾‹ $ echo $((1+10)) 11 $ echo $((1-10)) -9 ç¤ºä¾‹1 ç”¨(())åšæ•°å€¼è¿ç®— $ echo $((1+2**3-4%3)) #å…ˆä¹˜é™¤ååŠ å‡ï¼Œå…ˆç®—2**3=8 4%3=1ï¼Œæœ€å1+8-1=8 8 $ ((a=1+2**3-4%3)) $ echo $a 8 ç¤ºä¾‹2 åœ¨å˜é‡å‰åä½¿ç”¨--å’Œ++ç‰¹æ®Šè¿ç®—ç¬¦çš„è¡¨è¾¾å¼ $ a=10 $ echo $((a++)) #å¦‚æœaåœ¨è¿ç®—ç¬¦++çš„å‰é¢ï¼Œé‚£ä¹ˆåœ¨è¾“å‡ºæ•´ä¸ªè¡¨è¾¾å¼æ—¶ï¼Œä¼šè¾“å‡ºaçš„å€¼ 10 $ echo $a #æ‰§è¡Œä¸Šé¢çš„è¡¨è¾¾å¼åï¼Œå› ä¸ºæœ‰a++ï¼Œå› æ­¤aä¼šå¢åŠ 1 11 $ a=10 $ echo $((a--)) #å¦‚æœaåœ¨è¿ç®—ç¬¦--çš„å‰é¢ï¼Œé‚£ä¹ˆåœ¨è¾“å‡ºæ•´ä¸ªè¡¨è¾¾å¼æ—¶ï¼Œä¼šè¾“å‡ºaçš„å€¼ 10 $ echo $a #æ‰§è¡Œä¸Šé¢çš„è¡¨è¾¾å¼åï¼Œå› ä¸ºæœ‰a--ï¼Œå› æ­¤aä¼šå‡å°‘1 9 $ a=10 $ echo $((++a)) #å¦‚æœaåœ¨è¿ç®—ç¬¦++çš„åé¢ï¼Œé‚£ä¹ˆåœ¨è¾“å‡ºæ•´ä¸ªè¡¨è¾¾å¼æ—¶ï¼Œå…ˆè¿›è¡Œè‡ªå¢ 11 $ echo $a 11 $ a=10 $ echo $((--a)) #å¦‚æœaåœ¨è¿ç®—ç¬¦--çš„åé¢ï¼Œé‚£ä¹ˆåœ¨è¾“å‡ºæ•´ä¸ªè¡¨è¾¾å¼æ—¶ï¼Œå…ˆè¿›è¡Œè‡ªå‡ 9 $ echo $a 9 ç¤ºä¾‹3 é€šè¿‡(())è¿ç®—åèµ‹å€¼ç»™å˜é‡ $ a=100 $ b=$((a+1)) $ echo $b 101 å››ã€letè¿ç®—å‘½ä»¤çš„ç”¨æ³• letè¿ç®—å‘½ä»¤è¯­æ³•æ ¼å¼ let èµ‹å€¼è¡¨è¾¾å¼ ç›¸å½“äº ((èµ‹å€¼è¡¨è¾¾å¼)) ç¤ºä¾‹1 ç”¨letåšæ•°å€¼è¿ç®— $ a=1 $ let a=a+8 $ echo $a 9 äº”ã€exprå‘½ä»¤çš„ç”¨æ³• exprå‘½ä»¤æ—¢å¯ä»¥ç”¨äºæ•´æ•°è¿ç®—,ä¹Ÿå¯ä»¥ç”¨äºç›¸å…³å­—ç¬¦ä¸²é•¿åº¦ã€åŒ¹é…ç­‰çš„è¿ç®—å¤„ç† ç¤ºä¾‹ exprå‘½ä»¤ç”¨äºè®¡ç®— $ expr 2+2 2+2 $ expr 2 + 2 #æ³¨æ„ï¼Œè¿ç®—ç¬¦å·¦å³å¿…é¡»æœ‰è‡³å°‘ä¸€ä¸ªç©ºæ ¼ 4 $ expr 2 * 2 expr: syntax error #æ³¨æ„ï¼Œåšä¹˜æ³•è¿ç®—éœ€è¦è½¬ä¹‰* $ expr 2 \\* 2 4 ç¤ºä¾‹2 åˆ©ç”¨expråˆ¤æ–­ä¸€ä¸ªå˜é‡å€¼æˆ–å­—ç¬¦ä¸²æ˜¯å¦ä¸ºæ•´æ•° å®ç°åŸç†:åˆ©ç”¨expråšè®¡ç®—æ—¶å˜é‡æˆ–å­—ç¬¦ä¸²å¿…é¡»æ˜¯æ•´æ•°çš„åŸåˆ™ï¼ŒæŠŠä¸€ä¸ªå˜é‡æˆ–å­—ç¬¦ä¸²å’Œä¸€ä¸ªå·²çŸ¥çš„æ•´æ•°(é0)ç›¸åŠ ï¼Œçœ‹å‘½ä»¤è¿”å›çš„å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œå°±è®¤ä¸ºåšåŠ æ³•çš„å˜é‡æˆ–å­—ç¬¦ä¸²ä¸ºæ•´æ•°ï¼Œå¦åˆ™å°±ä¸æ˜¯ $ i=1 $ expr $i + 1 &>/dev/null $ echo $? 0 #è¿”å›0ï¼Œè¯æ˜içš„å€¼ä¸ºæ•´æ•° $ i=hehe $ expr $i + 1 &>/dev/null $ echo $? 2 #è¿”å›ä¸ºé0ï¼Œè¯æ˜içš„å€¼ä¸æ˜¯æ•´æ•° ç¤ºä¾‹3 åˆ©ç”¨expråˆ¤æ–­å‚æ•°æ˜¯å¦ä¸ºæ•´æ•° #ç¼–è¾‘è„šæœ¬ cat >expr1.sh /dev/null 2>&1 [ $? -eq 0 ] && echo int || echo chars done EOF #æ‰§è¡Œè„šæœ¬ $ sh expr1.sh please input: 1 int please input: 2 int please input: a chars please input: / chars ç¤ºä¾‹4 åˆ©ç”¨expråˆ¤æ–­æ–‡ä»¶æ‰©å±•åæ˜¯å¦ç¬¦åˆè¦æ±‚ #ç¼–è¾‘è„šæœ¬ cat > string.sh /dev/null;then echo \"you are using $1\" else echo \"please use *.pub file\" fi EOF #æ‰§è¡Œè„šæœ¬ $ sh string.sh hehe please use *.pub file $ sh string.sh hehe.pub you are using hehe.pub ç¤ºä¾‹5 åˆ©ç”¨exprè®¡ç®—å­—ç¬¦ä¸²çš„é•¿åº¦ #å½“å˜é‡æœ‰ç©ºæ ¼æ—¶ï¼Œexpr length åçš„å˜é‡å¿…é¡»åŠ å¼•å· $ char=\"i am a boy\" $ expr length $char expr: syntax error $ expr length \"$char\" 10 #å½“å˜é‡æ²¡æœ‰ç©ºæ ¼æ—¶ï¼Œexpr length åçš„å˜é‡å¯ä»¥ä¸åŠ å¼•å· $ char=\"iamboy\" $ expr length $char 6 äº”ã€bcå‘½ä»¤çš„ç”¨æ³• ç¤ºä¾‹1 bcäº¤äº’å¼ç”¨æ³• $ bc bc 1.06.95 Copyright 1991-1994, 1997, 1998, 2000, 2004, 2006 Free Software Foundation, Inc. This is free software with ABSOLUTELY NO WARRANTY. #For details type `warranty'. scale=5 #è¡¨ç¤ºå°æ•°åä¿ç•™5ä½ 9/5 1.80000 9/1.3 6.92307 1+1 2 9-3 6 ç¤ºä¾‹2 bcç”¨åœ¨å‘½ä»¤è¡Œä¸­ $ echo 3+5 | bc 8 $ echo 9-3 | bc 6 $ echo 9*9 | bc 81 $ echo 9.9+6.6 | bc 16.5 ç¤ºä¾‹3 åˆ©ç”¨bcé€šè¿‡ä¸€æ¡å‘½ä»¤è®¡ç®—è¾“å‡º1+2+3+..+10çš„å€¼ #ç”Ÿæˆè¡¨è¾¾å¼æ–¹æ³•ä¸€ $ seq -s \"+\" 10 1+2+3+4+5+6+7+8+9+10 $ seq -s \"+\" 10 | bc 55 #ç”Ÿæˆè¡¨è¾¾å¼æ–¹æ³•äºŒ $ echo {1..10} | tr \" \" \"+\" 1+2+3+4+5+6+7+8+9+10 $ echo {1..10} | tr \" \" \"+\" | bc 55 å…­ã€$[]ç¬¦å·çš„è¿ç®— $[]åªèƒ½åšæ•´æ•°è¿ç®— $ echo $[2**3] 8 $ echo $((3%5)) 3 $ echo $[1+1] 2 $ echo $[2*2] 4 $ echo $[10/3] 3 $ echo $[10%3] 1 $ echo $[10**3] 1000 ä¸ƒã€ç”¨awkå®ç°è®¡ç®— #æ–¹æ³•1 $ echo \"9.9 8.8\" | awk '{print ($1-$2)}' 1.1 $ echo \"358 113\" | awk '{print ($1-3)/$2}' 3.14159 #æ–¹æ³•2 $ awk 'BEGIN{print (9.9-8.8)}' 1.1 $ awk 'BEGIN{print (358-3)/113}' 3.14159 å…«ã€declare(åŒtypeset)å‘½ä»¤ç”¨æ³• ä½¿ç”¨typesetå®šä¹‰æ•´æ•°å˜é‡ï¼Œç›´æ¥è¿›è¡Œè®¡ç®—ï¼Œæ­¤æ–¹æ³•ä¸å¸¸ç”¨ï¼Œå› ä¸ºéœ€è¦å®šä¹‰æ‰èƒ½ç”Ÿæ•ˆ $ declare -i A=10 B=20 $ A=A+B $ echo $A 30 $ typeset -i C=30 D=50 $ C=C+D $ echo $C 80 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/6.1shellæµç¨‹æ§åˆ¶è¯­å¥ä¹‹if.html":{"url":"linux/shell/6.1shellæµç¨‹æ§åˆ¶è¯­å¥ä¹‹if.html","title":"if","keywords":"","body":"shellæµç¨‹æ§åˆ¶è¯­å¥ä¹‹if ä¸€ã€ifå•åˆ†æ”¯ 1.1 ifå•åˆ†æ”¯è¯­æ³• #å†™æ³•ä¸€ if æ¡ä»¶è¡¨è¾¾å¼;then å‘½ä»¤ fi #å†™æ³•äºŒ if æ¡ä»¶è¡¨è¾¾å¼ then å‘½ä»¤ fi 1.2 ç¤ºä¾‹ if [ 1 -eq 1 ];then echo \"equality\" fi äºŒã€ifåŒåˆ†æ”¯ 2.1 ifåŒåˆ†æ”¯è¯­æ³• #å†™æ³•ä¸€ if æ¡ä»¶è¡¨è¾¾å¼;then å‘½ä»¤ else å‘½ä»¤ fi #å†™æ³•äºŒ if æ¡ä»¶è¡¨è¾¾å¼ then å‘½ä»¤ else å‘½ä»¤ fi 2.2 ç¤ºä¾‹ if [ 1 -eq 1 ];then echo \"equality\" else echo \"not equality\" fi ä¸‰ã€ifå¤šåˆ†æ”¯ 3.1 ifå¤šåˆ†æ”¯è¯­æ³• elifåé¢è¿˜å¯ä»¥åŠ æ¡ä»¶ï¼Œå³elifå¯ä»¥æœ‰å¤šä¸ª å†™æ³•ä¸€ if æ¡ä»¶è¡¨è¾¾å¼;then å‘½ä»¤ elif å‘½ä»¤ else å‘½ä»¤ fi å†™æ³•äºŒ if æ¡ä»¶è¡¨è¾¾å¼ then å‘½ä»¤ elif å‘½ä»¤ else å‘½ä»¤ fi 3.2 ç¤ºä¾‹ if [ 1 -eq 1 ];then echo \"equality\" elif [ 2 -eq 1 ];then echo \"equality\" else echo \"not equality\" fi çŒœæ•°å­—è„šæœ¬ç¤ºä¾‹ ç³»ç»Ÿäº§ç”Ÿä¸€ä¸ªéšæœºæ•°ï¼Œç„¶åç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ•°å­—ï¼Œä¸éšæœºæ•°åšæ¯”è¾ƒï¼Œè¾“å…¥çš„æ•°å­—æ¯”éšæœºæ•°å¤§åˆ™æç¤ºè¾“å…¥æ•°å­—å¤§äº†ï¼Œè¾“å…¥çš„æ•°å­—æ¯”éšæœºæ•°å°åˆ™æç¤ºè¾“å…¥æ•°å­—å°äº†ï¼ŒçŒœå¯¹æç¤ºä½ çŒœå¯¹äº† #!/usr/bin/env bash SJ=`echo $((RANDOM%100+1))` i=1 for ((;;)) do read -p \"please input a num: \" NUM if [[ $NUM =~ ^[0-9]+$ ]];then if [ $NUM -eq $SJ ];then echo -e \"\\033[32myou guess it!!! \\033[0m\" echo -e \"\\033[34mGuess the total is $i times!!!\\033[0m\" exit 0 elif [ $NUM -gt $SJ ];then echo \"Larger than the random number\" else echo \"Smaller than the random number\" fi else echo \"Please enter the correct number: \" fi let i++ done æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/6.2shellæµç¨‹æ§åˆ¶è¯­å¥ä¹‹case.html":{"url":"linux/shell/6.2shellæµç¨‹æ§åˆ¶è¯­å¥ä¹‹case.html","title":"case","keywords":"","body":"shellæµç¨‹æ§åˆ¶è¯­å¥ä¹‹case caseè¯­å¥è¯­æ³• case å˜é‡å in æ¨¡å¼1) å‘½ä»¤1 ;; æ¨¡å¼2) å‘½ä»¤2 ;; æ¨¡å¼3) å‘½ä»¤3 ;; *) å…¶å®ƒå‘½ä»¤ esac ä½¿ç”¨ç¤ºä¾‹ read -p \"è¯·è¾“å…¥ä¸€ä¸ªæ•°å­—ï¼š\" NUM case $NUM in 1) echo \"ä½ è¾“å…¥çš„æ˜¯1\" ;; 2) echo \"ä½ è¾“å…¥çš„æ˜¯2\" ;; 3) echo \"ä½ è¾“å…¥çš„æ˜¯3\" ;; *) echo \"è¯·è¾“å…¥ä»¥ä¸‹æ•°å­—{1|2|3}\" esac è´­ç‰©è„šæœ¬ç¤ºä¾‹ æ‰“å°æœ¬åº—èœå•ï¼Œç„¶åæç¤ºè¾“å…¥å•†å“çš„ç¼–å·ï¼Œè´­ä¹°çš„æ•°é‡ï¼Œå¹¶è®¡ç®—æ¶ˆè´¹å¤šå°‘ï¼Œå¦‚æœè¾“å…¥ä¸æ­£ç¡®åˆ™é€€å‡º #!/bin/bash echo -e \"\\033[36mè¿™æ˜¯æœ¬åº—çš„èœå•:\\033[0m \\n\\t\\033[32m1.æ±‰å ¡/13ï¿¥\\033[0m\\n\\t\\033[35m2.>é¸¡è…¿/9ï¿¥\\033[0m\\n\\t\\033[31m3.å¯ä¹/6ï¿¥\\033[0m\" xunhuan (){ read -p 'è¯·è¾“å…¥è¦è´­ä¹°çš„å•†å“ç¼–å·,æŒ‰\"q\"é€€å‡º,æŒ‰\"y\"æ‰“å°æ¶ˆè´¹æ¸…å•: ' menu case \"$menu\" in q) break ;; 1) read -p \"è¯·è¾“å…¥è¦è´­ä¹°çš„æ±‰å ¡æ•°é‡: \" hb echo -e \"\\033[34m\\næ‚¨è´­ä¹°äº†$hbä¸ªæ±‰å ¡\\n\\033[0m\" ;; 2) read -p \"è¯·è¾“å…¥è¦è´­ä¹°çš„é¸¡è…¿æ•°é‡: \" jt echo -e \"\\033[34m\\næ‚¨è´­ä¹°äº†$jtä¸ªé¸¡è…¿\\n\\033[0m\" ;; 3) read -p \"è¯·è¾“å…¥è¦è´­ä¹°çš„å¯ä¹æ•°é‡: \" kl echo -e \"\\033[34m\\næ‚¨è´­ä¹°äº†$klä¸ªå¯ä¹\\n\\033[0m\" ;; y) a=$hb*13 b=$jt*9 c=$kl*6 let sum=$a+$b+$c echo -e \"\\033[32mæ¶ˆè´¹æ¸…å•:\\n\\tå•†å“åç§°\\tå•ä»·\\tæ•°é‡\\tæ€»ä»·\\n\\tæ±‰å ¡\\t\\t13ï¿¥\\t$hb\\t$a\\n\\té¸¡è…¿\\t\\t9ï¿¥\\t$jt\\t$b\\n\\tå¯ä¹\\t\\t6ï¿¥\\t$kl\\t$c\\n\\n\\tæ€»è®¡:$sumå…ƒ\\t\\tæ”¶é“¶å‘˜ï¼šæéªšå³°\\033[0m\" ;; *) echo \"è¾“å…¥ä¸æ­£ç¡®,è¯·è¾“å…¥æ­£ç¡®çš„ç¼–å·{1|2|3}\" esac } while : ;do xunhuan done æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/7.1shellå¾ªç¯æ§åˆ¶è¯­å¥ä¹‹for.html":{"url":"linux/shell/7.1shellå¾ªç¯æ§åˆ¶è¯­å¥ä¹‹for.html","title":"for","keywords":"","body":"shellå¾ªç¯æ§åˆ¶è¯­å¥ä¹‹for è¯­æ³• for å˜é‡å in å–å€¼åˆ—è¡¨; do å‘½ä»¤ done ç¤ºä¾‹ #!/bin/bash data='a b c d' IFS=, for i in $data;do echo $i done forå¾ªç¯é«˜å¹¶å‘æ‰§è¡Œè„šæœ¬ forå¾ªç¯pingè„šæœ¬ï¼Œæ‰§è¡Œæ•ˆæœå¾ˆæ…¢ï¼Œå› ä¸ºä¼šä¸€ä¸ªä¸€ä¸ªIPå»ping #!/usr/bin/env bash #export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin for i in {1..254} do ping -c1 10.0.0.$i &>/dev/null if [ $? -eq 0 ];then echo \"10.0.0.$i\" >> /root/ping.txt fi done é«˜å¹¶å‘æ‰§è¡Œ #!/usr/bin/env bash #export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin for i in {1..254} do { ping -c1 10.0.0.$i &>/dev/null if [ $? -eq 0 ];then echo \"10.0.0.$i\" >> /root/ping.txt fi }& done wait echo -e\"online ip is: \\n`cat /root/ping.txt`\" waite ç­‰å¾…å¹¶å‘å…¨éƒ¨æ‰§è¡Œå®Œæˆæ‰å¾€åæ‰§è¡Œ forå¾ªç¯é«˜å¹¶å‘ åœ¨è¦æ‰§è¡Œçš„å‘½ä»¤å¤–åŠ ä¸Š {å‘½ä»¤}& å³åœ¨doè·Ÿdoneä¹‹é—´çš„å‘½ä»¤åŠ {}& æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/7.2shellå¾ªç¯æ§åˆ¶è¯­å¥ä¹‹whileã€until.html":{"url":"linux/shell/7.2shellå¾ªç¯æ§åˆ¶è¯­å¥ä¹‹whileã€until.html","title":"whileã€until","keywords":"","body":"shellå¾ªç¯æ§åˆ¶è¯­å¥ä¹‹whileã€until ä¸€ã€while è¯­æ³• while æ¡ä»¶è¡¨è¾¾å¼ do å‘½ä»¤ done è¯´æ˜ whileå¾ªç¯è¯­å¥ä¼šå¯¹ç´§è·Ÿåœ¨whileå‘½ä»¤åçš„æ¡ä»¶è¡¨è¾¾å¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¯¥æ¡ä»¶è¡¨è¾¾å¼æˆç«‹ï¼Œåˆ™æ‰§è¡Œwhileå¾ªç¯ä½“é‡Œçš„å‘½ä»¤ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œåˆ°doneæ—¶å°±ä¼šé‡æ–°åˆ¤æ–­whileæ¡ä»¶è¡¨è¾¾å¼æ˜¯å¦æˆç«‹ï¼Œç›´åˆ°æ¡ä»¶è¡¨è¾¾å¼ä¸æˆç«‹æ—¶æ‰ä¼šè·³å‡ºwhileå¾ªç¯ä½“ï¼Œå¦‚æœä¸€å¼€å§‹æ¡ä»¶è¡¨è¾¾å¼å°±ä¸æˆç«‹ï¼Œé‚£ä¹ˆç¨‹åºå°±ä¸ä¼šè¿›å…¥å¾ªç¯ä½“ä¸­æ‰§è¡Œå‘½ä»¤äº† ç¤ºä¾‹1 while trueè¡¨ç¤ºæ¡ä»¶æ°¸è¿œä¸ºçœŸï¼Œå› æ­¤ä¼šä¸€ç›´æ‰§è¡Œ #!/bin/bash while true do uptime sleep 2 done æ‰§è¡Œç»“æœå¦‚ä¸‹ 22:15:04 up 11:00, 2 users, load average: 0.00, 0.01, 0.05 22:15:06 up 11:00, 2 users, load average: 0.00, 0.01, 0.05 22:15:08 up 11:00, 2 users, load average: 0.00, 0.01, 0.05 ã€‚ã€‚ã€‚ ctrl+cåœæ­¢ ç¤ºä¾‹2 whileå¾ªç¯ç«–å‘æ‰“å°54321 #!/bin/bash i=5 while ((i>0)) do echo \"$i\" ((i--)) done äºŒã€until è¯­æ³• until æ¡ä»¶è¡¨è¾¾å¼ do å‘½ä»¤ done å½“æ¡ä»¶è¡¨è¾¾å¼ä¸æˆç«‹æ—¶ï¼Œè¿›å…¥å¾ªç¯æ‰§è¡Œå‘½ä»¤ï¼Œæ¡ä»¶è¡¨è¾¾å¼æˆç«‹æ—¶ï¼Œç»ˆæ­¢å¾ªç¯ï¼Œuntilåº”ç”¨è¾ƒå°‘ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/7.3å¾ªç¯æ§åˆ¶åŠçŠ¶æ€è¿”å›å€¼.html":{"url":"linux/shell/7.3å¾ªç¯æ§åˆ¶åŠçŠ¶æ€è¿”å›å€¼.html","title":"å¾ªç¯æ§åˆ¶åŠçŠ¶æ€è¿”å›å€¼","keywords":"","body":"å¾ªç¯æ§åˆ¶åŠçŠ¶æ€è¿”å›å€¼ ä¸€ã€breakã€continueã€exitã€returnçš„åŒºåˆ«å’Œå¯¹æ¯” breakã€continueåœ¨æ¡ä»¶è¯­å¥åŠå¾ªç¯è¯­å¥(forã€while)ä¸­ç”¨äºæ§åˆ¶ç¨‹åºçš„èµ°å‘ exitç”¨äºç»ˆæ­¢æ‰€æœ‰è¯­å¥å¹¶é€€å‡ºå½“å‰è„šæœ¬ï¼Œé™¤æ­¤ä¹‹å¤–exitè¿˜å¯ä»¥è¿”å›ä¸Šä¸€æ¬¡ç¨‹åºæˆ–å‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€å€¼ç»™å½“å‰shell returnç±»ä¼¼äºexitï¼Œåªä¸è¿‡returnä»…ç”¨äºåœ¨å‡½æ•°å†…éƒ¨è¿”å›å‡½æ•°æ‰§è¡Œçš„çŠ¶æ€å€¼ å‘½ä»¤ è¯´æ˜ break [n] è·³å‡ºæ•´ä¸ªå¾ªç¯ï¼Œnè¡¨ç¤ºè·³å‡ºå¾ªç¯çš„å±‚æ•° continue [n] è·³è¿‡æœ¬æ¬¡å¾ªç¯ï¼Œå¿½ç•¥æœ¬æ¬¡å¾ªç¯çš„å‰©ä½™ä»£ç ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œnè¡¨ç¤ºé€€åˆ°ç¬¬nå±‚ç»§ç»­å¾ªç¯ exit [n] é€€å‡ºå½“å‰shellç¨‹åºï¼Œnä¸ºä¸Šä¸€æ¬¡ç¨‹åºæ‰§è¡Œçš„çŠ¶æ€è¿”å›å€¼ï¼Œnä¹Ÿå¯ä»¥çœç•¥ï¼Œåœ¨ä¸‹ä¸€ä¸ªshellé‡Œå¯é€šè¿‡$?æ¥æ”¶exit nçš„nçš„å€¼ return [n] é€€å‡ºå½“å‰å‡½æ•°ï¼Œå¹¶ä¸”åœ¨å‡½æ•°é‡Œä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼Œä»¥åˆ¤æ–­å‡½æ•°æ‰§è¡Œæ˜¯å¦æ­£ç¡®ï¼Œåœ¨ä¸‹ä¸€ä¸ªshellé‡Œå¯é€šè¿‡$?æ¥æ”¶return nçš„nçš„å€¼ äºŒã€breakã€continueã€exitåŠŸèƒ½æ‰§è¡Œæµç¨‹å›¾ 2.1 break 2.2.1 whileå¾ªç¯ä¸­breakçš„åŠŸèƒ½æ‰§è¡Œæµç¨‹å›¾ 2.2.2 forå¾ªç¯ä¸­breakçš„åŠŸèƒ½æ‰§è¡Œæµç¨‹å›¾ 2.2 continue 2.2.1 whileå¾ªç¯ä¸­continueçš„åŠŸèƒ½æ‰§è¡Œæµç¨‹å›¾ 2.2.2 forå¾ªç¯ä¸­continueçš„åŠŸèƒ½æ‰§è¡Œæµç¨‹å›¾ 2.3 exit 2.3.1 whileå¾ªç¯ä¸­exitçš„åŠŸèƒ½æ‰§è¡Œæµç¨‹å›¾ 2.3.2 forå¾ªç¯ä¸­exitçš„åŠŸèƒ½æ‰§è¡Œæµç¨‹å›¾ ä¸‰ã€breakã€continueã€exitã€returnåŸºç¡€ç¤ºä¾‹ 3.1 ç¼–è¾‘ç»¼åˆç¤ºä¾‹è„šæœ¬ #!/bin/bash if [ $# -ne 1 ];then #å¦‚æœä¼ å…¥çš„å‚æ•°ä¸ªæ•°ä¸ä¸º1ï¼Œåˆ™æ‰“å°ä¸‹é¢çš„ä½¿ç”¨æç¤ºç»™ç”¨æˆ· echo $\"usage:$0 {break|continue|exit|return}\" exit 1 fi #å®šä¹‰æµ‹è¯•å‡½æ•° test(){ for((i=0; i 3.2 break å«ä¹‰ è·³å‡ºæ•´ä¸ªå¾ªç¯ å½“å‚æ•°æ˜¯breakæ—¶ å½“iç­‰äº3æ—¶ï¼Œç¬¦åˆæ¡ä»¶ï¼Œæ‰§è¡Œbreakï¼Œè·³å‡ºæ•´ä¸ªå¾ªç¯ï¼Œä¹‹å‰å¾ªç¯æ‰“å°çš„å˜é‡iä¾æ¬¡ä¸º0ã€1ã€2ï¼Œå¹¶æ‰§è¡Œåç»­çš„echoï¼Œå› ä¸ºæ²¡æœ‰returnæ‰€ä»¥æ‰§è¡Œecho \"I am in func.\"å’Œecho \"ok\" $ sh test.sh break 0 1 2 I am in func. ok 3.3 continue å«ä¹‰ è·³è¿‡æœ¬æ¬¡å¾ªç¯ï¼Œå¿½ç•¥æœ¬æ¬¡å¾ªç¯çš„å‰©ä½™ä»£ç ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œnè¡¨ç¤ºé€€åˆ°ç¬¬nå±‚ç»§ç»­å¾ªç¯ å½“å‚æ•°æ˜¯continueæ—¶ å½“iç­‰äº3æ—¶ï¼Œç¬¦åˆæ¡ä»¶ï¼Œæ‰§è¡Œcontinueï¼Œè·³å‡ºæœ¬æ¬¡å¾ªç¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå› æ­¤æ‰“å°çš„å˜é‡iæ²¡æœ‰3ï¼Œæ‰§è¡Œåç»­çš„echoï¼Œå› ä¸ºæ²¡æœ‰returnæ‰€ä»¥æ‰§è¡Œecho \"I am in func.\"å’Œecho \"ok\" $ sh test.sh continue 0 1 2 4 5 I am in func. ok 3.4 exit å«ä¹‰ é€€å‡ºå½“å‰shellç¨‹åºï¼Œnä¸ºä¸Šä¸€æ¬¡ç¨‹åºæ‰§è¡Œçš„çŠ¶æ€è¿”å›å€¼ï¼Œnä¹Ÿå¯ä»¥çœç•¥ï¼Œåœ¨ä¸‹ä¸€ä¸ªshellé‡Œå¯é€šè¿‡$?æ¥æ”¶exit nçš„nçš„å€¼ å½“å‚æ•°æ˜¯exitæ—¶ å½“iç­‰äº3æ—¶ï¼Œç¬¦åˆæ¡ä»¶ï¼Œæ‰§è¡Œexitï¼Œé€€å‡ºè„šæœ¬ï¼Œæ‰€æœ‰çš„echoéƒ½ä¸æ‰§è¡Œï¼Œä¹‹å‰å¾ªç¯æ‰“å°çš„å˜é‡iä¾æ¬¡ä¸º0ã€1ã€2ï¼Œé»˜è®¤exitçš„é€€å‡ºç æ˜¯0ï¼Œå¦‚æœæŒ‡å®šäº†åˆ™æ‰“å°æŒ‡å®šçš„exité€€å‡ºç  $ sh test.sh exit 0 1 2 $ echo $? 0 #æ‰‹åŠ¨è®¾ç½®exitè¿”å›å€¼æ˜¯100 $ sh test.sh \"exit 100\" 0 1 2 $ echo $? 100 3.5 return å«ä¹‰ é€€å‡ºå½“å‰å‡½æ•°ï¼Œå¹¶åœ¨å‡½æ•°é‡Œä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼Œä»¥åˆ¤æ–­å‡½æ•°æ‰§è¡Œæ˜¯å¦æ­£ç¡®ï¼Œåœ¨ä¸‹ä¸€ä¸ªshellé‡Œå¯é€šè¿‡$?æ¥æ”¶return nçš„nçš„å€¼ å½“å‚æ•°æ˜¯returnæ—¶ å½“iç­‰äº3æ—¶ï¼Œç¬¦åˆæ¡ä»¶ï¼Œæ‰§è¡Œreturnï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªè¿”å›å€¼ï¼Œæ‰§è¡Œåç»­çš„echoï¼Œå› ä¸ºæ˜¯returnï¼Œæ‰€ä»¥å‡½æ•°ä¸­çš„echoä¸æ‰§è¡Œï¼Œæœ€åæ‰§è¡Œecho \"return's exit status:$func_ret\"å’Œecho \"ok\" $ sh test.sh return 0 1 2 return's exit status:0 ok #æ‰‹åŠ¨è®¾ç½®returnè¿”å›å€¼æ˜¯100 $ sh test.sh \"return 100\" 0 1 2 return's exit status:100 ok æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/8.shellæ•°ç»„.html":{"url":"linux/shell/8.shellæ•°ç»„.html","title":"shellæ•°ç»„","keywords":"","body":"shellæ•°ç»„ ä¸€ã€shellæ•°ç»„æ¦‚å¿µ æ¦‚å¿µ shellæ•°ç»„å°±æ˜¯ä¸€ä¸ªå…ƒç´ é›†åˆï¼Œå®ƒæŠŠæœ‰é™ä¸ªå…ƒç´ (å˜é‡æˆ–å­—ç¬¦ç»„åˆ)ç”¨ä¸€ä¸ªåå­—æ¥å‘½åï¼Œç„¶åç”¨ç¼–å·å¯¹ä»–ä»¬è¿›è¡ŒåŒºåˆ†ï¼Œè¿™ä¸ªåå­—å°±ç§°ä¸ºæ•°ç»„å æ•°ç»„ä¸‹æ ‡ ç”¨äºåŒºåˆ†ä¸åŒå†…å®¹çš„ç¼–å· æ•°ç»„å…ƒç´  ç»„æˆæ•°ç»„çš„å„ä¸ªå…ƒç´ ,ä¹Ÿç§°ä¸ºå˜é‡ äºŒã€shellæ•°ç»„å®šä¹‰ 2.0 shellæ•°ç»„åˆ†ç±» æ™®é€šæ•°ç»„ï¼šæ•°ç»„ä¸‹æ ‡åªèƒ½æ˜¯æ•°å­— å…³è”æ•°ç»„ï¼šæ•°ç»„ä¸‹æ ‡å¯ä»¥æ˜¯å­—ç¬¦ï¼Œé€šè¿‡declare -A æ•°ç»„åå®šä¹‰ 2.1 æ™®é€šæ•°ç»„ æ–¹æ³•ä¸€ ç”¨å°æ‹¬å·å°†å˜é‡å€¼æ‹¬èµ·æ¥èµ‹å€¼ç»™æ•°ç»„å˜é‡ï¼Œæ¯ä¸ªå˜é‡ä¹‹é—´è¦ç”¨ç©ºæ ¼è¿›è¡Œåˆ†éš”,å¸¸ç”¨å®šä¹‰æ–¹æ³• è¯­æ³• array=(value1 value2 value3 ... ) ä½¿ç”¨ç¤ºä¾‹ $ array=(1 2 3) $ echo ${array[*]} 1 2 3 æ–¹æ³•äºŒ ç”¨å°æ‹¬å·å°†å˜é‡å€¼æ‹¬èµ·æ¥ï¼ŒåŒæ—¶é‡‡ç”¨é”®å€¼å¯¹çš„å½¢å¼å¤åˆ¶ï¼Œä¸å¸¸ç”¨ è¯­æ³• array=( [1]=one [2]=two [3]=three ) ä½¿ç”¨ç¤ºä¾‹ $ array=( [1]=one [2]=two [3]=three ) $ echo ${array[*]} one two three $ echo ${array[1]} one $ echo ${array[2]} two $ echo ${array[3]} three æ–¹æ³•ä¸‰ é€šè¿‡åˆ†åˆ«å®šä¹‰æ•°ç»„å˜é‡çš„æ–¹æ³•æ¥å®šä¹‰ï¼Œä¸å¸¸ç”¨ è¯­æ³• array[0]=a;array[1]=b;array[2]=c ä½¿ç”¨ç¤ºä¾‹ $ array[0]=a;array[1]=b;array[2]=c $ echo ${array[0]} a $ echo ${array[1]} b $ echo ${array[2]} c æ–¹æ³•å›› åŠ¨æ€çš„å®šä¹‰æ•°ç»„å˜é‡ï¼Œå¹¶ä½¿ç”¨å‘½ä»¤çš„è¾“å‡ºç»“æœä½œä¸ºæ•°ç»„çš„å†…å®¹ è¯­æ³• array=($(å‘½ä»¤)) æˆ– array=(`å‘½ä»¤`) ä½¿ç”¨ç¤ºä¾‹ $ mkdir /array $ touch /array/{1..3}.txt $ ll /array/ total 0 -rw-r--r-- 1 root root 0 Nov 12 08:37 1.txt -rw-r--r-- 1 root root 0 Nov 12 08:37 2.txt -rw-r--r-- 1 root root 0 Nov 12 08:37 3.txt $ array=($(ls /array)) $ echo ${array[*]} 1.txt 2.txt 3.txt array=(`ls /array`) $ echo ${array[*]} 1.txt 2.txt 3.txt 2.2 å…³è”æ•°ç»„ 2.2.1 å®šä¹‰å…³è”æ•°ç»„ æ™®é€šæ•°ç»„çš„ä¸‹æ ‡ä¸èƒ½ä¸ºå­—ç¬¦ $ array=([a]=hehe [b]=haha [c]=xixi) #è¾“å‡ºä¸æ­£ç¡® $ echo ${array[*]} xixi å®šä¹‰å…³è”æ•°ç»„ï¼Œéœ€è¦æå‰ç”¨declear -A æ•°ç»„åå®šä¹‰ $ declare -A array $ array=([a]=hehe [b]=haha [c]=xixi) $ echo ${array[*]} hehe haha xixi å…³è”æ•°ç»„ä½¿ç”¨ç¤ºä¾‹ #å®šä¹‰äº†ä¸€ä¸ªå…³è”æ•°ç»„array $ declare -A array #è®©ä¸‹æ ‡ä¸ºmçš„æ•°ç»„å…ƒç´ è‡ªå¢1ï¼Œæ­¤æ—¶mä¸º1 $ let array[m]++ #è®©ä¸‹æ ‡ä¸ºmçš„æ•°ç»„å…ƒç´ è‡ªå¢1ï¼Œæ­¤æ—¶mä¸º2 $ let array[m]++ #è®©ä¸‹æ ‡ä¸ºfçš„æ•°ç»„å…ƒç´ è‡ªå¢1ï¼Œæ­¤æ—¶fä¸º1 $ let array[f]++ #æ‰“å°ä¸‹æ ‡ä¸ºmå‡ºç°çš„æ¬¡æ•° $ echo ${array[m]} 2 #æ‰“å°ä¸‹æ ‡ä¸ºfå‡ºç°çš„æ¬¡æ•° $ echo ${array[f]} 1 2.2.2 å…³è”æ•°ç»„è„šæœ¬ç¤ºä¾‹ ç»Ÿè®¡/etc/passwdä¸­æ¯ä¸ªbashå‡ºç°çš„æ¬¡æ•° æ€è·¯: 1.å°†/etc/passwdçš„æœ€åä¸€åˆ—å–å‡ºæ¥,å› ä¸ºæœ€åä¸€åˆ—æ˜¯bashç±»å‹ 2.å®šä¹‰å…³è”æ•°ç»„ï¼Œå°†å–å‡ºæ¥çš„bashç±»å‹å­˜æ”¾åˆ°æ•°ç»„ä¸­ 3.forå¾ªç¯éå†æ•°ç»„ï¼Œè¾“å‡ºç›¸åŒä¸‹æ ‡çš„æ•°ç»„å…ƒç´  ç¼–è¾‘è„šæœ¬ #!/usr/bin/env bash #å®šä¹‰ä¸€ä¸ªå…³è”æ•°ç»„ declare -A array #ä½¿ç”¨whileå¾ªç¯ä»/etc/passwdæ–‡ä»¶ä¸­è¯»å–æ¯ä¸€è¡Œ while read line do #æŠŠ/etc/passwdä¸­bashç±»å‹å–å‡ºæ¥ PASSWD=`echo $line|awk -F: '{print $NF}'` #è®©æ¯ä¸€è¡Œbashè‡ªå¢1,è¿™æ ·æœ€åå°±ä¼šæŠŠç›¸åŒbashç›¸åŠ  let array[$PASSWD]++ done æ‰§è¡Œç»“æœå¦‚ä¸‹ /sbin/nologin 21 /bin/sync 1 /bin/bash 2 /sbin/shutdown 1 /sbin/halt 1 2.2.3 å…³äºå…³è”æ•°ç»„çš„é—®é¢˜ 2.2.3.1 å…³è”æ•°ç»„èµ‹å€¼æ—¶å¿…é¡»æŒ‡å®šä¸‹æ ‡ #å…ˆå®šä¹‰ä¸€ä¸ªå…³è”æ•°ç»„ $ declare -A array #åœ¨ç»™æ•°ç»„èµ‹å€¼çš„æ—¶å€™æç¤ºä¸ºå…³è”æ•°ç»„èµ‹å€¼æ—¶å¿…é¡»ä½¿ç”¨ä¸‹æ ‡ $ array=(1 2 3) bash: array: 1: must use subscript when assigning associative array bash: array: 2: must use subscript when assigning associative array bash: array: 3: must use subscript when assigning associative array #æ­¤æ—¶å¿…é¡»ç»™æ•°ç»„å…ƒç´ æŒ‡å®šä¸‹æ ‡ $ array=([1]=1 [2]=2 [3]=3) //æŸ¥çœ‹å…ƒç´ æ˜¾ç¤º $ echo ${array[*]} 1 2 3 //æŸ¥çœ‹æ•°ç»„ä¸‹æ ‡ $ echo ${!array[*]} 1 2 3 //ä¾æ®æ•°ç»„ä¸‹æ ‡æŸ¥çœ‹æ•°ç»„å…ƒç´ æ­£ç¡® $ echo ${array[1]} 1 $ echo ${array[2]} 2 $ echo ${array[3]} 3 2.2.3.2 æ™®é€šæ•°ç»„åœ¨åªæœ‰ä¸€ä¸ªå…ƒç´ çš„æƒ…å†µä¸‹ï¼Œä¸‹æ ‡å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¶…è¿‡2ä¸ªå…ƒç´ å°±ä¸å¯ä»¥ ç¬¬ä¸€ç§æƒ…å†µï¼ŒæŒ‡å®šæ™®é€šæ•°ç»„çš„ä¸‹æ ‡æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åªç»™æ•°ç»„èµ‹å€¼ä¸€ä¸ªå…ƒç´  #å®šä¹‰ä¸€ä¸ªæ™®é€šæ•°ç»„ $ array=([a]=aa) //æ•°ç»„å†…å®¹å¯ä»¥æ­£å¸¸æ˜¾ç¤º $ echo ${array[*]} aa #ä¾æ®æ•°ç»„ä¸‹æ ‡æŸ¥çœ‹æ•°ç»„å…ƒç´ æ­£ç¡® $ echo ${array[a]} aa #æ•°ç»„ä¸‹æ ‡ä¹Ÿæ˜¾ç¤ºæ­£ç¡® $ echo ${!array[*]} 0 ç¬¬äºŒç§æƒ…å†µï¼ŒæŒ‡å®šæ™®é€šæ•°ç»„çš„ä¸‹æ ‡æ˜¯å­—ç¬¦ä¸²ï¼Œå¹¶ç»™æ•°ç»„èµ‹å€¼2ä¸ªå…ƒç´  #å®šä¹‰ä¸€ä¸ªæ™®é€šæ•°ç»„ $ array=([a]=aa [b]=bb) #æ­¤æ—¶æ•°ç»„å†…å®¹æ˜¾ç¤ºä¸æ­£ç¡® $ echo ${array[*]} bb #ä¾æ®æ•°ç»„ä¸‹æ ‡æŸ¥çœ‹æ•°ç»„å…ƒç´ ä¹Ÿä¸æ­£ç¡® $ echo ${array[a]} bb $ echo ${array[b]} bb #åŒæ—¶æ•°ç»„ä¸‹æ ‡æ˜¾ç¤ºä¹Ÿä¸æ­£ç¡® $ echo ${!array[*]} 0 ä¸‰ã€shellæ•°ç»„çš„æ‰“å°åŠè¾“å‡º 3.1 æ‰“å°æ•°ç»„å…ƒç´  è¯­æ³• ${æ•°ç»„å [ä¸‹æ ‡]} æ•°ç»„ä¸‹æ ‡ä»0å¼€å§‹ ä½¿ç”¨ç¤ºä¾‹ $ array=(1 2 3) $ echo ${array[0]} 1 $ echo ${array[1]} 2 $ echo ${array[2]} 3 #ä½¿ç”¨*æˆ–@æ‰“å°æ•´ä¸ªæ•°ç»„å†…å®¹ $ echo ${array[*]} 1 2 3 #ä½¿ç”¨*æˆ–@æ‰“å°æ•´ä¸ªæ•°ç»„å†…å®¹ $ echo ${array[@]} 1 2 3 3.2 æ‰“å°æ•°ç»„å…ƒç´ ä¸ªæ•° è¯­æ³• ${#æ•°ç»„å [*]} æˆ– ${#æ•°ç»„å [@]} ä½¿ç”¨ç¤ºä¾‹ $ array=(1 2 3) $ echo ${array[*]} 1 2 3 $ echo ${array[@]} 1 2 3 $ echo ${#array[@]} 3 $ echo ${#array[*]} 3 3.3 æŸ¥çœ‹æ•°ç»„ä¸‹æ ‡ è¯­æ³• ${!æ•°ç»„å[*]} ä½¿ç”¨ç¤ºä¾‹ $ array=(1 2 3) $ echo ${!array[*]} 0 1 2 3.4 æ•°ç»„èµ‹å€¼ è¯­æ³• #å¦‚æœä¸‹æ ‡ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°ç»„å…ƒç´  æ•°ç»„å[ä¸‹æ ‡]=å€¼ ä½¿ç”¨ç¤ºä¾‹ $ array=(1 2 3) $ echo ${array[*]} 1 2 3 #å¢åŠ ä¸‹æ ‡ä¸º3çš„æ•°ç»„å…ƒç´ ï¼Œå³å¢åŠ æ•°ç»„ç¬¬4ä¸ªå…ƒç´  $ array[3]=4 $ echo ${array[*]} 1 2 3 4 $ array[0]=hehe $ echo ${array[*]} hehe 2 3 4 æŸ¥çœ‹æ•°ç»„èµ‹å€¼ å‘½ä»¤: declare -a #æŸ¥çœ‹æ™®é€šæ•°ç»„ declare -A #æŸ¥çœ‹å…³è”æ•°ç»„ ä½¿ç”¨ç¤ºä¾‹: #åˆ›å»ºä¸€ä¸ªæ™®é€šæ•°ç»„ $ array=(1 2 3 4 5) $ declare -a | tail -1 declare -a array='([0]=\"1\" [1]=\"2\" [2]=\"3\" [3]=\"4\" [4]=\"5\")' #åˆ›å»ºä¸€ä¸ªå…³è”æ•°ç»„ $ declare -A array $ array=([a]=hehe [b]=haha [c]=xixi) $ declare -A | tail -1 declare -A array='([a]=\"hehe\" [b]=\"haha\" [c]=\"xixi\" )' 3.5 æ•°ç»„åŠæ•°ç»„å…ƒç´ çš„åˆ é™¤ è¯­æ³• #åˆ é™¤ç›¸åº”ä¸‹æ ‡çš„æ•°ç»„å…ƒç´  unset æ•°ç»„[ä¸‹æ ‡] #åˆ é™¤æ•´ä¸ªæ•°ç»„ unset æ•°ç»„ ä½¿ç”¨ç¤ºä¾‹ $ array=(1 2 3) $ echo ${array[*]} 1 2 3 #åˆ é™¤ä¸‹æ ‡ä¸º0çš„æ•°ç»„å…ƒç´  $ unset array[0] $ echo ${array[*]} 2 3 #åˆ é™¤æ•´ä¸ªæ•°ç»„ $ unset array $ echo ${array[*]} #æ•°ç»„å·²ç»åˆ é™¤ï¼Œè¿”å›ä¸ºç©º æ•°ç»„å…ƒç´ åˆ é™¤æ‰©å±•ç¤ºä¾‹ $ array=(one one one one one) $ echo ${array[*]} one one one one one #ä»å·¦è¾¹å¼€å§‹åŒ¹é…æœ€çŸ­çš„æ•°ç»„å…ƒç´ å¹¶åˆ é™¤ $ echo ${array[*]#o*} ne ne ne ne ne #ä»å·¦è¾¹å¼€å§‹åŒ¹é…æœ€é•¿çš„æ•°ç»„å…ƒç´ å¹¶åˆ é™¤ $ echo ${array[*]##o*} #å…¨éƒ¨åŒ¹é…å¹¶åˆ é™¤ #ä»å³è¾¹å¼€å§‹åŒ¹é…æœ€çŸ­çš„æ•°ç»„å…ƒç´ å¹¶åˆ é™¤ $ echo ${array[*]%%e*} on on on on on #ä»å³è¾¹å¼€å§‹åŒ¹é…æœ€é•¿çš„æ•°ç»„å…ƒç´ å¹¶åˆ é™¤ $ echo ${array[*]%e*} on on on on on 3.6 æ•°ç»„å†…å®¹æˆªå– è¯­æ³• #æ•°å­—1:æ•°å­—2è¡¨ç¤ºæˆªå–ä¸‹æ ‡1åˆ°ä¸‹æ ‡2çš„å…ƒç´  $[array[*]:æ•°å­—1:æ•°å­—2] ä½¿ç”¨ç¤ºä¾‹ $ array=(1 2 3 4 5 6) $ echo ${array[*]} 1 2 3 4 5 6 #æˆªå–ä¸‹æ ‡1åˆ°ä¸‹æ ‡3çš„å…ƒç´  $ echo ${array[*]:1:3} 2 3 4 $ array=(1 2 3 4 5 6) #è¿™é‡Œç†è§£ä¸ºä»ä¸‹æ ‡0å¼€å§‹,æˆªå–3ä¸ªå…ƒç´  $ echo ${array[*]:0:3} 1 2 3 $ array=(`echo {a..z}`) $ echo ${array[*]} a b c d e f g h i j k l m n o p q r s t u v w x y z 3.7 æ•°ç»„å†…å®¹æ›¿æ¢ è¯­æ³• $[æ•°ç»„å[*]/è¦æ›¿æ¢æ‰æ•°ç»„å…ƒç´ /æ›¿æ¢ä¸ºä»€ä¹ˆ] ä½¿ç”¨ç¤ºä¾‹ $ array=(1 2 3 4 5 6) #å°†æ•°ç»„ä¸­çš„1æ›¿æ¢ä¸ºheheï¼Œä½†ä¸æ”¹å˜åŸæ•°ç»„å†…å®¹ $ echo ${array[*]/1/hehe} hehe 2 3 4 5 6 #æ•°ç»„å†…å®¹å¹¶æ²¡æœ‰æ”¹å˜ $ echo ${array[*]} 1 2 3 4 5 6 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/9.shellå‡½æ•°.html":{"url":"linux/shell/9.shellå‡½æ•°.html","title":"shellå‡½æ•°","keywords":"","body":"shellå‡½æ•° ä¸€ã€shellå‡½æ•°ç®€ä»‹ å‡½æ•°æ¦‚å¿µ ç±»ä¼¼äºaliasåˆ«å å‡½æ•°ä½œç”¨ å°†ç¨‹åºé‡Œå¤šæ¬¡è¢«è°ƒç”¨çš„ç›¸åŒä»£ç ç»„åˆèµ·æ¥(å‡½æ•°ä½“)ï¼Œå¹¶ä¸ºå…¶å–ä¸€ä¸ªåå­—ï¼Œå³å‡½æ•°åï¼Œå…¶ä»–æ‰€æœ‰æƒ³é‡å¤è°ƒç”¨è¿™éƒ¨åˆ†ä»£ç çš„åœ°æ–¹éƒ½åªéœ€è¦è°ƒç”¨è¿™ä¸ªåå­—å°±å¯ä»¥äº† å‡½æ•°ä¼˜åŠ¿ æŠŠç›¸åŒç¨‹åºæ®µå®šä¹‰ä¸ºå‡½æ•°,å¯ä»¥å‡å°‘æ•´ä¸ªç¨‹åºçš„ä»£ç é‡,æå‡å¼€å‘æ•ˆç‡ å¢åŠ ç¨‹åºçš„å¯è¯»æ€§,æ˜“è¯»æ€§,æå‡ç®¡ç†æ•ˆç‡ å¯ä»¥å®ç°ç¨‹åºåŠŸèƒ½æ¨¡å—åŒ–,ä½¿å¾—ç¨‹åºå…·å¤‡é€šç”¨æ€§ äºŒã€shellå‡½æ•°çš„å®šä¹‰ 2.1 æ ‡å‡†å†™æ³• è¯­æ³• function å‡½æ•°å () { å‘½ä»¤ } 2.2 ç®€åŒ–å†™æ³• ç®€åŒ–å†™æ³•ä¸€ å‡½æ•°å () { å‘½ä»¤ } ç®€åŒ–å†™æ³•äºŒ function å‡½æ•°å { å‘½ä»¤ } ä¸‰ã€shellå‡½æ•°å‚æ•° å‚æ•°åˆ—è¡¨ å‚æ•° è¯´æ˜ $n ä½ç½®å‚æ•°ï¼Œç¬¬nä¸ªå‚æ•°ï¼Œnæ˜¯æ•´æ•° $# è„šæœ¬å‚æ•°æ€»æ•° $* å‚æ•°åˆ—è¡¨ $@ å‚æ•°åˆ—è¡¨ å››ã€shellå‡½æ•°çš„è°ƒç”¨ ç›´æ¥åœ¨è„šæœ¬ä¸­å†™å‡½æ•°åå³å¯ #!/usr/bin/env bash #testä¸ºå‡½æ•°åç§° test (){ echo \"function test\" } #è°ƒç”¨å‡½æ•° test äº”ã€shellå‡½æ•°çš„æ‰§è¡Œ 1.æ‰§è¡Œshellå‡½æ•°æ—¶ï¼Œå‡½æ•°åå‰çš„functionå’Œå‡½æ•°åçš„å°æ‹¬å·éƒ½ä¸è¦å¸¦ 2.å‡½æ•°çš„å®šä¹‰å¿…é¡»åœ¨è¦æ‰§è¡Œçš„ç¨‹åºå‰é¢å®šä¹‰æˆ–åŠ è½½ 3.shellæ‰§è¡Œç³»ç»Ÿä¸­å„ç§ç¨‹åºçš„æ‰§è¡Œé¡ºåºä¸º: ç³»ç»Ÿåˆ«å-->å‡½æ•°-->ç³»ç»Ÿå‘½ä»¤-->å¯æ‰§è¡Œæ–‡ä»¶ 4.åœ¨shellå‡½æ•°é‡Œé¢ï¼Œreturnå‘½ä»¤çš„åŠŸèƒ½äºexitç±»ä¼¼ï¼Œreturnçš„ä½œç”¨æ˜¯é€€å‡ºå‡½æ•°ï¼Œè€Œexitæ˜¯é€€å‡ºè„šæœ¬æ–‡ä»¶ 5.returnè¯­å¥ä¼šè¿”å›ä¸€ä¸ªé€€å‡ºå€¼(å³è¿”å›å€¼)ç»™è°ƒç”¨å‡½æ•°çš„å½“å‰ç¨‹åºï¼Œè€Œexitä¼šè¿”å›ä¸€ä¸ªé€€å‡ºå€¼(å³è¿”å›å€¼)ç»™æ‰§è¡Œç¨‹åºçš„å½“å‰shell 6.å¦‚æœå‡½æ•°å­˜æ”¾åœ¨ç‹¬ç«‹çš„æ–‡ä»¶ä¸­ï¼Œè¢«è„šæœ¬åŠ è½½ä½¿ç”¨æ—¶ï¼Œéœ€è¦ä½¿ç”¨sourceæˆ–\".\"æ¥åŠ è½½ 7.åœ¨å‡½æ•°å†…ä¸€èˆ¬ä½¿ç”¨localå®šä¹‰å±€éƒ¨å˜é‡,è¿™äº›å˜é‡ç¦»å¼€å‡½æ•°åå°±ä¼šæ¶ˆå¤± å…­ã€shellå‡½æ•°ä½¿ç”¨ç¤ºä¾‹ 6.1 åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ ç¼–è¾‘è„šæœ¬ #!/usr/bin/env bash test1 (){ echo test1 } test2 (){ echo test2 } test1 test2 æ‰§è¡Œç»“æœå¦‚ä¸‹ test1 test2 6.2 åˆ†ç¦»å‡½æ•°ä½“å’Œæ‰§è¡Œå‡½æ•°çš„è„šæœ¬ç¤ºä¾‹ âš ï¸è¿™ä¸ªæ–¹æ³•åœ¨centOS7ä¸­ä¸èƒ½ç”¨ï¼ŒåŸå› æœªçŸ¥!!! å»ºç«‹å‡½æ•°åº“è„šæœ¬ï¼Œå¾€/etc/init.d/functionsæ–‡ä»¶ä¸­è¿½åŠ ä¸€ä¸ªå‡½æ•° cat >>/etc/init.d/functions ç¼–å†™è„šæœ¬ï¼Œè°ƒç”¨åˆšæ‰å¾€/etc/init.d/functionsæ–‡ä»¶ä¸­è¿½åŠ çš„å‡½æ•° cat > test-functions.sh æ‰§è¡Œç»“æœå¦‚ä¸‹ $ sh test-functions.sh test functions 6.3 å‡½æ•°ä¼ å‚ç¤ºä¾‹ 6.3.1 é€šè¿‡è„šæœ¬ä¼ å‚ ç¼–è¾‘è„šæœ¬ cat > test-functions.sh æ‰§è¡Œç»“æœå¦‚ä¸‹ $ sh test-functions.sh 123 you input 123 6.3.2 é€šè¿‡/etc/init.d/functionsæ–‡ä»¶å®ç° âš ï¸è¿™ä¸ªæ–¹æ³•åœ¨centOS7ä¸­ä¸èƒ½ç”¨ï¼ŒåŸå› æœªçŸ¥!!! å»ºç«‹å‡½æ•°åº“è„šæœ¬ï¼Œå¾€/etc/init.d/functionsæ–‡ä»¶ä¸­è¿½åŠ ä¸€ä¸ªå‡½æ•° cat >>/etc/init.d/functions ç¼–å†™è„šæœ¬ï¼Œè°ƒç”¨åˆšæ‰å¾€/etc/init.d/functionsæ–‡ä»¶ä¸­è¿½åŠ çš„å‡½æ•° cat >test-functions.sh æ‰§è¡Œç»“æœå¦‚ä¸‹ $ sh test-functions.sh 123 you input 123 ä¸ƒã€shellå‡½æ•°è„šæœ¬ä½¿ç”¨ç¤ºä¾‹ urlæ£€æµ‹è„šæœ¬ç¤ºä¾‹ cat >check_url.sh æ‰§è¡Œç»“æœå¦‚ä¸‹ $ sh check_url.sh www.baidu.com www.baidu.com is yes æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/shell/10.expectè‡ªåŠ¨åŒ–äº¤äº’å¼ç¨‹åº.html":{"url":"linux/shell/10.expectè‡ªåŠ¨åŒ–äº¤äº’å¼ç¨‹åº.html","title":"expectè‡ªåŠ¨åŒ–äº¤äº’ç¨‹åº","keywords":"","body":"expectè‡ªåŠ¨åŒ–äº¤äº’å¼ç¨‹åº ä¸€ã€expectç®€ä»‹ ä»€ä¹ˆæ˜¯expect expectæ˜¯ä¸€ä¸ªç”¨æ¥å®ç°è‡ªåŠ¨äº¤äº’åŠŸèƒ½çš„è½¯ä»¶å¥—ä»¶(expect is a software suite for automating interactive tools)ï¼Œæ˜¯åŸºäºTCLçš„è„šæœ¬ç¼–ç¨‹å·¥å…·è¯­è¨€ï¼Œæ–¹ä¾¿å­¦ä¹ ï¼ŒåŠŸèƒ½å¼ºå¤§ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨expect linuxä¸­æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æˆ–ç¨‹åºæ—¶ï¼Œç³»ç»Ÿä¼šä»¥äº¤äº’å¼çš„å½¢å¼è¦æ±‚è¾“å…¥æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœåœ¨shellè„šæœ¬ä¸­ï¼Œè¿™æ ·å°±ä¸èƒ½å®ç°è„šæœ¬å®Œå…¨è‡ªåŠ¨åŒ–æ‰§è¡Œï¼Œå› æ­¤éœ€è¦ç”¨åˆ°expectè‡ªåŠ¨åŒ–äº¤äº’ linuxäº¤äº’å¼æ“ä½œçš„åœºæ™¯ #ä¿®æ”¹ç”¨æˆ·å¯†ç  $ passwd Changing password for user root. New password: #sshè¿æ¥æœåŠ¡å™¨ $ ssh root@10.0.0.10 root@10.0.0.10's password: #ç”Ÿæˆsshå¯†é’¥ ssh-keygen Generating public/private rsa key pair. Enter file in which to save the key (/root/.ssh/id_rsa): expectè‡ªåŠ¨äº¤äº’å·¥ä½œæµç¨‹ spawnå¯åŠ¨æŒ‡å®šè¿›ç¨‹--->expectè·å–æœŸå¾…çš„å…³é”®å­—--->sendå‘æŒ‡å®šè¿›ç¨‹å‘é€æŒ‡å®šå­—ç¬¦--->è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œé€€å‡ºç»“æŸ äºŒã€expectç®€å•ä½¿ç”¨ç¤ºä¾‹ ç¤ºä¾‹ï¼šå…äº¤äº’sshè¿æ¥æœåŠ¡å™¨ å…ˆæ‰‹åŠ¨äº¤äº’sshè¿æ¥ä¸€å°æœåŠ¡å™¨ å®‰è£…expect yum -y install expect ç¼–è¾‘expectè„šæœ¬ è„šæœ¬å¼€å¤´çš„#!/usr/bin/expectæ˜¯è„šæœ¬å¼€å¤´è§£æå™¨ï¼Œå’Œshellç±»ä¼¼ï¼Œè¡¨ç¤º ç¨‹åºä½¿ç”¨expectè§£æ #æ‰©å±•åä½¿ç”¨.expä»£è¡¨æ˜¯expectè„šæœ¬ cat >test.exp ä½¿ç”¨expectå‘½ä»¤æ‰§è¡Œè„šæœ¬ï¼Œå› ä¸ºä¹‹å‰å·²ç»sshè¿æ¥è¿‡äº†ï¼Œæ‰€ä»¥è¿™é‡Œå°±èƒ½ä¸éœ€è¦è¾“å…¥yesè¿æ¥äº† $ expect test.exp spawn ssh root@10.0.0.31 uptime root@10.0.0.31's password: 10:29:02 up 44 min, 1 user, load average: 0.00, 0.01, 0.03 è¿™é‡Œä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„ä¸éœ€è¦è¾“å…¥å¯†ç çš„ç¤ºä¾‹ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰sshè¿æ¥è¿‡çš„è¯è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨è¾“å…¥ç¬¬ä¸€æ¬¡è¿æ¥éœ€è¦çš„yes ä¸‰ã€expectç¨‹åºè‡ªåŠ¨äº¤äº’çš„é‡è¦å‘½ä»¤ 3.1 spawnå‘½ä»¤ åœ¨expectè‡ªåŠ¨äº¤äº’ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œspawnå‘½ä»¤æ˜¯ä¸€ä¸ªå¼€å§‹å°±éœ€è¦ä½¿ç”¨çš„å‘½ä»¤ï¼Œé€šè¿‡spawnæ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ–ç¨‹åºï¼Œä¹‹åæ‰€æœ‰çš„expectæ“ä½œéƒ½ä¼šåœ¨è¿™ä¸ªæ‰§è¡Œè¿‡çš„å‘½ä»¤æˆ–ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œï¼ŒåŒ…æ‹¬è‡ªåŠ¨äº¤äº’åŠŸèƒ½ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰spawnå‘½ä»¤ï¼Œexpectç¨‹åºå°†ä¼šæ— æ³•å®ç°è‡ªåŠ¨äº¤äº’ è¯­æ³• spawn [é€‰é¡¹] [éœ€è¦è‡ªåŠ¨äº¤äº’çš„å‘½ä»¤æˆ–ç¨‹åº] ç¤ºä¾‹ åœ¨spawnå‘½ä»¤çš„åé¢ï¼Œç›´æ¥æŒ¤ä¸Šè¦æ‰§è¡Œçš„å‘½ä»¤æˆ–ç¨‹åº spawn ssh root@10.0.0.100 uptime ä½¿ç”¨spawnå‘½ä»¤æ˜¯expectç¨‹åºå®ç°è‡ªåŠ¨äº¤äº’å·¥ä½œæµç¨‹ä¸­çš„ç¬¬ä¸€æ­¥ï¼Œä¹Ÿæ˜¯æœ€å…³é”®çš„ä¸€æ­¥ 3.2 expectå‘½ä»¤ 3.2.1 expectå‘½ä»¤è¯´æ˜ åœ¨expectè‡ªåŠ¨äº¤äº’ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“ä½¿ç”¨spawnå‘½ä»¤æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ–è€…ç¨‹åºä¹‹åï¼Œä¼šæç¤ºæŸäº›äº¤äº’å¼ä¿¡æ¯ï¼Œexpectå‘½ä»¤çš„ä½œç”¨å°±æ˜¯è·å–spawnå‘½ä»¤æ‰§è¡Œåçš„ä¿¡æ¯ï¼ŒæŸ¥çœ‹æ˜¯å¦å’Œå…¶äº‹å…ˆè‡ªå®šçš„ç›¸åŒ¹é…ï¼Œä¸€æ—¦åŒ¹é…ä¸ŠæŒ‡å®šçš„å†…å®¹å°±æ‰§è¡Œexpectåé¢çš„åŠ¨ä½œï¼Œexpectå‘½ä»¤ä¹Ÿæœ‰ä¸€äº›é€‰é¡¹ï¼Œç›¸å¯¹ç”¨çš„å¤šçš„æ˜¯-reï¼Œè¡¨ç¤ºä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼æ¥åŒ¹é… è¯­æ³• expect è¡¨è¾¾å¼ [åŠ¨ä½œ] ç¤ºä¾‹ âš ï¸ä»¥ä¸‹å‘½ä»¤ä¸èƒ½åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼Œéœ€è¦æ”¾å…¥expectè„šæœ¬ä¸­æ‰§è¡Œ spawn ssh root@10.0.0.100 uptime expect \"*password\" (send 1\\r) 3.2.2 expectå‘½ä»¤å®è·µ 3.2.2.1 å®è·µç¤ºä¾‹1 æ‰§è¡Œsshå‘½ä»¤è¿œç¨‹è·å–æœåŠ¡å™¨è´Ÿè½½å€¼å’Œeth0ç½‘å¡ï¼Œå¹¶è‡ªåŠ¨è¾“å…¥yesåŠç”¨æˆ·åå¯†ç  ç¼–è¾‘expectè„šæœ¬ cat >test.exp è¯´æ˜ exp_sendå’Œsendç±»ä¼¼ï¼Œåé¢çš„\\r(å›è½¦)ï¼Œå’Œå‰æ–‡çš„\\n(æ¢è¡Œ)ç±»ä¼¼ expect {}ï¼Œç±»ä¼¼å¤šè¡Œexpect åŒ¹é…å¤šä¸ªå­—ç¬¦ä¸²ï¼Œéœ€è¦åœ¨æ¯æ¬¡åŒ¹é…å¹¶æ‰§è¡ŒåŠ¨ä½œåï¼ŒåŠ ä¸Šexp_continue æ‰§è¡Œè„šæœ¬ $ expect test.exp spawn ssh root@10.0.0.31 uptime && ip a s eth0 The authenticity of host '10.0.0.31 (10.0.0.31)' can't be established. ECDSA key fingerprint is SHA256:o9tdhhhgM3KPZytcz16k/Wt6gfEkDp1FCD3Q7VmLnoE. ECDSA key fingerprint is MD5:0e:a2:0c:a6:42:e4:95:b4:77:44:14:36:ba:11:2b:d8. #å¯ä»¥çœ‹åˆ°è¿™é‡Œexpectä¼šè‡ªåŠ¨è¾“å…¥yes Are you sure you want to continue connecting (yes/no)? yes Warning: Permanently added '10.0.0.31' (ECDSA) to the list of known hosts. #expectè‡ªåŠ¨è¾“å…¥å¯†ç  root@10.0.0.31's password: 10:32:18 up 8:45, 1 user, load average: 0.08, 0.03, 0.05 2: eth0: mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:1c:42:1b:e4:d7 brd ff:ff:ff:ff:ff:ff inet 10.0.0.31/24 brd 10.0.0.255 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::21c:42ff:fe1b:e4d7/64 scope link valid_lft forever preferred_lft forever 3.2.2.2 å®è·µç¤ºä¾‹2 åˆ©ç”¨expectç›¸åº”shellè„šæœ¬ä¸­çš„å¤šä¸ªreadè¯»å…¥ ç¼–è¾‘shellè„šæœ¬ cat > read.sh ç¼–è¾‘expectè„šæœ¬ âš ï¸expectè„šæœ¬ä¸­çš„exp_sendä¹Ÿå¯ä»¥æ”¹æˆsend cat > read.exp æ‰§è¡Œè„šæœ¬ $ expect read.exp spawn /bin/sh /root/read.sh please input your username:xiaoming please input your password:1 please input your email:1@qq.com your name is xiaoming,your password is 1,your email is 1@qq.com. 3.3 sendå‘½ä»¤ sendå‘½ä»¤å’Œexp_sendå‘½ä»¤ç”¨æ³•ç±»ä¼¼ï¼Œå³åœ¨expectå‘½ä»¤ååŒ¹é…æŒ‡å®šçš„å­—ç¬¦ä¸²åï¼Œå‘é€æŒ‡å®šçš„å­—ç¬¦ä¸²ç»™ç³»ç»Ÿï¼Œè¿™äº›å‘½ä»¤å¯ä»¥æ”¯æŒä¸€äº›ç‰¹æ®Šè½¬ä¹‰ç¬¦å·ï¼Œä¾‹å¦‚\\r(å›è½¦)ã€\\n(æ¢è¡Œ)ã€\\t(åˆ¶è¡¨ç¬¦) sendå‘½ä»¤ä½¿ç”¨ç¤ºä¾‹ âš ï¸expectè„šæœ¬ä¸­çš„sendä¹Ÿå¯ä»¥æ”¹æˆexp_send cat > read.exp sendå‘½ä»¤å‚æ•° -i æŒ‡å®šspawn_idï¼Œç”¨æ¥å‘ä¸åŒçš„spawn_idè¿›ç¨‹å‘é€å‘½ä»¤ï¼Œæ˜¯è¿›è¡Œå¤šç¨‹åºæ§åˆ¶çš„å‚æ•° -s sä»£è¡¨slpwlyï¼Œå³æ§åˆ¶å‘é€çš„é€Ÿåº¦ï¼Œä½¿ç”¨çš„æ—¶å€™è¦ä¸expectä¸­çš„å˜é‡send_slowç›¸å…³è” 3.4 exp_continueå‘½ä»¤ exp_continueå‘½ä»¤ä¸€èˆ¬å¤„äºexpectå‘½ä»¤ä¸­ï¼Œå±äºä¸€ç§åŠ¨ä½œå‘½ä»¤ï¼Œä¸€èˆ¬ç”¨åœ¨åŒ¹é…å¤šæ¬¡å­—ç¬¦ä¸²çš„åŠ¨ä½œä¸­ï¼Œä»å‘½ä»¤çš„æ‹¼å†™å°±å¯ä»¥çœ‹å‡ºå‘½ä»¤çš„ä½œç”¨ï¼Œå³è®©expectç¨‹åºç»§ç»­åŒ¹é…çš„æ„æ€ exp_continueå‘½ä»¤ä½¿ç”¨ç¤ºä¾‹ cat > read.exp å¦‚æœéœ€è¦ä¸€æ¬¡æ€§åŒ¹é…å¤šä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä¸åŒçš„åŒ¹é…ä¹‹é—´å°±è¦åŠ ä¸Šexp_continueï¼Œå¦åˆ™expectå°†ä¸ä¼šè‡ªåŠ¨è¾“å…¥æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œæœ€åä¸€ä¸ªç»“å°¾å°±ä¸éœ€è¦åŠ ä¸Šexp_continueäº†ï¼Œå› ä¸ºåŒ¹é…å…¨éƒ¨å®Œæˆäº† 3.5 send_userå‘½ä»¤ send_userå‘½ä»¤å¯ä»¥ç”¨æ¥æ‰“å°expectè„šæœ¬ä¿¡æ¯ï¼Œç±»ä¼¼shellé‡Œçš„echoå‘½ä»¤ï¼Œå¹¶ä¸”æœ‰echo -eçš„åŠŸèƒ½ï¼Œè€Œé»˜è®¤çš„sendã€exp_sendå‘½ä»¤éƒ½æ˜¯å°†å­—ç¬¦ä¸²è¾“å‡ºåˆ°expectç¨‹åºä¸­å» send_userå‘½ä»¤ä½¿ç”¨ç¤ºä¾‹ ç¼–è¾‘expectè„šæœ¬ cat >send_user.exp æ‰§è¡Œè„šæœ¬ $ expect send_user.exp i am boy. i like play basketbal. 3.6 exitå‘½ä»¤ exitå‘½ä»¤çš„åŠŸèƒ½ç±»ä¼¼äºshellä¸­çš„exitï¼Œå³ç›´æ¥é€€å‡ºexpectè„šæœ¬ï¼Œé™¤äº†æœ€åŸºæœ¬çš„é€€å‡ºè„šæœ¬åŠŸèƒ½å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨è¿™ä¸ªå‘½ä»¤å¯¹è„šæœ¬åšä¸€äº›å…³é—­å‰çš„æ¸…ç†å’Œæç¤ºç­‰å·¥ä½œ exitå‘½ä»¤ä½¿ç”¨ç¤ºä¾‹ cat > exit.exp æ‰§è¡Œè„šæœ¬ $ expect exit.exp i am boy. i like play basketbal. goog bye. 3.7 expectå¸¸ç”¨å‘½ä»¤æ€»ç»“ expectå‘½ä»¤ ä½œç”¨ spawn spawnå‘½ä»¤æ˜¯ä¸€ä¸ªåœ¨expectè‡ªåŠ¨äº¤äº’ç¨‹åºçš„å¼€å§‹å°±éœ€è¦ä½¿ç”¨çš„å‘½ä»¤ï¼Œé€šè¿‡spawnæ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ–ç¨‹åºï¼Œä¹‹åæ‰€æœ‰çš„expectæ“ä½œéƒ½åœ¨è¿™ä¸ªæ‰§è¡Œè¿‡çš„å‘½ä»¤æˆ–ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œï¼ŒåŒ…æ‹¬è‡ªåŠ¨äº¤äº’åŠŸèƒ½ expect åœ¨expectè‡ªåŠ¨äº¤äº’ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåœ¨ä½¿ç”¨spawnå‘½ä»¤æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ–ç¨‹åºä¹‹åï¼Œä¼šæç¤ºæŸäº›äº¤äº’å¼ä¿¡æ¯ï¼Œexpectå‘½ä»¤çš„ä½œç”¨å°±æ˜¯è·å–è¿™äº›ä¿¡æ¯ï¼ŒæŸ¥çœ‹æ˜¯å¦å’Œå…¶äº‹å…ˆæŒ‡å®šçš„ä¿¡æ¯ç›¸åŒ¹é…ï¼Œä¸€æ—¦åŒ¹é…ä¸ŠæŒ‡å®šçš„å†…å®¹ï¼Œå°±æ‰§è¡Œexpectåé¢çš„åŠ¨ä½œ send expectä¸­çš„åŠ¨ä½œå‘½ä»¤ï¼Œå½“expectåŒ¹é…äº†æŒ‡å®šçš„å­—ç¬¦ä¸²åï¼Œå‘é€æŒ‡å®šçš„çš„å­—ç¬¦ä¸²ç»™ç³»ç»Ÿï¼Œè¿™äº›å‘½ä»¤å¯ä»¥æ”¯æŒä¸€äº›ç‰¹æ®Šçš„è½¬ä¹‰ç¬¦å·ï¼Œä¾‹å¦‚\\rè¡¨ç¤ºå›è½¦ã€\\nè¡¨ç¤ºæ¢è¡Œã€\\tè¡¨ç¤ºåˆ¶è¡¨ç¬¦ç­‰ï¼Œè¿˜æœ‰ä¸€ä¸ªç±»ä¼¼çš„exp_sendå‘½ä»¤ exp_continue å±äºä¸€ç§åŠ¨ä½œå‘½ä»¤ï¼Œåœ¨ä¸€ä¸ªexpectå‘½ä»¤ä¸­ï¼Œç”¨äºå¤šæ¬¡åŒ¹é…å­—ç¬¦ä¸²å¹¶æ‰§è¡Œä¸åŒçš„åŠ¨ä½œä¸­ï¼Œä»å‘½ä»¤çš„æ‹¼å†™æ ¼å¼å°±å¯ä»¥çœ‹å‡ºè¯¥å‘½ä»¤çš„ä½œç”¨ï¼Œå³è®©expectç¨‹åºç»§ç»­åŒ¹é… send_user ç”¨æ¥æ‰“å°expectè„šæœ¬ä¿¡æ¯ï¼Œç±»ä¼¼shellé‡Œçš„echoå‘½ä»¤ï¼Œå¹¶ä¸”å¸¦-e(æ”¯æŒè½¬ä¹‰)åŠŸèƒ½ exit é€€å‡ºexpectè„šæœ¬ï¼Œä»¥åŠåœ¨é€€å‡ºè„šæœ¬å‰åšä¸€äº›å…³é—­å‰çš„æ¸…ç†å’Œæç¤ºç­‰å·¥ä½œ å››ã€expectç¨‹åºå˜é‡ 4.1 æ™®é€šå˜é‡ å®šä¹‰è¯­æ³• set å˜é‡å å˜é‡å€¼ å®šä¹‰æ™®é€šå˜é‡ç¤ºä¾‹ set pwd 123 æ‰“å°å˜é‡ puts $å˜é‡å ä½¿ç”¨ç¤ºä¾‹ ç¼–è¾‘expectè„šæœ¬ cat > var.exp æ‰§è¡Œè„šæœ¬ $ expect var.exp 123 password is 123 4.2 ç‰¹æ®Šå‚æ•°å˜é‡ åœ¨expecté‡Œä¹Ÿæœ‰ä¸shellè„šæœ¬é‡Œçš„$0ã€$1ã€$#ç­‰ç±»ä¼¼çš„ç‰¹æ®Šå‚æ•°å˜é‡ï¼Œç”¨äºæ¥æ”¶åŠæ§åˆ¶expectè„šæœ¬ä¼ å‚ åœ¨expectä¸­$argvè¡¨ç¤ºå‚æ•°æ•°ç»„ï¼Œå¯ä»¥ä½¿ç”¨[lindex $argv n]æ¥æ”¶expectè„šæœ¬ä¼ é€’å‚ï¼Œnä»0å¼€å§‹ï¼Œåˆ†åˆ«è¡¨ç¤ºç¬¬ä¸€ä¸ª[lindex $argv 0]å‚æ•°ã€ç¬¬äºŒä¸ª[lindex $argv 1]å‚æ•°ã€ç¬¬ä¸‰ä¸ª[lindex $argv 2]å‚æ•°ã€‚ã€‚ã€‚ å®šä¹‰åŠè¾“å‡ºç‰¹æ®Šå‚æ•°å˜é‡ cat >special-var.exp æ‰§è¡Œè„šæœ¬ $ expect special-var.exp access.log 10.0.0.100 /tmp access.log 10.0.0.100 /tmp æ–‡ä»¶æ˜¯: access.log ä¸»æœºIPæ˜¯: 10.0.0.100 ç›®å½•æ˜¯: /tmp expectæ¥æ”¶å‚æ•°çš„æ–¹å¼å’Œbashè„šæœ¬çš„æ–¹å¼åŒºåˆ« ç±»å‹ æ¥æ”¶ä¼ å‚æ–¹å¼ bash $0...$n expect set å˜é‡å [lindex $argv 0...n] é™¤äº†åŸºæœ¬çš„ä½ç½®å‚æ•°å¤–ï¼Œexpectä¹Ÿæ”¯æŒå…¶ä»–çš„ç‰¹æ®Šå‚æ•°ï¼Œä¾‹å¦‚$argcè¡¨ç¤ºä¼ å‚çš„ä¸ªæ•°ï¼Œ$argv0è¡¨ç¤ºè„šæœ¬çš„åå­— ä½¿ç”¨ç¤ºä¾‹ ç¼–è¾‘expectè„šæœ¬ cat > special-other.exp æ‰§è¡Œè„šæœ¬ $ expect special-other.exp access.log 10.0.0.100 /tmp æ–‡ä»¶æ˜¯: access.log ä¸»æœºIPæ˜¯: 10.0.0.100 ç›®å½•æ˜¯: /tmp ä¼ å‚ä¸ªæ•°æ˜¯: 3 è„šæœ¬åæ˜¯: special-other.exp äº”ã€expectç¨‹åºä¸­çš„ifæ¡ä»¶è¯­å¥ è¯­æ³• ifå…³é”®å­—åé¢è¦æœ‰ç©ºæ ¼ï¼Œelseå…³é”®å­—å‰åéƒ½è¦æœ‰ç©ºæ ¼ï¼Œ{æ¡ä»¶è¡¨è¾¾å¼}å¤§æ‹¬å·é‡Œè¾¹é è¿‘å¤§æ‹¬å·å¤„å¯ä»¥æ²¡æœ‰ç©ºæ ¼ï¼Œå°†æŒ‡ä»¤æ‹¬èµ·æ¥çš„èµ·å§‹å¤§æ‹¬å·\"{\"å‰è¦æœ‰ç©ºæ ¼ if {æ¡ä»¶è¡¨è¾¾å¼} { å‘½ä»¤ } æˆ– if {æ¡ä»¶è¡¨è¾¾å¼} { å‘½ä»¤ } else { å‘½ä»¤ } ä½¿ç”¨ç¤ºä¾‹ ä½¿ç”¨ifè¯­å¥åˆ¤æ–­è„šæœ¬ä¼ å‚çš„ä¸ªæ•°ï¼Œå¦‚æœä¸ç¬¦åˆåˆ™ç»™äºˆæç¤º cat > if.exp æ‰§è¡Œè„šæœ¬ æœªç»™è„šæœ¬ä¼ å‚æ•° $ expect if.exp usage: expect if.exp file ip dir ç»™è„šæœ¬ä¼ å‚ $ expect if.exp access.log 10.0.0.100 tmp æ–‡ä»¶æ˜¯: access.log ä¸»æœºIPæ˜¯: 10.0.0.100 ç›®å½•æ˜¯: tmp å…­ã€expectä¸­çš„å…³é”®å­— expectä¸­çš„ç‰¹æ®Šå…³é”®å­—ç”¨äºåŒ¹é…è¿‡ç¨‹ï¼Œä»£è¡¨æŸäº›ç‰¹æ®Šçš„å«ä¹‰æˆ–çŠ¶æ€ï¼Œä¸€èˆ¬åªç”¨äºexpectå‘½ä»¤ä¸­è€Œä¸èƒ½åœ¨expectå‘½ä»¤å¤–é¢å•ç‹¬ä½¿ç”¨ 6.1 eofå…³é”®å­— eof(end-of-line)å…³é”®å­—ç”¨äºåŒ¹é…ç»“æŸç¬¦ï¼Œå³åœ¨expectè„šæœ¬ä¸­çš„æœ€åå£°æ˜ ç¤ºä¾‹ #!/usr/bin/expect spawn ssh root@10.0.0.100 uptime expect \"*password\" {send \"1\\n\"} #eofå…³é”®å­—ç”¨äºç»“æŸexpectè„šæœ¬ expect eof 6.2 timeoutå…³é”®å­— timeoutæ˜¯expectä¸­çš„ä¸€ä¸ªæ§åˆ¶æ—¶é—´çš„å…³é”®å­—å˜é‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…¨å±€æ€§çš„æ—¶é—´æ§åˆ¶å¼€å…³ï¼Œå¯ä»¥é€šè¿‡ä¸ºè¿™ä¸ªå˜é‡èµ‹å€¼æ¥è§„å®šæ•´ä¸ªexpectæ“ä½œçš„æ—¶é—´ï¼Œæ³¨æ„è¿™ä¸ªå˜é‡æ˜¯æœåŠ¡äºexpectå…¨å±€çš„ï¼Œè€Œä¸æ˜¯æŸä¸€æ¡å‘½ä»¤ï¼Œå³ä½¿å‘½ä»¤æ²¡æœ‰ä»»ä½•é”™è¯¯ï¼Œåˆ°äº†æ—¶é—´ä»ç„¶ä¼šæ¿€æ´»è¿™ä¸ªå˜é‡ï¼Œæ­¤å¤–ï¼Œåˆ°æ—¶é—´åè¿˜ä¼šæ¿€æ´»ä¸€ä¸ªå¤„ç†åŠæç¤ºä¿¡æ¯å¼€å…³ timeoutè¶…æ—¶åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹ #timeoutè¯­æ³•1 cat >timeout.exp timeout.exp æ‰§è¡Œè„šæœ¬ æ‰§è¡Œè„šæœ¬åæç¤ºéœ€è¦è¾“å…¥å¯†ç ï¼Œè¿™é‡Œç­‰å¾…5ç§’åå¦‚æœæ²¡æœ‰è¾“å…¥å¯†ç åˆ™æç¤ºè¯·æ±‚è¶…æ—¶ï¼Œå¹¶é€€å‡ºè„šæœ¬ $ expect timeout.exp spawn ssh root@10.0.0.31 uptime root@10.0.0.31's password: request timeout ä¸ƒã€expectç»¼åˆç¤ºä¾‹ æ‰¹é‡åˆ†å‘sshå¯†é’¥ç¤ºä¾‹ æœ¬åœ°ç”Ÿæˆå¯†é’¥å¯¹ ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa &>/dev/null ç¼–è¾‘expectè„šæœ¬ cat >ssh.exp åˆ†å‘å•ä¸ªä¸»æœºç¤ºä¾‹ $ expect ssh.exp ~/.ssh/id_rsa.pub 10.0.0.31 spawn ssh-copy-id -i /root/.ssh/id_rsa.pub -p 22 root@10.0.0.31 /usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: \"/root/.ssh/id_rsa.pub\" The authenticity of host '10.0.0.31 (10.0.0.31)' can't be established. ECDSA key fingerprint is SHA256:o9tdhhhgM3KPZytcz16k/Wt6gfEkDp1FCD3Q7VmLnoE. ECDSA key fingerprint is MD5:0e:a2:0c:a6:42:e4:95:b4:77:44:14:36:ba:11:2b:d8. Are you sure you want to continue connecting (yes/no)? yes /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys root@10.0.0.31's password: Number of key(s) added: 1 Now try logging into the machine, with: \"ssh -p '22' 'root@10.0.0.31'\" and check to make sure that only the key(s) you wanted were added. åˆ†å‘å¤šä¸ªä¸»æœºç¤ºä¾‹ ç¼–è¾‘shellè„šæœ¬å¾ªç¯æ‰§è¡Œexpectè„š cat > ssh.sh æ‰§è¡Œè„šæœ¬ $ sh ssh.sh spawn ssh-copy-id -i /root/.ssh/id_rsa.pub -p 22 root@10.0.0.31 /usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: \"/root/.ssh/id_rsa.pub\" The authenticity of host '10.0.0.31 (10.0.0.31)' can't be established. ECDSA key fingerprint is SHA256:o9tdhhhgM3KPZytcz16k/Wt6gfEkDp1FCD3Q7VmLnoE. ECDSA key fingerprint is MD5:0e:a2:0c:a6:42:e4:95:b4:77:44:14:36:ba:11:2b:d8. Are you sure you want to continue connecting (yes/no)? yes /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys root@10.0.0.31's password: Number of key(s) added: 1 Now try logging into the machine, with: \"ssh -p '22' 'root@10.0.0.31'\" and check to make sure that only the key(s) you wanted were added. spawn ssh-copy-id -i /root/.ssh/id_rsa.pub -p 22 root@10.0.0.52 /usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: \"/root/.ssh/id_rsa.pub\" The authenticity of host '10.0.0.52 (10.0.0.52)' can't be established. ECDSA key fingerprint is SHA256:o9tdhhhgM3KPZytcz16k/Wt6gfEkDp1FCD3Q7VmLnoE. ECDSA key fingerprint is MD5:0e:a2:0c:a6:42:e4:95:b4:77:44:14:36:ba:11:2b:d8. Are you sure you want to continue connecting (yes/no)? yes /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys root@10.0.0.52's password: Number of key(s) added: 1 Now try logging into the machine, with: \"ssh -p '22' 'root@10.0.0.52'\" and check to make sure that only the key(s) you wanted were added. æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/1.pythonåŸºç¡€ä¸€ å˜é‡ã€å¸¸é‡ã€æ³¨é‡Š.html":{"url":"python/pythonåŸºç¡€/1.pythonåŸºç¡€ä¸€ å˜é‡ã€å¸¸é‡ã€æ³¨é‡Š.html","title":"pythonåŸºç¡€ä¸€ å˜é‡ã€å¸¸é‡ã€æ³¨é‡Š","keywords":"","body":"pythonåŸºç¡€ä¸€ å˜é‡ã€å¸¸é‡ã€æ³¨é‡Š 1.å˜é‡ 1.1 å®šä¹‰ â€‹ å°†ç¨‹åºä¸­è¿è¡Œçš„ä¸­é—´å€¼ï¼Œä¸´æ—¶å­˜å‚¨èµ·æ¥ï¼Œä»¥ä¾¿å†æ¬¡ä½¿ç”¨ 1.2 å‘½åè§„èŒƒ æ•°å­—ã€å­—æ¯ã€ä¸‹åˆ’çº¿ç»„æˆ å˜é‡åè¦å…·æœ‰å¯æè¿°æ€§ ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ ç¦æ­¢ä½¿ç”¨pythonä¸­çš„å…³é”®å­— ['False', 'None', 'True', 'and', 'as', 'assert', 'break', 'class', 'continue', 'def', 'del', 'elif', 'else', 'except', 'finally', 'for', 'from', 'global', 'if', 'import', 'in', 'is', 'lambda', 'nonlocal', 'not', 'or', 'pass', 'raise', 'return', 'try', 'while', 'with', 'yield'] é©¼å³°å‘½åæ³• å•è¯é¦–å­—æ¯å¤§å†™ AisMan ä¸‹åˆ’çº¿å‘½åæ³• å•è¯ä¹‹é—´ä»¥ä¸‹åˆ’çº¿åˆ†å‰² a_is_man 2.å¸¸é‡ 2.1 å®šä¹‰ å˜é‡åå¤§å†™çš„å°±æ˜¯å¸¸é‡ 2.2 è¯´æ˜ pythonä¸­æœ¬æ²¡æœ‰å¸¸é‡ï¼Œä¸ºäº†è¿åˆåˆ«çš„è¯­è¨€ pythonä¸­çš„å¸¸é‡å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯ä¸å»ºè®®ä¿®æ”¹ 2.3 ç”¨é€” ç”¨äºé…ç½®æ–‡ä»¶ä¸­ 3.æ³¨é‡Š 3.1 å®šä¹‰ ç»™ä¸€äº›æ™¦æ¶©éš¾æ‡‚çš„ä»£ç è¿›è¡Œæ ‡æ³¨æˆ–è€…è§£é‡Š 3.2 åˆ†ç±» å•è¡Œæ³¨é‡Š ä¸€ä¸ª#å· å¤šè¡Œæ³¨é‡Š 3ä¸ªå•å¼•å·æˆ–è€…3ä¸ªåŒå¼•å·(æ¨è) 4.ç”¨æˆ·è¾“å…¥ 4.1 è¯­æ³• input(æç¤ºè¯­å¥) 4.2 è¯´æ˜ âš ï¸pythonä¸­inputè¾“å…¥çš„å†…å®¹éƒ½æ˜¯å­—ç¬¦ä¸² æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/2.pythonåŸºç¡€äºŒ æµç¨‹æ§åˆ¶è¯­å¥.html":{"url":"python/pythonåŸºç¡€/2.pythonåŸºç¡€äºŒ æµç¨‹æ§åˆ¶è¯­å¥.html","title":"pythonåŸºç¡€äºŒ æµç¨‹æ§åˆ¶è¯­å¥","keywords":"","body":"pythonåŸºç¡€äºŒ æµç¨‹æ§åˆ¶è¯­å¥ 1. ifæµç¨‹æ§åˆ¶è¯­å¥ 1.1 è¯­æ³• 1.1.1 å•åˆ†æ”¯ if æ¡ä»¶: æ‰§è¡Œå‘½ä»¤ 1.1.2 åŒåˆ†æ”¯ if æ¡ä»¶: æ‰§è¡Œå‘½ä»¤ else: æ‰§è¡Œå‘½ä»¤ 1.1.3 å¤šåˆ†æ”¯ å¤šé€‰ä¸€æˆ–é›¶ if æ¡ä»¶: æ‰§è¡Œå‘½ä»¤ elif æ¡ä»¶: æ‰§è¡Œå‘½ä»¤ elif æ¡ä»¶: æ‰§è¡Œå‘½ä»¤ ã€‚ã€‚ã€‚ å¤šé€‰ä¸€ if æ¡ä»¶: æ‰§è¡Œå‘½ä»¤ elif æ¡ä»¶: æ‰§è¡Œå‘½ä»¤ else æ¡ä»¶: æ‰§è¡Œå‘½ä»¤ 2. whileå¾ªç¯è¯­å¥ 2.1 è¯­æ³• #æ— é™å¾ªç¯ while True: å¾ªç¯ä½“ #æœ‰é™å¾ªç¯ while æ¡ä»¶: å¾ªç¯ä½“ 2.2 å…³é”®å­— break ç»ˆæ­¢å½“å‰å¾ªç¯ contiune è·³å‡ºæœ¬æ¬¡å¾ªç¯ï¼Œç»§ç»­ä¸‹æ¬¡å¾ªç¯ âš ï¸breakå’Œcontinueä¸‹æ–¹çš„ä»£ç ä¸ä¼šæ‰§è¡Œ 3. forå¾ªç¯è¯­å¥ 3.1 è¯­æ³• for å˜é‡å in æ¡ä»¶: å¾ªç¯ä½“ 3.2 forå¾ªç¯åˆ é™¤çš„å‘ #forå¾ªç¯åˆ é™¤åˆ—è¡¨ä¸­çš„å†…å®¹ï¼ŒåŒæ ·å¾ªç¯åˆ é™¤åˆ—è¡¨ä¹Ÿé€‚ç”¨äºå­—å…¸ //é”™è¯¯æ¼”ç¤º lst = [1,2,3,4,5] for i in lst: lst.remove(i) print(lst) [2, 4] //ç»“æœé”™è¯¯ï¼Œå› ä¸ºforå¾ªç¯åˆ é™¤ä¸€ä¸ªå…ƒç´ åï¼Œåè¾¹çš„å…ƒç´ ä¼šå¾€å‰è¡¥ï¼Œå½“iæ˜¯0çš„æ—¶å€™ï¼Œåˆ é™¤1ï¼Œæ­¤æ—¶2è¡¥ä¸Šï¼Œ2çš„ä¸‹æ ‡å˜ä¸ºäº†0ï¼Œä¸‹ä¸€æ¬¡forå¾ªç¯ï¼Œä¼šåˆ é™¤ä¸‹æ ‡ä¸º1çš„ï¼Œä½†æ˜¯æ­¤æ—¶åŸæœ¬ä¸‹æ ‡ä¸º1çš„å…ƒç´ 2å·²ç»è¡¥å‰äº†ï¼Œæ‰€ä»¥ä¼šåˆ é™¤3ï¼Œä¾æ¬¡ç±»æ¨ï¼Œä¼šéš”ç©ºåˆ é™¤å…ƒç´  //æ–¹æ³•1 lst = [1,2,3,4,5] for i in range(len(lst)): lst.pop(0) #åˆ—è¡¨ä¸­çš„å…ƒç´ åˆ é™¤ä¸€ä¸ªï¼Œåè¾¹çš„ä¼šç»§ç»­è¡¥ä¸Šï¼Œæ‰€ä»¥åªåˆ é™¤ç¬¬ä¸€ä¸ª print(lst) [] //æ–¹æ³•2 lst = [1,2,3,4,5] lst1 = lst.copy() #æµ…æ‹·è´æ˜¯ä¸¤ä¸ªå˜é‡å„è‡ªå ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯å€¼è¿˜æ˜¯å…±ç”¨ for i in lst1: #å› æ­¤å¾ªç¯lst1åˆ é™¤å€¼ï¼Œlstä¹Ÿåˆ é™¤ lst.remove(i) print(lst) [] 3.3 å¯è¿­ä»£å¯¹è±¡ä¸ä¸å¯è¿­ä»£å¯¹è±¡è¯´æ˜ #å¯è¿­ä»£å¯¹è±¡ str -- å­—ç¬¦ä¸² list -- åˆ—è¡¨ tuple -- å…ƒç¥– set -- é›†åˆ dict -- å­—å…¸ range -- èŒƒå›´ #ä¸å¯è¿­ä»£å¯¹è±¡ int -- æ•°å­— bool -- å¸ƒå°”å€¼ 3.4 ä»£ç ç¤ºä¾‹ #ä»£ç ç¤ºä¾‹1ï¼Œforå¾ªç¯ä¼šä¾¿åˆ©å¯è¿­ä»£å¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œç„¶åä¾æ¬¡æ‰§è¡Œprintï¼Œå› ä¸ºå¯è¿­ä»£å¯¹è±¡ä¸º4ä¸ªå­—ç¬¦ï¼Œå› æ­¤æ‰“å°4è¡Œ123 for i in \"hehe\" print (123) æ‰“å°ç»“æœ 123 123 123 123 #ä»£ç ç¤ºä¾‹2 for i in \"abced\" print (i) æ‰“å°ç»“æœ a b c d e 3.5 é¢è¯•é¢˜ âš ï¸ #forå¾ªç¯é¢è¯•é¢˜1 for i in \"abcde\": pass print (i) æ‰“å°ç»“æœ e âš ï¸forå¾ªç¯ä¸­é‡åˆ°passï¼Œåªä¼šæ‰“å°å¯è¿­ä»£å¯¹è±¡ä¸­çš„æœ€åä¸€ä¸ªå­—ç¬¦ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/3.pythonåŸºç¡€ä¸‰ å­—ç¬¦ä¸²è¯¦è§£.html":{"url":"python/pythonåŸºç¡€/3.pythonåŸºç¡€ä¸‰ å­—ç¬¦ä¸²è¯¦è§£.html","title":"pythonåŸºç¡€ä¸‰ å­—ç¬¦ä¸²è¯¦è§£","keywords":"","body":"pythonåŸºç¡€ä¸‰ å­—ç¬¦ä¸² 1. ç´¢å¼•(ä¸‹æ ‡) 1.1 å®šä¹‰ æ–¹ä¾¿æŸ¥æ‰¾å­—ç¬¦ä¸² 1.2 æ ¼å¼è¯´æ˜ å˜é‡å[ä¸‹æ ‡] 1.3 ä»£ç è¯´æ˜ name = \"abcd\" è®¡ç®—æœºä»0å¼€å§‹æ•°æ•° 0123 #ä»å·¦å‘å³ -1-2-3-4 #ä»å³å‘å·¦ #æ­£å‘å–å€¼ print (name[2]) c #åå‘å–å€¼ print (name[-3]) b 2. åˆ‡ç‰‡ 2.1 å®šä¹‰ æˆªå–ä»ä¸€ä¸ªä½ç½®åˆ°å¦ä¸€ä¸ªä½ç½® 2.2 æ ¼å¼è¯´æ˜ å˜é‡å[èµ·å§‹ä½ç½®:ç»ˆæ­¢ä½ç½®] âš ï¸é¡¾å¤´ä¸é¡¾å°¾ï¼Œå°±æ˜¯pythonä¸­çš„åˆ‡ç‰‡ä»èµ·å§‹ä½ç½®å¼€å§‹æˆªå–ï¼Œåˆ°ç»ˆæ­¢ä½ç½®ç»“æŸï¼Œä¸åŒ…å«ç»ˆæ­¢ä½ç½® 2.3 ä»£ç è¯´æ˜ name = \"hehe_haha_xixi\" #æ­£å‘æ‰“å° è¦æ‰“å°hehe print (name[0:4]) #0è¡¨ç¤ºèµ·å§‹ä½ç½®ï¼Œ4è¡¨ç¤ºç»“æŸä½ç½®ï¼Œä½†æ˜¯ä¸åŒ…å«ç»“æŸä½ç½® #åå‘ è¦æ‰“å°xixi print (name[-4:]) #é»˜è®¤åˆ°ç»“æŸä½ç½® #æ­£å‘å…¨éƒ¨æ‰“å° print (name[:]) hehe_haha_xixi #åå‘å…¨éƒ¨æ‰“å° éœ€è¦ç”¨åˆ°æ­¥é•¿ï¼ï¼ï¼ âš ï¸é»˜è®¤ä»å¤´å¼€å§‹ï¼Œåˆ°ç»“å°¾ 3. æ­¥é•¿ 3.1 å®šä¹‰ é…åˆåˆ‡ç‰‡ä½¿ç”¨ï¼Œè¡¨ç¤ºåˆ‡ç‰‡æ—¶çš„è§„åˆ™ï¼Œä¾‹å¦‚æ­¥é•¿ä¸º2ï¼Œåˆ‡å‰²å®Œç¬¬ä¸€ä¸ªä½ç½®åå¼€å§‹æˆªå–ç¬¬3ä¸ªä½ç½® 3.2 æ ¼å¼è¯´æ˜ å˜é‡å[åˆ‡ç‰‡èµ·å§‹ä½ç½®:åˆ‡ç‰‡ç»ˆæ­¢ä½ç½®:æ­¥é•¿] name[1:5:2] #nameä¸ºå˜é‡åï¼Œ1è¡¨ç¤ºä»å­—ç¬¦ä¸‹æ ‡1å¼€å§‹ï¼Œä¸‹æ ‡5ç»“æŸï¼Œæ­¥é•¿ä¸º2 3.3 ä»£ç è¯´æ˜ #ä¾‹å¦‚è¦æˆªå–ace name = \"abcde\" print (name[0::2]) ace #ä¾‹å¦‚è¦æˆªå–hgfed name = \"abcdefghi\" print (name[-2:2:-1]) hgfed âš ï¸æ­¥é•¿é»˜è®¤ä¸º1 âš ï¸æ­£å‘å–ç»“å°¾è¦åŠ 1ï¼Œåå‘å–ç»“å°¾è¦å‡1 #ä¾‹å¦‚è¦æˆªå–bcd name = \"abcde\" #æ­£å‘å–bcdï¼Œdçš„ä¸‹æ ‡ä¸º3ï¼Œæ­£å‘å–ï¼Œè¦åŠ 1ï¼Œå› æ­¤ä¸º4 name = \"abcde\" print (name[1:4]) #åå‘å–bcdå³dcbï¼Œbçš„ä¸‹æ ‡ä¸º1ï¼Œåå‘å–ï¼Œè¦å‡1ï¼Œå› æ­¤ä¸º0 name = \"abcde\" print (name[-2:0:-1]) âš ï¸âš ï¸âš ï¸ç´¢å¼•è¶…å‡ºæœ€å¤§èŒƒå›´ä¼šæŠ¥é”™ âš ï¸âš ï¸âš ï¸åˆ‡ç‰‡è¶…å‡ºæœ€å¤§èŒƒå›´ä¸ä¼šæŠ¥é”™ 4. å­—ç¬¦ä¸²çš„æ–¹æ³• upper #å…¨éƒ¨å¤§å†™ lower #å…¨éƒ¨å°å†™ startswith #ä»¥ä»€ä¹ˆå¼€å¤´ æ”¯æŒåˆ‡ç‰‡ endswith #ä»¥ä»€ä¹ˆç»“å°¾ æ”¯æŒåˆ‡ç‰‡ count #ç»Ÿè®¡ strip #å»é™¤å¤´å°¾ä¸¤ç«¯çš„ç©ºæ ¼,æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦,è¿˜å¯æŒ‡å®šå»é™¤å†…å®¹ split #åˆ†å‰², é»˜è®¤ä»¥ç©ºæ ¼,æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦è¿›è¡Œåˆ†å‰²,å¯ä»¥æŒ‡å®šåˆ†å‰²å†…å®¹, è¿”å›æ˜¯åˆ—è¡¨ replace #æ›¿æ¢ å‚æ•°1(æ—§å€¼),å‚æ•°2(æ–°å€¼),å‚æ•°3(æ¬¡æ•°) é»˜è®¤å…¨æ¢ # isç³»åˆ— str.isalnum #åˆ¤æ–­æ•°å­—,ä¸­æ–‡,å­—æ¯ str.isalpha #åˆ¤æ–­ä¸­æ–‡,å­—æ¯ str.isdigit #åˆ¤æ–­é˜¿æ‹‰ä¼¯æ•°å­— str.isdecimal #åˆ¤æ–­åè¿›åˆ¶ 4.1 upper è¯´æ˜ â€‹ å…¨éƒ¨å¤§å†™ ä»£ç ç¤ºä¾‹ name = \"abc\" print (name.upper()) ABC 4.2 lower è¯´æ˜ â€‹ å…¨éƒ¨å°å†™ ä»£ç ç¤ºä¾‹ name = \"ABC\" print (name.lower()) abc 4.3 startswith è¯´æ˜ â€‹ ä»¥ã€‚ã€‚ã€‚å¼€å¤´ï¼Œæ”¯æŒåˆ‡ç‰‡ï¼Œè¿”å›å¸ƒå°”å€¼ ä»£ç ç¤ºä¾‹ //æ— åˆ‡ç‰‡ç¤ºä¾‹ name = \"abcdefg\" print (name.startswith(\"a\")) True print (name.startswith(\"b\")) False //æœ‰åˆ‡ç‰‡ç¤ºä¾‹1 name = \"abcdefg\" print (name[1:3]) bc print (name.startswith(\"a\",1,3)) # åˆ‡ç‰‡ç»“æœä¸ºbcï¼Œä¸æ˜¯ä»¥aå¼€å¤´ï¼Œå› æ­¤ç»“æœä¸ºFalse False //æœ‰åˆ‡ç‰‡ç¤ºä¾‹2 name = \"abcdefg\" print (name[-1:3:-1]) gfe //åå‘å–å€¼æ— æ³•æ­£ç¡®åŒ¹é… print (name.startswith(\"g\",-1,3)) False //startswithæœ€å¤š3ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼šåŒ¹é…å†…å®¹ï¼Œç¬¬äºŒã€ä¸‰ä¸ªå‚æ•°ï¼šåˆ‡ç‰‡èŒƒå›´ print (name.startswith(\"g\",-1,3,-1)) Traceback (most recent call last): File \"\", line 1, in TypeError: startswith() takes at most 3 arguments (4 given) 4.4 endswith è¯´æ˜ â€‹ ä»¥ã€‚ã€‚ã€‚ç»“å°¾ï¼Œæ”¯æŒåˆ‡ç‰‡ï¼Œè¿”å›å¸ƒå°”å€¼ ä»£ç ç¤ºä¾‹ //æ— åˆ‡ç‰‡ç¤ºä¾‹ name = \"abcdefg\" print (name.endswith(\"g\")) True print (name.endswith(\"f\")) False //æœ‰åˆ‡ç‰‡ç¤ºä¾‹1 name = \"abcdefg\" print (name[1:3]) bc print (name.endswith(\"a\",1,3)) # åˆ‡ç‰‡ç»“æœä¸ºbc,ä¸æ˜¯ä»¥aç»“å°¾ï¼Œå› æ­¤ç»“æœä¸ºFalse False print (name.endswith(\"c\",1,3)) # åˆ‡ç‰‡ç»“æœä¸ºbc,ä»¥cç»“å°¾,å› æ­¤ç»“æœä¸ºTrue True //æœ‰åˆ‡ç‰‡ç¤ºä¾‹2 name = \"abcdefg\" print (name[-1:3:-1]) gfe //åå‘å–å€¼æ— æ³•æ­£ç¡®åŒ¹é… print (name.endswith(\"e\",-1,3)) False 4.5 strip è¯´æ˜ â€‹ å»é™¤å¤´å°¾ä¸¤ç«¯çš„ç©ºæ ¼,æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦,è¿˜å¯æŒ‡å®šå»é™¤å†…å®¹ ä»£ç ç¤ºä¾‹ //å»é™¤å¤´å°¾ä¸¤ç«¯çš„ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ name = \" ab c\\td a \" print (name.strip()) ab c d a //stripåªä¼šå»é™¤å¤´å°¾ä¸¤ç«¯çš„ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ï¼Œä¸­é—´çš„ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ä¸ä¼šå»é™¤ //æŒ‡å®šå»é™¤å†…å®¹ name = \"ab c\\td a\" print (name.strip(\"a\")) b c d //æŒ‡å®šå»é™¤çš„å†…å®¹\"a\",stripåªä¼šå»é™¤å¼€å¤´å’Œç»“å°¾çš„a 4.6 split è¯´æ˜ â€‹ åˆ†å‰², é»˜è®¤ä»¥ç©ºæ ¼,æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦è¿›è¡Œåˆ†å‰²,å¯ä»¥æŒ‡å®šåˆ†å‰²å†…å®¹, è¿”å›æ˜¯åˆ—è¡¨ ä»£ç ç¤ºä¾‹ //é»˜è®¤ä»¥ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦è¿›è¡Œåˆ†å‰²ï¼Œè¿”å›åˆ—è¡¨ name = \"hehe haha\" //ä¸­é—´çš„ç©ºæ ¼ä¼šé”€æ¯ print (name.split()) ['hehe', 'haha'] //æŒ‡å®šåˆ†å‰²å†…å®¹ï¼Œè¿”å›åˆ—è¡¨ name = \"hehe:haha\" print (name.split(\":\")) ['hehe', 'haha'] print (name.split(\"h\")) ['', 'e', 'e:', 'a', 'a'] 4.7 replace è¯´æ˜ â€‹ æ›¿æ¢ å‚æ•°1(æ—§å€¼),å‚æ•°2(æ–°å€¼),å‚æ•°3(æ¬¡æ•°) é»˜è®¤å…¨æ¢ ä»£ç ç¤ºä¾‹ name = \"hehe hehe hehe\" //é»˜è®¤å…¨éƒ¨æ›¿æ¢ç¤ºä¾‹ï¼Œæ›¿æ¢heheä¸ºhaha print (name.replace(\"e\",\"a\")) haha haha haha //åªæ›¿æ¢ç¬¬ä¸€ä¸ªheheä¸ºhaha print (name.replace(\"e\",\"a\",2)) haha hehe hehe 4.8 count è¯´æ˜ â€‹ è®¡ç®—å­—ç¬¦å‡ºç°æ¬¡æ•° ä»£ç ç¤ºä¾‹ //ç»Ÿè®¡å˜é‡nameä¸­aå‡ºç°çš„æ¬¡æ•° name = \"abcdeabcde\" print (name.count(\"a\")) 2 4.9 str.isalnum è¯´æ˜ â€‹ åˆ¤æ–­æ˜¯å¦åªåŒ…å«æ•°å­—,ä¸­æ–‡,å­—æ¯ï¼Œè¿”å›å¸ƒå°”å€¼ ä»£ç ç¤ºä¾‹ //åªåŒ…å«æ•°å­—ã€ä¸­æ–‡ã€å­—æ¯ï¼Œè¿”å›ç»“æœTrue name = \"123å‘µå‘µhaha\" print (name.isalnum()) True //åŒ…å«æ•°å­—ã€ä¸­æ–‡ã€å­—æ¯ï¼ŒåŒæ—¶åŒ…å«ç‰¹æ®Šç¬¦å·*ï¼Œè¿”å›ç»“æœFalse name = \"123å‘µå‘µhaha*\" print (name.isalnum()) False 4.10 str.isalpha è¯´æ˜ â€‹ åˆ¤æ–­ä¸­æ–‡,å­—æ¯,è¿”å›å¸ƒå°”å€¼ ä»£ç ç¤ºä¾‹ //åªåŒ…å«ä¸­æ–‡ã€å­—æ¯ï¼Œè¿”å›ç»“æœä¸ºTrue name = \"å‘µå‘µhehe\" print (name.isalpha()) True //åŒ…å«ä¸­æ–‡ã€å­—æ¯ï¼ŒåŒæ—¶åŒ…å«æ•°å­—ï¼Œè¿”å›ç»“æœä¸ºFalse name = \"å‘µå‘µhehe123\" print (name.isalpha()) False 4.11 str.isdigit è¯´æ˜ â€‹ åˆ¤æ–­é˜¿æ‹‰ä¼¯æ•°å­—,è¿”å›å¸ƒå°”å€¼ ä»£ç ç¤ºä¾‹ //isdigitæœ‰bugï¼Œåœ†åœˆ5ä¹Ÿç®—ä½œæ˜¯é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œå› æ­¤ç”¨isdecimalåšåˆ¤æ–­æ›´å¥½ name = \"1234â‘¤\" print (name.isdigit()) True name = \"12345\" print (name.isdigit()) True //èµ‹å€¼æ–¹å¼é”™è¯¯ name = 12345 print (name.isdigit()) Traceback (most recent call last): File \"\", line 1, in AttributeError: 'int' object has no attribute 'isdigit' 4.12 str.isdecimal è¯´æ˜ â€‹ åˆ¤æ–­åè¿›åˆ¶ï¼Œè¿”å›å¸ƒå°”å€¼ ä»£ç ç¤ºä¾‹ //åˆ¤æ–­åè¿›åˆ¶æ•°å­— name = \"10\" print (name.isdecimal()) True //ç”¨isdecimalåˆ¤æ–­åœ†åœˆæ•°å­—æ›´å‡†ç¡® name = \"1234â‘¤\" print (name.isdecimal()) False æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/4.pythonåŸºç¡€å›› æ ¼å¼åŒ–.html":{"url":"python/pythonåŸºç¡€/4.pythonåŸºç¡€å›› æ ¼å¼åŒ–.html","title":"pythonåŸºç¡€å›› æ ¼å¼åŒ–","keywords":"","body":"pythonåŸºç¡€å›› æ ¼å¼åŒ– 1. %å ä½å¡«ä½è¡¨ç¤ºæ³• 1.1 è¯´æ˜ å ä½ %s å­—ç¬¦ä¸²å ä½ âš ï¸å­—ç¬¦ä¸²å¯ä»¥å¡«å……æ•°å­—ï¼Œåè¾¹çš„è¡¥ä½å¯ä»¥æ˜¯æ•´å‹ %d ä¸%iç›¸åŒï¼Œæ•´å‹å ä½ âš ï¸åè¾¹çš„è¡¥ä½å¿…é¡»ä¸ºæ•´å‹ è¡¥ä½ å˜é‡å%(æ‰“å°çš„å†…å®¹) âš ï¸è¡¥ä½å¿…é¡»ä¸å ä½ä½æ•°ç›¸åŒ 1.2 ä»£ç ç¤ºä¾‹ #msgä¸­çš„å˜é‡ååçš„%sè¡¨ç¤ºç»™å¯¹åº”çš„å˜é‡å ä½ï¼Œè€Œåœ¨æœ€åçš„printä¸­%è¡¨ç¤ºå–ä½ name = input(\"name\") age = input(\"age\") sex = input(\"sex\") hobby = input(\"hobby\") msg = \"\"\" ------info------ name:%s age:%s sex:%s hobby:%s -------end------ \"\"\" print(msg%(name,int(age),sex,hobby)) 2. f+{}è¡¨ç¤ºæ³• python3.6ä»¥ä¸Šæ”¯æŒ 2.1 è¯´æ˜ ç”¨fè¡¨ç¤ºæ ¼å¼åŒ– msg =f\"myname is {input('name')}\" 2.2 ä»£ç ç¤ºä¾‹ msg = f\"my name is {input('è¯·è¾“å…¥å§“åï¼š')} I'm {input('è¯·è¾“å…¥å¹´é¾„: ')} years old\" print (msg) 3. æ¡ä»¶æ ¼å¼åŒ– 3.1 æŒ‰ç…§ä½ç½® s = \"a{}b\" s1 = s.format(\"ä½ å¥½\") print (s1) aä½ å¥½b 3.2 æŒ‰ç…§ç´¢å¼• s = \"a{1}b\" s1 = s.format(\"ä½ å¥½\",\"å‘µå‘µ\") print (s1) aå‘µå‘µb 3.3 æŒ‰ç…§å…³é”®å­— s = \"a{A}b\" s = s.format(A=\"ä½ å¥½\") print (s) aä½ å¥½b 4.å…¶ä»–æ ¼å¼åŒ– 4.1 æ ¼å¼åŒ–å‡½æ•°ä½¿ç”¨ç¤ºä¾‹ def func(a,b): return a + b msg = f\"è¿è¡Œç»“æœ:{func(1,2)}\" print(msg) è¿è¡Œç»“æœ:3 4.2 æ ¼å¼åŒ–åˆ—è¡¨ã€å­—å…¸ä½¿ç”¨ç¤ºä¾‹ #f-stringæ”¯æŒåˆ—è¡¨ lst = [1,2,3,4,5,6] msg = f\"è¿è¡Œç»“æœ:{lst[0:3]}\" print(msg) [1,2,3] #f-stringæ”¯æŒå­—å…¸ dic = {\"key\":1,\"key1\":22} msg = f\"è¿è¡Œç»“æœ:{dic['key1']}\" print(msg) è¿è¡Œç»“æœ:22 4.3 ä¸‰æœ¨è¿ç®—ç¬¦ä½¿ç”¨ç¤ºä¾‹ a = 100 b = 20 msg = f\"{a if a æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/5.pythonåŸºç¡€äº” è¿ç®—ç¬¦.html":{"url":"python/pythonåŸºç¡€/5.pythonåŸºç¡€äº” è¿ç®—ç¬¦.html","title":"pythonåŸºç¡€äº” è¿ç®—ç¬¦","keywords":"","body":"pythonåŸºç¡€äº” è¿ç®—ç¬¦ 1. æ¯”è¾ƒè¿ç®—ç¬¦ > å¤§äº = å¤§äºç­‰äº 2. èµ‹å€¼è¿ç®—ç¬¦ = ç­‰äº += åŠ ç­‰äº -= å‡ç­‰äº *= ä¹˜ç­‰äº /= é™¤ç­‰äº //= æ•´é™¤ç­‰äº **= å¹‚ç­‰äº %= æ¨¡ç­‰äº 3. é€»è¾‘è¿ç®—ç¬¦ 3.1 è¯´æ˜ ä¸ and æˆ– or é not 3.2 ä¼˜å…ˆçº§å’ŒæŸ¥æ‰¾é¡ºåº #ä¼˜å…ˆçº§ () > not > and > or #æŸ¥æ‰¾é¡ºåº ä»å·¦å¾€å³ 3.3 Trueå’ŒFalseè¿›è¡Œé€»è¾‘è¿ç®— and: ä¸€çœŸä¸€å‡,å°±æ˜¯å‡ åŒçœŸä¸ºçœŸ,åŒå‡ä¸ºå‡ or: ä¸€çœŸä¸€å‡,å°±æ˜¯çœŸ åŒçœŸä¸ºçœŸ,åŒå‡ä¸ºå‡ 3.4 é€»è¾‘è¿ç®—ç¬¦ä¸æ•°å­—è¿ç®—æ—¶çš„è§„åˆ™ é€»è¾‘è¿ç®—ç¬¦ä¸æ•°å­—è¿ç®—æ—¶çš„è§„åˆ™ # andæ•°å­—è¿›è¡Œé€»è¾‘è¿ç®—æ—¶: # æ•°å­—ä¸ä¸º 0 æ—¶å’Œä¸ä¸º False # andè¿ç®—é€‰æ‹©andåè¾¹çš„å†…å®¹ # andè¿ç®—éƒ½ä¸ºå‡æ—¶é€‰æ‹©andå‰çš„å†…å®¹ # and è¿ç®—ä¸€çœŸä¸€å‡é€‰æ‹©å‡ ç¤ºä¾‹ âš ï¸ ä»»ä½•æ—¶å€™ï¼Œ0éƒ½å¯ä»¥çœ‹ä½œæ˜¯False âš ï¸ ä»»ä½•æ—¶å€™ï¼Œé™¤0å¤–çš„å…¶ä½™æ•°å­—éƒ½å¯ä»¥çœ‹ä½œæ˜¯True print(1 and 3) ç»“æœï¼š3 åŸå› ï¼šæ•°å­—ä¸ä¸º0çš„æ—¶å€™é€‰æ‹©andåè¾¹çš„å†…å®¹ print(3 and 1) ç»“æœï¼š1 åŸå› ï¼šæ•°å­—ä¸ä¸º0çš„æ—¶å€™é€‰æ‹©andåè¾¹çš„å†…å®¹ print(0 and 8) ç»“æœï¼š0 åŸå› ï¼šandè¿ç®—ä¸€çœŸä¸€å‡é€‰æ‹©å‡ print(8 and 0) ç»“æœï¼š0 åŸå› ï¼šandè¿ç®—ä¸€çœŸä¸€å‡é€‰æ‹©å‡ print(False and 5) ç»“æœï¼šFalse åŸå› ï¼šä¸ºFalseé€‰æ‹©False print(5 and False) ç»“æœï¼šFalse åŸå› ï¼šandè¿ç®—ç¬¦ä¸€çœŸä¸€å‡é€‰æ‹©å‡ print(0 and False) ç»“æœï¼š0 åŸå› ï¼šå°†0çœ‹ä½œFalseï¼Œandè¿ç®—ç¬¦éƒ½ä¸ºå‡é€‰æ‹©andå‰è¾¹çš„å†…å®¹ print(False and 0) ç»“æœï¼šFalse åŸå› ï¼šandè¿ç®—ç¬¦éƒ½ä¸ºå‡æ—¶é€‰æ‹©andå‰çš„å†…å®¹ # or æ•°å­—è¿›è¡Œé€»è¾‘è¿ç®—æ—¶: # æ•°å­—ä¸ä¸º 0 æ—¶å’Œä¸ä¸º False # orè¿ç®—é€‰æ‹©orå‰è¾¹çš„å†…å®¹ # orè¿ç®—éƒ½ä¸ºå‡æ—¶é€‰æ‹©oråè¾¹çš„å†…å®¹ # or è¿ç®—ä¸€çœŸä¸€å‡é€‰æ‹©çœŸ ç¤ºä¾‹ print(1 or 3) ç»“æœï¼š1 åŸå› ï¼šæ•°å­—ä¸ä¸º0çš„æ—¶å€™é€‰æ‹©orå‰è¾¹çš„å†…å®¹ print(3 or 1) ç»“æœï¼š3 åŸå› ï¼šæ•°å­—ä¸ä¸º0çš„æ—¶å€™é€‰æ‹©orå‰è¾¹çš„å†…å®¹ print(0 or 8) ç»“æœï¼š8 åŸå› ï¼šorè¿ç®—ä¸€çœŸä¸€å‡é€‰æ‹©çœŸï¼Œ0ä¸ºå‡ï¼Œ8ä¸ºçœŸï¼Œé€‰æ‹©8 print(8 or 0) ç»“æœï¼š8 åŸå› ï¼šorè¿ç®—ä¸€çœŸä¸€å‡é€‰æ‹©çœŸï¼Œ0ä¸ºå‡ï¼Œ8ä¸ºçœŸï¼Œé€‰æ‹©8 print(False or 5) ç»“æœï¼š5 åŸå› ï¼šorè¿ç®—ä¸€çœŸä¸€å‡é€‰æ‹©çœŸï¼Œ0ä½å‡ï¼Œ5ä¸ºçœŸï¼Œé€‰æ‹©5 print(5 or False) ç»“æœï¼š5 åŸå› ï¼šorè¿ç®—ä¸€çœŸä¸€å‡é€‰æ‹©çœŸï¼Œ0ä½å‡ï¼Œ5ä¸ºçœŸï¼Œé€‰æ‹©5 print(0 or False) ç»“æœï¼šFalse åŸå› ï¼š0ä¸ºå‡ï¼Œorè¿ç®—éƒ½ä¸ºå‡æ—¶é€‰æ‹©oråè¾¹çš„å†…å®¹ print(False or 0) ç»“æœï¼š0 åŸå› ï¼š0ä¸ºå‡ï¼Œorè¿ç®—éƒ½ä¸ºå‡æ—¶é€‰æ‹©oråè¾¹çš„å†…å®¹ 4. æˆå‘˜è¿ç®—ç¬¦ 4.1 è¯´æ˜ in åœ¨ã€‚ã€‚ã€‚ä¸­ not in ä¸åœ¨ã€‚ã€‚ã€‚ä¸­ 4.2 ä»£ç ç¤ºä¾‹ #ä»¥ä¸‹ä»£ç ï¼Œå¦‚æœç”¨æˆ·è¾“å…¥çš„å†…å®¹åŒ…å«heheå³ä¸ºçœŸ name = \"hehe\" msg = input(\"è¯·è¾“å…¥å­—ç¬¦\") if name in msg: print(111) else: print(222) 5. ç®—æœ¯è¿ç®—ç¬¦ + åŠ  - å‡ * ä¹˜ / é™¤ // æ•´é™¤|åœ°æ¿é™¤ï¼ˆå‘ä¸‹å–æ•´ï¼‰ ä¾‹å¦‚ 5//3 = 1 ** å¹‚ % å–ä½™ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/6.pythonåŸºç¡€å…­ ç¼–ç .html":{"url":"python/pythonåŸºç¡€/6.pythonåŸºç¡€å…­ ç¼–ç .html","title":"pythonåŸºç¡€å…­ ç¼–ç ","keywords":"","body":"pythonåŸºç¡€å…­ ç¼–ç  1.ç¼–ç é›† ascii ä¸æ”¯æŒä¸­æ–‡ï¼Œæ¯ä¸€ä¸ªå­—ç¬¦å 8ä½ï¼Œ1ä¸ªå­—èŠ‚ gbk å›½æ ‡ï¼Œæ”¯æŒä¸­æ–‡ï¼Œä¸€ä¸ªå­—ç¬¦å 16ä½ï¼Œ2ä¸ªå­—èŠ‚ unicode ä¸­æ–‡ã€è‹±æ–‡éƒ½æ˜¯4ä¸ªå­—èŠ‚ utf-8 è‹±æ–‡1ä¸ªå­—èŠ‚ã€æ¬§æ´²2ä¸ªå­—èŠ‚ã€äºšæ´²3ä¸ªå­—èŠ‚ 2.äºŒæ¬¡ç¼–ç  2.1 ç¼–ç ä½œç”¨ 1.å­˜å‚¨ -- æ–‡ä»¶æ“ä½œ 2.ä¼ è¾“ -- ç½‘ç¼– 2.2 ç¼–ç  s = \"å‘µå‘µ\" s1 = s.encode(\"utf8\") print (s1) b'\\xe5\\x91\\xb5\\xe5\\x91\\xb5' 2.3 è§£ç  s2 = s1.decode(\"utf8\") print (s2) å‘µå‘µ 2.4 æ³¨æ„ç‚¹ âš ï¸ 1.python3å†…å­˜ä¸­ä½¿ç”¨çš„å°±æ˜¯unicodeï¼ˆä¸‡å›½ç ï¼‰ 2.ç¡¬ç›˜ä¸­å­˜å‚¨æ—¶çš„ç¼–ç æ–¹å¼ gbk utf-8 3.ç”¨ä»€ä¹ˆç¼–ç ï¼Œå°±ç”¨ä»€ä¹ˆè§£ç  3.å•ä½è½¬æ¢ bit = 1byte 1024byte = 1KB 1024KB = 1MB 1024MB = 1GB 1024GB = 1TB 1024TB = 1PB æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/7.1pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-æ•´å‹ã€å¸ƒå°”å€¼.html":{"url":"python/pythonåŸºç¡€/7.1pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-æ•´å‹ã€å¸ƒå°”å€¼.html","title":"æ•´å‹ã€å¸ƒå°”å€¼","keywords":"","body":"pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-æ•´å‹ã€å¸ƒå°”å€¼ 1.æ•´å‹ 1.1 å®šä¹‰ ç”¨äºè®¡ç®—å’Œæ¯”è¾ƒ 1.2 è¿›åˆ¶è½¬æ¢ 1.2.1 10è¿›åˆ¶ --> 2è¿›åˆ¶ ç®—æ³• æ•´é™¤2ï¼Œè·å–ä½™æ•°ï¼Œä»ä¸‹å¾€ä¸Šè¯»å– #ç¤ºä¾‹ 15è½¬æ¢ä¸ºäºŒè¿›åˆ¶ 15æ•´é™¤2 å•† ä½™æ•° 7 1 3 1 1 1 0 1 15è½¬æ¢ä¸ºäºŒè¿›åˆ¶ --> 1111 è½¬æ¢å…³é”®å­— bin() #åè¿›åˆ¶è½¬æ¢äºŒè¿›åˆ¶ ç¤ºä¾‹ print (bin(15)) 0b1111 1.2.2 2è¿›åˆ¶ --> 10è¿›åˆ¶ ç®—æ³• ä»å³å‘å·¦ï¼Œè®¡ç®—æœºä»0å¼€å§‹ #ç¤ºä¾‹ 1010è½¬æ¢ä¸ºåè¿›åˆ¶ 1010 =0*0**2 + 1*2**1 + 0*2**2 + 1*2**3 =0 + 2 + 0 + 8 =10 è½¬æ¢å…³é”®å­— int() #äºŒè¿›åˆ¶è½¬æ¢åè¿›åˆ¶ ç¤ºä¾‹ print (int(\"1010\"),2) 2è¡¨ç¤ºæ‹¬å·ä¸­çš„æ•°å­—æ˜¯äºŒè¿›åˆ¶ 10 1.3 æœ€å¤§ä½æ•° bit_length æ±‚åè¿›åˆ¶æœ€å¤§ä½æ•° //ç¤ºä¾‹1 a = 10 print (a.bit_length()) 4 #è¯´æ˜ 10è½¬æ¢ä¸º2è¿›åˆ¶ä¸º1010 -->4ä½ //ç¤ºä¾‹2 a = 30 print (a.bit_length()) 5 #è¯´æ˜ 30è½¬æ¢ä¸º2è¿›åˆ¶ä¸º11110 -->5ä½ 2.å¸ƒå°”å€¼ 2.1 ä½œç”¨ åˆ¤æ–­å¯¹é”™ 2.2 è¯´æ˜ åªæœ‰pythonçš„Trueå’ŒFalseçš„é¦–å­—æ¯æ˜¯å¤§å†™ï¼Œå…¶ä½™è¯­è¨€éƒ½æ˜¯å°å†™ 2.3 ä»£ç ç¤ºä¾‹ print(1>2) print(10>5) False True æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/7.2pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å­—ç¬¦ä¸².html":{"url":"python/pythonåŸºç¡€/7.2pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å­—ç¬¦ä¸².html","title":"å­—ç¬¦ä¸²","keywords":"","body":"pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å­—ç¬¦ä¸² 1.å­—ç¬¦ä¸² 1. å­—ç¬¦ä¸²çš„æ–¹æ³• upper #å…¨éƒ¨å¤§å†™ lower #å…¨éƒ¨å°å†™ startswith #ä»¥ä»€ä¹ˆå¼€å¤´ æ”¯æŒåˆ‡ç‰‡ endswith #ä»¥ä»€ä¹ˆç»“å°¾ æ”¯æŒåˆ‡ç‰‡ count #ç»Ÿè®¡ strip #å»é™¤å¤´å°¾ä¸¤ç«¯çš„ç©ºæ ¼,æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦,è¿˜å¯æŒ‡å®šå»é™¤å†…å®¹ split #åˆ†å‰², é»˜è®¤ä»¥ç©ºæ ¼,æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦è¿›è¡Œåˆ†å‰²,å¯ä»¥æŒ‡å®šåˆ†å‰²å†…å®¹, è¿”å›æ˜¯åˆ—è¡¨ replace #æ›¿æ¢ å‚æ•°1(æ—§å€¼),å‚æ•°2(æ–°å€¼),å‚æ•°3(æ¬¡æ•°) é»˜è®¤å…¨æ¢ capitalize #é¦–å­—æ¯å¤§å†™ title #æ¯ä¸ªå•è¯é¦–å­—æ¯å¤§å†™ index #æ ¹æ®å…ƒç´ æŸ¥æ‰¾ç´¢å¼• æŸ¥æ‰¾ä¸åˆ°æŠ¥é”™ find #æ ¹æ®å…ƒç´ æŸ¥æ‰¾ç´¢å¼• æŸ¥æ‰¾ä¸åˆ°è¿”å›-1 join #å°†åˆ—è¡¨è½¬æ¢ä¸ºå­—ç¬¦ä¸² split #å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ—è¡¨ center #å±…ä¸­ format #æ ¼å¼åŒ– swapcase #å¤§å°å†™è½¬æ¢ # isç³»åˆ— str.isalnum #åˆ¤æ–­æ•°å­—,ä¸­æ–‡,å­—æ¯ str.isalpha #åˆ¤æ–­ä¸­æ–‡,å­—æ¯ str.isdigit #åˆ¤æ–­é˜¿æ‹‰ä¼¯æ•°å­— str.isdecimal #åˆ¤æ–­åè¿›åˆ¶ 1.1 upper å…¨éƒ¨å¤§å†™ name = \"abc\" print (name.upper()) ABC 1.2 lower å…¨éƒ¨å°å†™ name = \"ABC\" print (name.lower()) abc 1.3 startswith ä»¥ã€‚ã€‚ã€‚å¼€å¤´ï¼Œæ”¯æŒåˆ‡ç‰‡ï¼Œè¿”å›å¸ƒå°”å€¼ //æ— åˆ‡ç‰‡ç¤ºä¾‹ name = \"abcdefg\" print (name.startswith(\"a\")) True print (name.startswith(\"b\")) False //æœ‰åˆ‡ç‰‡ç¤ºä¾‹1 name = \"abcdefg\" print (name[1:3]) bc print (name.startswith(\"a\",1,3)) # åˆ‡ç‰‡ç»“æœä¸ºbcï¼Œä¸æ˜¯ä»¥aå¼€å¤´ï¼Œå› æ­¤ç»“æœä¸ºFalse False //æœ‰åˆ‡ç‰‡ç¤ºä¾‹2 name = \"abcdefg\" print (name[-1:3:-1]) gfe //åå‘å–å€¼æ— æ³•æ­£ç¡®åŒ¹é… print (name.startswith(\"g\",-1,3)) False //startswithæœ€å¤š3ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼šåŒ¹é…å†…å®¹ï¼Œç¬¬äºŒã€ä¸‰ä¸ªå‚æ•°ï¼šåˆ‡ç‰‡èŒƒå›´ print (name.startswith(\"g\",-1,3,-1)) Traceback (most recent call last): File \"\", line 1, in TypeError: startswith() takes at most 3 arguments (1 given) 1.4 endswith ä»¥ã€‚ã€‚ã€‚ç»“å°¾ï¼Œæ”¯æŒåˆ‡ç‰‡ï¼Œè¿”å›å¸ƒå°”å€¼ //æ— åˆ‡ç‰‡ç¤ºä¾‹ name = \"abcdefg\" print (name.endswith(\"g\")) True print (name.endswith(\"f\")) False //æœ‰åˆ‡ç‰‡ç¤ºä¾‹1 name = \"abcdefg\" print (name[1:3]) bc print (name.endswith(\"a\",1,3)) # åˆ‡ç‰‡ç»“æœä¸ºbc,ä¸æ˜¯ä»¥aç»“å°¾ï¼Œå› æ­¤ç»“æœä¸ºFalse False print (name.endswith(\"c\",1,3)) # åˆ‡ç‰‡ç»“æœä¸ºbc,ä»¥cç»“å°¾,å› æ­¤ç»“æœä¸ºTrue True //æœ‰åˆ‡ç‰‡ç¤ºä¾‹2 name = \"abcdefg\" print (name[-1:3:-1]) gfe //åå‘å–å€¼æ— æ³•æ­£ç¡®åŒ¹é… print (name.endswith(\"e\",-1,3)) False 1.5 strip å»é™¤å¤´å°¾ä¸¤ç«¯çš„ç©ºæ ¼,æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦,è¿˜å¯æŒ‡å®šå»é™¤å†…å®¹ //å»é™¤å¤´å°¾ä¸¤ç«¯çš„ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ name = \" ab c\\td a \" print (name.strip()) ab c d a //stripåªä¼šå»é™¤å¤´å°¾ä¸¤ç«¯çš„ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ï¼Œä¸­é—´çš„ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ä¸ä¼šå»é™¤ //æŒ‡å®šå»é™¤å†…å®¹ name = \"ab c\\td a\" print (name.strip(\"a\")) b c d //æŒ‡å®šå»é™¤çš„å†…å®¹\"a\",stripåªä¼šå»é™¤å¼€å¤´å’Œç»“å°¾çš„a 1.6 split ä½œç”¨1:åˆ†å‰², é»˜è®¤ä»¥ç©ºæ ¼,æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦è¿›è¡Œåˆ†å‰²,å¯ä»¥æŒ‡å®šåˆ†å‰²å†…å®¹, è¿”å›æ˜¯åˆ—è¡¨ ä½œç”¨2:å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ—è¡¨ 1.åˆ†å‰² //é»˜è®¤ä»¥ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦è¿›è¡Œåˆ†å‰²ï¼Œè¿”å›åˆ—è¡¨ name = \"hehe haha\" //ä¸­é—´çš„ç©ºæ ¼ä¼šé”€æ¯ print (name.split()) ['hehe', 'haha'] //æŒ‡å®šåˆ†å‰²å†…å®¹ï¼Œè¿”å›åˆ—è¡¨ name = \"hehe:haha\" print (name.split(\":\")) ['hehe', 'haha'] print (name.split(\"h\")) ['', 'e', 'e:', 'a', 'a'] 2.å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ—è¡¨ s = \"hehe\" print (s.split()) ['hehe'] print (type(s.split())) 1.7 replace æ›¿æ¢ å‚æ•°1(æ—§å€¼),å‚æ•°2(æ–°å€¼),å‚æ•°3(æ¬¡æ•°) é»˜è®¤å…¨æ¢ name = \"hehe hehe hehe\" //é»˜è®¤å…¨éƒ¨æ›¿æ¢ç¤ºä¾‹ï¼Œæ›¿æ¢heheä¸ºhaha print (name.replace(\"e\",\"a\")) haha haha haha //åªæ›¿æ¢ç¬¬ä¸€ä¸ªheheä¸ºhaha print (name.replace(\"e\",\"a\",2)) haha hehe hehe 1.8 count è®¡ç®—å­—ç¬¦å‡ºç°æ¬¡æ•° //ç»Ÿè®¡å˜é‡nameä¸­aå‡ºç°çš„æ¬¡æ•° name = \"abcdeabcde\" print (name.count(\"a\")) 2 1.9 capitalize é¦–å­—æ¯å¤§å†™ s = \"hehe\" print (s.capitalize()) Hehe 1.10 title æ¯ä¸ªå•è¯é¦–å­—æ¯å¤§å†™ s = \"hehe,haha\" print (s.title()) Hehe,Haha 1.11 index æ ¹æ®å…ƒç´ æŸ¥æ‰¾ç´¢å¼• æŸ¥æ‰¾ä¸åˆ°æŠ¥é”™ #é€šè¿‡å…ƒç´ æŸ¥æ‰¾ç´¢å¼• s = [1,2,3,\"b\"] s = s.index(\"b\") print (s) 3 æŸ¥æ‰¾ä¸åˆ°æŠ¥é”™ s = [1,2,3,\"b\"] s = s.index(\"c\") print (s) ValueError: 'c' is not in list 1.12 find æ ¹æ®å…ƒç´ æŸ¥æ‰¾ç´¢å¼• æŸ¥æ‰¾ä¸åˆ°è¿”å›-1 #åˆ—è¡¨ä¸æ”¯æŒfind s = [1,2,3,\"b\"] s = s.find(\"c\") print (s) AttributeError: 'list' object has no attribute 'find' #æŸ¥æ‰¾ä¸åˆ°è¿”å›-1 s = \"abc\" s = s.find(\"d\") print (s) -1 1.13 join å°†åˆ—è¡¨è½¬æ¢ä¸ºå­—ç¬¦ä¸² //join() å°†åˆ—è¡¨è½¬æ¢ä¸ºå­—ç¬¦ä¸² lst = ['a','b','c'] s = \"_\".join(lst) print (s) a_b_c print (type(s)) 1.14 center å±…ä¸­ //ç¤ºä¾‹1 s = \"abc\" s = s.center(20) print (s) abc //æ€»é•¿åº¦20 //ç¤ºä¾‹2 s = \"abc\" s.center(20,\"_\") //æ€»é•¿åº¦20 å·¦å³ä¸¤è¾¹ä¸º_ s = \"abc\" s = s.center(20,\"_\") print (s) ________abc_________ 1.15 format æ ¼å¼åŒ– 1.æŒ‰ç…§ä½ç½®æ ¼å¼åŒ– s = \"a{}b\" s1 = s.format(\"ä½ å¥½\") print (s1) aä½ å¥½b 2.æŒ‰ç…§ç´¢å¼•æ ¼å¼åŒ– s = \"a{1}b\" s1 = s.format(\"ä½ å¥½\",\"å‘µå‘µ\") print (s1) aå‘µå‘µb 3.æŒ‰ç…§å…³é”®å­—æ ¼å¼åŒ– s = \"a{A}b\" s = s.format(A=\"ä½ å¥½\") print (s) aä½ å¥½b 1.16 swapcase å¤§å°å†™è½¬æ¢ s = \"abc\" print (s.swapcase()) ABC s = \"abcD\" print (s.swapcase()) ABCd isç³»åˆ— 1.17 str.isalnum åˆ¤æ–­æ˜¯å¦åªåŒ…å«æ•°å­—,ä¸­æ–‡,å­—æ¯ï¼Œè¿”å›å¸ƒå°”å€¼ //åªåŒ…å«æ•°å­—ã€ä¸­æ–‡ã€å­—æ¯ï¼Œè¿”å›ç»“æœTrue name = \"123å‘µå‘µhaha\" print (name.isalnum()) True //åŒ…å«æ•°å­—ã€ä¸­æ–‡ã€å­—æ¯ï¼ŒåŒæ—¶åŒ…å«ç‰¹æ®Šç¬¦å·*ï¼Œè¿”å›ç»“æœFalse name = \"123å‘µå‘µhaha*\" print (name.isalnum()) False 1.18 str.isalpha åˆ¤æ–­ä¸­æ–‡,å­—æ¯,è¿”å›å¸ƒå°”å€¼ //åªåŒ…å«ä¸­æ–‡ã€å­—æ¯ï¼Œè¿”å›ç»“æœä¸ºTrue name = \"å‘µå‘µhehe\" print (name.isalpha()) True //åŒ…å«ä¸­æ–‡ã€å­—æ¯ï¼ŒåŒæ—¶åŒ…å«æ•°å­—ï¼Œè¿”å›ç»“æœä¸ºFalse name = \"å‘µå‘µhehe123\" print (name.isalpha()) False 1.19 str.isdigit åˆ¤æ–­é˜¿æ‹‰ä¼¯æ•°å­—,è¿”å›å¸ƒå°”å€¼ //isdigitæœ‰bugï¼Œåœ†åœˆ5ä¹Ÿç®—ä½œæ˜¯é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œå› æ­¤ç”¨isdecimalåšåˆ¤æ–­æ›´å¥½ name = \"1231â‘¤\" print (name.isdigit()) True name = \"12315\" print (name.isdigit()) True //èµ‹å€¼æ–¹å¼é”™è¯¯ name = 12315 print (name.isdigit()) Traceback (most recent call last): File \"\", line 1, in AttributeError: 'int' object has no attribute 'isdigit' 1.20 str.isdecimal åˆ¤æ–­åè¿›åˆ¶ï¼Œè¿”å›å¸ƒå°”å€¼ //åˆ¤æ–­åè¿›åˆ¶æ•°å­— name = \"10\" print (name.isdecimal()) True //ç”¨isdecimalåˆ¤æ–­åœ†åœˆæ•°å­—æ›´å‡†ç¡® name = \"1231â‘¤\" print (name.isdecimal()) False æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/7.3pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-åˆ—è¡¨.html":{"url":"python/pythonåŸºç¡€/7.3pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-åˆ—è¡¨.html","title":"åˆ—è¡¨","keywords":"","body":"pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-åˆ—è¡¨ 1. åˆ—è¡¨ 1.1 å«ä¹‰ â€‹ pythonä¸­æ•°æ®ç»“æ„ä¹‹ä¸€ 1.2 å…³é”®å­— list 1.3 å®šä¹‰ åˆ—è¡¨å = [å…ƒç´ 1,å…ƒç´ 2,å…ƒç´ 3,...] #æ¯ä¸ªå…ƒç´ ä»¥é€—å·åˆ†éš” ä»¥é€—å·åˆ†éš”ç§°ä¸ºä¸€ä¸ªå…ƒç´  1.4 ä½œç”¨ 1.å­˜å‚¨å¤§é‡æ•°æ® 2.å­˜å‚¨ä¸åŒæ•°æ®ç±»å‹çš„æ•°æ® 1.5 ç‰¹ç‚¹ å¯å˜ã€å¯è¿­ä»£ã€æœ‰åº 1.6 åˆ—è¡¨å¢åŠ  lst.append() #è¿½åŠ åˆ—è¡¨,åªèƒ½åœ¨æœ«å°¾æ·»åŠ  //ä»£ç ç¤ºä¾‹ lst = [\"a\",\"b\"] lst.append(c) print (lst) ['a', 'b', 'c'] 1.7 åˆ—è¡¨æ’å…¥ âš ï¸âš ï¸âš ï¸ä»¥åå°½é‡å°‘ä½¿ç”¨åˆ—è¡¨æ’å…¥insertï¼Œæœ‰æ€§èƒ½æ¶ˆè€— lst.insert(ä¸‹æ ‡,æ’å…¥çš„å†…å®¹) #å‚æ•°1ï¼Œè¦æ’å…¥çš„ä½ç½®çš„ä¸‹æ ‡ï¼Œå‚æ•°2ï¼Œè¦æ’å…¥çš„å†…å®¹ //ä»£ç ç¤ºä¾‹ lst = [\"a\",\"b\"] lst.insert(1,\"c\") //1è¡¨ç¤ºè¦æ’å…¥çš„ä½ç½®ï¼Œå³ä¸‹æ ‡ï¼Œcè¡¨ç¤ºè¦æ’å…¥çš„å†…å®¹ print (lst) ['a', 'c', 'b'] 1.8 åˆ—è¡¨æ‰©å±• è¿­ä»£æ·»åŠ  âš ï¸extendåŸç†æ˜¯forå¾ªç¯è¿­ä»£æ·»åŠ  lst.extend() #extendæ˜¯è¿­ä»£æ·»åŠ ï¼Œä¾‹å¦‚æ·»åŠ \"abc\"ï¼Œä¼šæ·»åŠ \"a\",\"b\",\"c\" //ä»£ç ç¤ºä¾‹ lst = [\"a\",\"b\"] lst.extend(\"hehe\") print (lst) ['a', 'b', 'h', 'e', 'h', 'e'] //forå¾ªç¯ä»£ç ç¤ºä¾‹ lst = [\"a\",\"b\"] for i in \"hehe\": lst.append(i) print (lst) ['a', 'b', 'h', 'e', 'h', 'e'] 1.9 åˆ—è¡¨åˆ é™¤ #æ–¹å¼ä¸€ lst.remove() //ä¸€æ¬¡åªèƒ½åˆ é™¤ä¸€ä¸ª //é€šè¿‡å…ƒç´ åè¿›è¡Œåˆ é™¤ lst = [\"a\",\"b\",\"c\"] lst.remove(\"b\") ['a', 'c'] #æ–¹å¼äºŒ lst.pop() //å¼¹å‡ºï¼Œé»˜è®¤ä»åˆ—è¡¨æœ€åå¼¹å‡ºå†…å®¹ï¼Œå¹¶ä¸”æœ‰è¿”å›å€¼ï¼Œè¿”å›çš„å†…å®¹æ˜¯åˆ é™¤çš„å†…å®¹ //ä»£ç ç¤ºä¾‹,é»˜è®¤åˆ é™¤ lst = [\"a\",\"b\",\"c\"] lst.pop() 'c' print (lst) ['a', 'b'] //ä»£ç ç¤ºä¾‹ï¼Œé€šè¿‡ä¸‹æ ‡åˆ é™¤ lst = [\"a\",\"b\",\"c\"] lst.pop(0) 'a' print (lst) ['b', 'c'] #æ–¹å¼ä¸‰ del lst //æ…ç”¨ï¼Œåˆ é™¤åˆ—è¡¨å…¨éƒ¨ //ä»£ç ç¤ºä¾‹,åˆ é™¤åˆ—è¡¨å…¨éƒ¨ lst = [\"a\",\"b\",\"c\"] del lst print (lst) Traceback (most recent call last): File \"\", line 1, in NameError: name 'lst' is not defined //ä»£ç ç¤ºä¾‹ï¼Œæ ¹æ®ä¸‹æ ‡åˆ é™¤ lst = [\"a\",\"b\",\"c\"] del lst[0] print (lst) ['b', 'c'] //ä»£ç ç¤ºä¾‹ï¼Œåˆ‡ç‰‡åˆ é™¤ lst = [\"a\",\"b\",\"c\",\"d\",\"e\",\"f\"] del lst[1:3] print (lst) ['a', 'd', 'e', 'f'] #æ–¹å¼å›› clear lst //æ¸…é™¤åˆ—è¡¨ //ä»£ç ç¤ºä¾‹ lst = [\"a\",\"b\",\"c\"] lst.clear print (lst) [] 1.10 åˆ—è¡¨ä¿®æ”¹ lst[ä¸‹æ ‡] = \"ä¿®æ”¹ä¸ºã€‚ã€‚ã€‚\" #æ–¹å¼ä¸€ï¼Œä¿®æ”¹å•ä¸ªå…ƒç´  //ä»£ç ç¤ºä¾‹ lst = [\"a\",\"b\",\"c\"] lst[0] = \"hehe\" print (lst) ['hehe', 'b', 'c'] #æ–¹å¼äºŒï¼Œä¿®æ”¹å¤šä¸ªå…ƒç´  //ä»£ç ç¤ºä¾‹1ï¼Œè¶…å‡ºåˆ—è¡¨èŒƒå›´æ·»åŠ å¤šä¸ªå…ƒç´  lst = [\"a\",\"b\",\"c\"] lst[1:4] = 1,2,3 print (lst) ['a', 1, 2, 3] //ä»£ç ç¤ºä¾‹2ï¼Œè¶…å‡ºåˆ—è¡¨èŒƒå›´æ·»åŠ ä¸€ä¸ªå…ƒç´  lst = [\"a\",\"b\",\"c\"] lst[1:4] = 1, //âš ï¸è¿™é‡Œåè¾¹å¿…é¡»è¦åŠ ä¸€ä¸ªé€—å·ï¼Œå¦åˆ™ä¼šå˜æˆä¸å¯è¿­ä»£çš„æ•°å­— print (lst) ['a', 1] âš ï¸åˆ—è¡¨ä¿®æ”¹å…ƒç´ æ—¶ï¼Œä¿®æ”¹çš„å†…å®¹å¿…é¡»ä¸ºå¯è¿­ä»£çš„ lst[1:4] = 1 Traceback (most recent call last): File \"\", line 1, in TypeError: can only assign an iterable #æ–¹å¼ä¸‰ï¼Œåˆ‡ç‰‡ä¿®æ”¹å¤šä¸ªå…ƒç´  //ä»£ç ç¤ºä¾‹1,å°†aã€cã€eä¿®æ”¹ä¸ºAã€Cã€E lst = [\"a\",\"b\",\"c\",\"d\",\"e\",\"f\"] lst[0:5:2] = \"A\",\"B\",\"C\" print (lst) ['A', 'b', 'B', 'd', 'C', 'f'] //ä»£ç ç¤ºä¾‹2,ä¿®æ”¹åˆ—è¡¨ä¸­ä¸è¿ç»­çš„å…ƒç´ ï¼Œä¿®æ”¹çš„å†…å®¹å¿…é¡»ä¸€ä¸€å¯¹åº” lst = [\"a\",\"b\",\"c\",\"d\",\"e\",\"f\"] lst[0:5:2] = \"A\",\"B\" Traceback (most recent call last): File \"\", line 1, in ValueError: attempt to assign sequence of size 2 to extended slice of size 3 1.10.1åˆ—è¡¨ä¿®æ”¹æ€»ç»“ 1.ä½¿ç”¨åˆ‡ç‰‡æ—¶ï¼Œè·å–çš„å†…å®¹å°±æ˜¯åŸæ•°æ®æœ¬èº«ï¼Œå³åˆ—è¡¨åˆ‡ç‰‡åè·å–çš„æ˜¯åˆ—è¡¨ 2.åˆ‡ç‰‡è·å–çš„å†…å®¹æ˜¯è¿ç»­çš„ï¼Œä¿®æ”¹å†…å®¹æ—¶å¯å¤šå¯å°‘ 3.å¦‚æœåˆ‡ç‰‡è·å–çš„å†…å®¹ä¸æ˜¯è¿ç»­çš„ï¼Œä¿®æ”¹çš„å†…å®¹å¿…é¡»ä¸€ä¸€å¯¹åº” 1.11 åˆ—è¡¨æŸ¥çœ‹ #æ–¹æ³•ä¸€ forå¾ªç¯ lst = [\"a\",\"b\",\"c\"] for i in lst: print (i) a b c #æ–¹æ³•äºŒ ç´¢å¼•æŸ¥è¯¢ lst = [\"a\",\"b\",\"c\"] print (lst[0]) a 1.11 åˆ—è¡¨åµŒå¥— #åˆ—è¡¨åµŒå¥—å°±æ˜¯åˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯åˆ—è¡¨ //ä»£ç ç¤ºä¾‹ï¼Œè¦æ‰“å°8 lst = [1,2,3,[4,5,[6,7,8]]] lst1 = lst[3] print (lst1) [4, 5, [6, 7, 8]] lst2 = lst1[2] print (lst2) [6, 7, 8] print (lst2[2]) 8 //ä»£ç ç¤ºä¾‹ï¼Œè¦æ‰“å°8 lst = [1,2,3,[4,5,[6,7,8]]] print (lst[3][2][2]) 8 1.12 åˆ—è¡¨æ–¹æ³• 1.12.1 åˆ—è¡¨å€’åº reverse() å°†åˆ—è¡¨å€’åºæ˜¾ç¤º #æ–¹æ³•1 lst[::-1] //æ­¤æ–¹å¼ä¸ºæ–°å¼€è¾Ÿå†…å­˜ç©ºé—´ lst = [1,2,3,4,5,6] print (lst[::-1]) [6, 5, 4, 3, 2, 1] print (id(lst),id(lst[::-1])) 140193101789000 140193101800136 #æ–¹æ³•2 lst.reverse() //æ­¤æ–¹å¼ä¸ºåŸåœ°ä¿®æ”¹ lst = [1,2,3,4,5,6] lst.reverse() print (lst) [6, 5, 4, 3, 2, 1] //âš ï¸è¿™æ ·å†™ä¼šè¿”å›ç©º lst = [1,2,3,4,5,6] lst = lst.reverse() print (lst) None 1.12.2 åˆ—è¡¨æ’åº #å‡åº sort() lst = [1,3,2,7,5,6] lst.sort() print (lst) [1, 2, 3, 5, 6, 7] #é™åº sort(reverse=True) lst = [1,2,3,7,5,6] lst.sort(reverse=True) print (lst) [7, 6, 5, 3, 2, 1] 1.13 åˆ—è¡¨æ€»ç»“ 1.åˆ—è¡¨æ˜¯å¯å˜æ•°æ®ç±»å‹ï¼Œå¯è¿­ä»£æ•°æ®ç±»å‹ï¼Œåˆ—è¡¨æ˜¯æœ‰åºçš„ 2.åˆ—è¡¨çš„ä½œç”¨å­˜å‚¨å¤§é‡æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥å­˜å‚¨ä¸åŒæ•°æ®ç±»å‹ 3.åˆ—è¡¨å°±æ˜¯ä¸€ä¸ªå®¹å™¨ 1.14 åˆ—è¡¨é¢è¯•é¢˜ 1.åˆ—è¡¨æ•´åˆé¢è¯•é¢˜ lst1 = [1,2,3,[4]] lst2 = [5,6,7] lst1å’Œlst2æ•´åˆ #æ–¹æ³•1 extend lst1 = [1,2,3,[4]] lst2 = [5,6,7] lst1.extend(lst2) print (lst1) [1, 2, 3, [4], 5, 6, 7] #æ–¹æ³•2 åˆ—è¡¨ç›¸åŠ  lst1 = [1,2,3,[4]] lst2 = [5,6,7] print (lst1 + lst2) [1, 2, 3, [4], 5, 6, 7] 2.åˆ—è¡¨ç›¸ä¹˜é¢è¯•é¢˜ âš ï¸åˆ—è¡¨è¿›è¡Œä¹˜æ³•æ—¶ï¼Œå…ƒç´ éƒ½æ˜¯å…±ç”¨çš„ åŒæ ·çš„ï¼Œå…ƒç»„ä¹Ÿé€‚ç”¨ lst = [1,2,[]] lst1 = lst * 2 lst1[-1].append(8) lstã€lst1ç»“æœï¼Ÿ âš ï¸ lstä¸lst1ä¸­å…ƒç´ ç›¸åŒï¼Œå› ä¸ºåˆ—è¡¨è¿›è¡Œä¹˜æ³•æ—¶ï¼Œå…ƒç´ éƒ½æ˜¯å…±ç”¨çš„ï¼Œå› æ­¤å½“lst1æœ€åä¸€ä¸ªå…ƒç´ è¿½åŠ äº†ä¸€ä¸ª8ä¹‹åï¼Œæ‰€æœ‰çš„å…ƒç´ å˜æˆäº†1,2,[8] lst = [1,2,[]] lst1 = lst * 2 lst1[-1].append(8) print (lst) [1, 2, [8]] print (lst1) [1, 2, [8], 1, 2, [8]] 3.å®šä¹‰åˆ—è¡¨ lst = [] lst1 = list() //æ¬¡æ–¹å¼åŒæ ·é€‚ç”¨äºå…¶ä»–æ•°æ®ç±»å‹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/7.4pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å­—å…¸.html":{"url":"python/pythonåŸºç¡€/7.4pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å­—å…¸.html","title":"å­—å…¸","keywords":"","body":"pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å­—å…¸ 1.å­—å…¸ 1.1 å«ä¹‰ pythonä¸­çš„ä¸€ç§æ•°æ®ç±»å‹ å”¯ä¸€çš„ä¸€ç§{} é”®å€¼å¯¹çš„æ•°æ® 1.2 å…³é”®å­— dict 1.3 å®šä¹‰ dic = {key:value} 1.4 å“ˆå¸Œè¯´æ˜ å¯å˜æ•°æ®ç±»å‹å°±ä¸å¯å“ˆå¸Œ ä¸å¯å˜æ•°æ®ç±»å‹å°±å¯å“ˆå¸Œ 1.5 å­—å…¸è¯´æ˜ å­—å…¸çš„é”®æ˜¯ä¸å¯å˜æ•°æ®ç±»å‹ï¼Œå¯å“ˆå¸Œ å­—å…¸çš„é”®æ˜¯å”¯ä¸€çš„ï¼Œä¸å¯é‡å¤ å­—å…¸çš„å€¼å¯ä»¥æ˜¯ä»»æ„çš„ å­—å…¸æ˜¯ä¸€ä¸ªå¯å˜æ•°æ®ç±»å‹ 1.6 å­—å…¸çš„å¢ 1.6.1 æ–¹å¼ä¸€ dic[é”®] = å€¼ dic = {\"key1\":1,\"key2\":2,\"key3\":3} //å®šä¹‰ä¸€ä¸ªå­—å…¸ print (dic) {'key1': 1, 'key2': 2, 'key3': 3} dic[\"key4\"] = 4 //å¢åŠ ä¸€ä¸ªé”® print (dic) {'key1': 1, 'key2': 2, 'key3': 3, 'key4': 4} 1.6.2 æ–¹å¼äºŒ dic.setdefault(\"é”®\",å€¼) å‚æ•°1æ˜¯é”®ï¼Œå‚æ•°2æ˜¯å€¼ dic = {\"key1\":1,\"key2\":2,\"key3\":3} //å®šä¹‰ä¸€ä¸ªå­—å…¸ dic.setdefault(\"key4\",4) //å¢åŠ ä¸€ä¸ªé”® print (dic) {'key1': 1, 'key2': 2, 'key3': 3, 'key4': 4} #ç‰¹æ®Šè¯´æ˜1 ä½¿ç”¨setdefaultå¢åŠ å­—å…¸å€¼æ—¶ï¼Œå¦‚æœé”®å€¼å­˜åœ¨å°±ä¸å¢åŠ  dic = {\"key1\":1,\"key2\":2,\"key3\":3} //å®šä¹‰ä¸€ä¸ªå­—å…¸ dic.setdefault(\"key1\",5) //å‘å·²æœ‰çš„é”®key1ä¸­æ’å…¥å€¼ print (dic) {'key1': 1, 'key2': 2, 'key3': 3} //å·²å­˜åœ¨çš„é”®ä¸ä¼šæ”¹å˜ #ç‰¹æ®Šè¯´æ˜2 å¦‚æœé”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›None dic = {\"key1\":1} print (dic.setdefault(\"key5\")) None #ç‰¹æ®Šè¯´æ˜3 é”®å’Œå€¼æ·»åŠ æˆåŠŸåè¿”å›çš„æ˜¯æ·»åŠ çš„å€¼ dic = {\"key1\":1} print (dic.setdefault(\"key5\",5)) 5 #ç‰¹æ®Šè¯´æ˜4 å¦‚æœé”®å­˜åœ¨ï¼Œè¿”å›çš„æ˜¯é”®çš„å€¼ dic = {\"key1\":1} print (dic.setdefault(\"key1\")) 1 #setdefaultå·¥ä½œæµç¨‹è¯´æ˜ 1.setdefaultåœ¨å­—å…¸ä¸­å…ˆæ ¹æ®é”®å€¼æŸ¥æ‰¾ï¼Œå¦‚æœè¿”å›çš„ç»“æœä¸ºNoneï¼Œåœ¨è¿›è¡Œç¬¬äºŒæ­¥ 2.å°†é”®å’Œå€¼æ·»åŠ åˆ°å­—å…¸ä¸­ 1.7 å­—å…¸çš„åˆ  1.7.1 clear() æ¸…ç©º dic = {\"key1\":1,\"key2\":2,\"key3\":3} dic.clear() print (dic) {} 1.7.2 pop dic = {\"key1\":1,\"key2\":2,\"key3\":3} dic.pop(\"key1\") print (dic) {'key2': 2, 'key3': 3} 1.7.3 popitem() éšæœºåˆ é™¤(å®˜æ–¹åç§°ï¼Œpy3.6ç‰ˆæœ¬åé»˜è®¤åˆ é™¤æœ€åä¸€ä¸ª) #éšæœºåˆ é™¤ï¼ˆå®˜æ–¹åç§°ï¼‰python3.6ç‰ˆæœ¬åé»˜è®¤åˆ é™¤æœ€åä¸€ä¸ª dic = {\"key1\":1,\"key2\":2,\"key3\":3} dic.popitem() print (dic) {'key1': 1, 'key2': 2} 1.7.4 del åˆ é™¤å­—å…¸ #ç›´æ¥åˆ é™¤å­—å…¸ dic = {\"key1\":1,\"key2\":2,\"key3\":3} del dic sprint (dic) Traceback (most recent call last): File \"\", line 1, in NameError: name 'dic' is not defined #æ ¹æ®é”®åˆ é™¤,delåˆ é™¤ï¼Œé”®åªèƒ½æœ‰ä¸€ä¸ª dic = {\"key1\":1,\"key2\":2,\"key3\":3} del dic[\"key1\"] print (dic) {'key2': 2, 'key3': 3} 1.8 å­—å…¸çš„æ”¹ 1.8.1 dic[\"key\"] = \"value\" dic = {\"key1\":1,\"key2\":2,\"key3\":3} #ä¿®æ”¹æ–¹å¼ æš´åŠ›å¢åŠ ï¼Œå½“é”®åœ¨å­—å…¸ä¸­å­˜åœ¨æ—¶å°±ä¿®æ”¹ï¼Œä¸å­˜åœ¨å°±æ˜¯å¢åŠ  dic[\"key1\"] = \"5\" //é”®key1å­˜åœ¨ï¼Œæ­¤æ—¶ä¸ºä¿®æ”¹ print (dic) {'key1': '5', 'key2': 2, 'key3': 3} dic[\"key6\"] = \"6\" //é”®key6ä¸å­˜åœ¨ï¼Œæ­¤æ—¶ä¸ºå¢åŠ  print (dic) {'key1': 1, 'key2': 2, 'key3': 3, 'key6': '6'} 1.8.2 update dic = {\"key1\":1,\"key2\":2,\"key3\":3} dic.update({\"key1\":\"hehe\"}) //ä¿®æ”¹å•ä¸ªå€¼ print (dic) {'key1': 'hehe', 'key2': 2, 'key3': 3} dic = {\"key1\":1,\"key2\":2,\"key3\":3} dic.update({\"key1\":\"hehe\",\"key2\":\"haha\"}) //ä¿®æ”¹å¤šä¸ªå€¼ print (dic) {'key1': 'hehe', 'key2': 'haha', 'key3': 3} 1.9 å­—å…¸çš„æŸ¥ #æŸ¥æ‰¾æ–¹å¼1 æœ‰é”®è¿”å›å€¼ï¼Œæ²¡æœ‰é”®æŠ¥é”™ dic = {\"key1\":1,\"key2\":2,\"key3\":3} print (dic[\"key1\"]) //æœ‰é”®è¿”å›å€¼ 1 print (dic[\"key1\"]) //æ²¡æœ‰é”®æŠ¥é”™ KeyError: 'key10' #æŸ¥æ‰¾æ–¹å¼2 dic.get(\"key\") dic = {\"key1\":1,\"key2\":2,\"key3\":3} print (dic.get(\"key1\")) //æœ‰é”®è¿”å›å€¼ 1 print (dic.get(\"key10\")) //æ²¡æœ‰é”®è¿”å›None None print (dic.get(\"key10\",\"å‘µå‘µ\")) //æ²¡æœ‰é”®è¿˜å¯ä»¥è¿”å›è‡ªå®šä¹‰å€¼ å‘µå‘µ #æŸ¥æ‰¾æ–¹å¼3 è·å–å­—å…¸æ‰€æœ‰çš„é”®ã€å€¼ã€é”®å’Œå€¼ dic = {\"key1\":1,\"key2\":2,\"key3\":3} print (dic.keys()) //è¿”å›å­—å…¸æ‰€æœ‰çš„é”®ï¼Œé«˜ä»¿åˆ—è¡¨ dict_keys(['key1', 'key2', 'key3']) for i in dic.keys(): print (i) key1 key2 key3 print (dic.values()) //è¿”å›å­—å…¸æ‰€æœ‰çš„å€¼ dict_values([1, 2, 3]) for i in dic.values(): print (i) 1 2 3 print (dic.items()) //è¿”å›å­—å…¸æ‰€æœ‰çš„é”®å’Œå€¼ dict_items([('key1', 1), ('key2', 2), ('key3', 3)]) for i in dic.items(): print (i) ('key1', 1) ('key2', 2) ('key3', 3) 2.è§£æ„ 2.1 è§£æ„ç¤ºä¾‹1 ä¸¤ä¸ªå˜é‡äº’æ¢å€¼ a,b = 10,20 print (a,b) #aä¸bçš„å€¼äº’æ¢ a = 10 b = 20 a,b = b,a print (a,b) 20 10 #è§£æ„è¯´æ˜1 a,b = \"ä½ å¥½\" //å°†å­—ç¬¦ä¸²åˆ†åˆ«èµ‹å€¼ç»™aå’Œb print (a) print (b) ä½  å¥½ a,b = \"ä½ å¥½å•Š\" //åè¾¹çš„å€¼å¿…é¡»ä¸å˜é‡çš„æ•°é‡ç›¸åŒ print (a) print (b) 2.2 è§£æ„ç¤ºä¾‹2 å­—å…¸ç¤ºä¾‹ å­—å…¸æœ¬èº«æ˜¯æ— åºçš„ï¼Œæ‰€ä»¥ä¸æ”¯æŒç´¢å¼•ï¼Œpython3.6ä»¥ä¸Šç‰ˆæœ¬æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ˜¾ç¤º #å°†å­—å…¸è½¬æ¢ä¸ºåˆ—è¡¨ä»è€Œå¯ä»¥ä»¥ç´¢å¼•æŸ¥è¯¢å­—å…¸çš„é”®å’Œå€¼ dic = {\"key1\":1,\"key2\":2,\"key3\":3} lst = list(dic.items()) //å°†å­—å…¸æ‰€æœ‰é”®å’Œå€¼æ˜¾ç¤ºå¹¶è½¬æ¢ä¸ºåˆ—è¡¨ï¼Œä»è€Œå¯ä»¥å–é”®å’Œå€¼ print (lst[0]) ('key1', 1) print (lst[0][0]) //æ‰“å°å‡ºå­—å…¸çš„é”®å’Œå€¼åå†æ ¹æ®ç´¢å¼•å–é”®æˆ–è€…å€¼ key1 #è¿›é˜¶ï¼Œå­—å…¸ä¸­çš„å€¼æ¯”è¾ƒå°‘çš„æ—¶å€™å¯ä»¥ç”¨è½¬æ¢ä¸ºåˆ—è¡¨çš„æ–¹å¼ç„¶åæ ¹æ®ç´¢å¼•è·å–é”®æˆ–è€…å€¼è§£å†³ï¼Œå¦‚æœå­—å…¸ä¸­çš„å€¼æ¯”è¾ƒå¤šï¼Œå¯ä»¥ç”¨forå¾ªç¯è§£å†³ dic = {\"key1\":1,\"key2\":2,\"key3\":3,\"key4\":4,\"key5\":5,\"key6\":6,\"key7\":7,\"key8\":8,\"key9\":9} //è·å–å­—å…¸ä¸­çš„é”®å’Œå€¼ for i in dic.items(): print (i) ('key1', 1) ('key2', 2) ('key3', 3) ('key4', 4) ('key5', 5) ('key6', 6) ('key7', 7) ('key8', 8) ('key9', 9) //åˆ†åˆ«è·å–å­—å…¸ä¸­çš„é”®å’Œå€¼ for i in dic.items(): print (i[0],i[1]) key1 1 key2 2 key3 3 key4 4 key5 5 key6 6 key7 7 key8 8 key9 9 3.å­—å…¸çš„åµŒå¥— å­—å…¸çš„åµŒå¥—å°±æ˜¯å­—å…¸ä¸­è¿˜æœ‰å­—å…¸ #ç¤ºä¾‹1 dic = {\"dic1\":1,\"dic2\":2,\"dic3\":3,\"dic4\":4,\"dic5\":{\"dic6\":6,\"dic7\":{\"dic8\":8,\"dic9\":9,\"dic10\":{\"dic11\":11,\"dic12\":12}}}} //è¦è·å–dic12çš„å€¼ print (dic[\"dic5\"][\"dic7\"][\"dic10\"][\"dic12\"]) 12 #ç¤ºä¾‹2 dic = {\"dic1\":1,\"dic2\":2,\"dic3\":3,\"dic4\":4,\"dic5\":{\"dic6\":6,\"dic7\":{\"dic8\":8,\"dic9\":9,\"dic10\":{\"dic11\":\"ä¹ˆä¹ˆå“’\",\"dic12\":\"å‘µå“ˆå˜»\"}}}} //è¦è·å–å“ˆ print (dic[\"dic5\"][\"dic7\"][\"dic10\"][\"dic12\"][1]) #è·å–åˆ°å­—å…¸çš„é”®dic12åï¼Œå€¼æ˜¯å­—ç¬¦ä¸²ï¼Œå› æ­¤å¯ä»¥æ ¹æ®ç´¢å¼•å–å€¼ å“ˆ 4.å­—å…¸éªšæ“ä½œ 4.1 å­—å…¸æ‰¹é‡åˆ›å»ºé”®å€¼å¯¹ fromkeys fromkeys(å‚æ•°1ï¼Œå‚æ•°2) å‚æ•°1:é”®ï¼ˆå¯è¿­ä»£ï¼‰ å‚æ•°2:å€¼ï¼ˆå…±ç”¨ï¼‰æ‰¹é‡åˆ›å»ºé”®å€¼å¯¹ dic = {} dic = dic.fromkeys(\"abc\",'hehe') print (dic) {'a': 'hehe', 'b': 'hehe', 'c': 'hehe'} å­—å…¸æ‰¹é‡åˆ›å»ºé”®å€¼å¯¹ï¼Œå€¼å¿…é¡»å¯è¿­ä»£ï¼ï¼ï¼ //å­—å…¸æ‰¹é‡åˆ›å»ºé”®å€¼å¯¹ï¼Œå€¼æ˜¯å¯å˜æ•°æ®ç±»å‹çš„å‘ dic = {} dic = dic.fromkeys(\"abc\",[]) dic[\"c\"].append(6) print (dic) {'a': [6], 'b': [6], 'c': [6]} æœ¬æ„æ˜¯æƒ³ä¿®æ”¹cçš„å€¼ï¼Œä½†æ˜¯ç»“æœå´å…¨å˜äº† æ­£ç¡®åšæ³• dic = {} dic = dic.fromkeys(\"abc\",[]) dic[\"c\"] = 6 print (dic) {'a': [], 'b': [], 'c': 6} 4.2 å­—å…¸å¦ç±»å®šä¹‰æ–¹å¼ //å­—å…¸å¦ç±»å®šä¹‰æ–¹å¼1 print (dict(k1=1,k2=2)) {'k1': 1, 'k2': 2} //å­—å…¸å¦ç±»å®šä¹‰æ–¹å¼2 print (dict([(1,2),(3,4),(5,6)])) {1: 2, 3: 4, 5: 6} æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/7.5pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å…ƒç»„.html":{"url":"python/pythonåŸºç¡€/7.5pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å…ƒç»„.html","title":"å…ƒç»„","keywords":"","body":"pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-å…ƒç»„ 1.å…ƒç»„ 1.1 å«ä¹‰ pythonä¸­çš„æ•°æ®ç±»å‹ä¹‹ä¸€ 1.2 å…³é”®å­— tuple 1.3 å®šä¹‰ tu = () 1.4 ä½œç”¨ é€šè¿‡å…ƒç´ çš„åç§°è·å–å…ƒç´ çš„ç´¢å¼• 1.5 åº”ç”¨åœºæ™¯ 1.ä¸å¯å˜ï¼šä¸ºäº†é˜²æ­¢è¯¯æ“ä½œæ—¶ä¿®æ”¹é‡è¦æ•°æ® 2.é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨æ•°æ® 1.6 ç‰¹ç‚¹ 1.å…ƒç»„å°±æ˜¯ä¸€ä¸ªä¸å¯å˜çš„åˆ—è¡¨ 2.å…ƒç»„ä¸èƒ½å¢åˆ æ”¹ 3.å…ƒç»„æ˜¯ä¸€ä¸ªæœ‰åºï¼Œå¯è¿­ä»£ï¼Œä¸å¯å˜çš„æ•°æ®ç±»å‹ 4.å½“å°æ‹¬å·ä¸­æ²¡æœ‰å‡ºç°é€—å·æ—¶ï¼Œæ•°æ®ç±»å‹å°±æ˜¯æ‹¬å·ä¸­æ•°æ®æœ¬èº«çš„æ•°æ®ç±»å‹ 5.åˆ—è¡¨å’Œå…ƒç»„è¿›è¡Œä¹˜æ³•æ—¶ï¼Œå…ƒç´ éƒ½æ˜¯å…±ç”¨çš„ 1.7 ä½¿ç”¨ç¤ºä¾‹ //å®šä¹‰ä¸€ä¸ªå…ƒç»„ tu = (1,2,3) print (tu) (1, 2, 3) //æ”¯æŒç´¢å¼• tu = (1,2,3) print (tu[0]) 1 //æ”¯æŒåˆ‡ç‰‡ tu = (1,2,3) print (tu[0:1]) (1,) print (tu[0:2]) (1, 2) //ç»Ÿè®¡å…ƒç»„ä¸­å…ƒç´ ä¸ªæ•° tu.count tu = (1,2,3,1) print (tu.count(1)) 2 //é€šè¿‡å…ƒç´ çš„åç§°è·å–å…ƒç´ çš„ç´¢å¼• tu.index tu = (1,2,3) print (tu.index(1)) 0 //forå¾ªç¯æ‰“å°å…ƒç»„ä¸­çš„å†…å®¹ tu = (1,2,3) for i in tu: print (i) 1 2 3 1.8 å…ƒç»„é¢è¯•é¢˜ a = (10) # å½“å°æ‹¬å·ä¸­æ²¡æœ‰å‡ºç°é€—å·æ—¶,æ•°æ®ç±»å‹å°±æ˜¯æ‹¬å·ä¸­æ•°æ®ç±»å‹æœ¬èº« a = (\"abc\") # å½“å°æ‹¬å·ä¸­æ²¡æœ‰å‡ºç°é€—å·æ—¶,æ•°æ®ç±»å‹å°±æ˜¯æ‹¬å·ä¸­æ•°æ®ç±»å‹æœ¬èº« a = (\"abc\",) # è¿™æ˜¯ä¸€ä¸ªå…ƒç»„ a = () # è¿™æ˜¯å…ƒç»„ a = (1,2,3) # è¿™æ˜¯å…ƒç»„ //ä»£ç ç¤ºä¾‹ a = (10) print (type(a)) a = (\"abc\") print (type(a)) a = (\"abc\",) print (type(a)) a = () print (type(a)) a = (1,2,3) print (type(a)) æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/7.6pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-é›†åˆ.html":{"url":"python/pythonåŸºç¡€/7.6pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-é›†åˆ.html","title":"é›†åˆ","keywords":"","body":"pythonåŸºç¡€ä¸ƒ åŸºç¡€æ•°æ®ç±»å‹-é›†åˆ 1.é›†åˆ 1.1 å«ä¹‰ é›†åˆæ˜¯pythonä¸­çš„ä¸€ç§æ•°æ®ç±»å‹ 1.2 å…³é”®å­— set 1.3 å®šä¹‰ ç©ºé›†åˆ set() #å®šä¹‰é›†åˆç¤ºä¾‹ s = {1,2,3} 1.4 ç‰¹ç‚¹ 1.å»é‡ï¼Œé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯å”¯ä¸€çš„ 2.é›†åˆå…³ç³» 3.é›†åˆæ— åºã€å¯å˜ã€å¯è¿­ä»£ 1.5 é›†åˆä½¿ç”¨ç¤ºä¾‹ 1.é›†åˆå»é‡ lst = [1,2,3,1,4] print (set(lst)) {1, 2, 3, 4} 1.6 é›†åˆé¢è¯•é¢˜ç¤ºä¾‹ ä¸€è¡Œä»£ç å»é‡ âš ï¸éœ€è¦æ³¨æ„çš„æ˜¯åŸå…ˆçš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆï¼Œåœ¨åšå®Œå»é‡å¤„ç†åéœ€è¦è½¬æ¢ä¸ºåŸå…ˆçš„æ•°æ®ç±»å‹ lst = [1,2,3,5,6,1,5,6,7,8,9,33,1,2,33,66] print (set(lst)) //ä¸å®Œç¾åšæ³•ï¼Œæ²¡æœ‰å°†æ•°æ®ç±»å‹è½¬æ¢ä¸ºåŸæ¥çš„åˆ—è¡¨ print (list(set(lst))) [1, 2, 3, 33, 5, 6, 7, 8, 9, 66] 1.7 é›†åˆæ ¸å¿ƒè¯´æ˜ âš ï¸é›†åˆå°±æ˜¯ä¸€ä¸ªæ²¡æœ‰å€¼çš„å­—å…¸ âš ï¸é›†åˆå°±æ˜¯ä¸€ä¸ªæ²¡æœ‰å€¼çš„å­—å…¸ ä¸ºä»€ä¹ˆè¯´é›†åˆæ˜¯ä¸€ä¸ªæ²¡æœ‰å€¼çš„å­—å…¸ï¼Ÿï¼Ÿï¼Ÿ å­—å…¸çš„å€¼ï¼šä»»æ„ å­—å…¸çš„é”®ï¼šä¸å¯å˜ã€å¯å“ˆå¸Œ \"\"\"ç¤ºä¾‹è¯´æ˜ï¼Œåˆ—è¡¨æ˜¯å¯å˜çš„ å¦‚æœé›†åˆä¸­èƒ½æ‰“å°åˆ—è¡¨ï¼Œé‚£ä¹ˆè¯´æ˜é›†åˆä¸­çš„å…ƒç´ ç›¸å½“äºå­—å…¸ä¸­çš„å€¼,ä¹Ÿå°±æ˜¯é›†åˆæ˜¯ä¸€ä¸ªæ²¡æœ‰é”®çš„å­—å…¸ å¦‚æœé›†åˆä¸­ä¸èƒ½æ‰“å°åˆ—è¡¨ï¼Œé‚£ä¹ˆè¯´æ˜é›†åˆä¸­çš„å…ƒç´ ç›¸å½“äºå­—å…¸ä¸­çš„é”®ï¼Œä¹Ÿå°±æ˜¯é›†åˆæ˜¯ä¸€ä¸ªæ²¡æœ‰å€¼çš„å­—å…¸ \"\"\" #æ‰“å°ä¸€ä¸ªå¯å˜ç±»å‹ s = {1,2,[1,2,3]} print (s) TypeError: unhashable type: 'list' //æ‰“å°ç»“æœæŠ¥é”™åˆ—è¡¨ä¸å¯å“ˆå¸Œ #æ‰“å°ä¸€ä¸ªä¸å¯å˜ç±»å‹ s = {1,2,(1,2,3)} print (s) {1, 2, (1, 2, 3)} 1.8 é›†åˆçš„å¢åˆ æ”¹æŸ¥ 1.8.1 é›†åˆçš„å¢ #æ–¹å¼1 update s = set() s.update('play') print (s) {'l', 'a', 'p', 'y'} //é›†åˆä¸­çš„updateä¼šæŠŠå¢åŠ çš„å†…å®¹è¿­ä»£æ·»åŠ  #æ–¹å¼2 add s = set() s.add('play') //addåœ¨é›†åˆä¸­æ˜¯å¸¸ç”¨çš„ print (s) {'play'} 1.8.2 é›†åˆçš„åˆ  #æ–¹å¼1 pop éšæœºåˆ é™¤ s = {1,2,3,'å‘µå‘µ',5} s.pop() //âš ï¸é›†åˆä¸­çš„popæ˜¯éšæœºåˆ é™¤ print (s) {2, 3, 5, 'å‘µå‘µ'} {1, 2, 3, 5} #æ–¹å¼2 remove é€šè¿‡å…ƒç´ åç§°åˆ é™¤ s = {1,2,3,'å‘µå‘µ',5} s.remove(\"å‘µå‘µ\") print (s) {1, 2, 3, 5} #æ–¹å¼3 clear s = {1,2,3,'å‘µå‘µ',5} s.clear() print (s) set() //âš ï¸ ç©ºé›†åˆä¸ºset() 1.8.3 é›†åˆçš„æ”¹ 1.å…ˆåˆ ååŠ  2.è½¬æ¢æ•°æ®ç±»å‹è¿›è¡Œä¿®æ”¹ 1.8.4 é›†åˆçš„æŸ¥ #forå¾ªç¯ s = {1,2,3,'å‘µå‘µ',5} for i in s: print (i) 1 2 3 5 å‘µå‘µ 1.9 é›†åˆå…³ç³» 1.9.1 é›†åˆå¹¶é›† | == or a = {'a','b','c','d','e'} b = {'a','c','e','f'} print (a | b) {'b', 'a', 'c', 'f', 'd', 'e'} 1.9.2 é›†åˆäº¤é›† & == and a = {'a','b','c','d','e'} b = {'a','c','e','f'} print (a & b) {'a', 'c', 'e'} 1.9.3 é›†åˆå·®é›† - #å·®é›†å°±æ˜¯ç”¨è‡ªèº«çš„å…ƒç´ å‡å»å¯¹æ–¹çš„å…ƒç´ ï¼Œç›¸åŒçš„å…ƒç´ æ¶ˆé™¤ï¼Œä½†æ˜¯è‡ªèº«æ²¡æœ‰çš„ä¸ä¼šå‡ºç° a = {'a','b','c','d','e'} b = {'a','c','e','f'} print (a - b) {'b', 'd'} 1.9.4 é›†åˆè¡¥é›†ã€åå·®é›†ã€å¯¹ç§°é›† ^ #è¡¥é›†å°±æ˜¯ç”¨è‡ªèº«çš„å…ƒç´ å‡å»å¯¹æ–¹çš„å…ƒç´ ï¼Œç›¸åŒçš„å…ƒç´ æ¶ˆé™¤ï¼ŒåŒæ—¶è‡ªèº«æ²¡æœ‰çš„å…ƒç´ ä¼šå‡ºç° a = {'a','b','c','d','e'} b = {'a','c','e','f'} print (a ^ b) {'b', 'd', 'f'} 1.9.5 è¶…é›† å°±æ˜¯çˆ¶é›† > a = {'a','b','c','d','e'} b = {'a','c','e'} print (a > b) //åˆ¤æ–­aæ˜¯å¦æ˜¯bçš„çˆ¶é›† True 1.9.6 å­é›† a = {'a','b','c','d','e'} b = {'a','c','e'} print (b æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/8.pythonåŸºç¡€å…« å°æ•°æ®æ± ã€ä»£ç å—.html":{"url":"python/pythonåŸºç¡€/8.pythonåŸºç¡€å…« å°æ•°æ®æ± ã€ä»£ç å—.html","title":"pythonåŸºç¡€å…« å°æ•°æ®æ± ã€ä»£ç å—","keywords":"","body":"pythonåŸºç¡€å…« å°æ•°æ®æ± ã€ä»£ç å— 1.å°æ•°æ®æ± ã€ä»£ç å—ï¼ˆäº†è§£ï¼Œå®é™…å¼€å‘ä¸­ç”¨ä¸åˆ°ï¼‰ 1.1 å°æ•°æ®æ± ã€ä»£ç å—å«ä¹‰ å°æ•°æ®æ± ã€ä»£ç å—å±äºpythonä¸­çš„é©»ç•™æœºåˆ¶ï¼Œç›®çš„ç”¨äºèŠ‚çœå†…å­˜ç©ºé—´ ä»£ç å—ï¼šä¸€ä¸ªpyæ–‡ä»¶ã€ä¸€ä¸ªå‡½æ•°ã€ä¸€ä¸ªæ¨¡å—ã€ä¸€ä¸ªç±»ã€äº¤äº’æ¨¡å¼ï¼ˆç»ˆç«¯ï¼‰ä¸‹çš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªä»£ç å— å°æ•°æ®æ± ï¼špythonä¸­çš„å†…å­˜é©»ç•™æœºåˆ¶ï¼Œä¼˜å…ˆçº§æ¯”ä»£ç å—ä½ âš ï¸å…ˆæ‰§è¡Œä»£ç å—ç„¶åæ‰§è¡Œå°æ•°æ®æ±  1.2 å°æ•°æ®æ± ç¼“å­˜æœºåˆ¶ æ•°å­—ï¼š-5 ï½ 256 å­—ç¬¦ä¸²ï¼š 1.å®šä¹‰æ—¶å†…å®¹ï¼ˆä¸åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼‰é•¿åº¦ä¸é™ï¼Œå†…å®¹ç›¸åŒï¼Œå°±è¿›è¡Œé©»ç•™ 2.python3.6è§£é‡Šå™¨å­—ç¬¦ä¸²è¿›è¡Œä¹˜æ³•æ—¶ï¼ˆä¸åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼‰ï¼Œæ€»é•¿åº¦ä¸èƒ½è¶…è¿‡20 3.python3.7è§£é‡Šå™¨å­—ç¬¦ä¸²è¿›è¡Œä¹˜æ³•æ—¶ï¼ˆä¸åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼‰ï¼Œæ€»é•¿åº¦ä¸èƒ½è¶…è¿‡4096 âš ï¸éªŒè¯å°æ•°æ®æ± æœºåˆ¶å¿…é¡»åœ¨ç»ˆç«¯ä¸­ï¼Œä¸èƒ½åœ¨IDE(ä¾‹å¦‚pycharm)ä¸­éªŒè¯ï¼Œå› ä¸ºIDEä¸­æ˜¯ä¸€ä¸ªpyæ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªä»£ç å—ï¼Œä¼šä¼˜å…ˆæ‰§è¡Œ 1.å°æ•°æ®æ± æ•°å­—éªŒè¯ //-5 ~ 256éªŒè¯ï¼Œè¿”å›ç»“æœä¸ºTrueï¼Œé©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ç›¸åŒ >>> a = -5 >>> b = -5 >>> a is b True >>> print (id(a),id(b)) 4331026288 4331026288 >>> a = 256 >>> b = 256 >>> a is b True >>> print (id(a),id(b)) 4331034640 4331034640 //-5 ~ 256èŒƒå›´å¤–éªŒè¯ï¼Œè¿”å›ç»“æœä¸ºFalseï¼Œä¸é©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ä¸åŒ >>> a = -6 >>> b = -6 >>> a is b False >>> print (id(a),id(b)) 140558040632912 140557772390192 >>> a = 257 >>> b = 257 >>> a is b False >>> print (id(a),id(b)) 140558039687984 140557772390256 2.å°æ•°æ®æ± å­—ç¬¦ä¸²éªŒè¯ 2.1å®šä¹‰å†…å®¹éªŒè¯ //ä¸åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·,å®šä¹‰æ—¶å†…å®¹ç›¸åŒï¼Œé©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ç›¸åŒ >>> a = \"abc\" >>> b = \"abc\" >>> a is b True >>> print (id(a),id(b)) 140558040616664 140558040616664 //åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼Œå®šä¹‰æ—¶å†…å®¹ç›¸åŒï¼Œä¸é©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ä¸åŒ >>> a = \"abc#\" >>> b = \"abc#\" >>> a is b False >>> print (id(a),id(b)) 140557772689168 140557772689112 >>> a = \"abc#ä½ å¥½\" >>> b = \"abc#ä½ å¥½\" >>> a is b False >>> print (id(a),id(b)) 140557772596880 140557772596688 >>> a = \"abcä½ å¥½\" >>> b = \"abcä½ å¥½\" >>> a is b False >>> print (id(a),id(b)) 140557772596688 140557772596880 2.1å­—ç¬¦ä¸²ä¹˜æ³•éªŒè¯(python3.6) //ä¸åŒ…å«ä¸­æ–‡å’Œç‰¹æ®Šç¬¦å·ï¼Œæ€»é•¿åº¦ä¸è¶…è¿‡20ï¼Œé©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ç›¸åŒ >>> a = \"hehe\" * 3 >>> b = \"hehe\" * 3 >>> print (a is b) True >>> print (id(a),id(b)) 140557772708656 140557772708656 >>> a = \"hehe\" * 5 >>> b = \"hehe\" * 5 >>> print (a is b) True >>> print (id(a),id(b)) 140557772718488 140557772718488 //å­—ç¬¦ä¸²ç›¸ä¹˜ï¼Œç­‰äº20æ—¶é©»ç•™ //ä¸åŒ…å«ä¸­æ–‡å’Œç‰¹æ®Šç¬¦å·ï¼Œæ€»é•¿åº¦è¶…è¿‡20ï¼Œä¸é©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ä¸åŒ >>> a = \"hehe\" * 6 >>> b = \"hehe\" * 6 >>> print (a is b) False >>> print (id(a),id(b)) 140557772714992 140557772714912 //åŒ…å«ä¸­æ–‡æˆ–è€…ç‰¹æ®Šç¬¦å·ï¼Œä¸ç®¡æ€»é•¿åº¦æ˜¯å¦è¶…è¿‡20ï¼Œéƒ½ä¸é©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ä¸åŒ >>> a = \"abc#ä½ å¥½\" * 3 >>> b = \"abc#ä½ å¥½\" * 3 >>> print (a is b) False >>> print (id(a),id(b)) 140231892539968 140231893044000 //æ€»é•¿åº¦ä¸è¶…è¿‡20ï¼Œä½†æ˜¯å†…å­˜åœ°å€è¿˜æ˜¯ä¸åŒ >>> a = \"abc#ä½ å¥½\" * 5 >>> b = \"abc#ä½ å¥½\" * 5 >>> print (a is b) False >>> print (id(a),id(b)) 140231893461712 140231893461848 1.3 ä»£ç å—ç¼“å­˜æœºåˆ¶ æ•°å­—ï¼š-5 ï½ æ­£æ— ç©· å­—ç¬¦ä¸²ï¼š 1.å®šä¹‰æ—¶å†…å®¹é•¿åº¦ä¸é™ï¼Œå†…å®¹ç›¸åŒï¼Œå°±è¿›è¡Œé©»ç•™ 2.å­—ç¬¦ä¸²è¿›è¡Œä¹˜æ³•æ—¶ï¼ˆä¸åŒ…å«ä¸­æ–‡å’Œç‰¹æ®Šç¬¦å·ï¼‰ï¼Œæ€»é•¿åº¦ä¸èƒ½è¶…è¿‡20 1.ä»£ç å—æ•°å­—éªŒè¯ ï¼ˆpycharmä¸­éªŒè¯ï¼‰ //-5 ~ æ­£æ— ç©·éªŒè¯ï¼Œè¿”å›ç»“æœä¸ºTrueï¼Œé©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ç›¸åŒ a = -5 b = -5 print (a is b) True print (id(a),id(b)) 4453603184 4453603184 a = 1000000 b = 1000000 print (a is b) True print (id(a),id(b)) 140434424966800 140434424966800 //-5 ~ æ­£æ— ç©·èŒƒå›´å¤–éªŒè¯ï¼Œè¿”å›ç»“æœä¸ºFalseï¼Œä¸é©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ä¸åŒ a = -6 b = -6 print (a is b) False print (id(a),id(b)) 140442480390000 140442480390032 2.å­—ç¬¦ä¸²éªŒè¯ 2.1å®šä¹‰å†…å®¹éªŒè¯ //åªè¦å†…å®¹ç›¸åŒï¼Œå°±é©»ç•™ï¼Œå¯ä»¥åŒ…å«ä¸­æ–‡å’Œå­—ç¬¦ä¸²,å°æ•°æ®æ± ä¸­å°±ä¸å¯ä»¥ a = \"abc#ä½ å¥½\" b = \"abc#ä½ å¥½\" print (a is b) True print (id(a),id(b)) 140481266762928 140481266762928 2.2å­—ç¬¦ä¸²ä¹˜æ³•éªŒè¯ //ä¸åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼Œæ€»é•¿åº¦ä¸è¶…è¿‡20ï¼Œé©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ç›¸åŒï¼Œä¸å°æ•°æ®æ± ç›¸åŒ a = \"abc\" * 6 b = \"abc\" * 6 print (a is b) True print (id(a),id(b)) 140679911152496 140679911152496 //åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼Œæ— è®ºæ€»é•¿åº¦æ˜¯å¦è¶…è¿‡20ï¼Œéƒ½ä¸é©»ç•™ï¼Œå†…å­˜ç©ºé—´åœ°å€ä¸åŒ a = \"abc#ä½ å¥½\" * 3 b = \"abc#ä½ å¥½\" * 3 print (a is b) False print (id(a),id(b)) 140361947581552 140361947581216 //æ€»é•¿åº¦ä¸è¶…è¿‡20ï¼Œå†…å­˜ç©ºé—´åœ°å€ä¸åŒ a = \"abc#ä½ å¥½\" * 5 b = \"abc#ä½ å¥½\" * 5 print (a is b) False print (id(a),id(b)) 140438049459712 140437243696104 //æ€»é•¿åº¦è¶…è¿‡20ï¼Œå†…å­˜ç©ºé—´åœ°å€ä¸åŒ 1.4 å°æ•°æ®æ± å’Œä»£ç å—å¯¹æ¯” å°æ•°æ®æ±  ä»£ç å— æ•°å­— -5 ï½ 256 é©»ç•™ -5 ï½ æ­£æ— ç©· é©»ç•™ å­—ç¬¦ä¸²å®šä¹‰å†…å®¹ ä¸èƒ½åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼Œé•¿åº¦ä¸é™ï¼Œå†…å®¹ç›¸åŒå°±é©»ç•™ å¯ä»¥åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼Œé•¿åº¦ä¸é™ï¼Œå†…å®¹ç›¸åŒå°±é©»ç•™ å­—ç¬¦ä¸²ä¹˜æ³• ä¸èƒ½åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼Œæ€»é•¿åº¦ä¸è¶…è¿‡20å°±é©»ç•™ ä¸èƒ½åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šç¬¦å·ï¼Œæ€»é•¿åº¦ä¸è¶…è¿‡20å°±é©»ç•™ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/9.pythonåŸºç¡€ä¹ æ·±æµ…æ‹·è´.html":{"url":"python/pythonåŸºç¡€/9.pythonåŸºç¡€ä¹ æ·±æµ…æ‹·è´.html","title":"pythonåŸºç¡€ä¹ æ·±æµ…æ‹·è´","keywords":"","body":"pythonåŸºç¡€ä¹ æ·±æµ…æ‹·è´ 1.æ·±æµ…æ‹·è´ï¼ˆâš ï¸é‡è¦ï¼‰ 1.1 æµ…æ‹·è´ 1.1.1 å®šä¹‰ åªæ‹·è´ç¬¬ä¸€å±‚çš„å†…å­˜åœ°å€ 1.1.2 æµ…æ‹·è´ç¤ºä¾‹ èµ‹å€¼ ç¤ºæ„æµ…æ‹·è´å‰å…ˆè¯´æ˜èµ‹å€¼ 1.èµ‹å€¼å…±ç”¨åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªå˜é‡çš„å€¼æ”¹å˜ï¼Œå¦ä¸€ä¸ªèµ‹å€¼çš„å˜é‡åŒæ—¶ä¹Ÿæ”¹å˜ 2.å¤šä¸ªå˜é‡åæŒ‡å‘åŒä¸€å—å†…å­˜ç©ºé—´ //åˆ—è¡¨ç¤ºä¾‹ lst = [1,1,3] lst1 = lst lst1.append(4) //æ­£å¸¸æ€ç»´ç†è§£åº”è¯¥æ˜¯lst1æ›´æ”¹åï¼Œlstä¸ä¼šæ”¹å˜ï¼Œä½†æ˜¯èµ‹å€¼æ˜¯å¤šä¸ªå˜é‡åæŒ‡å‘åŒä¸€ä¸ªå†…å­˜ ç©ºé—´ï¼Œå› æ­¤åªè¦ä¸€ä¸ªå˜é‡æ”¹å˜ï¼Œå¦ä¸€ä¸ªå˜é‡ä¹Ÿæ”¹å˜ print (lst,lst1) [1, 1, 3, 4] [1, 1, 3, 4] //å­—å…¸ç¤ºä¾‹ dic = {'k1':1,'k1':1} dic1 = dic dic1.update({'k1':111}) print (dic,dic1) {'k1': 1, 'k1': 111} {'k1': 1, 'k1': 111} èµ‹å€¼ç¤ºæ„å›¾ æµ…æ‹·è´ åªæ‹·è´ç¬¬ä¸€å±‚çš„å†…å­˜åœ°å€ åˆ—è¡¨ä¸­æµ…æ‹·è´æœ‰ä¸¤ç§æ–¹å¼ 1. lst = [1,1,3] new_lst = lst.copy() 1. lst = [1,1,3] new_lst = lst[:] æµ…æ‹·è´åªæ‹·è´ç¬¬ä¸€å±‚çš„å†…å­˜ç©ºé—´åœ°å€,æµ…æ‹·è´çš„ä¸¤ä¸ªå˜é‡æ˜¯å•ç‹¬çš„å†…å­˜ç©ºé—´ï¼Œä¸å†æ˜¯å…±ç”¨åŒä¸€ä¸ªå†…å­˜ç©ºé—´åœ°å€ //åˆ—è¡¨ç¤ºä¾‹1 åˆ—è¡¨ä¸­æœªåµŒå¥—ç¬¬äºŒå±‚å…ƒç´  lst = [1,1,3] new_lst = lst.copy() new_lst.append(4) print (lst,new_lst) [1, 1, 3] [1, 1, 3, 4] //æµ…æ‹·è´ä¸­lstå’Œnew_lstç»“æœä¸åŒ print (id(lst),id(new_lst)) 140584614767176 140584614774344 //æµ…æ‹·è´ä¸­lstå’Œnew_lstå†…å­˜ç©ºé—´åœ°å€ä¸åŒ //åˆ—è¡¨ç¤ºä¾‹1 åˆ—è¡¨ä¸­åµŒå¥—äº†ç¬¬äºŒå±‚å…ƒç´  lst = [1,1,[3,4,5]] new_lst = lst.copy() new_lst.append(6) print (lst,new_lst) [1, 1, [3, 4, 5]] [1, 1, [3, 4, 5], 6] print (id(lst),id(new_lst)) 140431875130951 140431874963911 print (id(lst[1]),id(new_lst[1])) //æµ…æ‹·è´åªæ‹·è´ç¬¬ä¸€å±‚å†…å­˜ç©ºé—´ï¼Œå› æ­¤ä¸¤ä¸ªåˆ—è¡¨çš„ç¬¬äºŒä¸ªåµŒå¥—çš„å…ƒç´ çš„å€¼å†…å­˜ç©ºé—´ç›¸åŒ 140633470413384 140633470413384 æµ…æ‹·è´å•å±‚å…ƒç´ ç¤ºæ„å›¾ï¼ˆå¢åŠ å…ƒç´ ï¼‰ æµ…æ‹·è´å¤šå±‚å…ƒç´ ç¤ºæ„å›¾ï¼ˆä¿®æ”¹å…ƒç´ ï¼‰ æµ…æ‹·è´å¤šå±‚å…ƒç´ ç¤ºæ„å›¾ï¼ˆç¬¬äºŒå±‚å¢åŠ å…ƒç´ ï¼‰ 1.1.3 æµ…æ‹·è´æ€»ç»“ 1.æµ…æ‹·è´åªå¤åˆ¶ç¬¬ä¸€å±‚å†…å­˜ç©ºé—´åœ°å€ 1.æµ…æ‹·è´ï¼Œä¿®æ”¹ç¬¬ä¸€å±‚å…ƒç´ æˆ–è€…è¿½åŠ å…ƒç´ ï¼Œéƒ½æ˜¯å°†æ—§æŒ‡å‘æ”¹å˜ä¸ºæ–°æŒ‡å‘ï¼Œä¸¤ä¸ªå˜é‡äº’ä¸å½±å“ 3.æµ…æ‹·è´ä¿®æ”¹ç¬¬äºŒå±‚åŠä»¥ä¸‹å…ƒç´ æˆ–è€…è¿½åŠ å…ƒç´ ï¼Œä¿®æ”¹çš„æ˜¯ä¸¤ä¸ªå˜é‡å…±ç”¨çš„å€¼ï¼Œæ­¤æ—¶ä¿®æ”¹ä¼šå½±å“ä¸¤ä¸ªå˜é‡ 1.1.4 æµ…æ‹·è´å‘ lst = [1,3,[4,5],6] lst1 = lst lst1 = lst[:] lst1[-1] = [8,9] lst1[-1].append([0]) #æ•°å­—æ— æ³•è¿›è¡Œè¿½åŠ æ“ä½œ print (lst,lst1,lst1) AttributeError: 'int' object has no attribute 'append' 1.2æ·±æ‹·è´ 1.2.1 å®šä¹‰ ä¸å¯å˜æ•°æ®ç±»å‹å…±ç”¨å†…å­˜ç©ºé—´ï¼Œå¯å˜æ•°æ®ç±»å‹å¼€è¾Ÿæ–°çš„å†…å­˜ç©ºé—´ï¼Œä¸ç®¡åµŒå¥—å¤šå°‘å±‚éƒ½æ˜¯è¿™æ ·çš„åŸç† 1.2.2 æ·±æ‹·è´è¯­æ³• Import copy copy.deepcopy() 1.2.3 æ·±æ‹·è´ç¤ºä¾‹ import copy lst = [1,1,[3,4]] new_lst = copy.deepcopy(lst) print (id(lst[0]),id(new_lst[0])) #lst[0]ä¸º1ï¼Œ1æ˜¯æ•´å‹ï¼Œæ˜¯ä¸å¯å˜æ•°æ®ç±»å‹ --> å…±ç”¨å†…å­˜ç©ºé—´åœ°å€ 4464777164 4464777164 print (id(lst[-1]),id(new_lst[-1])) 140663166316984 140663166494088 #lst[-1]ä¸º[3,4]ï¼Œ[3,4]æ˜¯åˆ—è¡¨ï¼Œæ˜¯å¯å˜æ•°æ®ç±»å‹ --> æ–°å¼€è¾Ÿå†…å­˜ç©ºé—´åœ°å€ 1.2.4 æ·±æ‹·è´åŸç†å›¾ 1.2.5 æ·±æ‹·è´æ€»ç»“ æ·±æ‹·è´ä¸­ï¼Œä¸å¯å˜æ•°æ®ç±»å‹å…±ç”¨å†…å­˜ç©ºé—´åœ°å€ï¼Œå¯å˜æ•°æ®ç±»å‹å¼€è¾Ÿæ–°çš„å†…å­˜ç©ºé—´ï¼Œä¸ç®¡åµŒå¥—å¤šå°‘å±‚éƒ½æ˜¯è¿™æ · æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/10.pythonåŸºç¡€å æ–‡ä»¶æ“ä½œ.html":{"url":"python/pythonåŸºç¡€/10.pythonåŸºç¡€å æ–‡ä»¶æ“ä½œ.html","title":"pythonåŸºç¡€å æ–‡ä»¶æ“ä½œ","keywords":"","body":"pythonåŸºç¡€å æ–‡ä»¶æ“ä½œ 1.æ–‡ä»¶æ“ä½œ 1.1 ä½œç”¨ æŒä¹…åŒ–å­˜å‚¨ 1.2 æ–‡ä»¶æ“ä½œæ€»ç»“ f = open(file=\"æ–‡ä»¶åå­—æˆ–æ–‡ä»¶è·¯å¾„\",mode=\"æ“ä½œæ¨¡å¼\",encoding=\"ç¼–ç \") r åªè¯» w æ¸…ç©ºå†™ a è¿½åŠ å†™ rb åªè¯»å­—èŠ‚ wb æ¸…ç©ºå†™å­—èŠ‚ ab è¿½åŠ å†™å­—èŠ‚ r+ è¯»å†™ w+ æ¸…ç©ºå†™è¯» a+ è¿½åŠ å†™è¯» 1.3 æ–‡ä»¶æ“ä½œ 1.3.1 åªè¯»æ–‡ä»¶ --> r r: è¯»æ–‡æœ¬ f = open(\"test.txt\",mode=\"r\",encoding=\"utf-8\") #å‚æ•°è¯´æ˜ f å˜é‡åï¼Œå¥æŸ„ open è¡¨ç¤ºæ‰“å¼€æ–‡ä»¶ï¼Œé€šè¿‡pythonå‘æ“ä½œç³»ç»Ÿå‘é€æŒ‡ä»¤ test.txt è¡¨ç¤ºè¦æ“ä½œçš„æ–‡ä»¶ mode æŒ‡å®šå¯¹æ–‡ä»¶çš„æ“ä½œæ–¹å¼ï¼Œrè¡¨ç¤ºè¯»å– r è¡¨ç¤ºè¯»å–æ–‡ä»¶ encoding æŒ‡å®šå­—ç¬¦é›† âš ï¸æ–‡ä»¶è¯»å–æ—¶åªèƒ½è¯»ä¸€é åœ¨pyåŒçº§ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶txt.txtï¼Œå¹¶å†™å…¥ä»¥ä¸‹å†…å®¹ ä¸€åªå¥”è·‘çš„è‰æ³¥é©¬ abc 123 1.å…¨éƒ¨è¯»å– print(f.read()) f = open(\"txt.txt\",mode=\"r\",encoding=\"utf-8\") print(f.read()) ä¸€åªå¥”è·‘çš„è‰æ³¥é©¬ abc 123 2.ræ¨¡å¼ä¸‹æŒ‰ç…§å­—ç¬¦è¯»å– print(f.read(3)) f = open(\"txt.txt\",mode=\"r\",encoding=\"utf-8\") print(f.read(5)) ä¸€åªå¥”è·‘çš„ 3.è¯»å–ä¸€è¡Œ print(f.readline().strip()) è¯»å–ä¸€è¡Œé»˜è®¤æœ€åæœ‰æ¢è¡Œç¬¦ï¼Œéœ€è¦å»æ‰ f = open(\"txt.txt\",mode=\"r\",encoding=\"utf-8\") print (f.readline().strip()) ä¸€åªå¥”è·‘çš„è‰æ³¥é©¬ 4.è¯»å–å¤šè¡Œï¼Œä»¥åˆ—è¡¨çš„å½¢å¼å­˜å‚¨ print(f.readlines()) f = open(\"txt.txt\",mode=\"r\",encoding=\"utf-8\") print (f.readlines()) ['ä¸€åªå¥”è·‘çš„è‰æ³¥é©¬\\n', 'abc\\n', '123'] //è¯»å–æ€»ç»“ print(f.read()) #å…¨éƒ¨è¯»å– print(f.read(3)) #æ¨¡å¼çš„rçš„æƒ…å†µä¸‹æŒ‰ç…§å­—ç¬¦è¯»å– print(f.readline().strip()) #è¯»å–ä¸€è¡Œ print(f.readlines()) #è¯»å–å¤šè¡Œ,ä»¥åˆ—è¡¨çš„å½¢å¼å­˜å‚¨ 1.3.2 æ¸…ç©ºå†™ --> w w: æ¸…ç©ºå†™æ–‡æœ¬ f = open(\"txt.txt\",mode=\"w\",encoding=\"utf-8\") æ¸…ç©ºå†™ä¼šæŠŠè¦æ“ä½œçš„æ–‡ä»¶å…ˆæ¸…ç©ºï¼Œç„¶åå†å†™å…¥ //wæ¨¡å¼æ‰“å¼€æ–‡ä»¶åä¼šæ¸…ç©ºæ–‡ä»¶å†…å®¹ f = open(\"txt.txt\",mode=\"w\",encoding=\"utf-8\") print (f) txt.txtæ–‡ä»¶ä¸­çš„å†…å®¹ä¼šè¢«æ¸…ç©º //å†™å…¥å†…å®¹ f = open(\"txt.txt\",mode=\"w\",encoding=\"utf-8\") print (f.write(\"å‘µå‘µ\\nå“ˆå“ˆ\")) 5 txt.txtæ–‡ä»¶ä¸­çš„å†…å®¹ä¸ºå¦‚ä¸‹ï¼Œå¹¶ä¸”å…‰æ ‡åœ¨æœ€å¼€å¤´ å‘µå‘µ å“ˆå“ˆ //è¿ç»­å†™ä¼šä»æ–‡ä»¶æœ€åå¼€å§‹å†™ f = open(\"txt.txt\",mode=\"w\",encoding=\"utf-8\") print (f.write(\"å‘µå‘µ\\nå“ˆå“ˆ\")) print (f.write(\"å˜»å˜»\\nå˜¿å˜¿\")) 5 5 txt.txtæ–‡ä»¶ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼Œå¹¶ä¸”å…‰æ ‡åœ¨æœ€å¼€å¤´ å‘µå‘µ å“ˆå“ˆå˜»å˜» å˜¿å˜¿ //å¯¹æ–‡ä»¶å†™æ“ä½œåï¼Œéœ€è¦åˆ·æ–°å’Œå…³é—­æ–‡ä»¶ f = open(\"txt.txt\",mode=\"w\",encoding=\"utf-8\") print (f.write(\"å‘µå‘µ\\nå“ˆå“ˆ\")) print (f.write(\"å˜»å˜»\\nå˜¿å˜¿\")) print (f.write(\"å•¦å•¦\\nå¼å¼\")) f.flush() f.close() 5 5 5 txt.txtæ–‡ä»¶ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼Œå¹¶ä¸”å…‰æ ‡åœ¨æœ€å¼€å¤´ å‘µå‘µ å“ˆå“ˆå˜»å˜» å˜¿å˜¿å•¦å•¦ å¼å¼ 1.3.3 è¿½åŠ å†™ --> a a: è¿½åŠ å†™æ–‡æœ¬ f = open(\"txt.txt\",mode=\"a\",encoding=\"utf-8\") //è¿½åŠ å†™æ–‡æœ¬ åªä¼šåœ¨åŒä¸€è¡Œè¿½åŠ  f = open(\"txt.txt\",mode=\"a\",encoding=\"utf-8\") print (f.write(\"å‘µå‘µ\")) print (f.write(\"å“ˆå“ˆ\")) print (f.write(\"å˜¿å˜¿\")) txt.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼Œå¹¶ä¸”å…‰æ ‡åœ¨æœ€å¼€å¤´ å‘µå‘µå“ˆå“ˆå˜¿å˜¿ 1.3.4 åªè¯»å­—èŠ‚ --> rb âš ï¸äºŒè¿›åˆ¶æ–¹å¼è¯»å–æ–‡ä»¶ä¸èƒ½æŒ‡å®šå­—ç¬¦é›† f = open(\"txt.txt\",mode=\"rb\",encoding=\"utf-8\") print (f.read()) ValueError: binary mode doesn't take an encoding argument //txt.txtæ–‡ä»¶ä¸­çš„å†…å®¹ä¸º å‘µå‘µå“ˆå“ˆå˜¿å˜¿ f = open(\"txt.txt\",mode=\"rb\") print (f.read()) b'\\xe5\\x91\\xb5\\xe5\\x91\\xb5\\xe5\\x93\\x88\\xe5\\x93\\x88\\xe5\\x98\\xbf\\xe5\\x98\\xbf' ä»¥ä¸Šçš„å­—èŠ‚çš„å†…å®¹å°±æ˜¯ å‘µå‘µå“ˆå“ˆå˜¿å˜¿ 1.3.5 æ¸…ç©ºå†™å­—èŠ‚ --> wb 1. å­—èŠ‚å†…å®¹è¯´æ˜b'\\xe5\\x91\\xb5\\xe5\\x91\\xb5\\xe5\\x93\\x88\\xe5\\x93\\x88\\xe5\\x98\\xbf\\xe5\\x98\\xbf' txt.txtçš„å†…å®¹æ˜¯ å‘µå‘µå“ˆå“ˆå˜¿å˜¿ 2. æ¸…ç©ºtxt.txtæ–‡ä»¶ 3. f.write()æ‹¬å·ä¸­åªèƒ½å†™å­—èŠ‚ b'\\xxx'âš ï¸ f = open(\"txt.txt\",mode=\"wb\") f.write(b'\\xe5\\x91\\xb5\\xe5\\x91\\xb5\\xe5\\x93\\x88\\xe5\\x93\\x88\\xe5\\x98\\xbf\\xe5\\x98\\xbf') 4.æ­¤æ—¶txt.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹ å‘µå‘µå“ˆå“ˆå˜¿å˜¿ 1.3.6 è¿½åŠ å†™å­—èŠ‚ --> ab 1. å­—èŠ‚å†…å®¹è¯´æ˜b'\\xe5\\x91\\xb5\\xe5\\x91\\xb5\\xe5\\x93\\x88\\xe5\\x93\\x88\\xe5\\x98\\xbf\\xe5\\x98\\xbf' çš„å†…å®¹æ˜¯ å‘µå‘µå“ˆå“ˆå˜¿å˜¿ 2. txt.txtæ–‡ä»¶å†…å®¹æ˜¯ å‘µå‘µå“ˆå“ˆå˜¿å˜¿ 3. f.write()æ‹¬å·ä¸­åªèƒ½å†™å­—èŠ‚ b'\\xxx'âš ï¸ f = open(\"txt.txt\",mode=\"ab\") f.write(b'\\xe5\\x91\\xb5\\xe5\\x91\\xb5\\xe5\\x93\\x88\\xe5\\x93\\x88\\xe5\\x98\\xbf\\xe5\\x98\\xbf') 4.æ­¤æ—¶txt.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹,å·²æˆåŠŸè¿½åŠ  å‘µå‘µå“ˆå“ˆå˜¿å˜¿å‘µå‘µå“ˆå“ˆå˜¿å˜¿ 1.3.7 è¯»å†™ --> r+ txt.txtæ–‡ä»¶å†…å®¹ä¸º å‘µå‘µå“ˆå“ˆå˜¿å˜¿ f = open(\"txt.txt\",\"r+\",encoding=\"utf-8\") a = f.read() f.write(\"è¿™æ˜¯è¯»å†™\") å‘µå‘µå“ˆå“ˆå˜¿å˜¿ æ­¤æ—¶txt.txtæ–‡ä»¶å†…å®¹ä¸º å‘µå‘µå“ˆå“ˆå˜¿å˜¿è¿™æ˜¯è¯»å†™ 1.3.8 æ¸…ç©ºå†™è¯» --> w+ txt.txtæ–‡ä»¶å†…å®¹ä¸º å‘µå‘µå“ˆå“ˆå˜¿å˜¿ f = open(\"txt.txt\",\"w+\",encoding=\"utf-8\") print (f.write(\"æ¸…ç©ºå†™è¯»\")) print (f.read()) 4 æ­¤æ—¶txt.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼Œå¹¶ä¸”å…‰æ ‡åœ¨æœ€åè¾¹ æ¸…ç©ºå†™è¯» 1.3.9 è¿½åŠ å†™è¯» --> a+ txt.txtæ–‡ä»¶å†…å®¹ä¸º å‘µå‘µå“ˆå“ˆå˜¿å˜¿ f = open(\"txt.txt\",\"a+\",encoding=\"utf-8\") print (f.write(\"è¿½åŠ å†™è¯»\")) print (f.read()) æ­¤æ—¶txt.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼Œå¹¶ä¸”å…‰æ ‡åœ¨è¿½å­—å‰è¾¹ å‘µå‘µå“ˆå“ˆå˜¿å˜¿è¿½åŠ å†™è¯» 1.4 å…‰æ ‡æ“ä½œ txt.txtå†…å®¹ä¸º å‘µå‘µå“ˆå“ˆå˜¿å˜¿ å…‰æ ‡æ“ä½œæ€»ç»“ f = open(\"txt.txt\",\"r\",encoding=\"utf-8\") f.seek(0,0) #ç§»åŠ¨åˆ°æ–‡ä»¶å¤´éƒ¨ f.seek(0,1) #ç§»åŠ¨åˆ°å…‰æ ‡å½“å‰ä½ç½® f.seek(0,2) #ç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾ f.seek(3) #ç§»åŠ¨3ä¸ªå­—èŠ‚,æ ¹æ®ç¼–ç ä¸åŒå†³å®šç§»åŠ¨çš„å­—èŠ‚å¤§å° print(f.read()) print(f.tell()) #æŸ¥çœ‹å…‰æ ‡ è¿”å›çš„æ˜¯å­—èŠ‚ 1.5 with open with open 1.è‡ªåŠ¨å…³é—­æ–‡ä»¶ 2.å¯ä»¥åŒæ—¶æ“ä½œå¤šä¸ªæ–‡ä»¶ 3.as èµ·åˆ«å ç°åœ¨æœ‰ä¸¤ä¸ªæ–‡ä»¶ t1 t2ï¼Œt1å†…å®¹ä¸ºt1ï¼Œt2å†…å®¹ä¸ºt2 with open(\"t1\",\"r\",encoding=\"utf-8\") as f1, \\ open(\"t2\",\"r\",encoding=\"utf-8\") as f2: print (f1.read()) print (f2.read()) t1 t2 âš ï¸ä¸¤ä¸ªopenä¹‹é—´å¿…é¡»ä»¥é€—å·åˆ†éš”ï¼Œprintå¿…é¡»åœ¨withçš„ä¸‹ä¸€çº§ 1.6 ä¿®æ”¹æ–‡ä»¶ååŠæ–‡ä»¶å†…å®¹ 1.6.1 ä¿®æ”¹æ–‡ä»¶å ç°åœ¨æœ‰ä¸¤ä¸ªæ–‡ä»¶ t1 t2ï¼Œt1å†…å®¹ä¸ºt1ï¼Œt2å†…å®¹ä¸ºt2 ç°åœ¨æƒ³æŠŠä¸¤ä¸ªæ–‡ä»¶åäº’æ¢ å³t1 --> t2 t2 --> t1 è½¬æ¢æ€è·¯ï¼Œå°†t1æ”¹åä¸ºä¸´æ—¶æ–‡ä»¶t3ï¼Œç„¶åæŠŠt2æ”¹åä¸ºt1ï¼Œæœ€åæŠŠt3æ”¹åä¸ºt1ï¼Œå³ t1 --> t3 t2 --> t1 t3 --> t2 import os # ä¸æ“ä½œç³»ç»Ÿåšäº¤äº’ os.rename(\"t1\",\"t3\") os.rename(\"t2\",\"t1\") os.rename(\"t3\",\"t2\") æ­¤æ—¶t1å†…å®¹ä¸ºt2ï¼Œt2å†…å®¹ä¸ºt1 1.6.2 ä¿®æ”¹æ–‡ä»¶å†…å®¹ t1çš„å†…å®¹å¦‚ä¸‹ abc okm tgb ç°åœ¨è¦æŠŠt1ä¸­çš„bæ›¿æ¢æˆâ€œå‘µå‘µâ€ æ›¿æ¢æ€è·¯ï¼Œæ‹·è´t1ä¸ºt2ï¼Œâš ï¸å°½é‡ä¸åœ¨åŸæ–‡ä»¶ä¿®æ”¹ âš ï¸æ–‡æœ¬ä¸­å­˜å‚¨çš„éƒ½æ˜¯å­—ç¬¦ä¸² with open(\"t1\",\"r\",encoding=\"utf-8\")as f,\\ open(\"t2\",\"w\",encoding=\"utf-8\")as f1: for i in f: f1.write(i.replace(\"b\",\"å‘µå‘µ\")) f1.flush() æ­¤æ—¶t2å†…å®¹å¦‚ä¸‹ï¼Œå·²ç»å°†t1ä¸­çš„bæ›¿æ¢æˆäº†å‘µå‘µ aå‘µå‘µc okm tgå‘µå‘µ å› ä¸ºt1æ˜¯è¯»çš„ï¼Œt2æ‰æ˜¯å†™çš„æ–‡ä»¶ï¼Œç°åœ¨çš„éœ€æ±‚æ˜¯t1ä¸­ä¿®æ”¹ï¼Œå› æ­¤è¿˜éœ€è¦è½¬æ¢ä¸€ä¸‹æ–‡ä»¶å å³æŠŠt1ä¸t2çš„æ–‡ä»¶åç›¸äº’æ›¿æ¢ï¼Œè¿™æ ·æ‰èƒ½è¾¾åˆ°éœ€æ±‚ï¼ŒåŒæ—¶æ”¹ååçš„æºæ–‡ä»¶t2ä¸è¦åˆ é™¤ import os # ä¸æ“ä½œç³»ç»Ÿåšäº¤äº’ os.rename(\"t1\",\"t3\") os.rename(\"t2\",\"t1\") os.rename(\"t3\",\"t2\") æ­¤æ—¶t1æ–‡ä»¶å†…å®¹å¦‚ä¸‹ aå‘µå‘µc okm tgå‘µå‘µ t2æ–‡ä»¶å†…å®¹å¦‚ä¸‹ abc okm tgb #æ–‡ä»¶æ›¿æ¢å†…å®¹æ­¥éª¤æ€»ç»“ 1.ä¸è¦åœ¨åŸæ–‡ä»¶æ“ä½œï¼Œéœ€è¦æ‹·è´ä¸€ä¸ªæ–‡ä»¶ 2.è¯»åŸæ–‡ä»¶ï¼Œæ”¹æ‹·è´çš„æ–‡ä»¶ 3.æ”¹å®Œæ‹·è´çš„æ–‡ä»¶åå†æ›¿æ¢æ–‡ä»¶å 4.ä¿ç•™æ›¿æ¢æ–‡ä»¶ååçš„åŸæ–‡ä»¶ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/11.pythonåŸºç¡€åä¸€ å‡½æ•°.html":{"url":"python/pythonåŸºç¡€/11.pythonåŸºç¡€åä¸€ å‡½æ•°.html","title":"pythonåŸºç¡€åä¸€ å‡½æ•°","keywords":"","body":"pythonåŸºç¡€åä¸€ å‡½æ•° 1.å‡½æ•°çš„ä½œç”¨ å°è£…ä»£ç ,å¤§é‡çš„å‡å°‘é‡å¤ä»£ç ,é‡ç”¨æ€§é«˜ 2.å‡½æ•°çš„å®šä¹‰ def å‡½æ•°å(): å‡½æ•°ä½“ def æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œç”³æ˜è¦å®šä¹‰ä¸€ä¸ªå‡½æ•° ():æ˜¯å›ºå®šå†™æ³• å‡½æ•°ä½“ä¸­å†™çš„æ˜¯éœ€è¦ç”¨åˆ°çš„é‡å¤ä»£ç  3.å‡½æ•°çš„è°ƒç”¨ å‡½æ•°å() 4.å‡½æ•°çš„è¿”å›å€¼ #å‡½æ•°è¿”å›å€¼æ€»ç»“ å‡½æ•°ä½“ä¸­ä¸å†™returné»˜è®¤è¿”å›None,æˆ–è€…å†™äº†returnä¸å†™å€¼è¿”å›çš„ä¹Ÿæ˜¯None return èƒ½å¤Ÿè¿”å›ä»»æ„æ•°æ®ç±»å‹(pythonä¸­æ‰€æœ‰å¯¹è±¡) return èƒ½å¤Ÿè¿”å›å¤šä¸ªæ•°æ®ç±»å‹,ä»¥å…ƒç»„çš„å½¢å¼æ¥æ”¶ return èƒ½å¤Ÿç»ˆæ­¢å‡½æ•°,returnä¸‹æ–¹çš„ä»£ç ä¸æ‰§è¡Œ return å°†è¿”å›å€¼è¿”å›ç»™è°ƒç”¨è€… //returnç¤ºä¾‹ def func(): a = 10 return a a = func() print(a) 5.å‡½æ•°çš„å‚æ•° 5.1ä½ç½®å‚æ•° //å‡½æ•°å‚æ•°ç¤ºä¾‹ def hehe(app): //å½¢å‚æ•° print (\"æ‰“å¼€:\",app) //æ³¨æ„å¿…é¡»ç”¨é€—å·éš”å¼€ hehe(\"å¾®ä¿¡\") //å®å‚ æ‰§è¡Œç»“æœè¿”å›å¦‚ä¸‹ï¼š æ‰“å¼€: å¾®ä¿¡ //ä½ç½®å‚æ•°ç¤ºä¾‹ def ball(web, players, age, addr): #å½¢å‚ print(\"ç™»é™†NBAå®˜ç½‘\") print(f\"æ‰“å¼€{web}\") print(f\"æ‰¾ä¸€ä½{players},è¦æ±‚å¹´é¾„:{age},åœ°åŒº:{addr}çš„äºº\") print(\"çœ‹çœ‹è§†é¢‘\") print(\"å­¦å­¦çƒæŠ€\") ball(\"è§†é¢‘ä¸“åŒº\", \"çƒå‘˜\", 28, \"æ´›æ‰çŸ¶\") #å®å‚ æŒ‰ç…§ä½ç½®ä¼ å‚ ç™»é™†NBAå®˜ç½‘ æ‰“å¼€è§†é¢‘ä¸“åŒº æ‰¾ä¸€ä½çƒå‘˜,è¦æ±‚å¹´é¾„:28,åœ°åŒº:æ´›æ‰çŸ¶çš„äºº çœ‹çœ‹è§†é¢‘ å­¦å­¦çƒæŠ€ 5.2 é»˜è®¤å‚æ•° //é»˜è®¤å‚æ•°ç¤ºä¾‹ def ball(web, players, age, addr=\"æ´›æ‰çŸ¶\"): #addr=\"æ´›æ‰çŸ¶\"è¡¨ç¤ºé»˜è®¤å‚æ•° print(\"ç™»é™†NBAå®˜ç½‘\") print(f\"æ‰“å¼€{web}\") print(f\"æ‰¾ä¸€ä½{players},è¦æ±‚å¹´é¾„:{age},åœ°åŒº:{addr}çš„äºº\") print(\"çœ‹çœ‹è§†é¢‘\") print(\"å­¦å­¦çƒæŠ€\") ball(\"è§†é¢‘ä¸“åŒº\", \"çƒå‘˜\", 28) #å®å‚è¿™é‡Œå¯ä¸å†™å½¢å‚ä¸­å®šä¹‰çš„é»˜è®¤å€¼ ball(\"è§†é¢‘ä¸“åŒº\",\"çƒå‘˜\",30,\"æ³¢å£«é¡¿\") #å®å‚å†™å†…å®¹ä¼šè¦†ç›–å½¢å‚ä¸­å®šä¹‰çš„é»˜è®¤å‚æ•° ç™»é™†NBAå®˜ç½‘ æ‰“å¼€è§†é¢‘ä¸“åŒº æ‰¾ä¸€ä½çƒå‘˜,è¦æ±‚å¹´é¾„:28,åœ°åŒº:æ´›æ‰çŸ¶çš„äºº çœ‹çœ‹è§†é¢‘ å­¦å­¦çƒæŠ€ ç™»é™†NBAå®˜ç½‘ æ‰“å¼€è§†é¢‘ä¸“åŒº æ‰¾ä¸€ä½çƒå‘˜,è¦æ±‚å¹´é¾„:30,åœ°åŒº:æ³¢å£«é¡¿çš„äºº çœ‹çœ‹è§†é¢‘ å­¦å­¦çƒæŠ€ 5.3 å…³é”®å­—ä¼ å‚ //å…³é”®å­—ä¼ å‚ç¤ºä¾‹ def fun(a,b,c=1,d=2): print (a,b,c,d) fun(1,2,3,4) //ç»“æœæ˜¯1 2 3 4 fun(a=\"å‘µå‘µ\",b=\"å“ˆå“ˆ\") //ç»“æœæ˜¯å‘µå‘µ å“ˆå“ˆ 1 2 fun(1,2,d=\"å‘µå‘µ\") //ç»“æœæ˜¯1 2 1 å‘µå‘µ 5.4 åŠ¨æ€å‚æ•° *args 5.4.1 åŠ¨æ€å‚æ•°ä½œç”¨ 1.èƒ½å¤Ÿæ¥å—ä¸å›ºå®šé•¿åº¦çš„å‚æ•° 2.ä½ç½®å‚æ•°è¿‡å¤šæ—¶å¯ä»¥ä½¿ç”¨åŠ¨æ€å‚æ•° 5.4.2 åŠ¨æ€å‚æ•°ä½¿ç”¨æ–¹æ³• def func(*c): #å½¢å‚ä½ç½®ä¸Šçš„*æ˜¯èšåˆ print(*c) #å‡½æ•°ä½“ä¸­çš„*å°±æ˜¯æ‰“æ•£ func(1,2,3,4,5,6,7,8,9,0) ç»“æœå¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 0 def func(a,b,*c): # *cå°±è¡¨ç¤ºåŠ¨æ€å‚æ•° print (a,b,*c) func(1,2,3,4,5,6,7,8) 1 2 3 4 5 6 7 8 5.5 åŠ¨æ€å…³é”®å­—å‚æ•° **kwages 5.5.1 åŠ¨æ€å…³é”®å­—å‚æ•°ä½œç”¨ åªæ¥æ”¶å¤šä½™çš„åŠ¨æ€ä½ç½®å‚æ•° æ³¨æ„æ˜¯åªæ¥æ”¶ 5.5.2 åŠ¨æ€å…³é”®å­—å‚æ•°ä½¿ç”¨æ–¹æ³• //åŠ¨æ€å…³é”®å­—ä½¿ç”¨æ–¹æ³•ç¤ºä¾‹1 def func(a,b,**kwargs): print (kwargs) func(a=1,b=2,c=3,d=4,e=5) ç»“æœå¦‚ä¸‹ï¼š {'c': 3, 'd': 4, 'e': 5} //åŠ¨æ€å…³é”®å­—å‚æ•°ä½¿ç”¨æ–¹æ³•ç¤ºä¾‹2 dic = {\"key\": 1, \"key2\": 2} def func(**kwargs): #èšåˆ print(kwargs) #æ‰“æ•£ func(**dic) #æ‰“æ•£ func(key=1,key2=2) ç»“æœå¦‚ä¸‹ï¼š {'key': 1, 'key2': 2} 5.6 å‡½æ•°å‚æ•°é¢è¯•é¢˜ #ä¸‡èƒ½ä¼ å‚ def func(*args, **kwargs): print(args, kwargs) func(12, 2, 121, 12, 321, 3, a=1, b=2) ç»“æœå¦‚ä¸‹ (12, 2, 121, 12, 321, 3) {'a': 1, 'b': 2} *xargsè·å–çš„æ˜¯ä¸€ä¸ªå…ƒç»„ **kwargsè·å–çš„æ˜¯ä¸€ä¸ªå­—å…¸ #*argså’Œ**kwargs def func(*args, a1=8,**kwargs): #ä¸‡èƒ½ä¼ å‚ print(args, kwargs) #å‡½æ•°ä½“ä¸­çš„*argsæ˜¯å°†å…ƒç»„æ‰“æ•£,*kwargsæ˜¯å°†å­—å…¸çš„é”®è·å–åˆ° func(12, 2, a1=1, b1=2) ç»“æœå¦‚ä¸‹ï¼š (12, 2) {'b1': 2} 5.7 å‡½æ•°å‚æ•°æ€»ç»“ #å‚æ•°çš„æ€»ç»“: 1.å½¢å‚ åœ¨å®šä¹‰å‡½æ•°çš„é˜¶æ®µå°±æ˜¯å½¢å‚ å¯ä»¥å•ç‹¬ä½¿ç”¨ä½ç½®å‚æ•°,ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨é»˜è®¤å‚æ•°,ä¹Ÿå¯ä»¥æ··åˆä½¿ç”¨ ä½ç½®ä¼ å‚:å¿…é¡»ä¸€ä¸€å¯¹åº” é»˜è®¤å‚æ•°:å¯ä»¥ä¸ä¼ å‚,å¯ä»¥ä¼ å‚,ä¼ å‚å°±æ˜¯æŠŠé»˜è®¤çš„å€¼ç»™è¦†ç›– æ··åˆä½¿ç”¨:ä½ç½®å‚æ•°,é»˜è®¤å‚æ•° 2.å®å‚ åœ¨è°ƒç”¨å‡½æ•°çš„é˜¶æ®µå°±æ˜¯å®å‚ å¯ä»¥å•ç‹¬ä½¿ç”¨ä½ç½®å‚æ•°,ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨å…³é”®å­—å‚æ•°,ä¹Ÿå¯ä»¥æ··åˆä½¿ç”¨ ä½ç½®ä¼ å‚:å¿…é¡»ä¸€ä¸€å¯¹åº” å…³é”®å­—å‚æ•°:æŒ‡åé“å§“çš„æ–¹å¼è¿›è¡Œä¼ å‚ æ··åˆä½¿ç”¨:ä½ç½®å‚æ•°,é»˜è®¤å‚æ•° 3.å‚æ•°æ€»ç»“ ä½ç½®å‚æ•°,åŠ¨æ€ä½ç½®,é»˜è®¤å‚æ•°,åŠ¨æ€å…³é”®å­—å‚æ•° *args ç¨‹åºå‘˜ä¹‹é—´çº¦å®šä¿—ç§°(å¯ä»¥æ›´æ¢ä½†æ˜¯ä¸å»ºè®®æ›´æ¢) **kwargs ç¨‹åºå‘˜ä¹‹é—´çº¦å®šä¿—ç§°(å¯ä»¥æ›´æ¢ä½†æ˜¯ä¸å»ºè®®æ›´æ¢) *args è·å–çš„æ˜¯ä¸€ä¸ªå…ƒç»„ **kwargs è·å–çš„æ˜¯ä¸€ä¸ªå­—å…¸ *args åªæ¥å—å¤šä½™çš„ä½ç½®å‚æ•° **kwargs åªæ¥å—å¤šä½™çš„å…³é”®å­—å‚æ•° 4.å‡½æ•°å‚æ•°ä¼˜å…ˆçº§ æ•°å‚æ•°ä¼˜å…ˆçº§: ä½ç½®å‚æ•° > åŠ¨æ€ä½ç½®å‚æ•°(å¯å˜ä½ç½®å‚æ•°) > é»˜è®¤å‚æ•° > åŠ¨æ€å…³é”®å­—å‚æ•°(å¯å˜å…³é”®å­—å‚æ•°) 6.å‡½æ•°çš„æ³¨é‡Š #æ³¨é‡Šæ–¹æ³•1 def a(a,b): \"\"\" æ•°å­—åŠ æ³•è¿ç®— :param a: int :param b: int :return: int \"\"\" return a + b print (a(1,2)) #æ³¨é‡Šæ–¹æ³•2 def func(a:int,b:int): #è¿™é‡Œçš„a:intåªæ˜¯åšåˆ°ä¸€ä¸ªçº¦æŸï¼Œå¹¶æ²¡æœ‰å®é™…ä½œç”¨ \"\"\" åŠ æ³•è¿ç®— :param a: :param b: :return: \"\"\" return a + b print (func(1,2)) //æŸ¥çœ‹å‡½æ•°çš„æ³¨é‡Š func.__doc__ print (func.__doc__) åŠ æ³•è¿ç®— :param a: :param b: :return: //æŸ¥çœ‹å‡½æ•°çš„åå­— a.__name__ ä»£ç åœ¨ç¼–å†™è¿‡ç¨‹ä¸­ä¼šè®¾è®¡åˆ°å‡½æ•°åèµ‹å€¼ï¼Œä¾‹å¦‚ def func(a,b): return a + b a = func print (a(1,2)) print (a.__name__) func 7.å‡½æ•°çš„åç§°ç©ºé—´ 7.1å‡½æ•°åç§°ç©ºé—´åˆ†ç±» 1.å†…ç½®ç©ºé—´ -- å­˜æ”¾pyhtonè‡ªå¸¦ä¸€äº›å‡½æ•° 2.å…¨å±€ç©ºé—´ -- å½“å‰pyæ–‡ä»¶é¡¶æ ¼ç¼–å†™çš„ä»£ç å¼€è¾Ÿçš„ç©ºé—´ 3.å±€éƒ¨ç©ºé—´ -- å‡½æ•°å¼€è¾Ÿçš„ç©ºé—´ ç¨‹åºåŠ è½½é¡ºåº: å†…ç½®ç©ºé—´ > å…¨å±€ç©ºé—´ > å±€éƒ¨ç©ºé—´ ç¨‹åºå–å€¼é¡ºåº: å±€éƒ¨ç©ºé—´ > å…¨å±€ç©ºé—´ > å†…ç½®ç©ºé—´ //ä»£ç ç¤ºä¾‹ a = 10 #è¿™é‡Œçš„10æ˜¯å…¨å±€å˜é‡ def func(): a = 5 #è¿™é‡Œçš„5æ˜¯å±€éƒ¨å˜é‡ print (a) print (func()) 5 None 7.2å‡½æ•°çš„ä½œç”¨åŸŸ 1.å…¨å±€ä½œç”¨åŸŸ: å†…ç½® + å…¨å±€ globals() #æŸ¥çœ‹å…¨å±€ä½œç”¨åŸŸ 2.å±€éƒ¨ä½œç”¨åŸŸ: å±€éƒ¨ locals() #æŸ¥çœ‹å½“å‰ä½œç”¨åŸŸ(å»ºè®®æŸ¥çœ‹å±€éƒ¨) //ä»£ç ç¤ºä¾‹ æŸ¥çœ‹å…¨å±€ a = 10 b = 20 print (globals()) {'__name__': '__main__', '__doc__': None, '__package__': None, '__loader__': , '__spec__': None, '__annotations__': {}, '__builtins__': , '__file__': '/jetBrains/pycharm/python-works/pythonåŸºç¡€/test.py', '__cached__': None, 'a': 10, 'b': 20} //ä»£ç ç¤ºä¾‹ æŸ¥çœ‹å±€éƒ¨ def func(): a = 10 print (locals()) func() {'a': 10} 8.å‡½æ•°çš„ç¬¬ä¸€ç±»å¯¹è±¡ 8.1æ€»æ¦‚ 1.å‡½æ•°åå¯ä»¥å½“åšå€¼,èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ 2.å‡½æ•°åå¯ä»¥å½“åšå¦ä¸€ä¸ªå‡½æ•°çš„å‚æ•°æ¥ä½¿ç”¨ 3.å‡½æ•°åå¯ä»¥å½“åšå¦ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ 4.å‡½æ•°åå¯ä»¥å½“åšå…ƒç´ å­˜å‚¨åœ¨å®¹å™¨ä¸­ 8.2 å‡½æ•°åå¯ä»¥å½“ä½œå€¼ï¼Œèµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ //ä»£ç ç¤ºä¾‹ def func(): print(1) a = func #å‡½æ•°åæ˜¯funcï¼Œç„¶åèµ‹å€¼ç»™äº†aï¼Œæ‰“å°aä¸funcçš„å‡½æ•°å†…å­˜ç©ºé—´åœ°å€ä¸€æ ·ï¼Œå¹¶ä¸”æ‰§è¡Œa()ç›¸å½“äºæ‰§è¡Œfunc() print(func) #å‡½æ•°çš„å†…å­˜åœ°å€ print(a) #å‡½æ•°çš„å†…å­˜åœ°å€ a() #ç»“æœ 1 8.3 å‡½æ•°åå¯ä»¥å½“ä½œå¦ä¸€ä¸ªå‡½æ•°çš„å‚æ•°æ¥ä½¿ç”¨ //ä»£ç ç¤ºä¾‹ def func(): print(1) def foo(a): #a = func print(a) #funcè¿™ä¸ªå‡½æ•°çš„å†…å­˜åœ°å€ foo(func) funcå‡½æ•°å½“ä½œäº†fooå‡½æ•°çš„å‚æ•° 8.4 å‡½æ•°åå¯ä»¥å½“ä½œå¦ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ //ä»£ç ç¤ºä¾‹ def func(): return 1 #print def foo(a): #a = funcå‡½æ•°çš„å†…å­˜åœ°å€ return a #return funcå‡½æ•°çš„å†…å­˜åœ°å€ cc = foo(func) print(cc) #funcå‡½æ•°çš„å†…å­˜åœ°å€ 8.5 å‡½æ•°åå¯ä»¥å½“ä½œå…ƒç´ å­˜å‚¨åœ¨å®¹å™¨ä¸­ å®¹å™¨ï¼šå­—å…¸ã€å…ƒç»„ã€åˆ—è¡¨ã€é›†åˆ //ä»£ç ç¤ºä¾‹ def func(): print(1) def foo(): print(2) def f(): print(3) lst = [func,foo,f] âš ï¸å°†å‡½æ•°æ”¾åœ¨å®¹å™¨ä¸­çš„å¥½å¤„ï¼Œå¯ä»¥ä½¿ç”¨forå¾ªç¯æ‰¹é‡æ‰§è¡Œå‡½æ•°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œ for i in lst: i() 1 2 3 //ä»£ç ç¤ºä¾‹ è´­ç‰©å¹³å° âš ï¸æ•´ä½“æ€è·¯ 1.å®šä¹‰5ä¸ªå‡½æ•°ï¼Œæ¨¡æ‹Ÿè´­ç‰©å¹³å°æ³¨å†Œã€ç™»é™† 2.å°†è¿™5ä¸ªæ­¥éª¤çš„å‡½æ•°å­˜å…¥å­—å…¸ä¸­ 3.è®©ç”¨æˆ·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œï¼Œç„¶åæ‰§è¡Œå‡½æ•°å®ŒæˆåŠŸèƒ½å®ç° def register(): print(\"æ³¨å†Œ\") def login(): print(\"ç™»å½•\") def shopping(): print(\"æµè§ˆå•†å“\") def add_shopping_car(): print(\"åŠ å…¥è´­ç‰©è½¦\") def buy_goods(): print(\"è´­ä¹°\") msg = \"\"\" 1.æ³¨å†Œ 2.ç™»å½• 3.æµè§ˆå•†å“ 4.åŠ å…¥è´­ç‰©è½¦ 5.è´­ä¹° è¯·è¾“å…¥æ‚¨è¦é€‰æ‹©çš„åºå·: \"\"\" func_dic = {\"1\": register, \"2\": login, \"3\": shopping, \"4\": add_shopping_car, \"5\": buy_goods} while True: choose = input(msg) if choose in func_dic: func_dic[choose]() else: print(\"é€€å‡ºå•†åŸ\") 9.å‡½æ•°çš„åµŒå¥— 9.1 åˆ†ç±» 1.äº¤å‰åµŒå¥— 2.åµŒå¥— 9.2 äº¤å‰åµŒå¥— 9.2.1 äº¤å‰åµŒå¥—ç¤ºä¾‹1 def func(foo): print (1) foo() print (3) def a(): print (1) func(a) 1 1 3 ä¸Šè¿°ä»£ç è¿›ä¸€æ­¥è¯´æ˜ def func(foo): print(1) v = foo() #ç¬¬ä¸€ä¸ªåŠŸèƒ½æ˜¯è°ƒç”¨å‡½æ•°,ç¬¬äºŒä¸ªåŠŸèƒ½æ˜¯æ¥æ”¶è¿”å›å€¼ #v = None #print(v) #None print(3) 1 1 None 3 9.2.2 äº¤å‰åµŒå¥—ç¤ºä¾‹2 //ä»£ç ç¤ºä¾‹ def func(): print(1) print(\"å¤ªéš¾\") print(2) def foo(b): print(3) b() print(4) def f(a,b): a(b) f(foo,func) æœ€ç»ˆç»“æœ 3 1 å¤ªéš¾ 2 4 9.2.3 äº¤å‰åµŒå¥—ç¤ºä¾‹3 def func(a,b): def foo(b,a): print(b,a) return foo(a,b) a = func(4,7) print(a) ç»“æœ 4 7 None 9.2.4 äº¤å‰åµŒå¥—ç¤ºä¾‹4 //ä»£ç ç¤ºä¾‹1 def func(a,b): a = a + b b = a + 10 def foo(a,d): def f(e,f): print(f,e) return \"å‘µå‘µ\" f(d,a) foo(b,a) print(func(2,3)) ç»“æœ 15 5 None âš ï¸return \"å‘µå‘µ\"è¿”å›ç»™äº†fï¼Œfæ˜¯fooå‡½æ•°çš„æœ€åä¸€è¡Œï¼Œé»˜è®¤è¿”å›Noneï¼Œfooåˆæ˜¯funcå‡½æ•°çš„æœ€åä¸€è¡Œï¼Œé»˜è®¤è¿”å›None //ä»£ç ç¤ºä¾‹2 def func(a,b): a = a + b b = a + 10 def foo(a,d): def f(e,f): print(f,e) return \"å‘µå‘µ\" return f(d,a) return foo(b,a) print(func(2,3)) ç»“æœ 15 5 å‘µå‘µ 10. å‡½æ•°å…³é”®å­—globalä¸nonlocal 10.1 global global 1.globalåªä¿®æ”¹å…¨å±€ç©ºé—´ä¸­çš„å˜é‡ 2.åœ¨å±€éƒ¨ç©ºé—´ä¸­å¯ä»¥ä½¿ç”¨å…¨å±€ä¸­çš„å˜é‡,ä½†æ˜¯ä¸èƒ½ä¿®æ”¹,å¦‚æœè¦å¼ºåˆ¶ä¿®æ”¹éœ€è¦æ·»åŠ global 3.å½“å˜é‡åœ¨å…¨å±€å­˜åœ¨æ—¶globalå°±æ˜¯ç”³æ˜æˆ‘è¦ä¿®æ”¹å…¨å±€çš„å˜é‡,å¹¶ä¸”ä¼šåœ¨å±€éƒ¨å¼€è¾Ÿè¿™ä¸ªå˜é‡ 4.å½“å˜é‡åœ¨å…¨å±€ä¸­ä¸å­˜åœ¨æ—¶globalå°±æ˜¯ç”³æ˜è¦åœ¨å…¨å±€åˆ›å»ºä¸€ä¸ªå˜é‡,å¹¶ä¸”ä¼šåœ¨å±€éƒ¨å¼€è¾Ÿè¿™ä¸ªå˜é‡ 1.å‡½æ•°ä¸­åŠ å…³é”®å­—globalå¯¹å…¨å±€å˜é‡è¿›è¡Œä¿®æ”¹ //ä¸åŠ globalå…³é”®å­— a = 10 def func(): a += 1 func() print(a) ç»“æœæŠ¥é”™ UnboundLocalError: local variable 'a' referenced before assignment å½“å…¨å±€å˜é‡aå­˜åœ¨æ—¶ //ä½¿ç”¨glboalå…³é”®å­—ï¼Œglobalå…³é”®å­—ç”³æ˜å˜é‡aæ˜¯å…¨å±€å˜é‡ a = 10 def func(): global a #ç”³æ˜è¦ä¿®æ”¹å…¨å±€çš„å˜é‡a a += 1 func() print(a) ç»“æœï¼š 11 å½“å…¨å±€å˜é‡aä¸å­˜åœ¨æ—¶ //ä½¿ç”¨globalå…³é”®å­—ç”³æ˜å¹¶åˆ›å»ºå…¨å±€å˜é‡a def func(): global a a = 10 func() print(a) ç»“æœï¼š 10 å½“å˜é‡åœ¨å…¨å±€å­˜åœ¨æ—¶globlaå°±æ˜¯ç”³æ˜æˆ‘è¦ä¿®æ”¹å…¨å±€å˜é‡ï¼Œå¹¶ä¸”ä¼šåœ¨å±€éƒ¨å¼€è¾ŸåŒåå˜é‡ å½“å˜é‡åœ¨å…¨å±€ä¸å­˜åœ¨æ—¶globalå°±æ˜¯ç”³æ˜è¦åœ¨å…¨å±€åˆ›å»ºä¸€ä¸ªå˜é‡ 10.2 nonlocal nonlocal 1.nonlocalåªä¿®æ”¹å±€éƒ¨ç©ºé—´ä¸­çš„å˜é‡,æœ€å¤–å±‚çš„ä¸€ä¸ªå‡½æ•° 2.åªä¿®æ”¹ç¦»nonlocalæœ€è¿‘çš„ä¸€å±‚,å¦‚æœè¿™ä¸€å±‚æ²¡æœ‰å°±å¾€ä¸Šä¸€å±‚æŸ¥æ‰¾,åªèƒ½åœ¨å±€éƒ¨ 3.nonlocal ä¸èƒ½è¿›è¡Œåˆ›å»º nonlocalåªä¿®æ”¹å±€éƒ¨ç©ºé—´ä¸­çš„å˜é‡ï¼Œæœ€å¤–å±‚çš„ä¸€ä¸ªå‡½æ•° åªä¿®æ”¹ç¦»nonlocalæœ€è¿‘çš„ä¸€å±‚å‡½æ•°ï¼Œå¦‚æœè¿™ä¸€å±‚æ²¡æœ‰å°±å¾€ä¸Šä¸€å±‚æŸ¥æ‰¾ï¼Œåªèƒ½åœ¨å±€éƒ¨ //ä»£ç ç¤ºä¾‹1 def func(): a = 10 def foo(): a = 20 def f(): nonlocal a a += 1 print(a) f() foo() func() ç»“æœï¼š 21 //ä»£ç ç¤ºä¾‹2 a = 15 def func(): a = 10 def foo(): def f(): nonlocal a a += 1 print(a) #11 print(a) #10 f() foo() print(a) #11 func() print(a) #15 ç»“æœï¼š 10 11 11 15 globalä¸nonlocalç»“åˆç¤ºä¾‹ a = 10 def func(): a = 5 def foo(): a = 3 def f(): nonlocal a a += 1 def aa(): a = 1 def bb(): global a a += 1 print(a) #11 bb() print(a) #1 aa() print(a) #4 f() print(a) #4 foo() print(a) #5 func() print(a) #11 ç»“æœï¼š 11 1 4 4 5 11 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/12.pythonåŸºç¡€åäºŒ è¿­ä»£å™¨ã€ç”Ÿæˆå™¨.html":{"url":"python/pythonåŸºç¡€/12.pythonåŸºç¡€åäºŒ è¿­ä»£å™¨ã€ç”Ÿæˆå™¨.html","title":"pythonåŸºç¡€åäºŒ è¿­ä»£å™¨ã€ç”Ÿæˆå™¨","keywords":"","body":"pythonåŸºç¡€åäºŒ è¿­ä»£å™¨ã€ç”Ÿæˆå™¨ 1.è¿­ä»£å™¨ 1.1 å«ä¹‰ ä¸€ä¸ªä¸€ä¸ªå–å€¼ 1.2 å¯è¿­ä»£å¯¹è±¡ #Pythonä¸­è§„å®š,åªè¦æ˜¯å…·æœ‰__iter__()æ–¹æ³•å°±æ˜¯å¯è¿­ä»£å¯¹è±¡ str.__iter__() list.__iter__() tuple.__iter__() dict.__iter__() set.__iter__() âš ï¸å¯è¿­ä»£å¯¹è±¡èƒ½å¤Ÿé‡å¤å–å€¼ 1.3 è¿­ä»£å™¨ä½¿ç”¨ç¤ºä¾‹ //ä½¿ç”¨ç¤ºä¾‹1 å°†è¿­ä»£å™¨èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œè¿™æ ·å°±èƒ½é‡å¤å–å€¼äº† å¯è¿­ä»£å¯¹è±¡èƒ½å¤Ÿé‡å¤å–å€¼ lst = [1,1,2] å°†å¯è¿­ä»£å¯¹è±¡è½¬æ¢æˆè¿­ä»£å™¨ l = lst.__iter__() print(l) #ç»“æœï¼šï¼Œè¿­ä»£å™¨çš„å†…å­˜ç©ºé—´åœ°å€ print(l.__next__()) #ç»“æœï¼š1 print(l.__next__()) #ç»“æœï¼š1 print(l.__next__()) #ç»“æœï¼š2 print(1.__next__()) #ç»“æœï¼šStopIteration åœæ­¢è¿­ä»£ï¼Œä¸èƒ½è¶…è¿‡å…ƒç´ ä¸ªæ•° âš ï¸æœ‰å¤šå°‘ä¸ªå…ƒç´ å°±åªèƒ½nextå¤šå°‘æ¬¡ //ä½¿ç”¨ç¤ºä¾‹1 å•ç‹¬æ‰§è¡Œè¿­ä»£å™¨ï¼Œè¿™æ ·æ¯æ¬¡åªèƒ½å–ç¬¬ä¸€ä¸ªå€¼ lst = [1,1,2,4,5] âš ï¸ä»¥ä¸‹ä¸¤ä¸ªlst.__iter__()è¿­ä»£å™¨å†…å­˜åœ°å€ï¼Œmacä¸­æ˜¾ç¤ºçš„æ˜¯ä¸€æ ·ï¼Œwinæœ¬æœ‰çš„ä¸€æ ·ï¼Œæœ‰çš„ä¸ä¸€æ ·ï¼ï¼ï¼ print(lst.__iter__()) # print(lst.__iter__()) # print(lst.__iter__().__next__()) #ç»“æœï¼š1 #lst.__iter__() æ˜¯ä¸€ä¸ªè¿­ä»£å™¨1 print(lst.__iter__().__next__()) #ç»“æœï¼š1 #lst.__iter__() æ˜¯ä¸€ä¸ªè¿­ä»£å™¨1 âš ï¸è¿™é‡Œè¿­ä»£å™¨æ˜¯å¤šä¸ª 1.4 forå¾ªç¯æœ¬è´¨ âš ï¸âš ï¸âš ï¸forå¾ªç¯å°±æ˜¯ä¸€ä¸ªè¿­ä»£å™¨ s = \"hehe\" for i in s: print (i) h e h e s = \"hehe\" s1 = s.__iter__() while True: print (s1.__next__()) ç»“æœä¼šæŠ¥é”™å¦‚ä¸‹ï¼šåœæ­¢è¿­ä»£ StopIteration s = \"hehe\" s1 = s.__iter__() while True: try: #å°è¯•ç€è¿è¡Œä¸€ä¸‹ç¼©è¿›ä½“ä¸­çš„å†…å®¹ï¼Œå¦‚æœè¿è¡Œæœ‰é—®é¢˜ç”¨exceptæ¥æ”¶ä¸€ä¸‹ print (s1.__next__()) except StopIteration: break ç»“æœå¦‚ä¸‹ï¼š h e h e 1.5 python3ä¸­è¿­ä»£å™¨ç”¨æ³• //python1å’Œpython2ä¸­è¿­ä»£å™¨å…±åŒç”¨æ³• lst = ['a',1,2,4,5] print (iter(lst)) print (iter(lst)) print (iter(lst).__next__()) print (iter(lst).__next__()) ç»“æœå¦‚ä¸‹ï¼š a a //python1ä¸­æ”¯æŒ__iter__()æ–¹æ³• //python1ä¸­ä¸æ”¯æŒ __next__()æ–¹æ³• 2.ç”Ÿæˆå™¨ 2.1 ç”Ÿæˆå™¨å«ä¹‰ æ§åˆ¶å¾ªç¯è¿­ä»£è¡Œä¸ºï¼Œä¸€è¾¹å¾ªç¯ä¸€è¾¹è®¡ç®—çš„ç‰¹æ®Šç¨‹åº ä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«100ä¸‡å…ƒç´ çš„åˆ—è¡¨ï¼Œä¸ä»…å ç©ºé—´ã€‚è€Œä¸”å¦‚æœåªè®¿é—®å‰è¾¹å‡ ä¸ªå…ƒç´ ï¼Œåç»­çš„å…ƒç´ ç©ºé—´å°±ç™½ç™½æµªè´¹äº†ï¼Œç”Ÿæˆå™¨å¯ä»¥æ ¹æ®è§„åˆ™ç”Ÿæˆåç»­å…ƒç´  2.2 ç”Ÿæˆå™¨å®šä¹‰ 1.åŸºäºå‡½æ•°å®ç°çš„ç”Ÿæˆå™¨ 2.è¡¨è¾¾å¼å®ç°ç”Ÿæˆå™¨ 2.3 ç”Ÿæˆå™¨æœ¬è´¨ ç”Ÿæˆå™¨çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªè¿­ä»£å™¨ è¿­ä»£å™¨ï¼šæ–‡ä»¶å¥æŸ„ï¼Œé€šè¿‡æ•°æ®è½¬æ¢ï¼Œpythonè‡ªå¸¦æä¾› ç”Ÿæˆå™¨ï¼šç¨‹åºå‘˜è‡ªå·±å®ç° 2.4 ç”Ÿæˆå™¨ä½¿ç”¨ç¤ºä¾‹ 2.4.1 å®šä¹‰åŠåˆ›å»ºç”Ÿæˆå™¨ #å®šä¹‰ä¸€ä¸ªå‡½æ•° def func(): print (1) return 5 print (func()) 1 5 âš ï¸å‡½æ•°é¢˜ä¸­å­˜åœ¨å…³é”®å­—yieldå°±æ˜¯å®šä¹‰ä¸€ä¸ªç”Ÿæˆå™¨ #å®šä¹‰ä¸€ä¸ªç”Ÿæˆå™¨ def func(): print (1) yield 5 print (func()) #âš ï¸è¿™ä¸€æ­¥æ‰ç®—æ˜¯åˆ›å»ºä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡ 2.4.2 è¯­æ³•åŠè¯æ³• âš ï¸ä»£ç æ‰§è¡Œçš„æ—¶å€™æœ‰å¤šä¸ªå¯¹è±¡åœ¨å·¥ä½œ è¯­æ³•æ£€æŸ¥ è¯æ³•æ£€æŸ¥ //ç¤ºä¾‹1 def func(): print (foo) è¿”å›ç»“æœä¸ºç©º åŸå› ï¼š å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå› æ­¤ä¸æŠ¥é”™ //ç¤ºä¾‹1 def func(): if 2 > 1 ç»“æœï¼š SyntaxError: invalid syntax åŸå› ï¼š é¦–å…ˆè¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼Œè¯­æ³•é”™è¯¯ //ç¤ºä¾‹2 def func(): foo() func() ç»“æœï¼š æŠ¥é”™,è¯­æ³•æ£€æŸ¥æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯è¯æ³•æ£€æŸ¥æœ‰é—®é¢˜ 2.4.3 ç”Ÿæˆå™¨ä½¿ç”¨ 2.4.3.1 ç”Ÿæˆå™¨ä½¿ç”¨ç¤ºä¾‹1 âš ï¸âš ï¸âš ï¸ç”Ÿæˆå™¨æœ€å¤§ç‰¹ç‚¹ï¼šæƒ°æ€§æœºåˆ¶ //ç¤ºä¾‹1 def func(): yield 1 #è®°å½•æ‰§è¡Œä½ç½®ï¼Œå½“ç¬¬ä¸€æ¬¡nextçš„æ—¶å€™è®°å½•ï¼Œç¬¬äºŒæ¬¡nextçš„æ—¶å€™å°±å¼€å§‹ä»ä¸‹è¾¹å–å€¼ yield 1 yield 2 g = func() #è·å–çš„æ˜¯ç”Ÿæˆå™¨çš„å†…å­˜åœ°å€ print (next(g)) #å–å€¼ 1 print (next(g)) #å–å€¼ 1 print (next(g)) #å–å€¼ 2 print (next(g)) #å–å€¼ ä¼šæŠ¥é”™ StopIteration 2.4.3.2 ç”Ÿæˆå™¨ä½¿ç”¨ç¤ºä¾‹2 //ç¤ºä¾‹1 def func(): yield 1 #è®°å½•æ‰§è¡Œä½ç½®ï¼Œå½“ç¬¬ä¸€æ¬¡nextçš„æ—¶å€™è®°å½•ï¼Œç¬¬äºŒæ¬¡nextçš„æ—¶å€™å°±å¼€å§‹ä»ä¸‹è¾¹å–å€¼ yield 1 yield 2 g = func() g1 = func() g1 = func() print (g) print (g1) print (g1) print (next(func())) #è¿™æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨1 print (next(func())) #è¿™æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨1 print (next(func())) #è¿™æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨2 1 1 1 âš ï¸âš ï¸âš ï¸yieldå’Œreturnéƒ¨åˆ†åŠŸèƒ½å¾ˆåƒ def func(): yield print(next(func())) None #yeildåè¾¹ä¸å†™å†…å®¹è¿”å›çš„æ˜¯None 2.4.3.3 ç”Ÿæˆå™¨ä½¿ç”¨ç¤ºä¾‹3 //ç¤ºä¾‹2 def func(): #1 def foo(): #1 print (1) #2 yield foo #4 g = func().__next__() #5 print (g) #ç»“æœ .foo at 0x7fdb08082400> print (g()) #ç»“æœ 1 None print (type(g)) #ç»“æœ ğŸ·ç¤ºä¾‹2æ‰§è¡Œè¿‡ç¨‹ ç¬¬ä¸€æ­¥ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°func()ï¼š ç¬¬1è¡Œ ç¬¬äºŒæ­¥ï¼Œæ‰§è¡Œç¬¬5è¡Œçš„func()ï¼Œåˆ›å»ºä¸€ä¸ªç”Ÿæˆå™¨ ç¬¬ä¸‰æ­¥ï¼Œæ‰§è¡Œç¬¬5è¡Œfunc().__next__()ï¼Œè¿›è¡Œå»å€¼ï¼Œè·å–çš„æ˜¯ç”Ÿæˆå™¨çš„å†…å­˜ç©ºé—´åœ°å€ ç¬¬å››æ­¥ï¼Œæ‰§è¡Œç¬¬1ã€2è¡Œçš„fooå‡½æ•°ï¼Œåªæ˜¯å®šä¹‰ä¸€ä¸ªfooå‡½æ•°ï¼Œæ²¡æœ‰å®é™…è°ƒç”¨ ç¬¬äº”æ­¥ï¼Œæ‰§è¡Œç¬¬4è¡Œçš„yield fooï¼Œyield fooè·å–çš„æ˜¯fooå‡½æ•°çš„å†…å­˜ç©ºé—´åœ°å€ï¼Œå¹¶ä¸”è¿”å›ç»™å˜é‡g æ­¤æ—¶gå°±æ˜¯fooå‡½æ•°çš„å†…å­˜åœ°å€ ç¬¬å…­æ­¥ï¼Œprint (g)ï¼Œè¿”å›çš„æ˜¯fooçš„å‡½æ•°å†…å­˜åœ°å€ ç¬¬ä¸ƒæ­¥ï¼Œprint (g())ï¼Œg() == foo()ï¼Œè¿”å›1ï¼Œå‡½æ•°ä½“ä¸­é»˜è®¤è¿”å›None ç¬¬å…«æ­¥ï¼Œprint (type(g))ï¼Œè¿”å›çš„æ˜¯fooå‡½æ•°çš„ç±»å‹ 2.4.3.4 ç”Ÿæˆå™¨ä½¿ç”¨ç¤ºä¾‹4 //ç¤ºä¾‹4 def func(): yield 1,1,2,4,5 print (112) yield 1111 yield 666 g = func() print (next(g)) #ç»“æœ (1, 1, 2, 4, 5) print (next(g)) #ç»“æœ 112 1111 2.5 æ—¶é—´ ç©ºé—´ 2.5.1 ç©ºé—´æ¢æ—¶é—´ //æ¦‚å¿µ ä¾‹å¦‚ï¼Œä¸€ä¸ªåˆ—è¡¨è¦äº§ç”Ÿ50000ä¸ªå…ƒç´ ï¼Œä¸€æ¬¡æ€§åˆ›å»ºï¼Œè¿™æ ·å°±æ˜¯ç”¨äº†ç©ºé—´æ¢äº†æ—¶é—´ ç”¨ä¸€æ¬¡æ€§ç”Ÿæˆå ç”¨å¤§é‡ç©ºé—´çš„å…ƒç´ æ¢å–å¿«é€Ÿè¯»å–æ—¶é—´ 2.5.2 æ—¶é—´æ¢ç©ºé—´ //æ¦‚å¿µ ä¾‹å¦‚ï¼Œè¿˜æ˜¯ä¸€ä¸ªåˆ—è¡¨åˆ›å»º50000ä¸ªå…ƒç´ ï¼Œè¿™æ¬¡ä¸ä¸€æ¬¡æ€§åˆ›å»ºï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªç›‘æ§è€…ï¼Œç”¨ä¸€ä¸ªå…ƒç´ ç”±ç›‘æ§è€…å–ä¸€ä¸ªï¼Œè¿™æ ·å°±èŠ‚çœäº†å¤§é‡å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯éœ€è¦è¯»å–çš„æ—¶é—´å˜é•¿ //ä»£ç ç¤ºä¾‹ def func(): for i in range(1,50001): yield i g = func() print (next(g)) #ç»“æœ1 print (next(g)) #ç»“æœ1 è¿™æ ·å°±æ˜¯éœ€è¦ä¸€ä¸ªç„¶åè¯»å–ä¸€ä¸ªï¼ŒèŠ‚çœäº†å†…å­˜ç©ºé—´åœ°å€ï¼Œä½†æ˜¯éœ€è¦æ¶ˆè€—å¤§é‡æ—¶é—´ 2.6 yield from yield from é€ä¸ªè¿”å›å¯¹è±¡ //ç¤ºä¾‹1 å°†å…ƒç´ æ•´ä½“è¿”å› def func(): yield [1,1,2,4,5] #å°†å…ƒç´ æ•´ä½“è¿”å› g = func() print (next(g)) [1, 1, 2, 4, 5] //ç¤ºä¾‹1 å°†å…ƒç´ é€ä¸ªè¿”å› def func(): yield from [1,1,2,4,5] g = func() print (next(g)) print (next(g)) print (next(g)) 1 1 2 //ç¤ºä¾‹2 å¤šä¸ªyieldï¼Œé€ä¸ªè¿”å›ä¸€ä¸ªyieldçš„å…ƒç´ å†è¿”å›ä¸‹ä¸€ä¸ªyieldçš„ def func(): yield from [1,1,2] yield from ['a','b','c','d','e'] g = func() print (next(g)) print (next(g)) print (next(g)) print (next(g)) 1 1 2 a #yieldæ€»ç»“ yield èƒ½è¿”å›å¤šä¸ª,ä»¥å…ƒç»„çš„å½¢å¼å­˜å‚¨ yield èƒ½è¿”å›å„ç§æ•°æ®ç±»å‹(Pythonçš„å¯¹è±¡) yield èƒ½å¤Ÿå†™å¤šä¸ªå¹¶ä¸”éƒ½æ‰§è¡Œ yield èƒ½å¤Ÿè®°å½•æ‰§è¡Œä½ç½® yield åè¾¹ä¸å†™å†…å®¹ é»˜è®¤è¿”å›None yield éƒ½æ˜¯å°†æ•°æ®ä¸€æ¬¡æ€§è¿”å› 3.åŒºåˆ†è¿­ä»£å™¨å’Œç”Ÿæˆå™¨åŠè¿­ä»£å¯¹è±¡è¯´æ˜ #æ–¹æ³•1 å…·æœ‰send()æ–¹æ³•çš„å°±æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ #æ–¹æ³•1 æŸ¥çœ‹å†…å­˜åœ°å€ //ç¤ºä¾‹ lst = [1,1,2] print (lst.__iter__()) #ç»“æœ def func(): yield 1 print (func()) #ç»“æœ âš ï¸âš ï¸âš ï¸ ç”Ÿæˆå™¨ä¸€å®šæ˜¯ä¸€ä¸ªè¿­ä»£å™¨ï¼Œä½†æ˜¯è¿­ä»£å™¨ä¸ä¸€å®šæ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ //è¿­ä»£å¯¹è±¡ å…·æœ‰__iter__()æ–¹æ³•çš„å°±æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ //è¿­ä»£å™¨: å…·æœ‰__iter__() å’Œ __next__()æ–¹æ³•å°±æ˜¯ä¸€ä¸ªè¿­ä»£å™¨ //ç”Ÿæˆå™¨: åŸºäºå‡½æ•°åˆ›å»ºçš„ç”Ÿæˆå™¨,å‡½æ•°ä½“ä¸­å¿…é¡»å­˜åœ¨yield 4.è¿­ä»£å™¨å’Œç”Ÿæˆå™¨ä¼˜ç¼ºç‚¹æ€»ç»“ #ä¼˜ç‚¹ èŠ‚çœç©ºé—´ #ç¼ºç‚¹ 1.ä¸èƒ½ç›´æ¥ä½¿ç”¨å…ƒç´  1.ä¸èƒ½ç›´è§‚æŸ¥çœ‹å…ƒç´ çš„ä¸ªæ•° 2.ä½¿ç”¨ä¸çµæ´» 4.ç¨å¾®æ¶ˆè€—æ—¶é—´ 5.ä¸€æ¬¡æ€§æ‰§è¡Œï¼Œä¸èƒ½é€†è¡Œæ‰§è¡Œ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/14.pythonåŸºç¡€åå›› æ¨¡å—.html":{"url":"python/pythonåŸºç¡€/14.pythonåŸºç¡€åå›› æ¨¡å—.html","title":"pythonåŸºç¡€åå›› æ¨¡å—","keywords":"","body":"pythonåŸºç¡€åå›› æ¨¡å— é‡ç‚¹ ##osæ¨¡å— #æ–‡ä»¶å¤¹ç›¸å…³ os.makedirs('dirname1/dirname2') å¯ç”Ÿæˆå¤šå±‚é€’å½’ç›®å½• *** os.removedirs('dirname1') è‹¥ç›®å½•ä¸ºç©ºï¼Œåˆ™åˆ é™¤ï¼Œå¹¶é€’å½’åˆ°ä¸Šä¸€çº§ç›®å½•ï¼Œå¦‚è‹¥ä¹Ÿä¸ºç©ºï¼Œåˆ™åˆ é™¤ï¼Œä¾æ­¤ç±»æ¨ *** os.mkdir('dirname') ç”Ÿæˆå•çº§ç›®å½•ï¼›ç›¸å½“äºshellä¸­mkdir dirname *** os.rmdir('dirname') åˆ é™¤å•çº§ç©ºç›®å½•ï¼Œè‹¥ç›®å½•ä¸ä¸ºç©ºåˆ™æ— æ³•åˆ é™¤ï¼ŒæŠ¥é”™ï¼›ç›¸å½“äºshellä¸­rmdir dirname *** #æ–‡ä»¶ç›¸å…³ os.remove() åˆ é™¤ä¸€ä¸ªæ–‡ä»¶ *** os.rename(\"oldname\",\"newname\") é‡å‘½åæ–‡ä»¶/ç›®å½• *** #è·¯å¾„ç›¸å…³ os.path.abspath(path) è¿”å›pathè§„èŒƒåŒ–çš„ç»å¯¹è·¯å¾„ *** os.path.split(path) å°†pathåˆ†å‰²æˆç›®å½•å’Œæ–‡ä»¶åäºŒå…ƒç»„è¿”å› *** os.path.exists(path) å¦‚æœpathå­˜åœ¨ï¼Œè¿”å›Trueï¼›å¦‚æœpathä¸å­˜åœ¨ï¼Œè¿”å›False *** os.path.isfile(path) å¦‚æœpathæ˜¯ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ï¼Œè¿”å›Trueã€‚å¦åˆ™è¿”å›False *** os.path.isdir(path) å¦‚æœpathæ˜¯ä¸€ä¸ªå­˜åœ¨çš„ç›®å½•ï¼Œåˆ™è¿”å›Trueã€‚å¦åˆ™è¿”å›False *** os.path.join(path1[, path2[, ...]]) å°†å¤šä¸ªè·¯å¾„ç»„åˆåè¿”å›ï¼Œç¬¬ä¸€ä¸ªç»å¯¹è·¯å¾„ä¹‹å‰çš„å‚æ•°å°†è¢«å¿½ç•¥ *** os.path.getsize(path) è¿”å›pathçš„å¤§å° *** #sysæ¨¡å— sys.path è¿”å›æ¨¡å—çš„æœç´¢è·¯å¾„ï¼Œåˆå§‹åŒ–æ—¶ä½¿ç”¨PYTHONPATHç¯å¢ƒå˜é‡çš„å€¼ *** 1. æ¨¡å—ä»‹ç» pyæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å— 2. æ¨¡å—åˆ†ç±» 2.1 å†…ç½®æ¨¡å— å†…ç½®æ¨¡å—ä¹Ÿå«æ ‡å‡†åº“ 2.2 ç¬¬ä¸‰æ–¹æ¨¡å— åˆ«äººå†™å¥½çš„åŠŸèƒ½ 2.3 è‡ªå®šä¹‰æ¨¡å— è‡ªå·±å†™çš„ç‰¹å®šåŠŸèƒ½ 3. æ¨¡å—ä½œç”¨ 1.å¼€å‘æ•ˆç‡é«˜ï¼Œæœ‰å¤§é‡çš„å†…ç½®å‡½æ•°å’Œæ¨¡å— 2.æ‹¿æ¥ä¸»ä¹‰ï¼Œå¤§é‡çš„ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œæ‹¿æ¥æ—¢èƒ½ç”¨ï¼Œä¸éœ€è¦çŸ¥é“åŸç† 3.å‡å°‘é‡å¤ä»£ç ï¼Œåˆ†æ–‡ä»¶ç®¡ç†ï¼Œæœ‰åŠ©äºä¿®æ”¹å’Œç»´æŠ¤ 4. æ¨¡å—ä½¿ç”¨ 4.1 è¯­æ³• import æ¨¡å—å 4.2 æ¨¡å—çš„ä¸¤ç§ç”¨æ³• 1.å½“ä½œæ™®é€šæ¨¡å—æ‰§è¡Œ 2.è¢«å½“ä½œè„šæœ¬æ‰§è¡Œ 5. è‡ªå®šä¹‰æ¨¡å— è‡ªå®šä¹‰æ¨¡å—ä½¿ç”¨ç¤ºä¾‹ //éåŒçº§ç›®å½•ç¤ºä¾‹ 1.åœ¨å½“å‰éœ€è¦è°ƒç”¨æ¨¡å—çš„pyæ–‡ä»¶test.pyçš„ä¸åŒè·¯å¾„æ–°å»ºä¸€ä¸ªæ–‡ä»¶i.pyï¼Œä¸€ä¼štest.pyè°ƒç”¨è¿™ä¸ªæ–‡ä»¶i.py 2.åœ¨/Users/baixuebing/Desktopä¸‹åˆ›å»ºä¸€ä¸ªi.pyæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å¦‚ä¸‹ print(\"éåŒçº§ç›®å½•è‡ªå®šä¹‰æ¨¡å—è·¯å¾„å¯¼å…¥ç»ƒä¹ \") a = 10 b = 20 3.test.pyæ–‡ä»¶å†…å®¹å¦‚ä¸‹ import sys #éœ€è¦å¯¼å…¥sysæ¨¡å— sys.path.append('/Users/baixuebing/Desktop') #è¿™é‡Œå†™è¦å¯¼å…¥çš„è‡ªå®šä¹‰æ¨¡å—çš„è·¯å¾„ from i import a,b #è‡ªå®šä¹‰æ¨¡å—åæ˜¯iï¼Œå¯¼å…¥a,bä¸¤ä¸ªåŠŸèƒ½ print(a,b) #æ‰“å°åŠŸèƒ½ éåŒçº§ç›®å½•è‡ªå®šä¹‰æ¨¡å—è·¯å¾„å¯¼å…¥ç»ƒä¹  10 20 //åŒçº§ç›®å½•ç¤ºä¾‹ è¯´æ˜ï¼štest.pyæ–‡ä»¶ä¸è‡ªå®šä¹‰æ¨¡å—i.pyåœ¨åŒä¸€ä¸ªè·¯å¾„ä¸‹ from i import a,b print(a,b) åŒçº§ç›®å½•è‡ªå®šä¹‰æ¨¡å—å¯¼å…¥ç»ƒä¹  10 20 5.1 è‡ªå®šä¹‰æ¨¡å—ç‰¹æ®Šè¯´æ˜ åº”ç”¨åœºæ™¯ï¼š 1.ç°åœ¨æœ‰ä¸€ä¸ªè‡ªå®šä¹‰æ¨¡å—i.pyï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ def login(): print('ç™»é™†') def register(): print('æ³¨å†Œ') print('è‡ªå®šä¹‰æ¨¡å—ä¿ç•™è‡ªå®šä¹‰å†…å®¹ä¸è¢«è°ƒç”¨') print(123456) è°ƒç”¨è€…æ–‡ä»¶test.pyï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ import sys from i import login login() 2.å¯¼å…¥è¿™ä¸ªè‡ªå®šä¹‰æ¨¡å—å¹¶æ‰§è¡Œï¼Œè¿”å›ç»“æœå¦‚ä¸‹ï¼Œä½†æ˜¯è‡ªå®šä¹‰æ¨¡å—ä¸­è°ƒç”¨å‡½æ•°çš„123456ä¸æƒ³è¢«è°ƒç”¨ï¼Œéœ€è¦åšä¸€ä¸‹ç‰¹æ®Šå¤„ç†ï¼Œè®©è°ƒç”¨è€…åªèƒ½çœ‹åˆ° â€™è‡ªå®šä¹‰æ¨¡å—ä¿ç•™è‡ªå®šä¹‰å†…å®¹ä¸è¢«è°ƒç”¨â€˜ã€ç™»é™†ã€æ³¨å†Œï¼Œä¸èƒ½çœ‹åˆ°123456 è‡ªå®šä¹‰æ¨¡å—ä¿ç•™è‡ªå®šä¹‰å†…å®¹ä¸è¢«è°ƒç”¨ 123456 3.ä¿®æ”¹è‡ªå®šä¹‰æ¨¡å—i.pyï¼Œåœ¨a()å’Œb()çš„ä¸Šæ–¹åŠ å…¥ä¸€è¡Œä»£ç  if __name__ == \"__main__\": def a(): print('ç™»é™†') def register(): print('æ³¨å†Œ') print('è‡ªå®šä¹‰æ¨¡å—ä¿ç•™è‡ªå®šä¹‰å†…å®¹ä¸è¢«è°ƒç”¨') if __name__ == \"__main__\": #ä¸å¯å¤–ä¼ åŠŸèƒ½ print(123456) 4.è°ƒç”¨è€…å†æ¬¡æ‰§è¡Œï¼Œç»“æœå¦‚ä¸‹ï¼Œç»“æœ123456æ— æ³•è·å– è‡ªå®šä¹‰æ¨¡å—ä¿ç•™è‡ªå®šä¹‰å†…å®¹ä¸è¢«è°ƒç”¨ ç™»é™† ğŸŒŸğŸŒŸğŸŒŸ åŸå› ï¼š åœ¨å½“å‰æ–‡ä»¶i.pyä¸­æ‰§è¡Œ__name__è·å–çš„å€¼æ˜¯'__main__' å½“å‰æ–‡ä»¶i.pyè¢«å½“ä½œæ¨¡å—å¯¼å…¥æ—¶ï¼Œ__name__è·å–çš„æ˜¯å½“å‰æ–‡ä»¶å 6. æ¨¡å—å¯¼å…¥ 6.1 æ¨¡å—å¯¼å…¥è¿‡ç¨‹ 1.å°†æ¨¡å—å­˜å‚¨åˆ°å½“å‰åç§°ç©ºé—´ä¸­ï¼Œå¯ä»¥ä½¿ç”¨globalsæŸ¥çœ‹ 2.ä»¥æ¨¡å—çš„åå­—å‘½åï¼Œå¹¶å¼€è¾Ÿä¸€ä¸ªç‹¬ç«‹ç©ºé—´ 3.é€šè¿‡æ¨¡å—åæ¥ä½¿ç”¨æ¨¡å—ä¸­çš„åŠŸèƒ½ 6.2. å¯¼å…¥è¯´æ˜ 6.2.1 å…¨éƒ¨å¯¼å…¥ import æ¨¡å—å æ˜¯å°†æ¨¡å—ä¸­æ‰€æœ‰çš„å†…å®¹å…¨éƒ¨å€’å…¥ 6.2.2 å¯¼å…¥éƒ¨åˆ† from æ¨¡å—å import åŠŸèƒ½1ï¼ŒåŠŸèƒ½2 ä»æ¨¡å—ä¸­å¯¼å…¥éƒ¨åˆ†åŠŸèƒ½ from æ¨¡å—å import åŠŸèƒ½1 as åˆ«å 6.3 æ¨¡å—å¯¼å…¥æ³¨æ„ç‚¹âš ï¸ 1.åŒä¸€ä¸ªæ¨¡å—ï¼Œå†™å¤šæ¬¡ï¼Œåªæ‰§è¡Œä¸€æ¬¡ 6.4 æ¨¡å—å¯¼å…¥é¡ºåº å†…å­˜ --> å†…ç½® --> sys.path 7. æ¨¡å—è·¯å¾„ æ¨¡å—ä¸pyæ–‡ä»¶åœ¨åŒä¸€è·¯å¾„å¯ä»¥ç›´æ¥è°ƒç”¨ æ¨¡å—ä¸pyæ–‡ä»¶ä¸åœ¨åŒä¸€è·¯å¾„ï¼Œéœ€è¦å¯¼å…¥sysæ¨¡å—åŠå¯¼å…¥æ¨¡å—è·¯å¾„ import sys sys.path.append('è·¯å¾„') 8. æ¨¡å—æŸ¥æ‰¾é¡ºåº å†…å­˜ --> å†…ç½® --> sys.path 9. timeæ¨¡å— 9.1 æ—¶é—´åˆ†ç±» 9.1.1 æ—¶é—´æˆ³ ç”¨äºè®¡ç®— é€šå¸¸çš„å«æ³•,æ—¶é—´æˆ³è¡¨ç¤ºçš„æ˜¯æ ¼æ—å°¼æ²»æ—¶é—´æ˜¯ä»1970å¹´1æœˆ1æ—¥00:00:00å¼€å§‹æŒ‰ç§’è®¡ç®—çš„åç§»é‡ã€‚è¿™ä¸ªæ˜¯å®æ—¶å˜åŒ–çš„ã€‚æˆ‘ä»¬è¿è¡Œâ€œtype(time.time())â€ï¼Œè¿”å›çš„æ˜¯floatç±»å‹ #è·å–æ—¶é—´æˆ³ import time print(time.time()) 1569543159.206561 9.1.2 ç»“æ„åŒ–æ—¶é—´ ç”¨äºç¨‹åºå‘˜è·å–æ•°æ®ç»“æ„ å‘½åå…ƒç»„ #è·å–ç»“æ„åŒ–æ—¶é—´ import time t = time.time() #è·å–æ—¶é—´æˆ³ print(time.localtime(t)) #å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºç»“æ„åŒ–æ—¶é—´ time.struct_time(tm_year=2019, tm_mon=9, tm_mday=27, tm_hour=8, tm_min=22, tm_sec=41, tm_wday=4, tm_yday=270, tm_isdst=0) 9.1.3 å­—ç¬¦ä¸²æ—¶é—´ ç»™ç”¨æˆ·æŸ¥çœ‹çš„ pythonä¸­æ—¶é—´æ—¥æœŸæ ¼å¼åŒ–ç¬¦å·ï¼š %y ä¸¤ä½æ•°çš„å¹´ä»½è¡¨ç¤ºï¼ˆ00-99ï¼‰ %Y å››ä½æ•°çš„å¹´ä»½è¡¨ç¤ºï¼ˆ000-9999ï¼‰ %m æœˆä»½ï¼ˆ01-12ï¼‰ %d æœˆå†…ä¸­çš„ä¸€å¤©ï¼ˆ0-31ï¼‰ %H 24å°æ—¶åˆ¶å°æ—¶æ•°ï¼ˆ0-23ï¼‰ %I 12å°æ—¶åˆ¶å°æ—¶æ•°ï¼ˆ01-12ï¼‰ %M åˆ†é’Ÿæ•°ï¼ˆ00=59ï¼‰ %S ç§’ï¼ˆ00-59ï¼‰ %a æœ¬åœ°ç®€åŒ–æ˜ŸæœŸåç§° %A æœ¬åœ°å®Œæ•´æ˜ŸæœŸåç§° %b æœ¬åœ°ç®€åŒ–çš„æœˆä»½åç§° %B æœ¬åœ°å®Œæ•´çš„æœˆä»½åç§° %c æœ¬åœ°ç›¸åº”çš„æ—¥æœŸè¡¨ç¤ºå’Œæ—¶é—´è¡¨ç¤º %j å¹´å†…çš„ä¸€å¤©ï¼ˆ001-366ï¼‰ %p æœ¬åœ°A.M.æˆ–P.M.çš„ç­‰ä»·ç¬¦ %U ä¸€å¹´ä¸­çš„æ˜ŸæœŸæ•°ï¼ˆ00-53ï¼‰æ˜ŸæœŸå¤©ä¸ºæ˜ŸæœŸçš„å¼€å§‹ %w æ˜ŸæœŸï¼ˆ0-6ï¼‰ï¼Œæ˜ŸæœŸå¤©ä¸ºæ˜ŸæœŸçš„å¼€å§‹ %W ä¸€å¹´ä¸­çš„æ˜ŸæœŸæ•°ï¼ˆ00-53ï¼‰æ˜ŸæœŸä¸€ä¸ºæ˜ŸæœŸçš„å¼€å§‹ %x æœ¬åœ°ç›¸åº”çš„æ—¥æœŸè¡¨ç¤º %X æœ¬åœ°ç›¸åº”çš„æ—¶é—´è¡¨ç¤º %Z å½“å‰æ—¶åŒºçš„åç§° %% %å·æœ¬èº« #è·å–å­—ç¬¦ä¸²æ—¶é—´ import time print(time.strftime(\"%Y-%m-%d %X\")) 2017-09-27 08:18:32 9.2 ä¸‰ç§æ—¶é—´ç›¸äº’è½¬æ¢ 9.2.1 å­—ç¬¦ä¸²æ—¶é—´ç»“æ„åŒ–æ—¶é—´ import time str_time = \"2019-9-1 12:23:06\" print(time.strptime(str_time,\"%Y-%m-%d %H:%M:%S\")) # å°†å­—ç¬¦ä¸²æ—¶é—´è½¬æ¢æˆç»“æ„åŒ–æ—¶é—´ time.struct_time(tm_year=2019, tm_mon=9, tm_mday=1, tm_hour=12, tm_min=23, tm_sec=6, tm_wday=6, tm_yday=244, tm_isdst=-1) t = time.localtime() #å…ˆè·å–ç»“æ„åŒ–æ—¶é—´ print(time.strftime(\"%Y-%m-%d %H:%M:%S\",t)) #å°†ç»“æ„åŒ–æ—¶é—´è½¬æ¢æˆå­—ç¬¦ä¸²æ—¶é—´ 9.2.2 æ—¶é—´æˆ³ç»“æ„åŒ–æ—¶é—´ import time t = time.time() #è·å–æ—¶é—´æˆ³ print(t) 1569543714.778055 print(time.localtime(t)) #å°†æ—¶é—´æˆ³è½¬æˆç»“æ„åŒ–æ—¶é—´ time.struct_time(tm_year=2019, tm_mon=9, tm_mday=27, tm_hour=8, tm_min=22, tm_sec=41, tm_wday=4, tm_yday=270, tm_isdst=0) t = time.localtime() #å…ˆè·å–ç»“æ„åŒ–æ—¶é—´ print(time.mktime(t)) #å°†æœºæ„åŒ–æ—¶é—´è½¬æ¢æˆæ—¶é—´æˆ³ 1569564152.0 9.2.3 å­—ç¬¦ä¸²æ—¶é—´æ—¶é—´æˆ³ éœ€è¦å…ˆè½¬æ¢ä¸ºä¸­é—´äººç»“æ„åŒ–æ—¶é—´å†è½¬æ¢ï¼Œä¸èƒ½ç›´æ¥è½¬åŒ– å­—ç¬¦ä¸²æ—¶é—´ç»“æ„åŒ–æ—¶é—´æ—¶é—´æˆ³ 10. datetimeæ¨¡å— # import datetime âš ï¸æ­¤å†™æ³•ä¸æ­£ç¡® 1.è·å–å½“å‰æ—¶é—´ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯å­—ç¬¦ä¸² from datetime import datetime print(datetime.now()) 2017-10-03 18:58:09.455678 print(type(datetime.now())) 2.è‡ªå®šä¹‰æ—¶é—´ print(datetime(2016,11,11,11,11,11)) 2016-11-11 11:11:11 3.æ—¶é—´æˆ³è½¬æ¢æˆå¯¹è±¡ import time print(datetime.fromtimestamp(time.time())) 2017-10-07 18:27:43.683452 4.å°†å¯¹è±¡è½¬æ¢æˆæ—¶é—´æˆ³ print(datetime.timestamp(datetime.now())) 1570444141.19223 5.å°†å¯¹è±¡è½¬æ¢æˆå­—ç¬¦ä¸² print(datetime.strftime(datetime.now(),\"%Y-%m-%d %H:%M:%S\")) 2017-10-07 18:29:50 6.å°†å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹è±¡ print(datetime.strptime(\"2016/11/11\",\"%Y/%m/%d\")) 2016-11-11 00:00:00 7.å¯¹è±¡æ—¶é—´ä¸è‡ªå®šä¹‰æ—¶é—´åšè¿ç®— print(datetime.now() - datetime(9999,11,1,12,13,14)) -2914660 days, 6:20:23.854611 8.è®¡ç®—ä»å½“å‰å¯¹è±¡æ—¶é—´åˆ°æŸä¸€å¤© from datetime import datetime,timedelta print(datetime.now()) print(datetime.now() - timedelta(days=1)) print(datetime.now() + timedelta(days=1)) 2017-10-07 18:37:18.013572 2017-10-06 18:37:18.013611 2017-10-08 18:37:18.013628 11. randomæ¨¡å— éšæœºæ•° 1.è·å–0-1ä¹‹é—´çš„å°æ•° import random random.random() #0-1ä¹‹é—´çš„å°æ•° 2.è·å–èŒƒå›´çš„éšæœºæ•´æ•° random.randint(1,5) #è·å–1-5ä¹‹é—´çš„æ•´æ•° 3.è·å–èŒƒå›´å†…çš„éšæœºå¶æ•° random.randrange(0,10,2) 4.è·å–åˆ—è¡¨ä¸­å•ä¸ªå…ƒç´  lst = [1,2,3,4,5,6] random.choice(lst) 5.è·å–åˆ—è¡¨ä¸­æŒ‡å®šä¸ªæ•°å…ƒç´  lst = [1,2,3,4,5,6] random.choices(lst,k=5) #éšæœºè·å–5ä¸ªæ•°ï¼Œä¼šå‡ºç°é‡å¤å…ƒç´  random.sample(lst,k=5) #éšæœºè·å–5ä¸ªæ•°ï¼Œä¸ä¼šå‡ºç°é‡å¤å…ƒç´  6.æ‰“ä¹±é¡ºåº lst = [1,2,3,4,5,6,7,8] random.shuffle(lst) 12. sysæ¨¡å— ä¸pythonè§£é‡Šå™¨åšäº¤äº’ 1.è·å–ç³»ç»Ÿè·¯å¾„ import sys sys.path 2.è·å–ç³»ç»Ÿå¹³å° sys.platform windowns --> win32 mac --> darwin 3.è·å–å½“å‰pyæ–‡ä»¶è·¯å¾„ sys.argv #è¿”å›åˆ—è¡¨ 4.è·å–pythonè§£é‡Šå™¨ç‰ˆæœ¬ sys.version 5.é€€å‡ºç  sys.exit(1) #0æ˜¯æ­£å¸¸é€€å‡ºï¼Œå¯ä»¥ä¿®æ”¹ 6.è·å–æ‰€æœ‰æ¨¡å— sys.modules() 13. osæ¨¡å— 13.1 æ–‡ä»¶ 1.ä¿®æ”¹æ–‡ä»¶å import os os.rename(\"æ—§å\",\"æ–°å\") 2.åˆ é™¤æ–‡ä»¶ os.remove(\"è¦åˆ é™¤çš„æ–‡ä»¶å\") 13.2 æ–‡ä»¶å¤¹ 1.åˆ›å»ºæ–‡ä»¶å¤¹ os.makedirs('a/b/c') #é€’å½’åˆ›å»º os.mkdir('a') #å•ç‹¬åˆ›å»º 2.åˆ é™¤æ–‡ä»¶å¤¹ os.removedirs('a') #é€’å½’åˆ é™¤ os.rmdir('a') #åˆ é™¤æ–‡ä»¶å¤¹ 3.æŸ¥çœ‹æ–‡ä»¶å¤¹ os.listdir() #æŸ¥çœ‹å½“å‰è·¯å¾„ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ 13.3 è·¯å¾„ 1.è·å–è·¯å¾„ os.getcwd() #è·å–å½“å‰å·¥ä½œè·¯å¾„ 2.åˆ‡æ¢è·¯å¾„ os.chdir() #åˆ‡æ¢è·¯å¾„ 3.è·å–å½“å‰è·¯å¾„ os.curdir() 4.è·å–ä¸Šçº§ç›®å½• os.pardir() 5.è·å–ç»å¯¹è·¯å¾„ âš ï¸é‡è¦ æ³¨æ„æ˜¯å½“å‰è·¯å¾„ä¸‹çš„æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹ os.path.abspath('å½“å‰æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹å') 6.è·¯å¾„åˆ†å‰² âš ï¸åªåˆ†ä¸€åˆ€ è·å¾—çš„æ˜¯å…ƒç»„ os.path.split('è·¯å¾„') 7.çˆ¶çº§ç›®å½• âš ï¸âš ï¸âš ï¸ ğŸŒŸ os.path.dirname('è·¯å¾„') 8.è·å–è·¯å¾„æœ€å¤–å±‚ os.path.basename('è·¯å¾„') 9.å°†å¤šä¸ªè·¯å¾„ç»„åˆåè¿”å›ï¼Œç¬¬ä¸€ä¸ªç»å¯¹è·¯å¾„ä¹‹å‰çš„å‚æ•°å°†è¢«å¿½ç•¥ ğŸŒŸğŸŒŸğŸŒŸ os.path.join('è·¯å¾„1','è·¯å¾„2'.'è·¯å¾„3') 10.è·å–æ–‡ä»¶å¤§å° os.path.getsize() isç³»åˆ— 1.åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ è¿”å›å¸ƒå°”å€¼ os.path.exists() 2.åˆ¤æ–­æ˜¯å¦æ˜¯ç»å¯¹è·¯å¾„ è¿”å›å¸ƒå°”å€¼ os.path.isabs() 3.åˆ¤æ–­æ˜¯å¦æ˜¯å­˜åœ¨çš„æ–‡ä»¶ os.path.isfile('ç»å¯¹è·¯å¾„') 4.åˆ¤æ–­æ˜¯å¦æ˜¯ç›®å½• os.path.isdir() 13.4 å…¶ä»– 1.æ‰§è¡Œshellå‘½ä»¤ os.system() os.popen('dir').read() 2.è·å–ç¯å¢ƒå˜é‡ os.environ() 14.hashlibæ¨¡å— 14.1 å«ä¹‰ æ‘˜è¦ç®—æ³•ï¼ŒåŠ å¯†ç®—æ³• 14.2 åŠŸèƒ½ åŠ å¯†ï¼Œæ ¡éªŒä¸€è‡´æ€§ 14.3 åŠ å¯†è¯´æ˜ 1.å†…å®¹ç›¸åŒï¼Œå¯†ç ä¸€å®šç›¸åŒ 2.åŠ å¯†çš„å¯†æ–‡æ˜¯ä¸å¯é€†çš„ 3.æ˜æ–‡-->å­—èŠ‚-->å¯†æ–‡ 4.åŠ å¯†æ–¹æ³• md5ã€sha1ã€sha256ã€sha512 14.4 åŠ å¯†ç¤ºä¾‹ import hashlib #å¯¼å…¥hashlibæ¨¡å— s = \"123abc\" md5 = hashlib.md5() #é€‰æ‹©åŠ å¯†çš„æ–¹å¼ï¼Œåˆå§‹åŒ–ä¸€ä¸ªåŠ å¯† md5.update(s.encode(\"utf-8\")) #å°†è¦åŠ å¯†çš„å†…å®¹æ·»åŠ åˆ°å˜é‡md5ä¸­ print(md5.hexdigest()) #è¿›è¡ŒåŠ å¯† 14.5 åŠ ç› 14.5.1 å›ºå®šåŠ ç› user = input(\"user:\") pwd = input(\"pwd:\") import hashlib md5 = hashlib.md5(\"abc\".encode(\"utf-8\")) #è¿™é‡Œçš„abcå°±æ˜¯ç› md5.update(pwd.encode(\"utf-8\")) print(md5.hexdigest()) 14.5.1 åŠ¨æ€åŠ ç› user = input(\"user:\") pwd = input(\"pwd:\") import hashlib md5 = hashlib.md5(user.encode(\"utf-8\")) #è¿™é‡Œçš„userå°±æ˜¯åŠ¨æ€ç› md5.update(pwd.encode(\"utf-8\")) print(md5.hexdigest()) 15.collectionsæ¨¡å— 15.1 ç»Ÿè®¡ ğŸŒŸğŸŒŸğŸŒŸ //ç¤ºä¾‹ ç»Ÿè®¡åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•° #æ–¹æ³•1 forå¾ªç¯ lst = [1,1,2,5,6,7,7,9,99,99,1,3,7] dic = {} for i in lst: dic[i] = lst.count(i) print(dic) {1: 3, 2: 1, 5: 1, 6: 1, 7: 3, 9: 1, 99: 2, 3: 1} #æ–¹æ³•2 collectionsè®°æ•° lst = [1,1,2,5,6,7,7,9,99,99,1,3,7] from collections import Counter print(dict(Counter(lst))) {1: 3, 2: 1, 5: 1, 6: 1, 7: 3, 9: 1, 99: 2, 3: 1} 15.2 æœ‰åºå­—å…¸ ğŸŒŸğŸŒŸğŸŒŸ python2ä¸­ä½¿ç”¨ from collections import OrderedDict a = OrderedDict({\"key1\":1,\"key2\":2}) print(a) print(a[\"key1\"]) OrderedDict([('key1', 1), ('key2', 2)]) 1 15.3 é»˜è®¤å­—å…¸ from collections import defaultdict dic = defaultdict(list) #æ‹¬å·ä¸­å†™ä¸åŠ æ‹¬å·çš„æ–¹æ³• ä¾‹å¦‚åˆ—è¡¨åªå†™listï¼Œä¸å†™list()ï¼Œè¿™é‡Œå­—å…¸é»˜è®¤å€¼å°±æ˜¯ç©ºåˆ—è¡¨ dic['k1'].append(10) #æŒ‡æ˜å­—å…¸çš„å€¼ä¸º10 dic['k2'] #ä¸æŒ‡å®šå­—å…¸çš„å€¼ï¼Œé»˜è®¤æ˜¯ç©ºåˆ—è¡¨ print(dic) defaultdict(, {'k1': [10], 'k2': []}) //ç¤ºä¾‹é¢˜ å°†åˆ—è¡¨ä¸­å…ƒç´ å¤§äº66çš„è¿½åŠ åˆ°å­—å…¸çš„key1ä¸­ï¼Œå°äº66çš„è¿½åŠ åˆ°å­—å…¸çš„key2ä¸­ #æ–¹æ³•1 lst = [11,22,33,44,55,77,88,99] dic = {\"key1\":[],\"key2\":[]} for i in lst: if i > 66: dic['key2'].append(i) else: dic['key1'].append(i) print(dic) {'key1': [11, 22, 33, 44, 55], 'key2': [77, 88, 99]} #æ–¹æ³•2 lst = [11,22,33,44,55,77,88,99] dic = {} for i in lst: if i > 66: dic.setdefault('key2',[]).append(i) else: dic.setdefault('key1', []).append(i) print(dic) {'key1': [11, 22, 33, 44, 55], 'key2': [77, 88, 99]} #æ–¹æ³•3 from collections import defaultdict lst = [11,22,33,44,55,77,88,99] dic = defaultdict(list) for i in lst: if i > 66: dic['key2'].append(i) else: dic['key1'].append(i) print(dic) defaultdict(, {'key1': [11, 22, 33, 44, 55], 'key2': [77, 88, 99]}) 15.4 åŒç«¯é˜Ÿåˆ— 1.é˜Ÿåˆ— å…ˆè¿›å…ˆå‡º deque ğŸŒŸğŸŒŸğŸŒŸ from collections import deque lst = deque([11,22,33,44,55]) lst.appendleft(00) #ä»å·¦ä¾§å¼€å§‹è¿½åŠ  print(lst) deque([0, 11, 22, 33, 44, 55]) lst.popleft() #ä»å·¦ä¾§å¼€å§‹åˆ é™¤ print(lst) deque([22, 33, 44, 55]) 2.æ ˆ å…ˆè¿›åå‡º lst = [] lst.append(1) lst.append(2) lst.append(3) print(lst) lst.pop() print(lst) lst.pop() print(lst) lst.pop() 15.5 å‘½åå…ƒç»„ namedtuple ğŸŒŸğŸŒŸğŸŒŸ from collections import namedtuple dg = namedtuple('name',[\"aa\",\"bb\",\"cc\"]) print(dg('hehe','haha','xixi')) name(aa='hehe', bb='haha', cc='xixi') æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/15.pythonåŸºç¡€åäº” é—­åŒ….html":{"url":"python/pythonåŸºç¡€/15.pythonåŸºç¡€åäº” é—­åŒ….html","title":"pythonåŸºç¡€åäº” é—­åŒ…","keywords":"","body":"pythonåŸºç¡€åäº” é—­åŒ… 1.é—­åŒ… 1.1ä½œç”¨ ä¿æŠ¤æ•°æ®å®‰å…¨ï¼Œä¿æŠ¤æ•°æ®å¹²å‡€æ€§ 1.2 å®šä¹‰ 1.åœ¨åµŒå¥—å‡½æ•°å†…ï¼Œä½¿ç”¨éå…¨å±€å˜é‡(ä¸”ä¸ä½¿ç”¨æœ¬å±‚å˜é‡) 2.å°†åµŒå¥—å‡½æ•°è¿”å› âš ï¸ä¸èƒ½åŠ å‡½æ•°çš„() 1.3 é—­åŒ…æ³¨æ„ç‚¹âš ï¸ 1.âš ï¸âš ï¸âš ï¸ æ²¡æœ‰å°†åµŒå¥—çš„å‡½æ•°è¿”å›ä¹Ÿæ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä½†æ˜¯è¿™ä¸ªé—­åŒ…ä¸èƒ½ä½¿ç”¨ï¼ï¼ï¼ 2.é—­åŒ…ä¸èƒ½ä¼ å¯å˜ç±»å‹æ•°æ® 1.4 ç¤ºä¾‹ //é—­åŒ…ç¤ºä¾‹1 def func(): a = 10 #è‡ªç”±å˜é‡ def foo(): print(a) return foo f = func() print(f.__closure__) #éªŒè¯æ˜¯å¦æ˜¯é—­åŒ… (,) âš ï¸åœ¨åµŒå¥—å‡½æ•°å†…ï¼Œä½¿ç”¨éå…¨å±€å˜é‡(ä¸”ä¸ä½¿ç”¨æœ¬å±‚å˜é‡) //ç¤ºä¾‹2 æœªè¿”å›åµŒå¥—å‡½æ•°å€¼ï¼Œè™½ç„¶æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä½†æ˜¯ä¸èƒ½ä½¿ç”¨ def func(): a = 10 def foo(): print (a) print (foo.__closure__) #(,) func() //ç¤ºä¾‹3 def func(): a = 10 def foo(): print (a) return foo func()() #âš ï¸æ­¤æ—¶func() == foo == foo() func()() f = func() f() //ç¤ºä¾‹4 âš ï¸âš ï¸âš ï¸å‡½æ•°åœ¨æ¥å—å‚æ•°çš„æ—¶å€™ä¼šåœ¨ä¸‹è¾¹å®šä¹‰å‚æ•°çš„å˜é‡ å› æ­¤ï¼Œè¿™æ˜¯ä¸€ä¸ªé—­åŒ… def wrapper(a,b): #a = 2 âš ï¸å‡½æ•°æ¥å—å‚æ•°å°±ç›¸å½“äºåœ¨å‡½æ•°ä¸­å†æ¬¡å®šä¹‰è¿™ä¸ªå˜é‡ #b = 3 âš ï¸å‡½æ•°æ¥å—å‚æ•°å°±ç›¸å½“äºåœ¨å‡½æ•°ä¸­å†æ¬¡å®šä¹‰è¿™ä¸ªå˜é‡ def inner(): print (a) print (b) return inner a = 2 b = 3 ret = wrapper(a,b) print(ret.__closure__) #(, ) > è¯´æ˜ï¼Œè™½ç„¶å˜é‡aå’Œbæ˜¯åœ¨wrapperåŒçº§å®šä¹‰çš„ï¼Œä½†æ˜¯wrapperä¸­æ˜¯æ¥å—abä¸¤ä¸ªå‚æ•°çš„ï¼Œä¼šåœ¨wrapperä¸‹çº§å®šä¹‰abä¸¤ä¸ªå˜é‡ 1.5 åº”ç”¨åœºæ™¯ 1.è£…é¥°å™¨ 2.é˜²æ­¢æ•°æ®è¢«è¯¯æ”¹åŠ¨ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/16.pythonåŸºç¡€åå…­ æ¨å¯¼å¼.html":{"url":"python/pythonåŸºç¡€/16.pythonåŸºç¡€åå…­ æ¨å¯¼å¼.html","title":"pythonåŸºç¡€åå…­ æ¨å¯¼å¼","keywords":"","body":"pythonåŸºç¡€åå…­ æ¨å¯¼å¼ 1.æ¨å¯¼å¼ 1.1 ä½œç”¨ åšä¸€äº›æœ‰è§„å¾‹çš„æ•°æ®ç»“æ„ 1.2 åˆ—è¡¨æ¨å¯¼å¼ æ™®é€šå¾ªç¯ [åŠ å·¥åçš„å˜é‡ forå¾ªç¯] ç­›é€‰æ¨¡å¼ [åŠ å·¥åçš„å˜é‡ forå¾ªç¯ æ¡ä»¶] 1.2.1 æ™®é€šå¾ªç¯ [å˜é‡ forå¾ªç¯] //ä»£ç ç¤ºä¾‹1 è¦å¾ªç¯è¾“å‡º1-10 åŸå…ˆçš„ä»£ç  lst = [] for i in range(1,11): lst.append(i) print(lst) [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] ä½¿ç”¨åˆ—è¡¨æ¨å¯¼å¼ lst = [ i for i in range(1,11)] print (lst) [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] //ä»£ç ç¤ºä¾‹2 å°†1-10å†…çš„æ•°çš„å¹³æ–¹è¿½åŠ åˆ°åˆ—è¡¨ä¸­ åŸå…ˆä»£ç  l1 = [] for i in range(1,11): i *= i l1.append(i) print (l1) [1, 4, 9, 16, 25, 36, 49, 64, 81, 100] ä½¿ç”¨åˆ—è¡¨æ¨å¯¼å¼ l1 = [i*i for i in range(1,11)] print(l1) [1, 4, 9, 16, 25, 36, 49, 64, 81, 100] 1.2.2 ç­›é€‰æ¨¡å¼ [åŠ å·¥åçš„å˜é‡ forå¾ªç¯ æ¡ä»¶] //ä»£ç ç¤ºä¾‹1 æ‰¾å‡º30ä»¥å†…å¯ä»¥è¢«3æ•´é™¤çš„æ•° åŸå…ˆçš„ä»£ç  lst = [] for i in range(1,31): if i % 3 == 0: lst.append(i) print (lst) [3, 6, 9, 12, 15, 18, 21, 24, 27, 30] åˆ—è¡¨æ¨å¯¼å¼ f = [i for i in range(1,31) if i % 3 == 0] print (f) âš ï¸æ¨å¯¼å¼å¤–è¾¹åŠ æ‹¬å·å°±æ˜¯è¿”å›ç”Ÿæˆå™¨çš„å†…å­˜ç©ºé—´åœ°å€ f = (i for i in range(1,31) if i % 3 == 0) print (f) at 0x7fa7281a7d00> 1.3 å­—å…¸æ¨å¯¼å¼ æ™®é€šå¾ªç¯ ç­›é€‰æ¨¡å¼ 1.3.1 æ™®é€šå¾ªç¯ print({i:i+1 for i in range(3)}) {0: 1, 1: 2, 2: 3} 1.3.2 ç­›é€‰æ¨¡å¼ print({i:i+1 for i in range(3) if i > 1}) {åŠ å·¥åçš„å˜é‡:åŠ å·¥çš„åçš„å˜é‡ forå¾ªç¯ åŠ å·¥æ¡ä»¶} {2: 3} 1.4 é›†åˆæ¨å¯¼å¼ æ™®é€šå¾ªç¯ ç­›é€‰æ¨¡å¼ 1.4.1 æ™®é€šå¾ªç¯ print({i for i in range(3)}) {0, 1, 2} 1.4.2 ç­›é€‰æ¨¡å¼ print({i for i in range(3) if i > 1}) {2} 1.5 ç”Ÿæˆå™¨æ¨å¯¼å¼ æ™®é€šå¾ªç¯ ç­›é€‰æ¨¡å¼ 1.5.1 æ™®é€šæ¨¡å¼ g = (i for i in range(3)) print(next(g)) print(next(g)) 0 1 1.5.2 ç­›é€‰æ¨¡å¼ g = (i for i in range(3) if i+1 == 2) print (next(g)) 1 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/17.pythonåŸºç¡€åä¸ƒ åŒ¿åå‡½æ•°.html":{"url":"python/pythonåŸºç¡€/17.pythonåŸºç¡€åä¸ƒ åŒ¿åå‡½æ•°.html","title":"pythonåŸºç¡€åä¸ƒ åŒ¿åå‡½æ•°","keywords":"","body":"pythonåŸºç¡€åä¸ƒ åŒ¿åå‡½æ•° 1. å®šä¹‰ ç¤ºä¾‹ï¼šç»™å‡½æ•°ä¼ ä¸¤ä¸ªå‚æ•°å¹¶è®¡ç®—å’Œ f = lambda a,b:a+b å…¶ä¸­ a,bè¡¨ç¤ºå½¢å‚ï¼Œå¯ä»¥ä¼ å¤šä¸ªï¼Œå†’å·åè¾¹çš„è¡¨ç¤ºå‡½æ•°ä½“ä¸­è¦æ‰§è¡Œçš„ä»£ç  2. lambdaå‡½æ•°ç®€å•ç¤ºä¾‹è¯´æ˜ //ä»£ç ç¤ºä¾‹ ç»™å‡½æ•°ä¼ ä¸¤ä¸ªå‚æ•°å¹¶è®¡ç®—å’Œ æ™®é€šå‡½æ•°å†™æ³• def func(a,b): c = a + b return c print(func(1,2)) 3 åŒ¿åå‡½æ•°å†™æ³•1 f = lambda a,b:a+b print(f(1,2)) 3 åŒ¿åå‡½æ•°å†™æ³•2 print((lambda a,b:a+b)(1,2)) 3 3. lambdaå‡½æ•°ä¸æ™®é€šå‡½æ•°å¯¹æ¯”è¯´æ˜ æ™®é€šå‡½æ•°å†™æ³• def func(a,b): c = a + b return c print(func(1,2)) åŒ¿åå‡½æ•°å†™æ³• print((lambda a,b:a+b)(1,2)) 1.lambdaå’Œdefæ˜¯ä¸€æ ·çš„ 2.lambdaä¸­çš„ a,b å’Œdefä¸­çš„ï¼ˆa,bï¼‰æ˜¯ä¸€æ ·çš„ 3.lambdaä¸­çš„ a+b å’Œdefä¸­çš„ return a + b æ˜¯ä¸€æ ·çš„ 4.lambdaä¸­a,bæ˜¯å½¢å‚ï¼Œa+bæ˜¯è¿”å›å€¼ï¼Œå³å†’å·å‰è¾¹çš„æ˜¯å½¢å‚ï¼Œå†’å·åè¾¹çš„è¿”å›å€¼ å½¢å‚ï¼šå¯ä»¥æ¥å—ä½ç½®å‚æ•°ã€åŠ¨æ€ä½ç½®å‚æ•°ã€é»˜è®¤å‚æ•°ã€åŠ¨æ€å…³é”®å­—å‚æ•° è¿”å›å€¼ï¼šåªèƒ½è¿”å›ä¸€ä¸ªæ•°æ®ï¼Œå¦‚æœæƒ³è¿”å›å¤šä¸ªæ•°æ®ï¼Œéœ€è¦ç”¨()æ‹¬èµ·æ¥ 4. åŒ¿åå‡½æ•°é£éªšèµ°ä½ 4.1 lambda+åˆ—è¡¨ ç¤ºä¾‹1 //ç¤ºä¾‹1 è¿™ç§å†™æ³•ç»“æœæ˜¯3ä¸ªå‡½æ•°åœ°å€ print([lambda i:i+1 for i in range(3)]) [. at 0x7f9bf0068620>, . at 0x7f9bf00681e0>, . at 0x7f9bf0068048>] æ‹†åˆ†å†™æ³• lst = [] for i in range(3): def func(i): return i+1 lst.append(func) print(lst) [, , ] ç¤ºä¾‹1è¿›é˜¶ç‰ˆ //é”™è¯¯å†™æ³•ç¤ºä¾‹ g = [lambda i:i+1 for i in range(3)] #lambdaåè¾¹çš„iä¸forå¾ªç¯ä¸­çš„iæ²¡æœ‰å…³ç³» print([em() for em in g]) ç»“æœæŠ¥é”™ï¼Œå› ä¸ºlambdaåçš„iæ˜¯å½¢å‚ï¼Œem()æ²¡æœ‰ä¼ å‚ï¼Œå› æ­¤æŠ¥é”™ æ‹†åˆ†å†™æ³• lst = [] for i in range(3): def func(i): return i+1 lst.append(func) new_lst = [] for em in lst: new_lst.append(em()) #è¿™é‡Œçš„em()å°±æ˜¯func() ç»“æœæŠ¥é”™ï¼Œå› ä¸ºem()æ²¡æœ‰ä¼ å‚ //æ­£ç¡®å†™æ³•ç¤ºä¾‹ g = [lambda i:i+1 for i in range(3)] #lambdaåè¾¹çš„iä¸forå¾ªç¯ä¸­çš„iæ²¡æœ‰å…³ç³» print([em(3) for em in g]) [4, 4, 4] æ‹†åˆ†å†™æ³• lst = [] for i in range(3): def func(i): return i+1 lst.append(func) new_lst = [] for em in lst: #æ­¤æ—¶lst = [func,func,func] new_lst.append(em(3)) #è¿™é‡Œçš„em()å°±æ˜¯func() print(new_lst) [4, 4, 4] ç¤ºä¾‹2 ğŸ¦™ğŸ¦™ğŸ¦™è¿™ä¸ªé¢˜ä¸€èˆ¬äººèƒ½æƒ³åˆ°ï¼Ÿï¼Ÿï¼Ÿ g = [lambda x:x*i for i in range(3)] for j in [2,10]: g1 = (em(3) for em in g) print([e+j for e in g1]) [16, 16, 16] ä»£ç æ‹†åˆ† #g = [lambda x:x*i for i in range(3)]æ‹†åˆ†å¦‚ä¸‹ lst = [] #å¾ªç¯å®Œåè¿™é‡Œæ˜¯3ä¸ªå‡½æ•° [func,func,func] for i in range(3): def func(x): return x*i lst.append(func) for j in [2,10]: #è¿™é‡Œæ‰§è¡Œå®Œåjå°±æ˜¯10 def g1(): #ç”Ÿæˆå™¨å­˜æ”¾äºg1ä¸­,å…ˆå¾ªç¯2ï¼Œç„¶åå¾ªç¯10ï¼Œä¼šè¦†ç›– for em in lst: yield em(3) new_lst = [] for e in g1(): #g1()äº§ç”Ÿäº†ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œä¸€æ‰§è¡Œå°±è§¦å‘for em in lstï¼Œlstæ˜¯3ä¸ªfuncï¼Œè¿™é‡Œå°±æ˜¯yield em(3)ï¼Œæ‰§è¡Œ3æ¬¡func(3),å°±æ˜¯æ‰§è¡Œ3æ¬¡return 3*2ï¼Œå› ä¸ºiçš„forå¾ªç¯å·²ç»æ‰§è¡Œå®Œæˆï¼Œæœ€åçš„å€¼iæ˜¯2 new_lst.append(e+j) #6+10ï¼Œå¾ªç¯3æ¬¡ print(new_lst) [16, 16, 16] 4.2 lambda+ç”Ÿæˆå™¨ //ç¤ºä¾‹1 g = (lambda i:i+1 for i in range(3)) #lambdaåè¾¹çš„iä¸forå¾ªç¯ä¸­çš„iæ²¡æœ‰å…³ç³» print([em(3) for em in g]) [4, 4, 4] #ä»£ç è§£æ lambda i:i+1ä¸for i in range(3)æ²¡æœ‰ä»»ä½•å…³ç³»ï¼ï¼ï¼ åªæ˜¯å€ŸåŠ©forå¾ªç¯æ‰§è¡Œäº†3æ¬¡ return i+1 em(3)å°±æ˜¯ç»™iä¼ é€’äº†å‚æ•°ï¼Œå› æ­¤æ‰§è¡Œ3æ¬¡ i+1 æ‹†åˆ†å†™æ³• def foo(): for j in range(3): def func(i): return i+1 yield func g = foo() lst = [] for i in g: #è¿™é‡Œçš„iå°±æ˜¯func lst.append(i(3)) print(lst) [4, 4, 4] //ç¤ºä¾‹2 g = [lambda :i+1 for i in range(3)] print([em() for em in g]) [3, 3, 3] #g = [lambda :i+1 for i in range(3)]æ‹†åˆ†åå¦‚ä¸‹ g = [] #å¾ªç¯3æ¬¡åï¼Œåˆ—è¡¨ä¸­æ˜¯3ä¸ªfunc [func,func,func] for i in range(3): def func(): return i+1 g.append(func) #print([em() for em in g])æ‹†åˆ†åå¦‚ä¸‹ new_lst = [] for em in g: #è¿™é‡Œçš„gæ˜¯[func,func,func] new_lst.append(em()) #em()å°±æ˜¯è°ƒç”¨å‡½æ•°func()ï¼Œå› ä¸ºä¸Šè¾¹çš„forå¾ªç¯å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼Œå› æ­¤return i+1å°±æ˜¯2+1=3,æ‰€ä»¥è¿™é‡Œè¿½åŠ 3æ¬¡func()ï¼Œfunc()å°±æ˜¯æ‰§è¡Œreturn 2+1ï¼Œæ‰€ä»¥ç»“æœæ˜¯3æ¬¡3 print(new_lst) 4.3 lambda+åˆ—è¡¨ä¸lambda+ç”Ÿæˆå™¨å¯¹æ¯” //ä¸ä¼ å‚ç¤ºä¾‹ g = [lambda :i+1 for i in range(3)] print([em() for em in g]) [3, 3, 3] g = (lambda :i+1 for i in range(3)) print([em() for em in g]) [1, 2, 3] //ä¼ å‚ç¤ºä¾‹ g = [lambda x:x*i for i in range(3)] print([em(3) for em in g]) [6, 6, 6] g = (lambda x:x*i for i in range(3)) print([em(3) for em in g]) [0, 3, 6] æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/18.pythonåŸºç¡€åå…« å†…ç½®å‡½æ•°.html":{"url":"python/pythonåŸºç¡€/18.pythonåŸºç¡€åå…« å†…ç½®å‡½æ•°.html","title":"pythonåŸºç¡€åå…« å†…ç½®å‡½æ•°","keywords":"","body":"pythonåŸºç¡€åå…« å†…ç½®å‡½æ•° å†…ç½®å‡½æ•° 1. å«ä¹‰ pythonå¸®åŠ©æˆ‘ä»¬å†™äº†å¾ˆå¤šçš„åŠŸèƒ½ä¾›ä½¿ç”¨ 2. äº†è§£å‡½æ•° all() any() bytes() callable() chr() complex() divmod() eval() exec() frozenset() globals() hash() help() id() input() int() iter() locals() next() oct() ord() pow() repr() round() 2.1 all åˆ¤æ–­å…ƒç´ æ˜¯å¦éƒ½ä¸ºTrueï¼Œå…¨éƒ¨ä¸ºTrueæ‰è¿”å›True print(all(['a','b','c'])) True print(all(['a','b','c',0])) False 2.2 any åˆ¤æ–­å…ƒç´ ä¸­æ˜¯å¦å«æœ‰Trueï¼Œæœ‰ä¸€ä¸ªTrueå³ä¸ºTrue print(any(['a','b','c',0])) True 2.3 bytes å­—èŠ‚ä¸² print(bytes('å‘µå‘µ',encoding='utf-8')) b'\\xe5\\x91\\xb5\\xe5\\x91\\xb5' 2.4 callable åˆ¤æ–­æ˜¯å¦å¯è°ƒç”¨ï¼Œè¿”å›å¸ƒå°”å€¼ print(callable([1,1])) False def func(): pass print(callable(func)) True 2.5 chr æ ¹æ®å½“å‰ç¼–ç ï¼ˆunicodeï¼Œå…¼å®¹æ‰€æœ‰ï¼‰æŸ¥å¯¹åº”çš„å†…å®¹ print (chr(15678)) æ‘ 2.6 ord æŸ¥çœ‹å†…å®¹å¯¹åº”çš„ç¼–ç  print (ord('æ‘')) 15678 2.7 complex å¤æ•° print(complex(10)) (10+0j) 2.8 divmod è·å–çš„æ˜¯å…ƒç»„ï¼Œç¬¬ä¸€ä¸ªæ˜¯å•†ï¼Œç¬¬äºŒä¸ªæ˜¯ä½™æ•° print(divmod(10,3)) (3, 1) 2.9 hash æŸ¥çœ‹å†…å®¹æ˜¯å¦å¯å“ˆå¸Œ print(hash(111)) #ç»“æœ111 print(hash([1,1,3])) #ç»“æœæŠ¥é”™TypeError: unhashable type: 'list' 2.10 help æŸ¥çœ‹å¸®åŠ© print (help(str)) 2.11bin åè¿›åˆ¶è½¬æ¢æˆäºŒè¿›åˆ¶ print(bin(10)) 0b1010 2.12 oct åè¿›åˆ¶è½¬æ¢æˆå…«è¿›åˆ¶ print(oct(10)) 0o11 2.13 hex åè¿›åˆ¶è½¬æ¢æˆåå…­è¿›åˆ¶ print(hex(10)) 0xa 2.14 int å…¶ä»–è¿›åˆ¶è½¬æ¢ä¸ºåè¿›åˆ¶ int(\"xxx\",16) åå…­è¿›åˆ¶è½¬æ¢ä¸º10è¿›åˆ¶ int(\"xxx\",8) å…«è¿›åˆ¶è½¬æ¢ä¸º10è¿›åˆ¶ 2.15 pow å¹‚ print(pow(3,1)) 9 2.16 repr æ˜¾ç¤ºæ•°æ®ç±»å‹ åŸå½¢å¿…æ¼ s = \"113\" s1 = 113 print(repr(s)) #åŸå½¢å¿…æ¼ '113' print(s1) #113 2.17 round ä¿ç•™å°æ•°ä½ï¼Œé»˜è®¤å–å€¼ print(round(1.431341314,3)) 2.18 frozenset å†»ç»“é›†åˆ //åˆ›å»ºå¯å˜é›†åˆ s={'a','b'} print(s) {'a', 'b'} ä¿®æ”¹é›†åˆ s.add('c') print(s) {'a', 'b', 'c'} //åˆ›å»ºä¸å¯å˜é›†åˆ s=frozenset('abc') print(s) frozenset({'b', 'c', 'a'}) print(type(s)) å°è¯•ä¿®æ”¹ä¸å¯å˜é›†åˆ s.add('d') print(s) ç»“æœæŠ¥é”™ AttributeError: 'frozenset' object has no attribute 'add' 2.19 eval âš ï¸ç¦ç”¨ evalä¼šå°†å­—ç¬¦ä¸²è½¬æˆè¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼Œæ¯”è¾ƒå±é™© è¿™æ ·å°±å¯ä»¥åˆ©ç”¨æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œæ‰§è¡Œåˆ é™¤æ–‡ä»¶ç­‰æ“ä½œï¼Œå› æ­¤ç¦ç”¨ //ä»£ç ç¤ºä¾‹1 evalå‡½æ•°ä¼šå°†å­—ç¬¦ä¸²è½¬æ¢æˆè¡¨è¾¾å¼æ‰§è¡Œ msg = \"1+2+3\" print(eval(msg)) 6 //ä»£ç ç¤ºä¾‹2 å±é™©ç”¨æ³•ï¼Œå¯ä»¥æ‰§è¡Œç”¨æˆ·è¾“å…¥çš„ä»»ä½•å†…å®¹ å¦‚æœç”¨åœ¨äº†ç”¨æˆ·è¯„è®ºä¸­ï¼Œåˆ™ç”¨æˆ·è¯„è®ºè¾“å…¥çš„å†…å®¹å°±ä¼šæ‰§è¡Œï¼Œä¾‹å¦‚è¾“å…¥æ­»å¾ªç¯ã€åˆ é™¤ç­‰æ“ä½œï¼Œéå¸¸å±é™© msg = \"input('>>>')\" print(eval(msg)) 2.20 exec âš ï¸ç¦ç”¨ æ¯”è¾ƒå±é™©ï¼Œmsgä¸­çš„ä»»ä½•ä»£ç éƒ½ä¼šæ‰§è¡Œ //ä»£ç ç¤ºä¾‹ msg = \"\"\" def func(): print(\"è¿™ä¹ˆç‰›é€¼\") func() \"\"\" print(exec(msg)) è¿™ä¹ˆç‰›é€¼ None 3. é‡ç‚¹å‡½æ•° enumerate() open() range() len() str() list() tuple() dict() set() print() sum() abs() dir() zip() format() reversed() filter() map() sorted() max() min() reduce() 3.1 abs ç»å¯¹å€¼ ä¸ç®¡æ˜¯æ­£æ•°è¿˜æ˜¯è´Ÿæ•°éƒ½æ˜¯æ­£æ•° print(abs(-6)) print(abs(6)) 6 6 3.2 format æ ¼å¼è½¬æ¢ 1.å¯¹é½æ–¹å¼ s = \"ä½ å¥½\" s1 = format(s,\">10\") s1 = format(s,\" 3.3 enumerate æšä¸¾ enumerate() å‡½æ•°ç”¨äºå°†ä¸€ä¸ªå¯éå†çš„æ•°æ®å¯¹è±¡(å¦‚åˆ—è¡¨ã€å…ƒç»„æˆ–å­—ç¬¦ä¸²)ç»„åˆä¸ºä¸€ä¸ªç´¢å¼•åºåˆ—ï¼ŒåŒæ—¶åˆ—å‡ºæ•°æ®å’Œæ•°æ®ä¸‹æ ‡ï¼Œä¸€èˆ¬ç”¨åœ¨ for å¾ªç¯å½“ä¸­ã€‚ s = ['a','b','c'] lst = list(enumerate(s)) print (lst) [(0, 'a'), (1, 'b'), (1, 'c')] lst = list(enumerate(s,start=1)) print (lst) [(1, 'a'), (3, 'b'), (4, 'c')] 3.4 sum æ±‚å’Œ print(sum([1,1,3,4])) 10 3.5 print æ‰“å° 1.æ–‡ä»¶æµ f = open('a','a',encoding=\"utf-8\") print ('hehe',file=f) ä¼šåœ¨å½“å‰pyæ–‡ä»¶ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶aï¼Œæ–‡ä»¶aä¸­çš„å†…å®¹ä¸ºhehe 2.ä¿®æ”¹printé»˜è®¤æ¢è¡Œ //printé»˜è®¤æœ‰æ¢è¡Œç¬¦ print ('a') print ('b') a b //ä¿®æ”¹printé»˜è®¤æ¢è¡Œç¬¦ print ('a',end=\"|\") print ('b') a|b //ä¿®æ”¹printé»˜è®¤åˆ†éš”ç¬¦ printé»˜è®¤ä»¥ç©ºæ ¼åˆ†éš” print ('a','b') a b print ('a','b',sep='?') a?b 3.6 zip æ‹‰é“¾ lst1 = [1,2,3,4,5] lst2 = [5,4,3,2,1] å°†lst1å’Œlst2ä¸­ä¸‹æ ‡ç›¸åŒçš„å…ƒç´ ç»„æˆä¸€ä¸ªæ–°çš„ç»“æ„ //lambda+mapå†™æ³• print (list(map(lambda x,y:(x,y),lst1,lst2))) [(1, 5), (2, 4), (3, 3), (4, 2), (5, 1)] //list+zipå†™æ³• lst1 = [1,2,3,4,5] lst2 = [5,4,3,2,1] print (list(zip(lst1,lst2))) [(1, 5), (2, 4), (3, 3), (4, 2), (5, 1)] //å§æ§½ lst1 = [1,2,3,4,5] lst2 = [5,4,3,2,1] print (dict(zip(lst1,lst2))) {1: 5, 2: 4, 3: 3, 4: 2, 5: 1} 4.é«˜é˜¶å‡½æ•° filter() map() reduce() ä»¥ä¸Š3ä¸ªå‡½æ•°å¿…é¡»æœ‰æ¡ä»¶å’Œå‚æ•°ï¼ï¼ï¼ max() min() sorted() 4.1 filter ğŸŒŸğŸŒŸğŸŒŸ è¿‡æ»¤ ç­›é€‰åˆ—è¡¨ä¸­æ•°å­—å¤§äº5çš„ lst = [1,2,3,5,66,7,8,9] åŸå…ˆä»£ç  new_lst = [] for i in lst: if i > 5: new_lst.append(i) print (new_lst) [66, 7, 8, 9] filteré«˜é˜¶å‡½æ•°å†™æ³• //å†™æ³•1 lst = [1,2,3,5,66,7,8,9] def func(x): return x > 5 print (list(filter(func,lst))) [66, 7, 8, 9] //å†™æ³•2 lst = [1,2,3,5,66,7,8,9] print (list(filter(lambda x:x>5,lst))) [66, 7, 8, 9] 4.2 map ğŸŒŸğŸŒŸğŸŒŸ æ˜ å°„ æ˜ å°„ï¼Œå°†å¯è¿­ä»£å¯¹è±¡ä¸­æ¯ä¸ªå…ƒç´ æ‰§è¡Œå‡½æ•°åŠŸèƒ½ //ç¤ºä¾‹1 å°†åˆ—è¡¨ä¸­çš„å…ƒç´ è½¬æ¢æˆå­—ç¬¦ä¸² lst = [1,2,3,4,5] new_lst = [] for i in lst: new_lst.append(str(i)) print (new_lst) ['1', '2', '3', '4', '5'] é«˜é˜¶å‡½æ•°å†™æ³• lst = [1,2,3,4,5] print (list(map(str,lst))) ['1', '2', '3', '4', '5'] //ç¤ºä¾‹2 å°†ä¸¤ä¸ªåˆ—è¡¨ä¸­ä¸‹æ ‡ç›¸åŒçš„å…ƒç´ ç›¸åŠ  åŸå…ˆä»£ç  lst1 = [1,2,3] lst2 = [3,2,1] for i in range(len(lst1)): print (lst1[i] + lst2[i]) 4 4 4 é«˜é˜¶å‡½æ•°å†™æ³• //å†™æ³•1 lst1 = [1,2,3] lst2 = [3,2,1] def func(x,y): return x+y print (list(map(func,lst1,lst2))) [4, 4, 4] //å†™æ³•2 lst1 = [1,2,3] lst2 = [3,2,1] print (list(map(lambda x,y:x+y,lst1,lst2))) [4, 4, 4] //å†™æ³•3 å½“ä¸¤ä¸ªåˆ—è¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°ä¸åŒæ—¶ lst1 = [1,2,3,4] lst2 = [3,2,1] lst3 = [9,8,7,6,5] print (list(map(lambda x,y,z:x+y+z,lst1,lst2,lst3))) [13, 12, 11] âš ï¸åªç›¸åŠ æœ€çŸ­çš„ 4.3 reduce ğŸŒŸğŸŒŸğŸŒŸ ç´¯è®¡ç®— lst = [1,2,3,4,5] from functools import reduce def func(x,y): return x+y print(reduce(func,lst)) 15 ç´¯è®¡ç®—è¿‡ç¨‹ 1.å°†1å’Œ2åŒæ—¶èµ‹äºˆxå’Œyï¼Œæ­¤æ—¶xä¸º3ï¼Œå°†3èµ‹äºˆy,æ­¤æ—¶xä¸º6ï¼Œå°†4èµ‹äºˆy,æ­¤æ—¶xä¸º10ï¼Œå°†5èµ‹äºˆyï¼Œæœ€åxå’Œyç›¸åŠ  //lambdaå†™æ³• lst = [1,2,3,4,5] from functools import reduce print (reduce(lambda x,y:x+y,lst)) 15 4.4 sorted æ’åº ç”¨äºæ’åº å¯¹ä»¥ä¸‹åˆ—è¡¨æ’åº lst = [1,2,9,5,7,8,-6] //å†™æ³•1 lst = [1,2,9,5,7,8,-6] lst.sort() #âš ï¸åŸåœ°ä¿®æ”¹ print (lst) [-6, 1, 2, 5, 7, 8, 9] //å†™æ³•2 lst = [1,2,9,5,7,8,-6] print (sorted(lst)) #âš ï¸æ–°å¼€å†…å­˜ç©ºé—´ [-6, 1, 2, 5, 7, 8, 9] å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ’åº print (sorted('hehe,ggsimida')) #å‡åº [',', 'a', 'd', 'e', 'e', 'g', 'g', 'h', 'h', 'i', 'i', 'm', 's'] print (sorted('hehe,ggsimida',reverse=True)) #é™åº ['s', 'm', 'i', 'i', 'h', 'h', 'g', 'g', 'e', 'e', 'd', 'a', ','] é«˜é˜¶å‡½æ•°å†™æ³• æŒ‰ç…§é•¿åº¦è¿›è¡Œæ’åº //å†™æ³•1 lst = ['ä½ å¥½å•Š','å‘µå‘µ','ä¸å¥½ç†è§£','å•Š'] print (sorted(lst,key=len)) ['å•Š', 'å‘µå‘µ', 'ä½ å¥½å•Š', 'ä¸å¥½ç†è§£'] âš ï¸sortedè¿™é‡Œè¦å…ˆå†™æ“ä½œå¯¹è±¡åï¼Œç„¶åæŒ‡å®škeyï¼Œæ ¹æ®ä»€ä¹ˆè¿›è¡Œæ’åº //å†™æ³•2 lst = ['ä½ å¥½å•Š','å‘µå‘µ','ä¸å¥½ç†è§£','å•Š'] print (sorted(lst,key=lambda x:len(x))) ['å•Š', 'å‘µå‘µ', 'ä½ å¥½å•Š', 'ä¸å¥½ç†è§£'] 4.5 max() æœ€å¤§ min()æœ€å° print (max([1,2,3,5,6,-8])) 6 print (max([1,2,3,5,6,-8],key=abs)) #ä¸ç®¡æ­£è´Ÿæ•°ï¼Œé€‰æ‹©æœ€å¤§ dic = {'a':3,'b':2,'c':1} print (max(dic,key=lambda x:dic[x])) #æŒ‰å€¼æ’åºæ‹¿åˆ°é”® a print (min([1,2,3,5,6,-8])) 8 print (min([1,2,3,5,6,-8],key=abs)) #ä¸ç®¡æ­£è´Ÿæ•°ï¼Œé€‰æ‹©æœ€å° æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/19.pythonåŸºç¡€åä¹ åºåˆ—åŒ–.html":{"url":"python/pythonåŸºç¡€/19.pythonåŸºç¡€åä¹ åºåˆ—åŒ–.html","title":"pythonåŸºç¡€åä¹ åºåˆ—åŒ–","keywords":"","body":"pythonåŸºç¡€åä¹ åºåˆ—åŒ– 1. å«ä¹‰ å°†ä¸€ä¸ªæ•°æ®ç±»å‹è½¬æ¢æˆå¦ä¸€ä¸ªæ•°æ®ç±»å‹ 2. åˆ†ç±» 2.1 json è½¬æ¢æˆå­—ç¬¦ä¸² dump load ç”¨äºæ–‡ä»¶å†™å…¥å­˜å‚¨ dumps(åºåˆ—) loads(ååºåˆ—) ç”¨äºç½‘ç»œä¼ è¾“ //dumpsã€loadsç”¨æ³• ğŸŒŸåˆ—è¡¨ import json lst = [1,2,3] a = json.dumps(lst) #å°†åˆ—è¡¨è½¬æ¢ä¸ºå­—ç¬¦ä¸² print(a) #[1, 2, 3] print(type(a)) # b = json.loads(a) #å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ—è¡¨ print(b) #[1, 2, 3] print(type(b)) # âš ï¸åˆ—è¡¨ä¸­æœ‰ä¸­æ–‡ lst = ['å‘µå‘µ','å“ˆå“ˆ'] a = json.dumps(a) print(a) #[\"\\u5475\\u5475\", \"\\u54c8\\u54c8\"]ï¼Œç›´æ¥è½¬ä¸­æ–‡æœ‰é—®é¢˜ åŠ å‚æ•°ensure_ascii=Falseè§£å†³ lst = ['å‘µå‘µ','å“ˆå“ˆ'] a = json.dumps(lst,ensure_ascii=False) print(a) #[\"å‘µå‘µ\", \"å“ˆå“ˆ\"] ğŸŒŸå­—å…¸ import json dic = {\"key\":1,\"key2\":3} a = json.dumps(dic) #å°†å­—å…¸è½¬æ¢æˆå­—ç¬¦ä¸² print(a) print(type(a)) {\"key\": 1, \"key2\": 3} b = json.loads(a) #å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—å…¸ print(b) print(type(b)) {'key': 1, 'key2': 3} print(json.loads(a)['key']) #å­—å…¸å–å€¼ 1 2.2 pickle å‡ ä¹æ”¯æŒpythonä¸­æ‰€æœ‰çš„å¯¹è±¡(ä¸æ”¯æŒlambda) è½¬æ¢æˆå­—èŠ‚ pickleå†™å…¥å¤šè¡Œæ—¶è‡ªåŠ¨å¸¦æœ‰æ¢è¡Œ dump load ç”¨äºæ–‡ä»¶å†™å…¥å­˜å‚¨ dumps loads ç”¨äºç½‘ç»œä¼ è¾“ //å°†å‡½æ•°è½¬æ¢ä¸ºå­—èŠ‚ import pickle def func(): print(111) a = pickle.dumps(func) #å°†å‡½æ•°è½¬æ¢ä¸ºå­—èŠ‚ print(a) print(type(a)) b'\\x80\\x03c__main__\\nfunc\\nq\\x00.' b = pickle.loads(a) #å°†å­—èŠ‚è½¬æ¢ä¸ºå‡½æ•° b() print(type(b)) 111 //å°†å…ƒç»„è½¬æ¢ä¸ºå­—èŠ‚ tu = (1,2,3,4,5) import pickle a = pickle.dumps(tu) #å°†å…ƒç»„è½¬æ¢ä¸ºå­—èŠ‚ print(a) b'\\x80\\x03(K\\x01K\\x02K\\x03K\\x04K\\x05tq\\x00.' b = pickle.loads(a) #å°†å­—èŠ‚è½¬æ¢ä¸ºå…ƒç»„ print(b) (1, 2, 3, 4, 5) æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/20.pythonåŸºç¡€äºŒå æ­£åˆ™è¡¨è¾¾å¼.html":{"url":"python/pythonåŸºç¡€/20.pythonåŸºç¡€äºŒå æ­£åˆ™è¡¨è¾¾å¼.html","title":"pythonåŸºç¡€äºŒå æ­£åˆ™è¡¨è¾¾å¼","keywords":"","body":"pythonåŸºç¡€äºŒå æ­£åˆ™è¡¨è¾¾å¼ 1.æ­£åˆ™è¡¨è¾¾å¼è¯´æ˜ æ­£åˆ™å°±æ˜¯ç”¨ä¸€äº›å…·æœ‰ç‰¹æ®Šå«ä¹‰çš„ç¬¦å·ç»„åˆåˆ°ä¸€èµ·å»åŒ¹é…ç›¸åº”çš„å†…å®¹çš„æ–¹æ³•ï¼Œåœ¨pythonä¸­ï¼Œä½¿ç”¨æ­£åˆ™éœ€è¦å¯¼å…¥reæ¨¡å—æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼è¢«ç¼–è¯‘æˆä¸€ç³»åˆ—çš„å­—èŠ‚ç ï¼Œç„¶åç”¨cç¼–å†™çš„åŒ¹é…å¼•æ“æ‰§è¡Œ æ­£åˆ™è¡¨è¾¾å¼å…ƒå­—ç¬¦ å…ƒå­—ç¬¦ åŒ¹é…å†…å®¹ \\w åŒ¹é…å­—æ¯ï¼ˆåŒ…å«ä¸­æ–‡ï¼‰æˆ–æ•°å­—æˆ–ä¸‹åˆ’çº¿ \\W åŒ¹é…éå­—æ¯ï¼ˆåŒ…å«ä¸­æ–‡ï¼‰æˆ–æ•°å­—æˆ–ä¸‹åˆ’çº¿ \\s åŒ¹é…ä»»æ„çš„ç©ºç™½ç¬¦ \\S åŒ¹é…ä»»æ„éç©ºç™½ç¬¦ \\d åŒ¹é…æ•°å­— \\D åŒ¹é…éæ•°å­— \\A ä»å­—ç¬¦ä¸²å¼€å¤´åŒ¹é… \\z åŒ¹é…å­—ç¬¦ä¸²çš„ç»“æŸï¼Œå¦‚æœæ˜¯æ¢è¡Œï¼ŒåªåŒ¹é…åˆ°æ¢è¡Œå‰çš„ç»“æœ \\n åŒ¹é…ä¸€ä¸ªæ¢è¡Œç¬¦ \\t åŒ¹é…ä¸€ä¸ªåˆ¶è¡¨ç¬¦ ^ åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å§‹ $ åŒ¹é…å­—ç¬¦ä¸²çš„ç»“å°¾ . åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œé™¤äº†æ¢è¡Œç¬¦ï¼Œå½“re.DOTALLæ ‡è®°è¢«æŒ‡å®šæ—¶ï¼Œåˆ™å¯ä»¥åŒ¹é…åŒ…æ‹¬æ¢è¡Œç¬¦çš„ä»»æ„å­—ç¬¦ã€‚ [...] åŒ¹é…å­—ç¬¦ç»„ä¸­çš„å­—ç¬¦ ... åŒ¹é…é™¤äº†å­—ç¬¦ç»„ä¸­çš„å­—ç¬¦çš„æ‰€æœ‰å­—ç¬¦ * åŒ¹é…0ä¸ªæˆ–è€…å¤šä¸ªå·¦è¾¹çš„å­—ç¬¦ã€‚ + åŒ¹é…ä¸€ä¸ªæˆ–è€…å¤šä¸ªå·¦è¾¹çš„å­—ç¬¦ã€‚ ï¼Ÿ åŒ¹é…0ä¸ªæˆ–è€…1ä¸ªå·¦è¾¹çš„å­—ç¬¦ï¼Œéè´ªå©ªæ–¹å¼ã€‚ {n} ç²¾å‡†åŒ¹é…nä¸ªå‰é¢çš„è¡¨è¾¾å¼ã€‚ {n,m} åŒ¹é…nåˆ°mæ¬¡ç”±å‰é¢çš„æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰çš„ç‰‡æ®µï¼Œè´ªå©ªæ–¹å¼ ab åŒ¹é…aæˆ–è€…b () åŒ¹é…æ‹¬å·å†…çš„è¡¨è¾¾å¼ï¼Œä¹Ÿè¡¨ç¤ºä¸€ä¸ªç»„ 2.åŒ¹é…æ¨¡å¼ 2.1å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ s1 = 'pythonæ­£åˆ™ç»ƒä¹ ' print(s1.find('python')) 0 print(s1.find('æ­£åˆ™')) 6 print(s1.find('abc')) -1 2.2æ­£åˆ™åŒ¹é…ç¤ºä¾‹ \\w åŒ¹é…ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ ç»ƒä¹ _1.11' print(re.findall('\\w',s)) ç»“æœï¼š ['p', 'y', 't', 'h', 'o', 'n', 'æ­£', 'åˆ™', 'è¡¨', 'è¾¾', 'å¼', 'ç»ƒ', 'ä¹ ', '_', '1', '1', '1'] \\W å’Œ\\wç›¸åï¼Œä¸åŒ¹é…ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ ç»ƒä¹ _1.11' print(re.findall('\\W',s)) ç»“æœï¼š ['-', ' ', ' ', '.'] \\s åŒ¹é…ä»»æ„ç©ºç™½ç¬¦ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ ç»ƒä¹ _1.11' print(re.findall('\\s',s)) ç»“æœï¼ŒåŒ¹é…åˆ°äº†ç»ƒä¹ å‰è¾¹çš„ä¸¤ä¸ªç©ºæ ¼ï¼š [' ', ' '] \\d åŒ¹é…æ•°å­— import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ ç»ƒä¹ _1.11' print(re.findall('\\d',s)) ç»“æœï¼š ['1', '1', '1'] \\D ä¸\\dç›¸åï¼ŒåŒ¹é…éæ•°å­— import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ ç»ƒä¹ _1.11' print(re.findall('\\D',s)) ç»“æœï¼š ['p', 'y', 't', 'h', 'o', 'n', '-', 'æ­£', 'åˆ™', 'è¡¨', 'è¾¾', 'å¼', ' ', ' ', 'ç»ƒ', 'ä¹ ', '_', '.'] \\Aä¸^ ä»¥ä»€ä¹ˆå¼€å¤´ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ ç»ƒä¹ _1.11' print(re.findall('\\Apython',s)) print(re.findall('^python',s)) ç»“æœï¼š ['python'] \\Zä¸$ ä»¥ä»€ä¹ˆç»“å°¾ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ ç»ƒä¹ _1.11' print(re.findall('1.11\\Z',s)) print(re.findall('1.11$',s)) ç»“æœï¼š ['1.11'] \\n åŒ¹é…æ¢è¡Œç¬¦ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ \\n\\tç»ƒä¹ _1.11' print(re.findall('\\n',s)) ç»“æœï¼š ['\\n'] \\t åŒ¹é…åˆ¶è¡¨ç¬¦ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ \\n\\tç»ƒä¹ _1.11' print(re.findall('\\t',s)) ç»“æœï¼š ['\\t'] 3.åŒ¹é…æ–¹å¼ . åŒ¹é…é™¤æ¢è¡Œç¬¦å¤–çš„ä»»æ„å­—ç¬¦ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ \\n\\tç»ƒä¹ _1.11' print(re.findall('.',s)) ç»“æœï¼š ['p', 'y', 't', 'h', 'o', 'n', '-', 'æ­£', 'åˆ™', 'è¡¨', 'è¾¾', 'å¼', ' ', ' ', '\\t', 'ç»ƒ', 'ä¹ ', '_', '1', '.', '1', '1'] . å¦‚æœåŠ äº†DOTALLæ ‡è®°å°±å¯ä»¥åŒ¹é…ä»»æ„å­—ç¬¦ import re s = 'python-æ­£åˆ™è¡¨è¾¾å¼ \\n\\tç»ƒä¹ _1.11' print(re.findall('.',s,re.DOTALL)) ç»“æœï¼Œå¯ä»¥çœ‹åˆ°åŠ äº†DOTALLæ ‡å¿—å°±åŒ¹é…åˆ°äº†.åŸæœ¬æ— æ³•åŒ¹é…çš„æ¢è¡Œç¬¦\\t ['p', 'y', 't', 'h', 'o', 'n', '-', 'æ­£', 'åˆ™', 'è¡¨', 'è¾¾', 'å¼', ' ', ' ', '\\n', '\\t', 'ç»ƒ', 'ä¹ ', '_', '1', '.', '1', '1'] ? åŒ¹é…å‰è¾¹çš„å…ƒç´ å‡ºç°0ä¸ªæˆ–è€…1ä¸ª import re s = 'a-b-ab-abab-ababab-ababc' print(re.findall('ab?',s)) ç»“æœï¼ŒåŒ¹é…åˆ°äº†å…¨éƒ¨çš„8ä¸ªè¿ç»­çš„abï¼Œè¿˜å¯ä»¥åŒ¹é…åˆ°ä¸€ä¸ªaï¼Œå› ä¸ºbå¯ä»¥æ²¡æœ‰ ['a', 'ab', 'ab', 'ab', 'ab', 'ab', 'ab', 'ab', 'ab'] * åŒ¹é…å‰è¾¹çš„å…ƒç´ å‡ºç°0ä¸ªæˆ–è€…å¤šä¸ª(è´ªå©ªåŒ¹é…) import re s = 'a-b-ab-abab' print(re.findall('ab*',s)) ç»“æœï¼š ['a', 'ab', 'ab', 'ab'] + åŒ¹é…å‰è¾¹çš„å…ƒç´ å‡ºç°1ä¸ªæˆ–è€…å¤šä¸ª(è´ªå©ªåŒ¹é…) import re s = 'a-b-ab-abab' print(re.findall('ab+',s)) ç»“æœï¼š ['ab', 'ab', 'ab'] {n,m} åŒ¹é…å‰è¾¹çš„å…ƒç´ å‡ºç°nåˆ°mä¸ª import re s = 'aa-bb-aaabb-aaaaab' print(re.findall('aaa{1,3}',s)) ç»“æœï¼š ['aaa', 'aaaaa'] #å…¶ä»–åŒ¹é… {n} #å‰è¾¹çš„å­—ç¬¦å‡ºç°næ¬¡ {n,} #å‰è¾¹çš„å­—ç¬¦æœ€å°‘å‡ºç°næ¬¡ {,m} #å‰è¾¹çš„å­—ç¬¦æœ€å¤šå‡ºç°mæ¬¡ .* åŒ¹é…ä»»æ„å†…å®¹0ä¸ªæˆ–è€…å¤šä¸ª import re s = 'aa-bb-aaabb-aaaaab' print(re.findall('b.*',s)) ç»“æœï¼š ['bb-aaabb-aaaaab'] .? åŒ¹é…ä»»æ„å†…å®¹1ä¸ªæˆ–è€…å¤šä¸ª import re s = 'ab-bb-aab-aaaaab' print(re.findall('a.?b',s)) ç»“æœï¼š ['ab', 'aab', 'aab'] [] èŒƒå›´åŒ¹é… import re s = 'ab-bb-aab-123' print(re.findall('[a-z]',s)) ç»“æœï¼š ['a', 'b', 'b', 'b', 'a', 'a', 'b'] ä¸èŒƒå›´åŒ¹é…ç›¸åï¼Œä¸åŒ¹é…ä¸­æ‹¬å·ä¸­çš„å†…å®¹ import re s = 'ab-bb-aab-123' print(re.findall('[^a-z]',s)) ç»“æœï¼š ['-', '-', '-', '1', '2', '3'] 4.å¸¸ç”¨æ–¹æ³• 4.1findall å…¨éƒ¨æ‰¾åˆ°å¹¶è¿”å›ä¸€ä¸ªåˆ—è¡¨ import re s = 'ab-bb-aab-abc-abbc' print(re.findall('abc',s)) ['abc'] 4.2search ä»å­—ç¬¦ä¸²ä»»æ„ä½ç½®è¿›è¡ŒåŒ¹é…ï¼ŒæŸ¥æ‰¾åˆ°ä¸€ä¸ªå°±åœæ­¢ è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè·å–åŒ¹é…å†…å®¹å¿…é¡»ä½¿ç”¨.group() import re s = 'ab-bb-abc-abc-abbc' print(re.search('abc',s)) ç»“æœï¼Œå¦‚æœä¸åŠ .group()è·å–åŒ¹é…å†…å®¹ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ #ä½¿ç”¨.group()æ–¹æ³•è·å–åŒ¹é…å†…å®¹ print(re.search('abc',s).group()) abc 4.3match ä»å­—ç¬¦ä¸²å¼€å§‹ä½ç½®è¿›è¡ŒåŒ¹é… import re s = 'ab-bb-abc-abc-abbc' print(re.match('ab ',s).group()) ab #ä»¥ä¸Šç¤ºä¾‹ä¸­å¿…é¡»ä»¥aæˆ–è€…abå¼€å§‹æŸ¥çœ‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ print(re.match('bb ',s).group()) AttributeError: 'NoneType' object has no attribute 'group' 4.4split åˆ†éš”ï¼Œå¯æŒ‰ç…§ä»»æ„åˆ†éš”ç¬¦è¿›è¡Œåˆ†éš” import re s = 'ab-bb-abc-abc-abbc' print(re.split('bb',s)) #ä»¥bbä¸ºåˆ†éš”ç¬¦ ç»“æœï¼š ['ab-', '-abc-abc-a', 'c'] 4.5sub æ›¿æ¢ import re s = 'ab-bb-abc-abc-abbc' print(re.sub('bb','å‘µå‘µ',s)) #å°†bbæ›¿æ¢ä¸ºå‘µå‘µ ç»“æœï¼š ab-å‘µå‘µ-abc-abc-aå‘µå‘µc 4.6compile å®šä¹‰åŒ¹é…è§„åˆ™ import re s = 'ab-123-abc-abc-a123bbc' obj = re.compile('\\d{2}') #å®šä¹‰åŒ¹é…è§„åˆ™ï¼Œæ•°å­—å‡ºç°2æ¬¡ print(obj.findall(s)) ç»“æœï¼š ['12', '12'] 4.7finditer è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ æ ¼å¼ re.finditer('åŒ¹é…çš„å†…å®¹',æ“ä½œçš„å¯¹è±¡) import re s = 'ab-123-abc-abc-a123bbc' g = re.finditer('ab',s) #'ab'ä¸ºåŒ¹é…çš„å†…å®¹ï¼Œsä¸ºæ“ä½œçš„å¯¹è±¡ print(next(g).group()) ç»“æœï¼š ab 4.8ç»™åˆ†ç»„()èµ·åå­— æ ¼å¼ (?P) import re s = 'ab-123-abc-abc-a123bbc' ret = re.search('(?P)abc',s) #ç»™åˆ†ç»„èµ·åä¸ºtest_abc print(ret.group()) ç»“æœï¼š abc æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/21.pythonåŸºç¡€äºŒåä¸€ loggingæ—¥å¿—.html":{"url":"python/pythonåŸºç¡€/21.pythonåŸºç¡€äºŒåä¸€ loggingæ—¥å¿—.html","title":"pythonåŸºç¡€äºŒåä¸€ loggingæ—¥å¿—","keywords":"","body":"pythonåŸºç¡€äºŒåä¸€ loggingæ—¥å¿— æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/22.pythonåŸºç¡€äºŒåäºŒ åŒ….html":{"url":"python/pythonåŸºç¡€/22.pythonåŸºç¡€äºŒåäºŒ åŒ….html","title":"pythonåŸºç¡€äºŒåäºŒ åŒ…","keywords":"","body":"pythonåŸºç¡€äºŒåäºŒ åŒ… æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/23.pythonåŸºç¡€äºŒåä¸‰ å¼‚å¸¸å¤„ç†.html":{"url":"python/pythonåŸºç¡€/23.pythonåŸºç¡€äºŒåä¸‰ å¼‚å¸¸å¤„ç†.html","title":"pythonåŸºç¡€äºŒåä¸‰ å¼‚å¸¸å¤„ç†","keywords":"","body":"pythonåŸºç¡€äºŒåä¸‰ å¼‚å¸¸å¤„ç† 1.å¼‚å¸¸å’Œé”™è¯¯ 1.1é”™è¯¯ 1.1.1è¯­æ³•é”™è¯¯ #ifåè¾¹æ²¡æœ‰åŠ å†’å·ï¼Œå±äºè¯­æ³•é”™è¯¯ï¼Œæ— æ³•é€šè¿‡pythonè§£é‡Šå™¨ï¼Œå¿…é¡»è¿è¡Œå‰ä¿®æ”¹ num = 10 if num == 11 print('ok') ç»“æœæŠ¥é”™ï¼š SyntaxError: invalid syntax 1.1.2é€»è¾‘é”™è¯¯ #é™¤æ•°ä¸º0 num = 10 print(num/0) ç»“æœæŠ¥é”™ï¼š ZeroDivisionError: division by zero 1.2å¼‚å¸¸ ä»€ä¹ˆæ˜¯å¼‚å¸¸ï¼Ÿ å¼‚å¸¸å³æ˜¯ä¸€ä¸ªäº‹ä»¶ï¼Œè¯¥äº‹ä»¶ä¼šåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿï¼Œå½±å“äº†ç¨‹åºçš„æ­£å¸¸æ‰§è¡Œã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨Pythonæ— æ³•æ­£å¸¸å¤„ç†ç¨‹åºæ—¶å°±ä¼šå‘ç”Ÿä¸€ä¸ªå¼‚å¸¸ã€‚ å¼‚å¸¸æ˜¯Pythonå¯¹è±¡ï¼Œè¡¨ç¤ºä¸€ä¸ªé”™è¯¯ã€‚ å½“Pythonè„šæœ¬å‘ç”Ÿå¼‚å¸¸æ—¶æˆ‘ä»¬éœ€è¦æ•è·å¤„ç†å®ƒï¼Œå¦åˆ™ç¨‹åºä¼šç»ˆæ­¢æ‰§è¡Œã€‚ 1.3pythonä¸­å¼‚å¸¸çš„ç±» é”™è¯¯ç¤ºä¾‹ #è§¦å‘IndexError: ç´¢å¼•è¶…å‡ºèŒƒå›´ lst = [1,2,3] print(lst[5]) ç»“æœæŠ¥é”™ï¼š IndexError: list index out of range #è§¦å‘KeyError: å­—å…¸ä¸­æ²¡æœ‰æ­¤é”® dic = {'k1':1,'k2':2} print(dic['k3']) ç»“æœæŠ¥é”™ï¼š KeyError: 'k3' å¸¸è§å¼‚å¸¸ å¼‚å¸¸åç§° æè¿° BaseException æ‰€æœ‰å¼‚å¸¸çš„åŸºç±» SystemExit è§£é‡Šå™¨è¯·æ±‚é€€å‡º KeyboardInterrupt ç”¨æˆ·ä¸­æ–­æ‰§è¡Œ(é€šå¸¸æ˜¯è¾“å…¥^C) Exception å¸¸è§„é”™è¯¯çš„åŸºç±» StopIteration è¿­ä»£å™¨æ²¡æœ‰æ›´å¤šçš„å€¼ GeneratorExit ç”Ÿæˆå™¨(generator)å‘ç”Ÿå¼‚å¸¸æ¥é€šçŸ¥é€€å‡º StandardError æ‰€æœ‰çš„å†…å»ºæ ‡å‡†å¼‚å¸¸çš„åŸºç±» ArithmeticError æ‰€æœ‰æ•°å€¼è®¡ç®—é”™è¯¯çš„åŸºç±» FloatingPointError æµ®ç‚¹è®¡ç®—é”™è¯¯ OverflowError æ•°å€¼è¿ç®—è¶…å‡ºæœ€å¤§é™åˆ¶ ZeroDivisionError é™¤(æˆ–å–æ¨¡)é›¶ (æ‰€æœ‰æ•°æ®ç±»å‹) AssertionError æ–­è¨€è¯­å¥å¤±è´¥ AttributeError å¯¹è±¡æ²¡æœ‰è¿™ä¸ªå±æ€§ EOFError æ²¡æœ‰å†…å»ºè¾“å…¥,åˆ°è¾¾EOF æ ‡è®° EnvironmentError æ“ä½œç³»ç»Ÿé”™è¯¯çš„åŸºç±» IOError è¾“å…¥/è¾“å‡ºæ“ä½œå¤±è´¥ OSError æ“ä½œç³»ç»Ÿé”™è¯¯ WindowsError ç³»ç»Ÿè°ƒç”¨å¤±è´¥ ImportError å¯¼å…¥æ¨¡å—/å¯¹è±¡å¤±è´¥ LookupError æ— æ•ˆæ•°æ®æŸ¥è¯¢çš„åŸºç±» IndexError åºåˆ—ä¸­æ²¡æœ‰æ­¤ç´¢å¼•(index) KeyError æ˜ å°„ä¸­æ²¡æœ‰è¿™ä¸ªé”® MemoryError å†…å­˜æº¢å‡ºé”™è¯¯(å¯¹äºPython è§£é‡Šå™¨ä¸æ˜¯è‡´å‘½çš„) NameError æœªå£°æ˜/åˆå§‹åŒ–å¯¹è±¡ (æ²¡æœ‰å±æ€§) UnboundLocalError è®¿é—®æœªåˆå§‹åŒ–çš„æœ¬åœ°å˜é‡ ReferenceError å¼±å¼•ç”¨(Weak reference)è¯•å›¾è®¿é—®å·²ç»åƒåœ¾å›æ”¶äº†çš„å¯¹è±¡ RuntimeError ä¸€èˆ¬çš„è¿è¡Œæ—¶é”™è¯¯ NotImplementedError å°šæœªå®ç°çš„æ–¹æ³• SyntaxError Python è¯­æ³•é”™è¯¯ IndentationError ç¼©è¿›é”™è¯¯ TabError Tab å’Œç©ºæ ¼æ··ç”¨ SystemError ä¸€èˆ¬çš„è§£é‡Šå™¨ç³»ç»Ÿé”™è¯¯ TypeError å¯¹ç±»å‹æ— æ•ˆçš„æ“ä½œ ValueError ä¼ å…¥æ— æ•ˆçš„å‚æ•° UnicodeError Unicode ç›¸å…³çš„é”™è¯¯ UnicodeDecodeError Unicode è§£ç æ—¶çš„é”™è¯¯ UnicodeEncodeError Unicode ç¼–ç æ—¶é”™è¯¯ UnicodeTranslateError Unicode è½¬æ¢æ—¶é”™è¯¯ Warning è­¦å‘Šçš„åŸºç±» DeprecationWarning å…³äºè¢«å¼ƒç”¨çš„ç‰¹å¾çš„è­¦å‘Š FutureWarning å…³äºæ„é€ å°†æ¥è¯­ä¹‰ä¼šæœ‰æ”¹å˜çš„è­¦å‘Š OverflowWarning æ—§çš„å…³äºè‡ªåŠ¨æå‡ä¸ºé•¿æ•´å‹(long)çš„è­¦å‘Š PendingDeprecationWarning å…³äºç‰¹æ€§å°†ä¼šè¢«åºŸå¼ƒçš„è­¦å‘Š RuntimeWarning å¯ç–‘çš„è¿è¡Œæ—¶è¡Œä¸º(runtime behavior)çš„è­¦å‘Š SyntaxWarning å¯ç–‘çš„è¯­æ³•çš„è­¦å‘Š UserWarning ç”¨æˆ·ä»£ç ç”Ÿæˆçš„è­¦å‘Š 2.å¼‚å¸¸å¤„ç† æ•æ‰å¼‚å¸¸å¯ä»¥ä½¿ç”¨try/exceptè¯­å¥ã€‚ try/exceptè¯­å¥ç”¨æ¥æ£€æµ‹tryè¯­å¥å—ä¸­çš„é”™è¯¯ï¼Œä»è€Œè®©exceptè¯­å¥æ•è·å¼‚å¸¸ä¿¡æ¯å¹¶å¤„ç†ã€‚ å¦‚æœä½ ä¸æƒ³åœ¨å¼‚å¸¸å‘ç”Ÿæ—¶ç»“æŸä½ çš„ç¨‹åºï¼Œåªéœ€åœ¨tryé‡Œæ•è·å®ƒã€‚ 2.1try/exceptè¯­å¥ è¯­æ³• try: è¢«æ£€æµ‹çš„ä»£ç å— except å¼‚å¸¸ç±»å‹ï¼š tryä¸­ä¸€æ—¦æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œå°±æ‰§è¡Œè¿™é‡Œçš„ä»£ç  2.2try/except...elseè¯­å¥ è¯­æ³• try: è¢«æ£€æµ‹çš„ä»£ç å— except å¼‚å¸¸ç±»å‹ï¼š tryä¸­ä¸€æ—¦æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œå°±æ‰§è¡Œè¿™é‡Œçš„ä»£ç  else: æ²¡æœ‰å‘ç”Ÿå¼‚å¸¸æ‰§è¡Œçš„ä»£ç  tryçš„å·¥ä½œåŸç†æ˜¯ï¼Œå½“å¼€å§‹ä¸€ä¸ªtryè¯­å¥åï¼Œpythonå°±åœ¨å½“å‰ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¸­ä½œæ ‡è®°ï¼Œè¿™æ ·å½“å¼‚å¸¸å‡ºç°æ—¶å°±å¯ä»¥å›åˆ°è¿™é‡Œï¼Œtryå­å¥å…ˆæ‰§è¡Œï¼Œæ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆä¾èµ–äºæ‰§è¡Œæ—¶æ˜¯å¦å‡ºç°å¼‚å¸¸ã€‚ å¦‚æœå½“tryåçš„è¯­å¥æ‰§è¡Œæ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œpythonå°±è·³å›åˆ°tryå¹¶æ‰§è¡Œç¬¬ä¸€ä¸ªåŒ¹é…è¯¥å¼‚å¸¸çš„exceptå­å¥ï¼Œå¼‚å¸¸å¤„ç†å®Œæ¯•ï¼Œæ§åˆ¶æµå°±é€šè¿‡æ•´ä¸ªtryè¯­å¥ï¼ˆé™¤éåœ¨å¤„ç†å¼‚å¸¸æ—¶åˆå¼•å‘æ–°çš„å¼‚å¸¸ï¼‰ã€‚ å¦‚æœåœ¨tryåçš„è¯­å¥é‡Œå‘ç”Ÿäº†å¼‚å¸¸ï¼Œå´æ²¡æœ‰åŒ¹é…çš„exceptå­å¥ï¼Œå¼‚å¸¸å°†è¢«é€’äº¤åˆ°ä¸Šå±‚çš„tryï¼Œæˆ–è€…åˆ°ç¨‹åºçš„æœ€ä¸Šå±‚ï¼ˆè¿™æ ·å°†ç»“æŸç¨‹åºï¼Œå¹¶æ‰“å°é»˜è®¤çš„å‡ºé”™ä¿¡æ¯ï¼‰ã€‚ å¦‚æœåœ¨tryå­å¥æ‰§è¡Œæ—¶æ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œpythonå°†æ‰§è¡Œelseè¯­å¥åçš„è¯­å¥ï¼ˆå¦‚æœæœ‰elseçš„è¯ï¼‰ï¼Œç„¶åæ§åˆ¶æµé€šè¿‡æ•´ä¸ªtryè¯­å¥ã€‚ æ­£å¸¸è¿è¡Œç¤ºä¾‹ï¼Œæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶test.pyï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œä¸”å¹¶æœªå‘ç”Ÿå¼‚å¸¸ï¼š #!/usr/bin/python # -*- coding: UTF-8 -*- try: fh = open(\"testfile\", \"w\") fh.write(\"è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œç”¨äºæµ‹è¯•å¼‚å¸¸!!\") except IOError: print(\"Error: æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶æˆ–è¯»å–æ–‡ä»¶å¤±è´¥\") else: print(\"å†…å®¹å†™å…¥æ–‡ä»¶æˆåŠŸ\") fh.close() è¿è¡Œç»“æœï¼š $ python3 test.py å†…å®¹å†™å…¥æ–‡ä»¶æˆåŠŸ $ cat testfile # æŸ¥çœ‹å†™å…¥çš„å†…å®¹ è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œç”¨äºæµ‹è¯•å¼‚å¸¸!! å¼‚å¸¸è¿è¡Œç¤ºä¾‹ï¼Œè¿˜æ˜¯è¿è¡Œä»¥ä¸Šæ–‡ä»¶ï¼Œä½†æ–‡ä»¶æ²¡æœ‰å†™å…¥æƒé™ï¼Œå‘ç”Ÿäº†å¼‚å¸¸ å…ˆå–æ¶ˆtest.pyæ–‡ä»¶çš„æ‰§è¡Œæƒé™ $ python3 test.py Error: æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶æˆ–è¯»å–æ–‡ä»¶å¤±è´¥ 2.3try-finally è¯­å¥ try-finally è¯­å¥æ— è®ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸éƒ½å°†æ‰§è¡Œæœ€åçš„ä»£ç ã€‚ è¯­æ³• try: finally: #é€€å‡ºtryæ—¶æ€»ä¼šæ‰§è¡Œ raise ç¤ºä¾‹ #!/usr/bin/python # -*- coding: UTF-8 -*- ä»£ç å†™æ³•ä¸€ try: fh = open(\"testfile\", \"w\") fh.write(\"è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œç”¨äºæµ‹è¯•å¼‚å¸¸!!\") finally: print(\"Error: æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶æˆ–è¯»å–æ–‡ä»¶å¤±è´¥\") ä»£ç å†™æ³•äºŒ å±äºå¼‚å¸¸åµŒå¥— try: fh = open(\"testfile\", \"w\") try: fh.write(\"è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œç”¨äºæµ‹è¯•å¼‚å¸¸!!\") finally: print(\"å…³é—­æ–‡ä»¶\") fh.close() except IOError: print(\"Error: æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶æˆ–è¯»å–æ–‡ä»¶å¤±è´¥\") å¦‚æœæ–‡ä»¶æ²¡æœ‰å¯å†™æƒé™ï¼Œä¼šæŠ¥é”™ $ python3 test.py Error: æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶æˆ–è¯»å–æ–‡ä»¶å¤±è´¥ å½“åœ¨tryå—ä¸­æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œç«‹å³æ‰§è¡Œfinallyå—ä»£ç ã€‚ finallyå—ä¸­çš„æ‰€æœ‰è¯­å¥æ‰§è¡Œåï¼Œå¼‚å¸¸è¢«å†æ¬¡è§¦å‘ï¼Œå¹¶æ‰§è¡Œexceptå—ä»£ç ã€‚ å‚æ•°çš„å†…å®¹ä¸åŒäºå¼‚å¸¸ã€‚ 2.4ä¸‡èƒ½å¼‚å¸¸ Exception exceptionå¯ä»¥æ•è·æ‰€æœ‰å¼‚å¸¸ ç¤ºä¾‹ï¼Œå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´å‹ï¼Œä¼šæŠ¥é”™ s1 = 'hello' try: int(s1) except Exception as e: print(e) ç»“æœï¼š invalid literal for int() with base 10: 'hello' 2.5å¼‚å¸¸æ•è·åµŒå¥—ç¤ºä¾‹ a = int(input(\"è¯·è¾“å…¥é™¤æ•°>>>\")) b = int(input(\"è¯·è¾“å…¥è¢«é™¤æ•°>>>\")) try: print(a/b) except Exception: try: b = int(input(\"è¢«é™¤æ•°ä¸º0ï¼Œè¯·é‡æ–°è¾“å…¥è¢«é™¤æ•°>>>\")) print(a/b) except ZeroDivisionError: print(\"è¢«é™¤æ•°èƒ½ä¸º0ï¼Ÿï¼Ÿï¼Ÿï¼Œæ»šå§ï¼ï¼ï¼\") 2.6raiseæŠ›å‡ºå¼‚å¸¸ è¯­æ³• raise [å¼‚å¸¸ç±»å‹[(å¼‚å¸¸åŸå› )]] å…¶ä¸­ï¼Œç”¨ [] æ‹¬èµ·æ¥çš„ä¸ºå¯é€‰å‚æ•°ï¼Œå…¶ä½œç”¨æ˜¯æŒ‡å®šæŠ›å‡ºçš„å¼‚å¸¸åç§°ï¼Œä»¥åŠå¼‚å¸¸ä¿¡æ¯çš„ç›¸å…³æè¿°ã€‚å¦‚æœå¯é€‰å‚æ•°å…¨éƒ¨çœç•¥ï¼Œåˆ™ raise ä¼šæŠŠå½“å‰é”™è¯¯åŸæ ·æŠ›å‡ºï¼›å¦‚æœä»…çœç•¥ (å¼‚å¸¸åŸå› )ï¼Œåˆ™åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå°†ä¸é™„å¸¦ä»»ä½•çš„å¼‚å¸¸æè¿°ä¿¡æ¯ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œraise è¯­å¥æœ‰å¦‚ä¸‹ä¸‰ç§å¸¸ç”¨çš„ç”¨æ³•ï¼š raiseï¼šå•ç‹¬ä¸€ä¸ª raiseã€‚è¯¥è¯­å¥å¼•å‘å½“å‰ä¸Šä¸‹æ–‡ä¸­æ•è·çš„å¼‚å¸¸ï¼ˆæ¯”å¦‚åœ¨ except å—ä¸­ï¼‰ï¼Œæˆ–é»˜è®¤å¼•å‘ RuntimeError å¼‚å¸¸ã€‚ raise å¼‚å¸¸ç±»åç§°ï¼šraise åå¸¦ä¸€ä¸ªå¼‚å¸¸ç±»åç§°ã€‚è¯¥è¯­å¥å¼•å‘æŒ‡å®šå¼‚å¸¸ç±»çš„é»˜è®¤å®ä¾‹ã€‚ raise å¼‚å¸¸ç±»åç§°(æè¿°ä¿¡æ¯)ï¼šåœ¨å¼•å‘æŒ‡å®šå¼‚å¸¸çš„åŒæ—¶ï¼Œé™„å¸¦å¼‚å¸¸çš„æè¿°ä¿¡æ¯ã€‚ ä¸Šé¢ä¸‰ç§ç”¨æ³•æœ€ç»ˆéƒ½æ˜¯è¦å¼•å‘ä¸€ä¸ªå¼‚å¸¸å®ä¾‹ï¼ˆå³ä½¿æŒ‡å®šçš„æ˜¯å¼‚å¸¸ç±»ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯å¼•å‘è¯¥ç±»çš„é»˜è®¤å®ä¾‹ï¼‰ï¼Œraise è¯­å¥æ¯æ¬¡åªèƒ½å¼•å‘ä¸€ä¸ªå¼‚å¸¸å®ä¾‹ã€‚ 2.6.1 raise def main(): try: # ä½¿ç”¨try...exceptæ¥æ•æ‰å¼‚å¸¸ # æ­¤æ—¶å³ä½¿ç¨‹åºå‡ºç°å¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šä¼ æ’­ç»™mainå‡½æ•° mtd(3) except Exception as e: print('ç¨‹åºå‡ºç°å¼‚å¸¸:', e) # ä¸ä½¿ç”¨try...exceptæ•æ‰å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šä¼ æ’­å‡ºæ¥å¯¼è‡´ç¨‹åºä¸­æ­¢ mtd(3) def mtd(a): if a > 0: raise main() ç¨‹åºè¿è¡Œç»“æœï¼š ç¨‹åºå‡ºç°å¼‚å¸¸: No active exception to reraise raise RuntimeError: No active exception to reraise 2.6.2 raise å¼‚å¸¸ç±»åç§° def main(): try: # ä½¿ç”¨try...exceptæ¥æ•æ‰å¼‚å¸¸ # æ­¤æ—¶å³ä½¿ç¨‹åºå‡ºç°å¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šä¼ æ’­ç»™mainå‡½æ•° mtd(3) except Exception as e: print('ç¨‹åºå‡ºç°å¼‚å¸¸:', e) # ä¸ä½¿ç”¨try...exceptæ•æ‰å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šä¼ æ’­å‡ºæ¥å¯¼è‡´ç¨‹åºä¸­æ­¢ mtd(3) def mtd(a): if a > 0: raise ValueError main() ç¨‹åºè¿è¡Œç»“æœï¼š ç¨‹åºå‡ºç°å¼‚å¸¸: raise ValueError ValueError 2.6.3 raiseå¼‚å¸¸ç±»åç§°(æè¿°ä¿¡æ¯) def main(): try: # ä½¿ç”¨try...exceptæ¥æ•æ‰å¼‚å¸¸ # æ­¤æ—¶å³ä½¿ç¨‹åºå‡ºç°å¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šä¼ æ’­ç»™mainå‡½æ•° mtd(3) except Exception as e: print('ç¨‹åºå‡ºç°å¼‚å¸¸:', e) # ä¸ä½¿ç”¨try...exceptæ•æ‰å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šä¼ æ’­å‡ºæ¥å¯¼è‡´ç¨‹åºä¸­æ­¢ mtd(3) def mtd(a): if a > 0: raise ValueError(\"açš„å€¼å¤§äº0ï¼Œä¸ç¬¦åˆè¦æ±‚\") main() ç¨‹åºè¿è¡Œç»“æœï¼š ç¨‹åºå‡ºç°å¼‚å¸¸: açš„å€¼å¤§äº0ï¼Œä¸ç¬¦åˆè¦æ±‚ raise ValueError(\"açš„å€¼å¤§äº0ï¼Œä¸ç¬¦åˆè¦æ±‚\") ValueError: açš„å€¼å¤§äº0ï¼Œä¸ç¬¦åˆè¦æ±‚ 2.7è‡ªå®šä¹‰å¼‚å¸¸ å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„å¼‚å¸¸ç±»æ¥æ‹¥æœ‰è‡ªå·±çš„å¼‚å¸¸ã€‚å¼‚å¸¸ç±»ç»§æ‰¿è‡ª Exception ç±»ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿ï¼Œæˆ–è€…é—´æ¥ç»§æ‰¿ï¼Œä¾‹å¦‚: class MyError(Exception): def __init__(self, value): self.value = value def __str__(self): return repr(self.value) try: raise MyError(3 * 2) except MyError as e: print(f'è¿™æ˜¯æˆ‘è‡ªå®šä¹‰çš„å¼‚å¸¸ï¼Œè‡ªå®šä¹‰è¿ç®—ç»“æœæ˜¯{e.value}') ç¨‹åºè¿è¡Œç»“æœï¼š è¿™æ˜¯æˆ‘è‡ªå®šä¹‰çš„å¼‚å¸¸ï¼Œè‡ªå®šä¹‰è¿ç®—ç»“æœæ˜¯6 2.8assertæ–­è¨€ Python assertï¼ˆæ–­è¨€ï¼‰ç”¨äºåˆ¤æ–­ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œåœ¨è¡¨è¾¾å¼æ¡ä»¶ä¸º false çš„æ—¶å€™è§¦å‘å¼‚å¸¸ã€‚ æ–­è¨€å¯ä»¥åœ¨æ¡ä»¶ä¸æ»¡è¶³ç¨‹åºè¿è¡Œçš„æƒ…å†µä¸‹ç›´æ¥è¿”å›é”™è¯¯ï¼Œè€Œä¸å¿…ç­‰å¾…ç¨‹åºè¿è¡Œåå‡ºç°å´©æºƒçš„æƒ…å†µï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ä»£ç åªèƒ½åœ¨ Linux ç³»ç»Ÿä¸‹è¿è¡Œï¼Œå¯ä»¥å…ˆåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚ è¯­æ³• assert å¼‚å¸¸ç±»å‹ ç­‰ä»·äº if not expression: raise AssertionError assertåè¾¹å¯ä»¥ç´§è·Ÿå‚æ•° assert expression [, arguments] ç­‰ä»·äº if not expression: raise AssertionError(arguments) ä½¿ç”¨ç¤ºä¾‹ #ä½¿ç”¨ç¤ºä¾‹1ï¼Œè¿™æ®µä»£ç åªèƒ½åœ¨linuxç³»ç»Ÿä¸­è¿è¡Œ import sys assert ('linux' in sys.platform), \"è¯¥ä»£ç åªèƒ½åœ¨Linuxä¸‹æ‰§è¡Œ\" #ä½¿ç”¨ç¤ºä¾‹2 assert 1 == 2 ç»“æœï¼š AssertionError >>> assert True # æ¡ä»¶ä¸ºtrueæ­£å¸¸æ‰§è¡Œ >>> assert False # æ¡ä»¶ä¸ºfalseè§¦å‘å¼‚å¸¸ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/24.1pythonåŸºç¡€äºŒåå›› é¢å‘å¯¹è±¡åˆè¯†.html":{"url":"python/pythonåŸºç¡€/24.1pythonåŸºç¡€äºŒåå›› é¢å‘å¯¹è±¡åˆè¯†.html","title":"é¢å‘å¯¹è±¡åˆè¯†","keywords":"","body":"pythonåŸºç¡€äºŒåå›› é¢å‘å¯¹è±¡åˆè¯† 1.é¢å‘è¿‡ç¨‹ä¸é¢å‘å¯¹è±¡ 1.1ä»€ä¹ˆæ˜¯é¢å‘è¿‡ç¨‹ï¼Ÿ 1.1.1é¢å‘è¿‡ç¨‹æ¦‚å¿µ åœ¨æœªå­¦ä¹ é¢å‘å¯¹è±¡ä¹‹å‰å†™çš„ä»£ç éƒ½ç®—æ˜¯é¢å‘è¿‡ç¨‹ ä¾‹å¦‚ï¼Œæƒ³è¦å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼Œåˆ†æå‡ºè§£å†³é—®é¢˜æ‰€éœ€è¦çš„æ­¥éª¤ï¼Œç„¶åç”¨ä»£ç æˆ–è€…å‡½æ•°é€ä¸€å®ç°ï¼Œå¹¶æŒ‰ç…§ä»£ç é¡ºåºè°ƒç”¨ï¼Œè¿™å°±æ˜¯é¢å‘è¿‡ç¨‹ 1.1.2é¢è¿‡ç¨‹ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ æ€§èƒ½æ¯”é¢å‘å¯¹è±¡é«˜ï¼Œå› ä¸ºç±»è°ƒç”¨æ—¶éœ€è¦å®ä¾‹åŒ–ï¼Œå¼€é”€æ¯”è¾ƒå¤§ï¼Œæ¯”è¾ƒæ¶ˆè€—èµ„æº;æ¯”å¦‚å•ç‰‡æœºã€åµŒå…¥å¼å¼€å‘ã€Linux/Unixç­‰ä¸€èˆ¬é‡‡ç”¨é¢å‘è¿‡ç¨‹å¼€å‘ï¼Œæ€§èƒ½æ˜¯æœ€é‡è¦çš„å› ç´  ç¼ºç‚¹ ç»´æŠ¤æ€§ã€å¤ç”¨è¡Œã€æ‰©å±•æ€§è¾ƒå·® 1.2ä»€ä¹ˆæ˜¯é¢å‘å¯¹è±¡ï¼Ÿ 1.2.1é¢å‘å¯¹è±¡æ¦‚å¿µ é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡çš„æ ¸å¿ƒæ˜¯å¯¹è±¡ï¼ˆä¸Šå¸å¼æ€ç»´ï¼‰ï¼Œè¦ç†è§£å¯¹è±¡ä¸ºä½•ç‰©ï¼Œå¿…é¡»æŠŠè‡ªå·±å½“æˆä¸Šå¸ï¼Œä¸Šå¸çœ¼é‡Œä¸–é—´å­˜åœ¨çš„ä¸‡ç‰©çš†ä¸ºå¯¹è±¡ï¼Œä¸å­˜åœ¨çš„ä¹Ÿå¯ä»¥åˆ›é€ å‡ºæ¥ â¾¯å‘å¯¹è±¡æ€ç»´, è¦â¾ƒâ¼°å»ºç«‹å¯¹è±¡. â¾ƒâ¼°å»ºç«‹åœºæ™¯. ä½ æ˜¯å°±æ˜¯â¾¯å‘å¯¹è±¡ä¸–ç•Œä¸­çš„ä¸Šå¸. ä½ æƒ³è®©â»‹â¼²å˜›å°±â¼²å˜›. ä½ æƒ³è®©â¼ˆâ¼²å˜›â¼ˆå°±èƒ½â¼²å˜› 1.2.2é¢å‘å¯¹è±¡ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ æ˜¯ä¸€ç±»ç›¸ä¼¼åŠŸèƒ½å‡½æ•°çš„é›†åˆ,ä½¿ä½ çš„ä»£ç æ›´æ¸…æ™°åŒ–ï¼Œæ›´åˆç†åŒ– æ˜“ç»´æŠ¤ã€æ˜“å¤ç”¨ã€æ˜“æ‰©å±•ï¼Œç”±äºé¢å‘å¯¹è±¡æœ‰å°è£…ã€ç»§æ‰¿ã€å¤šæ€æ€§çš„ç‰¹æ€§ï¼Œå¯ä»¥è®¾è®¡å‡ºä½è€¦åˆçš„ç³»ç»Ÿï¼Œä½¿ç³»ç»Ÿæ›´åŠ çµæ´»ã€æ›´åŠ æ˜“äºç»´æŠ¤ ç¼ºç‚¹ æ€§èƒ½æ¯”é¢å‘è¿‡ç¨‹ä½ 1.2.3é¢å‘å¯¹è±¡ç‰¹ç‚¹ ç‰¹ç‚¹ 1.ç¨‹åºè®¾è®¡çš„é‡ç‚¹åœ¨äºæ•°æ®è€Œä¸æ˜¯è¿‡ç¨‹ï¼› 2.ç¨‹åºè¢«åˆ’åˆ†ä¸ºæ‰€è°“çš„å¯¹è±¡ï¼› 3.æ•°æ®ç»“æ„ä¸ºè¡¨ç°å¯¹è±¡çš„ç‰¹æ€§è€Œè®¾è®¡ï¼› 4.å‡½æ•°ä½œä¸ºå¯¹æŸä¸ªå¯¹è±¡æ•°æ®çš„æ“ä½œï¼Œä¸æ•°æ®ç»“æ„ç´§å¯†çš„ç»“åˆåœ¨ä¸€èµ·ï¼› 5.æ•°æ®è¢«éšè—èµ·æ¥ï¼Œä¸èƒ½ä¸ºå¤–éƒ¨å‡½æ•°è®¿é—®ï¼› 6.å¯¹è±¡ä¹‹é—´å¯ä»¥é€šè¿‡å‡½æ•°æ²Ÿé€šï¼› 7.æ–°çš„æ•°æ®å’Œå‡½æ•°å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™è½»è€Œæ˜“ä¸¾çš„æ·»åŠ è¿›æ¥ï¼› 8.åœ¨ç¨‹åºè®¾è®¡è¿‡ç¨‹ä¸­éµå¾ªç”±ä¸‹è‡³ä¸Šï¼ˆbottom-upï¼‰çš„è®¾è®¡æ–¹æ³•ã€‚ 2.ç±»ä¸å¯¹è±¡ 2.1ä»€ä¹ˆæ˜¯ç±»ï¼Ÿ 2.1.1ç±»çš„æ¦‚å¿µ å¯¹è±¡çš„æŠ½è±¡ï¼Œä¸€ç±»äº‹ç‰©çš„æ€»ç§° å…·æœ‰ç›¸åŒå±æ€§å’ŒåŠŸèƒ½çš„ä¸€ç±»äº‹ç‰© 2.1.2ç±»çš„è¯´æ˜ ç±»ï¼šå°±æ˜¯å…·æœ‰ç›¸åŒå±æ€§å’ŒåŠŸèƒ½çš„ä¸€ç±»äº‹ç‰©ï¼Œæ¯”å¦‚ï¼Œç‹—ç±»ã€çŒ«ç±»ã€äººç±» ç‹—ç±»ä¸­çš„é‡‘æ¯›ã€çŒ«ç±»ä¸­çš„æ©˜çŒ«ã€äººç±»ä¸­çš„ç”·äººã€å¥³äººå°±æ˜¯å…·ä½“çš„å¯¹è±¡ æ±½è½¦ï¼Œè½¦æœ‰è½®èƒã€å‘åŠ¨æœºã€æ–¹å‘ç›˜ç­‰ç­‰ï¼Œè½¦å°±æ˜¯ç±» äººï¼Œäººæœ‰æ€æƒ³ã€åå­—ã€å¹´é¾„ã€çˆ±å¥½ã€æ€§åˆ«ï¼Œäººå°±æ˜¯ç±» 2.2ä»€ä¹ˆæ˜¯å¯¹è±¡ï¼Ÿ 2.2.1å¯¹è±¡çš„æ¦‚å¿µ ç±»çš„å…·è±¡ï¼Œå³å¯¹è±¡ä¸ºç±»çš„å…·ä½“å®ç°ï¼Œé€šè¿‡ç±»å¯ä»¥åˆ›å»ºå¯¹è±¡ 2.2.2å¯¹è±¡çš„è¯´æ˜ å¯¹è±¡ï¼šå°±æ˜¯ç±»çš„å…·ä½“è¡¨ç°å½¢å¼ï¼Œä¾‹å¦‚ç‹—ç±»ä¸­çš„é‡‘æ¯›ã€çŒ«ç±»ä¸­çš„æ©˜çŒ«ã€äººç±»ä¸­çš„ç”·äººã€å¥³äººå°±æ˜¯å…·ä½“çš„å¯¹è±¡ 3.ç±»æ“ä½œ 3.1åˆ›å»ºç±» è¯­æ³• class ç±»å(): å±æ€§ æ–¹æ³• ä»£ç ç¤ºä¾‹ //åˆ›å»ºä¸€ä¸ªäººç±»ï¼Œäººç±»æœ‰å±æ€§å§“åã€å¹´é¾„ã€çˆ±å¥½ï¼Œäººç±»æœ‰æ–¹æ³•ç© class Person(): name = \"å‘µå‘µ\" age = 20 hobby = \"ç©\" def play(self): #è¿™é‡Œçš„selfæ˜¯å›ºå®šå†™æ³• print(\"äººå–œæ¬¢ç©\") 3.1.1ç±»å±æ€§ ä¸Šè¿°ä»£ç ä¸­çš„nameã€ageã€hobbyå°±æ˜¯ç±»å±æ€§ï¼Œå±äºç±»ä¸­çš„å…¨å±€å±æ€§ï¼Œåç»­è¿˜æœ‰ä¼ å‚æ–¹å¼çš„ç§æœ‰å±æ€§ 3.1.2ç±»æ–¹æ³• å°†å‡½æ•°å†™åœ¨ç±»ä¸­åŠ ä¸Šé»˜è®¤å‚æ•°selfå°±æ˜¯ç±»ä¸­çš„æ–¹æ³•ï¼Œselfä¸æ˜¯å›ºå®šå«selfï¼Œåªä¸è¿‡å¤§å®¶çº¦å®šä¿—ç§°å«self ä¸Šè¿°ä»£ç ä¸­çš„å‡½æ•°playå°±æ˜¯ç±»æ–¹æ³•ï¼Œselfä»£è¡¨ç±»å®ä¾‹å¯¹è±¡æœ¬èº«ï¼Œâš ï¸ä¸æ˜¯ç±»æœ¬èº« 3.2ç±»åçš„æ“ä½œ 3.2.1ç±»åæ“ä½œé™æ€å±æ€§ æ–¹å¼ä¸€ ç±»å.__dict__() æŸ¥çœ‹ç±»ä¸­æ‰€æœ‰å†…å®¹ ç±»å.__dict__()åªèƒ½åšæŸ¥çœ‹æ“ä½œï¼Œä¸èƒ½ä¿®æ”¹ã€åˆ é™¤ class Person(): name = \"å‘µå‘µ\" age = 20 hobby = \"ç©\" def play(self): print(\"äººå–œæ¬¢ç©\") #æŸ¥çœ‹ç±»ä¸­æ‰€æœ‰çš„å†…å®¹ print(Person.__dict__) ç»“æœï¼š {'__module__': '__main__', 'name': 'å‘µå‘µ', 'age': 20, 'hobby': 'ç©', 'play': , '__dict__': , '__weakref__': , '__doc__': None} æ–¹å¼äºŒ ä¸‡èƒ½çš„ç‚¹ . æ“ä½œå•ä¸ªå±æ€§(å¢åˆ æ”¹æŸ¥) ä¸‡èƒ½çš„ç‚¹å¯ä»¥åšå¢ã€åˆ ã€æ”¹ã€æŸ¥æ“ä½œ class Person(): name = \"å‘µå‘µ\" age = 20 hobby = \"ç©\" def play(self): print(\"äººå–œæ¬¢ç©\") #å¢æ“ä½œ å¢åŠ ç±»å±æ€§ Person.weight = 100 print(Person.weight) ç»“æœï¼š 100 #åˆ æ“ä½œ åˆ é™¤ç±»å±æ€§ del Person.name print(Person.name) ç»“æœï¼š AttributeError: type object 'Person' has no attribute 'name' #æ”¹æ“ä½œ ä¿®æ”¹ç±»å±æ€§ Person.name = \"å“ˆå“ˆ\" print(Person.name) ç»“æœï¼š å“ˆå“ˆ #æŸ¥æ“ä½œ æŸ¥çœ‹ç±»å±æ€§ print(Person.name) ç»“æœï¼š å‘µå‘µ 3.2.2ç±»åæ“ä½œåŠ¨æ€æ–¹æ³• âš ï¸é™¤äº†ç±»ä¸­çš„å±æ€§å’Œç±»æ–¹æ³•ä¹‹å¤–ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡å¯¹è±¡åæ“ä½œ class Person(): name = \"å‘µå‘µ\" age = 20 hobby = \"ç©\" def play(self): print(\"äººå–œæ¬¢ç©\") Person.play(1) #1æ˜¯éšä¾¿ä¼ çš„ä¸€ä¸ªå‚æ•°ï¼Œå› ä¸ºç±»ä¸­æ–¹æ³•å¿…é¡»æœ‰ä¸€ä¸ªå‚æ•° ç»“æœï¼š äººå–œæ¬¢ç© 3.2.3å¢åŠ ç±»çš„é™æ€å±æ€§ //ç±»å¤–å¢åŠ  class Person: def __init__(self,name): self.name = name def func(self,sex): self.sex = sex def func1(self): Person.bbb = 'ccc' Person.aaa = 'å°æ˜' print(Person.__dict__) ç»“æœï¼š {'__module__': '__main__', '__init__': , 'func': , 'func1': , '__dict__': , '__weakref__': , '__doc__': None, 'aaa': 'å°æ˜'} 4.å¯¹è±¡æ“ä½œ 4.1åˆ›å»ºå¯¹è±¡ å¯¹è±¡æ˜¯ä»ç±»ä¸­å‡ºæ¥çš„ï¼Œåªè¦æ˜¯ç±»ååŠ ä¸Šï¼ˆï¼‰ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå®ä¾‹åŒ–è¿‡ç¨‹ï¼Œè¿™ä¸ªå°±ä¼šå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ã€‚ class Person(): name = \"å‘µå‘µ\" age = 20 hobby = \"ç©\" def play(self): print(\"äººå–œæ¬¢ç©\") man = Person() #å®ä¾‹åŒ–å¯¹è±¡ print(man) å®ä¾‹åŒ–å¯¹è±¡å‘ç”Ÿçš„äº‹æƒ… 1.åœ¨å†…å­˜ä¸­å¼€è¾Ÿäº†ä¸€ä¸ªå¯¹è±¡ç©ºé—´ã€‚ 2.è‡ªåŠ¨æ‰§è¡Œç±»ä¸­çš„__init__æ–¹æ³•ï¼Œå¹¶å°†è¿™ä¸ªå¯¹è±¡ç©ºé—´ï¼ˆå†…å­˜åœ°å€ï¼‰ä¼ ç»™äº†__init__æ–¹æ³•çš„ç¬¬ä¸€ä¸ªä½ç½®å‚æ•°selfã€‚ 3.åœ¨__init__ æ–¹æ³•ä¸­é€šè¿‡selfç»™å¯¹è±¡ç©ºé—´æ·»åŠ å±æ€§ã€‚ ä»¥ä¸‹ä¸ºä»£ç ç¤ºä¾‹ class Person(): #selfå’ŒmanæŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå†…å­˜åœ°å€åŒä¸€ä¸ªç©ºé—´ï¼Œä¸‹é¢å°±æ˜¯é€šè¿‡selfç»™è¿™ä¸ªå¯¹è±¡ç©ºé—´å°è£…å››ä¸ªå±æ€§ def __init__(self,name,age,sex): self.name = name self.age = age self.sex = sex def a(self): print(f\"æˆ‘å«{self.name},æˆ‘ä»Šå¹´{self.age}äº†,æˆ‘æ˜¯{self.sex}çš„\") man = Person(\"å°æ˜\",20,'ç”·') #å®ä¾‹åŒ–å¯¹è±¡ï¼Œmanç°åœ¨å°±æ˜¯Personç±»çš„å®ä¾‹åŒ–å¯¹è±¡ man.a() #è°ƒç”¨ç±»ä¸­çš„æ–¹æ³• ç»“æœï¼š æˆ‘å«å°æ˜,æˆ‘ä»Šå¹´20äº†,æˆ‘æ˜¯ç”·çš„ 4.2å¯¹è±¡çš„æ“ä½œ 4.2.1å¯¹è±¡åæ“ä½œå¯¹è±¡ç©ºé—´å±æ€§ æ–¹å¼ä¸€ å¯¹è±¡åæŸ¥çœ‹å¯¹è±¡ä¸­æ‰€æœ‰å±æ€§ å¯¹è±¡å.__dict__ class Person(): def __init__(self,name,age,sex): self.name = name self.age = age self.sex = sex def a(self): print(f\"æˆ‘å«{self.name},æˆ‘ä»Šå¹´{self.age}äº†,æˆ‘æ˜¯{self.sex}çš„\") man = Person(\"å°æ˜\",20,'ç”·') print(man.__dict__) ç»“æœï¼š {'name': 'å°æ˜', 'age': 20, 'sex': 'ç”·'} æ–¹å¼äºŒ ä¸‡èƒ½çš„ç‚¹ . ä¸‡èƒ½çš„ç‚¹å¯ä»¥åšå¢ã€åˆ ã€æ”¹ã€æŸ¥æ“ä½œ class Person(): def __init__(self,name,age,sex): self.name = name self.age = age self.sex = sex def a(self): print(f\"æˆ‘å«{self.name},æˆ‘ä»Šå¹´{self.age}äº†,æˆ‘æ˜¯{self.sex}çš„\") man = Person(\"å°æ˜\",20,'ç”·') #å¢æ“ä½œ å¢åŠ ç±»å±æ€§ man.job = \"pythonå¼€å‘\" print(man.job) ç»“æœï¼š pythonå¼€å‘ #åˆ æ“ä½œ åˆ é™¤ç±»å±æ€§ del man.name print(man.name) ç»“æœï¼š AttributeError: 'Person' object has no attribute 'name' #æ”¹æ“ä½œ ä¿®æ”¹ç±»å±æ€§ man.name = \"å°çº¢\" print(man.name) ç»“æœï¼š å°çº¢ #æŸ¥æ“ä½œ æŸ¥çœ‹ç±»å±æ€§ print(man.name) ç»“æœï¼š å°æ˜ 4.2.2å¯¹è±¡åæŸ¥çœ‹ç±»ä¸­å±æ€§ class Person(): size = 36 weight = 100 def __init__(self,name,age,sex): self.name = name self.age = age self.sex = sex def a(self): print(f\"æˆ‘å«{self.name},æˆ‘ä»Šå¹´{self.age}äº†,æˆ‘æ˜¯{self.sex}çš„\") man = Person(\"å°æ˜\",20,'ç”·') #é€šè¿‡å¯¹è±¡åæŸ¥çœ‹ç±»ä¸­å±æ€§ print(man.size,man.weight) 36 100 4.2.3å¯¹è±¡åæ“ä½œç±»ä¸­æ–¹æ³• ç±»ä¸­çš„æ–¹æ³•ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡å¯¹è±¡æ‰§è¡Œçš„ï¼ˆé™¤å»ç±»æ–¹æ³•ï¼Œé™æ€æ–¹æ³•å¤–ï¼‰ï¼Œå¹¶ä¸”å¯¹è±¡æ‰§è¡Œè¿™äº›æ–¹æ³•éƒ½ä¼šè‡ªåŠ¨å°†å¯¹è±¡ç©ºé—´ä¼ ç»™æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°self class Person(): size = 36 weight = 100 def __init__(self,name,age,sex): self.name = name self.age = age self.sex = sex def a(self): print(f\"æˆ‘å«{self.name},æˆ‘ä»Šå¹´{self.age}äº†,æˆ‘æ˜¯{self.sex}çš„\") def f1(self): print(\"æˆ‘æ˜¯ç±»ä¸­çš„æ–¹æ³•f1\") man = Person(\"å°æ˜\",20,'ç”·') man.f1() ç»“æœï¼š æˆ‘æ˜¯ç±»ä¸­çš„æ–¹æ³•f1 4.2.4å¢åŠ å¯¹è±¡å±æ€§ //ç±»å¤–æ·»åŠ  class Person: def __init__(self,name): self.name = name def func(self,sex): self.sex = sex #ç±»å¤–é¢å¯ä»¥ï¼š obj = Person('å°æ˜') obj.age = 20 print(obj.__dict__) ç»“æœï¼š {'name': 'meet', 'age': 18} //ç±»å†…æ·»åŠ  class Person: def __init__(self,name): self.name = name def func(self,sex): self.sex = sex #ç±»å†…éƒ¨ä¹Ÿå¯ä»¥ï¼š obj = Person('å°æ˜') # __init__æ–¹æ³•å¯ä»¥ã€‚ obj.func(\"ç”·\") #funcæ–¹æ³•å¯ä»¥ print(obj.__dict__) ç»“æœï¼š {'name': 'å°æ˜', 'sex': 'ç”·'} 5.è¡¥å……è¯´æ˜ 5.1selfæ˜¯ä»€ä¹ˆ selfå…¶å®å°±æ˜¯ç±»ä¸­æ–¹æ³•ï¼ˆå‡½æ•°ï¼‰çš„ç¬¬ä¸€ä¸ªä½ç½®å‚æ•°ï¼Œåªä¸è¿‡è§£é‡Šå™¨ä¼šè‡ªåŠ¨å°†è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„å¯¹è±¡ä¼ ç»™selfã€‚æ‰€ä»¥æŠŠç±»ä¸­æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°çº¦å®šä¿—æˆè®¾ç½®æˆself, ä»£è¡¨è¿™ä¸ªå°±æ˜¯å¯¹è±¡.è¿™ä¸ªselfå¯ä»¥è¿›è¡Œæ”¹å˜ä½†æ˜¯ä¸å»ºè®®å¤§å®¶è¿›è¡Œä¿® ä¼ å‚åˆ†ä¸ºéšå¼ä¼ å‚å’Œæ˜¾ç¤ºä¼ å‚,selfè¿™ç§æ–¹å¼å°±æ˜¯éšå¼ä¼ å‚ class Person(): size = 36 weight = 100 def __init__(self,name,age,sex): self.name = name self.age = age self.sex = sex def a(self): #è¿™é‡Œçš„selfå°±æ˜¯å¯¹è±¡man print(f\"æˆ‘å«{self.name},æˆ‘ä»Šå¹´{self.age}äº†,æˆ‘æ˜¯{self.sex}çš„\") man = Person(\"å°æ˜\",20,'ç”·') man.a() ç»“æœï¼š æˆ‘å«å°æ˜,æˆ‘ä»Šå¹´20äº†,æˆ‘æ˜¯ç”·çš„ 5.2 ç±»ä¸­__init__()æ–¹æ³• æ„é€ æ–¹æ³•ï¼šç±»ä¸­çš„__init__()æ–¹æ³•ï¼ˆä¸»è¦ç”¨ä½œåˆå§‹åŒ–ï¼‰ åœ¨obj = ç±»å() æ‰§è¡Œååšäº†ä¸¤ä»¶äº‹ #1.åˆ›å»ºå¯¹è±¡ï¼Œå¯¹è±¡åå«obj #2.é€šè¿‡å¯¹è±¡æ‰§è¡Œç±»ä¸­çš„ä¸€ä¸ªç‰¹æ®Šæ–¹æ³• __init__ class Bar: def __init__(self): #è¿™é‡Œçš„selfå°±æ˜¯å¯¹è±¡åobj print('123') obj = Bar() ç±»ä¸­__init__()æ–¹æ³•ç¤ºä¾‹ //ç¬¬ä¸€ç‰ˆä»£ç  class Man: def __init__(self, name, age): self.n = name self.a = age print(f\"æˆ‘å«{self.n},æˆ‘ä»Šå¹´{self.a}å²\") b = Man(\"å°æ˜\", 20) #æ‰“å°ç»“æœ æˆ‘å«å°æ˜,æˆ‘ä»Šå¹´20å² #å†…å­˜ä¸­å‘ç”Ÿçš„äº‹ å†…å­˜ä¸­æœ‰ä¸€ä¸ªç©ºé—´å­˜æ”¾ç±»Manï¼Œ__init__()æ–¹æ³•åœ¨ç±»Manä¸­ï¼Œå¯¹è±¡bæŒ‡å‘ç±»Man ç±»ä¸­çš„__init__()æ–¹æ³•ä¼šè‡ªåŠ¨æ‰§è¡Œ #ä»£ç è¯´æ˜ ç±»Manä¸­çš„selfå°±æ˜¯å¯¹è±¡bï¼Œself.nå°±æ˜¯b.n __init__()å°±å«æ„é€ æ–¹æ³•ï¼Œæ„é€ æ–¹æ³•ä¼šåœ¨ç±»å()çš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œï¼Œå³åœ¨b = Man()çš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œ //ç¬¬äºŒç‰ˆä»£ç  class Man: def __init__(self, name, age): \"\"\" æ„é€ æ–¹æ³•ï¼Œä¼šåœ¨ç±»å()çš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œï¼Œå³åœ¨b = Man()çš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œ :param name: :param age: \"\"\" self.n = name self.a = age def show(self): print(f\"æˆ‘å«{self.n},æˆ‘ä»Šå¹´{self.a}å²\") b = Man(\"å°æ˜\", 20) b.show() #æ‰“å°ç»“æœ æˆ‘å«å°æ˜,æˆ‘ä»Šå¹´20å² 5.3å¯¹è±¡ã€ç±»æŸ¥æ‰¾å±æ€§çš„é¡ºåº å¯¹è±¡æŸ¥æ‰¾å±æ€§çš„é¡ºåº å¯¹è±¡ç©ºé—´ ------> ç±»ç©ºé—´ ------> çˆ¶ç±»ç©ºé—´ ç±»æŸ¥æ‰¾å±æ€§çš„é¡ºåº æœ¬ç±»ç©ºé—´ ------> çˆ¶ç±»ç©ºé—´ âš ï¸âš ï¸âš ï¸ç±»åä¸å¯èƒ½æ‰¾åˆ°å¯¹è±¡çš„å±æ€§ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/25.1pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šè¿›ç¨‹.html":{"url":"python/pythonåŸºç¡€/25.1pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šè¿›ç¨‹.html","title":"å¹¶å‘ç¼–ç¨‹-å¤šè¿›ç¨‹","keywords":"","body":"pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šè¿›ç¨‹ 1.å¤šä»»åŠ¡å¤„ç† å¤šä»»åŠ¡å¤„ç†å°±æ˜¯ä½¿è®¡ç®—æœºåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ 1.1 å®ç°æ–¹å¼ å¤šè¿›ç¨‹ å¤šçº¿ç¨‹ 1.2 ä¸²è¡Œã€å¹¶å‘ã€å¹¶è¡Œç¤ºæ„å›¾ ä¸²è¡Œ å¹¶å‘ å¹¶è¡Œ 2.å¤šè¿›ç¨‹ 2.1 å¤šè¿›ç¨‹æ¶‰åŠçš„æ¦‚å¿µ ç¨‹åºï¼šæ˜¯ä¸€ä¸ªæŒ‡ä»¤çš„é›†åˆï¼Œä¾‹å¦‚ç¼–å†™å®Œçš„ä»£ç ï¼Œè¿˜æ²¡æœ‰è¿è¡Œ è¿›ç¨‹ï¼šæ­£åœ¨æ‰§è¡Œçš„ç¨‹åºï¼Œä¾‹å¦‚å½“è¿è¡Œä¸€ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œå°±å¯åŠ¨äº†ä¸€ä¸ªè¿›ç¨‹ 2.2 pythonå¤šè¿›ç¨‹ 1.ç¨‹åºå¼€å§‹è¿è¡Œæ—¶ï¼Œé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªä¸»è¿›ç¨‹ 2.åœ¨ä¸»è¿›ç¨‹(çˆ¶è¿›ç¨‹)ä¸‹ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„è¿›ç¨‹(å­è¿›ç¨‹)ï¼Œå­è¿›ç¨‹ä¾èµ–äºä¸»è¿›ç¨‹ï¼Œå¦‚æœä¸»è¿›ç¨‹ç»“æŸï¼Œç¨‹åºä¼šé€€å‡º 3.pythonæä¾›äº†éå¸¸å¥½ç”¨çš„è¿›ç¨‹åŒ…multiprocessingï¼Œå€ŸåŠ©è¿™ä¸ªåŒ…ï¼Œå¯ä»¥è½»æ¾å®Œæˆä»å•è¿›ç¨‹åˆ°å¹¶å‘æ‰§è¡Œçš„è½¬æ¢ 2.2.1 multiprocessingæ¨¡å—ã€ç±»æ–¹æ³•åˆ›å»ºå¤šè¿›ç¨‹ æ–¹æ³•ä¸€ï¼šmultiprocessingæ¨¡å—æä¾›äº†ä¸€ä¸ªProcessç±»æ¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹å¯¹è±¡ //ä»£ç ç¤ºä¾‹1 from multiprocessing import Process def run(name): print(f\"å­è¿›ç¨‹ '{name}' è¿è¡Œä¸­\") if __name__ == \"__main__\": #windownsä¸­é˜²æ­¢é€’å½’æ‰§è¡Œåˆ›å»ºå­è¿›ç¨‹å¯¼è‡´å†…å­˜ä¸è¶³ï¼ŒLinuxã€Macä¸­å¯ä»¥ä¸å†™ print(\"çˆ¶è¿›ç¨‹å¯åŠ¨\") p = Process(target=run,args=('æˆ‘æ˜¯ä¼ å…¥çš„å‚æ•°',)) #åˆ›å»ºå­è¿›ç¨‹ p.start() #å¯åŠ¨è¿›ç¨‹ print(p.name) #æ‰“å°è¿›ç¨‹åå­—ï¼Œå¯ä»¥è‡ªå®šä¹‰ p.join() #å‘ŠçŸ¥ä¸»è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹ç»“æŸ print(\"å­è¿›ç¨‹ç»“æŸ\") ç»“æœï¼š çˆ¶è¿›ç¨‹å¯åŠ¨ Process-1 å­è¿›ç¨‹ 'æˆ‘æ˜¯ä¼ å…¥çš„å‚æ•°' è¿è¡Œä¸­ å­è¿›ç¨‹ç»“æŸ //ä»£ç ç¤ºä¾‹2 åˆ›å»ºå¤šä¸ªå­è¿›ç¨‹ã€è‡ªå®šä¹‰è¿›ç¨‹åå­— from multiprocessing import Process def run1(name,sex): print(f\"å­è¿›ç¨‹ '{name}' è¿è¡Œä¸­,æˆ‘æ˜¯{sex}çš„\") def run2(name,sex): print(f\"å­è¿›ç¨‹ '{name}' è¿è¡Œä¸­,æˆ‘æ˜¯{sex}çš„\") if __name__ == \"__main__\": print(\"çˆ¶è¿›ç¨‹å¯åŠ¨\") p1 = Process(target=run1,args=('æˆ‘æ˜¯å­è¿›ç¨‹1','ç”·',),name='è‡ªå®šä¹‰å­è¿›ç¨‹1') p2 = Process(target=run2,args=('æˆ‘æ˜¯å­è¿›ç¨‹2','å¥³',),name='è‡ªå®šä¹‰å­è¿›ç¨‹2') p1.start() p2.start() print(p1.name) print(p2.name) p1.join() p2.join() print(\"å­è¿›ç¨‹ç»“æŸ\") ç»“æœï¼š çˆ¶è¿›ç¨‹å¯åŠ¨ è‡ªå®šä¹‰å­è¿›ç¨‹1 è‡ªå®šä¹‰å­è¿›ç¨‹2 å­è¿›ç¨‹ 'æˆ‘æ˜¯å­è¿›ç¨‹1' è¿è¡Œä¸­,æˆ‘æ˜¯ç”·çš„ å­è¿›ç¨‹ 'æˆ‘æ˜¯å­è¿›ç¨‹2' è¿è¡Œä¸­,æˆ‘æ˜¯å¥³çš„ å­è¿›ç¨‹ç»“æŸ æ–¹æ³•äºŒï¼šç±»æ–¹æ³•åˆ›å»ºå¤šè¿›ç¨‹ åˆ›å»ºæ–°çš„è¿›ç¨‹è¿˜å¯ä»¥ä½¿ç”¨ç±»çš„æ–¹å¼ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼Œç»§æ‰¿Processç±»ï¼Œæ¯æ¬¡å®ä¾‹åŒ–è¿™ä¸ªç±»çš„æ—¶å€™ï¼Œå°±ç­‰åŒäºå®ä¾‹åŒ–ä¸€ä¸ªè¿›ç¨‹å¯¹è±¡ //multiprocessingæ¨¡å—åˆ›å»ºå¤šè¿›ç¨‹æ–¹æ³• from multiprocessing import Process def run(name): print(f\"æˆ‘æ˜¯è¿›ç¨‹ï¼š'{name}'\") if __name__ == \"__main__\": p = Process(target=run,args=('å‘µå‘µ',)) p.start() p.join() print(\"å­è¿›ç¨‹ç»“æŸ\") ç»“æœï¼š æˆ‘æ˜¯è¿›ç¨‹ï¼š'å‘µå‘µ' å­è¿›ç¨‹ç»“æŸ //åŸºäºä»¥ä¸Šä»£ç ï¼Œä½¿ç”¨ç±»çš„æ–¹å¼åˆ›å»ºå¤šè¿›ç¨‹ from multiprocessing import Process class Custum(Process): def __init__(self,name): super().__init__() self.name = name def run(self): #é‡å†™runæ–¹æ³•ï¼Œåªèƒ½æœ‰ä¸€ä¸ªä¸”å¿…é¡»å«run print(f\"æˆ‘æ˜¯è¿›ç¨‹ï¼š'{self.name}'\") if __name__ == \"__main__\": p = Custum(\"ç±»åˆ›å»ºè¿›ç¨‹\") p.start() p.join() print(\"å­è¿›ç¨‹ç»“æŸ\") ç»“æœï¼š æˆ‘æ˜¯è¿›ç¨‹ï¼š'ç±»åˆ›å»ºè¿›ç¨‹' å­è¿›ç¨‹ç»“æŸ ä½¿ç”¨ç±»æ–¹æ³•åˆ›å»ºå¤šè¿›ç¨‹ from multiprocessing import Process class A(Process): def __init__(self,name): super().__init__() self.name = name def hehe(self): #åç§°å¿…é¡»å«runï¼Œå¦åˆ™è¿è¡Œç»“æœä¼šæœ‰é—®é¢˜ print(f\"å­è¿›ç¨‹ {self.name} è¿è¡Œä¸­\") if __name__ == \"__main__\": print(\"çˆ¶è¿›ç¨‹å¯åŠ¨\") p = A(\"ç±»åˆ›å»ºè¿›ç¨‹\") p.start() p.join() print(\"å­è¿›ç¨‹ç»“æŸ\") ç»“æœï¼š çˆ¶è¿›ç¨‹å¯åŠ¨ å­è¿›ç¨‹ç»“æŸ 2.2.2 __name == \"__main__\"å‚æ•° 1.ä¸€ä¸ªpythonçš„æ–‡ä»¶æœ‰ä¸¤ç§ä½¿ç”¨çš„æ–¹æ³•ï¼Œç¬¬ä¸€æ˜¯ç›´æ¥ä½œä¸ºç¨‹åºæ‰§è¡Œï¼Œç¬¬äºŒæ˜¯importåˆ°å…¶ä»–çš„pythonç¨‹åº ä¸­è¢«è°ƒç”¨(æ¨¡å—é‡ç”¨)æ‰§è¡Œã€‚ 2.å› æ­¤if __name__ == 'main': çš„ä½œç”¨å°±æ˜¯æ§åˆ¶è¿™ä¸¤ç§æƒ…å†µæ‰§è¡Œä»£ç çš„è¿‡ç¨‹ï¼Œ__name__ æ˜¯å†…ç½®å˜é‡ï¼Œç”¨äºè¡¨ç¤ºå½“å‰æ¨¡å—çš„åå­— 3.åœ¨if __name__ == 'main': ä¸‹çš„ä»£ç åªæœ‰åœ¨æ–‡ä»¶ä½œä¸ºç¨‹åºç›´æ¥æ‰§è¡Œæ‰ä¼šè¢«æ‰§è¡Œï¼Œè€Œimportåˆ°å…¶ä»–ç¨‹åºä¸­æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ 4.åœ¨Windows ä¸Šï¼Œå­è¿›ç¨‹ä¼šè‡ªåŠ¨ import å¯åŠ¨å®ƒçš„è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œåœ¨ import çš„æ—¶å€™æ˜¯ä¼šæ‰§è¡Œè¿™äº›è¯­å¥çš„ã€‚ å¦‚æœä¸åŠ if __name__ == \"__main__\":çš„è¯å°±ä¼šæ— é™é€’å½’åˆ›å»ºå­è¿›ç¨‹ æ‰€ä»¥å¿…é¡»æŠŠåˆ›å»ºå­è¿›ç¨‹çš„éƒ¨åˆ†ç”¨é‚£ä¸ª if åˆ¤æ–­ä¿æŠ¤èµ·æ¥ import çš„æ—¶å€™ __name__ ä¸æ˜¯__main__ ï¼Œå°±ä¸ä¼šé€’å½’è¿è¡Œäº† //é”™è¯¯ç¤ºä¾‹ from multiprocessing import Process def run(name): print(f\"æˆ‘æ˜¯è¿›ç¨‹ï¼š '{name}'\") p = Process(target=run,args=('å‘µå‘µ',)) p.start() p.join() print(\"å­è¿›ç¨‹ç»“æŸ\") ç»“æœï¼š windowsä¼šæŠ¥ä¸€å †é”™ï¼ŒLinuxã€Macæ²¡æœ‰é—®é¢˜ //æ­£ç¡®ç¤ºä¾‹ from multiprocessing import Process def run(name): print(f\"æˆ‘æ˜¯è¿›ç¨‹ï¼š '{name}'\") if __name__ == \"__main__\": p = Process(target=run,args=('å‘µå‘µ',)) p.start() p.join() print(\"å­è¿›ç¨‹ç»“æŸ\") æˆ‘æ˜¯è¿›ç¨‹ï¼š 'å‘µå‘µ' å­è¿›ç¨‹ç»“æŸ 2.2.3 å¤šè¿›ç¨‹å‚æ•° target è¡¨ç¤ºè°ƒç”¨å¯¹è±¡ï¼Œå³å­è¿›ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡ p = Process(target=å¯¹è±¡å(å‡½æ•°å)) args è¡¨ç¤ºè°ƒç”¨å¯¹è±¡çš„ä½ç½®å‚æ•°å…ƒç»„ï¼Œargs=(ä¼ å…¥çš„å‚æ•°,) âš ï¸æ‹¬å·ä¸­ä¼ å…¥çš„å‚æ•°åé¢å¿…é¡»åŠ é€—å· p = Process(target=xxx,args=('ä¼ å…¥çš„å‚æ•°',)) name è¡¨ç¤ºè¿›ç¨‹çš„åç§° p = Process(target=xxx,args=('ä¼ å…¥çš„å‚æ•°',),name='å­è¿›ç¨‹åç§°') 2.2.4 Processç±»å¸¸ç”¨æ–¹æ³• p.start() å¯åŠ¨è¿›ç¨‹ï¼Œå¹¶è°ƒç”¨è¯¥å­è¿›ç¨‹ä¸­çš„p.run() p.run() è¿›ç¨‹å¯åŠ¨æ—¶è¿è¡Œçš„æ–¹æ³•ï¼Œæ­£æ˜¯å®ƒå»è°ƒç”¨targetæŒ‡å®šçš„å‡½æ•°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ç±»ä¸­çš„ä¸€å®šè¦å®ç°è¯¥æ–¹æ³• p.terminate() å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹pï¼Œä¸ä¼šè¿›è¡Œä»»ä½•æ¸…ç†æ“ä½œ p.is_alive() å¦‚æœå­è¿›ç¨‹pä»ç„¶è¿è¡Œï¼Œè¿”å›Trueï¼Œç”¨æ¥åˆ¤æ–­è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ p.join([è¶…æ—¶æ—¶é—´]) ä¸»è¿›ç¨‹ç­‰å¾…pç»ˆæ­¢ï¼Œtimeoutæ˜¯å¯é€‰çš„è¶…æ—¶æ—¶é—´ 2.2.5 Processç±»å¸¸ç”¨å±æ€§ name å½“å‰è¿›ç¨‹å®ä¾‹åˆ«åï¼Œé»˜è®¤ä¸ºProcess-N,Nä¸ºä»1å¼€å§‹é€’å¢çš„æ•´æ•°ï¼Œå¯ä»¥æŒ‡å®šè¿›ç¨‹åç§° pid å½“å‰è¿›ç¨‹å®ä¾‹çš„PID 2.2.6 å¤šè¿›ç¨‹ä¸­çš„å…¨å±€å˜é‡ å…¨å±€å˜é‡åœ¨å¤šä¸ªè¿›ç¨‹ä¸­ä¸å…±äº«ï¼Œè¿›ç¨‹ä¹‹é—´çš„æ•°æ®æ˜¯ç‹¬ç«‹çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹äº’ä¸å½±å“ from multiprocessing import Process num = 10 def f1(): global num num += 1 print(f\"ç¬¬ä¸€ä¸ªå­è¿›ç¨‹ä¸­çš„numå€¼ä¸º:{num}\") def f2(): global num num += 2 print(f\"ç¬¬äºŒä¸ªå­è¿›ç¨‹ä¸­çš„numå€¼ä¸º:{num}\") if __name__ == \"__main__\": p1 = Process(target=f1) p2 = Process(target=f2) p1.start() p2.start() p1.join() p2.join() print(f\"å…¨å±€å˜é‡ä¸­çš„numå€¼ä¸º:{num}\") ç»“æœï¼š ç¬¬ä¸€ä¸ªå­è¿›ç¨‹ä¸­çš„numå€¼ä¸º:11 ç¬¬äºŒä¸ªå­è¿›ç¨‹ä¸­çš„numå€¼ä¸º:12 å…¨å±€å˜é‡ä¸­çš„numå€¼ä¸º:10 2.3 è¿›ç¨‹æ±  è¿›ç¨‹æ± ï¼šç”¨æ¥åˆ›å»ºå¤šä¸ªè¿›ç¨‹ å½“éœ€è¦åˆ›å»ºå¤šå­è¿›ç¨‹æ•°é‡ä¸å¤šæ—¶ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨multiprocessingä¸­çš„ProcessåŠ¨æ€ç”Ÿæˆå¤šä¸ªè¿›ç¨‹ï¼Œä½†å¦‚æœæ˜¯å¤§é‡çš„è¿›ç¨‹ç›®æ ‡ï¼Œæ‰‹åŠ¨åˆ›å»ºè¿›ç¨‹çš„å·¥ä½œé‡å·¨å¤§ï¼Œæ­¤æ—¶å°±å¯ä»¥åˆ©ç”¨multiprocessingæ¨¡å—æä¾›çš„Pool åˆå§‹åŒ–Poolæ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªæœ€å¤§è¿›ç¨‹æ•°ï¼Œå½“æœ‰æ–°çš„è¯·æ±‚æäº¤åˆ°Poolä¸­æ—¶ï¼Œå¦‚æœæ± è¿˜æ²¡æœ‰æ»¡ï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ç”¨æ¥æ‰§è¡Œè¯¥è¯·æ±‚ï¼Œä½†æ˜¯å¦‚æœæ± ä¸­çš„è¿›ç¨‹æ•°å·²ç»è¾¾åˆ°æŒ‡å®šçš„æœ€å¤§å€¼ï¼Œé‚£ä¹ˆè¯¥è¯·æ±‚å°±ä¼šç­‰å¾…ï¼Œç›´åˆ°æ± ä¸­æœ‰è¿›ç¨‹ç»“æŸï¼Œæ‰ä¼šåˆ›å»ºæ–°çš„è¿›ç¨‹æ¥æ‰§è¡Œ from multiprocessing import Pool import time def r1(): print(\"123\") time.sleep(5) def r2(): print(\"abc\") time.sleep(3) if __name__ == \"__main__\": po = Pool(5) #å®šä¹‰ä¸€ä¸ªè¿›ç¨‹æ± ï¼Œæœ€å¤§è¿›ç¨‹æ•°ä¸º5ï¼Œä¸å†™é»˜è®¤ä¸ºCPUæ ¸å¿ƒæ•° for i in range(5): po.apply_async(r1) #apply_asyncé€‰æ‹©è¦è°ƒç”¨çš„ç›®æ ‡ï¼Œæ¯æ¬¡å¾ªç¯ä¼šç”¨ç©ºå‡ºæ¥çš„å­è¿›ç¨‹å»è°ƒç”¨ç›®æ ‡ po.apply_async(r2) po.close() #è¿›ç¨‹å…³é—­ä¹‹åä¸å†æ¥å—æ–°çš„è¯·æ±‚ po.join() #ç­‰å¾…poä¸­æ‰€æœ‰å­è¿›ç¨‹ç»“æŸï¼Œå¿…é¡»æ”¾åœ¨closeåé¢ ç»“æœï¼š ç¬¬ä¸€ç§’ä¼šå‡ºç°ä»¥ä¸‹ç»“æœï¼Œä½†æ˜¯åç»­ä¸ç¡®å®š å› ä¸ºè¿›ç¨‹æ± ä¸­å®šä¹‰äº†æœ€å¤§è¿›ç¨‹æ•°ä¸º5 123 abc 123 abc 123 2.3.1 è¿›ç¨‹æ± å¸¸ç”¨å‡½æ•°è§£æ multiprocessing.Poolå¸¸ç”¨å‡½æ•°è§£æ apply_async(func[,args[,kwds]]): ä½¿ç”¨éé˜»å¡æ–¹å¼è°ƒç”¨func(å¹¶è¡Œæ‰§è¡Œï¼Œå µå¡æ–¹å¼å¿…é¡»ç­‰å¾…ä¸Šä¸€ä¸ªè¿›ç¨‹é€€å‡ºæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªè¿›ç¨‹)ï¼Œargsä¸ºä¼ é€’ç»™funcçš„å‚æ•°åˆ—è¡¨ï¼Œkwdsä¸ºä¼ é€’ç»™funcçš„å…³é”®å­—å‚æ•°åˆ—è¡¨ apply(func[,args[,kwds]]) ä½¿ç”¨é˜»å¡æ–¹å¼è°ƒç”¨func close() å…³é—­Poolï¼Œä½¿å…¶ä¸å†æ¥å—æ–°çš„ä»»åŠ¡ join() ä¸»è¿›ç¨‹é˜»å¡ï¼Œç­‰å¾…å­è¿›ç¨‹çš„é€€å‡ºï¼Œå¿…é¡»åœ¨closeæˆ–terminateä¹‹åä½¿ç”¨ 2.4 è¿›ç¨‹é—´é€šä¿¡ 2.4.1 é˜Ÿåˆ—Qå®ç°è¿›ç¨‹é—´æ•°æ®ä¼ é€’ å¤šè¿›ç¨‹ä¹‹é—´ï¼Œé»˜è®¤æ˜¯ä¸å…±äº«æ•°æ®çš„ é€šè¿‡Queue(é˜Ÿåˆ—Q)å¯ä»¥å®ç°è¿›ç¨‹é—´æ•°æ®ä¼ é€’ Qæœ¬èº«æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— Queueæ–¹æ³•è¯´æ˜ Queue.put([num]) å­˜å…¥æ¶ˆæ¯ï¼Œnumä¸å†™æˆ–è€…ä¸ºè´Ÿæ•°ä¸é™åˆ¶ Queue.qsize() è¿”å›å½“å‰é˜Ÿåˆ—åŒ…å«çš„æ¶ˆæ¯æ•°é‡ Queue.empty() å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›Trueï¼Œåä¹‹è¿”å›False Queue.full() å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œè¿”å›Trueï¼Œåä¹‹è¿”å›False Queue.get([block[,timeout]]) è·å–é˜Ÿåˆ—ä¸­çš„ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åå°†å…¶ä»é˜Ÿåˆ—ç§»é™¤ï¼Œblocké»˜è®¤å€¼ä¸ºTrue å¦‚æœblockä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸”æ²¡æœ‰è®¾ç½®timeout(å•ä½ç§’)ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¦‚æœä¸ºç©ºï¼Œæ­¤æ—¶ç¨‹åºå°†è¢«é˜»å¡(åœåœ¨è¯»å–çŠ¶æ€)ï¼Œç›´åˆ°ä»æ¶ˆæ¯é˜Ÿåˆ—è¯»åˆ°æ¶ˆæ¯ä¸ºæ­¢ å¦‚æœè®¾ç½®äº†timeoutï¼Œåˆ™ä¼šç­‰å¾…timeoutç§’ï¼Œè‹¥è¿˜æ²¡æœ‰è¯»å–åˆ°ä»»ä½•æ¶ˆæ¯ï¼Œåˆ™æŠ›å‡º\"Queue.Empty\"å¼‚å¸¸ å¦‚æœblockå€¼ä¸ºFalseï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¦‚æœä¸ºç©ºï¼Œåˆ™ä¼šç«‹åˆ»æŠ›å‡º\"Queue.Empty\"å¼‚å¸¸ 2.4.1.1 å­˜å…¥æ¶ˆæ¯ Queue.put([num]) #å­˜å…¥æ¶ˆæ¯ï¼Œnumä¸å†™æˆ–è€…ä¸ºè´Ÿæ•°ä¸é™åˆ¶ //å­˜å…¥æ¶ˆæ¯ï¼Œæœ€å¤šå­˜å…¥3æ¡ï¼Œæ­¤æ—¶è¿è¡Œç¨‹åºä¸å›æŠ¥é”™ from multiprocessing import Queue q = Queue(3) q.put(\"å­˜å…¥æ¶ˆæ¯1\") q.put(\"å­˜å…¥æ¶ˆæ¯2\") q.put(\"å­˜å…¥æ¶ˆæ¯3\") //å­˜å…¥æ¶ˆæ¯ï¼Œæœ€å¤šå­˜å…¥3æ¡ï¼Œå¦‚æœæ­¤æ—¶å­˜å…¥4æ¡ï¼Œç¨‹åºä¼šå¡ä½ï¼ŒçŸ¥é“èƒ½å¤Ÿå­˜å…¥ä¸ºæ­¢ from multiprocessing import Queue q = Queue(3) q.put(\"å­˜å…¥æ¶ˆæ¯1\") q.put(\"å­˜å…¥æ¶ˆæ¯2\") q.put(\"å­˜å…¥æ¶ˆæ¯3\") q.put(\"å­˜å…¥æ¶ˆæ¯4\") #è¿™ä¸€æ¡æ¶ˆæ¯ä¸ä¼šå­˜å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼ŒçŸ¥é“é˜Ÿåˆ—æœ‰ç©ºé—²å¯ä»¥å­˜å…¥ä¸ºæ­¢ 2.4.1.2 è¯»å–æ¶ˆæ¯ Queue.get([block[,timeout]]) #è·å–é˜Ÿåˆ—ä¸­çš„ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åå°†å…¶ä»é˜Ÿåˆ—ç§»é™¤ï¼Œblocké»˜è®¤å€¼ä¸ºTrue //å­˜å…¥æ¶ˆæ¯ from multiprocessing import Queue q = Queue(3) #åˆå§‹åŒ–ä¸€ä¸ªQueueå¯¹è±¡ï¼Œæœ€å¤šå¯æ¥å—3æ¡æ¶ˆæ¯ q.put(\"å­˜å…¥æ¶ˆæ¯1\") #æ·»åŠ æ¶ˆæ¯ï¼Œæ•°æ®ç±»å‹ä¸é™ q.put(\"å­˜å…¥æ¶ˆæ¯2\") q.put(\"å­˜å…¥æ¶ˆæ¯3\") //è¯»å–æ¶ˆæ¯ï¼Œé»˜è®¤æ–¹å¼è¯»å– from multiprocessing import Queue q = Queue(3) #åˆå§‹åŒ–ä¸€ä¸ªQueueå¯¹è±¡ï¼Œæœ€å¤šå¯æ¥å—3æ¡æ¶ˆæ¯ q.put(\"å­˜å…¥æ¶ˆæ¯1\") #æ·»åŠ æ¶ˆæ¯ï¼Œæ•°æ®ç±»å‹ä¸é™ q.put(\"å­˜å…¥æ¶ˆæ¯2\") q.put(\"å­˜å…¥æ¶ˆæ¯3\") print(q.get()) print(q.get()) print(q.get()) ç»“æœï¼š å­˜å…¥æ¶ˆæ¯1 å­˜å…¥æ¶ˆæ¯2 //è¯»å–æ¶ˆæ¯ï¼ŒæŒ‡å®šblockå€¼ä¸ºFalse å¦‚æœblockå€¼ä¸ºFalseï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¦‚æœä¸ºç©ºï¼Œåˆ™ä¼šç«‹åˆ»æŠ›å‡º\"Queue.Empty\"å¼‚å¸¸ from multiprocessing import Queue q = Queue(3) print(q.get(block=False)) ç»“æœï¼š queue.Empty âš ï¸æ­¤æ–¹æ³•æœ‰æ—¶ä¼šæŠ¥é”™é˜Ÿåˆ—ä¸ºç©ºï¼Œæœ‰æ—¶å°±æ²¡æœ‰é—®é¢˜ï¼Œwinå’Œmacä¸­ä¸€æ ·,linuxä¼šå§‹ç»ˆæŠ¥é”™é˜Ÿåˆ—ä¸ºç©º from multiprocessing import Queue q = Queue(3) q.put(\"å­˜å…¥æ¶ˆæ¯1\") q.put(\"å­˜å…¥æ¶ˆæ¯2\") q.put(\"å­˜å…¥æ¶ˆæ¯3\") print(q.get(block=False)) //è¯»å–æ¶ˆæ¯ï¼ŒæŒ‡å®šè¯»å–ç©ºé˜Ÿåˆ—è¶…æ—¶æ—¶é—´ from multiprocessing import Queue q = Queue(3) print(q.get(timeout=3)) ç»“æœï¼š ç­‰å¾…3ç§’åä¼šæŠ¥é”™ queue.Empty Queue.get_nowait() ç›¸å½“äºQueue.get(False) from multiprocessing import Queue q = Queue(3) print(q.get_nowait()) ç»“æœï¼š queue.Empty 2.4.1.3 è·å–é˜Ÿåˆ—ä¿¡æ¯ Queue.empty() #å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›Trueï¼Œåä¹‹è¿”å›False //é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œè¿”å›False from multiprocessing import Queue import time q = Queue(3) q.put(\"1\") q.put(\"2\") q.put(\"3\") time.sleep(0.1) #å¦‚æœä¸åŠ sleepå¯èƒ½ä¼šè¿”å›é˜Ÿåˆ—ä¸ºç©º print(q.empty()) ç»“æœï¼š False //é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›True from multiprocessing import Queue import time q = Queue(3) print(q.empty()) Queue.full() #å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œè¿”å›Trueï¼Œåä¹‹è¿”å›False //é˜Ÿåˆ—æ»¡ï¼Œè¿”å›True from multiprocessing import Queue q = Queue(3) q.put(1) q.put(2) q.put(3) print(q.full()) ç»“æœï¼š True //é˜Ÿåˆ—ä¸æ»¡ï¼Œè¿”å›False from multiprocessing import Queue q = Queue(3) q.put(1) q.put(2) print(q.full()) ç»“æœï¼š False å¤šæ¥å—æ–¹ä»£ç ç¤ºä¾‹ åŒæ—¶æœ‰2ä¸ªä»¥ä¸Šçš„æ¥æ”¶æ–¹ from multiprocessing import Process,Queue import time def write(q): for i in range(6): print(\"å­è¿›ç¨‹1å†™å…¥äº†ï¼š\",i) q.put(i) time.sleep(1) def read1(q): while True: if not q.empty(): print(\"å­è¿›ç¨‹2è¯»å–äº†ï¼š\",q.get()) time.sleep(1) else: break def read2(q): while True: if not q.empty(): print(\"å­è¿›ç¨‹3è¯»å–äº†ï¼š\",q.get()) time.sleep(1) else: break if __name__ == \"__main__\": q = Queue() pw = Process(target=write,args=(q,)) pr1 = Process(target=read1,args=(q,)) pr2 = Process(target=read2,args=(q,)) pw.start() pw.join() pr1.start() pr2.start() pr1.join() pr2.join() print(\"æ¥å—å®Œæ¯•ï¼\") ç»“æœï¼š å­è¿›ç¨‹1å†™å…¥äº†ï¼š 0 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 1 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 2 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 3 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 4 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 5 å­è¿›ç¨‹2è¯»å–äº†ï¼š 0 å­è¿›ç¨‹3è¯»å–äº†ï¼š 1 å­è¿›ç¨‹2è¯»å–äº†ï¼š 2 å­è¿›ç¨‹3è¯»å–äº†ï¼š 3 å­è¿›ç¨‹3è¯»å–äº†ï¼š 4 å­è¿›ç¨‹2è¯»å–äº†ï¼š 5 æ¥å—å®Œæ¯•ï¼ âš ï¸ä¸Šè¿°ä»£ç çš„é—®é¢˜ä¹‹å¤„ï¼Œå­è¿›ç¨‹2å’Œå­è¿›ç¨‹3ä¸èƒ½åŒæ—¶è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œå­è¿›ç¨‹2è¯»å–äº†0ã€2ã€4ï¼Œå­è¿›ç¨‹3è¯»å–äº†1ã€3ã€5ï¼Œéœ€è¦åšä¸€äº›ä»£ç é€»è¾‘ä¿®æ”¹ï¼Œè®©å­è¿›ç¨‹2å’Œå­è¿›ç¨‹3èƒ½å¤ŸåŒæ—¶è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ //ä¸¤ä¸ªæ¥æ”¶æ–¹è¯»å–æ¶ˆæ¯é˜Ÿåˆ— æ€è·¯ï¼š from multiprocessing import Process,Queue import time def write(q1): for i in range(6): print(\"å­è¿›ç¨‹1å†™å…¥äº†ï¼š\",i) q1.put(i) time.sleep(1) def read1(q1,q2): while True: if not q1.empty(): a = q1.get() #å¦‚æœq1é˜Ÿåˆ—ä¸ä¸ºç©ºåˆ™å–å€¼å¹¶èµ‹å€¼ç»™a print(\"å­è¿›ç¨‹2è¯»å–äº†ï¼š\",a) q2.put(a) #q2ä»aä¸­è¯»å–å¹¶å†™å…¥æ¶ˆæ¯ time.sleep(1) else: break def read2(q2): while True: if not q2.empty(): print(\"å­è¿›ç¨‹3è¯»å–äº†ï¼š\",q2.get()) time.sleep(1) else: break if __name__ == \"__main__\": q1 = Queue() q2 = Queue() pw = Process(target=write,args=(q1,)) pr1 = Process(target=read1,args=(q1,q2)) pr2 = Process(target=read2,args=(q2,)) pw.start() pw.join() pr1.start() pr2.start() pr1.join() pr2.join() print(\"æ¥å—å®Œæ¯•ï¼\") ç»“æœï¼š å­è¿›ç¨‹1å†™å…¥äº†ï¼š 0 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 1 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 2 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 3 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 4 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 5 å­è¿›ç¨‹2è¯»å–äº†ï¼š 0 å­è¿›ç¨‹3è¯»å–äº†ï¼š 0 å­è¿›ç¨‹2è¯»å–äº†ï¼š 1 å­è¿›ç¨‹3è¯»å–äº†ï¼š 1 å­è¿›ç¨‹2è¯»å–äº†ï¼š 2 å­è¿›ç¨‹3è¯»å–äº†ï¼š 2 å­è¿›ç¨‹2è¯»å–äº†ï¼š 3 å­è¿›ç¨‹3è¯»å–äº†ï¼š 3 å­è¿›ç¨‹2è¯»å–äº†ï¼š 4 å­è¿›ç¨‹3è¯»å–äº†ï¼š 4 å­è¿›ç¨‹2è¯»å–äº†ï¼š 5 å­è¿›ç¨‹3è¯»å–äº†ï¼š 5 æ¥å—å®Œæ¯•ï¼ âš ï¸âš ï¸âš ï¸macæœ¬ä¸­æ‰§è¡Œç»“æœä¸æ­£ç¡®ï¼š å­è¿›ç¨‹1å†™å…¥äº†ï¼š 0 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 1 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 2 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 3 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 4 å­è¿›ç¨‹1å†™å…¥äº†ï¼š 5 å­è¿›ç¨‹2è¯»å–äº†ï¼š 0 å­è¿›ç¨‹2è¯»å–äº†ï¼š 1 å­è¿›ç¨‹2è¯»å–äº†ï¼š 2 å­è¿›ç¨‹2è¯»å–äº†ï¼š 3 å­è¿›ç¨‹2è¯»å–äº†ï¼š 4 å­è¿›ç¨‹2è¯»å–äº†ï¼š 5 æ¥å—å®Œæ¯•ï¼ è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹ä¹‹é—´çš„åŒºåˆ« è¿›ç¨‹ æœ€å°çš„èµ„æºå•ä½ï¼Œå†…å­˜çº§åˆ«ï¼Œå¦‚æœè¿›ç¨‹ä¸­æ²¡æœ‰çº¿ç¨‹åªæ˜¯åˆ’åˆ†äº†ä¸€ä¸ªç©ºé—´ çº¿ç¨‹ æœ€å°çš„è¿è¡Œå•ä½ï¼Œcpuçº§åˆ«ï¼Œè¿›ç¨‹åœ¨æ‰§è¡Œï¼Œå®é™…ä¸Šæ˜¯çº¿ç¨‹åœ¨æ‰§è¡Œ åç¨‹ å¾®çº¿ç¨‹ ç”¨æˆ·çº§åˆ« æ“ä½œç³»ç»Ÿä¸çŸ¥é“ä»€ä¹ˆæ˜¯åç¨‹ï¼Œæ˜¯ç¨‹åºå‘˜yyå‡ºæ¥çš„ï¼Œæ¬ºéª—æ“ä½œç³»ç»Ÿï¼Œå› ä¸ºæœ‰IOæ“ä½œï¼Œæ“ä½œç³»ç»Ÿä¼šå›æ”¶æƒé™ï¼Œåç¨‹å°±æ˜¯åœ¨ç”¨æˆ·çº§åˆ«å°†å¤šä¸ªä»»åŠ¡åšæˆä¸€ä¸ªä»»åŠ¡ï¼Œä½†å‡¡æœ‰ä¸€ä¸ªçº¿ç¨‹æœ‰IOï¼Œæ‰‹åŠ¨åˆ‡æ¢ï¼Œè®©çº¿ç¨‹èƒ½è·å¾—æ›´å¤§å ç”¨ç³»ç»Ÿèµ„æºçš„æœºä¼šï¼Œæé«˜å•çº¿ç¨‹æ•ˆç‡ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/25.2pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šçº¿ç¨‹.html":{"url":"python/pythonåŸºç¡€/25.2pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šçº¿ç¨‹.html","title":"å¹¶å‘ç¼–ç¨‹-å¤šçº¿ç¨‹","keywords":"","body":"pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šçº¿ç¨‹ 1.çº¿ç¨‹æ¦‚å¿µ çº¿ç¨‹ï¼šå®ç°å¤šä»»åŠ¡çš„å¦ä¸€ç§æ–¹å¼ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­åŒæ—¶è¿è¡Œçš„å¤šä¸ªå­ä»»åŠ¡å°±æˆä¸ºçº¿ç¨‹ è½»é‡çº§è¿›ç¨‹ï¼šçº¿ç¨‹åˆè¢«ç§°ä¸ºè½»é‡çº§è¿›ç¨‹ï¼Œæ˜¯æ›´å°çš„æ‰§è¡Œå•å…ƒ ä¸€ä¸ªè¿›ç¨‹å¯æ‹¥æœ‰å¤šä¸ªå¹¶è¡Œçš„çº¿ç¨‹ï¼Œå½“ä¸­æ¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå…±äº«å½“å‰è¿›ç¨‹çš„èµ„æº ä¸€ä¸ªè¿›ç¨‹ä¸­çš„çº¿ç¨‹å…±äº«ç›¸åŒçš„å†…å­˜å•å…ƒ/å†…å­˜åœ°å€ç©ºé—´ï¼Œè¿™æ ·å°±å¯ä»¥è®¿é—®ç›¸åŒçš„å˜é‡å’Œå¯¹è±¡ï¼Œè€Œä¸”ä»–ä»¬ä»åŒä¸€å †ä¸­åˆ†é…å¯¹è±¡ï¼Œè¿›è¡Œé€šä¿¡ã€æ•°æ®äº¤æ¢ã€åŒæ­¥æ“ä½œ çº¿ç¨‹é—´çš„é€šä¿¡æ˜¯åœ¨åŒä¸€ä¸ªåœ°å€ä¸Šè¿›è¡Œçš„ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–çš„é€šä¿¡æœºåˆ¶ï¼Œè¿™å°±ä½¿å¾—é€šä¿¡æ›´ç®€å•è€Œä¸”ä¿¡æ¯ä¼ é€’é€Ÿåº¦ä¹Ÿæ›´å¿« çº¿ç¨‹çš„5ç§çŠ¶æ€ å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„(æ“ä½œç³»ç»Ÿå†³å®š)ã€‚å½“æ‰§è¡Œåˆ°sleepè¯­å¥æ—¶ï¼Œçº¿ ç¨‹å°†è¢«é˜»å¡(Blocked) ï¼Œ åˆ°sleepç»“æŸåï¼Œ çº¿ç¨‹è¿›å…¥å°±ç»ª(Runnable) çŠ¶æ€ï¼Œ ç­‰å¾…è°ƒåº¦ã€‚ è€Œçº¿ç¨‹è°ƒåº¦å°†è‡ªè¡Œé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚ ä»£ç ä¸­åªèƒ½ä¿è¯æ¯ä¸ªçº¿ç¨‹éƒ½è¿è¡Œ å®Œæ•´ä¸ªrunå‡½æ•°ï¼Œ ä½†æ˜¯çº¿ç¨‹çš„å¯åŠ¨é¡ºåºã€runå‡½æ•°ä¸­æ¯æ¬¡å¾ªç¯çš„æ‰§è¡Œé¡ºåºéƒ½ä¸èƒ½ç¡®å®š 1ã€æ–°çŠ¶æ€:çº¿ç¨‹å¯¹è±¡å·²ç»åˆ›å»ºï¼Œè¿˜æ²¡æœ‰åœ¨å…¶ä¸Šè°ƒç”¨start()æ–¹æ³•ã€‚ 2ã€å¯è¿è¡ŒçŠ¶æ€:å½“çº¿ç¨‹æœ‰èµ„æ ¼è¿è¡Œï¼Œä½†è°ƒåº¦ç¨‹åºè¿˜æ²¡æœ‰æŠŠå®ƒé€‰å®šä¸ºè¿è¡Œçº¿ç¨‹æ—¶çº¿ç¨‹æ‰€å¤„çš„çŠ¶æ€ã€‚å½“start()æ–¹æ³•è°ƒç”¨æ—¶ï¼Œçº¿ç¨‹é¦–å…ˆè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ã€‚åœ¨çº¿ç¨‹è¿è¡Œä¹‹åæˆ–è€…ä»é˜»å¡ã€ç­‰å¾…æˆ–ç¡çœ çŠ¶æ€å›æ¥åï¼Œä¹Ÿè¿”å›åˆ°å¯è¿è¡ŒçŠ¶æ€ã€‚ 3ã€è¿è¡ŒçŠ¶æ€:çº¿ç¨‹è°ƒåº¦ç¨‹åºä»å¯è¿è¡Œæ± ä¸­é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ä½œä¸ºå½“å‰çº¿ç¨‹æ—¶çº¿ç¨‹æ‰€å¤„çš„çŠ¶æ€ã€‚è¿™ä¹Ÿæ˜¯çº¿ç¨‹è¿›å…¥è¿è¡ŒçŠ¶æ€çš„å”¯ä¸€ä¸€ç§æ–¹å¼ã€‚ 4ã€ç­‰å¾…/é˜»å¡/ç¡çœ çŠ¶æ€:è¿™æ˜¯çº¿ç¨‹æœ‰èµ„æ ¼è¿è¡Œæ—¶å®ƒæ‰€å¤„çš„çŠ¶æ€ã€‚å®é™…ä¸Šè¿™ä¸ªä¸‰çŠ¶æ€ç»„åˆä¸ºä¸€ç§ï¼Œå…¶å…±åŒç‚¹æ˜¯:çº¿ç¨‹ä»æ—§æ˜¯æ´»çš„(å¯è¿è¡Œçš„)ï¼Œä½†æ˜¯å½“å‰æ²¡æœ‰æ¡ä»¶è¿è¡Œã€‚ ä½†æ˜¯å¦‚æœæŸä»¶äº‹ä»¶å‡ºç°ï¼Œä»–å¯èƒ½è¿”å›åˆ°å¯è¿è¡ŒçŠ¶æ€ã€‚ 5ã€æ­»äº¡æ€:å½“çº¿ç¨‹çš„run()æ–¹æ³•å®Œæˆæ—¶å°±è®¤ä¸ºå®ƒæ­»å»ã€‚è¿™ä¸ªçº¿ç¨‹å¯¹è±¡ä¹Ÿè®¸æ˜¯æ´»çš„ï¼Œä½†æ˜¯ï¼Œå®ƒå·²ç»ä¸æ˜¯ä¸€ä¸ªå•ç‹¬æ‰§è¡Œçš„çº¿ç¨‹ï¼Œçº¿ç¨‹ä¸€æ—¦æ­»äº¡ï¼Œå°±ä¸èƒ½å†æ¬¡æ‰§è¡Œï¼Œå¦‚æœåœ¨ä¸€ä¸ªæ­»å»çš„çº¿ç¨‹ä¸Šè°ƒç”¨start()æ–¹æ³•ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ 2.çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ« åŒºåˆ« è¿›ç¨‹ çº¿ç¨‹ æ ¹æœ¬åŒºåˆ« ä½œä¸ºèµ„æºåˆ†é…çš„å•ä½ è°ƒåº¦å’Œæ‰§è¡Œçš„å•ä½ å¼€é”€ æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ä»£ç å’Œæ•°æ®ç©ºé—´(è¿›ç¨‹ä¸Šä¸‹æ–‡)ï¼Œè¿›ç¨‹é—´çš„åˆ‡æ¢ä¼šæœ‰è¾ƒå¤§çš„å¼€é”€ çº¿ç¨‹å¯ä»¥çœ‹æˆæ˜¯è½»é‡çº§çš„è¿›ç¨‹ï¼ŒåŒä¸€ä¸ªç±»çº¿ç¨‹å…±äº«ä»£ç å’Œæ•°æ®ç©ºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨(PC)ï¼Œçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€å° æ‰€å¤„ç¯å¢ƒ åœ¨æ“ä½œç³»ç»Ÿä¸­èƒ½åŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡ åœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­æœ‰å¤šä¸ªé¡ºåºæµåŒæ—¶æ‰§è¡Œ åˆ†é…å†…å­˜ ç³»ç»Ÿåœ¨è¿è¡Œçš„æ—¶å€™ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸åŒçš„å†…å­˜åŒºåŸŸ é™¤äº†CPUä¹‹å¤–ï¼Œä¸ä¼šä¸ºçº¿ç¨‹åˆ†é…å†…å­˜ï¼Œçº¿ç¨‹ä½¿ç”¨çš„èµ„æºæ˜¯å®ƒæ‰€å±çš„è¿›ç¨‹çš„èµ„æºï¼Œçº¿ç¨‹åªèƒ½å…±äº«èµ„æº åŒ…å«å…³ç³» æ²¡æœ‰çº¿ç¨‹çš„è¿›ç¨‹æ˜¯å¯ä»¥è¢«çœ‹ä½œå•çº¿ç¨‹çš„ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹å†…æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œè¿‡ç¨‹ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯å¤šä¸ªçº¿ç¨‹å®Œæˆçš„ çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥çº¿ç¨‹æœ‰çš„æ—¶å€™è¢«ç§°ä¸ºæ˜¯è½»æƒè¿›ç¨‹æˆ–è€…è½»é‡è¿›ç¨‹ 3.å¤šçº¿ç¨‹å®ç° 3.1 é€šè¿‡threading.Threadç›´æ¥åœ¨çº¿ç¨‹ä¸­è¿è¡Œå‡½æ•° //åˆ›å»ºå•çº¿ç¨‹ import threading #å¯¼å…¥threadingæ¨¡å— def thread(): print(\"çº¿ç¨‹å¯åŠ¨\") t = threading.Thread(target=thread) #åˆ›å»ºçº¿ç¨‹ t.start() #å¯åŠ¨çº¿ç¨‹ //åˆ©ç”¨forå¾ªç¯åˆ›å»ºå¤šçº¿ç¨‹ import threading def thread(): print(\"å­çº¿ç¨‹å¯åŠ¨\") for i in range(5): t = threading.Thread(target=thread) t.start() ç»“æœï¼š å­çº¿ç¨‹å¯åŠ¨ å­çº¿ç¨‹å¯åŠ¨ å­çº¿ç¨‹å¯åŠ¨ å­çº¿ç¨‹å¯åŠ¨ å­çº¿ç¨‹å¯åŠ¨ 3.2 é€šè¿‡ç±»ç»§æ‰¿threading.Threadç±»æ¥åˆ›å»ºçº¿ç¨‹ import threading class MyThread(threading.Thread): def run(self): for i in range(5): print(i) t1 = MyThread() t2 = MyThread() t1.start() t2.start() ç»“æœï¼š 0 1 2 3 4 0 1 2 3 4 3.3 æŸ¥çœ‹å½“å‰çº¿ç¨‹æ•°é‡ len(threading.enumerate() import threading import time import random def func(): time.sleep(random.randint(1, 3)) print(threading.current_thread().name,f\"å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡{len(threading.enumerate())}\") lst = [threading.Thread(target=func,name=f\"çº¿ç¨‹{i}\") for i in range(10)] for i in lst: i.start() ç»“æœï¼š çº¿ç¨‹åç§°ä¸å›ºå®š çº¿ç¨‹2 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡11 çº¿ç¨‹8 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡10 çº¿ç¨‹7 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡9 çº¿ç¨‹4 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡8 çº¿ç¨‹3 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡7 çº¿ç¨‹1 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡6 çº¿ç¨‹0 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡5 çº¿ç¨‹9 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡4 çº¿ç¨‹6 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡3 çº¿ç¨‹5 å½“å‰æ´»è·ƒçº¿ç¨‹æ•°é‡2 4.çº¿ç¨‹åŒæ­¥ 4.1äº’æ–¥é” åˆ›å»ºé” lock = threading.Lock() é”å®š lock.acquire() é‡Šæ”¾é” lock.release() æœªåŠ é”ä¹‹å‰å¾ªç¯100ä¸‡æ¬¡å‡ºç°çš„ç»“æœä¸å‡†ç¡®BUG from multiprocessing import Queue,Process,Lock import threading num = 0 def f1(): global num for i in range(1000000): num += 1 print(num) def f2(): global num for i in range(1000000): num += 1 print(num) t1 = threading.Thread(target=f1) t2 = threading.Thread(target=f2) t1.start() t2.start() print(\"ä¸»çº¿ç¨‹çš„numæ˜¯\",num) ç»“æœ1: ä¸»çº¿ç¨‹çš„numæ˜¯ 299428 1226857 1536106 ç»“æœ2: ä¸»çº¿ç¨‹çš„numæ˜¯ 263111 1173618 1499331 æ¯ä¸€æ¬¡æ‰§è¡Œçš„ç»“æœéƒ½ä¸ä¸€æ · åŠ é”è§£å†³å¾ªç¯100ä¸‡æ¬¡å‡ºç°ç»“æœä¸å‡†ç¡®çš„BUG from multiprocessing import Queue,Process,Lock import threading num = 0 def f1(): global num lock.acquire() for i in range(1000000): num += 1 print(num) lock.release() def f2(): global num lock.acquire() for i in range(1000000): num += 1 print(num) lock.release() lock = threading.Lock() #åˆ›å»ºé” t1 = threading.Thread(target=f1) t2 = threading.Thread(target=f2) t1.start() t2.start() print(\"ä¸»çº¿ç¨‹çš„numæ˜¯\",num) ç»“æœ1: ä¸»çº¿ç¨‹çš„numæ˜¯ 235674 1000000 2000000 ç»“æœ2: ä¸»çº¿ç¨‹çš„numæ˜¯ 227114 1000000 2000000 ä¸»çº¿ç¨‹çš„numè¿˜æ˜¯ä¸ä¸€è‡´ï¼Œå› ä¸ºçº¿ç¨‹é—´æ•°æ®æ˜¯å…±äº«çš„ï¼Œé”åªèƒ½ä¿è¯f1ã€f2ä¸¤ä¸ªå‡½æ•°ä¸­å®Œæ•´æ‰§è¡Œ 4.2äº’æ–¥é”å®ç°çº¿ç¨‹åŒæ­¥ ä»£ç æ•´ä½“æ€è·¯ 1.åˆ›å»º3ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ‰§è¡Œ3ä¸ªå‡½æ•°f1ã€f2ã€f3 2.åˆ›å»º3ä¸ªé”ï¼Œåªæœ‰åœ¨é”1åˆ›å»ºåä¸ä¸Šé”ï¼Œé”2ã€é”3éƒ½ä¸Šé” 3.ç”±äºé”1æ²¡æœ‰ä¸Šé”ï¼Œå› æ­¤å¯ä»¥å…ˆæ‰§è¡Œï¼Œé”1ä¸­æ‰§è¡Œåé‡Šæ”¾é”2ï¼Œé”2æ‰§è¡Œï¼Œæ‰§è¡Œåé‡Šæ”¾é”3ï¼Œé”3æ‰§è¡Œï¼Œæ‰§è¡Œå®Œåé‡Šæ”¾é”1ï¼Œé”1æ‰§è¡Œï¼Œè¿™æ ·å°±å¯ä»¥æ— é™å¾ªç¯é¡ºåºæ‰§è¡Œé”1ã€é”2ã€é”3 import threading from multiprocessing import Lock def f1(): while True: lock1.acquire() #æŠ¢é”1 print(1) lock2.release() #é‡Šæ”¾é”2ï¼Œè¿™æ ·å°±èƒ½æ‰§è¡Œå‡½æ•°f2 def f2(): while True: lock2.acquire() #æŠ¢é”2 print(2) lock3.release() #é‡Šæ”¾é”3ï¼Œè¿™æ ·å°±èƒ½æ‰§è¡Œå‡½æ•°f3 def f3(): while True: lock3.acquire() #æŠ¢é”3 print(3) lock1.release() #é‡Šæ”¾é”1ï¼Œè¿™æ ·å°±èƒ½æ‰§è¡Œå‡½æ•°f1 #åˆ›å»º3ä¸ªçº¿ç¨‹ï¼Œå¹¶åˆ†åˆ«æ‰§è¡Œå‡½æ•°f1ã€f2ã€f3 t1 = threading.Thread(target=f1) t2 = threading.Thread(target=f2) t3 = threading.Thread(target=f3) #åˆ›å»º3ä¸ªé”ï¼Œå¹¶ä¸”é”2ã€é”3åˆ›å»ºåå°±ä¸Šé” lock1 = threading.Lock() lock2 = threading.Lock() lock2.acquire() lock3 = threading.Lock() lock3.acquire() #å¯åŠ¨çº¿ç¨‹ t1.start() t2.start() t3.start() ç»“æœï¼š 1 2 3 1 2 3 ã€‚ã€‚ã€‚ 4.3æ¶ˆæ¯é˜Ÿåˆ—Queueå®ç°çº¿ç¨‹åŒæ­¥ 4.3.1çº¿ç¨‹ä¸­çš„Queueä¸è¿›ç¨‹ä¸­çš„QueueåŒºåˆ« è¿›ç¨‹ä¸­çš„Queue è¿›ç¨‹ä¸­çš„Queueæ˜¯ä»multriprocessingæ¨¡å—ä¸­å¯¼å…¥çš„ï¼Œ from multiprocessing import Queueï¼Œä½œç”¨æ˜¯ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ çº¿ç¨‹ä¸­çš„Queue çº¿ç¨‹ä¸­çš„Queueæ˜¯ä»queueæ¨¡å—ä¸­å¯¼å…¥çš„ï¼Œfrom queue import Queueï¼Œä½œç”¨æ˜¯å®ç°çº¿ç¨‹åŒæ­¥ 4.3.2çº¿ç¨‹ä¸­çš„Queue Pythonä¸­Queueæ¨¡å—ï¼Œå®ç°äº†3ç§ç±»å‹çš„é˜Ÿåˆ—æ¥å®ç°çº¿ç¨‹åŒæ­¥ï¼ŒåŒ…æ‹¬ FIFO(å…ˆå…¥å…ˆå‡º) é˜Ÿåˆ—Queueï¼ŒæŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ£€ç´¢æ¡ç›® LIFO(åå…¥å…ˆå‡º) æ ˆLifoQueueï¼Œæœ€åæ·»åŠ çš„æ¡ç›®æœ€å…ˆæ£€ç´¢åˆ° ä¼˜å…ˆçº§é˜Ÿåˆ— PriorityQueueï¼Œæ¡ç›®è¢«ä¿å­˜ä¸ºæœ‰åºçš„(ä½¿ç”¨heapqæ¨¡å—)å¹¶ä¸”æœ€å°å€¼çš„æ¡ç›®æœ€å…ˆè¢«å‰ªé” class queue.Queue(maxsize=0) FIFOé˜Ÿåˆ—çš„æ„é€ å™¨ï¼Œmaxsizeä¸ºä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºé˜Ÿåˆ—çš„æœ€å¤§æ¡ç›®æ•°ï¼Œå¯ç”¨æ¥é™åˆ¶å†…å­˜çš„ä½¿ç”¨ ä¸€æ—¦é˜Ÿåˆ—æ»¡ï¼Œæ’å…¥å°†è¢«é˜»å¡ç›´åˆ°é˜Ÿåˆ—ä¸­å­˜åœ¨ç©ºé—²æ—¶é—´ï¼Œå¦‚æœmaxsizeå°äºç­‰äº0ï¼Œé˜Ÿåˆ—å¤§å°ä¸ºæ— é™åˆ¶ï¼Œmaxsizeé»˜è®¤ä¸º0 import queue import threading def write(): while True: if q1.qsize() = 100: for i in range(20): a = q1.get() print(a) q1 = queue.Queue() #é€šè¿‡Queueéš”ç¦»å¼€äº†å­˜æ”¾æ•°æ®çš„çº¿ç¨‹ä¸è¯»å–æ•°æ®çš„çº¿ç¨‹ for i in range(1,501): q1.put(f\"åˆå§‹æ•°æ®f{i}\") for i in range(500): print(q1.get()) t1 = threading.Thread(target=write) t2 = threading.Thread(target=read) t1.start() t2.start() ç»“æœï¼š å¾ªç¯æ‰“å°æ–°æ•°æ®1-50 4.3.3ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ ç”Ÿäº§è€…å°±æ˜¯ç”Ÿäº§æ•°æ®çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…å°±æ˜¯æ¶ˆè´¹æ•°æ®çš„çº¿ç¨‹ ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼æ˜¯é€šè¿‡ä¸€ä¸ªå®¹å™¨(ç¼“å†²åŒº)æ¥è§£å†³ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¼ºè€¦åˆé—®é¢˜ ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¸ç›´æ¥é€šè®¯ï¼Œé€šè¿‡é˜»å¡é˜Ÿåˆ—æ¥è¿›è¡Œé€šè®¯ 4.4æ­»é”(é”™è¯¯æƒ…å†µ) æ­»é”å±äºé”™è¯¯æƒ…å†µï¼Œåœ¨çº¿ç¨‹å…±äº«å¤šä¸ªèµ„æºçš„æ—¶å€™ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«å æœ‰ä¸€éƒ¨åˆ†èµ„æºå¹¶åŒæ—¶ç­‰å¾…å¯¹æ–¹çš„èµ„æºï¼Œå°±ä¼šé€ æˆæ­»é” #ä»¥ä¸‹ä»£ç ï¼Œé”1å†ç­‰å¾…é”2ï¼Œé”2å†ç­‰å¾…é”1ï¼Œå› æ­¤é€ æˆäº†æ­»é” import threading import time def f1(): if lock1.acquire(): #f1æŠ¢åˆ°äº†é”1 print(\"lock1æŠ¢åˆ°äº†é”\") time.sleep(1) if lock2.acquire(): #å†ç­‰å¾…é”2ï¼Œä½†æ˜¯é”2å·²ç»è¢«f2æŠ¢åˆ°ï¼Œè¿˜æœªé‡Šæ”¾ï¼Œå› æ­¤æ— æ³•ç»§ç»­æ‰§è¡Œåç»­ä»£ç  print(\"lock2\") lock2.release() lock1.release() def f2(): if lock2.acquire(): #f2æŠ¢åˆ°äº†é”2 print(\"lock2æŠ¢åˆ°äº†é”\") time.sleep(1) if lock1.acquire(): #å†ç­‰å¾…é”1ï¼Œä½†æ˜¯é”1å·²ç»è¢«f1æŠ¢åˆ°ï¼Œè¿˜æœªé‡Šæ”¾ï¼Œå› æ­¤æ— æ³•ç»§ç»­æ‰§è¡Œåç»­ä»£ç  print(\"lock1\") lock1.release() lock2.release() lock1 = threading.Lock() lock2 = threading.Lock() t1 = threading.Thread(target=f1) t2 = threading.Thread(target=f2) t1.start() t2.start() ç»“æœï¼š lock1æŠ¢åˆ°äº†é” lock2æŠ¢åˆ°äº†é” ç¨‹åºä¼šå¡ä½ä¸åŠ¨ 4.5ä¿¡å·é‡ semaphone 4.5.1æ¦‚å¿µ 1.ä¿¡å·é‡semaphoneç”¨äºæ§åˆ¶ä¸€ä¸ªæ—¶é—´ç‚¹å†…çº¿ç¨‹è¿›å…¥æ•°é‡çš„é”ï¼Œä¿¡å·é‡æ˜¯ç”¨æ¥æ§åˆ¶çº¿ç¨‹å¹¶å‘æ•°çš„ 2.ä¿¡å·é‡åªæ§åˆ¶åŒä¸€æ—¶é—´èƒ½å¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå…¶ä½™ä¸ç®¡ 4.5.2ä½¿ç”¨åœºæ™¯ è¯»å†™æ–‡ä»¶ è¯»å†™æ–‡ä»¶çš„æ—¶å€™ï¼Œä¸€èˆ¬åªæœ‰ä¸€ä¸ªçº¿ç¨‹å†å†™ï¼Œè€Œè¯»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œï¼Œå¦‚æœéœ€è¦é™åˆ¶åŒæ—¶è¯»å–æ–‡ä»¶çš„çº¿ç¨‹ä¸ªæ•°ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°ä¿¡å·é‡ å¦‚æœä½¿ç”¨äº’æ–¥é”ï¼Œå°±æ˜¯é™åˆ¶åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¯»å–æ–‡ä»¶ æä¾›è®¿é—®çš„webæœåŠ¡ webæœåŠ¡éƒ½æ˜¯è·‘åœ¨æœåŠ¡å™¨ä¸­çš„ï¼Œè€ŒæœåŠ¡å™¨çš„èµ„æºæ˜¯æœ‰é™çš„ï¼Œå¦‚æœè®¿é—®è¯·æ±‚æ•°é‡ç‰¹åˆ«å¤šï¼Œä¸åŠ é™åˆ¶å°±ä¼šå¯¼è‡´æœåŠ¡å™¨å®•æœºï¼Œæ­¤æ—¶ä½¿ç”¨ä¿¡å·é‡é™åˆ¶åŒä¸€æ—¶é—´webæœåŠ¡èƒ½å¤„ç†çš„è¯·æ±‚å°±ä¸ä¼šé€ æˆå› è®¿é—®é‡å·¨å¤§è€Œé€ æˆæœåŠ¡å™¨å®•æœº 4.5.3ä¿¡å·é‡ä»£ç ç¤ºä¾‹ //æ— æ³•æ§åˆ¶åŒæ—¶æ‰§è¡Œçš„çº¿ç¨‹æ•° import time import threading def f1(): time.sleep(1) print(111) for i in range(100): t1 = threading.Thread(target=f1) t1.start() ç»“æœï¼š 100ä¸ª111 //ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶åŒæ—¶æ‰§è¡Œçš„çº¿ç¨‹æ•° import time import threading s = threading.Semaphore(5) #å¼€å¯ä¿¡å·é‡ def f1(): s.acquire() #ä¿¡å·é‡åŠ é” time.sleep(2) print(111) s.release() #ä¿¡å·é‡è§£é” for i in range(100): t1 = threading.Thread(target=f1) t1.start() ç»“æœï¼š ä¸€æ¬¡æ‰“å°5ä¸ª111ï¼Œç›´åˆ°å¾ªç¯å®Œæˆ 4.6GILå…¨å±€è§£é‡Šå™¨é” 4.6.1æ¦‚å¿µ Cpythonç‹¬æœ‰çš„é”ï¼Œç‰ºç‰²æ•ˆç‡ä¿è¯æ•°æ®å®‰å…¨ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«çš„æ•°æ® 4.6.2GILé”è¯´æ˜ é¦–å…ˆï¼Œæ‰§è¡Œpythonæ–‡ä»¶æ˜¯ä»€ä¹ˆè¿‡ç¨‹ï¼Ÿè°æŠŠè¿›ç¨‹è¿è¡Œèµ·æ¥çš„ï¼Ÿ æ“ä½œç³»ç»Ÿå°†ä½ çš„åº”ç”¨ç¨‹åºä»ç¡¬ç›˜åŠ è½½åˆ°å†…å­˜ç„¶åè¿è¡Œpythonæ–‡ä»¶ï¼Œåœ¨å†…å­˜ä¸­å¼€è¾Ÿä¸€ä¸ªè¿›ç¨‹ç©ºé—´ï¼Œå°†ä½ çš„pythonè§£é‡Šå™¨ä»¥åŠp yæ–‡ä»¶åŠ è½½è¿›å»ï¼Œè§£é‡Šå™¨è¿è¡Œpyæ–‡ä»¶ pythonè§£é‡Šå™¨åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå…ˆå°†ä½ çš„ä»£ç é€šè¿‡ç¼–è¯‘å™¨ç¼–è¯‘æˆcçš„å­—èŠ‚ç ï¼Œç„¶åä½ çš„è™šæ‹Ÿæœºæ‹¿åˆ°ä½ çš„cå­—èŠ‚ç ï¼Œè¾“å‡ºæœºå™¨ç ï¼Œå†é…åˆæ“ä½œç³»ç»ŸæŠŠä½ çš„è¿™ä¸ªæœºå™¨ä»ç»™CPUå¤„ç† pyæ–‡ä»¶æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹åšçš„å°±æ˜¯è¿™ä¸ªè¿‡ç¨‹ï¼Œå¦‚æœå¼€å¤šçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è¦è¿›è¡Œè¿™ä¸ªè¿‡ç¨‹ Cpythonä¸ºä»€ä¹ˆç”¨ä¸äº†å¤šæ ¸ï¼Ÿ cpythonåœ¨æ‰€æœ‰çš„çº¿ç¨‹è¿›å…¥è§£é‡Šå™¨ä¹‹å‰åŠ äº†ä¸€ä¸ªå…¨å±€è§£é‡Šå™¨é”å³GILé”ï¼Œè¿™ä¸ªé”æ˜¯äº’æ–¥é”ï¼Œæ˜¯åŠ åœ¨è§£é‡Šå™¨ä¸Šçš„ï¼Œå¯¼è‡´åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œæ‰€ä»¥ç”¨ä¸äº†å¤šæ ¸ ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ å› ä¸ºå†™pythonçš„äººåªæœ‰ä¸€ä¸ªCPU æ‰€ä»¥åŠ äº†ä¸€ä¸ªé”ï¼Œä¿è¯äº†æ•°æ®çš„å®‰å…¨ï¼Œè€Œä¸”å†å†™pythonè§£é‡Šå™¨æ—¶ï¼Œæ›´åŠ å¥½å†™ ä¸ºä»€ä¹ˆä¸å–æ¶ˆè¿™ä¸ªé”ï¼Ÿ è§£é‡Šå™¨å†…éƒ¨çš„ç®¡ç†å…¨éƒ¨æ˜¯é’ˆå¯¹å•çº¿ç¨‹å†™çš„ï¼Œå¦‚æœè¦å–æ¶ˆé”ï¼Œéœ€è¦é‡æ„pythonè§£é‡Šå™¨ èƒ½ä¸èƒ½ä¸ç”¨Cpythonï¼Ÿ å®˜æ–¹æ¨èä½¿ç”¨Cpythonï¼Œå¤„ç†é€Ÿåº¦å¿«ï¼Œç›¸å¯¹å…¶ä»–è§£é‡Šå™¨æ¯”è¾ƒå®Œå–„ å¤šçº¿ç¨‹æ— æ³•ä½¿ç”¨å¤šæ ¸ï¼Œæ€ä¹ˆåŠï¼Ÿ è™½ç„¶å¤šçº¿ç¨‹æ— æ³•ä½¿ç”¨å¤šæ ¸ï¼Œä½†æ˜¯å¤šè¿›ç¨‹å¯ä»¥åº”ç”¨å¤šæ ¸ï¼Œä½†æ˜¯å¼€é”€å¤§ GILå…¨å±€è§£é‡Šå™¨é”å’Œäº’æ–¥é”çš„åŒºåˆ« é”çš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿æŠ¤å…±äº«çš„æ•°æ®ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«æ•°æ® ä¿æŠ¤ä¸åŒçš„æ•°æ®å°±åº”è¯¥åŠ ä¸åŒçš„é” GILå’Œlockæ˜¯ä¸¤ç§é”ï¼Œä¿æŠ¤çš„æ•°æ®ä¸ä¸€æ ·ï¼ŒGILæ˜¯è§£é‡Šå™¨çº§åˆ«çš„ï¼Œä¿æŠ¤çš„æ˜¯è§£é‡Šå™¨çº§åˆ«çš„æ•°æ®ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çš„æ•°æ®ï¼Œlockäº’æ–¥é”æ˜¯ä¿æŠ¤ç”¨æˆ·è‡ªå·±å¼€å‘çš„åº”ç”¨ç¨‹åºçš„æ•°æ®ï¼ŒGILæ˜¯ä¸ç®¡è¿™æ ·çš„æ•°æ®çš„ ç¤ºæ„å›¾ 1âƒ£ï¸xx.pyæ–‡ä»¶ä¸­æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œç”±äºGILé”çš„å­˜åœ¨å¯¼è‡´åŒæ—¶åªèƒ½æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºå¤šä¸ªçº¿ç¨‹æ“ä½œä¸€ä¸ªèµ„æºä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥åœ¨è§£é‡Šå™¨çº§åˆ«åŠ äº†GILé” 2âƒ£ï¸cpythonè§£é‡Šå™¨ä¸æ”¯æŒåŒæ—¶è§£é‡Šå¤šä¸ªpythonçº¿ç¨‹ï¼ŒåŸå› æ˜¯ä¸ºäº†ä¿è¯è§£é‡Šå™¨çš„å®‰å…¨ï¼Œå› æ­¤ä¸æ”¯æŒå¤šçº¿ç¨‹åŒæ—¶å¹¶å‘ 3âƒ£ï¸GILé”æ˜¯è§£é‡Šå™¨çº§åˆ«çš„é”ï¼Œåªèƒ½ä¿è¯è§£é‡Šå™¨çš„å®‰å…¨ï¼Œä½†æ˜¯æ— æ³•ä¿è¯æ•°æ®å®‰å…¨ï¼Œæˆ‘ä»¬è‡ªå·±åŠ äº’æ–¥é”èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ 5.çº¿ç¨‹å¼‚æ­¥ çº¿ç¨‹å¼‚æ­¥æœ‰å¤šç§æ–¹å¼ 1.æ— éœ€ç­‰å¾…çº¿ç¨‹æ‰§è¡Œ(æ­£å¸¸å†™çš„çº¿ç¨‹æ‰§è¡Œä»£ç å°±æ˜¯å¼‚æ­¥ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨çº¿ç¨‹æ‰§è¡Œï¼Œå¤šä¸ªçº¿ç¨‹æ‰§è¡Œé¡ºåºä¸å›ºå®š) 2.é€šè¿‡å¾ªç¯æ§åˆ¶(æ–¹æ³•low) 3.é€šè¿‡å›è°ƒæœºåˆ¶å®ç°çº¿ç¨‹å¼‚æ­¥ é€šè¿‡å›è°ƒæœºåˆ¶å®ç°çº¿ç¨‹å¼‚æ­¥ from multiprocessing import Pool import random import time def download(name): for i in range(1,6): print(f\"{name}ä¸‹è½½æ–‡ä»¶{i}\") time.sleep(random.randint(1,3)) return \"ä¸‹è½½å®Œæˆ\" def alterUser(msg): print(msg) if __name__ == \"__main__\": p = Pool(3) #å½“funcæ‰§è¡Œå®Œæˆåï¼Œreturnçš„ä¸œè¥¿ä¼šç»™åˆ°å›è°ƒå‡½æ•°callback p.apply_async(func=download,args=(\"çº¿ç¨‹1\",),callback=alterUser) p.apply_async(func=download,args=(\"çº¿ç¨‹2\",),callback=alterUser) p.apply_async(func=download,args=(\"çº¿ç¨‹3\",),callback=alterUser) p.close() #å…³é—­è¿›ç¨‹æ±  p.join() ç»“æœï¼š ç»“æœé¡ºåºæ¯ä¸€æ¬¡æ‰§è¡Œéƒ½ä¼šä¸åŒï¼Œæœ€ç»ˆç»“æœä¸ºæ˜¾ç¤º3æ¬¡ä¸‹è½½å®Œæˆ çº¿ç¨‹1ä¸‹è½½æ–‡ä»¶1 çº¿ç¨‹2ä¸‹è½½æ–‡ä»¶1 çº¿ç¨‹3ä¸‹è½½æ–‡ä»¶1 çº¿ç¨‹1ä¸‹è½½æ–‡ä»¶2 çº¿ç¨‹2ä¸‹è½½æ–‡ä»¶2 çº¿ç¨‹3ä¸‹è½½æ–‡ä»¶2 çº¿ç¨‹3ä¸‹è½½æ–‡ä»¶3 çº¿ç¨‹1ä¸‹è½½æ–‡ä»¶3 çº¿ç¨‹3ä¸‹è½½æ–‡ä»¶4 çº¿ç¨‹2ä¸‹è½½æ–‡ä»¶3 çº¿ç¨‹3ä¸‹è½½æ–‡ä»¶5 çº¿ç¨‹1ä¸‹è½½æ–‡ä»¶4 ä¸‹è½½å®Œæˆ çº¿ç¨‹2ä¸‹è½½æ–‡ä»¶4 çº¿ç¨‹1ä¸‹è½½æ–‡ä»¶5 çº¿ç¨‹2ä¸‹è½½æ–‡ä»¶5 ä¸‹è½½å®Œæˆ ä¸‹è½½å®Œæˆ è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹ä¹‹é—´çš„åŒºåˆ« è¿›ç¨‹ æœ€å°çš„èµ„æºå•ä½ï¼Œå†…å­˜çº§åˆ«ï¼Œå¦‚æœè¿›ç¨‹ä¸­æ²¡æœ‰çº¿ç¨‹åªæ˜¯åˆ’åˆ†äº†ä¸€ä¸ªç©ºé—´ çº¿ç¨‹ æœ€å°çš„è¿è¡Œå•ä½ï¼Œcpuçº§åˆ«ï¼Œè¿›ç¨‹åœ¨æ‰§è¡Œï¼Œå®é™…ä¸Šæ˜¯çº¿ç¨‹åœ¨æ‰§è¡Œ åç¨‹ å¾®çº¿ç¨‹ ç”¨æˆ·çº§åˆ« æ“ä½œç³»ç»Ÿä¸çŸ¥é“ä»€ä¹ˆæ˜¯åç¨‹ï¼Œæ˜¯ç¨‹åºå‘˜yyå‡ºæ¥çš„ï¼Œæ¬ºéª—æ“ä½œç³»ç»Ÿï¼Œå› ä¸ºæœ‰IOæ“ä½œï¼Œæ“ä½œç³»ç»Ÿä¼šå›æ”¶æƒé™ï¼Œåç¨‹å°±æ˜¯åœ¨ç”¨æˆ·çº§åˆ«å°†å¤šä¸ªä»»åŠ¡åšæˆä¸€ä¸ªä»»åŠ¡ï¼Œä½†å‡¡æœ‰ä¸€ä¸ªçº¿ç¨‹æœ‰IOï¼Œæ‰‹åŠ¨åˆ‡æ¢ï¼Œè®©çº¿ç¨‹èƒ½è·å¾—æ›´å¤§å ç”¨ç³»ç»Ÿèµ„æºçš„æœºä¼šï¼Œæé«˜å•çº¿ç¨‹æ•ˆç‡ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/25.3pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šåç¨‹.html":{"url":"python/pythonåŸºç¡€/25.3pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šåç¨‹.html","title":"å¹¶å‘ç¼–ç¨‹-å¤šåç¨‹","keywords":"","body":"pythonåŸºç¡€äºŒåäº” å¹¶å‘ç¼–ç¨‹-å¤šåç¨‹ 1.åç¨‹ 1.1æ¦‚å¿µ åç¨‹æ˜¯æ¯”çº¿ç¨‹æ›´å°çš„æ‰§è¡Œå•å…ƒï¼Œä¹Ÿå«å¾®çº¿ç¨‹ ä¸€ä¸ªçº¿ç¨‹ä½œä¸ºä¸€ä¸ªå®¹å™¨é‡Œé¢å¯ä»¥æ”¾ç½®å¤šä¸ªåç¨‹ 1.2åç¨‹ä½œç”¨ åªåˆ‡æ¢å‡½æ•°è°ƒç”¨å³å¯å®Œæˆå¤šçº¿ç¨‹ï¼Œå¯ä»¥å‡å°‘CPUçš„åˆ‡æ¢ åç¨‹è‡ªå·±ä¸»åŠ¨è®©å‡ºCPUï¼Œä¸éœ€è¦ç³»ç»Ÿè°ƒç”¨ 1.3åç¨‹å®ç° 1.3.1 greenlet(ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œæ‰‹åŠ¨åˆ‡æ¢å‡½æ•°æ‰§è¡Œ) #åç¨‹é—´æ¥å›åˆ‡æ¢ï¼Œä¸éœ€è¦CPUçš„è°ƒç”¨ #éœ€è¦å…ˆå®‰è£…greenlet pip install greenlet from greenlet import greenlet import time def t1(): while True: print(\"AAA\") #ç¬¬ä¸€æ­¥å…ˆæ‰“å°AAA gr2.switch() #ç¬¬äºŒæ­¥è®©åç¨‹gr2è¿›æ¥æ‰§è¡Œï¼Œgr1ä¿ç•™æ­¤å¤„çš„æ‰§è¡Œä½ç½®ï¼Œåç¨‹gr2æ‰§è¡Œçš„æ˜¯t2å‡½æ•° time.sleep(1) def t2(): while True: print(\"bbb\") #ç¬¬ä¸‰æ­¥æ‰“å°bbb gr1.switch() #ç¬¬å››æ­¥è®©åç¨‹gr1è¿›æ¥æ‰§è¡Œï¼Œgr2ä¿ç•™æ­¤å¤„çš„æ‰§è¡Œä½ç½®ï¼Œåç¨‹gr1æ‰§è¡Œçš„æ˜¯t1å‡½æ•° time.sleep(1) gr1 = greenlet(t1) #åˆ›å»ºä¸€ä¸ªåç¨‹å¯¹è±¡ gr2 = greenlet(t2) gr1.switch() #æ­¤æ—¶ä¼šæ‰§è¡Œt1å‡½æ•° ç»“æœï¼š å¾ªç¯æ‰“å° AAA bbb 1.3.2 gevent(ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œè‡ªåŠ¨åˆ‡æ¢å‡½æ•°æ‰§è¡Œ) æ¦‚å¿µ geventæ˜¯ä¸€ä¸ªèƒ½å¤Ÿè‡ªåŠ¨åˆ‡æ¢å‡½æ•°æ‰§è¡Œçš„åç¨‹æ¨¡å—ï¼Œæ¯”greenletåŠŸèƒ½å¼ºå¤§ åŸç† geventé€šè¿‡greenletå®ç°åç¨‹ï¼Œå½“ä¸€ä¸ªgreenleté‡åˆ°IOæ“ä½œæ—¶ï¼Œå°±è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–çš„greenletï¼Œç­‰å¾…IOæ“ä½œå®Œæˆï¼Œå†åœ¨é€‚å½“çš„æ—¶å€™åˆ‡æ¢å›æ¥ç»§ç»­æ‰§è¡Œ ç‰¹ç‚¹ geventåªæœ‰é‡åˆ°æ¨¡å—èƒ½å¤Ÿè¯†åˆ«çš„IOæ“ä½œçš„æ—¶å€™ï¼Œç¨‹åºæ‰ä¼šè¿›è¡Œä»»åŠ¡åˆ‡æ¢ï¼Œå®ç°å¹¶å‘æ•ˆæœ #éœ€è¦å…ˆå®‰è£…gevent pip install gevent //ä»£ç ç¤ºä¾‹1 æ— é™å¾ªç¯åˆ‡æ¢åç¨‹ import gevent def A(): while True: print(\".........A.........\") gevent.sleep(1)#ç”¨æ¥æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶æ“ä½œ #geventä¸­ï¼šå½“ä¸€ä¸ªåç¨‹é‡åˆ°è€—æ—¶æ“ä½œä¼šè‡ªåŠ¨äº¤å‡ºæ§åˆ¶æƒç»™å…¶ä»–åç¨‹ def B(): while True: print(\".........B.........\") gevent.sleep(1) #æ¯å½“é‡åˆ°è€—æ—¶æ“ä½œï¼Œä¼šè‡ªç”¨è½¬åˆ°å…¶ä»–åç¨‹ g1 = gevent.spawn(A) #åˆ›å»ºä¸€ä¸ªgeventå¯¹è±¡ï¼ˆåˆ›å»ºäº†ä¸€ä¸ªåç¨‹ï¼‰ï¼Œæ­¤æ—¶å°±å·²ç»å¼€å§‹æ‰§è¡Œå‡½æ•°A g2 = gevent.spawn(B) g1.join() #ç­‰å¾…åç¨‹æ‰§è¡Œç»“æŸ g2.join() #ä¼šç­‰å¾…åç¨‹è¿è¡Œç»“æŸåå†é€€å‡º ç»“æœï¼š æ— é™å¾ªç¯æ‰“å° .........A......... .........B......... ã€‚ã€‚ã€‚ //ä»£ç ç¤ºä¾‹2 æ§åˆ¶åç¨‹å¾ªç¯æ¬¡æ•° import gevent def A(): for i in range(10): print(\"AAA\") gevent.sleep(1) def B(): for i in range(10): print(\"BBB\") gevent.sleep(1) g1 = gevent.spawn(A) g2 = gevent.spawn(B) g1.join() g2.join() ç»“æœï¼š æ‰“å°10æ¬¡ AAA BBB è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹ä¹‹é—´çš„åŒºåˆ« è¿›ç¨‹ æœ€å°çš„èµ„æºå•ä½ï¼Œå†…å­˜çº§åˆ«ï¼Œå¦‚æœè¿›ç¨‹ä¸­æ²¡æœ‰çº¿ç¨‹åªæ˜¯åˆ’åˆ†äº†ä¸€ä¸ªç©ºé—´ çº¿ç¨‹ æœ€å°çš„è¿è¡Œå•ä½ï¼Œcpuçº§åˆ«ï¼Œè¿›ç¨‹åœ¨æ‰§è¡Œï¼Œå®é™…ä¸Šæ˜¯çº¿ç¨‹åœ¨æ‰§è¡Œ åç¨‹ å¾®çº¿ç¨‹ ç”¨æˆ·çº§åˆ« æ“ä½œç³»ç»Ÿä¸çŸ¥é“ä»€ä¹ˆæ˜¯åç¨‹ï¼Œæ˜¯ç¨‹åºå‘˜yyå‡ºæ¥çš„ï¼Œæ¬ºéª—æ“ä½œç³»ç»Ÿï¼Œå› ä¸ºæœ‰IOæ“ä½œï¼Œæ“ä½œç³»ç»Ÿä¼šå›æ”¶æƒé™ï¼Œåç¨‹å°±æ˜¯åœ¨ç”¨æˆ·çº§åˆ«å°†å¤šä¸ªä»»åŠ¡åšæˆä¸€ä¸ªä»»åŠ¡ï¼Œä½†å‡¡æœ‰ä¸€ä¸ªçº¿ç¨‹æœ‰IOï¼Œæ‰‹åŠ¨åˆ‡æ¢ï¼Œè®©çº¿ç¨‹èƒ½è·å¾—æ›´å¤§å ç”¨ç³»ç»Ÿèµ„æºçš„æœºä¼šï¼Œæé«˜å•çº¿ç¨‹æ•ˆç‡ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/26.1pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-ç½‘ç»œåŸºç¡€çŸ¥è¯†.html":{"url":"python/pythonåŸºç¡€/26.1pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-ç½‘ç»œåŸºç¡€çŸ¥è¯†.html","title":"ç½‘ç»œç¼–ç¨‹-è®¡ç®—æœºç½‘ç»œåŸºç¡€","keywords":"","body":"pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-ç½‘ç»œåŸºç¡€çŸ¥è¯† 1.ç½‘ç»œåŸºç¡€ä¸­æ¶‰åŠåˆ°çš„å‡ ç§æ¦‚å¿µ 1.1IPåœ°å€ 1.1.1æ¦‚å¿µ IPåœ°å€æ˜¯ç”¨æ¥åœ¨ç½‘ç»œä¸­æ ‡è®°ä¸€å°ç”µè„‘çš„ä¸€ä¸²æ•°å­—ï¼Œåœ¨ç½‘ç»œä¸Šæ˜¯å”¯ä¸€çš„ IPåœ°å€åˆ†ç±»ç§ç½‘IPåœ°å€å’Œå…¬ç½‘IPåœ°å€ 1.1.2æ ¼å¼è¯´æ˜ æ¯ä¸€ä¸ªIPåœ°å€åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šç½‘ç»œåœ°å€å’Œä¸»æœºåœ°å€ Aç±»IPåœ°å€ç”±1å­—èŠ‚çš„â½¹ç»œåœ°å€å’Œ3å­—èŠ‚ä¸»æœºåœ°å€ç»„æˆï¼Œ â½¹ç»œåœ°å€çš„æœ€â¾¼ä½å¿…é¡»æ˜¯â€œ0â€ï¼Œåœ°å€èŒƒå›´1.0.0.1-126.255.255.254å¯â½¤çš„Aç±»â½¹ç»œæœ‰126ä¸ªï¼Œ æ¯ä¸ªâ½¹ç»œèƒ½å®¹çº³1677214ä¸ªä¸»æœº Bç±»IPåœ°å€ç”±2ä¸ªå­—èŠ‚çš„â½¹ç»œåœ°å€å’Œ2ä¸ªå­—èŠ‚çš„ä¸»æœºåœ°å€ç»„æˆï¼Œ â½¹ç»œåœ°å€çš„æœ€â¾¼ä½å¿…é¡»æ˜¯â€œ10â€ï¼Œåœ°å€èŒƒå›´128.1.0.1-191.255.255.254 å¯â½¤çš„Bç±»â½¹ç»œæœ‰16384ä¸ªï¼Œ æ¯ä¸ªâ½¹ç»œèƒ½å®¹çº³65534ä¸»æœº Cç±»IPåœ°å€ç”±3å­—èŠ‚çš„â½¹ç»œåœ°å€å’Œ1å­—èŠ‚çš„ä¸»æœºåœ°å€ç»„æˆï¼Œ â½¹ç»œåœ°å€çš„æœ€â¾¼ä½å¿…é¡»æ˜¯â€œ110â€èŒƒå›´192.0.1.1-223.255.255.254 Cç±»â½¹ç»œå¯è¾¾2097152ä¸ªï¼Œ æ¯ä¸ªâ½¹ç»œèƒ½å®¹çº³254ä¸ªä¸»æœº Dç±»IPåœ°å€ç¬¬â¼€ä¸ªå­—èŠ‚ä»¥â€œ1110â€å¼€å§‹ï¼Œ å®ƒæ˜¯â¼€ä¸ªä¸“â»”ä¿ç•™çš„åœ°å€ã€‚å®ƒå¹¶ä¸æŒ‡å‘ç‰¹å®šçš„â½¹ç»œï¼Œ â½¬å‰è¿™â¼€ç±»åœ°å€è¢«â½¤åœ¨å¤šç‚¹â¼´æ’­ï¼ˆä¸€å¯¹å¤šï¼‰ ä¸­å¤šç‚¹â¼´æ’­åœ°å€â½¤æ¥â¼€æ¬¡å¯»å€â¼€ç»„è®¡ç®—æœº åœ°å€èŒƒå›´224.0.0.1-239.255.255.254 Eç±»IPåœ°å€ä»¥â€œ1111â€å¼€å§‹ï¼Œä¸ºå°†æ¥ä¿ç•™ä½¿ç”¨ï¼Œä»…åšå®éªŒå’Œå¼€å‘ç”¨ 1.1.3ç§æœ‰IPåœ°å€ 1.1.3.1å«ä¹‰ ç§æœ‰IPï¼šæœ¬åœ°å±€åŸŸç½‘çš„IPï¼Œä¸“é—¨ä¸ºç»„ç»‡æœºæ„å†…éƒ¨ä½¿ç”¨ åœ¨è¿™ä¹ˆå¤šç½‘ç»œIPä¸­ï¼Œå›½é™…è§„å®šæœ‰ä¸€éƒ¨åˆ†çš„Ipåœ°å€æ˜¯ç”¨äºæˆ‘ä»¬çš„å±€åŸŸç½‘ä½¿ç”¨ï¼Œå±äºç§ç½‘IP 1.1.3.2èŒƒå›´ Aç±» 10.0.0.0 ï½ 10.255.255.255 Bç±» 172.16.0.0 ï½ 172.31.0.0 Cç±» 192.168.0.0 ï½ 192.168.255.255 1.1.4å›ç¯åœ°å€ 127.0.0.1 ä½œç”¨ æµ‹è¯•å½“å‰è®¡ç®—æœºçš„ç½‘ç»œé€šä¿¡åè®®ï¼Œ127.0.0.1å¯ä»¥ä»£è¡¨æœ¬æœº ç”¨æ¥æ£€æµ‹æœ¬æœºç½‘ç»œé—®é¢˜ï¼Œping 127.0.0.1å³å¯æ£€æµ‹ 1.1.5å­ç½‘æ©ç  1.1.5.1æ¦‚å¿µ å­ç½‘æ©ç æ˜¯åœ¨IPv4åœ°å€èµ„æºç´§ç¼ºçš„èƒŒæ™¯ä¸‹ä¸ºäº†è§£å†³lPåœ°å€åˆ†é…è€Œäº§ç”Ÿçš„è™šæ‹ŸlPæŠ€æœ¯ï¼Œé€šè¿‡å­ç½‘æ©ç å°†Aã€Bã€Cä¸‰ç±»åœ°å€åˆ’åˆ†ä¸ºè‹¥å¹²å­ç½‘ï¼Œä»è€Œæ˜¾è‘—æé«˜äº†IPåœ°å€çš„åˆ†é…æ•ˆç‡ï¼Œæœ‰æ•ˆè§£å†³äº†IPåœ°å€èµ„æºç´§å¼ çš„å±€é¢ã€‚å¦ä¸€æ–¹é¢ï¼Œåœ¨ä¼ä¸šå†…ç½‘ä¸­ä¸ºäº†æ›´å¥½åœ°ç®¡ç†ç½‘ç»œï¼Œç½‘ç®¡äººå‘˜ä¹Ÿåˆ©ç”¨å­ç½‘æ©ç çš„ä½œç”¨ï¼Œäººä¸ºåœ°å°†ä¸€ä¸ªè¾ƒå¤§çš„ä¼ä¸šå†…éƒ¨ç½‘ç»œåˆ’åˆ†ä¸ºæ›´å¤šä¸ªå°è§„æ¨¡çš„å­ç½‘ï¼Œå†åˆ©ç”¨ä¸‰å±‚äº¤æ¢æœºçš„è·¯ç”±åŠŸèƒ½å®ç°å­ç½‘äº’è”ï¼Œä»è€Œæœ‰æ•ˆè§£å†³äº†ç½‘ç»œå¹¿æ’­é£æš´å’Œç½‘ç»œç—…æ¯’ç­‰è¯¸å¤šç½‘ç»œç®¡ç†æ–¹é¢çš„é—®é¢˜ã€‚ 1.1.5.2é»˜è®¤å­ç½‘æ©ç  ç±»åˆ« å­ç½‘æ©ç çš„äºŒè¿›åˆ¶æ•°å€¼ å­ç½‘æ©ç çš„åè¿›åˆ¶æ•°å€¼ A 11111111 00000000 00000000 00000000 255.0.0.0 B 11111111 11111111 00000000 00000000 255.255.0.0 C 11111111 11111111 11111111 000000000 255.255.255.0 1.1.5.3å­ç½‘æ©ç åŠŸèƒ½ å­ç½‘æ©ç æ˜¯ä¸€ä¸ª32ä½åœ°å€ï¼Œæ˜¯ä¸IPåœ°å€ç»“åˆä½¿ç”¨çš„ä¸€ç§æŠ€æœ¯ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æœ‰ä¸¤ä¸ª ä¸€æ˜¯ç”¨äºå±è”½IPåœ°å€çš„ä¸€éƒ¨åˆ†ä»¥åŒºåˆ«ç½‘ç»œæ ‡è¯†å’Œä¸»æœºæ ‡è¯†ï¼Œå¹¶è¯´æ˜è¯¥IPåœ°å€æ˜¯åœ¨å±€åŸŸç½‘ä¸Šï¼Œè¿˜æ˜¯åœ¨è¿œç¨‹ç½‘ä¸Š äºŒæ˜¯ç”¨äºå°†ä¸€ä¸ªå¤§çš„IPç½‘ç»œåˆ’åˆ†ä¸ºè‹¥å¹²å°çš„å­ç½‘ç»œã€‚ 1.2ç½‘ç»œç«¯å£å· 1.2.1æ¦‚å¿µåŠä½œç”¨ ç«¯å£å·æ˜¯ç½‘ç»œä¸­é€šè¿‡IPåœ°å€+ç«¯å£å·åŒºåˆ†ä¸åŒçš„æœåŠ¡ 1.2.2èŒƒå›´åŠåˆ†ç±» ç«¯å£å·æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œåªæœ‰æ•´æ•°ï¼ŒèŒƒå›´æ˜¯ä»0åˆ°65535(åˆ†ä¸ºçŸ¥åå’ŒåŠ¨æ€ä¸¤ç§) çŸ¥åç«¯å£æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ç«¯å£å·ï¼Œç”¨æ¥åšå›ºå®šçš„äº‹æƒ…ï¼ŒèŒƒå›´æ˜¯ä»0åˆ°1023 80ç«¯å£åˆ†é…ç»™httpæœåŠ¡ 21ç«¯å£åˆ†é…ç»™ftpæœåŠ¡ åŠ¨æ€ç«¯å£æ˜¯ä¸€èˆ¬ä¸å›ºå®šåˆ†é…æŸç§æœåŠ¡ï¼Œè€Œæ˜¯åŠ¨æ€åˆ†é…ï¼ŒåŠ¨æ€åˆ†é…æ˜¯æŒ‡å½“ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹æˆ–åº”ç”¨ç¨‹åºè¿›ç¨‹éœ€è¦ç½‘ç»œé€šä¿¡æ˜¯ï¼Œå®ƒå‘ä¸»æœºç”³è¯·ä¸€ä¸ªç«¯å£ï¼Œä¸»æœºä»å¯ç”¨çš„ç«¯å£å·ä¸­åˆ†é…ä¸€ä¸ªä¾›å®ƒä½¿ç”¨ 1.3ç½‘ç»œåè®® 1.3.1æ¦‚å¿µ åè®®ï¼šçº¦å®šå¥½çš„è§„èŒƒ æ—©æœŸçš„è®¡ç®—æœºâ½¹ç»œï¼Œ éƒ½æ˜¯ç”±å„â¼šå•†â¾ƒâ¼°è§„å®šâ¼€å¥—åè®®ï¼Œ IBMã€Appleå’Œ Microsoftéƒ½æœ‰å„â¾ƒçš„â½¹ç»œåè®®ï¼Œ äº’ä¸å…¼å®¹ï¼ˆè¯­è¨€ã€æ–¹è¨€ã€é˜¿å¸•ç½‘ï¼‰ ä¸ºäº†æŠŠå…¨ä¸–ç•Œçš„æ‰€æœ‰ä¸åŒç±»å‹çš„è®¡ç®—æœºéƒ½è¿æ¥èµ·æ¥ï¼Œ å°±å¿…é¡»è§„å®šâ¼€å¥—å…¨çƒé€šâ½¤çš„åè®®ï¼Œ ä¸ºäº†å®ç°äº’è”â½¹è¿™ä¸ªâ½¬æ ‡ï¼Œäº’è”â½¹åè®®ç°‡ï¼ˆInternet Protocol Suiteï¼‰å°±æ˜¯é€šâ½¤åè®®æ ‡å‡†ã€‚ å› ä¸ºäº’è”â½¹åè®®åŒ…å«äº†ä¸Šç™¾ç§åè®®æ ‡å‡†ï¼Œä½†æ˜¯æœ€é‡è¦çš„ä¸¤ä¸ªåè®®æ˜¯TCPå’ŒIPåè®®ï¼Œæ‰€ä»¥ï¼Œâ¼¤å®¶æŠŠäº’è”â½¹çš„åè®®æ€»ç§°TCP/IPåè®® 1.3.2TCP/IPæ¨¡å‹ TCP/IPå®šä¹‰äº†ç”µå­è®¾å¤‡å¦‚ä½•è¿å…¥å› ç‰¹ç½‘ï¼Œä»¥åŠæ•°æ®å¦‚ä½•åœ¨å®ƒä»¬ä¹‹é—´ä¼ è¾“çš„æ ‡å‡† 4å±‚çš„å±‚çº§ç»“æ„ä¸­ï¼Œæ¯ä¸€å±‚éƒ½å‘¼å«å®ƒçš„ä¸‹ä¸€å±‚æ‰€æä¾›çš„ç½‘ç»œæ¥å®Œæˆè‡ªå·±çš„éœ€æ±‚ å…¶ä¸­çš„åº”ç”¨å±‚å…³æ³¨çš„æ˜¯åº”ç”¨ç¨‹åºçš„ç»†èŠ‚ï¼Œè€Œä¸æ˜¯æ•°æ®åœ¨ç½‘ç»œä¸­çš„ä¼ è¾“æ´»åŠ¨ å…¶ä»–ä¸‰å±‚ä¸»è¦å¤„ç†æ‰€æœ‰çš„é€šä¿¡ç»†èŠ‚ï¼Œå¯¹åº”ç”¨ç¨‹åºä¸€æ— æ‰€çŸ¥ï¼› åº”ç”¨å±‚ï¼šåº”ç”¨ç¨‹åºé—´æ²Ÿé€šçš„å±‚ï¼Œä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿæœ‰ä¸åŒçš„æ–‡ä»¶å‘½ååŸåˆ™å’Œä¸åŒçš„æ–‡æœ¬è¡Œè¡¨ç¤ºæ–¹æ³•ç­‰ï¼Œä¸åŒçš„ç³»ç»Ÿä¹‹é—´ä¼ è¾“æ–‡ä»¶è¿˜æœ‰å„ç§ä¸å…¼å®¹é—®é¢˜ï¼Œè¿™äº›éƒ½å°†ç”±åº”ç”¨å±‚æ¥å¤„ç† ä¼ è¾“å±‚ï¼šåœ¨æ­¤å±‚ä¸­ï¼Œå®ƒæä¾›äº†èŠ‚ç‚¹é—´çš„æ•°æ®ä¼ é€æœåŠ¡ï¼Œå¦‚ä¼ è¾“æ§åˆ¶åè®®ï¼ˆTCPï¼‰ã€ç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼ˆUDPï¼‰ç­‰ï¼Œè¿™ä¸€å±‚è´Ÿè´£ä¼ é€æ•°æ®ï¼Œå¹¶ä¸”ç¡®å®šæ•°æ®å·²è¢«é€è¾¾å¹¶æ¥æ”¶ ç½‘ç»œå±‚ï¼šè´Ÿè´£æä¾›åŸºæœ¬çš„æ•°æ®åŒ…ä¼ é€åŠŸèƒ½ï¼Œè®©æ¯ä¸€å—æ•°æ®åŒ…éƒ½èƒ½å¤Ÿåˆ°è¾¾ç›®çš„ä¸»æœºã€‚ç½‘ç»œå±‚æ¥æ”¶ç”±æ›´ä½å±‚å‘æ¥çš„æ•°æ®åŒ…ï¼Œå¹¶æŠŠè¯¥æ•°æ®åŒ…å‘é€åˆ°æ›´é«˜å±‚ï¼Œç›¸åï¼ŒIPå±‚ä¹ŸæŠŠä»TCPæˆ–UDPå±‚æ¥æ”¶æ¥çš„æ•°æ®åŒ…ä¼ é€åˆ°æ›´ä½å±‚ ç½‘ç»œæ¥å£å±‚ï¼šå¯¹å®é™…çš„ç½‘ç»œåª’ä½“çš„ç®¡ç†ï¼Œå®šä¹‰å¦‚ä½•ä½¿ç”¨å®é™…ç½‘ç»œæ¥ä¼ é€æ•°æ®ï¼ˆå¤„ç†æœºæ¢°çš„ã€ç”µæ°”çš„å’Œè¿‡ç¨‹çš„æ¥å£ï¼‰ ç¤ºæ„å›¾ TCP/IPåè®®ç°‡ä¸­å„åè®®ä¹‹é—´çš„å…³ç³» 1.3.3OSIä¸ƒå±‚æ¨¡å‹ OSIä¸ƒå±‚æ¨¡å‹ç¤ºæ„å›¾ ç‰©ç†å±‚ï¼š ç½‘çº¿è¿æ¥åœ¨å®¢æˆ·ç«¯è®¡ç®—æœºä¸Šï¼Œå…¶å®æ˜¯è¿æ¥åœ¨äº†è®¡ç®—æœºçš„ä¸€ä¸ªå«åšç½‘å¡çš„è®¾å¤‡ä¸Šï¼Œç½‘å¡æ˜¯ä¸“é—¨è´Ÿè´£ä¸å¤–ç•Œé€šä¿¡çš„ã€‚ç½‘çº¿ä¸€èˆ¬æ˜¯åŒç»çº¿æˆ–è€…å…‰ç¼†ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ— çº¿ç”µæ³¢ï¼Œä¸­é—´ç»è¿‡äº¤æ¢æœºï¼Œè·¯ç”±å™¨ï¼Œé˜²ç«å¢™ç­‰ç­‰ä¸€å †è®¾å¤‡ç»Ÿç§°ä¸ºç‰©ç†è¿æ¥ä»‹è´¨ï¼Œå¯ä»¥ç†è§£ä¸ºç»è¿‡äº’è”ç½‘ï¼Œå†è¿æ¥åˆ°æœåŠ¡ç«¯è®¾å¤‡ã€‚é¦–å…ˆå·¥ä½œçš„æ˜¯ç‰©ç†å±‚ï¼Œå‘é€ç”µä¿¡å· æ•°æ®é“¾è·¯å±‚ï¼š ç”µä¿¡å·åˆ†ä¸ºä¸¤ç§ï¼Œé«˜ç”µå¹³å’Œä½ç”µå¹³ï¼Œé«˜ç”µå¹³å¯ä»¥è¢«äººå®šä¹‰æˆæ•°å­— 1ï¼Œä½ç”µå¹³å¯ä»¥è¢«äººå®šä¹‰æˆæ•°å­— 0ã€‚å‡å¦‚æˆ‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª 0010101100ï¼ŒæœåŠ¡ç«¯ç›¸åº”çš„å°±ä¼šæ”¶åˆ°è¿™äº›æ•°å­—ã€‚ä½†æ˜¯å•çº¯çš„ä¸€æ®µäºŒè¿›åˆ¶æ•°å­—è¿™æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä¸€å®šè¦æ˜ç¡®ï¼Œä»å“ªé‡Œå¼€å§‹åˆ°å“ªé‡Œç»“æŸè¿™è¡¨ç¤ºä¸€æ®µå†…å®¹ï¼Œä»å“ªé‡Œå¼€å§‹åˆ°å“ªé‡Œç»“æŸè¿™åˆè¡¨ç¤ºå¦å¤–ä¸€æ®µå†…å®¹ã€‚è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦ç»™è¿™äº›äºŒè¿›åˆ¶æ•°å­—è¿›è¡Œåˆ†ç»„ ä»¥å¤ªç½‘åè®®è§„å®šï¼š ä¸€ç»„ç”µä¿¡å·æ„æˆä¸€ä¸ªæ•°æ®æŠ¥ï¼Œå«åšâ€˜å¸§â€™ æ¯ä¸€æ•°æ®å¸§åˆ†æˆï¼šæŠ¥å¤´headå’Œæ•°æ®dataä¸¤éƒ¨åˆ† è¿™ä¸€ç‚¹å’Œæˆ‘ä»¬å†™ä¿¡ç±»ä¼¼ï¼Œæœ‰ä¿¡å°ï¼Œæœ‰ä¿¡çš„å†…å®¹ï¼Œä¿¡å°ä¸Šé¢ä¼šå†™æ˜è¿™å°ä¿¡çš„å‘é€è€…æ¥å—è€…åˆ†åˆ«æ˜¯è°ï¼Œ ä¿¡é‡Œé¢çš„ä¿¡çº¸ä¸Šå†™çš„å°±æ˜¯ä¿¡çš„å†…å®¹ã€‚ headåŒ…å«ï¼š(å›ºå®š18ä¸ªå­—èŠ‚) å‘é€è€…ï¼æºåœ°å€ï¼Œ6ä¸ªå­—èŠ‚ æ¥æ”¶è€…ï¼ç›®æ ‡åœ°å€ï¼Œ6ä¸ªå­—èŠ‚ æ•°æ®ç±»å‹ï¼Œ6ä¸ªå­—èŠ‚ dataåŒ…å«ï¼š(æœ€çŸ­46å­—èŠ‚ï¼Œæœ€é•¿1500å­—èŠ‚) æ³¨æ„ï¼šå¤´å›ºå®šé•¿åº¦18ä¸ªå­—èŠ‚ï¼Œä¹Ÿåªæœ‰å›ºå®šé•¿åº¦ï¼Œæ¥æ”¶è€…æ‰çŸ¥é“æŒ‰ç…§ä»€ä¹ˆæ ‡å‡†æ¥è¯»å– æ•°æ®æŠ¥çš„å…·ä½“å†…å®¹ headé•¿åº¦ï¼‹dataé•¿åº¦ï¼æœ€çŸ­64å­—èŠ‚ï¼Œæœ€é•¿1518å­—èŠ‚ï¼Œè¶…è¿‡æœ€å¤§é™åˆ¶å°±åˆ†ç‰‡å‘é€ ä»¥å¤ªç½‘è§„å®šheadé‡Œé¢è¦æœ‰å‘é€è€…çš„æºåœ°å€å’Œæ¥å—è€…çš„ç›®æ ‡åœ°å€ï¼Œæºåœ°å€å¯ä»¥ç†è§£ä¸ºæ˜¯å‘é€è€…çš„å®¶ï¼Œç›®æ ‡åœ°å€å°±æ˜¯æ¥æ”¶è€…çš„å®¶ã€‚é‚£ä¹ˆï¼Œåœ¨è®¡ç®—æœºä¸­å¦‚ä½•æ ‡è¯†å®¶åœ¨å“ªé‡Œï¼Ÿ ä½¿ç”¨macåœ°å€ï¼Œæ³¨æ„è¿™ä¸ªmacåœ°å€ä¸æ˜¯ä½ ç”¨çš„è‹¹æœç”µè„‘é‚£ä¸ªmacï¼Œåªæ˜¯å·§åˆåŒåäº†ã€‚MACåœ°å€ï¼ˆMedia Access Control Addressï¼‰ï¼Œç›´è¯‘ä¸ºåª’ä½“è®¿é—®æ§åˆ¶åœ°å€ï¼Œä¹Ÿç§°ä¸ºå±€åŸŸç½‘åœ°å€ï¼ˆLAN Addressï¼‰ï¼Œä»¥å¤ªç½‘åœ°å€ï¼ˆEthernet Addressï¼‰æˆ–ç‰©ç†åœ°å€ï¼ˆPhysical Addressï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨æ¥ç¡®è®¤ç½‘ä¸Šè®¾å¤‡ä½ç½®çš„åœ°å€ã€‚ macåœ°å€æ˜¯è®¡ç®—æœºä¸Šä¸€ä¸ªå”¯ä¸€çš„åœ°å€ï¼Œæ˜¯åœ¨è®¡ç®—æœºçš„ç½‘å¡ä¸Šçš„ï¼Œæ¯å—ç½‘å¡å‡ºå‚æ—¶éƒ½è¢«çƒ§åˆ¶ä¸Šä¸€ä¸ª ä¸–ç•Œå”¯ä¸€çš„macåœ°å€ï¼Œé•¿åº¦ä¸º48ä½2è¿›åˆ¶ï¼Œé€šå¸¸ç”±12ä½16è¿›åˆ¶æ•°è¡¨ç¤ºï¼ˆå‰å…­ä½æ˜¯å‚å•†ç¼–å·ï¼Œåå…­ä½æ˜¯æµæ°´çº¿å·ï¼‰ è¿™æ ·åšçš„ç›®çš„å°±æ˜¯è¦ä¿è¯æ¯ä¸€ä¸ªmacåœ°å€æ˜¯å…¨ä¸–ç•Œç‹¬ä¸€æ— äºŒçš„ ç½‘ç»œå±‚ï¼š ç½‘ç»œå±‚æœ‰ä¸€ä¸ªIPåè®®ï¼Œæˆ‘ä»¬å¸¸è¯´çš„IPV4å°±æ˜¯IPåè®®çš„ç¬¬å››ä¸ªç‰ˆæœ¬ï¼ŒIPV6å°±æ˜¯IPåè®®çš„ç¬¬å…­ä¸ªç‰ˆæœ¬ ä¼ è¾“å±‚ï¼š ä¼ è¾“å±‚æœ‰ä¸€ä¸ªTCPåè®®å’ŒUDPåè®®ï¼Œè¿™ä¸¤ä¸ªåè®®éƒ½æ˜¯åŸºäºç«¯å£å·¥ä½œçš„åè®® ä¼šè¯å±‚ï¼šè´Ÿè´£æ–‡ä»¶å‘é€/æ¥æ”¶ è¡¨ç¤ºå±‚ï¼šè´Ÿè´£æ•°æ®å‹ç¼©ã€ç¼–ç  åº”ç”¨å±‚ï¼š åº”ç”¨å±‚å°±æ˜¯åº”ç”¨è½¯ä»¶ï¼Œåº”ç”¨è½¯ä»¶æ˜¯ä½ å†™çš„ï¼Œè¿™ä¸ªæ ‡å‡†å¯ä»¥ç”±ä½ æ¥å®šï¼Œå½“ç„¶äº†ä½ ä¹Ÿå¯ä»¥éµå¾ªä¸€äº›å¤§å®¶å·²ç»å®šåˆ¶å¥½äº†çš„åº”ç”¨å±‚åè®®çš„æ ‡å‡†ï¼Œå¸¸è§çš„æœ‰ httpï¼Œmailï¼Œftp å‘é€è¿‡ç¨‹ï¼š åº”ç”¨å±‚è½¯ä»¶ï¼ˆæœ‰åè®®æˆ–æ— åè®®ï¼‰===>ä¼ è¾“å±‚ï¼ˆTCP/UDPåè®®ï¼‰===>ç½‘ç»œå±‚ï¼ˆipåè®®ï¼‰===>æ•°æ®é“¾è·¯å±‚ï¼ˆä»¥å¤ªç½‘åè®®ï¼‰===>ç‰©ç†å±‚===>ç”µä¿¡å·å‘é€ï¼ˆ100011001010110ï¼‰ æ¥æ”¶è¿‡ç¨‹åˆ™ç›¸å TCP/IPä¸OSIä¸ƒå±‚æ¨¡å‹å¯¹æ¯” æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/26.2pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-udpç¼–ç¨‹.html":{"url":"python/pythonåŸºç¡€/26.2pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-udpç¼–ç¨‹.html","title":"ç½‘ç»œç¼–ç¨‹-UDPç¼–ç¨‹","keywords":"","body":"pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-udpç¼–ç¨‹ 1.Socketç¼–ç¨‹ç®€ä»‹ 1.1å«ä¹‰ socketï¼šå¥—æ¥å­—ï¼Œé€šè¿‡ç½‘è·¯å®Œæˆè¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼(åŒºåˆ«äºä¸€å°è®¡ç®—æœºä¹‹é—´è¿›ç¨‹é€šä¿¡) 1.2è¯´æ˜ socketæœ¬è´¨æ˜¯ç¼–ç¨‹æ¥å£(API) :socketæ˜¯å¯¹TCP/IPåè®®çš„å°è£…ï¼Œsocketåªæ˜¯ä¸ªç¼–ç¨‹æ¥å£ä¸æ˜¯åè®®ï¼Œé€šè¿‡socketæˆ‘ä»¬æ‰èƒ½ä½¿ç”¨TCP/IPåè®®ç°‡ TCP/IPä¹Ÿè¦æä¾›å¯ä¾›ç¨‹åºå‘˜åšç½‘ç»œå¼€å‘æ‰€ç”¨çš„æ¥å£ï¼Œè¿™å°±æ˜¯socketç¼–ç¨‹æ¥å£ï¼Œsocketæä¾›äº†ç½‘ç»œé€šä¿¡çš„èƒ½åŠ› å¥—æ¥å­—ä¹‹é—´çš„è¿æ¥è¿‡ç¨‹å¯åˆ†ä¸º3ä¸ªæ­¥éª¤ï¼š 1.æœåŠ¡å™¨ç›‘å¬ 2.å®¢æˆ·ç«¯è¯·æ±‚ 3.è¿æ¥ç¡®è®¤ 2.åˆ›å»ºsocket è¯­æ³• #å¯¼å…¥å¥—æ¥å­—æ¨¡å— from socket import * #åˆ›å»ºå¥—æ¥å­—å¯¹è±¡ s = socket(socket.AF_NENT,SOCK_DGRAM) å‚æ•°è¯´æ˜ AF_NENT #æŒ‡æ˜IPV4 SOCKET_DGRAM #å¥—æ¥å­—ç±»å‹ï¼ŒSOCKET_DGRAMæ˜¯tcpåè®® SOCKET_STREAM #å¥—æ¥å­—ç±»å‹ï¼ŒSOCKET_STREAMæ˜¯udpåè®® 3.socketç¼–ç¨‹-udp 3.1udpè¯´æ˜ 3.1.1æ¦‚å¿µ UDPï¼šUser Data Protocolï¼Œç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼Œæ˜¯ä¸€ä¸ªæ— è¿æ¥çš„ç®€å•çš„é¢å‘æ•°æ®æŠ¥çš„ä¼ è¾“å±‚åè®®ï¼Œudpä¸æä¾›å¯é æ€§ï¼Œå®ƒåªæ˜¯æŠŠåº”ç”¨å±‚ä¼ ç»™IPå±‚çš„æ•°æ®æŠ¥å‘å‡ºå»ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯å®ƒä»¬èƒ½åˆ°è¾¾ç›®çš„åœ°ï¼Œç”±äºudpåœ¨ä¼ è¾“æ•°æ®æŠ¥å‰ä¸ç”¨åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œä¸”æ²¡æœ‰è¶…æ—¶é‡å‘ç­‰æœºåˆ¶ï¼Œæ•…è€Œä¼ è¾“é€Ÿåº¦å¾ˆå¿«** 3.1.2udpç”¨å¤„ udpä¸€èˆ¬ç”¨äºå¤šç‚¹é€šä¿¡å’Œå®æ—¶çš„æ•°æ®ä¸šåŠ¡ï¼Œæ¯”å¦‚ è¯­éŸ³å¹¿æ’­ è§†é¢‘ QQ TFTP(ç®€å•æ–‡ä»¶ä¼ è¾“) 3.2ä½¿ç”¨udpå‘é€æ•°æ® ç¬¬ä¸€æ­¥ å‘é€æ•°æ®ï¼Œä¸ºçœ‹åˆ°æ•ˆæœå…ˆå®‰è£…ç½‘ç»œè°ƒè¯•åŠ©æ‰‹NetAssist(windowså®‰è£…) NetAssiståˆå§‹é…ç½®ï¼Œåè®®é€‰æ‹©UDPï¼ŒIPåœ°å€ä¼šè‡ªåŠ¨è¯†åˆ«æœ¬æœºåœ°å€ï¼Œç«¯å£å·ä»»æ„é€‰æ‹©ä¸€ä¸ªå¯ä½¿ç”¨çš„ï¼Œé…ç½®å®Œæˆåç‚¹å‡»è¿æ¥æŒ‰é’® from socket import * #AF_INETè¡¨ç¤ºIPV4 SOCK_DGRAMè¡¨ç¤ºudpåè®® s = socket(AF_INET,SOCK_DGRAM) #NetAssistä¸­çš„é»˜è®¤ç¼–ç æ˜¯gb2312ï¼Œè¿™é‡Œéœ€è¦æŒ‡å®šä¸€ä¸‹ï¼Œå¦åˆ™æ˜¾ç¤ºçš„ä¿¡æ¯ä¼šæ˜¯ä¹±ç  s.sendto(\"ä½ å¥½\".encode(\"gb2312\"),(\"192.168.34.90\",8080)) ç¬¬äºŒæ­¥ è¿è¡Œä»¥ä¸Šä»£ç ï¼Œä¼šåœ¨NetAssistä¸­çœ‹åˆ°æ•ˆæœ è¿™é‡Œå¯ä»¥çœ‹åˆ°å‘é€çš„ä½ å¥½å·²ç»åœ¨NetAssistä¸­æ”¶åˆ° 3.3ä½¿ç”¨udpæ¥æ”¶æ•°æ® 3.3.1udpæ¥æ”¶æ•°æ® from socket import * s = socket(AF_INET, SOCK_DGRAM) #åˆ›å»ºå¥—æ¥å­— addr = ('127.0.0.1', 8888) #å‡†å¤‡æ¥æ”¶æ–¹åœ°å€ data = input(\"è¯·è¾“å…¥ï¼š\") s.sendto(data.encode(),addr) #ç­‰å¾…æ¥æ”¶æ•°æ® redata = s.recvfrom(1024) #1024è¡¨ç¤ºæœ¬æ¬¡æ¥æ”¶çš„æœ€å¤§å­—èŠ‚æ•° print(redata) s.close() macå’Œlinuxä¸­è¿è¡Œç¨‹åºï¼Œè¾“å…¥å†…å®¹åç¨‹åºä¼šå¡ä½ï¼ŒåŸå› æœªçŸ¥âš ï¸âš ï¸âš ï¸ windowsä¸­è¿è¡Œç¨‹åºï¼Œè¾“å…¥å†…å®¹åä¼šè¿”å›å¦‚ä¸‹ç»“æœ (b'abc', ('127.0.0.1', 8888)) 3.2.2udpç»‘å®šä¿¡æ¯ bind å¦‚æœä¿¡æ¯(IPåœ°å€ã€ç«¯å£å·)æ²¡æœ‰ç»‘å®šï¼Œæ¯å‘é€ä¸€æ¬¡ä¿¡æ¯ï¼Œç³»ç»Ÿä¼šéšæœºåˆ†é…ä¸€ä¸ªç«¯å£ï¼Œè¿˜è¦é¿å…åŒä¸€å°è®¡ç®—æœºä¸Šçš„ä¸åŒè¿›ç¨‹ç«¯å£å·ç›¸åŒçš„é—®é¢˜ ç»‘å®šä¿¡æ¯ï¼šè®©ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨å›ºå®šçš„ç«¯å£ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå‘é€æ–¹ä¸ç»‘å®šç«¯å£ï¼Œæ¥æ”¶æ–¹ä¼šç»‘å®š from socket import * s = socket(AF_INET, SOCK_DGRAM) #åˆ›å»ºå¥—æ¥å­— s.bind(('', 8788)) #ç»‘å®šæœ¬æœºä¸€ä¸ªç«¯å£ï¼Œipåœ°å€å’Œç«¯â¼å·ï¼Œipâ¼€èˆ¬ä¸â½¤å†™ addr = ('192.168.1.17', 8080) #å‡†å¤‡æ¥æ”¶æ–¹åœ°å€å’Œç«¯å£ data = input(\"è¯·è¾“å…¥ï¼š\") s.sendto(data.encode(),addr) redata = s.recvfrom(1024) #1024è¡¨ç¤ºæœ¬æ¬¡æ¥æ”¶çš„æœ€â¼¤å­—èŠ‚æ•° print(redata) s.close() 3.3.3echoæœåŠ¡å™¨ echoæœåŠ¡å™¨å°±æ˜¯å‘é€ä»€ä¹ˆï¼Œè¿”å›ä»€ä¹ˆ udpæ¥æ”¶ä½¿ç”¨recvfromæ–¹æ³• from socket import * s = socket(AF_INET,SOCK_DGRAM) port = 8888 s.bind((\"\",port)) rdata = s.recvfrom(1024) print(rdata) æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œç¨‹åºä¼šç­‰å¾…æ¥å—æ¶ˆæ¯ NetAssistç«¯å‘é€æ¶ˆæ¯ï¼Œç¨‹åºä¼šæ¥æ”¶åˆ°å¦‚ä¸‹ç»“æœï¼Œæ˜¯ä¸€ä¸ªå…ƒç»„ (b'hehe', ('192.168.34.11', 8080)) ç»“æœè¯´æ˜ï¼š b'hehe' #æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªå­—èŠ‚ç  192.168.34.11 #å‘é€æ–¹IPåœ°å€ 8080 #å‘é€æ–¹ç«¯å£ ä»¥ä¸‹ä»£ç ä¸ºudpæ— é™æ¥æ”¶æ¶ˆæ¯ from socket import * s = socket(AF_INET,SOCK_DGRAM) port = 8888 s.bind((\"\",port)) #ç»‘å®š8888ç«¯å£ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªå…ƒç»„âš ï¸ while True: rdata = s.recvfrom(1024) #s.recvfromè¡¨ç¤ºæ¥æ”¶çš„æ¶ˆæ¯ï¼Œ1024è¡¨ç¤ºæœ¬æ¬¡æ¥æ”¶çš„æœ€å¤§å­—èŠ‚æ•° s.sendto(rdata[0],rdata[1]) #å‘é€æ•°æ®ï¼Œrdata[0]æ˜¯æ¥å—çš„ä¿¡æ¯ï¼Œrdata[1]æ˜¯æ¥æ”¶çš„IPåœ°å€å’Œç«¯å£ 4.ä½¿ç”¨socketè¿›è¡Œç½‘ç»œé€šä¿¡çš„è¿‡ç¨‹ 1.å¯¼å…¥socketæ¨¡å— 2.åˆ›å»ºå¥—æ¥å­—å¯¹è±¡ 3.ç»‘å®šIPåœ°å€å’Œç«¯å£å·(æ¥æ”¶æ•°æ®æ—¶è¦ç»‘å®šç«¯å£ï¼Œå‘é€æ—¶å¯ä»¥ä¸ç»‘å®š) 4.å‘é€æ¶ˆæ¯ï¼Œéœ€è¦å†™æ˜æ¥æ”¶æ–¹çš„IPå’Œç«¯å£å· 5.æ¥å—æ¶ˆæ¯(æ¥å—æ¶ˆæ¯å‰å¦‚æœæ²¡æœ‰è¿›è¡Œè¿‡é€šä¿¡ï¼Œéœ€è¦å…ˆå‘é€ä¸€æ¬¡) ä»¥ä¸‹ä»£ç ä¸ºæ¨¡æ‹Ÿå…¨åŒå·¥ï¼Œpythonç¨‹åºå‘é€ä¿¡æ¯ç»™NetAssist,NetASssistå‘é€ä¿¡æ¯ç»™pythonç¨‹åºï¼Œå¦‚æœå‘é€çš„ä¿¡æ¯ä¸­åŒ…å«886ã€åœ¨è§ã€å†è§ç­‰å°±é€€å‡ºç¨‹åº from socket import * import time #1åˆ›å»ºå¥—æ¥å­— udpSocket = socket(AF_INET, SOCK_DGRAM) bindAddr = (\"\",7088) udpSocket.bind(bindAddr)#ç»‘å®š while True: lst = ['886','åœ¨è§','å†è§'] #æ¥æ”¶å¯¹æ–¹å‘é€çš„æ•°æ® recvData = udpSocket.recvfrom(1024) print(recvData) print(type(recvData[0].strip())) #ç±»å‹æ˜¯å­—èŠ‚ print(str(recvData[0].strip(), encoding='gb2312')) #ç±»å‹æ˜¯å­—ç¬¦ä¸² if str(recvData[0].strip(),encoding='gb2312') in lst: break print('[%s] %s.%s' %(time.ctime(),recvData[1],recvData[0].decode(\"gb2312\"))) a = input(\"è¯·è¾“å…¥ï¼š\") udpSocket.sendto(a.encode('gb2312'),('192.168.34.11',8080)) if a in lst: break udpSocket.close() 5.udpå¹¿æ’­ 5.1æ¦‚å¿µã€åˆ†ç±»ã€ç¤ºæ„å›¾ æ¦‚å¿µ udpå¹¿æ’­ï¼šå½“å‰ç½‘ç»œä¸Šæ‰€æœ‰ç”µè„‘çš„æŸä¸ªè¿›ç¨‹éƒ½æ”¶åˆ°åŒä¸€ä¸ªæ•°æ®(âš ï¸tcpæ²¡æœ‰å¹¿æ’­) åˆ†ç±» å•æ’­ï¼šç‚¹å¯¹ç‚¹ å¤šæ’­ï¼šä¸€å¯¹å¤š å¹¿æ’­ï¼šä¸€å¯¹æ‰€æœ‰ ç¤ºæ„å›¾ 5.2é…ç½®udpå¹¿æ’­ å‘é€æ–¹ from socket import * #åˆ›å»ºudpå¥—æ¥å­— s = socket(AF_INET,SOCK_DGRAM) #å¯¹è¿™ä¸ªéœ€è¦å‘é€å¹¿æ’­æ•°æ®çš„å¥—æ¥å­—è¿›è¡Œä¿®æ”¹è®¾ç½®ï¼Œå›ºå®šæ ¼å¼ï¼Œå¦åˆ™ä¸èƒ½å‘é€å¹¿æ’­æ•°æ® s.setsockopt(SOL_SOCKET,SO_BROADCAST,1) #ä»£è¡¨å½“å‰ç½‘æ®µçš„å¹¿æ’­åœ°å€ï¼Œç¼–ç å¦‚æœä¸å†™å°±æ˜¯utf-8 s.sendto(\"udpå¹¿æ’­ä¿¡æ¯æµ‹è¯•\".encode(),(\"\",8080)) s.close() æ¥æ”¶æ–¹ from socket import * s = socket(AF_INET,SOCK_DGRAM) addr = s.bind((\"\",8080)) recv = s.recvfrom(1024) print(recv[0].decode()) s.close() è¿è¡Œè¿‡ç¨‹ 1.å…ˆè¿è¡Œæ¥æ”¶æ–¹ç¨‹åºç­‰å¾…æ¥å—ï¼Œç¨‹åºä¼šå¡ä½ç›´åˆ°æ¥æ”¶åˆ°ä¿¡æ¯ 2.å‘é€æ–¹è¿è¡Œç¨‹åºï¼Œå‘å½“å‰ç½‘ç»œä¸­å‘é€udpå¹¿æ’­ï¼Œæ¥æ”¶ç¨‹åºå°±ä¼šæ”¶åˆ°å‘é€æ–¹çš„ä¿¡æ¯ 6.åŸºäºudpå®ç°çš„TFTP 6.1TFTPä»‹ç» æ¦‚å¿µ TFTP(Trivial File Transfer Protocolï¼Œç®€å•æ–‡ä»¶ä¼ è¾“åè®®)æ˜¯TCP/IPåè®®ç°‡ä¸­ä¸€ä¸ªç”¨æ¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œç®€å•æ–‡ä»¶ä¼ è¾“çš„åè®® ä½œç”¨ ä½¿ç”¨TFTPåè®®ï¼Œå°±å¯ä»¥å®ç°ç®€å•æ–‡ä»¶çš„ä¸‹è½½ ç‰¹ç‚¹ ç®€å• å ç”¨èµ„æºå° é€‚åˆä¼ é€’å°æ–‡ä»¶ é€‚åˆåœ¨å±€åŸŸç½‘è¿›è¡Œä¼ é€’ ç«¯å£å·ä¸º69 åŸºäºudpå®ç° 6.2TFTPä¼ è¾“è¿‡ç¨‹ ç¬¬ä¸€æ­¥ã€å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯»å†™è¯·æ±‚ï¼ŒæœåŠ¡ç«¯é»˜è®¤ç«¯å£udp69 ç¬¬äºŒæ­¥ã€æœåŠ¡ç«¯å“åº”æ•°æ®åŒ…å‘é€ç»™å®¢æˆ·ç«¯ï¼ŒTFTPæ•°æ®åŒ…æœ‰å›ºå®šçš„æ ¼å¼ ç¬¬ä¸‰æ­¥ã€å®¢æˆ·ç«¯æ”¶åˆ°æ•°æ®åŒ…åå‘æœåŠ¡ç«¯è¿”å›ç¡®è®¤ä¿¡æ¯ACK ä¼ è¾“è¿‡ç¨‹ä¸­æ¶‰åŠçš„ä¸€äº›é—®é¢˜ æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯ä¼ æ•°æ®çš„æ—¶å€™å‘ç”Ÿä¸¢åŒ…æ€ä¹ˆåŠï¼Ÿ å¦‚æœæœåŠ¡ç«¯å‘é€ç»™å®¢æˆ·ç«¯çš„æ•°æ®åŒ…å‘ç”Ÿä¸¢å¤±æƒ…å†µï¼Œåˆ™æœåŠ¡ç«¯ä¼šé‡æ–°å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯è¿”å›çš„ç¡®è®¤ä¿¡æ¯ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ å®¢æˆ·ç«¯ä¼šé‡å‘ACKç»™æœåŠ¡ç«¯ï¼Œè¿™æ ·æœåŠ¡ç«¯æ‰èƒ½ç»§ç»­ä¼ è¾“æ•°æ® å®¢æˆ·ç«¯å¦‚ä½•ç¡®å®šæœåŠ¡ç«¯å·²ç»å…¨éƒ¨ä¼ è¾“å®Œæ¯•ï¼Ÿ TFTPåè®®ä¸­ï¼ŒæœåŠ¡ç«¯æ¯æ¬¡ä¼šå›ºå®šå‘å®¢æˆ·ç«¯è¿”å›516å­—èŠ‚çš„æ•°æ®(2å­—èŠ‚æ“ä½œç +2å­—èŠ‚å—ç¼–å·+512å­—èŠ‚çœŸå®æ•°æ®)ï¼Œå½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„æ•°æ®å°äº516å­—èŠ‚æ—¶ï¼Œå°±æ„å‘³ç€æœåŠ¡ç«¯å·²ç»å‘é€å®Œæ¯•äº† å¦‚æœæ°å¥½æœ€åä¸€æ¬¡æ•°æ®é•¿åº¦ä¸º516å­—èŠ‚ï¼ŒæœåŠ¡ç«¯ä¼šå†å‘ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°æ®åŒ… TFTPèƒ½å¦ä¿è¯æ•°æ®ä¸ä¸¢åŒ…ï¼Ÿ TFTPæ˜¯å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢åŒ…çš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯å¦‚æœæ²¡æœ‰æ”¶åˆ°æ•°æ®æœåŠ¡ç«¯ä¼šé‡å‘æ•°æ®ï¼ŒæœåŠ¡ç«¯æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ACKå°±ä¸ä¼šç»§ç»­å‘é€æ•°æ® TFTPä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°çš„æ•°æ®å°äºæœåŠ¡ç«¯å‘é€çš„516å­—èŠ‚ï¼Œè¿™ç§æƒ…å†µæ— æ³•åšæ ¡éªŒ 6.3TFTPæ ¼å¼è¦æ±‚ TFTPæ ¼å¼è¦æ±‚ 6.4TFTPæ„é€ ä¸‹è½½è¯·æ±‚æ•°æ® TFTPæ„é€ ä¸‹è½½è¯·æ±‚æ•°æ®éœ€è¦æ ¹æ®TFTPè¯»å†™è¯·æ±‚æ ¼å¼æ¥ç¼–å†™ ä»¥ä¸‹ä»£ç ä¸ºæ„é€ TFTPè¯·æ±‚æ•°æ®ç¤ºä¾‹ #éœ€è¦å¯¼å…¥structæ¨¡å— import struct #æ„é€ ä¸‹è½½è¯·æ±‚ filename = \"abc.jpg\" //å°†æ–‡ä»¶åèµ‹å€¼ç»™å˜é‡ï¼Œæ–¹ä¾¿ä¿®æ”¹ requestData = struct.pack(\"!H%dsb5sb\" %len(filename.encode(\"gb2312\")),1,filename.encode(\"gb2312\"),0,\"octet\".encode(\"gb2312\"),0) struct.pack(\"!H%dsb5sb\" %len(filename.encode(\"gb2312\")),1,filename.encode(\"gb2312\"),0,\"octet\".encode(\"gb2312\"),0) struct.packæ˜¯ä¸€ç§æ‰“åŒ…çš„æ–¹æ³•ï¼Œæ‰“åŒ…æ ¼å¼ä¸­åˆ†ä¸º6ä¸ªéƒ¨åˆ†ï¼Œç¬¬1éƒ¨åˆ†æ˜¯å¯¹å5éƒ¨åˆ†è¿›è¡Œçš„ç»Ÿä¸€è¯´æ˜ï¼Œå5éƒ¨åˆ†æ˜¯TFTPè¯»å†™è¯·æ±‚å›ºå®šæ ¼å¼ !H%dsb5sb\" %len(filename.encode(\"gb2312\")) 1 filename.encode(\"gb2312\"ï¼‰#ç¼–ç æ–¹å¼æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ 0 \"octet\".encode(\"gb2312\") #ç¼–ç æ–¹å¼æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ 0 ç¬¬ä¸€éƒ¨åˆ† \"!H%dsb5sb\" %len(filename.encode(\"gb2312\")) !è¡¨ç¤ºæŒ‰ç…§ç½‘ç»œä¼ è¾“æ•°æ®è¦æ±‚çš„å½¢å¼æ¥ç»„ç»‡æ•°æ® Hè¡¨ç¤ºå°†ç¬¬äºŒéƒ¨åˆ†çš„1æ›¿æ¢æˆå 2ä¸ªå­—èŠ‚ %dæ˜¯æ•°å­—å ä½ç¬¦ï¼Œå› ä¸ºåé¢å†™äº† %len(filename.encode(\"gb2312\"))ï¼Œå› æ­¤è¿™é‡Œçš„%så°±æ˜¯å­˜æ”¾æ–‡ä»¶åçš„å˜é‡filenameä¸­çš„æ–‡ä»¶çš„å­—èŠ‚é•¿åº¦ï¼Œ%dåè¾¹çš„bè¡¨ç¤ºå­—èŠ‚ 5sbæ˜¯æŒ‡åè¾¹çš„ octet,sbè¡¨ç¤ºçš„æ˜¯å­—èŠ‚ï¼Œoctetæ˜¯5ä¸ªå­—èŠ‚ï¼Œå› æ­¤æ˜¯5sbï¼Œè¿™é‡Œæ˜¯å›ºå®šçš„æ ¼å¼ ç¬¬äºŒéƒ¨åˆ† 1 è¿™é‡Œçš„1å·²ç»ç”±å‰è¾¹çš„Hæ›¿æ¢æˆ2ä¸ªå­—èŠ‚ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸Šä¼ è¿˜æ˜¯ä¸‹è½½ï¼Œ1æ˜¯ä¸‹è½½ï¼Œ2æ˜¯ä¸Šä¼  ç¬¬ä¸‰éƒ¨åˆ† filename.encode(\"gb2312\") è¿™é‡Œè¡¨ç¤ºå°†æ–‡ä»¶åç¼–ç æˆäºŒè¿›åˆ¶ï¼Œâš ï¸æ³¨æ„ï¼Œè¿™é‡Œçš„ç¼–ç æ–¹å¼è¦æ ¹æ®å®é™…æƒ…å†µåšç›¸åº”çš„ä¿®æ”¹ ç¬¬å››éƒ¨åˆ† 0 è¿™é‡Œçš„0æ˜¯å›ºå®šæ ¼å¼ ç¬¬äº”éƒ¨åˆ† \"octet\".encode(\"gb2312\") è¿™é‡Œçš„octetæ˜¯å›ºå®šæ ¼å¼ ç¬¬å…­éƒ¨åˆ† 0 è¿™é‡Œçš„0æ˜¯å›ºå®šæ ¼å¼ 6.5å®ç°TFTPä¸‹è½½ 6.5.1structæ¨¡å—è¯´æ˜ ä½œç”¨ structæ¨¡å—å¯ä»¥æŒ‰ç…§æŒ‡å®šæ ¼å¼å°†pythonæ•°æ®è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²ä¸ºå­—èŠ‚æµ structä¸­çš„ä¸‰ä¸ªé‡è¦å‡½æ•° pack æŒ‰ç…§ç»™å®šçš„æ ¼å¼(fmt)ï¼ŒæŠŠæ•°æ®å°è£…æˆå­—ç¬¦ä¸²(å®é™…ä¸Šæ˜¯ç±»ä¼¼äºcç»“æ„çš„å­—èŠ‚æµ) pack(fmt,v1,v2,...) struct.pack(\"!H8sb5sb\",1,\"test.jpg\",0,\"octet\",0) unpack æŒ‰ç…§ç»™çš„æ ¼å¼(fmt)è§£æå­—èŠ‚æµstringï¼Œè¿”å›è§£æå‡ºæ¥çš„å…ƒç»„ unpact(fat,string) struct.unpack(\"!HH\",4,p_num) cmdTuple = struct.unpack(\"!HH\",recvData[:4]) calcsize è®¡ç®—ç»™å®šçš„æ ¼å¼(fmt)å ç”¨å¤šå°‘å­—èŠ‚ structæ¨¡å—ä½¿ç”¨è¯´æ˜å›¾ 6.5.2TFTPä¸‹è½½ç¨‹åº ç¬¬ä¸€æ­¥ã€è®¾ç½®TFTPæœåŠ¡ç«¯ å®ç°TFTPéœ€è¦ç”¨åˆ°ä¸€ä¸ªè½¯ä»¶Tftpd32ï¼Œé€‰æ‹©å…±äº«çš„ç›®å½•ç”¨æ¥æä¾›ä¸‹è½½ï¼Œé€‰æ‹©æœ¬æœºç½‘å¡127.0.0.1 ç¬¬äºŒæ­¥ã€ç¼–å†™ä¸‹è½½å™¨(å®¢æˆ·ç«¯) å®ç°TFTPä¸‹è½½å™¨ ä¸‹è½½ï¼šä»æœåŠ¡å™¨ä¸Šå°†ä¸€ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°æœ¬åœ° ä¸‹è½½è¿‡ç¨‹ åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸€å®šè¦ä¸ä¸‹è½½çš„æ–‡ä»¶åç›¸åŒ å‘ç©ºæ–‡ä»¶ä¸­å†™å…¥æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œæ¥æ”¶ä¸€ç‚¹å†™å…¥ä¸€ç‚¹ æ¥æ”¶å®Œæ‰€æœ‰æ•°æ®åå…³é—­æ–‡ä»¶ ç¼–å†™ä¸€ä¸ªTFTPä¸‹è½½ç¨‹åº #å¯¼å…¥structæ¨¡å—ã€socketæ¨¡å—ã€timeæ¨¡å— import struct from socket import * import time #TFTPä¸­å…±äº«çš„æ–‡ä»¶åŠTFTPæœåŠ¡ç«¯IPåœ°å€åˆ†åˆ«å†™å…¥å˜é‡ä¸­ filename = \"xiaohua.jpg\" serverIP = \"192.168.34.112\" #åˆ©ç”¨struckæ¨¡å—çš„packæ–¹æ³•å°è£…è¯·æ±‚æ•°æ®ï¼Œä»£ç å…·ä½“å«ä¹‰åœ¨6.4TFTPæ„é€ ä¸‹è½½è¯·æ±‚æ•°æ® requestData = struct.pack(\"!H%dsb5sb\" %len(filename.encode(\"gb2312\")),1,filename.encode(\"gb2312\"),0,\"octet\".encode(\"gb2312\"),0) #åˆ›å»ºå¥—æ¥å­—å¯¹è±¡ s = socket(AF_INET,SOCK_DGRAM) #å‘é€è¯·æ±‚æ•°æ® s.sendto(requestData,(serverIP,69)) #è®¾ç½®æ–‡ä»¶å¥æŸ„ï¼Œå°†åç»­æ¥æ”¶çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œâš ï¸å†™å…¥çš„æ–‡ä»¶å¿…é¡»ä¸TFTPä¸­å…±äº«çš„æ–‡ä»¶åç›¸åŒ f = open(filename,\"ab\") #å› ä¸ºä¸çŸ¥é“è¦æ¥å—çš„æ•°æ®æœ‰å¤šå¤§ï¼Œå› æ­¤å†™ä¸€ä¸ªwhileå¾ªç¯å¾ªç¯æ¥æ”¶ï¼ŒçŸ¥é“æ¥æ”¶å®Œæˆ while True: #æ¥æ”¶æ•°æ®ï¼Œæ‰“å°ä¸€ä¸‹çœ‹çœ‹æ¥æ”¶åˆ°çš„å†…å®¹æ˜¯ä»€ä¹ˆ recvData = s.recvfrom(1024) print(recvData) æ”¶åˆ°çš„æ•°æ®å†…å®¹å¦‚ä¸‹ï¼Œæ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ† ç¬¬ä¸€éƒ¨åˆ†æ˜¯ æ“ä½œç +å—ç¼–å·+çœŸå®æ•°æ® ä¸€å…±516å­—èŠ‚ æ“ä½œç ï¼šå‰2ä¸ªå­—èŠ‚ å—ç¼–å·ï¼šå‰2ä¸ªå­—èŠ‚ çœŸå®æ•°æ®ï¼š512å­—èŠ‚ ç¬¬äºŒéƒ¨åˆ†æ˜¯ TFTPæœåŠ¡ç«¯IPåŠTFTPå‘å®¢æˆ·ç«¯å“åº”æ•°æ®æ—¶ç”¨åˆ°çš„éšæœºç«¯å£ âš ï¸TFTPå‘å®¢æˆ·ç«¯è¿”å›æ•°æ®æ—¶ä¸ä¼šä½¿ç”¨é»˜è®¤çš„69ç«¯å£ï¼Œä¼šä½¿ç”¨ä¸€ä¸ªéšæœºç«¯å£ï¼Œå› ä¸º69ç«¯å£è¿˜éœ€è¦å‘å…¶ä»–å®¢æˆ·ç«¯å“åº”è¯·æ±‚ï¼Œè€Œåç»­å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯è¿”å›ACKç¡®è®¤ä¿¡æ¯æ—¶ï¼Œä¹Ÿéœ€è¦ç”¨åˆ°è¿™ä¸ªéšæœºç«¯å£âš ï¸ (b'\\x00\\x03\\x00\\x01FLV\\x01\\æ­¤å¤„çœç•¥ä¸€ä¸‡å­—\\x00!modified by youku.com in 20111202\\x00\\x0chasKeyframes\\\\x00\\x00Aj\\xb0\\xa6@\\x00', ('192.168.34.112', 49373)) \\x00\\x03\\x00\\x01FLV è¿™ä¸€éƒ¨åˆ†å…¶å®å°±èƒ½çœ‹åˆ°æ“ä½œç å’Œå—ç¼–å·ï¼Œæ“ä½œç æ˜¯3(\\x03),å—ç¼–å·æ˜¯1(\\x01)ï¼Œæ–‡ä»¶åæ˜¯(FLv) ä¸Šè¿°ä»£ç ä¸­å·²ç»æ”¶åˆ°äº†TFTPå“åº”çš„æ•°æ®ï¼Œæ¥ä¸‹æ¥è·å–ä¸€ä¸‹æ“ä½œç å’Œå—ç¼–å· #å› ä¸ºä¸çŸ¥é“è¦æ¥æ”¶çš„æ•°æ®æœ‰å¤šå¤§ï¼Œå› æ­¤å†™ä¸€ä¸ªwhileå¾ªç¯å¾ªç¯æ¥æ”¶ï¼ŒçŸ¥é“æ¥æ”¶å®Œæˆ while True: #æ¥æ”¶æ•°æ®ï¼Œæ‰“å°ä¸€ä¸‹çœ‹çœ‹æ¥æ”¶åˆ°çš„å†…å®¹æ˜¯ä»€ä¹ˆ recvData = s.recvfrom(1024) print(recvData) #è·å–æ“ä½œç å’Œå—ç¼–å·ï¼Œè¿™é‡Œç”¨åˆ°äº†structæ¨¡å—ä¸­çš„unpack(è§£åŒ…)æ–¹æ³• caozuoma,kuaibianhao = struct.unpack(\"!HH\",recvData[0][:4]) //è·å–æ“ä½œç å’Œå—ç¼–å·ä»£ç è¯´æ˜ æ”¶åˆ°çš„æ•°æ®å¦‚ä¸‹ (b'\\x00\\x03\\x00\\x01FLV\\x01\\æ­¤å¤„çœç•¥ä¸€ä¸‡å­—\\x00!modified by youku.com in 20111202\\x00\\x0chasKeyframes\\\\x00\\x00Aj\\xb0\\xa6@\\x00', ('192.168.34.112', 49373)) è¦è·å–æ“ä½œç å’Œä»£ç å—ï¼Œéœ€è¦æˆªå–æ”¶åˆ°çš„æ•°æ®çš„ç¬¬ä¸€éƒ¨åˆ†ä¸­çš„å‰4ä¸ªå­—èŠ‚ è¿”å›çš„æ•°æ®çš„æ˜¯ä¸€ä¸ªå…ƒç»„ ç¬¬ä¸€éƒ¨åˆ†æ˜¯ æ“ä½œç +å—ç¼–å·+çœŸå®æ•°æ® ä¸€å…±516å­—èŠ‚ æ“ä½œç ï¼šå‰2ä¸ªå­—èŠ‚ å—ç¼–å·ï¼šå‰2ä¸ªå­—èŠ‚ çœŸå®æ•°æ®ï¼š512å­—èŠ‚ ç¬¬äºŒéƒ¨åˆ†æ˜¯ æœåŠ¡å™¨IPåœ°å€å’Œéšæœºç«¯å£ è·å–åˆ°çš„ç»“æœå¦‚ä¸‹ï¼Œå› ä¸ºè¿˜æ²¡æœ‰å‘æœåŠ¡å™¨å‘é€ACKç¡®è®¤ä¿¡æ¯ï¼Œå› æ­¤å—ç¼–å·ä¼šä¸€ç›´æ”¶åˆ°1 3 1 3 1 ã€‚ã€‚ã€‚ ç°åœ¨å·²ç»è·å–åˆ°äº†æ“ä½œç å’Œå—ç¼–å·ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å†™å…¥æœ¬åœ°æ–‡ä»¶ä»¥åŠå‘æœåŠ¡å™¨å‘é€ACKç¡®è®¤ä¿¡æ¯äº† #å…ˆåˆ¤æ–­ä¸€ä¸‹æ“ä½œç æ˜¯å¦æ˜¯5ï¼Œå¦‚æœæ˜¯5åˆ™å°±æ˜¯é”™è¯¯ä¿¡æ¯ if caozuoma == 5: print(\"æ–‡ä»¶ä¸å­˜åœ¨ï¼ï¼ï¼\") break #å°†æ”¶åˆ°çš„æ•°æ®å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼Œæ”¶åˆ°çš„æ•°æ®çš„ç¬¬ä¸€éƒ¨åˆ†ç¬¬4ä¸ªå­—èŠ‚åçš„512å­—èŠ‚å°±æ˜¯çœŸå®æ•°æ® f.write(recvData[0][4:]) #TFTPåè®®ä¸­æ¯æ¬¡ä¼ è¾“çš„æ•°æ®æ˜¯512å­—èŠ‚ï¼Œè¿™é‡Œåšä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœæ•°æ®å°äº512å­—èŠ‚åˆ™è¯´æ˜å®¢æˆ·ç«¯æ¥æ”¶å®Œæ¯• âš ï¸è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹çš„æ˜¯ï¼Œå¦‚æœæœ€åä¸€æ¬¡ä¼ è¾“çš„æ•°æ®æ°å¥½ç­‰äº512å­—èŠ‚ï¼Œåˆ™æœåŠ¡ç«¯ä¼šå†æ¬¡å‘é€ä¸€ä¸ªæ•°æ®é•¿åº¦ä¸º0çš„åŒ… if len(recvData[0]) å®Œæ•´ä»£ç  import struct from socket import * import time filename = \"xiaohua.jpg\" serverIP = \"192.168.34.112\" requestData = struct.pack(\"!H%dsb5sb\" %len(filename.encode(\"gb2312\")),1,filename.encode(\"gb2312\"),0,\"octet\".encode(\"gb2312\"),0) s = socket(AF_INET,SOCK_DGRAM) s.sendto(requestData,(serverIP,69)) f = open(filename,\"ab\") while True: recvData = s.recvfrom(1024) print(recvData) caozuoma,kuaibianhao = struct.unpack(\"!HH\",recvData[0][:4]) serverPort = recvData[1][1] print(caozuoma,kuaibianhao) if caozuoma == 5: print(\"æ–‡ä»¶ä¸å­˜åœ¨ï¼ï¼ï¼\") break f.write(recvData[0][4:]) if len(recvData[0]) 6.6å®ç°TFTPä¸Šä¼  æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/26.3pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-tcpç¼–ç¨‹.html":{"url":"python/pythonåŸºç¡€/26.3pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-tcpç¼–ç¨‹.html","title":"ç½‘ç»œç¼–ç¨‹-TCPç¼–ç¨‹","keywords":"","body":"pythonåŸºç¡€äºŒåå…­ ç½‘ç»œç¼–ç¨‹-tcpç¼–ç¨‹ 1.TCPä»‹ç» TCP ä¸ UDP çš„åŒºåˆ«ç›¸å½“å¤§ã€‚å®ƒå……åˆ†åœ°å®ç°äº†æ•°æ®ä¼ è¾“æ—¶å„ç§æ§åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥è¿›è¡Œä¸¢åŒ…æ—¶çš„é‡å‘æ§åˆ¶ï¼Œè¿˜å¯ä»¥å¯¹æ¬¡åºä¹±æ‰çš„åˆ†åŒ…è¿›è¡Œé¡ºåºæ§åˆ¶ã€‚è€Œè¿™äº›åœ¨ UDP ä¸­éƒ½æ²¡æœ‰ã€‚ æ­¤å¤–ï¼ŒTCP ä½œä¸ºä¸€ç§é¢å‘æœ‰è¿æ¥çš„åè®®ï¼Œåªæœ‰åœ¨ç¡®è®¤é€šä¿¡å¯¹ç«¯å­˜åœ¨æ—¶æ‰ä¼šå‘é€æ•°æ®ï¼Œä»è€Œå¯ä»¥æ§åˆ¶é€šä¿¡æµé‡çš„æµªè´¹ã€‚ æ ¹æ® TCP çš„è¿™äº›æœºåˆ¶ï¼Œåœ¨ IP è¿™ç§æ— è¿æ¥çš„ç½‘ç»œä¸Šä¹Ÿèƒ½å¤Ÿå®ç°é«˜å¯é æ€§çš„é€šä¿¡ï¼ˆ ä¸»è¦é€šè¿‡æ£€éªŒå’Œã€åºåˆ—å·ã€ç¡®è®¤åº”ç­”ã€é‡å‘æ§åˆ¶ã€è¿æ¥ç®¡ç†ä»¥åŠçª—å£æ§åˆ¶ç­‰æœºåˆ¶å®ç°ï¼‰ã€‚ 2.TCPä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹ 2.1TCPä¸‰æ¬¡æ¡æ‰‹ TCP æä¾›é¢å‘æœ‰è¿æ¥çš„é€šä¿¡ä¼ è¾“ã€‚é¢å‘æœ‰è¿æ¥æ˜¯æŒ‡åœ¨æ•°æ®é€šä¿¡å¼€å§‹ä¹‹å‰å…ˆåšå¥½ä¸¤ç«¯ä¹‹é—´çš„å‡†å¤‡å·¥ä½œã€‚ æ‰€è°“ä¸‰æ¬¡æ¡æ‰‹æ˜¯æŒ‡å»ºç«‹ä¸€ä¸ª TCP è¿æ¥æ—¶éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯æ€»å…±å‘é€ä¸‰ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„å»ºç«‹ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æ‰§è¡Œconnectæ¥è§¦å‘ã€‚ ä¸‹é¢æ¥çœ‹çœ‹ä¸‰æ¬¡æ¡æ‰‹çš„æµç¨‹å›¾ï¼š ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å°†æ ‡å¿—ä½SYNç½®ä¸º1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=Jï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯è¿›å…¥SYN_SENTçŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯ç¡®è®¤ã€‚ ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡å™¨ç«¯æ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½SYN=1çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨ç«¯å°†æ ‡å¿—ä½SYNå’ŒACKéƒ½ç½®ä¸º1ï¼Œack=J+1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=Kï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™å®¢æˆ·ç«¯ä»¥ç¡®è®¤è¿æ¥è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯è¿›å…¥SYN_RCVDçŠ¶æ€ã€‚ ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°ç¡®è®¤åï¼Œæ£€æŸ¥ackæ˜¯å¦ä¸ºJ+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ACKç½®ä¸º1ï¼Œack=K+1ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯æ£€æŸ¥ackæ˜¯å¦ä¸ºK+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œéšåå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ä¹‹é—´å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®äº†ã€‚ 2.2TCPå››æ¬¡æŒ¥æ‰‹ å››æ¬¡æŒ¥æ‰‹å³ç»ˆæ­¢TCPè¿æ¥ï¼Œå°±æ˜¯æŒ‡æ–­å¼€ä¸€ä¸ªTCPè¿æ¥æ—¶ï¼Œéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ€»å…±å‘é€4ä¸ªåŒ…ä»¥ç¡®è®¤è¿æ¥çš„æ–­å¼€ã€‚åœ¨socketç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯ä»»ä¸€æ–¹æ‰§è¡Œcloseæ¥è§¦å‘ã€‚ ç”±äºTCPè¿æ¥æ˜¯å…¨åŒå·¥çš„ï¼Œå› æ­¤ï¼Œæ¯ä¸ªæ–¹å‘éƒ½å¿…é¡»è¦å•ç‹¬è¿›è¡Œå…³é—­ï¼Œè¿™ä¸€åŸåˆ™æ˜¯å½“ä¸€æ–¹å®Œæˆæ•°æ®å‘é€ä»»åŠ¡åï¼Œå‘é€ä¸€ä¸ªFINæ¥ç»ˆæ­¢è¿™ä¸€æ–¹å‘çš„è¿æ¥ï¼Œæ”¶åˆ°ä¸€ä¸ªFINåªæ˜¯æ„å‘³ç€è¿™ä¸€æ–¹å‘ä¸Šæ²¡æœ‰æ•°æ®æµåŠ¨äº†ï¼Œå³ä¸ä¼šå†æ”¶åˆ°æ•°æ®äº†ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªTCPè¿æ¥ä¸Šä»ç„¶èƒ½å¤Ÿå‘é€æ•°æ®ï¼Œç›´åˆ°è¿™ä¸€æ–¹å‘ä¹Ÿå‘é€äº†FINã€‚é¦–å…ˆè¿›è¡Œå…³é—­çš„ä¸€æ–¹å°†æ‰§è¡Œä¸»åŠ¨å…³é—­ï¼Œè€Œå¦ä¸€æ–¹åˆ™æ‰§è¡Œè¢«åŠ¨å…³é—­ã€‚ ä¸‹é¢æ¥çœ‹çœ‹å››æ¬¡æŒ¥æ‰‹çš„æµç¨‹å›¾ï¼š ä¸­æ–­è¿æ¥ç«¯å¯ä»¥æ˜¯å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨ç«¯ã€‚ ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªFIN=Mï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ç«¯çš„æ•°æ®ä¼ é€ï¼Œå®¢æˆ·ç«¯è¿›å…¥FIN_WAIT_1çŠ¶æ€ã€‚æ„æ€æ˜¯è¯´\"æˆ‘å®¢æˆ·ç«¯æ²¡æœ‰æ•°æ®è¦å‘ç»™ä½ äº†\"ï¼Œä½†æ˜¯å¦‚æœä½ æœåŠ¡å™¨ç«¯è¿˜æœ‰æ•°æ®æ²¡æœ‰å‘é€å®Œæˆï¼Œåˆ™ä¸å¿…æ€¥ç€å…³é—­è¿æ¥ï¼Œå¯ä»¥ç»§ç»­å‘é€æ•°æ®ã€‚ ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡å™¨ç«¯æ”¶åˆ°FINåï¼Œå…ˆå‘é€ack=M+1ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œä½ çš„è¯·æ±‚æˆ‘æ”¶åˆ°äº†ï¼Œä½†æ˜¯æˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œè¯·ç»§ç»­ä½ ç­‰æˆ‘çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±è¿›å…¥FIN_WAIT_2 çŠ¶æ€ï¼Œç»§ç»­ç­‰å¾…æœåŠ¡å™¨ç«¯çš„FINæŠ¥æ–‡ã€‚ ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šå½“æœåŠ¡å™¨ç«¯ç¡®å®šæ•°æ®å·²å‘é€å®Œæˆï¼Œåˆ™å‘å®¢æˆ·ç«¯å‘é€FIN=NæŠ¥æ–‡ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå¥½äº†ï¼Œæˆ‘è¿™è¾¹æ•°æ®å‘å®Œäº†ï¼Œå‡†å¤‡å¥½å…³é—­è¿æ¥äº†ã€‚æœåŠ¡å™¨ç«¯è¿›å…¥LAST_ACKçŠ¶æ€ã€‚ ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°FIN=NæŠ¥æ–‡åï¼Œå°±çŸ¥é“å¯ä»¥å…³é—­è¿æ¥äº†ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯ä¸ç›¸ä¿¡ç½‘ç»œï¼Œæ€•æœåŠ¡å™¨ç«¯ä¸çŸ¥é“è¦å…³é—­ï¼Œæ‰€ä»¥å‘é€ack=N+1åè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œå¦‚æœServerç«¯æ²¡æœ‰æ”¶åˆ°ACKåˆ™å¯ä»¥é‡ä¼ ã€‚æœåŠ¡å™¨ç«¯æ”¶åˆ°ACKåï¼Œå°±çŸ¥é“å¯ä»¥æ–­å¼€è¿æ¥äº†ã€‚å®¢æˆ·ç«¯ç­‰å¾…äº†2MSLåä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œåˆ™è¯æ˜æœåŠ¡å™¨ç«¯å·²æ­£å¸¸å…³é—­ï¼Œé‚£å¥½ï¼Œæˆ‘å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚æœ€ç»ˆå®Œæˆäº†å››æ¬¡æŒ¥æ‰‹ã€‚ ä¸Šé¢æ˜¯ä¸€æ–¹ä¸»åŠ¨å…³é—­ï¼Œå¦ä¸€æ–¹è¢«åŠ¨å…³é—­çš„æƒ…å†µï¼Œå®é™…ä¸­è¿˜ä¼šå‡ºç°åŒæ—¶å‘èµ·ä¸»åŠ¨å…³é—­çš„æƒ…å†µï¼Œ å…·ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š 3.TCPå…¶ä»–ç‰¹æ€§ 3.1é€šè¿‡åºåˆ—å·ä¸ç¡®è®¤åº”ç­”æé«˜å¯é æ€§ åœ¨ TCP ä¸­ï¼Œå½“å‘é€ç«¯çš„æ•°æ®åˆ°è¾¾æ¥æ”¶ä¸»æœºæ—¶ï¼Œæ¥æ”¶ç«¯ä¸»æœºä¼šè¿”å›ä¸€ä¸ªå·²æ”¶åˆ°æ¶ˆæ¯çš„é€šçŸ¥ã€‚è¿™ä¸ªæ¶ˆæ¯å«åšç¡®è®¤åº”ç­”ï¼ˆACKï¼‰ã€‚å½“å‘é€ç«¯å°†æ•°æ®å‘å‡ºä¹‹åä¼šç­‰å¾…å¯¹ç«¯çš„ç¡®è®¤åº”ç­”ã€‚å¦‚æœæœ‰ç¡®è®¤åº”ç­”ï¼Œè¯´æ˜æ•°æ®å·²ç»æˆåŠŸåˆ°è¾¾å¯¹ç«¯ã€‚åä¹‹ï¼Œåˆ™æ•°æ®ä¸¢å¤±çš„å¯èƒ½æ€§å¾ˆå¤§ã€‚ åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰ç­‰å¾…åˆ°ç¡®è®¤åº”ç­”ï¼Œå‘é€ç«¯å°±å¯ä»¥è®¤ä¸ºæ•°æ®å·²ç»ä¸¢å¤±ï¼Œå¹¶è¿›è¡Œé‡å‘ã€‚ç”±æ­¤ï¼Œå³ä½¿äº§ç”Ÿäº†ä¸¢åŒ…ï¼Œä»ç„¶èƒ½å¤Ÿä¿è¯æ•°æ®èƒ½å¤Ÿåˆ°è¾¾å¯¹ç«¯ï¼Œå®ç°å¯é ä¼ è¾“ã€‚ æœªæ”¶åˆ°ç¡®è®¤åº”ç­”å¹¶ä¸æ„å‘³ç€æ•°æ®ä¸€å®šä¸¢å¤±ã€‚ä¹Ÿæœ‰å¯èƒ½æ˜¯æ•°æ®å¯¹æ–¹å·²ç»æ”¶åˆ°ï¼Œåªæ˜¯è¿”å›çš„ç¡®è®¤åº”ç­”åœ¨é€”ä¸­ä¸¢å¤±ã€‚è¿™ç§æƒ…å†µä¹Ÿä¼šå¯¼è‡´å‘é€ç«¯è¯¯ä»¥ä¸ºæ•°æ®æ²¡æœ‰åˆ°è¾¾ç›®çš„åœ°è€Œé‡å‘æ•°æ®ã€‚ æ­¤å¤–ï¼Œä¹Ÿæœ‰å¯èƒ½å› ä¸ºä¸€äº›å…¶ä»–åŸå› å¯¼è‡´ç¡®è®¤åº”ç­”å»¶è¿Ÿåˆ°è¾¾ï¼Œåœ¨æºä¸»æœºé‡å‘æ•°æ®ä»¥åæ‰åˆ°è¾¾çš„æƒ…å†µä¹Ÿå±¡è§ä¸é²œã€‚æ­¤æ—¶ï¼Œæºä¸»æœºåªè¦æŒ‰ç…§æœºåˆ¶é‡å‘æ•°æ®å³å¯ã€‚ å¯¹äºç›®æ ‡ä¸»æœºæ¥è¯´ï¼Œåå¤æ”¶åˆ°ç›¸åŒçš„æ•°æ®æ˜¯ä¸å¯å–çš„ã€‚ä¸ºäº†å¯¹ä¸Šå±‚åº”ç”¨æä¾›å¯é çš„ä¼ è¾“ï¼Œç›®æ ‡ä¸»æœºå¿…é¡»æ”¾å¼ƒé‡å¤çš„æ•°æ®åŒ…ã€‚ä¸ºæ­¤æˆ‘ä»¬å¼•å…¥äº†åºåˆ—å·ã€‚ åºåˆ—å·æ˜¯æŒ‰ç…§é¡ºåºç»™å‘é€æ•°æ®çš„æ¯ä¸€ä¸ªå­—èŠ‚ï¼ˆ8ä½å­—èŠ‚ï¼‰éƒ½æ ‡ä¸Šå·ç çš„ç¼–å·ã€‚æ¥æ”¶ç«¯æŸ¥è¯¢æ¥æ”¶æ•°æ® TCP é¦–éƒ¨ä¸­çš„åºåˆ—å·å’Œæ•°æ®çš„é•¿åº¦ï¼Œå°†è‡ªå·±ä¸‹ä¸€æ­¥åº”è¯¥æ¥æ”¶çš„åºåˆ—å·ä½œä¸ºç¡®è®¤åº”ç­”è¿”é€å›å»ã€‚é€šè¿‡åºåˆ—å·å’Œç¡®è®¤åº”ç­”å·ï¼ŒTCP èƒ½å¤Ÿè¯†åˆ«æ˜¯å¦å·²ç»æ¥æ”¶æ•°æ®ï¼Œåˆèƒ½å¤Ÿåˆ¤æ–­æ˜¯å¦éœ€è¦æ¥æ”¶ï¼Œä»è€Œå®ç°å¯é ä¼ è¾“ã€‚ 3.2é‡å‘è¶…æ—¶çš„ç¡®å®š é‡å‘è¶…æ—¶æ˜¯æŒ‡åœ¨é‡å‘æ•°æ®ä¹‹å‰ï¼Œç­‰å¾…ç¡®è®¤åº”ç­”åˆ°æ¥çš„é‚£ä¸ªç‰¹å®šæ—¶é—´é—´éš”ã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ä»æœªæ”¶åˆ°ç¡®è®¤åº”ç­”ï¼Œå‘é€ç«¯å°†è¿›è¡Œæ•°æ®é‡å‘ã€‚æœ€ç†æƒ³çš„æ˜¯ï¼Œæ‰¾åˆ°ä¸€ä¸ªæœ€å°æ—¶é—´ï¼Œå®ƒèƒ½ä¿è¯â€œç¡®è®¤åº”ç­”ä¸€å®šèƒ½åœ¨è¿™ä¸ªæ—¶é—´å†…è¿”å›â€ã€‚ TCP è¦æ±‚ä¸è®ºå¤„åœ¨ä½•ç§ç½‘ç»œç¯å¢ƒä¸‹éƒ½è¦æä¾›é«˜æ€§èƒ½é€šä¿¡ï¼Œå¹¶ä¸”æ— è®ºç½‘ç»œæ‹¥å µæƒ…å†µå‘ç”Ÿä½•ç§å˜åŒ–ï¼Œéƒ½å¿…é¡»ä¿æŒè¿™ä¸€ç‰¹æ€§ã€‚ä¸ºæ­¤ï¼Œå®ƒåœ¨æ¯æ¬¡å‘åŒ…æ—¶éƒ½ä¼šè®¡ç®—å¾€è¿”æ—¶é—´åŠå…¶åå·®ã€‚å°†è¿™ä¸ªå¾€è¿”æ—¶é—´å’Œåå·®æ—¶é—´ç›¸åŠ ï¼Œé‡å‘è¶…æ—¶çš„æ—¶é—´å°±æ˜¯æ¯”è¿™ä¸ªæ€»å’Œè¦ç¨å¤§ä¸€ç‚¹çš„å€¼ã€‚ åœ¨ BSD çš„ Unix ä»¥åŠ Windows ç³»ç»Ÿä¸­ï¼Œè¶…æ—¶éƒ½ä»¥0.5ç§’ä¸ºå•ä½è¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤é‡å‘è¶…æ—¶éƒ½æ˜¯0.5ç§’çš„æ•´æ•°å€ã€‚ä¸è¿‡ï¼Œæœ€åˆå…¶é‡å‘è¶…æ—¶çš„é»˜è®¤å€¼ä¸€èˆ¬è®¾ç½®ä¸º6ç§’å·¦å³ã€‚ æ•°æ®è¢«é‡å‘ä¹‹åè‹¥è¿˜æ˜¯æ”¶ä¸åˆ°ç¡®è®¤åº”ç­”ï¼Œåˆ™è¿›è¡Œå†æ¬¡å‘é€ã€‚æ­¤æ—¶ï¼Œç­‰å¾…ç¡®è®¤åº”ç­”çš„æ—¶é—´å°†ä¼šä»¥2å€ã€4å€çš„æŒ‡æ•°å‡½æ•°å»¶é•¿ã€‚ æ­¤å¤–ï¼Œæ•°æ®ä¹Ÿä¸ä¼šè¢«æ— é™ã€åå¤åœ°é‡å‘ã€‚è¾¾åˆ°ä¸€å®šé‡å‘æ¬¡æ•°ä¹‹åï¼Œå¦‚æœä»æ²¡æœ‰ä»»ä½•ç¡®è®¤åº”ç­”è¿”å›ï¼Œå°±ä¼šåˆ¤æ–­ä¸ºç½‘ç»œæˆ–å¯¹ç«¯ä¸»æœºå‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼ºåˆ¶å…³é—­è¿æ¥ã€‚å¹¶ä¸”é€šçŸ¥åº”ç”¨é€šä¿¡å¼‚å¸¸å¼ºè¡Œç»ˆæ­¢ã€‚ 3.3ä»¥æ®µä¸ºå•ä½å‘é€æ•°æ® åœ¨å»ºç«‹ TCP è¿æ¥çš„åŒæ—¶ï¼Œä¹Ÿå¯ä»¥ç¡®å®šå‘é€æ•°æ®åŒ…çš„å•ä½ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°å…¶ä¸ºâ€œæœ€å¤§æ¶ˆæ¯é•¿åº¦â€ï¼ˆMSSï¼‰ã€‚æœ€ç†æƒ³çš„æƒ…å†µæ˜¯ï¼Œæœ€å¤§æ¶ˆæ¯é•¿åº¦æ­£å¥½æ˜¯ IP ä¸­ä¸ä¼šè¢«åˆ†ç‰‡å¤„ç†çš„æœ€å¤§æ•°æ®é•¿åº¦ã€‚ TCP åœ¨ä¼ é€å¤§é‡æ•°æ®æ—¶ï¼Œæ˜¯ä»¥ MSS çš„å¤§å°å°†æ•°æ®è¿›è¡Œåˆ†å‰²å‘é€ã€‚è¿›è¡Œé‡å‘æ—¶ä¹Ÿæ˜¯ä»¥ MSS ä¸ºå•ä½ã€‚ MSS åœ¨ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å€™ï¼Œåœ¨ä¸¤ç«¯ä¸»æœºä¹‹é—´è¢«è®¡ç®—å¾—å‡ºã€‚ä¸¤ç«¯çš„ä¸»æœºåœ¨å‘å‡ºå»ºç«‹è¿æ¥çš„è¯·æ±‚æ—¶ï¼Œä¼šåœ¨ TCP é¦–éƒ¨ä¸­å†™å…¥ MSS é€‰é¡¹ï¼Œå‘Šè¯‰å¯¹æ–¹è‡ªå·±çš„æ¥å£èƒ½å¤Ÿé€‚åº”çš„ MSS çš„å¤§å°ã€‚ç„¶åä¼šåœ¨ä¸¤è€…ä¹‹é—´é€‰æ‹©ä¸€ä¸ªè¾ƒå°çš„å€¼æŠ•å…¥ä½¿ç”¨ã€‚ 3.4åˆ©ç”¨çª—å£æ§åˆ¶æé«˜é€Ÿåº¦ TCP ä»¥1ä¸ªæ®µä¸ºå•ä½ï¼Œæ¯å‘é€ä¸€ä¸ªæ®µè¿›è¡Œä¸€æ¬¡ç¡®è®¤åº”ç­”çš„å¤„ç†ã€‚è¿™æ ·çš„ä¼ è¾“æ–¹å¼æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯åŒ…çš„å¾€è¿”æ—¶é—´è¶Šé•¿é€šä¿¡æ€§èƒ½å°±è¶Šä½ã€‚ ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTCP å¼•å…¥äº†çª—å£è¿™ä¸ªæ¦‚å¿µã€‚ç¡®è®¤åº”ç­”ä¸å†æ˜¯ä»¥æ¯ä¸ªåˆ†æ®µï¼Œè€Œæ˜¯ä»¥æ›´å¤§çš„å•ä½è¿›è¡Œç¡®è®¤ï¼Œè½¬å‘æ—¶é—´å°†ä¼šè¢«å¤§å¹…åœ°ç¼©çŸ­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€ç«¯ä¸»æœºï¼Œåœ¨å‘é€äº†ä¸€ä¸ªæ®µä»¥åä¸å¿…è¦ä¸€ç›´ç­‰å¾…ç¡®è®¤åº”ç­”ï¼Œè€Œæ˜¯ç»§ç»­å‘é€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š çª—å£å¤§å°å°±æ˜¯æŒ‡æ— éœ€ç­‰å¾…ç¡®è®¤åº”ç­”è€Œå¯ä»¥ç»§ç»­å‘é€æ•°æ®çš„æœ€å¤§å€¼ã€‚ä¸Šå›¾ä¸­çª—å£å¤§å°ä¸º4ä¸ªæ®µã€‚è¿™ä¸ªæœºåˆ¶å®ç°äº†ä½¿ç”¨å¤§é‡çš„ç¼“å†²åŒºï¼Œé€šè¿‡å¯¹å¤šä¸ªæ®µåŒæ—¶è¿›è¡Œç¡®è®¤åº”ç­”çš„åŠŸèƒ½ã€‚ 3.5æ»‘åŠ¨çª—å£æ§åˆ¶ ä¸Šå›¾ä¸­çš„çª—å£å†…çš„æ•°æ®å³ä¾¿æ²¡æœ‰æ”¶åˆ°ç¡®è®¤åº”ç­”ä¹Ÿå¯ä»¥è¢«å‘é€å‡ºå»ã€‚ä¸è¿‡ï¼Œåœ¨æ•´ä¸ªçª—å£çš„ç¡®è®¤åº”ç­”æ²¡æœ‰åˆ°è¾¾ä¹‹å‰ï¼Œå¦‚æœå…¶ä¸­éƒ¨åˆ†æ•°æ®å‡ºç°ä¸¢åŒ…ï¼Œé‚£ä¹ˆå‘é€ç«¯ä»ç„¶è¦è´Ÿè´£é‡ä¼ ã€‚ä¸ºæ­¤ï¼Œå‘é€ç«¯ä¸»æœºéœ€è¦è®¾ç½®ç¼“å­˜ä¿ç•™è¿™äº›å¾…è¢«é‡ä¼ çš„æ•°æ®ï¼Œç›´åˆ°æ”¶åˆ°ä»–ä»¬çš„ç¡®è®¤åº”ç­”ã€‚ åœ¨æ»‘åŠ¨çª—å£ä»¥å¤–çš„éƒ¨åˆ†åŒ…æ‹¬æœªå‘é€çš„æ•°æ®ä»¥åŠå·²ç»ç¡®è®¤å¯¹ç«¯å·²æ”¶åˆ°çš„æ•°æ®ã€‚å½“æ•°æ®å‘å‡ºåè‹¥å¦‚æœŸæ”¶åˆ°ç¡®è®¤åº”ç­”å°±å¯ä»¥ä¸ç”¨å†è¿›è¡Œé‡å‘ï¼Œæ­¤æ—¶æ•°æ®å°±å¯ä»¥ä»ç¼“å­˜åŒºæ¸…é™¤ã€‚ æ”¶åˆ°ç¡®è®¤åº”ç­”çš„æƒ…å†µä¸‹ï¼Œå°†çª—å£æ»‘åŠ¨åˆ°ç¡®è®¤åº”ç­”ä¸­çš„åºåˆ—å·çš„ä½ç½®ã€‚è¿™æ ·å¯ä»¥é¡ºåºåœ°å°†å¤šä¸ªæ®µåŒæ—¶å‘é€æé«˜é€šä¿¡æ€§èƒ½ã€‚è¿™ç§æœºåˆ¶ä¹Ÿåˆ«ç§°ä¸ºæ»‘åŠ¨çª—å£æ§åˆ¶ã€‚ 3.6çª—å£æ§åˆ¶ä¸­çš„é‡å‘æ§åˆ¶ åœ¨ä½¿ç”¨çª—å£æ§åˆ¶ä¸­ï¼Œ å‡ºç°ä¸¢åŒ…ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š â‘  ç¡®è®¤åº”ç­”æœªèƒ½è¿”å›çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®å·²ç»åˆ°è¾¾å¯¹ç«¯ï¼Œæ˜¯ä¸éœ€è¦å†è¿›è¡Œé‡å‘çš„ï¼Œå¦‚ä¸‹å›¾ï¼š â‘¡ æŸä¸ªæŠ¥æ–‡æ®µä¸¢å¤±çš„æƒ…å†µã€‚æ¥æ”¶ä¸»æœºå¦‚æœæ”¶åˆ°ä¸€ä¸ªè‡ªå·±åº”è¯¥æ¥æ”¶çš„åºåˆ—å·ä»¥å¤–çš„æ•°æ®æ—¶ï¼Œä¼šé’ˆå¯¹å½“å‰ä¸ºæ­¢æ”¶åˆ°æ•°æ®è¿”å›ç¡®è®¤åº”ç­”ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“æŸä¸€æŠ¥æ–‡æ®µä¸¢å¤±åï¼Œå‘é€ç«¯ä¼šä¸€ç›´æ”¶åˆ°åºå·ä¸º1001çš„ç¡®è®¤åº”ç­”ï¼Œå› æ­¤ï¼Œåœ¨çª—å£æ¯”è¾ƒå¤§ï¼Œåˆå‡ºç°æŠ¥æ–‡æ®µä¸¢å¤±çš„æƒ…å†µä¸‹ï¼ŒåŒä¸€ä¸ªåºåˆ—å·çš„ç¡®è®¤åº”ç­”å°†ä¼šè¢«é‡å¤ä¸æ–­åœ°è¿”å›ã€‚è€Œå‘é€ç«¯ä¸»æœºå¦‚æœè¿ç»­3æ¬¡æ”¶åˆ°åŒä¸€ä¸ªç¡®è®¤åº”ç­”ï¼Œå°±ä¼šå°†å…¶å¯¹åº”çš„æ•°æ®è¿›è¡Œé‡å‘ã€‚è¿™ç§æœºåˆ¶æ¯”ä¹‹å‰æåˆ°çš„è¶…æ—¶ç®¡ç†æ›´åŠ é«˜æ•ˆï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸ºé«˜é€Ÿé‡å‘æ§åˆ¶ã€‚ 4.TCPç¼–ç¨‹æµç¨‹ 4.1é•¿è¿æ¥ä¸çŸ­è¿æ¥ é•¿è¿æ¥ é•¿è¿æ¥æŒ‡çš„æ˜¯ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹ä¹‹é—´åˆ†å¤šæ¬¡ä¼ é€’å®Œæ‰€æœ‰æ•°æ®ï¼Œä¼šé•¿æ—¶é—´å ç”¨æŸä¸ªå¥—æ¥å­—ï¼Œä¾‹å¦‚åœ¨çº¿çœ‹è§†é¢‘ã€æ‰“æ¸¸æˆå°±æ˜¯é•¿è¿æ¥ çŸ­è¿æ¥ çŸ­è¿æ¥æŒ‡çš„æ˜¯ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹ä¹‹é—´ä¼ é€’å°‘éƒ¨åˆ†æ•°æ®ï¼Œå¤šæ¬¡æ¡æ‰‹æŒ¥æ‰‹æ‰ä¼ é€’å®Œæ‰€æœ‰æ•°æ®ï¼Œä¼šçŸ­æ—¶é—´å ç”¨æŸä¸ªå¥—æ¥å­—ï¼Œä¾‹å¦‚æµè§ˆå™¨é™æ€é¡µé¢å°±æ˜¯çŸ­è¿æ¥ï¼Œå› ä¸ºæµè§ˆå™¨é™æ€é¡µé¢å¯èƒ½ä¼šéå¸¸å¤šï¼Œè€Œæµè§ˆè€…ä¸ä¸€å®šä¼šå…¨éƒ¨é˜…è¯»å®Œï¼Œå› æ­¤æµè§ˆå™¨ä¼šå…ˆåŠ è½½ä¸€éƒ¨åˆ†é¡µé¢ï¼Œç„¶åæ–­å¼€è¿æ¥ï¼Œå°†è¿æ¥ç©ºé—²å‡ºæ¥æä¾›å…¶ä»–è¯·æ±‚ï¼Œç­‰åˆ°æµè§ˆè€…ç»§ç»­å¾€ä¸‹æµè§ˆå†æŠŠå‰©ä½™çš„å†…å®¹å»ºç«‹è¿æ¥å‘é€å®Œæˆ 4.2TCPç¼–ç¨‹æµç¨‹è¯´æ˜ è¿‡ç¨‹è¯´æ˜ æœåŠ¡ç«¯ 1.æœåŠ¡ç«¯åˆ›å»ºsocketå¥—æ¥å­—å¯¹è±¡ï¼Œç”¨äºæ”¶å‘æ•°æ® socket() 2.æœåŠ¡ç«¯ç»‘å®šè‡ªèº«çš„IPåŠç«¯å£ bind() 3.æœåŠ¡ç«¯è®¾ç½®æœ€å¤§è¿æ¥æ•° listen() è¿™é‡Œçš„æœ€å¤§è¿æ¥æ•°æŒ‡çš„æ˜¯ï¼ŒæœåŠ¡ç«¯è¾¾åˆ°æœ€å¤§è¿æ¥æ•°åï¼Œåç»­å¯ä»¥æ’é˜Ÿç­‰å¾…çš„è¯·æ±‚æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ•°å­—å°±ä¼šè¢«æœåŠ¡ç«¯æ‹’ç»æœåŠ¡ï¼Œä¾‹å¦‚listen(5)ï¼Œè¿™é‡Œè®¾ç½®ä¸º5ï¼Œå‡å¦‚æœåŠ¡å™¨è¾¾åˆ°äº†æœ€å¤§è¿æ¥æ•°1ä¸‡ï¼Œåˆ™å¯ä»¥æ’é˜Ÿç­‰å¾…çš„è¯·æ±‚æ•°ä¸º5 4.æœåŠ¡ç«¯åˆ›å»ºaccept()ï¼Œç­‰å¾…æ¥å—socketè¿æ¥ï¼ŒæœåŠ¡ç«¯çš„acceptä¼šä¸å®¢æˆ·ç«¯åˆ›å»ºçš„connectå»ºç«‹TCPä¸‰æ¬¡æ¡æ‰‹ å®¢æˆ·ç«¯ 1.å®¢æˆ·ç«¯åˆ›å»ºsocketå¥—æ¥å­—å¯¹è±¡ï¼Œç”¨äºæ”¶å‘æ•°æ® socket() 2.å®¢æˆ·ç«¯åˆ›å»ºconnectï¼Œç”¨äºè¿æ¥æœåŠ¡ç«¯ï¼Œconnectä¼šä¸æœåŠ¡ç«¯åˆ›å»ºçš„acceptå»ºç«‹TCPä¸‰æ¬¡æ¡æ‰‹ 5.åˆ›å»ºTCPæœåŠ¡å™¨ã€å®¢æˆ·ç«¯ 5.1æœ€lowç‰ˆTCPæœåŠ¡å™¨ã€å®¢æˆ·ç«¯ ç¼–å†™ä¸€ä¸ªæœ€ç®€å•çš„TCPæœåŠ¡å™¨ #å¯¼å…¥socketæ¨¡å— from socket import * #åˆ›å»ºsocketå¥—æ¥å­—ï¼Œç”¨äºtcpç›‘å¬ tcpSocket = socket(AF_INET,SOCK_STREAM) #ç»‘å®šæœåŠ¡ç«¯IPåœ°å€å’Œç«¯å£ tcpSocket.bind((\"127.0.0.1\",8080)) #è®¾ç½®æœ€å¤§è¿æ¥æ•°,è¿™é‡Œçš„æœ€å¤§è¿æ¥æ•°æŒ‡çš„æ˜¯æœåŠ¡ç«¯è¾¾åˆ°æœ€å¤§è¿æ¥æ•°åå¯ä»¥æ’é˜Ÿç­‰å¾…çš„è¯·æ±‚æ•° tcpSocket.listen(5) #åˆ›å»ºä¸€ä¸ªæ–°çš„å¥—æ¥å­—ï¼Œç­‰å¾…æ¥å—socketè¿æ¥ï¼Œäºæ”¶å‘æ•°æ®,æ¥å—åˆ°çš„æ•°æ®è§£æ„ä¸ºæ–°å¥—æ¥å­—å’Œå®¢æˆ·ç«¯IPåœ°å€ newTcpSocket,addr = tcpSocket.accept() #å‘é€æ•°æ®ï¼Œç¼–ç æ ¹æ®å®é™…æƒ…å†µæŒ‡å®š newTcpSocket.send(\"æˆ‘æ˜¯tcpæœåŠ¡ç«¯ï¼Œå¿«æ¥è¿æˆ‘ï¼\".encode()) print(newTcpSocket.recv(1024).decode()) #å‘é€å®Œæ•°æ®åå…³é—­ç”¨äºæ”¶å‘æ•°æ®çš„æ–°å¥—æ¥å­—å¯¹è±¡ newTcpSocket.close() #å…³é—­ç”¨äºç›‘å¬çš„å¥—æ¥å­—å¯¹è±¡ï¼Œå…³é—­åç¨‹åºä¸å†æ¥å—ä»»ä½•æ–°çš„å®¢æˆ·ç«¯è¿æ¥ tcpSocket.close() ç¼–å†™ä¸€ä¸ªæœ€ç®€å•çš„TCPå®¢æˆ·ç«¯ #å¯¼å…¥socketæ¨¡å— from socket import * #åˆ›å»ºsocketå¥—æ¥å­—å¯¹è±¡ tcpSocket = socket(AF_INET,SOCK_STREAM) #åˆ›å»ºconnectï¼Œç”¨äºè¿æ¥TCPæœåŠ¡å™¨ tcpSocket.connect((\"127.0.0.1\",8080)) #æ¥å—æ•°æ® recvData = tcpSocket.recv(1024) print(recvData.decode()) #å‘TCPæœåŠ¡ç«¯å‘é€æ•°æ® tcpSocket.send(\"æˆ‘æ˜¯tcpå®¢æˆ·ç«¯ï¼Œæˆ‘æ¥äº†ï¼\".encode()) #å…³é—­å¥—æ¥å­—å¯¹è±¡ tcpSocket.close() 5.2å•è¿›ç¨‹TCPæœåŠ¡å™¨ å•è¿›ç¨‹çš„TCPæœåŠ¡å™¨æ¯æ¬¡åªèƒ½æœåŠ¡ä¸€ä¸ªå®¢æˆ·ç«¯ #å¯¼å…¥socketæ¨¡å— from socket import * #åˆ›å»ºåªç”¨æ¥ç›‘å¬çš„å¥—æ¥å­—å¯¹è±¡ serverSocket = socket(AF_INET,SOCK_STREAM) #ç»‘å®šTCPæœåŠ¡ç«¯IPå’Œç«¯å£ addr = (\"192.168.34.90\",9999) serverSocket.bind(addr) #è®¾ç½®æœ€å¤§æ’é˜Ÿç­‰å¾…æ•° serverSocket.listen(3) #è¿™é‡Œè¦èƒ½å¤šæ¬¡å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼Œå› æ­¤å†™ä¸€ä¸ªwhileå¾ªç¯ while True: print(\"ä¸»è¿›ç¨‹ç­‰å¾…æ–°å®¢æˆ·ç«¯è¿æ¥\") #åˆ›å»ºacceptï¼Œç”¨æ¥ç­‰å¾…å®¢æˆ·ç«¯socketè¿æ¥ newSocket,clientAddr = serverSocket.accept() print(newSocket) #æ‰“å°ç»“æœ print(clientAddr) #æ‰“å°ç»“æœ ('192.168.34.90', 55255) #clientAddr[0]å°±æ˜¯å®¢æˆ·ç«¯çš„IPåœ°å€ï¼ŒclientAddr[1]å°±æ˜¯å®¢æˆ·ç«¯çš„ç«¯å£ print(f\"ä¸»è¿›ç¨‹æ¥ä¸‹æ¥è´Ÿè´£å¤„ç†{clientAddr[0]},ç«¯å£{clientAddr[1]}çš„è¯·æ±‚\") #ä¼ è¾“è¿‡ç¨‹å¯èƒ½ä¼šå‡ºé”™ï¼Œå› æ­¤å†™ä¸€ä¸ªå¼‚å¸¸å¤„ç†é¿å…ç¨‹åºå´©æºƒ try: while True: #æ¥å—æ•°æ®å¹¶è§£ç ï¼Œç¼–ç ç±»å‹æ ¹æ®å®é™…æƒ…å†µå¡«å†™ recvData = newSocket.recv(1024).decode() #åšä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœæ”¶åˆ°çš„æ•°æ®å†…å®¹é•¿åº¦å¤§äº0ï¼Œåˆ™è¯´æ˜æ˜¯åœ¨æ¥å—æ•°æ®ï¼Œå¹¶æ‰“å°æ¥å—çš„æ•°æ®ï¼Œéƒ½åˆ™å°±æç¤ºå®¢æˆ·ç«¯å·²å…³é—­ if len(recvData) > 0: print(f\"æ¥æ”¶åˆ°æ¥è‡ª{clientAddr[0]}ï¼Œç«¯å£{clientAddr[1]}çš„æ•°æ®:\",recvData) else: print(f\"{clientAddr[0]}å®¢æˆ·ç«¯å·²å…³é—­\") break except Exception: print(\"æ¥æ”¶æ•°æ®å‡ºé”™ï¼\") #æ— è®ºæ¥å—æ˜¯å¦æŠ¥é”™æœ€åéƒ½æ‰§è¡Œå…³é—­æ–°å»ºçš„ç”¨äºæ”¶å‘æ•°æ®çš„å¥—æ¥å­— finally: newSocket.close() break #å…³é—­ç”¨äºç›‘å¬çš„å¥—æ¥å­— serverSocket.close() TCPå®¢æˆ·ç«¯ç¼–å†™ #å¯¼å…¥socketæ¨¡å— from socket import * #åˆ›å»ºsocketå¥—æ¥å­—å¯¹è±¡ tcpSocket = socket(AF_INET,SOCK_STREAM) #åˆ›å»ºconnectï¼Œç”¨äºè¿æ¥TCPæœåŠ¡å™¨ tcpSocket.connect((\"192.168.34.90\",9999)) #å‘TCPæœåŠ¡ç«¯å‘é€æ•°æ® while True: s = input(\"è¯·è¾“å…¥è¦å‘é€çš„å†…å®¹>>>\") tcpSocket.send(s.encode()) #å¦‚æœå®¢æˆ·ç«¯è¾“å…¥çš„æ˜¯Qæˆ–è€…qï¼Œåˆ™å…³é—­å¥—æ¥å­—å¯¹è±¡å¹¶é€€å‡ºç¨‹åº if s.lower() == \"q\": tcpSocket.close() break æœåŠ¡ç«¯æ¥å—æœ¬æœºå®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯ æœåŠ¡ç«¯æ¥æ”¶å…¶ä»–æœºå™¨å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯ 5.3å¹¶å‘TCPæœåŠ¡å™¨ 5.3.1 setsockopt(SOL_SOCKET,SO_REUSEADDR,1ï¼‰æ–¹æ³• serSocket.setsockopt(SOL_SOCKET,SO_REUSEADDR,1ï¼‰ serSokcetæ˜¯å¥—æ¥å­—å¯¹è±¡å˜é‡åï¼Œæ­¤é€‰é¡¹æ„æ€ä¸ºé‡æ–°è®¾ç½®å¥—æ¥å­—é€‰é¡¹ï¼Œé‡å¤ä½¿ç”¨ç»‘å®šçš„ä¿¡æ¯ è¿™ä¹ˆåšçš„åŸå› ï¼Ÿ å½“æœ‰ä¸€ä¸ªæœ‰ç›¸åŒæœ¬åœ°åœ°å€å’Œç«¯å£çš„socket1å¤„äºTIME_WAITçŠ¶æ€æ—¶ï¼Œè€Œä½ å¯åŠ¨çš„ç¨‹åºçš„socket2è¦å ç”¨è¯¥åœ°å€å’Œç«¯å£ï¼Œä½ çš„ç¨‹åºå°±è¦ç”¨åˆ°SO_REUSEADDRé€‰é¡¹ã€‚ åœ¨å¤šè¿›ç¨‹ä¸­çš„ä½œç”¨ï¼Ÿ ä½¿ç”¨å¤šè¿›ç¨‹ç¼–å†™å¹¶å‘TCPæœåŠ¡ï¼Œå› ä¸ºæœ‰å¤šä¸ªå­è¿›ç¨‹å¯ä»¥æä¾›æœåŠ¡ï¼Œå› æ­¤æ¯ä¸ªå­è¿›ç¨‹éœ€è¦å ç”¨ä¸»è¿›ç¨‹çš„ç«¯å£ï¼Œä½†æ˜¯ç«¯å£åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹å ç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±å‡ºç°äº†ç«¯å£è¢«å ç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥ç”¨åˆ°äº†setsockopt(SOL_SOCKET,SO_REUSEADDR,1ï¼‰æ–¹æ³• åœ¨å¤šçº¿ç¨‹ä¸­çš„ä½œç”¨ï¼Ÿ ä½¿ç”¨å¤šçº¿ç¨‹ç¼–å†™å¹¶å‘TCPæœåŠ¡ï¼Œçº¿ç¨‹ä¹‹é—´æ˜¯å…±äº«æ•°æ®çš„ï¼Œä¸å­˜åœ¨ç«¯å£è¢«å ç”¨æƒ…å†µï¼Œä½†æ˜¯å¤šçº¿ç¨‹ä¸­æ¯ä¸ªå­çº¿ç¨‹ä½¿ç”¨ä¸»è¿›ç¨‹çš„ç«¯å£åï¼Œç³»ç»Ÿä¼šä¿ç•™å‡ åˆ†é’Ÿç«¯å£è¢«å ç”¨çš„çŠ¶æ€ï¼Œä¸è®©åˆ«çš„çº¿ç¨‹ä½¿ç”¨ï¼Œä½¿ç”¨setsockopt(SOL_SOCKET,SO_REUSEADDR,1ï¼‰æ–¹æ³•è®©ç«¯å£ä¸è¢«ç³»ç»Ÿä¿ç•™ 5.3.2å¤šè¿›ç¨‹TCPæœåŠ¡å™¨ 5.3.3å¤šçº¿ç¨‹TCPæœåŠ¡å™¨ 6.sockeserver 6.1sockeserverä»‹ç» æ¦‚å¿µ socketserverå¯ä»¥å®ç°å’Œå¤šä¸ªå®¢æˆ·ç«¯é€šä¿¡ï¼ˆå®ç°å¹¶å‘å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚çš„SocketæœåŠ¡ç«¯ï¼‰ ä½œç”¨ å¯ä»¥ä½¿ç”¨socketserveræ¥åˆ›å»ºsocketç”¨æ¥ç®€åŒ–å¹¶å‘æœåŠ¡å™¨ åŸç† å®ƒæ˜¯åœ¨socketçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œä¹Ÿå°±æ˜¯è¯´åº•å±‚è¿˜æ˜¯è°ƒç”¨çš„socket å¤„ç†è¯·æ±‚è¿‡ç¨‹ æœåŠ¡å™¨æ¥å—å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ â¡ï¸ å®ä¾‹åŒ–ä¸€ä¸ªè¯·æ±‚å¤„ç†ç¨‹åº â¡ï¸ æ ¹æ®æœåŠ¡å™¨ç±»å’Œè¯·æ±‚å¤„ç†ç¨‹åºç±»ï¼Œè°ƒç”¨å¤„ç†æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼šåŸºæœ¬è¯·æ±‚ç¨‹åºç±»ï¼ˆBaseRequestHandlerï¼‰è°ƒç”¨æ–¹æ³• handle ã€‚æ­¤æ–¹æ³•é€šè¿‡å±æ€§ self.requestæ¥è®¿é—®å®¢æˆ·ç«¯å¥—æ¥å­— 7.è¿œç¨‹æ‰§è¡Œå‘½ä»¤subprocess 7.1subprocessä»‹ç» ä½œç”¨ pythonå¯ä»¥ä½¿ç”¨subprocessæ¨¡å—ä¸‹Popenç±»ä¸­å°è£…çš„æ–¹æ³•æ¥æ‰§è¡Œç³»ç»Ÿç»ˆç«¯å‘½ä»¤ è¯­æ³• obj = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE) //å‚æ•°è¯´æ˜ shell=True #å‘½ä»¤è§£é‡Šå™¨ï¼Œç›¸å½“äºè°ƒç”¨windowsä¸­çš„cmdæˆ–è€…macä¸­çš„ç»ˆç«¯æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ stdout=subprocess.PIPE #stdoutè¡¨ç¤ºæ­£ç¡®ç»“æœä¸¢åˆ°ç®¡é“ä¸­ stderr=subprocess.PIPE #stderrè¡¨ç¤ºé”™è¯¯ç»“æœä¸¢åˆ°ç®¡é“ä¸­ PIPE #PIPEè¡¨ç¤ºå°†ç»“æœè½¬ç§»åˆ°å½“å‰è¿›ç¨‹ subprocessæ–¹æ³• Popen() æ„é€ æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºPopenç±»çš„å®ä¾‹åŒ–å¯¹è±¡ stdout.read() stderr.read() å¯ä»¥è·å–å‘½ä»¤æ‰§è¡Œçš„ç»“æœ(æ­£ç¡®çš„ä¸é”™è¯¯çš„) 7.2subprocessä½¿ç”¨ç¤ºä¾‹ import subprocess while True: cmd = input(\"è¯·è¾“å…¥å‘½ä»¤>>>\") obj = subprocess.Popen(cmd, shell = True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, ) error = obj.stderr.read().decode(\"utf-8\") out = obj.stdout.read().decode(\"utf-8\") print(error + out) if cmd.lower() == \"q\": break æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œè¾“å…¥å‘½ä»¤ï¼Œå°±ä¼šæœ‰è¿”å›ç»“æœ âš ï¸windowsä¸­çš„ç³»ç»Ÿç¼–ç æ˜¯GBKï¼Œmacä¸­çš„æ˜¯utf-8 æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonåŸºç¡€/27.pythonåŸºç¡€äºŒåä¸ƒ pythonæ“ä½œmysql.html":{"url":"python/pythonåŸºç¡€/27.pythonåŸºç¡€äºŒåä¸ƒ pythonæ“ä½œmysql.html","title":"pythonåŸºç¡€äºŒåä¸ƒ pythonæ“ä½œmysql","keywords":"","body":"pythonåŸºç¡€äºŒåä¸ƒ pythonæ“ä½œmysql 1.å®‰è£…pymysql pip3 install pymysql 2.pythonè¿æ¥mysql 2.1pythonè¿æ¥mysqlè¯­æ³• //å¯¼å…¥pymysqlæ¨¡å— import pymysql //æ‰“å¼€æ•°æ®åº“è¿æ¥ âš ï¸âš ï¸âš ï¸æŒ‡å®šå­—ç¬¦é›†çš„æ—¶å€™utf-8åœ¨è¿™é‡Œçš„å†™æ³•ä¸ºutf8 conn = pymysql.connect(\"æ•°æ®åº“ip\",\"ç”¨æˆ·\",\"å¯†ç \",\"æ•°æ®åº“\",\"ç«¯å£(ä¸å†™é»˜è®¤ä¸º3306)\",\"å­—ç¬¦é›†\") //ä½¿ç”¨cursor()æ–¹æ³•è·å–æ“ä½œæ¸¸æ ‡ cursor = conn.cursor() //ä½¿ç”¨execute()æ–¹æ³•æ‰§è¡ŒSQLæ“ä½œ cursor.execute(\"SQLè¯­å¥\") //ä½¿ç”¨fetchone()æ–¹æ³•è·å–å•æ¡æ•°æ® data = cursor.fetchone() print (\"Database version : %s \" %data) //å…³é—­æ¸¸æ ‡ cursor.close() //å…³é—­æ•°æ®åº“è¿æ¥ conn.close() 2.2pythonè¿æ¥mysqlç®€å•æŸ¥è¯¢ç¤ºä¾‹ //æ•°æ®åº“db1ä¸­æœ‰ä¸€å¼ t1è¡¨ï¼Œè¡¨å†…å®¹å¦‚ä¸‹ mysql> select * from t1; +------+--------+ | id | name | +------+--------+ | 1 | å°æ˜ | | 2 | å°é¢– | | 3 | å°ä¸½ | +------+--------+ 3 rows in set (0.00 sec) //æ¥ä¸‹æ¥è¿æ¥æ•°æ®åº“è¿›è¡Œæ“ä½œ #å¯¼å…¥pymysqlæ¨¡å— import pymysql #æ‰“å¼€æ•°æ®åº“è¿æ¥ conn = pymysql.connect( host='xxx', user='xxx', password=\"xxx\", database='db1', port=3306, charset='utf8', ) #åˆ›å»ºæ¸¸æ ‡ cursor = conn.cursor() #å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œå­˜æ”¾sqlè¯­å¥ sql = 'select * from t1' #ä½¿ç”¨execute()æ–¹æ³•æ‰§è¡Œsqlæ“ä½œ cursor.execute(sql) #ä½¿ç”¨fetchall()æ–¹æ³•è·å–æ‰€æœ‰æ•°æ® data = cursor.fetchall() #æ‰“å°æŸ¥è¯¢çš„å†…å®¹ print(data) ((1, 'å°æ˜'), (2, 'å°é¢–'), (3, 'å°ä¸½')) #å…³é—­æ¸¸æ ‡ cursor.close() #å…³é—­è¿æ¥ conn.close() 3.pythonæ“ä½œmysql 3.1åˆ›å»ºè¡¨æ“ä½œ #å¯¼å…¥pymysqlæ¨¡å— import pymysql #æ‰“å¼€æ•°æ®åº“è¿æ¥ db = pymysql.connect(\"localhost\",\"testuser\",\"test123\",\"TESTDB\" ) #ä½¿ç”¨cursor()æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ¸¸æ ‡å¯¹è±¡cursor cursor = db.cursor() #ä½¿ç”¨execute()æ–¹æ³•æ‰§è¡Œ SQLï¼Œå¦‚æœè¡¨å­˜åœ¨åˆ™åˆ é™¤ cursor.execute(\"drop table if exists t2\") #ä½¿ç”¨é¢„å¤„ç†è¯­å¥åˆ›å»ºè¡¨ sql = \"\"\"create table t2( id int not null, age int not null, name char(10) not null, hobby set('å”±','è·³','rap','ç¯®çƒ'))\"\"\" #æ‰§è¡Œsqlè¯­å¥ cursor.execute(sql) #æŸ¥çœ‹ç»“æœ mysql> show tables; +---------------+ | Tables_in_db1 | +---------------+ | t1 | | t2 | +---------------+ 2 rows in set (0.00 sec) mysql> desc t2; +-------+---------------------------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+---------------------------------+------+-----+---------+-------+ | id | int(11) | NO | | NULL | | | age | int(11) | NO | | NULL | | | name | char(10) | NO | | NULL | | | hobby | set('å”±','è·³','rap','ç¯®çƒ') | YES | | NULL | | +-------+---------------------------------+------+-----+---------+-------+ 4 rows in set (0.00 sec) #å…³é—­æ¸¸æ ‡ cursor.clos() #å…³é—­æ•°æ®åº“è¿æ¥ conn.close() 3.2æ•°æ®æ“ä½œ 3.2.1æŸ¥è¯¢æ“ä½œ pythonæ“ä½œmysqlæ—¶è·å–æ•°æ®çš„æ–¹æ³•æœ‰3ç§ cursor.fetchone() #æŸ¥è¯¢è¿”å›ä¸€æ¡ç»“æœ cursor.fetchmany(n) #æŸ¥è¯¢è¿”å›æŒ‡å®šçš„æ¡æ•°ï¼Œnä¸ºæ•°å­— cursor.fetchall() #æŸ¥è¯¢è¿”å›æ‰€æœ‰çš„ç»“æœ //æ•°æ®åº“db1ä¸­æœ‰ä¸€å¼ t1è¡¨ï¼Œè¡¨å†…å®¹å¦‚ä¸‹ mysql> select * from t1; +------+--------+ | id | name | +------+--------+ | 1 | å°æ˜ | | 2 | å°é¢– | | 3 | å°ä¸½ | +------+--------+ 3 rows in set (0.00 sec) //ä½¿ç”¨cursor.fetchone()æ–¹æ³•è·å–ä¸€æ¡ç»“æœ data = cursor.fetchone() print(data) (1, 'å°æ˜') //ä½¿ç”¨cursor.fetchmany(n)æ–¹æ³•æŒ‡å®šè·å–çš„å†…å®¹ä¸ªæ•°ï¼Œnä¸ºæ•°å­— #fetchmanyä¸æŒ‡å®šè·å–ä¸ªæ•°æ—¶è¿”å›çš„å†…å®¹ data = cursor.fetchmany() print(data) ((1, 'å°æ˜'),) #fetchmanyæŒ‡å®šè·å–ä¸ªæ•°æ—¶è¿”å›çš„å†…å®¹ data = cursor.fetchmany(2) print(data) ((1, 'å°æ˜'), (2, 'å°é¢–')) //ä½¿ç”¨cursor.fetchall()æ–¹æ³•è·å–å…¨éƒ¨å†…å®¹ data = cursor.fetchall() print(data) ((1, 'å°æ˜'), (2, 'å°é¢–'), (3, 'å°ä¸½')) fetchæ–¹æ³•è¿”å›çš„ç»“æœéƒ½æ˜¯å…ƒç»„ï¼Œæ²¡æ³•çœ‹å‡ºå“ªä¸ªæ•°æ®æ˜¯å¯¹åº”çš„å“ªä¸ªå­—æ®µï¼Œå¯ä»¥é‡‡ç”¨å­—å…¸çš„æ–¹å¼æ˜¾ç¤ºï¼Œè¿™æ ·çœ‹èµ·æ¥æ¯”è¾ƒæ˜ç¡® å¯ä»¥åœ¨åˆ›å»ºæ¸¸æ ‡çš„æ—¶å€™ï¼ŒåŠ ä¸Šä¸€ä¸ªå‚æ•°è®©è¿”å›çš„ç»“æœæ˜¯å­—å…¸æ ¼å¼å±•ç¤º //åˆ›å»ºæ¸¸æ ‡çš„æ—¶å€™åŠ ä¸Šä¸€ä¸ªå‚æ•°cursor=pymysql.cursors.DictCursorè®©è¿”å›çš„ç»“æœæ˜¯å­—å…¸æ ¼å¼ cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) data = cursor.fetchall() print(data) [{'id': 1, 'name': 'å°æ˜'}, {'id': 2, 'name': 'å°é¢–'}, {'id': 3, 'name': 'å°ä¸½'}] 3.2.2å¢åŠ æ•°æ®æ“ä½œ //æ•°æ®åº“ä¸­t2è¡¨å†…å®¹ä¸ºç©º mysql> desc t2; +-------+---------------------------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------+---------------------------------+------+-----+---------+-------+ | id | int(11) | NO | | NULL | | | age | int(11) | NO | | NULL | | | name | char(10) | NO | | NULL | | | hobby | set('å”±','è·³','rap','ç¯®çƒ') | YES | | NULL | | +-------+---------------------------------+------+-----+---------+-------+ 4 rows in set (0.00 sec) mysql> select * from t2; Empty set (0.00 sec) //ç°åœ¨å‘t2è¡¨ä¸­æ’å…¥æ•°æ® import pymysql conn = pymysql.connect( host='xxx', user='pptfz', password=\"xxx\", database='db1', port=3306, charset='utf8', ) cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) sql = \"\"\" insert into t2 values(1,18,'å°æ˜','å”±,ç¯®çƒ'), (2,20,'å°é¢–','å”±,è·³'), (3,28,'å°å¤','å”±,è·³,rap,ç¯®çƒ') \"\"\" cursor.execute(sql) conn.commit() conn.close() //æŸ¥çœ‹ç»“æœ sql = 'select * from t2' cursor.execute(sql) data = cursor.fetchall() print(data) [{'id': 1, 'age': 18, 'name': 'å°æ˜', 'hobby': 'å”±,ç¯®çƒ'}, {'id': 2, 'age': 20, 'name': 'å°é¢–', 'hobby': 'å”±,è·³'}, {'id': 3, 'age': 28, 'name': 'å°å¤', 'hobby': 'å”±,è·³,rap,ç¯®çƒ'}] 3.2.3åˆ é™¤æ•°æ®æ“ä½œ #åˆ›å»ºæ¸¸æ ‡ cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) #sqlè¯­å¥ sql = 'delete from t2 where id=3' #æ‰§è¡Œsqlæ“ä½œï¼Œå‘ç”Ÿé”™è¯¯å›æ»š try: cursor.execute(sql) conn.commit() except: conn.rollback() #å…³é—­è¿æ¥ conn.close() 3.2.4ä¿®æ”¹æ•°æ®æ“ä½œ #åˆ›å»ºæ¸¸æ ‡ cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) #sqlè¯­å¥ sql = 'update t2 set age=30 where id=2' #æ‰§è¡Œsqlæ“ä½œï¼Œå‘ç”Ÿé”™è¯¯å›æ»š try: cursor.execute(sql) conn.commit() except: conn.rollback() #å…³é—­è¿æ¥ conn.close() 4.execute()ä¹‹sqlæ³¨å…¥ 4.1å…ˆåšä¸€ä¸ªç®€å•çš„ç™»é™†è®¤è¯ âš ï¸è¿™é‡Œçš„ç¤ºä¾‹æœ‰sqlæ³¨å…¥çš„é—®é¢˜ï¼Œä¼šåœ¨åè¾¹çš„ç¤ºä¾‹ä¸­è§£å†³ //userinfoè¡¨å†…å®¹å¦‚ä¸‹ mysql> select * from userinfo; +-------+-------+ | uname | pwd | +-------+-------+ | admin | admin | +-------+-------+ 1 row in set (0.00 sec) //æ¥ä¸‹æ¥åšä¸€ä¸ªå•ä¸€çš„åˆ¤æ–­ #å¯¼å…¥pymysql import pymysql #è¿æ¥mysql conn = pymysql.connect( host='xxx', user='pptfz', password=\"xxx\", database='db1', port=3306, charset='utf8', ) #åˆ›å»ºæ¸¸æ ‡ cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) #è¾“å…¥ç”¨æˆ·æ°‘å…±å’Œå¯†ç  uname = input('è¯·è¾“å…¥ç”¨æˆ·å>>>') password = input('è¯·è¾“å…¥å¯†ç >>>') #æ‰§è¡Œsqlè¯­å¥ï¼Œè¿”å›ç»“æœå¤§äº1è¯´æ˜ç”¨æˆ·åå’Œå¯†ç å­˜åœ¨ï¼Œå¦åˆ™å°±æ˜¯ä¸å­˜åœ¨ sql = \"select * from userinfo where uname='%s' and pwd='%s'\"%(uname,password) #æ‰§è¡Œsqlè¯­å¥ cursor.execute(sql) #æŸ¥è¯¢çš„ç»“æœ data = cursor.fetchone() #åšåˆ¤æ–­ if data: print('ç™»é™†æˆåŠŸ') else: print('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯') conn.close() æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š å½“è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç å­˜åœ¨äºuserinfoè¡¨ä¸­æ—¶ï¼Œè¿™é‡Œä¸ºå›ºå®šçš„ç”¨æˆ·åaminå¯†ç adminè¿”å›ç™»é™†æˆåŠŸï¼Œå¦åˆ™è¿”å›ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¿™æ ·å°±åšäº†ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ç™»é™†è®¤è¯ ç™»é™†æˆåŠŸ ç™»é™†å¤±è´¥ 4.2sqlæ³¨å…¥ç®€å•ç¤ºä¾‹ 4.2.1ç¤ºä¾‹1 æ¥ä¸‹æ¥åšä¸€ä¸ªæ“ä½œï¼Œåœ¨è¾“å…¥ç”¨æˆ·åçš„æ—¶å€™ï¼Œåœ¨ç”¨æˆ·ååè¾¹åŠ ä¸€ä¸ªå•å¼•å·ï¼Œç„¶åç©ºæ ¼ï¼Œç„¶åå†™ä¸Š--ï¼Œæœ€å--çš„åé¢å†™ä¸Šä»»æ„å­—ç¬¦ï¼Œè¿™æ ·å°±èƒ½åœ¨çŸ¥é“ç”¨æˆ·åçš„æƒ…å†µä¸‹ä¸éœ€è¦è¾“å…¥å¯†ç å°±å¯ä»¥ç™»é™†æˆåŠŸ import pymysql conn = pymysql.connect( host='xxx', user='pptfz', password=\"xxx\", database='db1', port=3306, charset='utf8', ) cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) uname = input('è¯·è¾“å…¥ç”¨æˆ·å>>>') password = input('è¯·è¾“å…¥å¯†ç >>>') # sql = f'select * from userinfo where uname=\"{uname}\" and pwd=\"{password}\"' sql = \"select * from userinfo where uname='%s' and pwd='%s';\"%(uname,password) cursor.execute(sql) # data = cursor.fetchall() data = cursor.fetchone() if data: print('ç™»é™†æˆåŠŸ') else: print('ç™»é™†å¤±è´¥') conn.close() åˆ†æä¸€ä¸‹ç»“æœ æ­¤æ—¶unameè¿™ä¸ªå˜é‡ç­‰äºadmin' -- xxxï¼Œsqlè¯­å¥è¢«å­—ç¬¦ä¸²æ›¿æ¢ä¹‹åä¼šå˜æˆå¦‚ä¸‹ select * from userinfo where uname='admin' -- xxx' and pwd=''; å…¶ä¸­adminåè¾¹çš„'ï¼Œåœ¨è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¾“å…¥çš„æ˜¯admin'ï¼Œè¿™ä¸ªå¼•å·å’Œå‰è¾¹çš„å¼•å·ç»„æˆäº†ä¸€å¯¹ï¼Œä¹Ÿå°±æ˜¯select * from userinfo where uname='admin'' -- xxx and pwd='' --åœ¨sqlè¯­å¥ä¸­æ˜¯æ³¨é‡Šçš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´åé¢çš„è¯­å¥è¢«æ³¨é‡Šäº†ï¼Œæ­¤æ—¶çš„sqlè¯­å¥å˜æˆäº†select * from usrinfo where uname='admin'ï¼Œåè¾¹çš„' -- xxx and pwd=''å˜æˆäº†æ³¨é‡Š è¿™æ ·çš„è¯å°±æ˜¯çŸ¥é“ç”¨æˆ·åå³å¯ç™»é™†æˆåŠŸï¼Œè¿™å°±æ˜¯æœ€ç®€å•çš„sqlæ³¨é‡Š 4.2.2ç¤ºä¾‹2 ç”¨æˆ·åå’Œå¯†ç éƒ½ä¸éœ€è¦è¾“å…¥å°±èƒ½ç™»é™†æˆåŠŸ oråè¾¹è·Ÿäº†ä¸€ä¸ªæ°¸çœŸçš„æ¡ä»¶ï¼Œå› æ­¤ä¸ç®¡è¾“å…¥ä»€ä¹ˆéƒ½èƒ½ç™»é™†æˆåŠŸ æœ‰äº›ç½‘ç«™ç›´æ¥åœ¨è¾“å…¥å†…å®¹çš„æ—¶å€™ï¼Œå°±é™å®šäº†ä¸èƒ½è¾“å…¥ä¸€äº›ç‰¹æ®Šçš„ç¬¦å·ï¼Œå› ä¸ºæœ‰äº›ç‰¹æ®Šç¬¦å·å¯ä»¥æ”¹å˜sqlçš„æ‰§è¡Œé€»è¾‘ï¼Œå…¶å®ä¸å…‰æ˜¯--ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç¬¦å·ä¹Ÿèƒ½æ”¹å˜sqlè¯­å¥çš„æ‰§è¡Œé€»è¾‘ï¼Œè¿™ä¸ªæ–¹æ¡ˆæ˜¯åœ¨å®¢æˆ·ç«¯ç»™ç”¨æˆ·è¾“å…¥çš„åœ°æ–¹è¿›è¡Œé™åˆ¶ï¼Œä½†æ˜¯åˆ«äººå¯ä¸å¯ä»¥æ¨¡æ‹Ÿä½ çš„å®¢æˆ·ç«¯æ¥å‘é€è¯·æ±‚ï¼Œæ˜¯å¯ä»¥çš„ï¼Œä»–æ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸æŒ‰ç…§ä½ çš„å®¢æˆ·ç«¯çš„è¦æ±‚æ¥ï¼Œå°±å‘ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œä½ çš„å®¢æˆ·ç«¯æ˜¯é™åˆ¶ä¸äº†çš„ã€‚ ã€‹æ‰€ä»¥å•çº¯çš„åœ¨å®¢æˆ·ç«¯è¿›è¡Œè¿™ä¸ªç‰¹æ®Šå­—ç¬¦çš„è¿‡æ»¤æ˜¯ä¸èƒ½è§£å†³æ ¹æœ¬é—®é¢˜çš„ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬æœåŠ¡ç«¯ä¹Ÿéœ€è¦è¿›è¡ŒéªŒè¯ï¼Œå¯ä»¥é€šè¿‡æ­£åˆ™æ¥å°†å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„å†…å®¹è¿›è¡Œç‰¹æ®Šå­—ç¬¦çš„åŒ¹é…ï¼Œå¦‚æœæœ‰è¿™äº›ç‰¹æ®Šå­—ç¬¦ï¼Œæˆ‘ä»¬å°±è®©å®ƒç™»é™†å¤±è´¥ã€‚ åœ¨æœåŠ¡ç«¯æ¥è§£å†³sqlæ³¨å…¥çš„é—®é¢˜ï¼šä¸è¦è‡ªå·±æ¥è¿›è¡Œsqlå­—ç¬¦ä¸²çš„æ‹¼æ¥äº†ï¼Œpymysqlèƒ½å¸®æˆ‘ä»¬æ‹¼æ¥ï¼Œä»–èƒ½å¤Ÿé˜²æ­¢sqlæ³¨å…¥ï¼Œæ‰€ä»¥ä»¥åæˆ‘ä»¬å†å†™sqlè¯­å¥çš„æ—¶å€™æŒ‰ä¸‹é¢çš„æ–¹å¼å†™ï¼š //ä¹‹å‰æˆ‘ä»¬çš„sqlè¯­å¥æ˜¯è¿™æ ·å†™çš„ï¼š sql = \"select * from userinfo where uname='%s' and pwd='%s';\"%(uname,passwdor) //ä»¥åå†å†™çš„æ—¶å€™ï¼Œsqlè¯­å¥é‡Œé¢çš„%så·¦å³çš„å¼•å·å»æ‰ï¼Œå¹¶ä¸”è¯­å¥åé¢çš„%(uname,pword)è¿™äº›å†…å®¹ä¹Ÿä¸è¦è‡ªå·±å†™äº†ï¼ŒæŒ‰ç…§ä¸‹é¢çš„æ–¹å¼å†™ sql = \"select * from userinfo where username=%s and password=%s;\" //éš¾é“æˆ‘ä»¬ä¸ä¼ å€¼äº†å—ï¼Œä¸æ˜¯çš„ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„å½¢å¼ï¼Œåœ¨excuteé‡Œé¢å†™å‚æ•°ï¼š å…¶å®å®ƒæœ¬è´¨ä¹Ÿæ˜¯å¸®ä½ è¿›è¡Œäº†å­—ç¬¦ä¸²çš„æ›¿æ¢ï¼Œåªä¸è¿‡å®ƒä¼šå°†unameå’Œpasswordé‡Œé¢çš„ç‰¹æ®Šå­—ç¬¦ç»™è¿‡æ»¤æ‰ cursor.execute(sql,[uname,password]) ä½¿ç”¨cursor.executeæ–¹æ³•æ‰§è¡Œsqlè¯­å¥æ­£ç¡®å†™æ³• import pymysql conn = pymysql.connect( host='xxx', user='pptfz', password=\"xxx\", database='db1', port=3306, charset='utf8', ) cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) uname = input('è¯·è¾“å…¥ç”¨æˆ·å>>>') password = input('è¯·è¾“å…¥å¯†ç >>>') # sql = f'select * from userinfo where uname=\"{uname}\" and pwd=\"{password}\"' sql = \"select * from userinfo where uname=%s and pwd=%s\" cursor.execute(sql,[uname,password]) # data = cursor.fetchall() data = cursor.fetchone() if data: print('ç™»é™†æˆåŠŸ') else: print('ç™»é™†å¤±è´¥') conn.close() ä½¿ç”¨4.2.1ç¤ºä¾‹1ä¸­çš„å†™æ³•ç™»é™†ï¼Œä¼šæç¤ºç™»é™†å¤±è´¥ ä½¿ç”¨4.2.2ç¤ºä¾‹2ä¸­çš„å†™æ³•ç™»é™†ï¼Œä¼šæç¤ºç™»é™†å¤±è´¥ è¿™æ ·ä½¿ç”¨cursor.executeæ–¹æ³•å°±è§£å†³äº†ç®€å•sqlæ³¨å…¥çš„é—®é¢˜ï¼Œå› æ­¤ä»¥åçš„ä»»æ„è¯­å¥éƒ½å¿…é¡»ä½¿ç”¨æ­¤å†™æ³•æ¥ä»£æ›¿æˆ‘ä»¬è‡ªå·±å†™çš„å­—ç¬¦ä¸²æ›¿æ¢ cursor.execute(sql,[uname,password]) 4.3sqlæ³¨å…¥ç®€å•æ€»ç»“ 4.3.1sqlæ³¨å…¥çš„ä¸¤ç§æ–¹æ³• ä¸¤ç§sqlæ³¨å…¥æ–¹æ³• 1ã€sqlæ³¨å…¥ä¹‹ï¼šç”¨æˆ·å­˜åœ¨ï¼Œç»•è¿‡å¯†ç  ç”¨æˆ·å' -- ä»»æ„å­—ç¬¦ 2ã€sqlæ³¨å…¥ä¹‹ï¼šç”¨æˆ·ä¸å­˜åœ¨ï¼Œç»•è¿‡ç”¨æˆ·ä¸å¯†ç  ç”¨æˆ·å' or 1=1 -- ä»»æ„å­—ç¬¦ 4.3.2é€šè¿‡pymysqlæä¾›çš„excute()æ–¹æ³•è§£å†³äº†ç®€å•sqlæ³¨å…¥é—®é¢˜ //åŸæ¥æ˜¯æˆ‘ä»¬å¯¹sqlè¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ sql=\"select * from userinfo where uname='%s' and pwd='%s'\" %(uname,password) print(sql) data = cursor.execute(sql) //æ”¹å†™ä¸ºexecuteå¸®æˆ‘ä»¬åšå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæˆ‘ä»¬æ— éœ€ä¸”ä¸€å®šä¸èƒ½å†ä¸º%såŠ å¼•å·äº† sql=\"select * from userinfo where uname=%s and pwd=%s\" //âš ï¸%séœ€è¦å»æ‰å¼•å·ï¼Œå› ä¸ºpymysqlä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬åŠ ä¸Š data = cursor.execute(sql,[uname,password]) #pymysqlæ¨¡å—è‡ªåŠ¨å¸®æˆ‘ä»¬è§£å†³sqlæ³¨å…¥çš„é—®é¢˜ï¼Œåªè¦æˆ‘ä»¬æŒ‰ç…§pymysqlçš„è§„çŸ©æ¥ã€‚ âš ï¸âš ï¸âš ï¸sqlè¯­å¥ä¸è¦è‡ªå·±æ‹¼æ¥ï¼Œäº¤ç»™pymysqlæä¾›çš„executeæ–¹æ³•è§£å†³ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonè¿›é˜¶/django/1.djangoåˆ›å»ºé¡¹ç›®.html":{"url":"python/pythonè¿›é˜¶/django/1.djangoåˆ›å»ºé¡¹ç›®.html","title":"djangoåŸºç¡€ä¸€ åˆ›å»ºé¡¹ç›®","keywords":"","body":"1.djangoåˆ›å»ºé¡¹ç›® 1.1æ–¹å¼ä¸€ å‘½ä»¤åˆ›å»ºé¡¹ç›® ç¬¬ä¸€æ­¥ã€å®‰è£…django pip3 install django==1.11.9 ç¬¬äºŒæ­¥ã€åˆ›å»ºé¡¹ç›® åˆ›å»ºä¸€ä¸ªç›®å½•å¹¶åˆ‡æ¢åˆ°è¿™ä¸ªç›®å½•ä¸‹ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºé¡¹ç›® django-admin startproject é¡¹ç›®åç§° åˆ›å»ºé¡¹ç›®æ—¶é‡åˆ°çš„é¡¹ç›®åç§°é—®é¢˜ï¼Œä¸èƒ½åŠ  -ï¼Œå¯ä»¥åŠ  _ ç¬¬ä¸‰æ­¥ã€åˆ›å»ºåº”ç”¨ è¿›å…¥åˆ°åˆ›å»ºçš„é¡¹ç›®ç›®å½•ä¸­ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ python3 manage.py startapp åº”ç”¨åç§° ç¬¬å››æ­¥ã€ä¿®æ”¹é…ç½®æ–‡ä»¶ #åˆ›å»ºçš„é¡¹ç›®è·¯å¾„ project01å°±æ˜¯é¡¹ç›® /jetBrains/pycharm/django/project01 #åˆ›å»ºçš„åº”ç”¨çš„è·¯å¾„ app03å°±æ˜¯åº”ç”¨ /jetBrains/pycharm/django/project01/app03 #ä¿®æ”¹çš„é…ç½®æ–‡ä»¶çš„è·¯å¾„ åˆ›å»ºçš„é¡¹ç›®ä¸‹åŒåçš„ç›®å½•ä¸­çš„settings.py /jetBrains/pycharm/django/project01/project01 ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼Œæ·»åŠ åˆ›å»ºçš„åº”ç”¨åç§° å¤§æ¦‚åœ¨40è¡Œ INSTALLED_APPS = [ 'django.contrib.admin', 'django.contrib.auth', 'django.contrib.contenttypes', 'django.contrib.sessions', 'django.contrib.messages', 'django.contrib.staticfiles', 'app03', #æœ€åä¸€è¡Œæ·»åŠ åˆ›å»ºçš„åº”ç”¨åç§°,å°†é¡¹ç›®å’Œåº”ç”¨å…³è”åˆ°ä¸€èµ· ] ç¬¬äº”æ­¥ã€å¯åŠ¨é¡¹ç›® å¦‚æœç«¯å£ä¸å†™ï¼Œé»˜è®¤æ˜¯8000 å¦‚æœIPåœ°å€å’Œç«¯å£å·éƒ½ä¸å†™ï¼Œé»˜è®¤æ˜¯127.0.0.1:8000 python3 manage.py runserver 127.0.0.1:8001 ç¬¬å…­æ­¥ã€æµè§ˆå™¨è®¿é—® 127.0.0.1:8001 åˆ°æ­¤ï¼Œæœ€åŸºæœ¬çš„djangoåˆ›å»ºé¡¹ç›®ã€åº”ç”¨ã€å¯åŠ¨å®Œæˆ ç”¨pycharmæ‰“å¼€åˆ›å»ºçš„djangoé¡¹ç›® 1.2æ–¹å¼äºŒ åˆ©ç”¨pycharmåˆ›å»ºé¡¹ç›® File-->New Project æ‰“å¼€pycharmåˆ›å»ºçš„djangoé¡¹ç›® 1.3é¡¹ç›®ç›®å½•æ–‡ä»¶ä»‹ç» manage.py -----> Djangoé¡¹ç›®é‡Œé¢çš„å·¥å…·ï¼Œé€šè¿‡å®ƒå¯ä»¥è°ƒç”¨django shellå’Œæ•°æ®åº“ï¼Œå¯åŠ¨å…³é—­é¡¹ç›®ä¸é¡¹ç›®äº¤äº’ç­‰ï¼Œä¸ç®¡ä½ å°†æ¡†æ¶åˆ†äº†å‡ ä¸ªæ–‡ä»¶ï¼Œå¿…ç„¶æœ‰ä¸€ä¸ªå¯åŠ¨æ–‡ä»¶ï¼Œå…¶å®ä»–ä»¬æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ settings.py -----> åŒ…å«äº†é¡¹ç›®çš„é»˜è®¤è®¾ç½®ï¼ŒåŒ…æ‹¬æ•°æ®åº“ä¿¡æ¯ï¼Œè°ƒè¯•æ ‡å¿—ä»¥åŠå…¶ä»–ä¸€äº›å·¥ä½œçš„å˜é‡ urls.py -----> è´Ÿè´£æŠŠURLæ¨¡å¼æ˜ å°„åˆ°åº”ç”¨ç¨‹åº wsgi.py -----> runserverå‘½ä»¤å°±ä½¿ç”¨wsgirefæ¨¡å—åšç®€å•çš„web serverï¼Œåé¢ä¼šçœ‹åˆ°renserverå‘½ä»¤ï¼Œæ‰€æœ‰ä¸socketç›¸å…³çš„å†…å®¹éƒ½åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢äº† 1.4MVCå’ŒMTVæ¨¡å¼ MVCæ¨¡å¼ WebæœåŠ¡å™¨å¼€å‘é¢†åŸŸé‡Œè‘—åçš„MVCæ¨¡å¼ï¼Œæ‰€è°“MVCå°±æ˜¯æŠŠWebåº”ç”¨åˆ†ä¸ºæ¨¡å‹(M)ï¼Œæ§åˆ¶å™¨(C)å’Œè§†å›¾(V)ä¸‰å±‚ï¼Œä»–ä»¬ä¹‹é—´ä»¥ä¸€ç§æ’ä»¶å¼çš„ã€æ¾è€¦åˆçš„æ–¹å¼è¿æ¥åœ¨ä¸€èµ·ï¼Œæ¨¡å‹è´Ÿè´£ä¸šåŠ¡å¯¹è±¡ä¸æ•°æ®åº“çš„æ˜ å°„(ORM)ï¼Œè§†å›¾è´Ÿè´£ä¸ç”¨æˆ·çš„äº¤äº’(é¡µé¢)ï¼Œæ§åˆ¶å™¨æ¥å—ç”¨æˆ·çš„è¾“å…¥è°ƒç”¨æ¨¡å‹å’Œè§†å›¾å®Œæˆç”¨æˆ·çš„è¯·æ±‚ï¼Œå…¶ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š MTVæ¨¡å¼(djangoä¸­çš„æ¨¡å¼) Djangoçš„MTVæ¨¡å¼æœ¬è´¨ä¸Šå’ŒMVCæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿæ˜¯ä¸ºäº†å„ç»„ä»¶é—´ä¿æŒæ¾è€¦åˆå…³ç³»ï¼Œåªæ˜¯å®šä¹‰ä¸Šæœ‰äº›è®¸ä¸åŒï¼ŒDjangoçš„MTVåˆ†åˆ«æ˜¯å€¼ï¼š M ä»£è¡¨æ¨¡å‹ï¼ˆModelï¼‰ï¼š è´Ÿè´£ä¸šåŠ¡å¯¹è±¡å’Œæ•°æ®åº“çš„å…³ç³»æ˜ å°„(ORM) T ä»£è¡¨æ¨¡æ¿ (Template)ï¼šè´Ÿè´£å¦‚ä½•æŠŠé¡µé¢å±•ç¤ºç»™ç”¨æˆ·(html) V ä»£è¡¨è§†å›¾ï¼ˆViewï¼‰ï¼š è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶åœ¨é€‚å½“æ—¶å€™è°ƒç”¨Modelå’ŒTemplate ã€€ã€€é™¤äº†ä»¥ä¸Šä¸‰å±‚ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ªURLåˆ†å‘å™¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªä¸ªURLçš„é¡µé¢è¯·æ±‚åˆ†å‘ç»™ä¸åŒçš„Viewå¤„ç†ï¼ŒViewå†è°ƒç”¨ç›¸åº”çš„Modelå’ŒTemplateï¼ŒMTVçš„å“åº”æ¨¡å¼å¦‚ä¸‹æ‰€ç¤ºï¼š è¿‡ç¨‹ 1.ç”¨æˆ·è¾“å…¥urlè®¿é—®ï¼Œè¯·æ±‚å‘é€è‡³è§†å›¾ 2.è§†å›¾çš„ä¸šåŠ¡é€»è¾‘æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ï¼Œè§†å›¾åˆ¤æ–­è¯·æ±‚çš„ç±»å‹ å¦‚æœæ˜¯é™æ€é¡µé¢ï¼Œä»æ¨¡ç‰ˆä¸­è·å–é™æ€htmlæ–‡ä»¶è¿”å›ç»™è§†å›¾ï¼Œå†ç”±è§†å›¾è¿”å›ç»™ç”¨æˆ· å¦‚æœæ˜¯åŠ¨æ€é¡µé¢ï¼Œè§†å›¾å°†è¯·æ±‚å‘é€è‡³æ¨¡å‹ï¼Œæ¨¡å‹ä»æ•°æ®åº“ä¸­è·å–æ•°æ®è¿”å›ç”¨æˆ· 3.ç”¨æˆ·çš„è¯·æ±‚æœ€ç»ˆç”±è§†å›¾è¿”å›ç»™ç”¨æˆ· æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonè¿›é˜¶/django/2.django urlsè·¯ç”±.html":{"url":"python/pythonè¿›é˜¶/django/2.django urlsè·¯ç”±.html","title":"djangoåŸºç¡€äºŒ urlsè·¯ç”±","keywords":"","body":"2.urlsè·¯ç”± 2.1urlsè·¯ç”±ä½¿ç”¨ç¤ºä¾‹ åœ¨é¡¹ç›®ç›®å½•ä¸­çš„urlsæ–‡ä»¶ä¸­ç¼–å†™è·¯ç”±è§„åˆ™ from django.conf.urls import url from django.contrib import admin from app01 import views #è¿™ä¸€è¡Œä¸ºå¯¼å…¥åº”ç”¨ä¸­çš„viewsæ–‡ä»¶(ç”¨äºå†™ä¸šåŠ¡é€»è¾‘) urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^index/$', views.index), #è¿™ä¸€è¡Œè‡ªå®šä¹‰ä¸€ä¸ªè®¿é—®è·¯å¾„ ] éœ€è¦åœ¨urlsæ–‡ä»¶ä¸­å¼•å…¥åº”ç”¨ç¨‹åºä¸­çš„views åœ¨åº”ç”¨ç¨‹åºä¸­çš„viewsæ–‡ä»¶ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘ from django.shortcuts import render # Create your views here. def index(request): return render(request,'index.html') #ç¼–å†™å‡½æ•°ï¼Œè¿”å›index.htmlé¡µé¢ï¼Œå‡½æ•°ä¸­çš„requestå‚æ•°ä¸ºé»˜è®¤å†™æ³•ï¼Œåç§°éšæ„ï¼Œrenderæ–¹æ³•ç”¨äºè¿”å›ç»™viewè§†å›¾index.htmlæ–‡ä»¶ï¼Œå†ç”±viewè§†å›¾è¿”å›ç»™ç”¨æˆ· è‡ªå®šä¹‰çš„å‡½æ•°ä¸­éœ€è¦ä¼ å…¥ä¸€ä¸ªrequestå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å°è£…äº†æ‰€æœ‰çš„è¯·æ±‚ç›¸å…³ä¿¡æ¯ï¼Œè¿™ä¸ªrequestæ˜¯ä¸€ä¸ªå¯¹è±¡ è§†å›¾ä¸­éœ€è¦ç”¨åˆ°render()æ–¹æ³•ï¼Œrenderä¸­éœ€è¦ç”¨åˆ°requestå‚æ•°ï¼Œå¹¶ä¸”è¿”å›templatesç›®å½•ä¸‹çš„htmlæ–‡ä»¶ ä¸ºä»€ä¹ˆè¿™é‡Œrenderæ–¹æ³•ä¸­å†™ä¸€ä¸ªhtmlæ–‡ä»¶å°±èƒ½è¿”å›ç»™ç”¨æˆ·å‘¢ï¼Œåœ¨é¡¹ç›®ä¸‹åŒåçš„ç›®å½•ä¸­çš„settingsé…ç½®æ–‡ä»¶ä¸­TEMPLATESä¸€é¡¹(å…³äºæ¨¡ç‰ˆhtmlæ–‡ä»¶çš„é…ç½®) 'DIRS': [os.path.join(BASE_DIR, 'templates')] os.path.join(BASE_DIR,'templates') BASE_DIRåœ¨å¼€å¤´import oså¤„å®šä¹‰å¦‚ä¸‹ BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__))) __file__æ˜¯å½“å‰æ–‡ä»¶ os.path.abspathå½“å‰æ–‡ä»¶ç»å¯¹è·¯å¾„ os.path.dirnameæ‰¾åˆ°å½“å‰æ–‡ä»¶ä¸Šå±‚ç›®å½• ä¸¤ä¸ªos.path.dirnameå°±æ‰¾åˆ°äº†é¡¹ç›®ç›®å½•ï¼Œå› æ­¤BASE_DIRå°±æ˜¯é¡¹ç›®ç›®å½• å†å›å¤´çœ‹'DIRS': [os.path.join(BASE_DIR, 'templates')] BASE_DIRå°±æ˜¯é¡¹ç›®ç›®å½•ï¼Œå’Œtemplatesç›®å½•åšäº†ä¸€ä¸ªæ‹¼æ¥ï¼Œå› æ­¤åœ¨renderæ–¹æ³•ä¸­ç›´æ¥å†™htmlæ–‡ä»¶å°±èƒ½æ‰¾åˆ° é¡¹ç›®/templates/htmlæ–‡ä»¶ åœ¨templatesç›®å½•ä¸‹åˆ›å»ºindex.htmlæ–‡ä»¶ Title ç¬¬ä¸€æ¬¡djangoä½¿ç”¨ å¦‚æœè¦æƒ³ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ªhtmlé¡µé¢ï¼Œéœ€è¦åœ¨é¡¹ç›®ä¸‹çš„templatesä¸­ç¼–è¾‘htmlæ–‡ä»¶ æµè§ˆå™¨è®¿é—® è¿™æ ·å°±æ˜¯ä¸€ä¸ªç®€å•çš„djangoä½¿ç”¨ç¤ºä¾‹ å…³äºurlè·¯å¾„æœ€åè¾¹çš„æ–œæ è¯´æ˜ï¼Œä¾‹å¦‚ index/ url(r'^home/', views.home) å‰ç½®å¯¼èˆªæ–œæ ä¸éœ€è¦å†™,åé¢çš„æ–œæ æ˜¯æ ¹æ®djangoçš„é…ç½®æ¥çš„,å¦‚æœåœ¨settingsé…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬è®¾ç½®äº†APPEND_SLASH = False,é‚£ä¹ˆæµè§ˆå™¨å‘é€æ¥çš„è¯·æ±‚å¦‚æœæ²¡æœ‰å¸¦ç€åé¢çš„æ–œæ ,ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸è¯·æ±‚çš„,ä½†æ˜¯å¦‚æœæ²¡æœ‰è¿™ä¸ªé…ç½®çš„è¯,djangoè¦æ±‚æµè§ˆå™¨å¿…é¡»å¸¦ç€è·¯å¾„åé¢çš„æ–œæ æ¥è¿›è¡Œè®¿é—®,å¦‚æœä½ è¾“å…¥è·¯å¾„çš„æ—¶å€™æ²¡æœ‰åŠ /,é‚£ä¹ˆdjangoè®©ä½ çš„æµè§ˆå™¨å‘ä¸€ä¸ªé‡å®šå‘è¯·æ±‚å¸¦ä¸Š/ æ¯”å¦‚ï¼Œè®¿é—®çš„æ—¶å€™åªå†™äº†indexï¼Œdjangoä¼šè®©æµè§ˆå™¨å†æ¬¡å‘é€ä¸€ä¸ªé‡å®šå‘è¯·æ±‚index/ 2.2urlåˆ«åå’Œå‘½åç©ºé—´ urlåˆ«åçš„ä½œç”¨æ˜¯å½“ä¿®æ”¹äº†urlçš„è®¿é—®è·¯å¾„ï¼Œè§†å›¾é€»è¾‘ä¸­è¿”å›çš„urlè·¯å¾„ä¹Ÿéœ€è¦æ”¹åŠ¨ï¼Œå…¶ä»–ç›¸å…³è”çš„åœ°æ–¹ä¹Ÿå¯èƒ½éœ€è¦æ”¹åŠ¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨urlä¸­å®šä¹‰ä¸€ä¸ªåˆ«åï¼Œå¦‚æœåç»­æ›´æ”¹äº†urlçš„è®¿é—®è·¯å¾„ï¼Œå…¶ä»–åœ°æ–¹åªéœ€è¦ç”¨åˆ°urlåˆ«åçš„åå‘è§£æå°±èƒ½è‡ªåŠ¨æ‰¾åˆ°åˆ«åå¯¹åº”çš„urlè·¯å¾„ï¼Œè¿™æ ·çš„è¯åªéœ€è¦ä¿®æ”¹urlè·¯å¾„è€Œä¸æ›´æ”¹å…¶ä½™åœ°æ–¹ å†™æ³•: url(r'^login/v2/', views.login,name='login'), è§†å›¾ä¸­åå‘è§£æ: from django.urls import reverse def login(request): print(reverse('login')) #/login/v2/ if request.method == 'GET': return render(request,'login.html') else: uname = request.POST.get('uname') pwd = request.POST.get('pwd') if uname == 'admin' and pwd == 'admin': return HttpResponse('ok') else: return redirect(reverse('login')) #ä½¿ç”¨åå‘è§£æ htmlæ¨¡æ¿æ¸²æŸ“æ—¶åå‘è§£æçš„è¯­æ³•{% url åˆ«å %} {% csrf_token %} ç”¨æˆ·å: å¯†ç : 2.3urlåˆ«ååå‘è§£æå‚æ•° åœ¨urlsæ–‡ä»¶ä¸­å®šä¹‰çš„urlè·¯å¾„ä¸­å¦‚æœæœ‰æ­£åˆ™åŒ¹é…ï¼Œé‚£ä¹ˆåœ¨è§†å›¾å‡½æ•°ä¸­è¿›è¡Œurlåˆ«ååå‘è§£æçš„æ—¶å€™å°±éœ€è¦å¸¦ä¸Šå‚æ•°äº†ï¼Œè€Œå¸¦å‚æ•°åˆåˆ†ä¸ºæ— ååˆ†ç»„å’Œæœ‰ååˆ†ç»„ 2.3.1urlæ— ååˆ†ç»„ä¼ å‚æ–¹å¼ args=(å‚æ•°1,) urlsæ–‡ä»¶ä¸­å®šä¹‰urlè·¯å¾„å¦‚ä¸‹æ‰€ç¤º url(r'book1/1/', views.book,name='book1'), url(r'book2/(\\d+)/', views.book,name='book2'), ç°åœ¨æƒ³åšçš„æ•ˆæœæ˜¯è®¿é—®book1/1/ç„¶åé‡å®šå‘åˆ°book2ï¼Œè§†å›¾æ–‡ä»¶å†…å®¹å¦‚ä¸‹ def book1(request): return redirect('book2') def book2(request): return HttpResponse('book2') è¿™ä¸ªæ—¶å€™è®¿é—®127.0.0.1/book/1ä¼šæŠ¥é”™ï¼Œå› ä¸ºbook2çš„urlæ˜¯æœ‰æ­£åˆ™åŒ¹é…çš„ï¼Œè¿™ä¸ªæ—¶å€™æ²¡æœ‰ä¼ å‚æ•°ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™å¦‚ä¸‹ æ­¤æ—¶å°±éœ€è¦åœ¨urlåå‘è§£ææ—¶ä¼ å‚äº†ï¼Œurlsæ–‡ä»¶ä¸­çš„æ­£åˆ™åŒ¹é…æ˜¯æ— ååˆ†ç»„ï¼Œæ— ååˆ†ç»„çš„ä¼ å‚æ–¹å¼æ˜¯args=() from django.urls import reverse def book1(request): #urlæ— ååˆ†ç»„ä¼ å‚æ˜¯args return redirect(reverse('book2',args=(1,))) #urlsä¸­book2æœ‰æ— ååˆ†ç»„ï¼Œå› æ­¤éœ€è¦ä¼ ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°åä»»æ„ def book2(request,n): return HttpResponse('book2') ä¼ å‚åå†è®¿é—®å°±å¯ä»¥æ­£ç¡®é‡å®šå‘äº† 2.3.2urlæœ‰ååˆ†ç»„ä¼ å‚æ–¹å¼ kwargs={'åˆ†ç»„åç§°':'å‚æ•°'} urlsæ–‡ä»¶ä¸­å®šä¹‰urlè·¯å¾„å¦‚ä¸‹æ‰€ç¤º url(r'book1/1/', views.book1,name='book1'), #å®šä¹‰ä¸€ä¸ªæœ‰ååˆ†ç»„ï¼Œåç§°ä¸ºbook2 url(r'book2/(?P\\d+)/', views.book2,name='book2'), ç°åœ¨æƒ³åšçš„æ•ˆæœæ˜¯è®¿é—®book1/1/ç„¶åé‡å®šå‘åˆ°book2ï¼Œè§†å›¾æ–‡ä»¶å†…å®¹å¦‚ä¸‹ def book1(request): return redirect('book2') def book2(request): return HttpResponse('book2') è¿™ä¸ªæ—¶å€™è®¿é—®127.0.0.1/book/1ä¼šæŠ¥é”™ï¼Œå› ä¸ºbook2çš„urlæ˜¯æœ‰æ­£åˆ™åŒ¹é…çš„ï¼Œè¿™ä¸ªæ—¶å€™æ²¡æœ‰ä¼ å‚æ•°ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™å¦‚ä¸‹ æ­¤æ—¶å°±éœ€è¦åœ¨urlåå‘è§£ææ—¶ä¼ å‚äº†ï¼Œurlsæ–‡ä»¶ä¸­çš„æ­£åˆ™åŒ¹é…æ˜¯æœ‰ååˆ†ç»„ï¼Œæœ‰ååˆ†ç»„ä¼ å‚æ–¹å¼æ˜¯kwargs={'åˆ†ç»„åç§°':'å‚æ•°'} from django.urls import reverse def book1(request): #è¿™é‡Œæ˜¯urlæœ‰ååˆ†ç»„ä½ç½®ä¼ å‚ï¼Œpageå°±æ˜¯urlsæ–‡ä»¶ä¸­å®šä¹‰çš„urlæœ‰ååˆ†ç»„åç§° return redirect(reverse('book2',kwargs={'page':1})) #åœ¨è¦é‡å®šå‘çš„è·¯å¾„å‡½æ•°ä¸­ä¹Ÿéœ€è¦ä¼ é€’urlsæ–‡ä»¶ä¸­å®šä¹‰çš„urlæœ‰ååˆ†ç»„åç§° def book2(request,page): return HttpResponse('book2') ä¼ å‚åå†è®¿é—®å°±å¯ä»¥æ­£ç¡®é‡å®šå‘äº† æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonè¿›é˜¶/django/3.django è§†å›¾å‡½æ•°.html":{"url":"python/pythonè¿›é˜¶/django/3.django è§†å›¾å‡½æ•°.html","title":"djangoåŸºç¡€ä¸‰ è§†å›¾å‡½æ•°","keywords":"","body":"3.è§†å›¾å‡½æ•° 3.1requestå¯¹è±¡ request.path #request.pathå½“å‰è¯·æ±‚è·¯å¾„ request.method #å½“å‰è¯·æ±‚æ–¹æ³•(get,post...) request.GET #è·å–æ‰€æœ‰getè¯·æ±‚æºå¸¦è¿‡æ¥çš„æ•°æ® request.POST #è·å–æ‰€æœ‰postè¯·æ±‚æºå¸¦è¿‡æ¥çš„æ•°æ® request.body #è·å–æ‰€æœ‰postè¯·æ±‚æºå¸¦è¿‡æ¥çš„æ•°æ®çš„åŸå§‹æ ¼å¼ 3.2è§†å›¾å‡½æ•°ä½¿ç”¨å°ç¤ºä¾‹ urlsæ–‡ä»¶ urlpatterns = [ url(r'^admin/', admin.site.urls), #ç¼–å†™ä¸€ä¸ªloginç™»é™†è§†å›¾æ–‡ä»¶ url(r'^login/', views.login), ] viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse def login(request): if request.method == 'GET': return render(request,'login.html') else: uname = request.POST.get('username') pwd = request.POST.get('password') if uname == 'admin' and pwd == 'admin': return HttpResponse('ç™»é™†æˆåŠŸï¼') else: return HttpResponse('ç™»é™†å¤±è´¥!!!') htmlæ–‡ä»¶ Title {##} ç”¨æˆ·åï¼š å¯†ç ï¼š ä¸ºäº†éªŒè¯postè¯·æ±‚ï¼Œæ³¨é‡Šsettingsæ–‡ä»¶ä¸­çš„ä¸€è¡Œ Djangoé¡¹ç›®ä¸‹åŒåç›®å½•ä¸­çš„settingsæ–‡ä»¶ï¼Œ48è¡Œ MIDDLEWARE = [ 'django.middleware.security.SecurityMiddleware', 'django.contrib.sessions.middleware.SessionMiddleware', 'django.middleware.common.CommonMiddleware', # 'django.middleware.csrf.CsrfViewMiddleware', 'django.contrib.auth.middleware.AuthenticationMiddleware', 'django.contrib.messages.middleware.MessageMiddleware', 'django.middleware.clickjacking.XFrameOptionsMiddleware', ] æµè§ˆå™¨è®¿é—® é”™è¯¯çš„ç¤ºä¾‹ urlsæ–‡ä»¶ def login(request): if request.method == 'POST': return render(request,'login.html') else: uname = request.GET.get('username') pwd = request.GET.get('password') if uname == 'admin' and pwd == 'admin': return HttpResponse('ç™»é™†æˆåŠŸï¼') else: return HttpResponse('ç™»é™†å¤±è´¥!!!') htmlæ–‡ä»¶ Title {##} ç”¨æˆ·åï¼š å¯†ç ï¼š ä¸ºäº†éªŒè¯postè¯·æ±‚ï¼Œæ³¨é‡Šsettingsæ–‡ä»¶ä¸­çš„ä¸€è¡Œ Djangoé¡¹ç›®ä¸‹åŒåç›®å½•ä¸­çš„settingsæ–‡ä»¶ï¼Œ48è¡Œ MIDDLEWARE = [ 'django.middleware.security.SecurityMiddleware', 'django.contrib.sessions.middleware.SessionMiddleware', 'django.middleware.common.CommonMiddleware', # 'django.middleware.csrf.CsrfViewMiddleware', 'django.contrib.auth.middleware.AuthenticationMiddleware', 'django.contrib.messages.middleware.MessageMiddleware', 'django.middleware.clickjacking.XFrameOptionsMiddleware', ] æŒ‰ç…§ä¹‹å‰çš„ç†è§£åº”è¯¥æ˜¯ä¼šè¿”å›ç™»é™†ç•Œé¢ï¼Œå› ä¸ºæˆ‘login.htmlæ–‡ä»¶ä¸­formè¡¨å•å†™çš„è¯·æ±‚æ–¹æ³•æ˜¯postï¼Œè€Œviewsè§†å›¾æ–‡ä»¶ä¸­çš„é€»è¾‘åˆ¤æ–­æ˜¯å¦‚æœè¯·æ±‚æ˜¯poståˆ™è¿”å›ç™»é™†ç•Œé¢ï¼Œä½†æ˜¯å®é™…æƒ…å†µå¹¶ä¸æ˜¯è¿™æ · ä¸ºä»€ä¹ˆä¼šç›´æ¥è¿”å›ç™»é™†å¤±è´¥å‘¢ï¼Ÿ åŸå› ï¼šå½“æµè§ˆå™¨æ‰“å¼€é¡µé¢çš„æ—¶å€™ï¼Œé»˜è®¤çš„æ–¹æ³•å°±æ˜¯GETï¼Œå½“ç‚¹å‡»ç™»é™†é‚£ä¸€åˆ»æ‰ä¼šæ ¹æ®formè¡¨å•ä¸­çš„methodæŒ‡å®šçš„è¯·æ±‚ç±»å‹è€Œè¿›è¡Œè½¬å˜ï¼Œä½†æ˜¯ç°åœ¨ç›´æ¥å°±æ˜¯GETæ–¹æ³•ï¼Œå› æ­¤åœ¨loginå‡½æ•°çš„åˆ¤æ–­ä¸­å°±ç›´æ¥è·³åˆ°äº†ç¬¬ä¸€ä¸ªelseåé¢ï¼Œä½†æ˜¯æ­¤æ—¶æ ¹æœ¬å°±æ²¡æœ‰ç”¨æˆ·ç™»é™†ç•Œé¢å‡ºç°ï¼Œæ‰€ä»¥å°±æ— æ³•è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œæ‰€ä»¥ä¼šç›´æ¥æç¤ºç™»é™†å¤±è´¥ï¼ï¼ï¼ 3.3å“åº”æ–¹æ³• renderè¿”å›htmlé¡µé¢ HttpResponseè¿”å›å­—ç¬¦ä¸² redirect 3.3.1render è¿”å›htmlé¡µé¢ viewsæ–‡ä»¶ä¸­çš„å†™æ³• #éœ€è¦å¯¼å…¥HttpResponse from django.shortcuts import render,HttpResponse # Create your views here. def index(request): return render(request,'index.html') 3.3.2HttpResponse è¿”å›å­—ç¬¦ä¸² viewsæ–‡ä»¶ä¸­çš„å†™æ³• #éœ€è¦å¯¼å…¥HttpResponse from django.shortcuts import render,HttpResponse # Create your views here. #HttpResponseæ–¹æ³•ä¸­ç›´æ¥å†™å­—ç¬¦ä¸² def index(request): # return render(request,'index.html') return HttpResponse('HttpResponseæ–¹æ³•è¿”å›çš„æ˜¯å­—ç¬¦ä¸²') 3.3.3redirect é‡å®šå‘ FBVå†™æ³• urlsæ–‡ä»¶ urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^home/', views.home), url(r'^login/', views.login), ] viewsæ–‡ä»¶ #redirectæ–¹æ³•éœ€è¦å¯¼å…¥redirect from django.shortcuts import render,HttpResponse,redirect # Create your views here. def home(request): return HttpResponse('ç™»é™†æˆåŠŸ') def login(request): if request.method == 'GET': return render(request,'login.html') else: uname = request.POST.get('uname') pwd = request.POST.get('pwd') if uname == 'admin' and pwd == 'admin': # return HttpResponse('ç™»é™†æˆåŠŸ') return redirect('/home/') else: # return HttpResponse('ç™»é™†å¤±è´¥') return redirect('/login/') redictæ˜¯é‡å®šå‘ï¼Œä¹‹å‰æˆ‘ä»¬è®¿é—®çš„æ—¶å€™å¦‚æœç™»é™†å¤±è´¥å°±ç›´æ¥æç¤ºç™»é™†å¤±è´¥ ç°åœ¨ä½¿ç”¨äº†redicté‡å®šå‘ å¦‚æœç™»é™†æˆåŠŸå°±é‡å®šå‘åˆ°å¦ä¸€ä¸ªè·¯å¾„ä¸‹ï¼Œè¿™é‡Œæ˜¯/homeï¼Œä¹Ÿå°±æ˜¯ç™»é™†æˆåŠŸé¡µé¢ å¦‚æœç™»é™†å¤±è´¥å°±è¿˜æ˜¯é‡å®šå‘åˆ°è®¿é—®è·¯å¾„ä¸‹ï¼Œè¿™é‡Œæ˜¯/loginï¼Œä¹Ÿå°±æ˜¯ç™»é™†ç•Œé¢ CBVå†™æ³• urlsæ–‡ä»¶ urlpatterns = [ url(r'^admin/', admin.site.urls), # url(r'^login/', views.login), url(r'^login/', views.LoginView.as_view()), ] viewsæ–‡ä»¶ #redirectæ–¹æ³•éœ€è¦å¯¼å…¥redirect from django.shortcuts import render,HttpResponse,redirect from django.views import View #CBVå†™æ³•ä¸­éœ€è¦å¯¼å…¥View # Create your views here. def home(request): return HttpResponse('ç™»é™†æˆåŠŸ') class LoginView(View): def get(self,request): return render(request, 'login.html') def post(self,request): uname = request.POST.get('username') pwd = request.POST.get('password') if uname == 'admin' and pwd == 'admin': # return HttpResponse('ç™»é™†æˆåŠŸ') return redirect('/home/') else: # return HttpResponse('ç™»é™†å¤±è´¥') return redirect('/login/') redictæ˜¯é‡å®šå‘ï¼Œä¹‹å‰æˆ‘ä»¬è®¿é—®çš„æ—¶å€™å¦‚æœç™»é™†å¤±è´¥å°±ç›´æ¥æç¤ºç™»é™†å¤±è´¥ ç°åœ¨ä½¿ç”¨äº†redicté‡å®šå‘ å¦‚æœç™»é™†æˆåŠŸå°±é‡å®šå‘åˆ°å¦ä¸€ä¸ªè·¯å¾„ä¸‹ï¼Œè¿™é‡Œæ˜¯/homeï¼Œä¹Ÿå°±æ˜¯ç™»é™†æˆåŠŸé¡µé¢ å¦‚æœç™»é™†å¤±è´¥å°±è¿˜æ˜¯é‡å®šå‘åˆ°è®¿é—®è·¯å¾„ä¸‹ï¼Œè¿™é‡Œæ˜¯/loginï¼Œä¹Ÿå°±æ˜¯ç™»é™†ç•Œé¢ 3.4CBVå’ŒFBV 3.4.1å«ä¹‰ FBV:function based view :åŸºäºå‡½æ•°çš„è§†å›¾é€»è¾‘ CBV:class based view :åŸºäºç±»çš„è§†å›¾é€»è¾‘ 3.4.1CBV CBVä¸­urlå†™æ³• # url(r'^login/', views.login), url(r'^login/', views.LoginView.as_view()), CBVä¸­viewså†™æ³• from django.shortcuts import render,HttpResponse,redirect from django.views import View #CBVå†™æ³•ä¸­éœ€è¦å¯¼å…¥View # Create your views here. class LoginView(View): def get(self,request): return render(request, 'login.html') def post(self,request): uname = request.POST.get('username') pwd = request.POST.get('password') if uname == 'admin' and pwd == 'admin': # return HttpResponse('ç™»é™†æˆåŠŸ') return redirect('/home/') else: # return HttpResponse('ç™»é™†å¤±è´¥') return redirect('/login/') CBVä¸­æºç é‡ç‚¹ def dispatch(self, request, *args, **kwargs): #æ ¹æ®è¯·æ±‚æ–¹æ³•å»åˆ†å‘å¯¹åº”çš„ç±»å‘æ”¾æ¥æ‰§è¡Œ # Try to dispatch to the right method; if a method doesn't exist, # defer to the error handler. Also defer to the error handler if the # request method isn't on the approved list. if request.method.lower() in self.http_method_names: handler = getattr(self, request.method.lower(), self.http_method_not_allowed) #åå°„!!!! else: handler = self.http_method_not_allowed return handler(request, *args, **kwargs) CBVä¸­é‡å†™dispatchæ–¹æ³• class LoginView(View): def dispatch(self, request, *args, **kwargs): print(111) # print(request.META) #httpæ‰€æœ‰ç›¸å…³è¯·æ±‚å¤´ä¿¡æ¯ ret = super().dispatch(request, *args, **kwargs) #render(request, 'login.html') print(222) return ret def get(self,request): print('this is get method!!!') return render(request, 'login.html') def post(self,request): uname = request.POST.get('username') pwd = request.POST.get('password') if uname == 'admin' and pwd == 'admin': return redirect('/home/') else: return redirect('/login/') 3.4.2FBV FBVä¸­urlå†™æ³• url(r'^login/', views.login), #url(r'^login/', views.LoginView.as_view()), FBVä¸­viewså†™æ³• from django.shortcuts import render,HttpResponse,redirect # Create your views here. def login(request): if request.method == 'GET': return render(request,'login.html') else: uname = request.POST.get('uname') pwd = request.POST.get('pwd') if uname == 'admin' and pwd == 'admin': # return HttpResponse('ç™»é™†æˆåŠŸ') return redirect('/home/') else: # return HttpResponse('ç™»é™†å¤±è´¥') return redirect('/login/') 3.4.3CBVå’ŒFBVçš„è£…é¥°å™¨ def func(f): def foo(request): print(111) ret = f(request) print(222) return ret return foo #FBV æ¨¡å¼ä¸‹,å’Œæ™®é€šå‡½æ•°åŠ è£…é¥°å™¨æ˜¯ä¸€æ ·çš„å†™æ³• @func def home(request): print('home') return HttpResponse('ä½ æ‡‚ä»€ä¹ˆæ˜¯è£…é¥°å™¨å—ï¼Ÿ') CBVåŠ è£…é¥°çš„ä¸‰ä¸ªå§¿åŠ¿: # @method_decorator(func,name='get') ä½ç½®3 class LoginView(View): # @method_decorator(func) #ä½ç½®2 def dispatch(self, request, *args, **kwargs): print('aaaa') ret = super().dispatch(request, *args, **kwargs) #render(request, 'login.html') print('bbbb') return ret @method_decorator(func) #ä½ç½®1 def get(self,request): print('this is get method!!!') return render(request, 'login.html') def post(self,request): uname = request.POST.get('username') pwd = request.POST.get('password') if uname == 'admin' and pwd == 'admin': return redirect('/home/') else: return redirect('/login/') æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonè¿›é˜¶/django/4.django æ¨¡ç‰ˆæ¸²æŸ“.html":{"url":"python/pythonè¿›é˜¶/django/4.django æ¨¡ç‰ˆæ¸²æŸ“.html","title":"djangoåŸºç¡€å›› æ¨¡ç‰ˆæ¸²æŸ“","keywords":"","body":"4.æ¨¡ç‰ˆæ¸²æŸ“ 4.1settingsæ–‡ä»¶é…ç½® settingsé…ç½®æ–‡ä»¶ä¸­çš„TEMPLATESé¡¹æ˜¯å¯¹é™æ€é¡µé¢çš„è®¾ç½®ï¼ŒDIRSå¤„éœ€è¦å†™ä¸Šå¯¹åº”çš„é™æ€æ–‡ä»¶å­˜æ”¾çš„ä½ç½®ï¼Œé»˜è®¤ä¸ºtemplates TEMPLATES = [ { 'BACKEND': 'django.template.backends.django.DjangoTemplates', 'DIRS': [os.path.join(BASE_DIR, 'templates')] #åˆ«å¿˜äº†é…ç½®è¿™ä¸ªè·¯å¾„ , 'APP_DIRS': True, 'OPTIONS': { 'context_processors': [ 'django.template.context_processors.debug', 'django.template.context_processors.request', 'django.contrib.auth.context_processors.auth', 'django.contrib.messages.context_processors.messages', ], }, }, ] 4.2æ¨¡ç‰ˆè¯­æ³• åœ¨htmlæ–‡ä»¶æ ‡ç­¾ä¸­å†™ {{ å˜é‡ }} {% é€»è¾‘ %} 4.3ä¸‡èƒ½çš„ç‚¹ . htmlæ–‡ä»¶ ä»¥ä¸‹ä»£ç ä¸­dic.nameå°±æ˜¯.çš„è¿ç”¨ Title {{ num }} {{ str }} {{ lst }} {{ dic.name }} {# #æ³¨æ„,è°ƒç”¨æ–¹æ³•æ—¶,ä¸èƒ½åŠ æ‹¬å·,æ‰€æœ‰å¦‚æœæ–¹æ³•å¸¦å‚æ•°,å°±æ²¡æ³•ç”¨äº†#} {{ woman.play }} {{ woman.xx }} viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse,redirect from django.views import View #CBVè¿›ç¨‹çš„ç±» # Create your views here. def home(request): # return HttpResponse('ç™»é™†æˆåŠŸ') # return render(request,'index.html') num = 10 str = 'I am a running çš„è‰æ³¥é©¬' lst = [1,2,3,4,5,6] dic = {'name':'å°æ˜','age':20} class A: money = 100 def __init__(self): self.xx = 'oo' def play(self): return 'ä»€ä¹ˆä»·ä½ï¼Ÿ' woman = A() return render(request,'æ¨¡ç‰ˆæ¸²æŸ“.html',{'num':num,'str':str,'lst':lst,'dic':dic,'woman':woman}) è¿è¡Œåçš„åˆæ¬¡æ•ˆæœ 4.4è¿‡æ»¤å™¨ 4.4.1è¿‡æ»¤å™¨ç”¨æ³• æœ‰å‚æ•°çš„è¿‡æ»¤å™¨ç”¨æ³• {{ å˜é‡|è¿‡æ»¤å™¨åç§°:'å‚æ•°' }} æ²¡å‚æ•°çš„è¿‡æ»¤å™¨ç”¨æ³• {{ å˜é‡|è¿‡æ»¤å™¨åç§° }} 4.4.2å†…ç½®è¿‡æ»¤å™¨ viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse,redirect from django.views import View #CBVè¿›ç¨‹çš„ç±» # Create your views here. def home(request): # return HttpResponse('ç™»é™†æˆåŠŸ') # return render(request,'index.html') num = 10 str = 'I am a running çš„è‰æ³¥é©¬' lst = [1,2,3,4,5,6] dic = {'name':'å°æ˜','age':20} class A: money = 100 def __init__(self): self.xx = 'oo' def play(self): return 'ä»€ä¹ˆä»·ä½ï¼Ÿ' woman = A() return render(request,'æ¨¡ç‰ˆæ¸²æŸ“.html',{'num':num,'str':str,'lst':lst,'dic':dic,'woman':woman}) 4.4.2.1 truncatechars æˆªæ–­å­—ç¬¦ä¸² truncatechars:æ•°å­— æ•°å­—è¡¨ç¤ºè¦æˆªæ–­çš„å­—ç¬¦æ•° æœªæˆªæ–­å‰ æˆªæ–­å truncatechars:5è¡¨ç¤ºæˆªå–5ä¸ªå­—ç¬¦ï¼Œå…¶ä¸­åŒ…æ‹¬3ä¸ª. {{ str | truncatechars:5 }} 4.4.2.2 default å¦‚æœä¸€ä¸ªå˜é‡æ˜¯falseæˆ–è€…ä¸ºç©ºï¼Œä½¿ç”¨ç»™å®šçš„é»˜è®¤å€¼ã€‚ å¦åˆ™ï¼Œä½¿ç”¨å˜é‡çš„å€¼ åœ¨viewsæ–‡ä»¶ä¸­åªæœ‰numå˜é‡ï¼Œæ²¡æœ‰num1å˜é‡ï¼Œå› æ­¤ä½¿ç”¨defaultæŒ‡å®šçš„å€¼ {{ num1 | default:'æ²¡æœ‰num1è¿™ä¸ªå˜é‡' }} 4.4.2.3 length è·å–å˜é‡æ•°æ®é•¿åº¦ {{ lst | length }} 4.4.2.4 filesizeformat å¤§å°æŒ‰ç…§äººç±»å¯è¯»æ–¹å¼æ˜¾ç¤º viewsæ–‡ä»¶ä¸­å®šä¹‰file_size = 1024ï¼Œæ³¨æ„è¿˜éœ€è¦åœ¨renderæ–¹æ³•ä¸­ä»¥å­—å…¸çš„å½¢å¼å®šä¹‰è¿”å› {{ file_size | filesizeformat }} 4.4.2.5 slice åˆ‡ç‰‡(é¡¾å¤´ä¸é¡¾è…š) {{ str | slice:'2:9' }} ä½¿ç”¨åˆ‡ç‰‡æˆªå– 4.4.2.6 date æ—¥æœŸæ ¼å¼åŒ–æ˜¾ç¤º viewsæ–‡ä»¶ import datetime now = datetime.datetime.now() æ³¨æ„åœ¨renderæ–¹æ³•ä¸­è¿”å› htmlæ–‡ä»¶ {{ now | date:'Y-m-d H:i:s' }} 4.4.2.7 safe å…³é—­HTMLçš„è‡ªåŠ¨è½¬ä¹‰ safeæ˜¯é˜²æ­¢xssæ”»å‡»è®©ä¸€äº›jsã€htmlç­‰ç­‰ä»£ç å˜æˆæ™®é€šå­—ç¬¦è€Œä¸æ‰§è¡Œï¼Œä½†æœ‰çš„æ—¶å€™æˆ‘ä»¬æƒ³è¦æ‰§è¡Œè¿™äº›ä»£ç ï¼Œå°±éœ€è¦ç”¨åˆ°safe Djangoçš„æ¨¡æ¿ä¸­åœ¨è¿›è¡Œæ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™ä¼šå¯¹HTMLæ ‡ç­¾å’ŒJSç­‰è¯­æ³•æ ‡ç­¾è¿›è¡Œè‡ªåŠ¨è½¬ä¹‰ï¼ŒåŸå› æ˜¾è€Œæ˜“è§ï¼Œè¿™æ ·æ˜¯ä¸ºäº†å®‰å…¨ï¼Œdjangoæ‹…å¿ƒè¿™æ˜¯ç”¨æˆ·æ·»åŠ çš„æ•°æ®ï¼Œæ¯”å¦‚å¦‚æœæœ‰äººç»™ä½ è¯„è®ºçš„æ—¶å€™å†™äº†ä¸€æ®µjsä»£ç ï¼Œè¿™ä¸ªè¯„è®ºä¸€æäº¤ï¼Œjsä»£ç å°±æ‰§è¡Œå•¦ï¼Œè¿™æ ·å°±å¯ä»¥æä¸€äº›åäº‹å„¿äº†ï¼Œå†™ä¸ªå¼¹çª—çš„æ­»å¾ªç¯ï¼Œæµè§ˆå™¨ä¼šä¸€ç›´å¼¹çª—ï¼Œè¿™å«åšxssæ”»å‡»ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¸è®©ä½ è¿™ä¹ˆæï¼Œç»™ä½ è½¬ä¹‰äº†ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¸å¸Œæœ›è¿™äº›HTMLå…ƒç´ è¢«è½¬ä¹‰ï¼Œæ¯”å¦‚æˆ‘ä»¬åšä¸€ä¸ªå†…å®¹ç®¡ç†ç³»ç»Ÿï¼Œåå°æ·»åŠ çš„æ–‡ç« ä¸­æ˜¯ç»è¿‡ä¿®é¥°çš„ï¼Œè¿™äº›ä¿®é¥°å¯èƒ½æ˜¯é€šè¿‡ä¸€ä¸ªç±»ä¼¼äºFCKeditorç¼–è¾‘åŠ æ³¨äº†HTMLä¿®é¥°ç¬¦çš„æ–‡æœ¬ï¼Œå¦‚æœè‡ªåŠ¨è½¬ä¹‰çš„è¯æ˜¾ç¤ºçš„å°±æ˜¯ä¿æŠ¤HTMLæ ‡ç­¾çš„æºæ–‡ä»¶ã€‚ä¸ºäº†åœ¨Djangoä¸­å…³é—­HTMLçš„è‡ªåŠ¨è½¬ä¹‰æœ‰ä¸¤ç§æ–¹å¼ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå•ç‹¬çš„å˜é‡æˆ‘ä»¬å¯ä»¥é€šè¿‡ è¿‡æ»¤å™¨\"|safe\" çš„æ–¹å¼å‘Šè¯‰Djangoè¿™æ®µä»£ç æ˜¯å®‰å…¨çš„ä¸å¿…è½¬ä¹‰ã€‚ viewsæ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ªa_tagï¼Œæˆ‘é—¨ç°åœ¨å°±æƒ³è®©è¿™ä¸ªæ ‡ç­¾æˆä¸ºä¸€ä¸ªè¶…é“¾æ¥ a_tag = \"ç™¾åº¦\" htmlæ–‡ä»¶ {{ a_tag | safe }} æ²¡æœ‰åŠ safe åŠ ä¸Šsafeå 4.4.2.8 join å­—ç¬¦ä¸²æ‹¼æ¥åˆ—è¡¨ viewsæ–‡ä»¶ lst = [1,2,3,4,5,6] htmlæ–‡ä»¶ {{ lst | join:\"+\"}} 4.4.2.9 cut ç§»é™¤å˜é‡ä¸­æ‰€æœ‰çš„ä¸ç»™å‡ºçš„å˜é‡ç›¸åŒçš„å­—ç¬¦ä¸² viewsæ–‡ä»¶ str = 'I am a running çš„è‰æ³¥é©¬' htmlæ–‡ä»¶ {{ str | cut:' ' }} 4.5æ ‡ç­¾ 4.5.1 foræ ‡ç­¾ foræ ‡ç­¾è¯­æ³• {% for foo in å¾ªç¯çš„å¯¹è±¡ %} {% endfor %} foræ ‡ç­¾å¾ªç¯åˆ—è¡¨ç®€å•ç¤ºä¾‹ viewsæ–‡ä»¶ def home(request): lst = [1,2,3,4,5] return render(request,'home.html',{'lst':lst}) htmlæ–‡ä»¶ {% for foo in lst %} {{ foo }} {% endfor %} ç»“æœå¦‚ä¸‹ {% for foo in lst reversed %} {{ foo }} {% endfor %} foræ ‡ç­¾å¾ªç¯å­—å…¸ç®€å•ç¤ºä¾‹ viewsæ–‡ä»¶ def home(request): lst = [1,2,3,4,5] dic = {'name':'å°æ˜','age':20,'hobby':'å”±ã€è·³ã€rapã€ç¯®çƒ'} return render(request,'home.html',{'lst':lst,'dic':dic}) htmlæ–‡ä»¶ {% for foo in dic.items %} //è¿™é‡Œå¯ä»¥å¾ªç¯å­—å…¸çš„é”®ã€å€¼ã€é”®å’Œå€¼ {{ foo }} {% endfor %} {% for key,value in dic.items %} {{ key }}--->{{ value }} {% endfor %} foræ ‡ç­¾ä¸­çš„empty {% for i in lst1 %} #å½“æ²¡æœ‰æ•°æ®æ—¶,ä¼šç”Ÿæˆemptyçš„å†…å®¹ {{ i }} {% empty %} å•¥æ•°æ®ä¹Ÿæ²¡æœ‰! {% endfor %} foræ ‡ç­¾ä¸­çš„forloopæ–¹æ³•ï¼Œå¿…é¡»åœ¨å¾ªç¯å†…ä½¿ç”¨ forloop.counter #å½“å‰å¾ªç¯çš„ç´¢å¼•å€¼(ä»1å¼€å§‹)ï¼Œforloopæ˜¯å¾ªç¯å™¨ï¼Œé€šè¿‡ç‚¹æ¥ä½¿ç”¨åŠŸèƒ½ forloop.counter0 #å½“å‰å¾ªç¯çš„ç´¢å¼•å€¼ï¼ˆä»0å¼€å§‹ï¼‰ forloop.revcounter #å½“å‰å¾ªç¯çš„å€’åºç´¢å¼•å€¼ï¼ˆä»1å¼€å§‹ï¼‰ forloop.revcounter0 #å½“å‰å¾ªç¯çš„å€’åºç´¢å¼•å€¼ï¼ˆä»0å¼€å§‹ï¼‰ forloop.first #å½“å‰å¾ªç¯æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡å¾ªç¯ï¼ˆå¸ƒå°”å€¼ï¼‰ forloop.last #å½“å‰å¾ªç¯æ˜¯ä¸æ˜¯æœ€åä¸€æ¬¡å¾ªç¯ï¼ˆå¸ƒå°”å€¼ï¼‰ forloop.parentloop #æœ¬å±‚å¾ªç¯çš„å¤–å±‚å¾ªç¯çš„å¯¹è±¡ï¼Œå†é€šè¿‡ä¸Šé¢çš„å‡ ä¸ªå±æ€§æ¥æ˜¾ç¤ºå¤–å±‚å¾ªç¯çš„è®¡æ•°ç­‰ forloop.counter #å½“å‰å¾ªç¯çš„ç´¢å¼•å€¼(ä»1å¼€å§‹)ï¼Œforloopæ˜¯å¾ªç¯å™¨ï¼Œé€šè¿‡ç‚¹æ¥ä½¿ç”¨åŠŸèƒ½ {% for key,value in dic.items %} {{ forloop.counter }}{{ key }}--->{{ value }} {% endfor %} forloop.counter0 #å½“å‰å¾ªç¯çš„ç´¢å¼•å€¼ï¼ˆä»0å¼€å§‹ï¼‰ {% for key,value in dic.items %} {{ forloop.counter0 }}{{ key }}--->{{ value }} {% endfor %} forloop.first #å½“å‰å¾ªç¯æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡å¾ªç¯ï¼ˆå¸ƒå°”å€¼ï¼‰ {% for key,value in dic.items %} {{ forloop.first }} {{ key }}--->{{ value }} {% endfor %} forloop.parentloop #æœ¬å±‚å¾ªç¯çš„å¤–å±‚å¾ªç¯çš„å¯¹è±¡ï¼Œå†é€šè¿‡ä¸Šé¢çš„å‡ ä¸ªå±æ€§æ¥æ˜¾ç¤ºå¤–å±‚å¾ªç¯çš„è®¡æ•°ç­‰ viewsæ–‡ä»¶ def home(request): lst = [1,2,3,4,5] dic = {'name':'å°æ˜','age':20,'hobby':['å”±','è·³','rap','ç¯®çƒ']} return render(request,'home.html',{'lst':lst,'dic':dic}) htmlæ–‡ä»¶ {% for key,value in dic.items %} {{ forloop.last }} {{ key }}--->{{ value }} {% for foo in dic.hobby %} {{ forloop.parentloop.counter }}---{{ forloop.counter }}{{ foo }} {% endfor %} {% endfor %} 4.5.2 ifæ ‡ç­¾ ifè¯­å¥æ”¯æŒ and ã€orã€==ã€>ã€=ã€inã€not inã€isã€is notåˆ¤æ–­ï¼Œæ³¨æ„æ¡ä»¶ä¸¤è¾¹éƒ½æœ‰ç©ºæ ¼ viewsæ–‡ä»¶ def home(request): num = 100 str = 'helow' lst = [1,2,3,4,5] dic = {'name':'å°æ˜','age':20,'hobby':'å”±ã€è·³ã€rapã€ç¯®çƒ'} return render(request,'home.html',{'lst':lst,'dic':dic,'num':num,'str':str}) htmlæ–‡ä»¶ æ™®é€šåˆ¤æ–­ {% if num == 100 %} æ•°å­—ç­‰äº100 {% else %} æ•°å­—ä¸ç­‰äº100 {% endif %} #è¯­æ³• {% if %} {% elif %} {% else %} {% endif %} //ä»¥endifç»“å°¾ ç»“åˆè¿‡æ»¤å™¨ä½¿ç”¨ {% if str|length == 5 %} å­—ç¬¦ä¸²é•¿åº¦ä¸º5 {% endif %} 4.5.3 withæ ‡ç­¾ ç”¨äºç»™æ¯”è¾ƒé•¿çš„æ•°æ®è°ƒç”¨èµ·åˆ«åï¼Œåªèƒ½åœ¨withæ ‡ç­¾ä¸­åªç”¨ viewsæ–‡ä»¶ def home(request): lst = [1,2,{'name':'å°æ˜','age':20},4,5] return render(request,'home.html',{'lst':lst} htmlæ–‡ä»¶ htmlæ–‡ä»¶ä¸­æƒ³æ¸²æŸ“viewsæ–‡ä»¶ä¸­è¿”å›çš„åˆ—è¡¨ä¸­çš„å…ƒç´ ä¸­çš„å­—å…¸çš„å€¼ï¼Œå¦‚æœæ¯ä¸€æ¬¡éƒ½å†™çš„è¯ä¼šæ¯”è¾ƒé•¿ï¼Œä¾‹å¦‚lst.2.nameï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å–ä¸€ä¸ªåˆ«åï¼Œç”¨äºç»™è¿™ä¸ªæ•°æ®çš„è°ƒç”¨ï¼Œè¿™æ ·çš„è¯ä¸‹æ¬¡åˆ«çš„åœ°æ–¹æœ‰å¼•ç”¨çš„æ—¶å€™å†™èµ·å•¦ä¼šæ¯”è¾ƒç®€å• //ä¾‹å¦‚ï¼Œh1æ ‡ç­¾å’Œaæ ‡ç­¾ä¸­éƒ½æƒ³å¼•ç”¨è¿™ä¸ªæ•°æ®çš„è°ƒç”¨ï¼Œæ²¡æœ‰èµ·åˆ«åä¹‹å‰çš„å†™æ³•ï¼Œè¿™æ ·æ¯æ¬¡å¼•ç”¨éƒ½éœ€è¦åœ¨å†™ä¸€éï¼Œæ¯”è¾ƒéº»çƒ¦ {{ lst.2.name }} {{ lst.2.name }} //è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨åˆ°withåˆ«åçš„æ–¹æ³• {% with lst.2.name as l %} {{ l }} {% endwith %} 4.5.4 csrf_token é€šè¿‡csrfè®¤è¯æœºåˆ¶ #å†™æ³• {% csrf_token %} csrf_token ã€€ã€€ã€€ã€€æˆ‘ä»¬ä»¥postæ–¹å¼æäº¤è¡¨å•çš„æ—¶å€™ï¼Œä¼šæŠ¥é”™ï¼Œæˆ‘ä»¬åœ¨settingsé‡Œé¢çš„ä¸­é—´ä»¶é…ç½®é‡Œé¢æŠŠä¸€ä¸ªcsrfçš„é˜²å¾¡æœºåˆ¶ç»™æ³¨é”€äº†ï¼Œæœ¬èº«ä¸åº”è¯¥æ³¨é”€çš„ï¼Œè€Œæ˜¯åº”è¯¥å­¦ä¼šæ€ä¹ˆä½¿ç”¨å®ƒï¼Œå¹¶ä¸”ä¸è®©è‡ªå·±çš„æ“ä½œè¢«forbidenï¼Œé€šè¿‡è¿™ä¸ªä¸œè¥¿å°±èƒ½æå®šã€‚ ã€€ã€€ã€€ã€€è¿™ä¸ªæ ‡ç­¾ç”¨äºè·¨ç«™è¯·æ±‚ä¼ªé€ ä¿æŠ¤ï¼Œ ã€€ã€€ã€€ã€€åœ¨é¡µé¢çš„formè¡¨å•é‡Œé¢ï¼ˆæ³¨æ„æ˜¯åœ¨formè¡¨å•é‡Œé¢ï¼‰ä»»ä½•ä½ç½®å†™ä¸Š{% csrf_token %}ï¼Œè¿™ä¸ªä¸œè¥¿æ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™æ›¿æ¢æˆäº†ï¼Œéšè—çš„ï¼Œè¿™ä¸ªæ ‡ç­¾çš„å€¼æ˜¯ä¸ªéšæœºå­—ç¬¦ä¸²ï¼Œæäº¤çš„æ—¶å€™ï¼Œè¿™ä¸ªä¸œè¥¿ä¹Ÿè¢«æäº¤äº†ï¼Œé¦–å…ˆè¿™ä¸ªä¸œè¥¿æ˜¯æˆ‘ä»¬åç«¯æ¸²æŸ“çš„æ—¶å€™ç»™é¡µé¢åŠ ä¸Šçš„ï¼Œé‚£ä¹ˆå½“ä½ é€šè¿‡æˆ‘ç»™ä½ çš„formè¡¨å•æäº¤æ•°æ®çš„æ—¶å€™ï¼Œä½ å¸¦ç€è¿™ä¸ªå†…å®¹æˆ‘å°±è®¤è¯†ä½ ï¼Œä¸å¸¦ç€ï¼Œæˆ‘å°±ç¦æ­¢ä½ ï¼Œå› ä¸ºåå°æˆ‘ä»¬djangoä¹Ÿå­˜ç€è¿™ä¸ªä¸œè¥¿ï¼Œå’Œä½ è¿™ä¸ªå€¼ç›¸åŒçš„ä¸€ä¸ªå€¼ï¼Œå¯ä»¥åšå¯¹åº”éªŒè¯æ˜¯ä¸æ˜¯æˆ‘ç»™ä½ çš„tokenï¼Œå°±åƒä¸€ä¸ªæˆ‘ä»¬åå°ç»™è¿™ä¸ªç”¨æˆ·çš„ä¸€ä¸ªé€šè¡Œè¯ï¼Œå¦‚æœä½ ç”¨æˆ·æ²¡æœ‰æŒ‰ç…§æˆ‘ç»™ä½ çš„è¿™ä¸ªæ­£å¸¸çš„é¡µé¢æ¥postæäº¤è¡¨å•æ•°æ®ï¼Œæˆ–è€…è¯´ä½ æ²¡æœ‰å…ˆå»è¯·æ±‚æˆ‘è¿™ä¸ªç™»é™†é¡µé¢ï¼Œè€Œæ˜¯ç›´æ¥æ¨¡æ‹Ÿè¯·æ±‚æ¥æäº¤æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘å°±èƒ½çŸ¥é“ï¼Œä½ è¿™ä¸ªè¯·æ±‚æ˜¯éæ³•çš„ï¼Œåçˆ¬è™«æˆ–è€…æ¶æ„æ”»å‡»æˆ‘çš„ç½‘ç«™ 4.6è‡ªå®šä¹‰æ ‡ç­¾å’Œè‡ªå®šä¹‰è¿‡æ»¤å™¨ 4.6.1è‡ªå®šä¹‰æ ‡ç­¾ 1.åœ¨åº”ç”¨ç¨‹åºç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtemplatetagsç›®å½•(åç§°åªèƒ½å«templatetags) 2.åœ¨templatetabsç›®å½•ä¸­åˆ›å»ºxx.py 3.åœ¨xx.pyä¸­å¯¼å…¥template from django import template #å˜é‡åç§°å¿…é¡»å«register register = template.Library() #è‡ªå®šä¹‰æ ‡ç­¾ @register.simple_tag def tag(v1): return v1 + 'tag' ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾ urlsæ–‡ä»¶ url(r'^tags/', views.tags), viewsæ–‡ä»¶ def tags(request): name = 'hehe' return render(request,'tags.html',{'name':name}) tags.htmlæ–‡ä»¶ //è¿™é‡Œè¡¨ç¤ºå¼•å…¥åº”ç”¨ç¨‹åºç›®å½•ä¸‹templatetagsç›®å½•ä¸­è‡ªå®šä¹‰çš„xx.pyï¼Œè¿™ä¸ªxx.pyä¸­æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„æ ‡ç­¾ {% load xx %} {% tag name %} args.htmlæ–‡ä»¶ä¸­ä¸ç»™è‡ªå®šä¹‰æ ‡ç­¾ä¼ å‚æ•° viewsæ–‡ä»¶ä¸­æŒ‡å®šç»™è‡ªå®šä¹‰çš„æ ‡ç­¾ä¼ 2ä¸ªå‚æ•°ï¼Œv1æ˜¯viewsä¸­tagå‡½æ•°å®šä¹‰çš„å˜é‡nameï¼Œv2å°±æ˜¯args.htmlä¸­è‡ªå®šä¹‰æ ‡ç­¾ä¼ çš„ä¸€ä¸ªå‚æ•° from django import template #å˜é‡åç§°å¿…é¡»å«register register = template.Library() #è‡ªå®šä¹‰æ ‡ç­¾ @register.simple_tag def tag(v1,v2): return v1 + 'tag' + v2 args.htmlæ–‡ä»¶ä¸­ç»™è‡ªå®šä¹‰æ ‡ç­¾ä¼ å‚ {% tag name 'å‚æ•°1' %} 4.6.2è‡ªå®šä¹‰è¿‡æ»¤å™¨ 1.åœ¨åº”ç”¨ç¨‹åºç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtemplatetagsç›®å½•(åç§°åªèƒ½å«templatetags) 2.åœ¨templatetabsç›®å½•ä¸­åˆ›å»ºxx.py 3.åœ¨xx.pyä¸­å¯¼å…¥template from django import template #å˜é‡åç§°å¿…é¡»å«register register = template.Library() #è‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œæœ€å¤š2ä¸ªå‚æ•° è¿™é‡Œè‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ¥å—ä»»æ„ä¸€ä¸ªå‚æ•°ï¼Œç»™è¿™ä¸ªå‚æ•°åè¾¹åŠ ä¸€ä¸ªå­—ç¬¦ä¸² @register.filter def oo(v1): return v1 + 'oo' ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨ urlsæ–‡ä»¶ url(r'^tags/', views.tags), viewsæ–‡ä»¶ def tags(request): name = 'hehe' return render(request,'tags.html',{'name':name}) tags.html //è¿™é‡Œè¡¨ç¤ºå¼•å…¥åº”ç”¨ç¨‹åºç›®å½•ä¸‹templatetagsç›®å½•ä¸­è‡ªå®šä¹‰çš„xx.pyï¼Œè¿™ä¸ªxx.pyä¸­æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ {% load xx %} {{ name | oo }} ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ï¼Œæ¥å—ä»»æ„ä¸€ä¸ªå‚æ•°ï¼Œç»™è¿™ä¸ªå‚æ•°åè¾¹åŠ ä¸€ä¸ªå­—ç¬¦ä¸²oo ä¸Šè¿°ç»“æœæ˜¯xx.pyå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨æ–‡ä»¶ä¸­çš„å‡½æ•°åªä¼ äº†ä¸€ä¸ªå‚æ•°ï¼Œç°åœ¨æˆ‘ä»¬ç»™è¿™ä¸ªå‡½æ•°ä¼ 2ä¸ªå‚æ•°(æœ€å¤šä¼ ä¸¤ä¸ªå‚æ•°) xx.pyå†™æ³• from django import template #å˜é‡åç§°å¿…é¡»å«register register = template.Library() #è‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œæœ€å¤š2ä¸ªå‚æ•° è¿™é‡Œè‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ¥å—ä»»æ„ä¸€ä¸ªå‚æ•°ï¼Œç»™è¿™ä¸ªå‚æ•°åè¾¹åŠ ä¸€ä¸ªå­—ç¬¦ä¸² @register.filter def oo(v1,v2): return v2 + 'oo' + v1 ä¸Šè¿°ä»£ç ä¸­v1æ˜¯viewsä¸­å®šä¹‰çš„nameå˜é‡çš„å€¼ï¼Œä¹Ÿå°±æ˜¯heheï¼Œv2å°±æ˜¯tags.htmlä¸­å‡½æ•°ooåé¢ä¼ çš„å‚æ•°ï¼Œå› æ­¤æ‰“å°çš„ç»“æœå°±æ˜¯ å“ˆå“ˆoohehe urlsæ–‡ä»¶ url(r'^tags/', views.tags), viewsæ–‡ä»¶ def tags(request): name = 'hehe' return render(request,'tags.html',{'name':name}) tags.html //è¿™é‡Œè¡¨ç¤ºå¼•å…¥åº”ç”¨ç¨‹åºç›®å½•ä¸‹templatetagsç›®å½•ä¸­è‡ªå®šä¹‰çš„xx.pyï¼Œè¿™ä¸ªxx.pyä¸­æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ {% load xx %} {{ name | oo:'å“ˆå“ˆ' }} 4.6.3 inclusion_tag ä¿®æ”¹å¼•å…¥ç»„ä»¶çš„æ ·å¼ï¼ˆ éå¸¸éš¾ç†è§£ï¼‰ inclusion_tagä½œç”¨å¦‚ä¸‹ æ¥ä¸‹æ¥å¼€å§‹æ•´ä¸ªè¿‡ç¨‹ ç¬¬ä¸€æ­¥ã€å…ˆåœ¨djangoé¡¹ç›®åŒè·¯å¾„ä¸‹çš„templatesç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªèœå•é™æ€é¡µé¢ä½œä¸ºä¸€ä¸ªç»„ä»¶ zujian.html Title .menus{ width: 200px; } .menus .item{ background-color: green; color: white; height: 50px; } èœå•1 èœå•2 èœå•3 æ•ˆæœå¦‚ä¸‹ ç¬¬äºŒæ­¥ã€åˆ†åˆ«åœ¨urlså’Œviewsæ–‡ä»¶ä¸­å†™ä¸Šå¯¹åº”çš„è®¿é—®è·¯å¾„å’Œå‡½æ•° è¿™é‡Œåœ¨åè¾¹å®šä¹‰ä¸€ä¸ªxx.htmlï¼Œè¿™ä¸ªxx.htmlå¼•å…¥ç»„ä»¶æ–‡ä»¶zujian.htmlï¼Œå¹¶ä¸”è®¿é—®è·¯å¾„æ˜¯xxï¼Œè§†å›¾ä¸­çš„å‡½æ•°ä¹Ÿå«xx(è¿”å›xx.html) urlsæ–‡ä»¶ url(r'^xx/', views.xx), viewsæ–‡ä»¶ def xx(request): return render(request,'xx.html') ç¬¬ä¸‰æ­¥ã€è¿˜æ˜¯åœ¨templatesç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªxx.htmlæ–‡ä»¶ï¼Œè¿™ä¸ªhtmlæ–‡ä»¶å¼•å…¥åˆšæ‰åˆ›å»ºçš„ç»„ä»¶æ–‡ä»¶ xx.htmlæ–‡ä»¶åˆå§‹å†…å®¹å¦‚ä¸‹ Title .nav{ height: 200px; width: 150px; background-color: burlywood; } æˆ‘æ˜¯xx.htmlï¼Œä¸€ä¼šæˆ‘è¦å¼•å…¥ç»„ä»¶ä¸­çš„æ ·å¼ï¼Œå°±æ˜¯ç»„ä»¶ä¸­çš„é‚£ä¸ªèœå•æ ï¼Œå¹¶ä¸”æˆ‘ä¸ä¿®æ”¹å¼•å…¥çš„æ ·å¼ï¼Œåªæ˜¯ä¿®æ”¹èœå•æ ä¸ºå…¶ä»–å†…å®¹ åˆå§‹xx.html æ¥ä¸‹æ¥åœ¨xx.htmlæ–‡ä»¶ä¸­å¼•å…¥ç»„ä»¶æ–‡ä»¶çš„æ ·å¼ åœ¨divæ ‡ç­¾ä¸‹å¼•å…¥zujian.html æˆ‘æ˜¯xx.htmlï¼Œä¸€ä¼šæˆ‘è¦å¼•å…¥ç»„ä»¶ä¸­çš„æ ·å¼ï¼Œå°±æ˜¯ç»„ä»¶ä¸­çš„é‚£ä¸ªèœå•æ ï¼Œå¹¶ä¸”æˆ‘ä¸ä¿®æ”¹å¼•å…¥çš„æ ·å¼ï¼Œåªæ˜¯ä¿®æ”¹èœå•æ ä¸ºå…¶ä»–å†…å®¹ {% include 'zujian.html' %} å¼•å…¥ç»„ä»¶åçš„æ ·å¼ï¼Œç»¿è‰²ä¸ºzujian.htmlæ–‡ä»¶ä¸­çš„å†…å®¹ æ¥ä¸‹æ¥æƒ³è¦å°†å¼•å…¥çš„æ ·å¼ä¸­çš„èœå•æ å˜ä¸ºå…¶ä»–å†…å®¹ï¼Œéœ€è¦åšä»¥ä¸‹æ“ä½œï¼Œåœ¨ç»„ä»¶æ–‡ä»¶zujian.htmlæ–‡ä»¶ä¸­å°†æƒ³è¦æ›´æ”¹çš„å†…å®¹åˆ©ç”¨forå¾ªç¯ä¾¿åˆ© zujian.htmlæ–‡ä»¶ //åˆ©ç”¨forå¾ªç¯éå†dataå˜é‡ï¼Œfooå°±æ˜¯dataå˜é‡ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œè¿™æ ·çš„è¯å°±åšæˆäº†åŠ¨æ€çš„æ•ˆæœï¼ŒåŸå…ˆçš„èœå•æ divæ ‡ç­¾ç°åœ¨åªéœ€è¦å†™ä¸€ä¸ªï¼Œå› ä¸ºfooæ˜¯å˜é‡dataä¸­æ‰€æœ‰çš„å€¼ {% for foo in data %} {{ foo }} {% endfor %} //æ³¨é‡Šä¹‹å‰çš„èœå•æ ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ç”¨åˆ°åŠ¨æ€ä¼ å…¥å†…å®¹ {# èœå•1#} {# èœå•2#} {# èœå•3#} è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œç°åœ¨æƒ³æŠŠzujian.htmlæ–‡ä»¶ä¸­çš„èœå•æ åšä¸€ä¸‹åŠ¨æ€ä¿®æ”¹ï¼Œè¿™é‡Œå†™äº†ä»dataä¸­å–å€¼ï¼Œä½†æ˜¯å¾ªç¯éå†çš„dataæ˜¯ä»å“ªæ¥çš„ï¼Ÿï¼Ÿï¼Ÿè¿™æ—¶å°±å¼•å‡ºäº†inclusion_tag inclusion_tagéœ€è¦å†™åœ¨templatetagsç›®å½•ä¸‹è‡ªå®šä¹‰çš„pyæ–‡ä»¶ä¸­ï¼Œè€Œdataå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿”å›ç»™xx.htmlæ–‡ä»¶çš„åŠ¨æ€å†…å®¹ï¼Œå› ä¸ºxx.htmlå¼•å…¥zujian.htmlçš„æ ·å¼æ˜¯å›ºå®šçš„ï¼Œåªæœ‰zujian.htmlæ–‡ä»¶ä¸­å®šä¹‰çš„å†…å®¹ ç¬¬å››æ­¥ã€åœ¨templatetagsç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªmytags.py templatetagsç›®å½•æ˜¯åœ¨djangoé¡¹ç›®çš„åº”ç”¨ç¨‹åºç›®å½•ä¸‹åˆ›å»ºçš„ç›®å½•ï¼Œåœ¨è‡ªå®šä¹‰æ ‡ç­¾å’Œè‡ªå®šä¹‰è¿‡æ»¤å™¨çš„æ—¶å€™å¿…é¡»åˆ›å»ºè¿™ä¸ªç›®å½•ï¼Œä¸”åå­—åªèƒ½æ˜¯è¿™ä¸ªï¼Œåœ¨è¿™ä¸ªtemplatetagsç›®å½•ä¸‹åˆ›å»ºçš„pyæ–‡ä»¶ä¸­è‡ªå®šä¹‰æ ‡ç­¾å’Œè¿‡æ»¤å™¨ mytags.py @register.inclusion_tag('zujian.html')æ˜¯å›ºå®šå†™æ³•ï¼Œæ‹¬å·ä¸­çš„å‚æ•°å°±æ˜¯ç»„ä»¶æ–‡ä»¶ï¼Œè¿™é‡Œçš„dataæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å­—å…¸ @register.inclusion_tag('zujian.html') def hehe(v1): return {'data':['å”±','è·³','rap','ç¯®çƒ']} ç¬¬äº”æ­¥ã€åœ¨xx.htmlæ–‡ä»¶ä¸­å¼•å…¥åŠ¨æ€å†…å®¹ æˆ‘æ˜¯xx.htmlï¼Œä¸€ä¼šæˆ‘è¦å¼•å…¥ç»„ä»¶ä¸­çš„æ ·å¼ï¼Œå°±æ˜¯ç»„ä»¶ä¸­çš„é‚£ä¸ªèœå•æ ï¼Œå¹¶ä¸”æˆ‘ä¸ä¿®æ”¹å¼•å…¥çš„æ ·å¼ï¼Œåªæ˜¯ä¿®æ”¹èœå•æ ä¸ºå…¶ä»–å†…å®¹ {#{% include 'zujian.html' %}#} {% load mytags %} //å¼•å…¥è‡ªå®šä¹‰å‡½æ•°çš„é‚£ä¸ªæ–‡ä»¶å {% hehe %} //å¼•å…¥è‡ªå®šä¹‰å‡½æ•°ï¼Œç”¨äºè¿”å›data æœ€ç»ˆè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼Œå¼•å…¥çš„ç»„ä»¶çš„èƒŒæ™¯é¢œè‰²ç»¿è‰²æ²¡æœ‰æ”¹å˜ï¼Œä½†æ˜¯æ”¹å˜äº†ä¹‹å‰çš„èœå•æ  æ•´ä¸ªè¿‡ç¨‹æ€»ç»“ 1.å®šä¹‰urls url(r'^xx/', views.xx), 2.å®šä¹‰è§†å›¾ def xx(request): return render(request,'xx.html') 3.xx.htmlæ–‡ä»¶å¼•å…¥ç»„ä»¶æ–‡ä»¶zujian.htmlï¼Œç»„ä»¶ä¸­åªå®šä¹‰äº†ä¸€ä¸ªèƒŒæ™¯è‰²ï¼Œä½†æ˜¯xx.htmlæ–‡ä»¶æƒ³è¦åŠ¨æ€çš„æ·»åŠ ä¸€äº›å†…å®¹ï¼Œä¾‹å¦‚èœå•æ ï¼Œæ­¤æ—¶éœ€è¦åœ¨ç»„ä»¶æ–‡ä»¶ä¸­åšå¦‚ä¸‹æ”¹åŠ¨ ç»„ä»¶æ–‡ä»¶ä¸­å®šä¹‰çš„èƒŒæ™¯è‰² Title .menus{ width: 200px; } åˆ©ç”¨forå¾ªç¯å»å¾ªç¯ä¸€ä¸ªå˜é‡ï¼Œä¾‹å¦‚dataï¼Œè¿™ä¸ªå˜é‡æ˜¯åœ¨djangoé¡¹ç›®ä¸‹çš„åº”ç”¨ç¨‹åºç›®å½•ä¸‹çš„templatetagsä¸‹çš„ä»»æ„åç§°pyæ–‡ä»¶ä¸­åˆ©ç”¨@register.inclusion_tag('zujian.html')å’Œè‡ªå®šä¹‰å‡½æ•°ä¸­çš„returnè¿”å›å€¼å®šä¹‰çš„å˜é‡ åº”ç”¨ç¨‹åºä¸‹templatesç›®å½•ä¸­å®šä¹‰ä¸€ä¸ªmytags.py(åç§°ä»»æ„)ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ inclusion_tagä¸­å¿…é¡»è·Ÿä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å¿…é¡»æ˜¯ç»„ä»¶æ–‡ä»¶ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°hehe(åç§°ä»»æ„)ï¼Œreturnçš„è¿”å›å€¼ä¼šè¿”å›ç»™ç»„ä»¶æ–‡ä»¶ mytags.pyæ–‡ä»¶å†…å®¹å¦‚ä¸‹ from django import template register = template.Library() @register.inclusion_tag('zujian.html') def hehe(): return {'data':['å”±','è·³','rap','ç¯®çƒ']} 4.ç¬¬3æ­¥ä¸­çš„dataå˜é‡å·²ç»è¿”å›ç»™äº†ç»„ä»¶æ–‡ä»¶ï¼Œå› æ­¤xx.htmlæ–‡ä»¶ä¸­éœ€è¦å¼•å…¥åº”ç”¨ç¨‹åºä¸‹çš„templatetagsä¸­å®šä¹‰çš„é‚£ä¸ªpyæ–‡ä»¶(è¿™é‡Œæ˜¯mytag.py) è¿˜éœ€è¦å¼•å…¥è¿™ä¸ªpyæ–‡ä»¶ä¸­è‡ªå®šä¹‰çš„å‡½æ•°çš„åç§°(è¿™é‡Œæ˜¯hehe) mytags.py(è‡ªå®šä¹‰æ ‡ç­¾éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸‹çš„templatetagsç›®å½•ä¸­å®šä¹‰ä¸€ä¸ªä»»æ„çš„pyæ–‡ä»¶ï¼Œç„¶ååœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å†™è‡ªå®šä¹‰æ ‡ç­¾å†…å®¹) xx.htmlæ–‡ä»¶å†…å®¹å¦‚ä¸‹ æˆ‘æ˜¯xx.htmlï¼Œä¸€ä¼šæˆ‘è¦å¼•å…¥ç»„ä»¶ä¸­çš„æ ·å¼ï¼Œå°±æ˜¯ç»„ä»¶ä¸­çš„é‚£ä¸ªèœå•æ ï¼Œå¹¶ä¸”æˆ‘ä¸ä¿®æ”¹å¼•å…¥çš„æ ·å¼ï¼Œåªæ˜¯ä¿®æ”¹èœå•æ ä¸ºå…¶ä»–å†…å®¹ {#{% include 'zujian.html' %}#} {% load mytags %} {% hehe %} #å‚æ•°è¯´æ˜ {% load mytags %} //å¼•å…¥åº”ç”¨ç¨‹åºä¸‹çš„templatetagsä¸­å®šä¹‰çš„é‚£ä¸ªpyæ–‡ä»¶(è¿™é‡Œæ˜¯mytags.py) {% hehe %} //å¼•å…¥è¿™ä¸ªpyæ–‡ä»¶(mytags.py)ä¸­è‡ªå®šä¹‰çš„å‡½æ•°çš„åç§°(è¿™é‡Œæ˜¯hehe) æœ€ç»ˆçš„æ¸²æŸ“æ•ˆæœå°±ç”±åº”ç”¨ç¨‹åºä¸‹çš„templatetagsä¸­å®šä¹‰çš„é‚£ä¸ªpyæ–‡ä»¶(è¿™é‡Œæ˜¯mytags.py)ä¸­å®šä¹‰çš„å‡½æ•°ä¸­è‡ªå®šä¹‰çš„è¿”å›å€¼å†³å®š è¿™é‡Œå®šä¹‰çš„dataæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œdataä¼šè¿”å›ç»™ç»„ä»¶æ–‡ä»¶ç”¨äºåŠ¨æ€æ¸²æŸ“ from django import template register = template.Library() @register.inclusion_tag('zujian.html') def hehe(): return {'data':['å”±','è·³','rap','ç¯®çƒ']} å…³äºåŠ¨æ€è¿”å›å†…å®¹çš„ä¸€ä¸ªé—®é¢˜ å†™åœ¨mytagsä¸­æ˜¯å†™æ­»çš„ï¼Œæˆ‘ä»¬åº”è¯¥å†™æˆåŠ¨æ€çš„ï¼Œæ‰€ä»¥åº”è¯¥å†™åœ¨viewsä¸­ä»æ•°æ®åº“ä¸­è·å–æ•°æ®è¾¾åˆ°åŠ¨æ€è¿”å›çš„æ•ˆæœï¼Œå› æ­¤ä¿®æ”¹mytagsæ–‡ä»¶å¦‚ä¸‹ mytagsæ–‡ä»¶ from django import template register = template.Library() @register.inclusion_tag('zujian.html') #è¿™é‡Œçš„v1å°±æ˜¯ç»™xx.htmlæ–‡ä»¶ä¸­å¼•å…¥heheå‡½æ•°èƒ½å¤Ÿä¼ ä¸€ä¸ªå‚æ•° def hehe(v1): return {'data':v1} viewsæ–‡ä»¶ def xx(request): #è¿™é‡Œçš„lstå°±ç›¸å½“äºä»æ•°æ®åº“ä¸­åŠ¨æ€è·å–çš„æ•°æ® lst = ['å”±1','è·³1','rap1','ç¯®çƒ1'] return render(request,'xx.html',{'lst':lst}) xx.htmlæ–‡ä»¶ æˆ‘æ˜¯xx.htmlï¼Œä¸€ä¼šæˆ‘è¦å¼•å…¥ç»„ä»¶ä¸­çš„æ ·å¼ï¼Œå°±æ˜¯ç»„ä»¶ä¸­çš„é‚£ä¸ªèœå•æ ï¼Œå¹¶ä¸”æˆ‘ä¸ä¿®æ”¹å¼•å…¥çš„æ ·å¼ï¼Œåªæ˜¯ä¿®æ”¹èœå•æ ä¸ºå…¶ä»–å†…å®¹ {#{% include 'zujian.html' %}#} {% load mytags %} {% hehe lst %} //åœ¨è¿™é‡Œå¼•å…¥viewsä¸­å®šä¹‰çš„lst æœ€ç»ˆçœŸæ­£çš„åŠ¨æ€è·å–å†…å®¹æ•ˆæœå¦‚ä¸‹ 4.7ç»„ä»¶ ç»„ä»¶ç±»ä¼¼äºpythonä¸­çš„æ¨¡å—ï¼Œç»„ä»¶æ˜¯æŠŠå…¶ä»–htmlé¡µé¢å¼•å…¥è¿‡æ¥ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹å¼•å…¥çš„æ–‡ä»¶çš„å†…å®¹ ç»„ä»¶æ–‡ä»¶ Title 1 2 3 è‡ªå®šä¹‰æ–‡ä»¶ åœ¨è‡ªå®šä¹‰æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æƒ³å¼•å…¥ç»„ä»¶æ–‡ä»¶ä¸­çš„åˆ—è¡¨æ ·å¼ï¼Œéœ€è¦å¦‚ä¸‹ä»£ç ï¼Œè¿™ä¸ªå°±æ˜¯åœ¨è‡ªå®šä¹‰æ–‡ä»¶ä¸­è¡¨ç¤ºå¼•å…¥ç»„ä»¶.htmlæ–‡ä»¶ #å†™æ³• {% include 'ç»„ä»¶.html' %} Title .c1{ background-color: green; } {% include 'ç»„ä»¶.html' %} æˆ‘æ˜¯ä¸€ä¸ªå¼•å…¥äº†ç»„ä»¶æ–‡ä»¶çš„è‡ªå®šä¹‰æ–‡ä»¶ 4.8æ¨¡ç‰ˆç»§æ‰¿ æˆ‘ä»¬åœ¨å†™å¤šä¸ªé™æ€é¡µé¢çš„æ—¶å€™å¯èƒ½ä¼šæœ‰ä¸€äº›ç›¸åŒçš„æ ·å¼ï¼Œè¿™æ ·çš„è¯æ¯å†™ä¸€ä¸ªé¡µé¢å°±éœ€è¦å¤åˆ¶ç›¸åŒçš„ä»£ç ï¼Œè¿™æ ·å°±é€ æˆäº†ä»£ç å¤§é‡é‡å¤ï¼Œæ­¤æ—¶å°±ç”¨åˆ°äº†æ¨¡ç‰ˆç»§æ‰¿ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç›¸åŒæ ·å¼çš„é¡µé¢çš„ä»£ç å•ç‹¬æ”¾åœ¨ä¸€ä¸ªæ¨¡ç‰ˆæ–‡ä»¶ä¸­ï¼Œå…¶ä½™é¡µé¢ç»§æ‰¿è¿™ä¸ªæ¨¡ç‰ˆæ–‡ä»¶ï¼Œç„¶ååœ¨è®¾ç½®è‡ªå®šä¹‰å†…å®¹å³å¯ï¼Œè¿™æ ·å°±ä¸ç”¨é‡å¤å†™ç›¸åŒæ ·å¼çš„ä»£ç äº† æ¨¡ç‰ˆæ–‡ä»¶ base.htmlæ–‡ä»¶ Title .nav{ background-color: pink; height: 40px; } .left-menu{ display: inline-block; width: 200px; background-color: mediumpurple; } .content{ display: inline-block; height: 200px; width: 600px; background-color: burlywood; color:white; } ul{ padding: 0; margin: 0; } #è¿™é‡Œè¡¨ç¤ºé¢„ç•™cssæ ·å¼ï¼Œå­æ¨¡ç‰ˆç»§æ‰¿åå¯ä»¥ä¿®æ”¹æ¨¡ç‰ˆçš„æ ·å¼ {% block css %} {% endblock %} ä¸ªäººä¸­å¿ƒ ç™»å½•|æ³¨å†Œ èœå•1 èœå•2 èœå•3 {% block content %} baseé¡µé¢ xxx {% endblock %} {% block js %} {% endblock %} æ¨¡ç‰ˆç»§æ‰¿çš„å†™æ³• åœ¨æ¨¡ç‰ˆhtmlæ–‡ä»¶ä¸­éœ€è¦ç”¨åˆ°blockæ–¹æ³•ï¼Œä¾‹å¦‚ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦èœå•1å’Œèœå•2æœ‰è‡ªå·±çš„è‡ªå®šä¹‰ç•Œé¢è€Œä¸ç»§æ‰¿æ¨¡ç‰ˆæ–‡ä»¶ï¼Œå†™æ³•å¦‚ä¸‹ {% block content %} baseé¡µé¢ xxx {% endblock %} è¿™ä¸ªæ ‡ç­¾å°±æ˜¯èœå•1å’Œèœå•2ä¸­éœ€è¦å•ç‹¬è®¾ç½®æ ·å¼çš„æ ‡ç­¾ï¼Œä¸ºäº†ä¸ç»§æ‰¿æ¨¡ç‰ˆæ–‡ä»¶ï¼Œéœ€è¦åœ¨è¿™ä¸ªæ ‡ç­¾å†™å¦‚ä¸‹å†…å®¹ blockä¸­åŒ…å«çš„aæ ‡ç­¾å°±æ˜¯èœå•1å’Œèœå•2çš„htmlæ–‡ä»¶ä¸­éœ€è¦é‡å†™çš„ {% block content %} baseé¡µé¢ xxx {% endblock %} è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œæ¨¡ç‰ˆæ–‡ä»¶ä¸­çš„baseé¡µé¢ä¸å¸Œæœ›è¢«ç»§æ‰¿ï¼Œè¿™é‡Œå°±å•ç‹¬æŠŠè¿™ä¸ªé¡µé¢é¢„ç•™å‡ºæ¥ï¼Œæ¥ä¸‹æ¥åœ¨èœå•1å’Œèœå•2çš„htmlæ–‡ä»¶ä¸­åœ¨å•ç‹¬å†™è¿™å—çš„æ ·å¼ï¼Œå†™æ³•å¦‚ä¸‹ //è¿™é‡Œè¡¨ç¤ºç»§æ‰¿æ¨¡ç‰ˆæ–‡ä»¶base.html {% extends 'base.html' %} å› ä¸ºä¸éœ€è¦ç»§æ‰¿æ¨¡ç‰ˆæ–‡ä»¶ä¸­çš„ baseé¡µé¢ å¤„çš„å†…å®¹ï¼Œè€Œæ¨¡ç‰ˆæ–‡ä»¶ä¸­ä¹ŸæŠŠè¿™ä¸€å—å†…å®¹å·²ç»é¢„ç•™å‡ºæ¥äº†ï¼Œå¹¶ä¸”å®šä¹‰äº†é¢„ç•™åç§°ä¸º contentï¼Œåœ¨èœå•1å’Œèœå•2çš„htmlæ–‡ä»¶ä¸­ä¹‹éœ€è¦å¼•å…¥è¿™ä¸ªæ¨¡ç‰ˆé¢„ç•™åç§°ï¼Œè¿™æ ·å°±å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„æ ·å¼äº†ï¼Œå†™æ³•å¦‚ä¸‹ {% block content %} èœå•1çš„å†…å®¹ {% endblock %} base.htmlæ–‡ä»¶å¦‚ä¸Šï¼Œç°åœ¨æˆ‘ä»¬è®¾ç½®èœå•1ã€èœå•2çš„è‡ªå®šä¹‰å†…å®¹ï¼Œéœ€è¦åšä»¥ä¸‹æ“ä½œ urlsæ–‡ä»¶ from app01 import views urlpatterns = [ url(r'^admin/', admin.site.urls), #è¿™ä¸ªå°±æ˜¯æ¨¡ç‰ˆé¡µé¢ url(r'^base/', views.base), #ä¸‹è¾¹ä¸¤ä¸ªæ˜¯èœå•1å’Œèœå•2è¿”å›çš„é¡µé¢ url(r'^menu01/', views.menu01), url(r'^menu02/', views.menu02), ] viewsæ–‡ä»¶ def base(request): return render(request,'base.html') def menu01(request): return render(request,'menu01.html') def menu02(request): return render(request,'menu02.html') menu01.html {% extends 'base.html' %} .content{ display: inline-block; height: 200px; width: 600px; background-color: green; color:white; } {% endblock %} {% block content %} èœå•1çš„å†…å®¹ {% endblock %} menu02.html {% extends 'base.html' %} {% block content %} èœå•2çš„å†…å®¹ {% endblock %} è®¿é—®baseé¡µé¢ï¼Œç‚¹å‡»èœå•1ï¼Œè¿”å›é¡µé¢å¦‚ä¸‹ï¼Œå› ä¸ºåœ¨menu01.htmlæ–‡ä»¶ä¸­ï¼Œæˆ‘é—¨è‡ªå·±æŒ‡å®šäº†æ ·å¼ï¼Œå› æ­¤èƒŒæ™¯é¢œè‰²å°±å’Œæ¨¡ç‰ˆçš„ä¸åŒäº† è®¿é—®baseé¡µé¢ï¼Œç‚¹å‡»èœå•2ï¼Œè¿”å›é¡µé¢å¦‚ä¸‹ block.super() è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç»§æ‰¿æ¨¡æ¿é¢„ç•™å—çš„å†…å®¹çš„åŒæ—¶åœ¨è‡ªå®šä¹‰å†…å®¹ {% block content %} {{ block.super }} #å°†æ¨¡ç‰ˆä¸­çš„contentè¿™ä¸ªåç§°çš„å—ä¸­çš„å†…å®¹æ‹¿è¿‡æ¥ èœå•1çš„å†…å®¹ {% endblock %} 4.9urlåˆ«åå’Œåå‘è§£æ urlåˆ«åçš„ä½œç”¨æ˜¯å½“ä¿®æ”¹äº†urlçš„è®¿é—®è·¯å¾„ï¼Œè§†å›¾é€»è¾‘ä¸­è¿”å›çš„urlè·¯å¾„ä¹Ÿéœ€è¦æ”¹åŠ¨ï¼Œå…¶ä»–ç›¸å…³è”çš„åœ°æ–¹ä¹Ÿå¯èƒ½éœ€è¦æ”¹åŠ¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨urlä¸­å®šä¹‰ä¸€ä¸ªåˆ«åï¼Œå¦‚æœåç»­æ›´æ”¹äº†urlçš„è®¿é—®è·¯å¾„ï¼Œå…¶ä»–åœ°æ–¹åªéœ€è¦ç”¨åˆ°urlåˆ«åçš„åå‘è§£æå°±èƒ½è‡ªåŠ¨æ‰¾åˆ°åˆ«åå¯¹åº”çš„urlè·¯å¾„ï¼Œè¿™æ ·çš„è¯åªéœ€è¦ä¿®æ”¹urlè·¯å¾„è€Œä¸æ›´æ”¹å…¶ä½™åœ°æ–¹ å†™æ³•: url(r'^login/v2/', views.login,name='login'), è§†å›¾ä¸­åå‘è§£æ: from django.urls import reverse def login(request): print(reverse('login')) #/login/v2/ if request.method == 'GET': return render(request,'login.html') else: uname = request.POST.get('uname') pwd = request.POST.get('pwd') if uname == 'admin' and pwd == 'admin': return HttpResponse('ok') else: return redirect(reverse('login')) #ä½¿ç”¨åå‘è§£æ htmlæ¨¡æ¿æ¸²æŸ“æ—¶åå‘è§£æçš„è¯­æ³•{% url åˆ«å %} {% csrf_token %} ç”¨æˆ·å: å¯†ç : âš ï¸âš ï¸âš ï¸è¿›è¡Œhtmlæ¨¡æ¿æ¸²æŸ“æ—¶åå‘è§£ææ—¶ï¼Œå¦‚æœå®šä¹‰äº†å‘½åç©ºé—´ï¼Œåˆ™åœ¨htmlä¸­éœ€è¦å¦‚ä¸‹å†™æ³• htmlæ¨¡æ¿æ¸²æŸ“æ—¶åå‘è§£æçš„è¯­æ³•{% url å‘½åç©ºé—´:åˆ«å %} 4.10includeè·¯ç”±åˆ†å‘å’Œurlå‘½åç©ºé—´ 4.10.1includeè·¯ç”±åˆ†å‘ includeè·¯ç”±åˆ†å‘å°±æ˜¯å°†ä¸åŒçš„urlæ”¾åœ¨ä¸åŒçš„åº”ç”¨ç¨‹åºä¸‹çš„urlsæ–‡ä»¶ä¸­ï¼Œå…ˆåŒ¹é…ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„è·¯å¾„ï¼Œç„¶ååœ¨åˆ†åˆ«å»è¿™ä¸¤ä¸ªåº”ç”¨ç¨‹åºå¯¹åº”çš„urlsæ–‡ä»¶ä¸­æ‰¾ä¸‹ä¸€çº§ç›®å½• ä¾‹å¦‚ï¼Œç°åœ¨æœ‰app01å’Œapp02ä¸¤ä¸ªåº”ç”¨ç¨‹åºï¼Œç°åœ¨è®¾ç½®çš„è®¿é—®è·¯å¾„å¦‚ä¸‹ /app01/index /app02/index è®¿é—®åˆ°app01å°±å»app01è·¯å¾„ä¸‹æ‰¾index æ¥ä¸‹æ¥åšä¸€ä¸‹æ¼”ç¤º ç¬¬ä¸€æ­¥ã€åœ¨é¡¹ç›®ç›®å½•ä¸‹åŒåçš„ç›®å½•ä¸‹çš„urls.pyä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ ä»£ç çš„æ„æ€æ˜¯è®¿é—®app01å°±å»æ‰¾app01.urlsæ–‡ä»¶ï¼Œè®¿é—®app02å°±å»æ‰¾app02.urlsæ–‡ä»¶ï¼Œnamespaceæ˜¯å‘½åç©ºé—´ï¼Œä¸ºäº†é˜²æ­¢è·¯ç”±åˆ†å‘ä¸­å‡ºç°åŒåçš„urlåˆ«åå¼•å‘çš„é”™è¯¯ #éœ€è¦å¯¼å…¥include from django.conf.urls import url,include from django.contrib import admin urlpatterns = [ #æ³¨æ„ï¼Œåˆå§‹çš„adminéœ€è¦æ³¨é‡Š #url(r'^admin/', admin.site.urls), url(r'^index/', views.index), url(r'^app01/', include('app01.urls',namespace='app01')), url(r'^app02/', include('app02.urls',namespace='app02')), ] #åŒ¹é…è¯´æ˜ /app01/index å…ˆåŒ¹é…app01è¿™ä¸ªè·¯å¾„ï¼Œç„¶ååˆ°app01urlä¸­å†™çš„includeåŒ…å«çš„urlsæ–‡ä»¶ä¸­åœ¨å»æ‰¾indexè·¯å¾„ ç¬¬äºŒæ­¥ã€åœ¨å„ä¸ªappåº”ç”¨ç›®å½•ä¸‹é¢åˆ›å»ºurls.pyæ–‡ä»¶ï¼Œåœ¨urls.pyæ–‡ä»¶ä¸­å†™è‡ªå·±åº”ç”¨çš„å„ä¸ªè·¯å¾„ app01 from django.conf.urls import url, include from django.contrib import admin from app01 import views urlpatterns = [ url(r'^index/', views.index, name='index'), ] app02 from django.conf.urls import url, include from django.contrib import admin from app02 import views urlpatterns = [ url(r'^index/', views.index,name='index'), ] ç¬¬ä¸‰æ­¥ã€ç¼–å†™viewsæ–‡ä»¶ app01 viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse # Create your views here. def index(request): return HttpResponse('app01-index') app02 viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse # Create your views here. def index(request): return HttpResponse('app02-index') æµè§ˆå™¨è®¿é—®ç»“æœ è®¿é—®127.0.0.1/app01/index è®¿é—®127.0.0.1/app02/index 4.10.2urlå‘½åç©ºé—´ æ³¨æ„ï¼šurlå‘½åç©ºé—´æ˜¯åœ¨è¿›è¡Œè·¯ç”±åˆ†å‘çš„æ—¶å€™å†™çš„ï¼Œè€Œurlåˆ«åæ˜¯åœ¨urlsæ–‡ä»¶ä¸­æŒ‡å®šè·¯å¾„çš„æ—¶å€™å†™çš„åˆ«å urlå‘½åç©ºé—´æ˜¯ä¸ºäº†é˜²æ­¢urlæœ‰ç›¸åŒåˆ«åè€Œå¯¼è‡´çš„é—®é¢˜ å†™æ³•: url(r'^app01/', include('app01.urls',namespace='app01')), å°†æ¯ä¸ªåº”ç”¨è‡ªå·±çš„urlè·¯å¾„åˆ’åˆ†ä¸€ä¸ªç©ºé—´,å°†æ¥é€šè¿‡åˆ«ååå‘è§£ææ—¶,é€šè¿‡ç©ºé—´åç§°å¯ä»¥æ‰¾åˆ°å¯¹åº”åº”ç”¨ä¸‹é¢çš„è·¯å¾„ ä½¿ç”¨: views.pyæ–‡ä»¶ä¸­å†™æ³• from django.urls import reverse def index(request): print('app01åå‘è§£æ:', reverse('app01:index')) #app02åå‘è§£æ: /app02/index/ return HttpResponse('app01-index') #reverse('app01:index') app01å°±æ˜¯å‘½åç©ºé—´ indexå°±æ˜¯app01ä¸‹çš„indexè·¯å¾„ htmlä¸­å†™æ³•: {% url 'app01:login' %} æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonè¿›é˜¶/django/5.django ORM.html":{"url":"python/pythonè¿›é˜¶/django/5.django ORM.html","title":"djangoåŸºç¡€äº” ORM","keywords":"","body":"5.ORM 5.1ORMç®€ä»‹ MVCæˆ–è€…MVCæ¡†æ¶ä¸­åŒ…æ‹¬ä¸€ä¸ªé‡è¦çš„éƒ¨åˆ†ï¼Œå°±æ˜¯ORMï¼Œå®ƒå®ç°äº†æ•°æ®æ¨¡å‹ä¸æ•°æ®åº“çš„è§£è€¦ï¼Œå³æ•°æ®æ¨¡å‹çš„è®¾è®¡ä¸éœ€è¦ä¾èµ–äºç‰¹å®šçš„æ•°æ®åº“ï¼Œé€šè¿‡ç®€å•çš„é…ç½®å°±å¯ä»¥è½»æ¾æ›´æ¢æ•°æ®åº“ï¼Œè¿™æå¤§çš„å‡è½»äº†å¼€å‘äººå‘˜çš„å·¥ä½œé‡ï¼Œä¸éœ€è¦é¢å¯¹å› æ•°æ®åº“å˜æ›´è€Œå¯¼è‡´çš„æ— æ•ˆåŠ³åŠ¨ ORMæ˜¯â€œå¯¹è±¡-å…³ç³»-æ˜ å°„â€çš„ç®€ç§°ã€‚ï¼ˆObject Relational Mappingï¼Œç®€ç§°ORMï¼‰ ORMæ‰§è¡Œçš„è¿‡ç¨‹ ç±»å¯¹è±¡--->sql--->pymysql--->mysqlæœåŠ¡ç«¯--->ç£ç›˜ï¼Œormå…¶å®å°±æ˜¯å°†ç±»å¯¹è±¡çš„è¯­æ³•ç¿»è¯‘æˆsqlè¯­å¥çš„ä¸€ä¸ªå¼•æ“ ORMä¸åŸç”ŸSQLå¯¹æ¯” 5.2ORMæ“ä½œ 5.2.1ORMè¿æ¥mysql è¿™é‡Œå…ˆæ¥ä¸€ä¸ªormè¿æ¥mysqlå¹¶åˆ›å»ºä¸€å¼ è¡¨çš„ç¤ºä¾‹ ç¬¬ä¸€æ­¥ã€ä¿®æ”¹settingsé…ç½®æ–‡ä»¶ï¼Œé…ç½®mysqlç›¸å…³ä¿¡æ¯ #å…ˆæ³¨é‡Šé»˜è®¤é¡¹ # DATABASES = { # 'default': { # 'ENGINE': 'django.db.backends.sqlite3', # 'NAME': os.path.join(BASE_DIR, 'db.sqlite3'), # } # } DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'æ•°æ®åº“å', 'HOST': 'æ•°æ®åº“IP', 'PORT': 'æ•°æ®åº“ç«¯å£', 'USER': 'ç”¨æˆ·', 'PASSWORD': 'å¯†ç ' } } ç¬¬äºŒæ­¥ã€åœ¨é¡¹ç›®ç›®å½•ä¸‹çš„åŒåç›®å½•ä¸‹çš„__init__.pyæ–‡ä»¶ä¸­å†™ä¸Šä»¥ä¸‹å†…å®¹,æ¥æŒ‡å®špymysqlä½œä¸ºè¿æ¥å®¢æˆ·ç«¯ import pymysql pymysql.install_as_MySQLdb() ç¬¬ä¸‰æ­¥ã€åœ¨åº”ç”¨ç¨‹åºç›®å½•ä¸‹é¢çš„models.pyæ–‡ä»¶ä¸­å†™å¯¹åº”çš„ç±»ï¼Œè¿™é‡Œä¸ºåˆ›å»ºä¸€å¼ è¡¨ from django.db import models #è¿™é‡Œè¡¨ç¤ºåˆ›å»ºä¸€ä¸ªuserinfoè¡¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdjangoåœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ä¼šæŠŠè¡¨åå°å†™å¹¶é‡å‘½åä¸º åº”ç”¨ç¨‹åº_userinfo class UserInfo(models.Model): id = models.AutoField(primary_key=True) username = models.CharField(max_length=10) password = models.CharField(max_length=32) ç¬¬å››æ­¥: æ‰§è¡Œæ•°æ®åº“åŒæ­¥æŒ‡ä»¤ï¼Œåœ¨ç»ˆç«¯ä¸­æ‰§è¡Œï¼Œæ‰§è¡Œçš„è·¯å¾„æ˜¯djangoé¡¹ç›®ä¸‹ #åœ¨migrationsæ–‡ä»¶å¤¹ä¸‹é¢ç”Ÿæˆè®°å½•æ–‡ä»¶ python3 manage.py makemigrations #æ‰§è¡Œè®°å½•æ–‡ä»¶ python3 manage.py migrate å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„è¡¨å·²ç»åˆ›å»ºå®Œæˆäº†ï¼Œä½†æ˜¯å‘ç°å¤šäº†å¥½å¤šå…¶ä»–çš„è¡¨ï¼Œé‚£è¿™äº›è¡¨æ˜¯ä»å“ªæ¥çš„å‘¢ï¼Œè¿™äº›æ˜¯djangoä»settingsæ–‡ä»¶ä¸­å¾ªç¯è¯»å–INSTALLED_APPSä¸‹çš„æ‰€æœ‰å­é¡¹è€Œé»˜è®¤åˆ›å»ºçš„è¡¨ è¡¨ç»“æ„ 5.2.2å•è¡¨æ“ä½œ 5.2.2.1å¢ åº”ç”¨ç¨‹åºçš„models.pyæ–‡ä»¶ä¸­å·²ç»å®šä¹‰äº†åˆ›å»ºä¸€å¼ è¡¨çš„è¯­å¥ urlsæ–‡ä»¶ from app01 import views urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^index/', views.index), ] viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse from app01 import models #æ–¹å¼1 def index(request): obj = models.UserInfo( username='å°æ˜', password='123' ) obj.save() return HttpResponse('ok') #æ–¹å¼2 def index(request): models.UserInfo.objects.create( username='å°é¢–', password='666' ) return HttpResponse('ok') æ¥ä¸‹æ¥å¯åŠ¨djangoé¡¹ç›®ï¼Œæµè§ˆå™¨è®¿é—®æˆ‘ä»¬æŒ‡å®šçš„127.0.0.1:8000/index æ‰§è¡Œä»¥ä¸Šä»»æ„ä¸€ç§æ–¹å¼éƒ½å¯ä»¥æ’å…¥æ•°æ® 5.2.2.2åˆ  viewsæ–‡ä»¶ def index(request): #åˆ é™¤UserInfoè¡¨ä¸­idå€¼ä¸º1çš„å€¼ models.UserInfo.objects.filter(id=1).delete() return HttpResponse('ok') æµè§ˆå™¨è®¿é—®127.0.0.1/indexå³å¯æˆåŠŸæ‰§è¡Œè¯­å¥ å¯ä»¥çœ‹åˆ°ï¼Œidä¸º1çš„å­—æ®µå·²ç»è¢«åˆ é™¤ 5.2.2.3æ”¹ viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse from app01 import models # Create your views here. def index(request): # æ–¹å¼1 models.UserInfo.objects.filter(id=2).update( username='abc', password='abc', ) # æ–¹å¼2 # obj = models.UserInfo.objects.filter(id=2)[0] # obj.username = 'ggg' # obj.password = 'ggg' # obj.save() return HttpResponse('ok') æµè§ˆå™¨è®¿é—®127.0.0.1/index å¯ä»¥çœ‹åˆ°ä¿®æ”¹å·²ç»ç”Ÿæ•ˆ æ‰¹é‡åˆ›å»º viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse from app01 import models # Create your views here. def index(request): list_obj = [] for i in range(6): obj = models.UserInfo( username='name%s' %i, password='pwd%s' %i, ) list_obj.append(obj) print(list_obj) models.UserInfo.objects.bulk_create(list_obj) return HttpResponse('ok') print(list_obj)è¿”å›çš„ç»“æœå¦‚ä¸‹ [, , , , , ] æµè§ˆå™¨è®¿é—®127.0.0.1/index å¯ä»¥çœ‹åˆ°å·²ç»æ‰¹é‡æ’å…¥äº†æ•°æ® update_or_create æœ‰å°±æ›´æ–°,æ²¡æœ‰å°±åˆ›å»º from django.shortcuts import render,HttpResponse from app01 import models # Create your views here. def index(request): a,b = models.UserInfo.objects.update_or_create( username='name0', defaults={ 'id': 20, 'password': 'abcdef', } ) print(a) #å½“å‰æ›´æ–°åçš„modelå¯¹è±¡,æˆ–è€…æ˜¯ä½ æ–°å¢çš„è®°å½•çš„modelå¯¹è±¡ print(b) #æ–°å¢å°±æ˜¯True,æŸ¥è¯¢å°±False return HttpResponse('ok') #aè¿”å›çš„ç»“æœ UserInfo object #bè¿”å›çš„ç»“æœ True 5.2.2.4æŸ¥ æœ€ç®€å•çš„æŸ¥è¯¢ from django.shortcuts import render,HttpResponse from app01 import models # Create your views here. def index(request): ret = models.UserInfo.objects.filter(id=1) print(ret) # ]> -- [] obj = ret[0] print(obj.id, obj.username) return HttpResponse('ok') è¡¨app01_userinfoå†…å®¹å¦‚ä¸‹ print(ret)ç»“æœå¦‚ä¸‹ ]> print(obj.id, obj.username)æ‰§è¡Œåç»“æœå¦‚ä¸‹ 1 aaa æŸ¥è¯¢éå¸¸é‡è¦çš„13ç§æ–¹æ³• 1 all() æŸ¥è¯¢æ‰€æœ‰ç»“æœï¼Œç»“æœæ˜¯querysetç±»å‹ viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse from app01 import models # Create your views here. def index(request): ret = models.UserInfo.objects.all() print(ret) return HttpResponse('ok') #print(ret)ç»“æœå¦‚ä¸‹ , ]> ç°åœ¨æˆ‘ä»¬æƒ³çœ‹åˆ°çš„æ˜¯æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œéœ€è¦åœ¨modelsæ–‡ä»¶ä¸­æˆ‘ä»¬åˆ›å»ºçš„UserInfoä¸­å†™ä¸€ä¸ªç±»çš„å±æ€§ class UserInfo(models.Model): id = models.AutoField(primary_key=True) username = models.CharField(max_length=10) password = models.CharField(max_length=32) #åœ¨modelsæ–‡ä»¶ä¸­å†™ä¸Šè¿™ä¸ªå±æ€§åå°±èƒ½åœ¨all()æ–¹æ³•ä¸­è¿”å›æ•°æ®è€Œä¸æ˜¯å¯¹æˆé‚£ä¸ª def __str__(self): return self.username #ç»“æœå¦‚ä¸‹ , ]> 2 get() åªèƒ½è¿”å›ä¸€ä¸ªæ•°æ®ï¼Œæ²¡æœ‰æˆ–è€…æ•°æ®å¤šå°±æŠ¥é”™ï¼Œä¸æ˜¯querysetç±»å‹ï¼Œæ˜¯è¡Œè®°å½•å¯¹è±¡ ä¾‹å¦‚ï¼ŒæŸ¥è¯¢ä¸€ä¸ªè¡¨ä¸­å¯†ç ä¸ºaaaçš„æ•°æ®ï¼Œå¦‚æœè¿™ä¸ªè¡¨ä¸­åªæœ‰ä¸€ä¸ªç”¨æˆ·çš„å¯†ç æ˜¯aaaï¼Œåˆ™å¯ä»¥æŸ¥è¯¢æˆåŠŸï¼Œå¦‚æœè¿™ä¸ªè¡¨ä¸­æœ‰å¤šä¸ªç”¨æˆ·çš„å¯†ç æ˜¯aaaè¿™ä¸ªæ—¶å€™å°±ä¼šæŠ¥é”™å¹¶ä¸”è¿™ä¸ªè¡¨ä¸­å¦‚æœæ²¡æœ‰ç”¨æˆ·çš„å¯†ç æ˜¯aaaåŒæ ·ä¼šæŠ¥é”™ from django.shortcuts import render,HttpResponse from app01 import models # Create your views here. def index(request): ret = models.UserInfo.objects.get(password='aaa') print(ret) return HttpResponse('ok') è¡¨app01_userinfoå†…å®¹å¦‚ä¸‹ æµè§ˆå™¨è®¿é—®127.0.0.1/index æ­¤æ—¶è¿”å›çš„ç»“æœæ˜¯å¯ä»¥æˆåŠŸæŸ¥è¯¢çš„ ç°åœ¨ä¿®æ”¹è¡¨å†…å®¹å¦‚ä¸‹ å†æ¬¡æ‰§è¡Œä»¥ä¸Šä»£ç ï¼ŒæŸ¥è¯¢è¡¨ä¸­å¯†ç ä¸ºaaaçš„æ•°æ®ï¼Œæ­¤æ—¶ä¼šæŠ¥é”™ ä¿®æ”¹ä»£ç ä¸ºæŸ¥è¯¢è¡¨ä¸­å¯†ç ä¸ºbbbçš„æ•°æ®ï¼ŒåŒæ ·ä¼šæŠ¥é”™ getä¸¤ä¸ªæŠ¥é”™,ä½†æ˜¯getè¯·æ±‚è¿”å›çš„ç»“æœæ˜¯modelå¯¹è±¡ #1.UserInfo matching query does not exist. æ²¡æœ‰æŸ¥åˆ°çš„æŠ¥é”™ #2 get() returned more than one UserInfo -- it returned 11! ç»“æœå¤šäº†,ä¸è¡Œ! 3 filter() æŸ¥è¯¢æ•°æ®ï¼Œè¿”å›å€¼æ˜¯querysetç±»å‹ viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse from app01 import models # Create your views here. def index(request): ret = models.UserInfo.objects.filter(password='bbb') print(ret) return HttpResponse('ok') filteræŸ¥è¯¢è¡¨ä¸­å¯†ç ä¸ºbbbçš„æ•°æ®ï¼Œè™½ç„¶è¡¨ä¸­ç»“æœæ²¡æœ‰ï¼Œä½†æ˜¯ä¸ä¼šåƒgetæŠ¥é”™ print(ret)ç»“æœå¦‚ä¸‹ filteræŸ¥è¯¢è¡¨ä¸­å¯†ç ä¸ºaaaçš„æ•°æ®ï¼Œè¡¨ä¸­å¯†ç ä¸ºaaaçš„æ•°æ®æœ‰2æ¡ï¼Œfilterä¸ä¼šåƒgetä¸€æ ·æŠ¥é”™ , ]> 4 exclude() æ’é™¤ï¼Œè¿”å›å€¼æ˜¯querysetç±»å‹ ç°æœ‰app01_bookè¡¨å¦‚ä¸‹ æŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼Œæ’é™¤bidä¸º4çš„æ•°æ® urlsæ–‡ä»¶ from django.conf.urls import url,include from django.contrib import admin from app01 import views urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^index/', views.index), ] viewsæ–‡ä»¶ from django.shortcuts import render,reverse,redirect,HttpResponse from app01 import models def index(request): #æŸ¥è¯¢bidä¸ä¸º4çš„æ•°æ®ï¼Œè¿™é‡Œè¿˜å¯ä»¥å†™å¤šä¸ªæ’é™¤æ¡ä»¶ï¼Œä»¥é€—å·åˆ†éš” ret = models.Book.objects.exclude(bid=4) print(ret) return HttpResponse('ok') modelsæ–‡ä»¶ class Book(models.Model): bid = models.AutoField(primary_key=True) bname = models.CharField(max_length=20) price = models.DecimalField(max_digits=6,decimal_places=2) publish_date = models.DateField(auto_now_add=False) publish = models.CharField(max_length=20) def __str__(self): return self.bname æµè§ˆå™¨è®¿é—®127.0.0.1/indexï¼Œè¿”å›ç»“æœå¦‚ä¸‹ï¼Œbidä¸º4çš„éš”å£è€ç‹çš„æ•…äº‹æ²¡æœ‰è¿”å› , , , , ]> 5 order_by() querysetç±»å‹çš„æ•°æ®æ¥è°ƒç”¨ï¼Œå¯¹æŸ¥è¯¢ç»“æœæ’åº,é»˜è®¤æ˜¯æŒ‰ç…§idæ¥å‡åºæ’åˆ—çš„ï¼Œè¿”å›å€¼æ˜¯querysetç±»å‹ æŒ‰ç…§bidå€’åºæ’åºï¼Œåœ¨bidå‰åŠ ä¸ª-å·å³å¯ viwesæ–‡ä»¶ def index(request): ret = models.Book.objects.all().order_by('-bid') print(ret) return HttpResponse('ok') æµè§ˆå™¨åé—®127.0.0.1/indexï¼Œè¿”å›ç»“æœå¦‚ä¸‹ï¼Œç»“æœæ˜¯å€’åº , , , , , ]> order_by()ä¸­åŠ å¤šä¸ªæ¡ä»¶è¯´æ˜ #è¿™æ®µä»£ç çš„æ„æ€æ˜¯æŒ‰ç…§idå€’å™æ’åºï¼Œç„¶åå†æŒ‰ç…§idç›¸åŒçš„æ•°æ®è¿›è¡Œä»·æ ¼å‡åºæ’åº models.Test.objects.all().order_by('-id','money') ç°æœ‰è¡¨app01_testå¦‚ä¸‹ å…ˆæŒ‰ç…§idè¿›è¡Œå€’å™æ’åº ret = models.Test.objects.all().order_by('-id') print(ret.values()) è¿”å›ç»“æœå¦‚ä¸‹ å†åŠ ä¸€ä¸ªæ¡ä»¶è¿›è¡Œæ’åºï¼Œå…ˆæ ¹æ®idç›¸åŒçš„è¿›è¡Œå€’åºæ’åºï¼Œç„¶åå†æ ¹æ®moneyå‡åºæ’åº ret = models.Test.objects.order_by('-id','money') print(ret.values()) è¿”å›ç»“æœå¦‚ä¸‹ 6 reverse() querysetç±»å‹çš„æ•°æ®æ¥è°ƒç”¨ï¼Œå¯¹æŸ¥è¯¢ç»“æœåå‘æ’åºï¼Œè¿”å›å€¼è¿˜æ˜¯querysetç±»å‹ ä»¥ä¾‹5ä¸­app01_testè¡¨ä¸ºä¾‹ âš ï¸ç›´æ¥è¿›è¡Œreverseè¿›è¡Œåå‘æ’åºæ˜¯ä¸ç”Ÿæ•ˆçš„ï¼Œå¿…é¡»å…ˆè¿›è¡Œåˆ†ç»„ ret = models.Test.objects.all().reverse() è¿”å›ç»“æœå¦‚ä¸‹ï¼Œä¸åˆ†ç»„è¿›è¡Œåå‘æ’åºæ˜¯ä¸ç”Ÿæ•ˆçš„ å…ˆè¿›è¡Œåˆ†ç»„ï¼Œç„¶åå†è¿›è¡Œåå‘æ’åºæ‰èƒ½ç”Ÿæ•ˆ ret = models.Test.objects.all().order_by('id').reverse() è¿”å›ç»“æœå¦‚ä¸‹ 7 count() querysetç±»å‹çš„æ•°æ®æ¥è°ƒç”¨ï¼Œè¿”å›æ•°æ®åº“ä¸­åŒ¹é…æŸ¥è¯¢(QuerySet)çš„å¯¹è±¡æ•°é‡ ä»¥ä¾‹5ä¸­app01_testè¡¨ä¸ºä¾‹ ret = models.Test.objects.all().count() print(ret) è¿”å›ç»“æœä¸º5ï¼Œå› ä¸ºapp01_testè¡¨ä¸­æœ‰5æ¡è®°å½• 8 first() querysetç±»å‹çš„æ•°æ®æ¥è°ƒç”¨ï¼Œè¿”å›ç¬¬ä¸€æ¡è®°å½•ï¼Œå¾—åˆ°çš„éƒ½æ˜¯modelå¯¹è±¡ï¼Œä¸æ˜¯queryset ä»¥ä¾‹5ä¸­app01_testè¡¨ä¸ºä¾‹ ret = models.Test.objects.all().first() print(ret) #modelsæ–‡ä»¶è¡¨çš„ç±»ä¸­éœ€è¦å†™å¦‚ä¸‹ä»£ç  class Test(models.Model): id = models.IntegerField(primary_key=True) name = models.CharField(max_length=10) money = models.IntegerField() def __str__(self): return self.name è¿”å›ç»“æœä¸º1-å°æ˜ 9 last() querysetç±»å‹çš„æ•°æ®æ¥è°ƒç”¨ï¼Œè¿”å›æœ€åä¸€æ¡è®°å½•ï¼Œå¾—åˆ°çš„æ˜¯modelå¯¹è±¡ ä»¥ä¾‹5ä¸­app01_testè¡¨ä¸ºä¾‹ ret = models.Test.objects.all().last() print(ret) #modelsæ–‡ä»¶è¡¨çš„ç±»ä¸­éœ€è¦å†™å¦‚ä¸‹ä»£ç  class Test(models.Model): id = models.IntegerField(primary_key=True) name = models.CharField(max_length=10) money = models.IntegerField() def __str__(self): return self.name æŸ¥è¯¢æ—¶é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨lastæ–¹æ³•æŸ¥è¯¢ä¸€ä¸ªæ²¡æœ‰è®¾ç½®ä¸»é”®çš„è¡¨æ—¶ï¼Œåªèƒ½è¿”å›idç›¸åŒçš„è®°å½•ä¸­çš„ç¬¬ä¸€ä¸ªidçš„è®°å½• ä¾‹å¦‚ï¼Œä¸€å¼ è¡¨ä¸­idå­—æ®µå¦‚ä¸‹ï¼š1ã€2ã€3ã€3ã€3ï¼ŒæŸ¥è¯¢çš„è¿”å›çš„ç»“æœæ˜¯id=3çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå³2åè¾¹çš„ç¬¬ä¸€ä¸ª3 æ­¤è¡¨ä¸­æ²¡æœ‰è®¾ç½®ä¸»é”®ï¼Œåªèƒ½è¿”å›3-å¤§å¼ºï¼Œè€Œç†è®ºä¸Šæ˜¯3-å“ˆå“ˆ 10 exists() querysetç±»å‹çš„æ•°æ®æ¥è°ƒç”¨ï¼Œå¦‚æœQuerySetåŒ…å«æ•°æ®ï¼Œå°±è¿”å›Trueï¼Œå¦åˆ™è¿”å›False ç©ºçš„querysetç±»å‹æ•°æ®ä¹Ÿæœ‰å¸ƒå°”å€¼Trueå’ŒFalseï¼Œä½†æ˜¯ä¸€èˆ¬ä¸ç”¨å®ƒæ¥åˆ¤æ–­æ•°æ®åº“é‡Œé¢æ˜¯ä¸æ˜¯æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰å¤§é‡çš„æ•°æ®ï¼Œä½ ç”¨å®ƒæ¥åˆ¤æ–­ï¼Œé‚£ä¹ˆå°±éœ€è¦æŸ¥è¯¢å‡ºæ‰€æœ‰çš„æ•°æ®ï¼Œæ•ˆç‡å¤ªå·®äº†ï¼Œç”¨countæˆ–è€…exits ä¾‹ï¼šall_books = models.Book.objects.all().exists() #ç¿»è¯‘æˆçš„sqlæ˜¯SELECT (1) AS a FROM app01_book LIMIT 1ï¼Œå°±æ˜¯é€šè¿‡limit 1ï¼Œå–ä¸€æ¡æ¥çœ‹çœ‹æ˜¯ä¸æ˜¯æœ‰æ•°æ® ä»¥ä¾‹5ä¸­app01_testè¡¨ä¸ºä¾‹ testè¡¨ä¸­æ²¡æœ‰id=5çš„æ•°æ®ï¼Œå› æ­¤ä¼šè¿”å›False ret = models.Test.objects.filter(id=5).exists() 11 values() ç”¨çš„æ¯”è¾ƒå¤šï¼Œquerysetç±»å‹çš„æ•°æ®æ¥è°ƒç”¨ï¼Œè¿”å›ä¸€ValueQuerySetâ€”â€”ä¸€ä¸ªç‰¹æ®Šçš„QuerySetï¼Œè¿è¡Œåå¾—åˆ°çš„å¹¶ä¸æ˜¯ä¸€ç³»åˆ—modelçš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å­—å…¸åºåˆ—,åªè¦æ˜¯è¿”å›çš„querysetç±»å‹ï¼Œå°±å¯ä»¥ç»§ç»­è¿ç»­è°ƒç”¨querysetç±»å‹çš„å…¶ä»–çš„æŸ¥æ‰¾æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ ä»¥ä¾‹5ä¸­app01_testè¡¨ä¸ºä¾‹ ret = models.UserInfo.objects.all().values('id','name') querysetè°ƒç”¨ ret = models.UserInfo.objects.values('id','name') objectsè°ƒç”¨--å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œå–å€¼ è¿”å›ç»“æœå¦‚ä¸‹ 12 values_list å®ƒä¸values()éå¸¸ç›¸ä¼¼ï¼Œå®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªå…ƒç»„åºåˆ—ï¼Œvaluesè¿”å›çš„æ˜¯ä¸€ä¸ªå­—å…¸åºåˆ— ä»¥ä¾‹5ä¸­app01_testè¡¨ä¸ºä¾‹ ret = models.Test.objects.all().values_list('id','name') è¿”å›ç»“æœå¦‚ä¸‹ 13 distinct() valueså’Œvalues_listå¾—åˆ°çš„querysetç±»å‹çš„æ•°æ®æ¥è°ƒç”¨ï¼Œä»è¿”å›ç»“æœä¸­å‰”é™¤é‡å¤çºªå½• ä»¥ä¾‹5ä¸­app01_testè¡¨ä¸ºä¾‹ ret = models.UserInfo.objects.all().values('id','name').distinct() ret = models.UserInfo.objects.values('id','name').distinct() åŸºäºåŒä¸‹åˆ’çº¿çš„æ¨¡ç³ŠæŸ¥è¯¢ è¡¨app01_bookå†…å®¹å¦‚ä¸‹ #priceå€¼ç­‰äºè¿™ä¸‰ä¸ªé‡Œé¢çš„ä»»æ„ä¸€ä¸ªçš„å¯¹è±¡ Book.objects.filter(price__in=[10,33,9999]) #å¤§äºï¼Œå¤§äºç­‰äºæ˜¯price__gte=100ï¼Œåˆ«å†™price>100ï¼Œè¿™ç§å‚æ•°ä¸æ”¯æŒ Book.objects.filter(price__gt=100) #å°äºï¼Œå°äºç­‰äºæ˜¯price__lte=100ï¼Œåˆ«å†™price æŸ¥è¯¢ç¤ºä¾‹ 1 æŸ¥è¯¢æŸæŸå‡ºç‰ˆç¤¾å‡ºç‰ˆè¿‡çš„ä»·æ ¼å¤§äº100çš„ä¹¦ç± ret = models.Book.objects.filter(price__gt=100,publish='è€ç‹å‡ºç‰ˆç¤¾').values('bname') 2 æŸ¥è¯¢2018å¹´11æœˆå‡ºç‰ˆçš„æ‰€æœ‰ä»¥Liå¼€å¤´çš„ä¹¦ç±åç§° ret = models.Book.objects.filter(bname__startswith='Linux',publish_date__year=2018,publish_date__month=11).values('bname') 3 æŸ¥è¯¢ä»·æ ¼ä¸º88,100æˆ–è€…9999çš„æ‰€æœ‰ä¹¦ç±åç§°åŠå…¶å‡ºç‰ˆç¤¾åç§° ret = models.Book.objects.filter(price__in=[88,100,9999]).values('bname','publish') 4 æŸ¥è¯¢ä»·æ ¼åœ¨80åˆ°100ä¹‹é—´çš„æ‰€æœ‰ä¹¦ç±åç§°åŠå…¶ä»·æ ¼ ret = models.Book.objects.filter(price__range=[80,100]).values('bname','price') 5 æŸ¥è¯¢æ‰€æœ‰è€ç‹å‡ºç‰ˆç¤¾å‡ºç‰ˆçš„ä¹¦ç±çš„ä»·æ ¼ï¼ˆä»é«˜åˆ°ä½æ’åºï¼Œå»é‡ï¼‰ ret = models.Book.objects.filter(publish='è€ç‹å‡ºç‰ˆç¤¾').values('price').order_by('-price').distinct() 5.2.3å¤šè¡¨æ“ä½œ è¡¨å…³ç³»åŠå­—æ®µè®¾è®¡ urlsæ–‡ä»¶ from django.conf.urls import url from django.contrib import admin from app01 import views urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^query/', views.query), ] settingsæ–‡ä»¶é…ç½®æ•°æ®åº“è¿æ¥ DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'orm01', 'HOST': '127.0.0.1', 'PORT': '3306', 'USER': 'root', 'PASSWORD': 'xxx' } } modelsæ–‡ä»¶ from django.db import models # Create your models here. class Author(models.Model): name=models.CharField(max_length=32) age=models.IntegerField() ad=models.OneToOneField(to=\"AuthorDetail\",to_field=\"id\",on_delete=models.CASCADE) # to_field=\"id\" å¯ä»¥ä¸å†™,é»˜è®¤æ‰¾ä¸»é”® # to=\"AuthorDetail\", to=å¯ä»¥ä¸ç”¨å†™ # models.SET_NULL ç½®ç©º # on_delete=models.CASCADE é»˜è®¤æ˜¯çº§è”åˆ é™¤,æƒ³åšçº§è”æ›´æ–°,ç›´æ¥å»æ•°æ®åº“ä¿®æ”¹è¡¨ç»“æ„ class AuthorDetail(models.Model): birthday=models.DateField() telephone=models.CharField(max_length=16) addr=models.CharField(max_length=64) class Publish(models.Model): name=models.CharField(max_length=32) city=models.CharField(max_length=32) class Book(models.Model): title = models.CharField(max_length=32) publishDate=models.DateField() price=models.DecimalField(max_digits=5,decimal_places=2) publishs=models.ForeignKey(to=\"Publish\",to_field=\"id\",on_delete=models.CASCADE) #è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ç”Ÿæˆç¬¬3å¼ è¡¨å…³è”bookè¡¨å’Œauthorè¡¨ authors=models.ManyToManyField(to='Author',) âš ï¸å¦‚æœAuthorDetailå†™åœ¨Authorçš„ä¸Šè¾¹ï¼Œåˆ™ad=models.OneToOneField(to=\"AuthorDetail\"ä¸­çš„AuthorDetailå¯ä»¥ä¸åŠ å¼•å· âš ï¸django1.xç‰ˆæœ¬on_delete=models.CASCADEå¯ä»¥ä¸å†™ï¼Œé»˜è®¤æ˜¯çº§è¿åˆ é™¤ï¼Œå¦‚æœæƒ³åšçº§è¿æ›´æ–°ï¼Œç›´æ¥åˆ°æ•°æ®åº“ä¸­æ“ä½œï¼Œä½†æ˜¯django2.xå¿…é¡»å†™çº§è¿åˆ é™¤ âš ï¸OneToOneFieldæ˜¯ä¸€å¯¹ä¸€ ForeignKeyæ˜¯ä¸€å¯¹å¤š ManyToManyFieldæ˜¯å¤šå¯¹å¤š djangoé¡¹ç›®ä¸‹åŒåç›®å½•__init__.pyæ–‡ä»¶ import pymysql pymysql.install_as_MySQLdb() ç›¸å…³é…ç½®æ–‡ä»¶é…ç½®å®Œæˆåå¼€å§‹åŒæ­¥æ•°æ®åº“ âš ï¸makemigrationsæ‰§è¡Œåå¿…é¡»æ‰§è¡Œmigrateï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜ //åœ¨djangoé¡¹ç›®ä¸‹ #åœ¨migrationsç›®å½•ä¸‹é¢ç”Ÿæˆè®°å½•æ–‡ä»¶ python3 manage.py makemigrations #æ‰§è¡Œè®°å½•æ–‡ä»¶ python3 manage.py migrate å…³äºåªæ‰§è¡Œmakemigrationsä¸æ‰§è¡Œmigrateå¯èƒ½å‡ºç°çš„é—®é¢˜ 1.å½“æ‰§è¡Œmakemigrationsåï¼Œä¼šåœ¨djangoé¡¹ç›®ä¸‹çš„makemigrationsç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª0001_initial.pyï¼Œè¿™ä¸ªæ–‡ä»¶è®°å½•çš„æ˜¯modelsæ–‡ä»¶ä¸­çš„æ“ä½œ(åˆ›å»ºè¡¨ã€åˆ é™¤è¡¨)ï¼Œå½“æ‰§è¡Œmigrateåä¼šæ‰§è¡Œæ•°æ®åº“åŒæ­¥æ“ä½œï¼ŒåŒæ—¶åœ¨æ•°æ®åº“ä¸­djangoä¼šè‡ªåŠ¨åˆ›å»ºä¸€å¼ django_migrationsè¡¨ï¼Œè¿™ä¸ªè¡¨è®°å½•çš„æ˜¯modelsæ–‡ä»¶ä¸­çš„æ“ä½œ 2.å¦‚æœåªæ‰§è¡Œäº†makemigrationsè€Œä¸æ‰§è¡Œmigrateï¼Œå½“ä¿®æ”¹äº†modelsæ–‡ä»¶å†æ¬¡é‡å¤æ‰§è¡Œmakemigrationsï¼Œdjangoä¼šä»æ•°æ®åº“ä¸­çš„django_migrationsæŸ¥çœ‹0001_initialæ˜¯å¦æ‰§è¡Œè¿‡ï¼Œè€Œæ­¤æ—¶0001_initialå·²ç»æ‰§è¡Œè¿‡äº†ï¼Œå› æ­¤ä¼šå‡ºç°ä¿®æ”¹äº†modelsæ–‡ä»¶æ‰§è¡Œmigrateæç¤ºæ²¡æœ‰æ”¹åŠ¨çš„é—®é¢˜ åŒæ­¥åçš„æ•°æ®åº“ï¼Œå¯ä»¥çœ‹åˆ°app01_book_authorsè¿™å¼ è¡¨æ˜¯ormè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºçš„ 5.2.3.1å¢ viewsæ–‡ä»¶ ä¸€å¯¹ä¸€ï¼Œä½œè€…è¡¨å’Œä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨ //ç»™ä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨æ·»åŠ ä¸€æ¡è®°å½• models.AuthorDetail.objects.create( birthday='2018-11-11', telephone='18033336789', addr='åŒ—äº¬' ) //ç»™ä½œè€…è¡¨æ·»åŠ ä¸€æ¡è®°å½• models.Author.objects.create( name='å°æ˜', age=1, #æ–¹å¼1 #å…³è”ä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨ä¸­idä¸º1çš„ ad=models.AuthorDetail.objects.get(id=1) #æ–¹å¼2(å¸¸ç”¨) ad_id = 1 ) ä¸€å¯¹å¤šï¼Œå‡ºç‰ˆç¤¾å’Œä¹¦ç±è¡¨ models.Book.objects.create( title='éš”å£è€ç‹çš„æ•…äº‹', publishDate='2011-01-01', price='99', #æ–¹å¼1 publishs=models.Publish.objects.get(id=1) #æ–¹å¼2 publishs_id=2 ) å¤šå¯¹å¤šï¼Œä¹¦ç±è¡¨å’Œä½œè€…è¡¨ //æ–¹å¼ä¸€ book_obj = models.Book.objects.get(id=1) author1 =models.Author.objects.get(id=1) author2 =models.Author.objects.get(id=2) #å‘å…³è”ä¹¦ç±è¡¨å’Œä½œè€…è¡¨çš„ç¬¬3å¼ è¡¨ä¸­æ’å…¥ä½œè€…1å’Œä½œè€…2ï¼Œä¹¦ç±idä¸º1çš„ä¹¦çš„ä½œè€…æœ‰2ä¸ªï¼Œåˆ†åˆ«ä¸ºä½œè€…idä¸º1çš„å’Œä½œè€…idä¸º2çš„ #æ–¹å¼1 book_obj.authors.add(author1,author2) #æ–¹å¼2 book_obj.authors.add(*[author1,author2]) //æ–¹å¼äºŒ book_obj = models.Book.objects.get(id=1) #æ–¹å¼1 book_obj.authors.add(1,2) #æ–¹å¼2 book.obj.authors.add(*[1,2]) æŸ¥çœ‹å…³è”ä½œè€…è¡¨å’Œä¹¦ç±è¡¨çš„ç¬¬3å¼ è¡¨app01_book_authorsï¼Œä¹¦ç±idä¸º1çš„ä¹¦ä½œè€…æœ‰2ä¸ª 5.2.3.2åˆ  ä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šåˆ é™¤æ–¹å¼ä¸€æ · models.Author.objects.get(id=1).delete() åˆ é™¤äº†ä½œè€…è¡¨ä¸­idä¸º1çš„è®°å½•ï¼Œä½†æ˜¯ä¸ä¼šå½±å“ä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨ä¸­ä½œè€…idä¸º1çš„è®°å½• ä½œè€…è¡¨çš„idä½œä¸ºå¤–é”®å…³è”ä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨ä¸­çš„ä½œè€…idï¼Œå¯ä»¥ç†è§£ä¸ºæˆ‘æŠ±åˆ«äººçš„å¤§è…¿ï¼Œåˆ é™¤æˆ‘è‡ªå·±ä¸å½±å“åˆ«äººï¼Œä½†æ˜¯åˆ«äººå¦‚æœåˆ é™¤å¤§è…¿ä¼šå½±å“æˆ‘ ä½œè€…è¡¨æ˜¯å…³è”è€…ï¼Œä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨æ˜¯è¢«å…³è”è€… å¤šå¯¹å¤š //æ–¹å¼ä¸€ remove ç§»é™¤ #æ‰¾åˆ°ä¹¦ç±idä¸º1çš„ä¹¦ book_obj = models.Book.objects.get(id=1) #åˆ é™¤ä¹¦ç±idä¸º1çš„ä¹¦çš„ä½œè€…idä¸º2å’Œ3 book_obj.authors.remove(2,3) //æ–¹å¼äºŒ clear å…¨éƒ¨æ¸…ç©º #æŠŠä¹¦ç±idä¸º1çš„å¯¹åº”çš„ä½œè€…å…¨éƒ¨åˆ é™¤ book_obj = models.Book.objects.get(id=1) book_obj.authors.clear() 5.2.3.3æ”¹ ä¸€å¯¹å¤šå’Œä¸€å¯¹ä¸€å’Œå•è¡¨æ˜¯ä¸€æ ·çš„ #å°†ä¹¦ç±è¡¨ä¸­idä¸º1çš„æ•°æ®æ•°åä¿®æ”¹ä¸ºpythonä»å…¥é—¨åˆ°æ”¾å¼ƒå¹¶ä¸”å‡ºç‰ˆç¤¾ä¿®æ”¹ä¸ºå‡ºç‰ˆç¤¾idä¸º3çš„ book_obj = models.Book.objects.filter(id=1).update( title='pythonä»å…¥é—¨åˆ°æ”¾å¼ƒ', #æ–¹å¼1 publishs=models.Publish.objects.get(id=3) #æ–¹å¼2 publishs_id=3 ï¼‰ å¤šå¯¹å¤š //set å…ˆæ¸…ç©ºå†è¿½åŠ ï¼Œsetä¸­å¿…é¡»å†™å­—ç¬¦ä¸²ï¼Œåˆ é™¤å¤šä¸ªåœ¨åˆ—è¡¨ä¸­å¡«å†™å¤šä¸ªæ•°å€¼ #æŠŠä¹¦ç±idä¸º1çš„ä½œè€…å…¨éƒ¨æ”¹ä¸º2 book_obj = models.Book.objects.get(id=1) book_obj.authors.set(['2',]) 5.2.3.4æŸ¥ åŸºäºå¯¹è±¡çš„è·¨è¡¨æŸ¥è¯¢ ä¸€å¯¹ä¸€ ä½œè€…è¡¨å’Œä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨ //æ­£å‘æŸ¥è¯¢ #æŸ¥è¯¢ä½œè€…å°æ˜çš„ä½å€ author_obj = models.Author.objects.get(name='å°æ˜') # author_obj.adç›´æ¥æ‹¿åˆ°authordetailè¡¨ä¸­çš„é‚£ä¸ªè®°å½•å¯¹ print(author_obj.ad.addr) //åå‘æŸ¥è¯¢ #æŸ¥è¯¢ä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨ä¸­ç”µè¯å·ä»¥170å¼€å¤´çš„ä½œè€…åå­— authordetail_ojb = models.AuthorDetail.objects.filter( telephone__startswith='170').first() print(book_obj) #ä¸åŠ firstæ‰“å°ç»“æœ ]> print(book_obj) #åŠ firstæ‰“å°ç»“æœ Book object #authordetail_ojb.authorä¸­çš„authoræ˜¯ç±»åå°å†™ï¼Œç›´æ¥å®šä½åˆ°app01_authorè¿™å¼ è¡¨ print(authordetail_ojb.author.name) å…³äºæ­£å‘æŸ¥è¯¢å’Œåå‘æŸ¥è¯¢çš„è¯´æ˜ ä¸€å¯¹å¤š å‡ºç‰ˆç¤¾è¡¨å’Œä¹¦ç±è¡¨ //æ­£å‘æŸ¥è¯¢ #æŸ¥è¯¢pythonä»å…¥é—¨åˆ°æ”¾å¼ƒè¿™æœ¬ä¹¦çš„å‡ºç‰ˆç¤¾ book_obj = models.Book.objects.filter(title='pythonä»å…¥é—¨åˆ°æ”¾å¼ƒ').first() print(book_obj.publishs.name) //åå‘æŸ¥è¯¢ pub_obj = models.Publish.objects.get(name='å—äº¬å‡ºç‰ˆç¤¾') #pub_obj.book_set.all()ä¸­book_setæ˜¯ç»“æœå¯èƒ½ä¸ºå¤šä¸ªï¼Œæœ€åçš„allæ˜¯æ‹¿åˆ°çš„ä¹¦ç±å¯¹è±¡æ‰€æœ‰ä¿¡æ¯ books = pub_obj.book_set.all().values('title') print(books) #æŸ¥è¯¢å—äº¬å‡ºç‰ˆç¤¾ä¸­æ•°ååŒ…å«linuxçš„ä¹¦ books = pub_obj.book_set.filter(title__contains='linux').values('title') å¤šå¯¹å¤š ä¹¦ç±è¡¨å’Œä½œè€…è¡¨ //æ­£å‘æŸ¥è¯¢ #æŸ¥è¯¢ä¹¦ç±è¡¨ä¸­ä¹¦åä¸ºlinuxä»å…¥é—¨åˆ°æ”¾å¼ƒçš„ä½œè€… book_obj = models.Book.objects.filter(title='linuxä»å…¥é—¨åˆ°æ”¾å¼ƒ').first() authors = book_obj.authors.all().values('name') print(authors) //åå‘æŸ¥è¯¢ åå‘æŸ¥è¯¢ä¸­ç”¨å­—æ®µå­˜åœ¨çš„è¡¨çš„å°å†™ç±»åï¼Œè¿™é‡Œä¸ºbook #æŸ¥è¯¢ä½œè€…å°æ˜å†™çš„ä¹¦ xiaoming_obj = models.Author.objects.get(name='å°æ˜') ret = xiaoming_obj.book_set.all().values('title') print(ret) æŸ¥è¯¢ä¹¦ç±è¡¨ä¸­ä¹¦åä¸ºlinuxä»å…¥é—¨åˆ°æ”¾å¼ƒçš„ä½œè€… åŸºäºåŒä¸‹åˆ’çº¿çš„è·¨è¡¨æŸ¥è¯¢ å°±æ˜¯joinè¿è¡¨æŸ¥è¯¢ ä¸€å¯¹ä¸€ ä½œè€…è¡¨ä¸ä½œè€…è¯¦ç»†ä¿¡æ¯è¡¨ //æŸ¥è¯¢ä½œè€…å°æ˜çš„ä½å€ #åŸºäºå¯¹è±¡çš„è·¨è¡¨æŸ¥è¯¢å†™æ³• æ­£å‘æŸ¥è¯¢ author_obj = models.Author.objects.get(name='å°æ˜') #author_obj.adç›´æ¥æ‹¿åˆ°authordetailè¡¨ä¸­çš„é‚£ä¸ªè®°å½•å¯¹ print(author_obj.ad.addr) #åŸºäºåŒä¸‹åˆ’çº¿çš„è·¨è¡¨æŸ¥è¯¢å†™æ³• #æ­£å‘æŸ¥è¯¢ ret = models.Author.objects.filter(name='å°æ˜').values('ad__addr') print(ret) #åå‘æŸ¥è¯¢ ret = models.AuthorDetail.objects.filter(author__name='å°æ˜').values('addr') print(ret) æ­£å‘æŸ¥è¯¢ä¸­ å…³è”å­—æ®µ__å­—æ®µ å°±è·å¾—äº†å…³è”è¡¨çš„æ•°æ® åå‘æŸ¥è¯¢ä¸­ è¡¨å__å­—æ®µ ä¸€å¯¹å¤š ä¹¦ç±è¡¨å’Œå‡ºç‰ˆç¤¾è¡¨ //æŸ¥è¯¢ä¸œäº¬å‡ºç‰ˆç¤¾å‡ºç‰ˆçš„ä¹¦ #åŸç”Ÿsqlè¯­å¥ select app01_book.title from app01_publish inner join app01_book on app01_publish.id = app01_book.publishs_id where app01_publish.name='ä¸œäº¬å‡ºç‰ˆç¤¾'; #æ­£å‘æŸ¥è¯¢ ret = models.Book.objects.filter(publishs__name='ä¸œäº¬å‡ºç‰ˆç¤¾').values('title') #åå‘æŸ¥è¯¢ ret = models.Publish.objects.filter(name='ä¸œäº¬å‡ºç‰ˆç¤¾').values('book__title') å¤šå¯¹å¤š ä¹¦ç±è¡¨å’Œä½œè€…è¡¨ å…³è”å­—æ®µåœ¨ä¹¦ç±è¡¨ä¸­ï¼Œä»ä¹¦ç±è¡¨æŸ¥è¯¢æ˜¯æ­£å‘æŸ¥è¯¢ #æŸ¥è¯¢ä¸€ä¸‹å°æ˜å†™äº†å“ªäº›ä¹¦ #æ­£å‘æŸ¥è¯¢ å…³è”å­—æ®µåœ¨bookè¡¨ä¸­ï¼Œç°åœ¨è¦æŸ¥è¯¢å°æ˜å†™äº†å“ªäº›ä¹¦ï¼Œå½“å‰æ˜¯bookè¡¨ï¼Œè¡¨ä¸­æ²¡æœ‰ä½œè€…åå­—çš„å­—æ®µï¼Œå› æ­¤éœ€è¦å…ˆè¿è¡¨ç„¶ååœ¨å–å€¼ ret = models.Book.objects.filter(authors__name='å°æ˜').values('title') print(ret) #åå‘æŸ¥è¯¢ ç°åœ¨è¦æŸ¥è¯¢å°æ˜å†™äº†å“ªäº›ä¹¦ï¼Œå½“å‰æ˜¯authorè¡¨ï¼Œè¡¨ä¸­æœ‰ä½œè€…åå­—çš„å­—æ®µï¼Œå› æ­¤ä¸éœ€è¦å…ˆè¿è¡¨ï¼Œå·²çŸ¥å­—æ®µåœ¨æœ¬è¡¨çš„å°±å¯ä»¥å…ˆå†™æ¡ä»¶æœ€ååœ¨è¿è¡¨ ret = models.Author.objects.filter(name='å°æ˜').values('book__title') print(ret) å…³è”çš„æ–¹å¼ï¼Œæ­£å‘æŸ¥è¯¢å’Œåå‘æŸ¥è¯¢éƒ½å¯ä»¥ä½¿ç”¨ï¼Œå…³é”®åœ¨äºæŸ¥è¯¢çš„æ¡ä»¶ å…³è”å­—æ®µ__å­—æ®µ å°±è·å¾—äº†å…³è”è¡¨çš„æ•°æ® å°å†™ç±»å__å­—æ®µ èšåˆæŸ¥è¯¢ aggregateèšåˆæŸ¥è¯¢,ç»“æœæ˜¯æ™®é€šå­—å…¸,querysetçš„ç»“æŸç¬¦ #å¯¼å…¥ç›¸å…³æ¨¡å— from django.db.models import Avg,Max,Min,Count,Sum //æŸ¥è¯¢ä¹¦ç±è¡¨ä¸­ä»·æ ¼æœ€é«˜çš„ obj = models.Book.objects.all().aggregate(a=Max('price')) print(obj) ç»“æœï¼š {'a': Decimal('125.00')} åˆ†ç»„æŸ¥è¯¢ //æŸ¥è¯¢æ¯ä¸ªå‡ºç‰ˆç¤¾å‡ºç‰ˆçš„ä¹¦çš„æœ€é«˜ä»·æ ¼ #æ–¹å¼ä¸€ ret = models.Book.objects.values('publishs_id').annotate(m=Max('price')) print(ret) ç»“æœï¼š æ–¹å¼ä¸€å†™æ³•è¯´æ˜ valueså†™åœ¨annotateå‰é¢,æ„æ€æ˜¯ä»¥valuesæ‹¬å·å†…çš„å­—æ®µä½œä¸ºåˆ†ç»„çš„ä¾æ®,annotateé‡Œé¢æ˜¯ä½ è¦åšçš„ç»Ÿè®¡ç»“æœ,è¿™æ ·,è¿”å›ç»“æœä¸ºquerysetç±»å‹æ•°æ®,é‡Œé¢æ˜¯å­—å…¸{'publishs_id':1,'m':100} #æ–¹å¼äºŒ #ä»å‡ºç‰ˆç¤¾è¡¨ä¸­æŸ¥è¯¢ï¼Œéœ€è¦è¿æ¥bookè¡¨ï¼Œå› ä¸ºbookè¡¨ä¸­æ‰æœ‰ä¹¦åå’Œä»·æ ¼ï¼Œè¿™ä¹ˆå†™è¡¨ç¤ºç›´æ¥ä»¥publishè¿™å¼ è¡¨çš„idè¿›è¡Œåˆ†ç»„ ret = models.Publish.objects.annotate(m=Max('book__price')).values('m','name') print(ret) ç»“æœï¼š æ–¹å¼äºŒå†™æ³•è¯´æ˜ annotateç›´æ¥å†™åœ¨äº†objectsåé¢,æ„æ€æ˜¯æŒ‰ç…§å‰é¢è¡¨çš„æ‰€æœ‰çš„æ•°æ®(é»˜è®¤æ˜¯idå€¼)ä½œä¸ºåˆ†ç»„ä¾æ®,ç»“æœè¿”å›çš„æ˜¯å‰é¢è¿™ä¸ªè¡¨çš„æ‰€æœ‰modelså¯¹è±¡(modelå¯¹è±¡ä¸­åŒ…å«äº†æ¯ä¸ªå¯¹è±¡è‡ªå·±çš„ç»Ÿè®¡ç»“æœ),åœ¨é€šè¿‡valuesæ¥å–å€¼,å–å€¼æ—¶å¯ä»¥ç›´æ¥å†™å­—æ®µå’Œç»Ÿè®¡ç»“æœçš„åˆ«å,ä¹Ÿæ˜¯querysetç±»å‹,é‡Œé¢æ˜¯å­—å…¸{'m':100,'name':'ä¸œäº¬å‡ºç‰ˆç¤¾'} Få’ŒQæŸ¥è¯¢ åœ¨bookè¡¨ä¸­æ·»åŠ è¿ä¸ªå­—æ®µï¼šç‚¹èµ(dianzan)å’Œè¯„è®º(pinglun) class Book(models.Model): title = models.CharField(max_length=32) publishDate=models.DateField() dianzan = models.IntegerField(default=100) pinglun = models.IntegerField(default=100) price=models.DecimalField(max_digits=5,decimal_places=2) publishs=models.ForeignKey(to=\"Publish\",to_field=\"id\",on_delete=models.CASCADE) app01_bookè¡¨ä¸­å†…å®¹ FæŸ¥è¯¢ FæŸ¥è¯¢ç”¨äºä¸€å¼ è¡¨ä¸­çš„ä¸¤ä¸ªå­—æ®µæ¯”è¾ƒä¹‹åçš„ç¬¦åˆæ¡ä»¶çš„ç»“æœé›† //æŸ¥è¯¢bookè¡¨ä¸­ç‚¹èµæ•°å¤§äºè¯„è®ºæ•°çš„æ‰€æœ‰ä¹¦ç± #lowç‰ˆå†™æ³• list1 = [] books = models.Book.objects.all() for i in books: if i.dianzan > i.comment: list1.append(i) #FæŸ¥è¯¢å†™æ³• ret = models.Book.objects.filter(dianzan__gt=F('pinglun')).values('title') print(ret) ç»“æœï¼š //Fè¿˜æ”¯æŒå››åˆ™è¿ç®—ï¼Œä¾‹å¦‚å°†bookè¡¨ä¸­çš„ä»·æ ¼éƒ½ä¸Šè°ƒ50å…ƒmodels.Book.objects.all().update( price=F('price')+50 ) QæŸ¥è¯¢ QæŸ¥è¯¢ç”¨äºå¤šä¸ªæ¡ä»¶æœ‰ä¸ã€æˆ–ã€éæ—¶çš„ç»¼åˆæŸ¥è¯¢ ä¸ï¼š& æˆ–ï¼š| éï¼šï½ ormæ‰§è¡ŒåŸç”Ÿsqlè¯­å¥ //æ–¹å¼ä¸€ ret = models.Book.objects.raw('select * from app01_book') for i in ret: print(i.title) ç»“æœï¼š ä¼šæŠŠè¡¨ä¸­æ‰€æœ‰ä¹¦åæ‰“å°å‡ºæ¥ //æ–¹å¼äºŒ djangoè‡ªå¸¦çš„è¿æ¥é€šé“(åœ¨é¡¹ç›®ä¸‹åŒåç›®å½•__init__.pyä¸­é…ç½®çš„pymysql) from django.db import connection import pymysql def query(request): conn = pymysql.connect() cursor = connection.cursor() cursor.execute('select * from app01_book;') print(cursor.fetchall()) //æ–¹å¼ä¸‰ def query(request): conn = pymysql.connect( host='127.0.0.1', port=3306, user='root', password='PAPAlichencan!1', database='orm02', charset='utf8' ) cursor = conn.cursor(pymysql.cursors.DictCursor) cursor.execute('select * from app01_book;') print(cursor.fetchall()) ç»“æœï¼š [{'id': 1, 'title': 'pythonä»å…¥é—¨åˆ°æ”¾å¼ƒ', 'publishDate': datetime.date(2011, 1, 1), 'price': Decimal('99.00'), 'publishs_id': 3, 'dianzan': 600, 'pinglun': 150}, {'id': 2, 'title': 'linuxä»å…¥é—¨åˆ°æ”¾å¼ƒ', 'publishDate': datetime.date(2019, 12, 12), 'price': Decimal('99.90'), 'publishs_id': 2, 'dianzan': 500, 'pinglun': 300}, {'id': 3, 'title': 'éš”å£è€ç‹çš„æ•…äº‹', 'publishDate': datetime.date(2019, 11, 7), 'price': Decimal('125.00'), 'publishs_id': 2, 'dianzan': 100, 'pinglun': 100}, {'id': 4, 'title': 'linuxå®‰å…¨æŒ‡å—', 'publishDate': datetime.date(2020, 11, 30), 'price': Decimal('66.00'), 'publishs_id': 2, 'dianzan': 300, 'pinglun': 2000}, {'id': 5, 'title': 'å¥”è·‘çš„linuxå†…æ ¸', 'publishDate': datetime.date(2019, 11, 1), 'price': Decimal('77.00'), 'publishs_id': 2, 'dianzan': 50, 'pinglun': 100}] djangoå¤–éƒ¨è„šæœ¬è°ƒç”¨modelsæ•°æ®åº“æ“ä½œ ä½¿ç”¨åœºæ™¯ï¼šæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¸æƒ³è¿è¡Œdjangoé¡¹ç›®åªæƒ³æ‰§è¡Œä¸€äº›è§†å›¾ä¸­çš„é€»è¾‘ï¼Œè¿™ä¸ªæ—¶å€™å°±ç”¨åˆ°äº†djangoå¤–éƒ¨è„šæœ¬è°ƒç”¨modelsæ•°æ®åº“æ“ä½œ æ“ä½œæ–¹æ³•ï¼šåœ¨djangoé¡¹ç›®ä¸‹æ–°å»ºä¸€ä¸ªxx.pyæ–‡ä»¶ï¼Œåœ¨xx.pyæ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œç„¶åç›´æ¥è¿è¡Œè¿™ä¸ªxx.pyæ–‡ä»¶å°±å¯ä»¥åœ¨ä¸å¯åŠ¨djangoé¡¹ç›®çš„æƒ…å†µä¸‹è€Œå•ç‹¬æ‰§è¡Œæˆ‘ä»¬æƒ³æ‰§è¡Œçš„æµ‹è¯•é€»è¾‘ #å¯¼å…¥osæ¨¡å— import os if __name__ == '__main__': #æœ€åä¸€ä¸ªå‚æ•°è¦å†™é¡¹ç›®å.settings os.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"orm02.settings\") #å¯¼å…¥django import django django.setup() #å¯¼å…¥åº”ç”¨ç¨‹åºçš„models from app01 import models ret = models.Book.objects.all().values('title') print(ret) ORMäº‹åŠ¡å’Œé” é” models.Book.objects.select_for_update().filter(id=1) äº‹åŠ¡ //æ–¹å¼1 å…¨å±€é…ç½® DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'mxshop', 'HOST': '127.0.0.1', 'PORT': '3306', 'USER': 'root', 'PASSWORD': '123', \"ATOMIC_REQUESTS\": True, #å…¨å±€å¼€å¯äº‹åŠ¡ï¼Œç»‘å®šçš„æ˜¯httpè¯·æ±‚å“åº”æ•´ä¸ªè¿‡ç¨‹å½“ä¸­çš„sql } } æ–¹å¼1ä¸­ï¼Œdjangoé¡¹ç›®ä¸­æ‰€æœ‰çš„è§†å›¾é€»è¾‘å…¨éƒ¨åŠ ä¸Šäº†äº‹ç‰© //æ–¹å¼2: è§†å›¾å‡½æ•°åŠ è£…é¥°å™¨ from django.db import transaction @transaction.atomic def viewfunc(request): # This code executes inside a transaction. é€»è¾‘è¯­å¥ æ–¹å¼2ä¸­ï¼Œæˆ‘ä»¬åªæƒ³ç»™æŸä¸€ä¸ªè§†å›¾å‡½æ•°åŠ äº‹ç‰©ï¼Œè¿™ä¸ªæ—¶å€™å°±ç”¨åˆ°äº†ä¸Šè¿°çš„æ–¹æ³• æ–¹å¼3: ä¸Šä¸‹æ–‡åŠ è£…é¥°å™¨ from django.db import transaction def viewfunc(request): # This code executes in autocommit mode (Django's default). é€»è¾‘è¯­å¥1 with transaction.atomic(): #ä¿å­˜ç‚¹ # This code executes inside a transaction. é€»è¾‘è¯­å¥2 é€»è¾‘è¯­å¥3 æ–¹å¼3ä¸­ï¼Œæˆ‘ä»¬åªæƒ³ç»™é€»è¾‘è¯­å¥2æ·»åŠ äº‹ç‰©ï¼Œè€Œå…¶ä»–è¯­å¥ä¸éœ€è¦ï¼Œè¿™ä¸ªæ—¶å€™å°±åœ¨é€»è¾‘è¯­å¥2çš„ä¸Šè¾¹å†™å¦‚ä¸Šè¯­å¥å³å¯ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonè¿›é˜¶/django/6.cookieå’Œsession.html":{"url":"python/pythonè¿›é˜¶/django/6.cookieå’Œsession.html","title":"djangoåŸºç¡€å…­ cookieå’Œsession","keywords":"","body":"cookieå’Œsession ä¸€ã€cookie 1.1cookieçš„ç”±æ¥ httpåè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œæ— çŠ¶æ€çš„æ„æ€å°±æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒçš„æ‰§è¡Œæƒ…å†µå’Œç»“æœä¸å‰é¢çš„è¯·æ±‚å’Œä¹‹åçš„è¯·æ±‚éƒ½æ— ç›´æ¥å…³ç³»ï¼Œå¯¹äºæœåŠ¡å™¨æ¥è®²ï¼Œæ¯æ¬¡éƒ½è¯·æ±‚éƒ½æ˜¯å…¨æ–°çš„ çŠ¶æ€å¯ä»¥ç†è§£ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åœ¨æŸæ¬¡ä¼šè¯ä¸­äº§ç”Ÿçš„æ•°æ®ï¼Œé‚£æ— çŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œäº§ç”Ÿçš„æ•°æ®å°±ä¸ä¼šè¢«ä¿å­˜ï¼Œè€Œä¼šè¯äº§ç”Ÿçš„æ•°æ®åˆæ˜¯éœ€è¦æˆ‘ä»¬ä¿å­˜çš„ï¼Œç»å…¸çš„éœ€æ±‚å°±æ˜¯å®¢æˆ·ç«¯ç™»é™†æœåŠ¡ç«¯åï¼ŒæœåŠ¡ç«¯éœ€è¦è®°ä½å®¢æˆ·ç«¯æ˜¯è°ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°ç™»é™†ï¼Œè¿™æ ·å°±äº§ç”Ÿäº†cookie 1.2cookieæ˜¯ä»€ä¹ˆ cookieæ˜¯æµè§ˆå™¨çš„æŠ€æœ¯ï¼Œcookieå…·ä½“æŒ‡çš„æ˜¯ä¸€æ®µå°ä¿¡æ¯ï¼Œå®ƒæ˜¯æœåŠ¡å™¨å‘é€å‡ºæ¥å­˜å‚¨åœ¨æµè§ˆå™¨ä¸Šçš„ä¸€ç»„ç»„ç®€ç›´å¯¹ï¼Œå¯ä»¥ç†è§£ä¸ºæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯çš„ä¸€ä¸ªå°ç”œç‚¹ï¼Œä¸‹æ¬¡å®¢æˆ·ç«¯çš„æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨æ—¶å°±ä¼šè‡ªåŠ¨æºå¸¦è¿™äº›é”®å€¼å¯¹ï¼Œä¸€ä¾¿æœåŠ¡å™¨æå–æœ‰ç”¨ä¿¡æ¯ 1.3cookieçš„åŸç† cookieçš„å·¥ä½œåŸç†æ˜¯ï¼šæµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œå¸¦ç€ä¸€ä¸ªç©ºçš„cookieï¼Œç„¶åç”±æœåŠ¡å™¨äº§ç”Ÿå†…å®¹ï¼Œæµè§ˆå™¨æ”¶åˆ°å†…å®¹åä¿å­˜åœ¨æœ¬åœ°ï¼Œå½“æµè§ˆå™¨å†æ¬¡è®¿é—®æœåŠ¡å™¨æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¸¦ä¸Šcookieï¼Œè¿™æ ·æœåŠ¡å™¨å°±èƒ½é€šè¿‡cookieçš„å†…å®¹æ¥åˆ¤æ–­è¯·æ±‚è€…æ˜¯è°äº† æŸ¥çœ‹cookie cookieåŸç†ç¤ºæ„å›¾ 1.4cookieè§„èŒƒ Cookieå¤§å°ä¸Šé™ä¸º4KBï¼Œæ˜¯æ€»æ•°å¤§å°ä¸º4KBä¸æ˜¯å•ä¸ª ä¸€ä¸ªæœåŠ¡å™¨æœ€å¤šåœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸Šä¿å­˜20ä¸ªCookie ä¸€ä¸ªæµè§ˆå™¨æœ€å¤šä¿å­˜300ä¸ªCookieï¼Œå› ä¸ºä¸€ä¸ªæµè§ˆå™¨å¯ä»¥è®¿é—®å¤šä¸ªæœåŠ¡å™¨ ä¸åŒæµè§ˆå™¨ä¹‹é—´æ˜¯ä¸å…±äº«Cookieçš„ 1.5cookieå’Œhttpå¤´ Cookieæ˜¯é€šè¿‡HTTPè¯·æ±‚å’Œå“åº”å¤´åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¼ é€’çš„ï¼š Cookieï¼šè¯·æ±‚å¤´ï¼Œå®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼› æ ¼å¼ï¼š Cookie: a=A; b=B; c=Cã€‚å³å¤šä¸ªCookieç”¨åˆ†å·ç¦»å¼€ï¼› ï¬ Set-Cookieï¼šå“åº”å¤´ï¼ŒæœåŠ¡å™¨ç«¯å‘é€ç»™å®¢æˆ·ç«¯ï¼› ä¸€ä¸ªCookieå¯¹è±¡ä¸€ä¸ªSet-Cookieï¼š Set-Cookie: a=A Set-Cookie: b=B Set-Cookie: c=C 1.6cookieçš„è¦†ç›– å¦‚æœæœåŠ¡å™¨ç«¯å‘é€é‡å¤çš„Cookieé‚£ä¹ˆä¼šè¦†ç›–åŸæœ‰çš„Cookieï¼Œä¾‹å¦‚å®¢æˆ·ç«¯çš„ç¬¬ä¸€ä¸ªè¯·æ±‚æœåŠ¡å™¨ç«¯å‘é€çš„Cookieæ˜¯ï¼šSet-Cookie: a=Aï¼›ç¬¬äºŒè¯·æ±‚æœåŠ¡å™¨ç«¯å‘é€çš„æ˜¯ï¼šSet-Cookie: a=AAï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åªç•™ä¸‹ä¸€ä¸ªCookieï¼Œå³ï¼ša=AAã€‚ 1.7djangoä¸­æ“ä½œcookie 1.7.1djangoè®¾ç½®cookie è®¾ç½®cookie #æ–¹å¼ä¸€ è·å–cookie: request.COOKIES.get('xx') è®¾ç½®cookie: HttpResponse('xx').set_cookie('é”®','å€¼') #æ–¹å¼äºŒ è·å–ç­¾åcookie: request.get_signed_cookie('is_login',salt='xxx') è®¾ç½®ç­¾åcookie: ret.set_signed_cookie('is_login',True,'xxx') è®¾ç½®cookieä¸­çš„å‚æ•° key #cookieçš„é”® value='' #cookieçš„å€¼ max_age=None #è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ï¼Œç»è¿‡å¤šå°‘ç§’åcookieå¤±æ•ˆï¼Œé»˜è®¤ä¸¤å‘¨ expires=None #è¶…æ—¶æ—¶é—´(IE requires expires, so set it if hasn't been already.)ï¼Œä¾‹å¦‚ï¼Œå½“å‰æ—¶é—´ä¸º1æœˆ1æ—¥10æ—¶10åˆ†ï¼Œè®¾ç½®ä¸º7å°±æ˜¯1æœˆ8æ—¥çš„10æ—¶10åˆ†å¤±æ•ˆ path='/' #Cookieç”Ÿæ•ˆçš„è·¯å¾„ï¼Œ/ è¡¨ç¤ºæ ¹è·¯å¾„ï¼Œç‰¹æ®Šçš„ï¼šæ ¹è·¯å¾„çš„cookieå¯ä»¥è¢«ä»»ä½•urlçš„é¡µé¢è®¿é—® domain=None #Cookieç”Ÿæ•ˆçš„åŸŸå secure=False #httpsä¼ è¾“ httponly=False #åªèƒ½httpåè®®ä¼ è¾“ï¼Œæ— æ³•è¢«JavaScriptè·å–ï¼ˆä¸æ˜¯ç»å¯¹ï¼Œåº•å±‚æŠ“åŒ…å¯ä»¥è·å–åˆ°ä¹Ÿå¯ä»¥è¢«è¦†ç›–ï¼‰ cookieè®¾ç½®æ—¶ä¸è¦è®¾ç½®ä¸­æ–‡ï¼ï¼ï¼å› ä¸ºä¸ä¸“ä¸š å¦‚æœéè¦è®¾ç½®ä¸­æ–‡çš„è§£å†³æ–¹æ³• #æ–¹å¼1 def login(request): ret = HttpResponse('ok') ret.set_cookie('k1','ä½ å¥½'.encode('utf-8').decode('iso-8859-1')) #å–å€¼ï¼šrequest.COOKIES['k1'].encode('utf-8').decode('iso-8859-1').encode('iso-8859-1').decode('utf-8') return ret #æ–¹å¼2 json def login(request): ret = HttpResponse('ok') import json ret.set_cookie('k1',json.dumps('ä½ å¥½')) #å–å€¼ json.loads(request.COOKIES['k1']) return ret 1.7.2djangoåˆ é™¤cookie åˆ é™¤cookie: ret = redirect(\"/login/\") ret.delete_cookie('cookieé”®åç§°') 1.7.3cookieç‰ˆç™»é™†æ ¡éªŒç¤ºä¾‹ ç”¨æˆ·è®¿é—®loginï¼Œç™»é™†æˆåŠŸé‡å®šå‘åˆ°é¡µé¢homeå±•ç¤ºå†…å®¹ urlsæ–‡ä»¶ from django.conf.urls import url from django.contrib import admin from app01 import views urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^login/', views.login,name='login'), url(r'^home/', views.home,name='home'), ] viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse,redirect # Create your views here. def login(request): if request.method == 'GET': return render(request,'login.html') else: username = request.POST.get('username') password = request.POST.get('password') if username == 'admin' and password == 'admin': ret = redirect('home') #è¿™é‡Œæ˜¯æˆ‘ä»¬è‡ªå·±è®¾ç½®cookie ret.set_cookie('is_login',True) # return redirect('home') return ret else: return redirect('login') def home(request): #è¿™é‡Œè·å–ä¸Šè¾¹æˆ‘ä»¬è‡ªå·±è®¾ç½®çš„cookie is_login = request.COOKIES.get('is_login') if is_login == 'True': return render(request,'home.html') else: return redirect('login') htmlæ–‡ä»¶ #login.html Title ç™»å½•é¡µé¢ {% csrf_token %} ç”¨æˆ·å: å¯†ç : #home.html Title æ¬¢è¿æ¥åˆ°ä¹”æ‰å¤§ä¿å¥ä¼šæ‰€ æ•´ä½“çš„é€»è¾‘æ˜¯ç”¨æˆ·ç™»é™†æˆåŠŸåè¿”å›homeé¡µé¢ï¼Œç›´æ¥è®¿é—®homeé¡µé¢ä¸å¯ä»¥ï¼Œæ¸…é™¤cookieåç”¨æˆ·éœ€è¦é‡æ–°ç™»é™† æŸ¥çœ‹æµè§ˆå™¨ä¸­çš„cookie äºŒã€session 2.1sessionæ˜¯ä»€ä¹ˆ Sessionæ˜¯æœåŠ¡å™¨ç«¯æŠ€æœ¯ï¼Œåˆ©ç”¨è¿™ä¸ªæŠ€æœ¯ï¼ŒæœåŠ¡å™¨åœ¨è¿è¡Œæ—¶å¯ä»¥ä¸ºæ¯ä¸€ä¸ªç”¨æˆ·çš„æµè§ˆå™¨åˆ›å»ºä¸€ä¸ªå…¶ç‹¬äº«çš„sessionå¯¹è±¡ï¼Œç”±äºsessionä¸ºç”¨æˆ·æµè§ˆå™¨ç‹¬äº«ï¼Œæ‰€ä»¥ç”¨æˆ·åœ¨è®¿é—®æœåŠ¡å™¨çš„webèµ„æºæ—¶ ï¼Œå¯ä»¥æŠŠå„è‡ªçš„æ•°æ®æ”¾åœ¨å„è‡ªçš„sessionä¸­ï¼Œå½“ç”¨æˆ·å†å»è®¿é—®è¯¥æœåŠ¡å™¨ä¸­çš„å…¶å®ƒwebèµ„æºæ—¶ï¼Œå…¶å®ƒwebèµ„æºå†ä»ç”¨æˆ·å„è‡ªçš„sessionä¸­å–å‡ºæ•°æ®ä¸ºç”¨æˆ·æœåŠ¡ã€‚ sessionå›¾è§£ 2.2sessionè¯¦ç»†æµç¨‹ 1.å½“ç”¨æˆ·ç™»é™†ä¹‹åï¼ŒæœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªå­—å…¸{'key':'value'}ï¼Œå¹¶ä¸”å°†å­—å…¸å­˜å…¥sessionï¼Œkeyæ˜¯æœåŠ¡ç«¯è‡ªåŠ¨ç”Ÿæˆçš„ä¸€æ®µå­—ç¬¦ä¸²æ ‡ç¤ºï¼Œè¿”å›cookieï¼Œvalueæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ ¼å¼çš„å­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„å†…å®¹ç”±æˆ‘ä»¬è‡ªå·±å†³å®š 2.åœ¨1ä¸­ç”Ÿæˆçš„å­—å…¸valueä¸­è‡ªå®šä¹‰æ ¼å¼æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·åã€å¯†ç ç­‰ç­‰ 3.å½“æˆ‘ä»¬åœ¨djangoä¸­ç”¨åˆ°sessionæ—¶ï¼Œcookieç”±æœåŠ¡ç«¯éšæœºç”Ÿæˆï¼Œå†™åˆ°æµè§ˆå™¨çš„cookieä¸­ï¼Œæ¯ä¸ªæµè§ˆå™¨éƒ½æœ‰è‡ªå·±çš„cookieå€¼ï¼Œæ˜¯sessionå¯»æ‰¾ç”¨æˆ·ä¿¡æ¯çš„å”¯ä¸€æ ‡è¯†ï¼Œæ¯ä¸ªæµè§ˆå™¨è¯·æ±‚åˆ°åå°çš„æ¥æ”¶çš„request_sessionç­‰ä»·äº1ä¸­sessionå­—å…¸çš„key(cookie)å¯¹åº”çš„value 2.3sessionè§„èŒƒ å€ŸåŠ©äºcookieè¿›è¡Œä¼ è¾“ éæ˜æ–‡æ˜¾ç¤º é•¿åº¦ä¸é™ 2.4djangoä¸­æ“ä½œsession 2.4.1djangoè®¾ç½®session //sessionå¯ä»¥è®¾ç½®å¤šä¸ª request.session['is_login'] = True request.session['username'] = username //è·å–session request.session.get('is_login') request.session.get('username') djangoè®¾ç½®sessionè¿‡ç¨‹ 1.ç”Ÿæˆéšæœºå­—ç¬¦ä¸² 2.æ”¾åˆ°cookieä¸­è¿›è¡Œä¼ è¾“ 3.å°†éšæœºå­—ç¬¦ä¸²å’Œå¯¹åº”æ•°æ®ä¿å­˜åˆ°è‡ªå·±æœåŠ¡ç«¯çš„æ•°æ®åº“ä¸­ djangoè·å–sessionè¿‡ç¨‹ 1.å–å‡ºcookieä¸­çš„sessionéšæœºå­—ç¬¦ä¸²{'sessionid':'asdfasfpoaijsdgihsdj'} xx = request.COOKIES.get('sessionid') 2.åˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢è¿™ä¸ªsessionidå¯¹åº”çš„é‚£æ¡è®°å½• data = select session_data from django_session where session_key = xx; 3.æ‹¿å‡ºè®°å½•ä¸­çš„session_dataæ•°æ®éƒ¨åˆ†è¿›è¡Œè§£å¯†,å¹¶å–å‡ºæ•°æ® dic.get('is_login') --> True dic = ss(data) --> {'is_login':True} djangoåˆ é™¤sessionè¿‡ç¨‹ 1.åˆ é™¤cookieä¸­çš„sessionidé‚£ä¸ªé”®å€¼å¯¹ 2.åˆ é™¤äº†æ•°æ®åº“ä¸­çš„è¿™æ¡è®°å½• 2.4.2djangoåˆ é™¤session request.session.flush() 2.4.3sessionç‰ˆç™»é™†æ ¡éªŒç¤ºä¾‹ ç”¨æˆ·è®¿é—®loginï¼Œç™»é™†æˆåŠŸé‡å®šå‘åˆ°é¡µé¢homeå±•ç¤ºå†…å®¹ urlsæ–‡ä»¶ from django.conf.urls import url from django.contrib import admin from app01 import views urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^login/', views.login,name='login'), url(r'^home/', views.home,name='home'), ] viewsæ–‡ä»¶ from django.shortcuts import render,HttpResponse,redirect # Create your views here. def login(request): if request.method == 'GET': return render(request,'login.html') else: username = request.POST.get('username') password = request.POST.get('password') if username == 'admin' and password == 'admin': request.session['is_login'] = True request.session['username'] = username \"\"\" è®¾ç½®sessionååšçš„3ä»¶äº‹ 1.ç”Ÿæˆéšæœºå­—ç¬¦ä¸² 2.æ”¾åˆ°cookieä¸­è¿›è¡Œä¼ è¾“ 3.å°†éšæœºå­—ç¬¦ä¸²å’Œå¯¹åº”æ•°æ®ä¿å­˜åˆ°è‡ªå·±æœåŠ¡ç«¯çš„æ•°æ®åº“ä¸­ \"\"\" return redirect('home') else: return redirect('login') def home(request): #è¿™é‡Œè·å–ä¸Šè¾¹æˆ‘ä»¬è‡ªå·±è®¾ç½®çš„session is_login = request.session.get('is_login') \"\"\" request.session.getåšçš„äº‹ 1.å–å‡ºcookieä¸­çš„sessionéšæœºå­—ç¬¦ä¸²{'sessionid':'asdfasfpoaijsdgihsdj'} xx = request.COOKIES.get('sessionid') 2.åˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢è¿™ä¸ªsessionidå¯¹åº”çš„é‚£æ¡è®°å½• data = select session_data from django_session where session_key = xx; 3.æ‹¿å‡ºè®°å½•ä¸­çš„session_dataæ•°æ®éƒ¨åˆ†è¿›è¡Œè§£å¯†,å¹¶å–å‡ºæ•°æ® dic = sss(data) --> {'is_login':True} dic.get('is_login') --> True \"\"\" if is_login == True: return render(request,'home.html') else: return redirect('login') def logout(request): #åˆ é™¤session request.session.flush() \"\"\" åˆ é™¤session 1.åˆ é™¤cookieä¸­çš„sessionidé‚£ä¸ªé”®å€¼å¯¹ 2.åˆ é™¤äº†æ•°æ®åº“ä¸­çš„è¿™æ¡è®°å½• \"\"\" return redirect('login') htmlæ–‡ä»¶ #login.html Title ç™»å½•é¡µé¢ {% csrf_token %} ç”¨æˆ·å: å¯†ç : #home.html Title æ¬¢è¿æ¥åˆ°ä¹”æ‰å¤§ä¿å¥ä¼šæ‰€ æ³¨é”€ cookieä¸sessionæ€»ç»“ cookieçš„ä½œç”¨: ä¿æŒä¼šè¯,ä½¿ç”¨æˆ·ä¸éœ€è¦é‡å¤çš„å»ç™»å½• 1.æœ‰å¤§å°é™åˆ¶,Cookieæ€»å¤§å°ä¸Šé™ä¸º4KBï¼› 2.æœ‰ä¸ªæ•°é™åˆ¶ ä¸€ä¸ªæœåŠ¡å™¨æœ€å¤šåœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸Šä¿å­˜20ä¸ªCookieï¼› ä¸€ä¸ªæµè§ˆå™¨æœ€å¤šä¿å­˜300ä¸ªCookieï¼Œå› ä¸ºä¸€ä¸ªæµè§ˆå™¨å¯ä»¥è®¿é—®å¤šä¸ªæœåŠ¡å™¨ã€‚ session 1.æ¯”cookieé¢ä¸Šå®‰å…¨ä¸€äº› 2.sessionæ²¡æœ‰å¤§å°é™åˆ¶ 3.å¯ä»¥é…ç½®å¤šä¸ªå­˜å‚¨æ–¹æ¡ˆ,å¯ä»¥é…ç½®åˆ°ç¼“å­˜ä¸­ django sessionè¡¨ä¸­session keyæ ‡è®°çš„æ˜¯æµè§ˆå™¨ï¼Œä¸æ˜¯ç”¨æˆ·ï¼Œä¸€ä¸ªæµè§ˆå™¨å¯¹åº”ä¸€ä¸ªæœåŠ¡ç«¯ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonè¿›é˜¶/django/7.Ajax.html":{"url":"python/pythonè¿›é˜¶/django/7.Ajax.html","title":"djangoåŸºç¡€ä¸ƒ Ajax","keywords":"","body":"6.Ajax å¼‚æ­¥æäº¤ å±€éƒ¨åˆ·æ–° æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonè¿›é˜¶/django/8.djangoä¸­é—´ä»¶.html":{"url":"python/pythonè¿›é˜¶/django/8.djangoä¸­é—´ä»¶.html","title":"djangoåŸºç¡€å…« djangoä¸­é—´ä»¶","keywords":"","body":"djangoä¸­é—´ä»¶ 1.ä¸­é—´ä»¶ä»‹ç» 1.1djangoä¸­é—´ä»¶ç®€ä»‹åŠå®šä¹‰ djangoä¸­é—´ä»¶æ˜¯ä»‹äºrequestä¸responseå¤„ç†ä¹‹é—´çš„ä¸€é“å¤„ç†è¿‡ç¨‹ï¼Œç›¸å¯¹æ¯”è¾ƒè½»é‡çº§ï¼Œå¹¶ä¸”åœ¨å…¨å±€ä¸Šæ”¹å˜djangoçš„è¾“å…¥ä¸è¾“å‡ºã€‚å› ä¸ºæ”¹å˜çš„æ˜¯å…¨å±€ï¼Œæ‰€ä»¥éœ€è¦è°¨æ…å®ç”¨ï¼Œç”¨ä¸å¥½ä¼šå½±å“åˆ°æ€§èƒ½ã€‚ Djangoçš„ä¸­é—´ä»¶çš„å®šä¹‰ï¼š #ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªé’©å­æ¡†æ¶ï¼Œç”¨äºDjangoçš„è¯·æ±‚/å“åº”å¤„ç†ã€‚è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€åº•å±‚çš„â€œæ’ä»¶â€ç³»ç»Ÿï¼Œç”¨äºå…¨å±€åœ°æ”¹å˜Djangoçš„è¾“å…¥æˆ–è¾“å‡ºã€‚ Middleware is a framework of hooks into Djangoâ€™s request/response processing. Itâ€™s a light, low-level â€œpluginâ€ system for globally altering Djangoâ€™s input or output. 1.2djangoä¸­é—´ä»¶çš„ä½œç”¨ å¦‚æœä½ æƒ³ä¿®æ”¹è¯·æ±‚ï¼Œä¾‹å¦‚è¢«ä¼ é€åˆ°viewä¸­çš„HttpRequestå¯¹è±¡ã€‚ æˆ–è€…ä½ æƒ³ä¿®æ”¹viewè¿”å›çš„HttpResponseå¯¹è±¡ï¼Œè¿™äº›éƒ½å¯ä»¥é€šè¿‡ä¸­é—´ä»¶æ¥å®ç°ã€‚ å¯èƒ½ä½ è¿˜æƒ³åœ¨viewæ‰§è¡Œä¹‹å‰åšä¸€äº›æ“ä½œï¼Œè¿™ç§æƒ…å†µå°±å¯ä»¥ç”¨ middlewareæ¥å®ç°ã€‚ è¯´çš„ç›´ç™½ä¸€ç‚¹ä¸­é—´ä»¶æ˜¯å¸®åŠ©æˆ‘ä»¬åœ¨è§†å›¾å‡½æ•°æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œä¹‹åéƒ½å¯ä»¥åšä¸€äº›é¢å¤–çš„æ“ä½œï¼Œå®ƒæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œç±»ä¸­å®šä¹‰äº†å‡ ä¸ªæ–¹æ³•ï¼ŒDjangoæ¡†æ¶ä¼šåœ¨è¯·æ±‚çš„ç‰¹å®šçš„æ—¶é—´å»æ‰§è¡Œè¿™äº›æ–¹æ³•ã€‚ 1.3djangoä¸­é—´ä»¶çš„é…ç½®é¡¹ æ‰“å¼€djangoé¡¹ç›®çš„settings.pyæ–‡ä»¶ï¼Œçœ‹åˆ°ä¸‹é¢çš„MIDDLEWAREé…ç½®é¡¹ï¼Œdjangoé»˜è®¤è‡ªå¸¦çš„ä¸€äº›ä¸­é—´ä»¶ï¼š MIDDLEWARE = [ 'django.middleware.security.SecurityMiddleware', 'django.contrib.sessions.middleware.SessionMiddleware', 'django.middleware.common.CommonMiddleware', 'django.middleware.csrf.CsrfViewMiddleware', 'django.contrib.auth.middleware.AuthenticationMiddleware', 'django.contrib.messages.middleware.MessageMiddleware', 'django.middleware.clickjacking.XFrameOptionsMiddleware', ] 2.djangoç”Ÿå‘½å‘¨æœŸ djangoç”Ÿå‘½å‘¨æœŸ 3.è‡ªå®šä¹‰ä¸­é—´ä»¶ ç¬¬ä¸€æ­¥ã€åœ¨djangoé¡¹ç›®ä¸‹çš„åº”ç”¨ç¨‹åºç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªmymiddlewareç›®å½•ï¼Œåç§°ä»»æ„ï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸­å†åˆ›å»ºä¸€ä¸ªmiddlewareæ–‡ä»¶ï¼Œåç§°ä»»æ„ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ #å¯¼å…¥MiddlewareMixin from django.utils.deprecation import MiddlewareMixin from django.shortcuts import redirect,render,HttpResponse class Auth(MiddlewareMixin): # å®šä¹‰ä¸€ä¸ªç™½åå• white_list = ['/login/', ] def process_request(self,request): if request.path in self.white_list: pass else: is_login = request.session.get('is_login') \"\"\" request.session.getåšçš„äº‹ 1.å–å‡ºcookieä¸­çš„sessionéšæœºå­—ç¬¦ä¸²{'sessionid':'asdfasfpoaijsdgihsdj'} xx = request.COOKIES.get('sessionid') 2.åˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢è¿™ä¸ªsessionidå¯¹åº”çš„é‚£æ¡è®°å½• data = select session_data from django_session where session_key = xx; 3.æ‹¿å‡ºè®°å½•ä¸­çš„session_dataæ•°æ®éƒ¨åˆ†è¿›è¡Œè§£å¯†,å¹¶å–å‡ºæ•°æ® dic = sss(data) --> {'is_login':True} dic.get('is_login') --> True \"\"\" # è¿™é‡Œå†™ä¸€ä¸ªpassï¼Œå°±æ˜¯è¿”å›ä¸€ä¸ªNoneï¼Œå¦‚æœè¿”å›æ˜¯Noneï¼Œåˆ™è¯´æ˜é€šè¿‡äº†è¯·æ±‚ if is_login == True: pass else: # return redirect('login') return HttpResponse('ä¸­é—´ä»¶ä¸è®©ä½ ç™»é™†') ç¬¬äºŒæ­¥ã€åœ¨settingsæ–‡ä»¶ä¸­MIDDLEWAREé¡¹çš„æœ€åè¾¹é…ç½®ä¸­é—´ä»¶ #åº”ç”¨ç¨‹åºå.è‡ªå®šä¹‰ä¸­é—´ä»¶çš„ç›®å½•.è‡ªå®šä¹‰ä¸­é—´ä»¶pyæ–‡ä»¶.è‡ªå®šä¹‰ç±» 'app01.mymiddleware.middleware.Auth' ç¬¬ä¸‰æ­¥ã€è§†å›¾æ–‡ä»¶ from django.shortcuts import render,HttpResponse,redirect from django.urls import reverse # Create your views here. def login(request): if request.method == 'GET': return render(request,'login.html') else: username = request.POST.get('username') password = request.POST.get('password') if username == 'admin' and password == 'admin': request.session['is_login'] = True request.session['username'] = username \"\"\" è®¾ç½®sessionååšçš„3ä»¶äº‹ 1 ç”Ÿæˆéšæœºå­—ç¬¦ä¸² 2 æ”¾åˆ°cookieä¸­è¿›è¡Œä¼ è¾“ 3 å°†éšæœºå­—ç¬¦ä¸²å’Œå¯¹åº”æ•°æ®ä¿å­˜åˆ°è‡ªå·±æœåŠ¡ç«¯çš„æ•°æ®åº“ä¸­ \"\"\" return redirect('home') else: return redirect('login') def home(request): #è¿™é‡Œè·å–ä¸Šè¾¹æˆ‘ä»¬è‡ªå·±è®¾ç½®çš„cookie # is_login = request.COOKIES.get('is_login') is_login = request.session.get('is_login') \"\"\" request.session.getåšçš„äº‹ 1.å–å‡ºcookieä¸­çš„sessionéšæœºå­—ç¬¦ä¸²{'sessionid':'asdfasfpoaijsdgihsdj'} xx = request.COOKIES.get('sessionid') 2.åˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢è¿™ä¸ªsessionidå¯¹åº”çš„é‚£æ¡è®°å½• data = select session_data from django_session where session_key = xx; 3.æ‹¿å‡ºè®°å½•ä¸­çš„session_dataæ•°æ®éƒ¨åˆ†è¿›è¡Œè§£å¯†,å¹¶å–å‡ºæ•°æ® dic = sss(data) --> {'is_login':True} dic.get('is_login') --> True \"\"\" if is_login == True: return render(request,'home.html') else: return redirect('login') 4.ä¸­é—´ä»¶5å¤§æ–¹æ³• 4.1process_request(self,request) 3ä¸­çš„è‡ªå®šä¹‰ä¸­é—´ä»¶ç”¨åˆ°çš„å°±æ˜¯process_request(self,request)ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹è¯·æ±‚è¿›è¡Œå¤„ç†çš„æ–¹æ³• process_requestæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯requestï¼Œè¿™ä¸ªrequestå’Œè§†å›¾å‡½æ•°ä¸­çš„requestæ˜¯ä¸€æ ·çš„ã€‚ å®ƒçš„è¿”å›å€¼å¯ä»¥æ˜¯Noneä¹Ÿå¯ä»¥æ˜¯HttpResponseå¯¹è±¡ã€‚è¿”å›å€¼æ˜¯Noneçš„è¯ï¼ŒæŒ‰æ­£å¸¸æµç¨‹ç»§ç»­èµ°ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å¤„ç†ï¼Œå¦‚æœæ˜¯HttpResponseå¯¹è±¡ï¼ŒDjangoå°†ä¸æ‰§è¡Œè§†å›¾å‡½æ•°ï¼Œè€Œå°†å“åº”å¯¹è±¡è¿”å›ç»™æµè§ˆå™¨ã€‚ 4.2process_response(self, request, response) process_responseæ˜¯å¯¹è§†å›¾å‡½æ•°æ‰€æœ‰çš„å“åº”è¿›è¡Œå¤„ç† å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯requestï¼Œä¸€ä¸ªæ˜¯responseï¼Œrequestå’Œè§†å›¾å‡½æ•°ä¸­çš„requestæ˜¯ä¸€æ ·çš„ï¼Œresponseæ˜¯è§†å›¾å‡½æ•°è¿”å›çš„HttpResponseå¯¹è±¡ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¹Ÿå¿…é¡»æ˜¯HttpResponseå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œåœ¨æ¯ä¸€ä¸ªè§†å›¾å‡½æ•°çš„å“åº”å¤´ä¸­æ·»åŠ ä¸€äº›ä¸œè¥¿ï¼Œå°±å¯ä»¥åœ¨process_responseæ–¹æ³•ä¸­æ·»åŠ å“åº”å¤´ def process_response(self,request,response): ''' :param request: :param response: å°±æ˜¯è§†å›¾å‡½æ•°çš„è¿”å›å€¼(HttpResonseå¯¹è±¡) :return: ''' ''' print(response) responseè¿”å›çš„æ˜¯ä¸€ä¸ªHttpResponseå¯¹è±¡ ''' #å¿…é¡»è¿”å›responseè¿™ä¸ªå€¼ï¼Œä¸è¿”å›ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„respnseæ–¹æ³•æ‹¿ä¸åˆ°è¿™ä¸ªå€¼ return response 4.3process_view(self, request, view_func, view_args, view_kwargs) process_viewæ˜¯åœ¨è§†å›¾å‡½æ•°æ‰§è¡Œå‰æ‰§è¡Œ è¯¥æ–¹æ³•æœ‰å››ä¸ªå‚æ•° requestæ˜¯HttpRequestå¯¹è±¡ã€‚ view_funcæ˜¯Djangoå³å°†ä½¿ç”¨çš„è§†å›¾å‡½æ•°ã€‚ï¼ˆå®ƒæ˜¯å®é™…çš„å‡½æ•°å¯¹è±¡ï¼Œè€Œä¸æ˜¯å‡½æ•°çš„åç§°ä½œä¸ºå­—ç¬¦ä¸²ã€‚ï¼‰ view_argsæ˜¯å°†ä¼ é€’ç»™è§†å›¾çš„ä½ç½®å‚æ•°çš„åˆ—è¡¨. view_kwargsæ˜¯å°†ä¼ é€’ç»™è§†å›¾çš„å…³é”®å­—å‚æ•°çš„å­—å…¸ã€‚ view_argså’Œview_kwargséƒ½ä¸åŒ…å«ç¬¬ä¸€ä¸ªè§†å›¾å‚æ•°ï¼ˆrequestï¼‰ã€‚ Djangoä¼šåœ¨è°ƒç”¨è§†å›¾å‡½æ•°ä¹‹å‰è°ƒç”¨process_viewæ–¹æ³•ã€‚ å®ƒåº”è¯¥è¿”å›Noneæˆ–ä¸€ä¸ªHttpResponseå¯¹è±¡ã€‚ å¦‚æœè¿”å›Noneï¼ŒDjangoå°†ç»§ç»­å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œæ‰§è¡Œä»»ä½•å…¶ä»–ä¸­é—´ä»¶çš„process_viewæ–¹æ³•ï¼Œç„¶åå†æ‰§è¡Œç›¸åº”çš„è§†å›¾ã€‚ å¦‚æœå®ƒè¿”å›ä¸€ä¸ªHttpResponseå¯¹è±¡ï¼ŒDjangoä¸ä¼šè°ƒç”¨å¯¹åº”çš„è§†å›¾å‡½æ•°ã€‚ å®ƒå°†æ‰§è¡Œä¸­é—´ä»¶çš„process_responseæ–¹æ³•å¹¶å°†åº”ç”¨åˆ°è¯¥HttpResponseå¹¶è¿”å›ç»“æœã€‚ process_viewæ‰§è¡Œé¡ºåºç¤ºæ„å›¾ ä¸­é—´ä»¶æ–‡ä»¶ from django.utils.deprecation import MiddlewareMixin from django.shortcuts import redirect,render,HttpResponse class MD1(MiddlewareMixin): def process_request(self,request): print('MD1çš„process_requestæ–¹æ³•') def process_response(self,request,response): print('MD1çš„process_responseæ–¹æ³•') return response def process_view(self,request,view_func,view_args,view_kwargs): print('MD1çš„process_viewæ–¹æ³•',view_func.__name__) class MD2(MiddlewareMixin): def process_request(self, request): print('MD2çš„process_requestæ–¹æ³•') def process_response(self, request, response): print('MD2çš„process_responseæ–¹æ³•') return response def process_view(self, request, view_func, view_args, view_kwargs): print('MD2çš„process_viewæ–¹æ³•', view_func.__name__) é…ç½®settingsæ–‡ä»¶ï¼ŒMIDDLEWAREé¡¹ 'app01.mymiddleware.xx.MD1', 'app01.mymiddleware.xx.MD2', è§†å›¾æ–‡ä»¶ def login(request): #è¿™é‡Œæ‰“å°ä¸€ä¸ªloginè§†å›¾å‡½æ•°æ˜¯ä¸ºäº†çœ‹åˆ°æ‰§è¡Œçš„é¡ºåºï¼Œprocess_request,process_response,process_view print('loginè§†å›¾å‡½æ•°') if request.method == 'GET': return render(request,'login.html') æ‰“å°ç»“æœ å¯ä»¥çœ‹åˆ°ï¼Œå…ˆæ‰§è¡Œprocess_requestæ–¹æ³•ï¼Œç„¶åæ‰§è¡Œprocess_viewæ–¹æ³•ï¼Œprocess_viewæ–¹æ³•æ˜¯åœ¨è§†å›¾å‡½æ•°æ‰§è¡Œå‰æ‰§è¡Œï¼Œä¹‹åæ‰§è¡Œè§†å›¾å‡½æ•°ï¼Œæœ€åæ‰§è¡Œprocess_responseæ–¹æ³•ï¼Œå¹¶ä¸”process_responseæ˜¯å€’åºæ‰§è¡Œ âš ï¸âš ï¸âš ï¸å¦‚æœåœ¨process_requestæ–¹æ³•ä¸­è¿”å›äº†HttpResponseå¯¹è±¡ï¼Œåˆ™åªæ‰§è¡Œè‡ªå·±ä¸­é—´ä»¶çš„process_requestæ–¹æ³•å’Œprocess_responseæ–¹æ³•ï¼Œå¦‚æœè‡ªå·±çš„ä¸­é—´ä»¶æ²¡æœ‰å®šä¹‰process_responseæ–¹æ³•ï¼Œåˆ™ä¼šäº¤ç»™è‡ªå·±ç±»çš„ä¸Šä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¦‚æœä¸Šä¸€ä¸ªç±»ä¹Ÿæ²¡æœ‰ï¼Œä¼šä¸€ç›´å¾€ä¸Šæ¨ class MD1(MiddlewareMixin): def process_request(self,request): print('MD1çš„process_requestæ–¹æ³•') #è¿™é‡Œè¿”å›äº†ä¸€ä¸ªHttpResponseå¯¹è±¡ï¼Œåˆ™åªæ‰§è¡Œè‡ªå·±ä¸­é—´ä»¶çš„process_requestæ–¹æ³•å’Œprocess_responseæ–¹æ³• return HttpResponse('xxx') def process_response(self,request,response): print('MD1çš„process_responseæ–¹æ³•') return response def process_view(self,request,view_func,view_args,view_kwargs): print('MD1çš„process_viewæ–¹æ³•',view_func.__name__) æ‰“å°ç»“æœ MD1çš„process_requestæ–¹æ³• MD1çš„process_responseæ–¹æ³• ç¤ºæ„å›¾ 4.4process_exception(self, request, exception) è¯¥æ–¹æ³•ä¸¤ä¸ªå‚æ•°: ä¸€ä¸ªHttpRequestå¯¹è±¡ ä¸€ä¸ªexceptionæ˜¯è§†å›¾å‡½æ•°å¼‚å¸¸äº§ç”Ÿçš„Exceptionå¯¹è±¡ã€‚ è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨è§†å›¾å‡½æ•°ä¸­å‡ºç°å¼‚å¸¸äº†æ‰æ‰§è¡Œï¼Œå®ƒè¿”å›çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ªNoneä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªHttpResponseå¯¹è±¡ã€‚å¦‚æœæ˜¯HttpResponseå¯¹è±¡ï¼ŒDjangoå°†è°ƒç”¨æ¨¡æ¿å’Œä¸­é—´ä»¶ä¸­çš„process_responseæ–¹æ³•ï¼Œå¹¶è¿”å›ç»™æµè§ˆå™¨ï¼Œå¦åˆ™å°†é»˜è®¤å¤„ç†å¼‚å¸¸ã€‚å¦‚æœè¿”å›ä¸€ä¸ªNoneï¼Œåˆ™äº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„process_exceptionæ–¹æ³•æ¥å¤„ç†å¼‚å¸¸ã€‚å®ƒçš„æ‰§è¡Œé¡ºåºä¹Ÿæ˜¯æŒ‰ç…§ä¸­é—´ä»¶æ³¨å†Œé¡ºåºçš„å€’åºæ‰§è¡Œã€‚ process_exceptionæ‰§è¡Œç¤ºæ„å›¾ ä¸­é—´ä»¶æ–‡ä»¶ from django.utils.deprecation import MiddlewareMixin from django.shortcuts import redirect,render,HttpResponse class MD1(MiddlewareMixin): def process_request(self,request): print('MD1çš„process_requestæ–¹æ³•') # return HttpResponse('xxx') def process_response(self,request,response): print('MD1çš„process_responseæ–¹æ³•') return response def process_view(self,request,view_func,view_args,view_kwargs): print('MD1çš„process_viewæ–¹æ³•',view_func.__name__) def process_exception(self, request, exception): print(exception) print(\"MD1çš„process_exceptionæ–¹æ³•\") return HttpResponse(str(exception)) class MD2(MiddlewareMixin): def process_request(self, request): print('MD2çš„process_requestæ–¹æ³•') def process_response(self, request, response): print('MD2çš„process_responseæ–¹æ³•') return response def process_view(self, request, view_func, view_args, view_kwargs): print('MD2çš„process_viewæ–¹æ³•', view_func.__name__) def process_exception(self, request, exception): print(exception) print(\"MD2çš„process_exceptionæ–¹æ³•\") return HttpResponse(str(exception)) è§†å›¾å‡½æ•°æ–‡ä»¶ï¼Œåœ¨è§†å›¾å‡½æ•°ä¸­æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ def login(request): # print('loginè§†å›¾å‡½æ•°') print(\"app01ä¸­çš„loginè§†å›¾å‡½æ•°\") raise ValueError(\"è§†å›¾å‡½æ•°ä¸­å‡ºé”™äº†æ‰æ‰§è¡Œprocess_exceptionæ–¹æ³•\") return HttpResponse(\"OK\") if request.method == 'GET': return render(request,'login.html') else: username = request.POST.get('username') password = request.POST.get('password') if username == 'admin' and password == 'admin': request.session['is_login'] = True request.session['username'] = username \"\"\" è®¾ç½®sessionååšçš„3ä»¶äº‹ 1 ç”Ÿæˆéšæœºå­—ç¬¦ä¸² 2 æ”¾åˆ°cookieä¸­è¿›è¡Œä¼ è¾“ 3 å°†éšæœºå­—ç¬¦ä¸²å’Œå¯¹åº”æ•°æ®ä¿å­˜åˆ°è‡ªå·±æœåŠ¡ç«¯çš„æ•°æ®åº“ä¸­ \"\"\" return redirect('home') else: return redirect('login') æ‰“å°ç»“æœï¼Œå½“md1å’Œmd2ä¸­çš„process_exceptionæ–¹æ³•éƒ½è¿”å›äº†Httpresponseå¯¹è±¡ï¼Œåªæ‰§è¡Œmd2çš„process_exceptionæ–¹æ³• å½“åªæœ‰md1è¿”å›Httpresponseå¯¹è±¡æ—¶ï¼Œmd1å’Œmd2çš„process_exceptionæ–¹æ³•éƒ½æ‰§è¡Œ 4.5process_template_response(self, request, response) å®ƒçš„å‚æ•°ï¼Œä¸€ä¸ªHttpRequestå¯¹è±¡ï¼Œresponseæ˜¯TemplateResponseå¯¹è±¡ï¼ˆç”±è§†å›¾å‡½æ•°æˆ–è€…ä¸­é—´ä»¶äº§ç”Ÿï¼‰ process_template_responseæ˜¯åœ¨è§†å›¾å‡½æ•°æ‰§è¡Œå®Œæˆåç«‹å³æ‰§è¡Œï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªå‰ææ¡ä»¶ï¼Œé‚£å°±æ˜¯è§†å›¾å‡½æ•°è¿”å›çš„å¯¹è±¡æœ‰ä¸€ä¸ªrender()æ–¹æ³•ï¼ˆæˆ–è€…è¡¨æ˜è¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªTemplateResponseå¯¹è±¡æˆ–ç­‰ä»·æ–¹æ³•ï¼‰ ä¸­é—´ä»¶æ–‡ä»¶ from django.utils.deprecation import MiddlewareMixin from django.shortcuts import redirect,render,HttpResponse class MD1(MiddlewareMixin): def process_request(self,request): print('MD1çš„process_requestæ–¹æ³•') # return HttpResponse('xxx') def process_response(self,request,response): print('MD1çš„process_responseæ–¹æ³•') return response def process_view(self,request,view_func,view_args,view_kwargs): print('MD1çš„process_viewæ–¹æ³•',view_func.__name__) def process_exception(self, request, exception): print(exception) print(\"MD1çš„process_exceptionæ–¹æ³•\") return HttpResponse(str(exception)) def process_template_response(self, request, response): print(\"MD1çš„process_template_responseæ–¹æ³•\") return response class MD2(MiddlewareMixin): def process_request(self, request): print('MD2çš„process_requestæ–¹æ³•') def process_response(self, request, response): print('MD2çš„process_responseæ–¹æ³•') return response def process_view(self, request, view_func, view_args, view_kwargs): print('MD2çš„process_viewæ–¹æ³•', view_func.__name__) def process_exception(self, request, exception): print(exception) print(\"MD2çš„process_exceptionæ–¹æ³•\") # return HttpResponse(str(exception)) def process_template_response(self, request, response): print(\"MD2çš„process_template_responseæ–¹æ³•\") return response è§†å›¾æ–‡ä»¶ï¼Œå¿…é¡»è¿™ä¹ˆå†™æ‰è¡Œ def login(request): def render(): print(\"in index/render\") return HttpResponse(\"OK\") # è¿”å›çš„å°†æ˜¯è¿™ä¸ªæ–°çš„å¯¹è±¡ rep = HttpResponse(\"OK\") rep.render = render return rep æ‰“å°ç»“æœ 5.ä¸­é—´ä»¶æ‰§è¡Œæµç¨‹ è¯·æ±‚åˆ°è¾¾ä¸­é—´ä»¶ä¹‹åï¼Œå…ˆæŒ‰ç…§æ­£åºæ‰§è¡Œæ¯ä¸ªæ³¨å†Œä¸­é—´ä»¶çš„process_requesæ–¹æ³•ï¼Œprocess_requestæ–¹æ³•è¿”å›çš„å€¼æ˜¯Noneï¼Œå°±ä¾æ¬¡æ‰§è¡Œï¼Œå¦‚æœè¿”å›çš„å€¼æ˜¯HttpResponseå¯¹è±¡ï¼Œä¸å†æ‰§è¡Œåé¢çš„process_requestæ–¹æ³•ï¼Œè€Œæ˜¯æ‰§è¡Œå½“å‰å¯¹åº”ä¸­é—´ä»¶çš„process_responseæ–¹æ³•ï¼Œå°†HttpResponseå¯¹è±¡è¿”å›ç»™æµè§ˆå™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šå¦‚æœMIDDLEWAREä¸­æ³¨å†Œäº†6ä¸ªä¸­é—´ä»¶ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¬¬3ä¸ªä¸­é—´ä»¶è¿”å›äº†ä¸€ä¸ªHttpResponseå¯¹è±¡ï¼Œé‚£ä¹ˆç¬¬4,5,6ä¸­é—´ä»¶çš„process_requestå’Œprocess_responseæ–¹æ³•éƒ½ä¸æ‰§è¡Œï¼Œé¡ºåºæ‰§è¡Œ3,2,1ä¸­é—´ä»¶çš„process_responseæ–¹æ³• process_requestæ–¹æ³•éƒ½æ‰§è¡Œå®Œåï¼ŒåŒ¹é…è·¯ç”±ï¼Œæ‰¾åˆ°è¦æ‰§è¡Œçš„è§†å›¾å‡½æ•°ï¼Œå…ˆä¸æ‰§è¡Œè§†å›¾å‡½æ•°ï¼Œå…ˆæ‰§è¡Œä¸­é—´ä»¶ä¸­çš„process_viewæ–¹æ³•ï¼Œprocess_viewæ–¹æ³•è¿”å›Noneï¼Œç»§ç»­æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ‰€æœ‰process_viewæ–¹æ³•æ‰§è¡Œå®Œåæ‰§è¡Œè§†å›¾å‡½æ•°ã€‚åŠ å…¥ä¸­é—´ä»¶3 çš„process_viewæ–¹æ³•è¿”å›äº†HttpResponseå¯¹è±¡ï¼Œåˆ™4,5,6çš„process_viewä»¥åŠè§†å›¾å‡½æ•°éƒ½ä¸æ‰§è¡Œï¼Œç›´æ¥ä»æœ€åä¸€ä¸ªä¸­é—´ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸­é—´ä»¶6çš„process_responseæ–¹æ³•å¼€å§‹å€’åºæ‰§è¡Œ process_template_responseå’Œprocess_exceptionä¸¤ä¸ªæ–¹æ³•çš„è§¦å‘æ˜¯æœ‰æ¡ä»¶çš„ï¼Œæ‰§è¡Œé¡ºåºä¹Ÿæ˜¯å€’åºã€‚æ€»ç»“æ‰€æœ‰çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/python-other/nginx+django+uwsgiéƒ¨ç½²é¡¹ç›®.html":{"url":"python/python-other/nginx+django+uwsgiéƒ¨ç½²é¡¹ç›®.html","title":"nginx+django+uWSGIéƒ¨ç½²é¡¹ç›®","keywords":"","body":"nginx+django+uwsgiéƒ¨ç½²é¡¹ç›® ä¸€ã€WSGIã€uWSGIã€uwsgiæ¦‚å¿µç®€è¿° WSGI WSGIï¼Œå…¨ç§° Web Server Gateway Interfaceï¼Œæˆ–è€… Python Web Server Gateway Interface ï¼Œæ˜¯ä¸º Python è¯­è¨€å®šä¹‰çš„ Web æœåŠ¡å™¨å’Œ Web åº”ç”¨ç¨‹åºæˆ–æ¡†æ¶ä¹‹é—´çš„ä¸€ç§ç®€å•è€Œé€šç”¨çš„æ¥å£ wsgi server (æ¯”å¦‚uWSGIï¼‰ è¦å’Œ wsgi applicationï¼ˆæ¯”å¦‚django ï¼‰äº¤äº’ï¼Œuwsgiéœ€è¦å°†è¿‡æ¥çš„è¯·æ±‚è½¬ç»™django å¤„ç†ï¼Œé‚£ä¹ˆuWSGI å’Œ djangoçš„äº¤äº’å’Œè°ƒç”¨å°±éœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒå°±æ˜¯WSGI WSGI çš„å®˜æ–¹å®šä¹‰æ˜¯ï¼Œthe Python Web Server Gateway Interfaceã€‚ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸œè¥¿æ˜¯ä¸€ä¸ªGatewayï¼Œä¹Ÿå°±æ˜¯ç½‘å…³ã€‚ç½‘å…³çš„ä½œç”¨å°±æ˜¯åœ¨åè®®ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ WSGI æ˜¯ä½œä¸º Web æœåŠ¡å™¨ä¸ Web åº”ç”¨ç¨‹åºæˆ–åº”ç”¨æ¡†æ¶ä¹‹é—´çš„ä¸€ç§ä½çº§åˆ«çš„æ¥å£ï¼Œä»¥æå‡å¯ç§»æ¤ Web åº”ç”¨å¼€å‘çš„å…±åŒç‚¹ã€‚WSGI æ˜¯åŸºäºç°å­˜çš„ CGI æ ‡å‡†è€Œè®¾è®¡çš„ã€‚ uWSGI uWSGIæ˜¯ä¸€ä¸ªWebæœåŠ¡å™¨ï¼Œå®ƒå®ç°äº†WSGIåè®®ã€uwsgiã€httpç­‰åè®®ã€‚Nginxä¸­HttpUwsgiModuleçš„ä½œç”¨æ˜¯ä¸uWSGIæœåŠ¡å™¨è¿›è¡Œäº¤æ¢ã€‚ uwsgi uwsgiæ˜¯æœåŠ¡å™¨å’ŒæœåŠ¡ç«¯åº”ç”¨ç¨‹åºçš„é€šä¿¡åè®®ï¼Œè§„å®šäº†æ€ä¹ˆæŠŠè¯·æ±‚è½¬å‘ç»™åº”ç”¨ç¨‹åºå’Œè¿”å› äºŒã€å¤„ç†è¿‡ç¨‹ nginx+django+uWSGIå¤„ç†è¿‡ç¨‹ 1.å®¢æˆ·ç«¯(æµè§ˆå™¨)å‡†å¤‡å‘é€è¯·æ±‚ 2.å¦‚æœè¯·æ±‚çš„æ˜¯é™æ€å†…å®¹åˆ™ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œnginxåœ¨è¿™é‡Œç»Ÿä¸€æ”¶é›†åç«¯djangoé¡¹ç›®çš„é™æ€æ–‡ä»¶ 3.å¦‚æœè¯·æ±‚çš„æ˜¯åŠ¨æ€å†…å®¹, å°±æŠŠè¯·æ±‚è½¬å‘ç»™uWSGI ,uWSGIè¿æ¥Djangoè¿›å…¥æˆ‘ä»¬çš„Pythonç¨‹åºè¿›è¡Œå¤„ç†ï¼Œè¿™æœŸé—´uWSGIä¼šè¿æ¥æ•°æ®åº“è·å–æ•°æ® ä¸‰ã€éƒ¨ç½²è¿‡ç¨‹ 3.1ç¯å¢ƒåŠè§’è‰²è¯´æ˜ ç³»ç»Ÿç¯å¢ƒ è§’è‰² ç‰ˆæœ¬ ç³»ç»Ÿ centos7.6 nginx 1.16 django 2.1 mysql 5.7.22 uWSGI 2.0.18 supervisor 4.1.0 è§’è‰²è¯´æ˜ nginx æä¾›åå‘è§£æåŠŸèƒ½ï¼Œå°†80ç«¯å£è¯·æ±‚è½¬å‘è‡³djangoç«¯å£ï¼ŒåŒæ—¶è¿˜è´Ÿè´£å¤„ç†é™æ€èµ„æº uWSGI+django å¯åŠ¨åç«¯é¡¹ç›®ï¼Œå¤„ç†åŠ¨æ€è¯·æ±‚ mysql æ•°æ®åº“ï¼Œå­˜å‚¨æ•°æ®ï¼Œdjangoä»æ•°æ®åº“ä¸­è·å–æ•°æ® supervisor è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œé˜²æ­¢uWSGIçªç„¶å´©æºƒï¼Œsupervisorèƒ½è‡ªåŠ¨å¯åŠ¨uWSGI 3.2éƒ¨ç½²è¿‡ç¨‹ 3.2.1å®‰è£…nginx1.16 1.ä¸‹è½½nginx [root@django ~]# wget http://nginx.org/download/nginx-1.16.1.tar.gz 2.å®‰è£…ä¾èµ– [root@django ~]# yum -y install gcc gcc-c++ zlib zlib-devel openssl openssl-devel pcre-devel 3.æ·»åŠ ngxinç”¨æˆ·å’Œç»„ [root@django ~]# groupadd nginx && useradd nginx -g nginx -s /sbin/nologin -M 4.è§£å‹ç¼©å¹¶ç¼–è¯‘å®‰è£… [root@django ~]# tar xf nginx-1.16.1.tar.gz [root@django ~]# cd nginx-1.16.1/ [root@django nginx-1.16.1]# ./configure --user=nginx --group=nginx --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_realip_module --with-http_gzip_static_module [root@django nginx-1.16.1]# make -j 2 && make install 5.è®¾ç½®nginxå‘½ä»¤ç¯å¢ƒå˜é‡ [root@django ~]# echo \"PATH=/usr/local/nginx/sbin:$PATH\" >/etc/profile.d/nginx.sh [root@django ~]# source /etc/profile 6.å¯åŠ¨nginx [root@django ~]# nginx [root@django ~]# ps aux|grep nginx root 6833 0.0 0.2 45968 1132 ? Ss 15:20 0:00 nginx: master process nginx nginx 6834 0.0 0.3 48508 1972 ? S 15:20 0:00 nginx: worker process root 6920 0.0 0.1 112708 988 pts/0 S+ 15:21 0:00 grep --color=auto nginx 3.2.2å®‰è£…mysql5.7.22 âš ï¸âš ï¸âš ï¸ äºŒè¿›åˆ¶å®‰è£…mysqlçš„å¯åŠ¨è„šæœ¬å’Œ å®‰è£…ç›®å½•/mysql/bin/mysqld_safe è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­éƒ½æ˜¯é»˜è®¤/usr/local/mysqlï¼Œå¦‚æœå®‰è£…ç›®å½•ä¸åœ¨/usr/local/ä¸‹ï¼Œéœ€è¦ä¿®æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„è·¯å¾„ï¼Œå³æŠŠ/usr/localæ›¿æ¢ä¸ºmysqlå®‰è£…ç›®å½• sed -i 's#/usr/local#/application#g' /etc/init.d/mysql /application/mysql/bin/mysqld_safe 1.ä¸‹è½½MySQL-5.7.22äºŒè¿›åˆ¶åŒ… [root@django ~]# wget https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz MD5å€¼ 9ef7a05695f8b4ea29f8d077c3b415e2 2.è§£å‹ç¼©mysqläºŒè¿›åˆ¶åŒ…åˆ°/usr/local [root@django ~]# tar xf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C /usr/local 3.ä¿®æ”¹åç§°ã€åšè½¯è¿æ¥ [root@django local]# mv /usr/local/mysql-5.7.22-linux-glibc2.12-x86_64 /usr/local/mysql-5.7.22 && \\ ln -s /usr/local/mysql-5.7.22 /usr/local/mysql 4.åˆ›å»ºmysqlç”¨æˆ·å’Œç»„ [root@django local]# groupadd mysql && useradd -g mysql -s /bin/false mysql 5.ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶ï¼Œmyql-5.7.22äºŒè¿›åˆ¶åŒ…é»˜è®¤æ²¡æœ‰mysqlé…ç½®æ–‡ä»¶ #å¤‡ä»½/etc/my.cnf [root@django local]# mv /etc/my.cnf /etc/my.cnf.old #ä»¥ä¸‹é…ç½®ä¸ºæœ€ç²¾ç®€ç‰ˆï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œç›¸åº”è®¾ç½® [root@django~]# cat >> /etc/my.cnf /etc/profile.d/mysql.sh #ä½¿é…ç½®ç”Ÿæ•ˆ [root@django ~]# source /etc/profile 9.é…ç½®systemdç®¡ç†mysql [root@django ~]# cat >> /etc/systemd/system/mysqld.service set password='123'; Query OK, 0 rows affected (0.00 sec) mysql> flush privileges; Query OK, 0 rows affected (0.01 sec) 3.2.3å®‰è£…python3.6 1.ä¸‹è½½python [root@django ~]# wget https://www.python.org/ftp/python/3.6.9/Python-3.6.9.tar.xz 2.å®‰è£…ä¾èµ–åŒ… [root@django ~]# yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel libffi-devel gcc gcc-c++ make 3.è§£å‹ç¼©pythonå¹¶ç¼–è¯‘å®‰è£… [root@django ~]# tar xf Python-3.6.9.tar.gz [root@django ~]# cd Python-3.6.9/ [root@django Python-3.6.9]# ./configure --prefix=/usr/local/python36 [root@django Python-3.6.9]# make -j 2 && make install 4.å¯¼å‡ºpythonå‘½ä»¤ç¯å¢ƒå˜é‡ [root@django ~]# echo \"PATH=/usr/local/python36/bin:$PATH\" >/etc/profile.d/python36.sh [root@django ~]# source /etc/profile [root@django ~]# python3 -V Python 3.6.9 5.é…ç½®pipå›½å†…æº [root@django ~]# mkdir ~/.pip [root@django ~]# cat >~/.pip/pip.conf 3.2.4éƒ¨ç½²pythonè™šæ‹Ÿç¯å¢ƒvirtualenvã€virtualenvwrappeã€uwsgiåŠdjangoé¡¹ç›® é‰´äºvirtualenvä¸ä¾¿äºå¯¹è™šæ‹Ÿç¯å¢ƒé›†ä¸­ç®¡ç†,æ‰€ä»¥æ¨èç›´æ¥ä½¿ç”¨virtualenvwrapper,virtualenvwrapperæä¾›äº†ä¸€ç³»åˆ—å‘½ä»¤ä½¿å¾—å’Œè™šæ‹Ÿç¯å¢ƒå·¥ä½œå˜å¾—ä¾¿åˆ©,å®ƒæŠŠä½ æ‰€æœ‰çš„è™šæ‹Ÿç¯å¢ƒéƒ½æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹ virtualenvwrapperæ•´ä½“å·¥ä½œè¿‡ç¨‹ 1.å®‰è£…virtualenvwrapper 2.åœ¨~/.bashrcæ–‡ä»¶ä¸­æŒ‡å®švirtualenvwrapperå­˜æ”¾è™šæ‹Ÿç¯å¢ƒæ€»ç›®å½•,æŒ‡å®švirtualenvwrapper.shå­˜æ”¾ä½ç½®(findæŸ¥æ‰¾) 3.mkvirtualenvå‘½ä»¤åˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒ,-pé€‰é¡¹æŒ‡å®šä¸åŒpythonç‰ˆæœ¬å‘½ä»¤è·¯å¾„ 4. workonå‘½ä»¤åˆ‡æ¢ä¸åŒpythonè™šæ‹Ÿç¯å¢ƒ ç¬¬ä¸€æ­¥ã€å®‰è£…virtualenvã€virtualenvwrapper [root@django ~]# pip3 install virtualenv virtualenvwrapper ç¬¬äºŒæ­¥ã€ç¼–è¾‘virtualenvwrapperç¯å¢ƒå˜é‡ //å‘~/.bashrcä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ [root@django ~]# cat >> ~/.bashrc requirements.txtå¯¼å‡ºå¼€å‘ç¯å¢ƒä¸­æ‰€æœ‰å®‰è£…çš„æ¨¡å— ç¬¬å…­æ­¥ã€ä¿®æ”¹é¡¹ç›®requirements.txtæ–‡ä»¶ä¸­çš„djangoç‰ˆæœ¬ä¸º2.1 å…‹éš†çš„djangoåšå®¢é¡¹ç›®ä¸­çš„requirements.txtæ–‡ä»¶djangoç‰ˆæœ¬æ˜¯2.2.8ï¼Œç»“æœå‡ºäº†ä¸€å †é—®é¢˜ï¼Œä½†æ˜¯ä½œè€…åœ¨githubä¸Šä»‹ç»å´æ˜¯åŸºäºdjango2.1ï¼Œä¿®æ”¹å®Œåå®‰è£…requirements.txtä¸­çš„æ¨¡å— (django) [root@django DjangoBlog]# pip3 install -Ur requirements.txt (django) [root@django DjangoBlog]# pip3 install pymysql ç¬¬ä¸ƒæ­¥ã€é…ç½®mysqlå­—ç¬¦é›† //ä¿®æ”¹my.cnfï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ [mysqld] character-set-server=utf8mb4 collation-server=utf8mb4_unicode_ci [client] default-character-set = utf8mb4 [mysql] default-character-set = utf8mb4 //é‡å¯mysql (django) [root@django DjangoBlog]# systemctl restart mysqld ç¬¬å…«æ­¥ã€å»ºåº“æˆæƒ CREATE USER 'djangoblog'@'localhost' IDENTIFIED BY 'DjAnGoBlOg123!@#'; CREATE DATABASE `djangoblog` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */; GRANT all ON djangoblog.* TO 'djangoblog'@'localhost'; FLUSH PRIVILEGES; ç¬¬ä¹æ­¥ã€ä¿®æ”¹djangoé¡¹ç›®mysqlé…ç½® //ä¿®æ”¹DjangoBlog/settings.pyä¸­çš„DATABASESé…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤º DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'djangoblog', 'USER': 'djangoblog', 'PASSWORD': 'DjAnGoBlOg123!@#', 'HOST': 'localhost', 'PORT': 3306, 'OPTIONS': {'charset': 'utf8mb4'}, } } ç¬¬åæ­¥ã€ç¼–è¾‘DjangoBlog/__init__.pyï¼ŒæŒ‡å®špymysqlä¸ºå®¢æˆ·ç«¯ cat >DjangoBlog/__init__.py /usr/local/nginx/conf/conf.d/django.blog.conf é…ç½®æœ¬æœºhostsè§£æåè®¿é—®django.blogï¼Œé¡¹ç›®ç•Œé¢å¦‚ä¸‹ 3.2.5å®‰è£…supervisorç®¡ç†uWSGI 1.å®‰è£…supervisor (django) [root@django DjangoBlog]# pip3 install supervisor (django) [root@django DjangoBlog]# supervisord -v 4.1.0 2.ç”Ÿæˆsupervisoré…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤echo_supervisord_conf > /etc/supervisord.conf cat >> /etc/supervisord.conf /etc/logrotate.d/supervisor > /usr/lib/tmpfiles.d/tmp.conf> /usr/lib/systemd/system/supervisord.service /etc/supervisor/config.d/django.ini update django django: added process group supervisor> status django RUNNING pid 19728, uptime 0:00:17 å…³äºdjangoæ”¶é›†é™æ€æ–‡ä»¶é…ç½® uwsigé»˜è®¤ä¸è§£æé™æ€æ–‡ä»¶ï¼Œéœ€è¦ç»Ÿä¸€æ”¶é›†ä¸€ä¸‹ï¼Œäº¤ç»™nginxå»è¿”å›ç»™å®¢æˆ·ç«¯ //settings.pyæ–‡ä»¶ä¸­å¦‚ä¸‹å‚æ•°æ˜¯é…ç½®ç»Ÿä¸€æ”¶é›†æ‰€æœ‰é™æ€æ–‡ä»¶ STATIC_ROOT='xxx' //è¿™é‡Œå…‹éš†çš„é¡¹ç›®ä½œè€…æŠŠç›®å½•è®¾ç½®ä¸ºäº†å¦‚ä¸‹è·¯å¾„ DjangoBlog/collectedstatic //é…ç½®å®Œåéœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ ./manage.py collectstatic --no-input #æ”¶é›†é™æ€æ–‡ä»¶ ./manage.py compress --force #å‹ç¼©é™æ€æ–‡ä»¶ nginxå¯¹äºé™æ€èµ„æºçš„é…ç½® nginx+django+uWSGIä¸­è¿˜å¯ä»¥é…ç½®nginxä¸“é—¨åŒ¹é…é™æ€èµ„æºè·¯å¾„ location /static { alias /django/DjangoBlog/collectedstatic; } djangoä¸­é…ç½®é™æ€èµ„æºåˆ«åï¼Œè¿™é‡Œstaticæ˜¯åˆ«åï¼Œstaticsæ˜¯çœŸæ­£çš„è·¯å¾„ STATIC_URL = '/static/' STATICFILES_DIRS = [ os.path.join(BASE_DIR,'statics'), ] python manage.py runserver å…¶å®æ˜¯è°ƒç”¨wsgirefè¿™ä¸ªpythonå†…ç½®çš„wsgi æœåŠ¡å™¨ï¼Œæ€§èƒ½å¾ˆä½ï¼Œå•çº¿ç¨‹ uWSGIæ˜¯Cå†™çš„ä¸€ä¸ªåŸºäºuwsgiåè®®è¿è¡Œçš„é«˜æ€§èƒ½WebæœåŠ¡å™¨ï¼Œæ”¯æŒå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/python-other/pythonè™šæ‹Ÿç¯å¢ƒ.html":{"url":"python/python-other/pythonè™šæ‹Ÿç¯å¢ƒ.html","title":"pythonè™šæ‹Ÿç¯å¢ƒ","keywords":"","body":"pythonè™šæ‹Ÿç¯å¢ƒ ä¸ºä»€ä¹ˆè¦åˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒ pythonç‰ˆæœ¬ä¼—å¤š,éƒ¨åˆ†ç‰ˆæœ¬åŠŸèƒ½å·®å¼‚è¾ƒå¤§,centOS7.5 é»˜è®¤pythonç‰ˆæœ¬2.7.5,centOS6.9 é»˜è®¤pythonç‰ˆæœ¬2.6.6,åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ç»å¸¸é‡åˆ°ç¬¬ä¸‰æ–¹åº“ä¾èµ–çš„pythonç‰ˆæœ¬å’Œç³»ç»Ÿpythonç‰ˆæœ¬ä¸ä¸€è‡´çš„æƒ…å†µ,åŒæ—¶åˆå› ç³»ç»Ÿåº•å±‚éœ€è¦è°ƒç”¨å½“å‰ç‰ˆæœ¬python,æ‰€ä»¥ä¸èƒ½éšæ„å˜æ›´å½“å‰ç³»ç»Ÿpythonç‰ˆæœ¬,å¦‚æ­¤æƒ…å¢ƒä¸‹å°±ä¼šæœ‰pythonå¤šç‰ˆæœ¬å…±å­˜çš„æƒ…å†µ,å› æ­¤pythonå¤šç¯å¢ƒç®¡ç†å·¥å…·åº”ç”¨è€Œç”Ÿ ä¸€ã€pyenv pyenv githubåœ°å€ 1.1pyenvç®€ä»‹ pyenvæ˜¯ä¸€ä¸ªç®€å•çš„pythonç‰ˆæœ¬ç®¡ç†å·¥å…·,ä»¥å‰å«åšpythonbrew,è¿™ä¸ªå·¥å…·å¯ä»¥æ–¹ä¾¿åˆ‡æ¢å…¨å±€pythonç‰ˆæœ¬,å®‰è£…å¤šä¸ªä¸åŒçš„pythonç‰ˆæœ¬,è®¾ç½®ç‹¬ç«‹çš„æŸä¸ªæ–‡ä»¶å¤¹æˆ–è€…å·¥ç¨‹ç›®å½•ç‰¹å¼‚çš„pythonç‰ˆæœ¬,åŒæ—¶åˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒ 1.2pyenvåŸç† pyenvä½œä¸ºpythonçš„ç‰ˆæœ¬ç®¡ç†å·¥å…·,é€šè¿‡æ”¹å˜shellçš„ç¯å¢ƒå˜é‡æ¥åˆ‡æ¢ä¸åŒçš„pythonç‰ˆæœ¬,ä»¥è¾¾åˆ°å¤šç‰ˆæœ¬å…±å­˜çš„ç›®çš„ 1) pyenvå®‰è£…åä¼šåœ¨ç³»ç»ŸPATHä¸­æ’å…¥shimsè·¯å¾„,æ¯æ¬¡æ‰§è¡Œpythonç›¸å…³çš„å¯æ‰§è¡Œæ–‡ä»¶,ä¼šä¼˜å…ˆåœ¨shimsé‡Œå¯»æ‰¾pythonè·¯å¾„~/.pyenv/shims:/usr/local/bin:/usr/bin:/bin 2) ç³»ç»Ÿé€‰æ‹©pythonç‰ˆæœ¬,æŒ‰ç…§å¦‚ä¸‹é¡ºåºé€‰æ‹©pythonè„šæœ¬ â€‹ â‘ shellå˜é‡è®¾ç½®(æ‰§è¡ŒpyenvæŸ¥çœ‹) â€‹ â‘¡å½“å‰å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•ä¸‹çš„.python_versionæ–‡ä»¶é‡Œçš„ç‰ˆæœ¬å·(æ‰§è¡Œpyenv shellæŸ¥çœ‹) â€‹ â‘¢ä¸Šå±‚ç›®å½•æŸ¥è¯¢æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª.pyenv-versionæ–‡ä»¶ â€‹ â‘£å…¨å±€çš„ç‰ˆæœ¬å·åœ¨~/.pyenv/versionæ–‡ä»¶å†…(æ‰§è¡Œpyenv global) 3) ç¡®å®šç‰ˆæœ¬æ–‡ä»¶çš„ä½ç½®å’Œpythonç‰ˆæœ¬å,pyenvä¼šæ ¹æ®ç‰ˆæœ¬å·åœ¨~/.pyenv/versions/ç›®å½•ä¸­æŸ¥æ‰¾å¯¹åº”çš„pythonç‰ˆæœ¬,æ‰§è¡Œå‘½ä»¤pyenv versionså¯æŸ¥çœ‹ç³»ç»Ÿç›®å‰å®‰è£…çš„pythonç‰ˆæœ¬ 1.3éƒ¨ç½²pyenv //å…‹éš†pyenvè‡³rootå®¶ç›®å½• [root@test1 ~]# git clone git://github.com/yyuu/pyenv.git ~/.pyenv //ä¿®æ”¹ç¯å¢ƒå˜é‡ [root@test1 ~]# echo 'export PYENV_ROOT=\"$HOME/.pyenv\"' >> ~/.bashrc [root@test1 ~]# echo 'export PATH=\"$PYENV_ROOT/bin:$PATH\"' >> ~/.bashrc [root@test1 ~]# echo 'eval \"$(pyenv init -)\"' >> ~/.bashrc [root@test1 ~]# tail -3 ~/.bashrc export PYENV_ROOT=\"$HOME/.pyenv\" export PATH=\"$PYENV_ROOT/bin:$PATH\" eval \"$(pyenv init -)\" //ä½¿é…ç½®ç”Ÿæ•ˆ [root@test1 ~]# source ~/.bashrc //æµ‹è¯•å®‰è£…æ˜¯å¦æ­£ç¡®,è¿”å›å¦‚ä¸‹å³è¡¨æ˜æ­£ç¡® [root@test1 ~]# pyenv versions * system (set by /root/.pyenv/version) //è®¾ç½®pipå›½å†…æº mkdir ~/.pip cat >~/.pip/pip.conf 1.4é€šè¿‡oyenvç®¡ç†å¤šç‰ˆæœ¬python pyenvå‘½ä»¤è¯­æ³• Usage: pyenv [] //æŸ¥çœ‹å¯å®‰è£…çš„ç‰ˆæœ¬åˆ—è¡¨ [root@test1 ~]# pyenv install --list ä¼šåˆ—å‡ºå¥½å¤šä¸åŒç‰ˆæœ¬ //å®‰è£…ä¾èµ–åŒ… [root@test1 ~]# yum -y install python-pip python-devel gcc gcc-c++ zlib-devel libffi-devel bzip2-devel bzip2-libs readline readline-devel readline-static openssl openssl-devel openssl-static sqlite-devel //å®‰è£…æŒ‡å®šçš„pythonç‰ˆæœ¬ [root@test1 ~]# pyenv install 3.7.1 Downloading Python-3.7.1.tar.xz... -> https://www.python.org/ftp/python/3.7.1/Python-3.7.1.tar.xz Installing Python-3.7.1... Installed Python-3.7.1 to /root/.pyenv/versions/3.7.1 //åˆ‡æ¢å½“å‰ç›®å½•pythonç›®å½•ä¸º3.7.1 #æœªåˆ‡æ¢å‰ [root@test1 ~]# python Python 2.7.5 (default, Aug 7 2019, 00:51:29) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] on linux2 Type \"help\", \"copyright\", \"credits\" or \"license\" for more information. >>> #åˆ‡æ¢ [root@test1 ~]# pyenv local 3.7.1 [root@test1 ~]# python Python 3.7.1 (default, Feb 18 2020, 13:20:03) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information. //åˆ‡æ¢ååˆ·æ–°shims [root@test1 ~]# pyenv rehash //åˆ‡æ¢å›ç³»ç»Ÿç‰ˆæœ¬ [root@test1 ~]# pyenv global system pyenvé‡åˆ°çš„é—®é¢˜ 1.pyenv global systemåˆ‡æ¢å¤±è´¥ï¼Œæ­£å¸¸åº”è¯¥æ˜¯å›åˆ‡æ¢åˆ°ç³»ç»Ÿé»˜è®¤çš„python2.7.5ï¼Œä½†æ˜¯åˆ‡æ¢å¤±è´¥ï¼ŒåŸå› æœªçŸ¥ 2.pyenvåˆ‡æ¢åˆ°å®‰è£…çš„pythonç‰ˆæœ¬åï¼Œä¼šå¯¼è‡´åŸå…ˆç¼–è¯‘å®‰è£…çš„pythonç¯å¢ƒå˜é‡å¤±æ•ˆï¼Œä¾‹å¦‚ï¼ŒåŸå…ˆç¼–è¯‘å®‰è£…äº†python3.6ï¼Œç„¶åé€šè¿‡pyenvå®‰è£…äº†python3.7ï¼Œåˆ‡æ¢åä¼šå¯¼è‡´python3.6çš„ç¯å¢ƒå˜é‡å¤±æ•ˆï¼ŒåŸå› æœªçŸ¥ï¼ï¼ï¼ äºŒã€virtualenv 2.1virtualenvç®€ä»‹ pythonçš„ç¬¬ä¸‰æ–¹åŒ…å¾ˆå¤š,åœ¨ä¸€ä¸ªpythonç¯å¢ƒä¸‹å¼€å‘æ—¶é—´è¶Šä¹…,å®‰è£…ä¾èµ–è¶Šå¤š,å°±è¶Šå®¹æ˜“å‡ºç°ä¾èµ–åŒ…å†²çªé—®é¢˜,ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜,virtualenvè¢«å¼€å‘å‡ºæ¥,å®ƒå¯ä»¥æ­å»ºè™šæ‹Ÿä¸”ç‹¬ç«‹çš„pythonç¯å¢ƒ,è¿™æ ·å°±å¯ä»¥ä½¿æ¯ä¸ªé¡¹ç›®ç¯å¢ƒä¸å…¶ä»–é¡¹ç›®ç‹¬ç«‹å¼€æ¥,ä¿æŒç¯å¢ƒçš„å¹²å‡€,é¿å…åŒ…å†²çªé—®é¢˜,å¦å¤–,åœ¨å¼€å‘pythonåº”ç”¨ç¨‹åºçš„æ—¶å€™,æ‰€æœ‰ç¬¬ä¸‰æ–¹çš„åŒ…éƒ½ä¼šè¢«pipå®‰è£…åˆ°ç³»ç»Ÿpythonç‰ˆæœ¬çš„site-packagesç›®å½•ä¸‹,å¦‚æœè¦å¼€å‘å¤šä¸ªåº”ç”¨ç¨‹åº,é‚£ä¹ˆè¿™äº›ç¨‹åºä¼šå…±ç”¨ä¸€ä¸ªpython,è¿™æ„å‘³ç€æ‰€æœ‰çš„åŒ…éƒ½å®‰è£…åœ¨ç³»ç»Ÿçš„pythonç›®å½•ä¸‹,è¿™ä¸ä»…å½±å“æ­£å¸¸å¼€å‘å·¥ä½œ,è¿˜æœ‰å¯èƒ½å› ä¸ºéšæ„å˜æ›´ç³»ç»Ÿpythonç‰ˆæœ¬ä¿¡æ¯è€Œé€ æˆç³»ç»Ÿä¸ç¨³å®š,è¿™ç§æƒ…å†µä¸‹,æ¯ä¸ªåº”ç”¨å¯èƒ½éœ€è¦å„è‡ªæ‹¥æœ‰ä¸€å¥—ç‹¬ç«‹çš„pythonè¿è¡Œç¯å¢ƒ,virtualenvå°±æ˜¯ç”¨æ¥ä¸ºä¸€ä¸ªåº”ç”¨åˆ›å»ºä¸€å¥—éš”ç¦»çš„pythonè¿è¡Œç¯å¢ƒçš„,virtualenvæ˜¯åº•å±‚åŸºäºpythonå¼€å‘çš„pythonç¯å¢ƒéš”ç¦»å·¥å…·,å…¶é€šè¿‡è™šæ‹Ÿç›®å½•çš„æ–¹å¼æ¥å®ç°å¤šç¯å¢ƒçš„å¹¶å­˜ 2.2virtualenvåŸç† åœ¨ç³»ç»Ÿä¸­åˆ›å»ºå·¥ä½œç›®å½•,è¯¥ç›®å½•ç±»ä¼¼å®‰è£…ç³»ç»Ÿçš„pythonç›®å½•,ä¿ç•™å®Œæ•´çš„pythonç¯å¢ƒ,è§£é‡Šå™¨,æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“ç­‰,å½“éœ€è¦æ—¶,åˆ‡æ¢ç¯å¢ƒå˜é‡æ¿€æ´»å³å¯ä½¿ç”¨ 2.3å®‰è£…virtualenv //å®‰è£…python-pipå’Œpython-develç¨‹åºåŒ… [root@test1 ~]# yum -y install python-pip python-devel //å®‰è£…virtualenv [root@test1 ~]# pip install virtualenv 2.4é€šè¿‡virtualenvç®¡ç†å¤špythonç‰ˆæœ¬ virtualenvä¸æ˜¯é€šè¿‡å¤šç‰ˆæœ¬ç®¡ç†çš„æ–¹å¼æ¥å®ç°ç³»ç»ŸåŒæ—¶å…¼å®¹å¤špythonç¯å¢ƒçš„,è€Œæ˜¯é€šè¿‡å…¶åœ¨å·¥ä½œç›®å½•ä¸­è™šæ‹Ÿå®Œæ•´çš„pythonç¯å¢ƒæ¥å®ç°pythonå¤šç¯å¢ƒå¹¶å­˜ 2.4.1virtualenvå‘½ä»¤ç”¨æ³•è¯´æ˜ virtualenvå‘½ä»¤è¯­æ³• virtualenv [options] dest_dir options --version #æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬å· -h,--help #æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ -v,--verbose #æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ -q,--quiet #ä¸ç°å®è¯¦ç»†ä¿¡æ¯ -p PYTHON_EXE,--python=PYTHON_EXE #æŒ‡å®šæ‰€ç”¨çš„pythonè§£æå™¨çš„ç‰ˆæœ¬,æ¯”å¦‚ --python=python2.5å°±æ˜¯ä½¿ç”¨python2.5ç‰ˆæœ¬çš„è§£æå™¨åˆ›å»ºæ–°çš„éš”ç¦»ç¯å¢ƒ,é»˜è®¤ä½¿ç”¨çš„æ—¶å½“å‰ç³»ç»Ÿå®‰è£…çš„pythonè§£æå™¨(/usr/bin/python) --clear #æ¸…ç©ºérootç”¨æˆ·çš„å®‰è£…,å¹¶ä»å¤´å¼€å§‹åˆ›å»ºéš”ç¦»ç¯å¢ƒ --no-site-packages #ä»¤éš”ç¦»ç¯å¢ƒä¸èƒ½è®¿é—®ç³»ç»Ÿå…¨å±€çš„site-packagesç›®å½• --system-site-packages #ä»¤éš”ç¦»ç¯å¢ƒå¯ä»¥è®¿é—®ç³»ç»Ÿå…¨å±€çš„site-packagesç›®å½• --unzip-setuptools #å®‰è£…æ—¶è§£å‹setuptoolsæˆ–distribute --relocatable #é‡å®šä½æŸä¸ªå·²å­˜åœ¨çš„éš”ç¦»ç¯å¢ƒ,ä½¿ç”¨è¯¥é€‰é¡¹å°†ä¿®æ­£è„šæœ¬,å¹¶ä»¤æ‰€æœ‰ .pthæ–‡ä»¶ä½¿ç”¨ç›¸åº”è·¯å¾„ --distribute #ä½¿ç”¨distributeä»£æ›¿setuptools,ä¹Ÿå¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ VIRTUALENV_DISTRIBUTEè¾¾åˆ°åŒæ ·æ•ˆæœ --extra-search-dir=SEARCH_DIRS #ç”¨äºæŸ¥æ‰¾setuptools/distribute/pipå‘å¸ƒåŒ…çš„ç›®å½•,å¯ä»¥æ·»åŠ ä»»æ„æ•°é‡çš„ -extra-search-dirè·¯å¾„ --never-dowload #ç¦æ­¢ä»ç½‘ä¸Šä¸‹è½½ä»»ä½•æ•°æ®,æ­¤æ—¶,å¦‚æœåœ¨æœ¬åœ°æœç´¢å‘å¸ƒåŒ…å¤±è´¥,virtualenvå°±ä¼šæŠ¥é”™ --prompt==PROMPT #å®šä¹‰éš”ç¦»ç¯å¢ƒçš„å‘½ä»¤è¡Œå‰ç¼€ 2.4.2virtualenvåˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒç¤ºä¾‹ âš ï¸è¿™é‡Œæå‰å·²ç»å®‰è£…å¥½python3.6 1.åˆ›å»ºpythonè™šæ‹Ÿå·¥ä½œç›®å½•ï¼Œè¿™é‡ŒæŒ‡å®šä½¿ç”¨python3 [root@test1 ~]# virtualenv -p /usr/local/python36/bin/python3 /opt/venv1 2.åŠ è½½è™šæ‹Ÿç¯å¢ƒ [root@test2 ~]# source /opt/venv1/bin/activate (venv1) [root@test1 ~]# python Python 3.6.9 (default, Feb 18 2020, 19:47:30) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information. >>> 3.æŸ¥çœ‹å½“å‰pythonç¯å¢ƒå®‰è£…çš„åŒ… (venv1) [root@test1 ~]# pip3 list Package Version ---------- ------- pip 20.0.2 setuptools 45.2.0 wheel 0.34.2 4.é€€å‡ºè™šæ‹Ÿç¯å¢ƒ (venv1) [root@test ~]# deactivate [root@test2 ~]# ä¸‰ã€virtualenvwrapper 3.1virtualenvwrapperç®€ä»‹ é‰´äºvirtualenvä¸ä¾¿äºå¯¹è™šæ‹Ÿç¯å¢ƒé›†ä¸­ç®¡ç†,æ‰€ä»¥æ¨èç›´æ¥ä½¿ç”¨virtualenvwrapper,virtualenvwrapperæä¾›äº†ä¸€ç³»åˆ—å‘½ä»¤ä½¿å¾—å’Œè™šæ‹Ÿç¯å¢ƒå·¥ä½œå˜å¾—ä¾¿åˆ©,å®ƒæŠŠä½ æ‰€æœ‰çš„è™šæ‹Ÿç¯å¢ƒéƒ½æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹ virtualenvwrapperæ•´ä½“å·¥ä½œè¿‡ç¨‹ 1.å®‰è£…virtualenvwrapper 2.åœ¨~/.bashrcæ–‡ä»¶ä¸­æŒ‡å®švirtualenvwrapperå­˜æ”¾è™šæ‹Ÿç¯å¢ƒæ€»ç›®å½•,æŒ‡å®švirtualenvwrapper.shå­˜æ”¾ä½ç½®(findæŸ¥æ‰¾) 3.mkvirtualenvå‘½ä»¤åˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒ,-pé€‰é¡¹æŒ‡å®šä¸åŒpythonç‰ˆæœ¬å‘½ä»¤è·¯å¾„ 4. workonå‘½ä»¤åˆ‡æ¢ä¸åŒpythonè™šæ‹Ÿç¯å¢ƒ 3.2virtualenvwrapperé…ç½®è¿‡ç¨‹ 3.2.1å®‰è£…virtualenvwrapper(ç¡®ä¿virtualenvå·²å®‰è£…) [root@test1 ~]# pip install virtualenvwrapper 3.2.2ç¼–è¾‘ç¯å¢ƒå˜é‡ //å‘~/.bashrcä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ [root@test1 ~]# echo \"export WORKON_HOME=/opt/virtualenvwrapper\" >> ~/.bashrc ;echo \"source /usr/bin/virtualenvwrapper.sh\" >> ~/.bashrc 1 export WORKON_HOME=/opt/virtualenvwrapper 2 source /usr/bin/virtualenvwrapper.sh 1ï¼švirtualenvwrapperå­˜æ”¾è™šæ‹Ÿç¯å¢ƒç›®å½•,è¿™é‡Œè‡ªå®šä¹‰åœ¨/opt/virtualenvwrapper 2ï¼švirtrualenvwrapperä¼šå®‰è£…åˆ°pythonçš„binç›®å½•ä¸‹ï¼Œæ‰€ä»¥è¯¥è·¯å¾„æ˜¯pythonå®‰è£…ç›®å½•ä¸‹bin/virtualenvwrapper.sh,æœ¬æ–‡pythonå®‰è£…åœ¨äº†/usr/local/ //ä½¿é…ç½®ç”Ÿæ•ˆ [root@test1 ~]# source ~/.bashrc 3.2.3åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ mkvirtualenv //å› ä¸ºåœ¨3.2.2ä¸­æŒ‡å®šäº†WORKON_HOME=/opt/virtualenvwrapperï¼Œæ‰€ä»¥åˆ›å»ºçš„pythonè™šæ‹Ÿç¯å¢ƒéƒ½ä¼šåœ¨è¿™ä¸ªç›®å½•ä¸‹ root@test1 ~]# mkvirtualenv -p /usr/local/python36/bin/python3 venv1 created virtual environment in 200ms CPython3Posix(dest=/opt/virtualenvwrapper/venv1, clear=False, global=False) with seeder FromAppData pip=latest setuptools=latest wheel=latest app_data_dir=/root/.local/share/virtualenv/seed-v1 via=copy virtualenvwrapper.user_scripts creating /opt/virtualenvwrapper/venv1/bin/predeactivate virtualenvwrapper.user_scripts creating /opt/virtualenvwrapper/venv1/bin/postdeactivate virtualenvwrapper.user_scripts creating /opt/virtualenvwrapper/venv1/bin/preactivate virtualenvwrapper.user_scripts creating /opt/virtualenvwrapper/venv1/bin/postactivate virtualenvwrapper.user_scripts creating /opt/virtualenvwrapper/venv1/bin/get_env_details (venv1) [root@test1 ~]# //æŸ¥çœ‹åˆ›å»ºçš„è™šæ‹Ÿç¯å¢ƒï¼Œvenv1å°±æ˜¯åˆšåˆšåˆ›å»ºçš„è™šæ‹Ÿç¯å¢ƒ [root@test2 ~]# ls /opt/virtualenvwrapper/ get_env_details postmkproject predeactivate venv1 initialize postmkvirtualenv premkproject postactivate postrmvirtualenv premkvirtualenv postdeactivate preactivate prermvirtualenv 3.2.4åˆ‡æ¢è™šæ‹Ÿç¯å¢ƒ //å…ˆåˆ›å»ºä¸¤ä¸ªè™šæ‹Ÿç¯å¢ƒï¼Œå¹¶æŒ‡å®špythonç‰ˆæœ¬ [root@test1 ~]# mkvirtualenv -p /usr/bin/python py2 [root@test1 ~]# mkvirtualenv -p /usr/local/python36/bin/python3 py3 //åˆ‡æ¢è™šæ‹Ÿç¯å¢ƒ [root@test1 ~]# workon py2 (py2) [root@test1 ~]# python -V Python 2.7.5 [root@test1 ~]# workon py3 (py3) [root@test1 ~]# python -V Python 3.6.9 3.2.5å…¶ä»–æ“ä½œ //æŸ¥çœ‹å½“å‰çš„è™šæ‹Ÿç¯å¢ƒç›®å½•ï¼Œå³é€šè¿‡mkvirtualenvå‘½ä»¤åˆ›å»ºçš„venvè™šæ‹Ÿç¯å¢ƒ [root@test1 ~]# workon py2 py3 //é€€å‡ºè™šæ‹Ÿç¯å¢ƒ (py3) [root@test1 ~]# deactivate [root@test1 ~]# //åˆ é™¤è™šæ‹Ÿç¯å¢ƒ [root@test1 ~]# rmvirtualenv py2 Removing py2... æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"python/pythonå®‰è£…/centos7.6ç¼–è¯‘å®‰è£…python3.6.9.html":{"url":"python/pythonå®‰è£…/centos7.6ç¼–è¯‘å®‰è£…python3.6.9.html","title":"centos7.6ç¼–è¯‘å®‰è£…python3.6","keywords":"","body":"centos7.6ç¼–è¯‘å®‰è£…python3.6.9 pythonå„ç‰ˆæœ¬ä¸‹è½½åœ°å€ 1.å®‰è£…ä¾èµ–åŒ… yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel libffi-devel gcc gcc-c++ make 2.ä¸‹è½½pythonåŒ… wget https://www.python.org/ftp/python/3.6.9/Python-3.6.9.tar.xz 3.è§£å‹ç¼©åŒ…å¹¶ç¼–è¯‘å®‰è£… tar xf Python-3.6.9.tar.xz && cd Python-3.6.9 ./configure --prefix=/usr/local/python36 --with-ssl make && make install 4.å¯¼å‡ºpythonå‘½ä»¤ç¯å¢ƒå˜é‡ echo 'PATH=/usr/local/python36/bin:$PATH' >/etc/profile.d/python36.sh && source /etc/profile âš ï¸å¦‚æœæŠŠpythonç¯å¢ƒå˜é‡å†™åœ¨/etc/profile.d/*.shï¼Œåœ¨ä½¿ç”¨pip3å®‰è£…çš„æ—¶å€™å¯èƒ½ä¼šæŠ¥é”™Caused by SSLError(\"Can't connect to HTTPS URL because the SSL module is not available.\",ï¼‰ï¼Œä½†æ˜¯å¯¼å…¥åˆ°/etc/profileä¸­å°±æ²¡æœ‰é—®é¢˜ï¼Œä¸çŸ¥é“æ€ä¹ˆè§£å†³ï¼Œå¹¶ä¸”ç»å¯¹ä¸æ˜¯ç½‘ä¸Šè¯´çš„opensslé—®é¢˜ 5.é…ç½®pipå›½å†…æº mkdir ~/.pip cat >~/.pip/pip.conf pipæ›´æ–° pip install --upgrade pip æˆ–è€… python -m pip install --upgrade pip æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"web/html/1.html5åŸºç¡€çŸ¥è¯†.html":{"url":"web/html/1.html5åŸºç¡€çŸ¥è¯†.html","title":"html5åŸºç¡€çŸ¥è¯†","keywords":"","body":"å‰ç«¯åŸºç¡€ 1.åŸºç¡€ç»“æ„ æ³¡æ³¡åè‚¥çš‚o ä¸€çº§æ ‡é¢˜ æ™®é€šæ–‡å­— 1.1 æ ‡ç­¾å†™æ³•åˆ†ç±» å…¨å°é—­æ ‡ç­¾ xxx æ ‡ç­¾å±æ€§ xxx xx:å±æ€§å ss:å±æ€§å€¼ è‡ªå°é—­æ ‡ç­¾ 1.2 æ ‡ç­¾åˆ†ç±» å—æ ‡ç­¾(è¡Œå¤–æ ‡ç­¾):ç‹¬å ä¸€è¡Œæ˜¾ç¤º - **h1-h6(æ ‡é¢˜æ ‡ç­¾)** - **p(æ®µè½æ ‡ç­¾)** - **br(æ¢è¡Œæ ‡ç­¾)** - **hr(æ¨ªçº¿æ ‡ç­¾)** - **div(æ™®é€šæ–‡æœ¬æ ‡ç­¾)** - **ul(æ— åºåˆ—è¡¨)** - **ol(æœ‰åºåˆ—è¡¨)** - **li(åˆ—è¡¨ä¸­ç”¨åˆ°çš„æ ‡ç­¾ï¼Œåˆ—è¡¨ä¸­çš„è¡Œ)** å†…è”æ ‡ç­¾(è¡Œå†…æ ‡ç­¾):ä¸ç‹¬å ä¸€è¡Œæ˜¾ç¤ºï¼Œå†…è”æ ‡ç­¾åªèƒ½åŒ…å«å†…è”æ ‡ç­¾ï¼Œä¸èƒ½åŒ…å«å—çº§æ ‡ç­¾ img(å›¾ç‰‡æ ‡ç­¾) a(è¶…é“¾æ¥æ ‡ç­¾) span(æ™®é€šæ–‡æœ¬æ ‡ç­¾) 2.headæ ‡ç­¾ 2.1 metaæ ‡ç­¾ 2.2.1 meta æ–‡æ¡£å­—ç¬¦ç¼–ç  æˆ‘çš„ç½‘é¡µ ä¸€çº§æ ‡é¢˜ 2.2.2 meta é¡µé¢åˆ·æ–° ä¸–ä¸Šæœ€ç‰›é€¼çš„é¡µé¢æ ‡é¢˜ metaé¡µé¢åˆ·æ–°æµ‹è¯• è¿è¡Œä»¥ä¸Šä»£ç ï¼Œæµè§ˆå™¨ä¸­å°±ä¼šæ¯éš”2ç§’åˆ·æ–°ä¸€æ¬¡ 2.2.3 meta å…³é”®å­— metaæ ‡ç­¾å¯ä»¥è®¾ç½®å…³é”®å­—ï¼Œç”¨äºæœç´¢å¼•æ“æ”¶å½•å’Œå…³é”®å­—æœç´¢ã€‚ ä¸–ä¸Šæœ€ç‰›é€¼çš„é¡µé¢æ ‡é¢˜ ç»™æœç´¢å¼•æ“äº¤é’±å°±ä¼šä¼˜å…ˆæ˜¾ç¤ºä¸Šè¿°å…³é”®å­— ä¾‹å¦‚ï¼Œåœ¨ç™¾åº¦æœç´¢çš„htmlé¡µé¢ä¸­æœ‰ä¸Šè¿°ä»£ç ä¸­contentä¸­çš„å…³é”®å­—ï¼Œæœç´¢æ¡†ä¸­è¾“å…¥å…³é”®å­—å°±ä¼šæœ‰è¿”å›ç»“æœï¼Œç»™æœç´¢å¼•æ“äº¤çš„é’±è¶Šå¤šï¼Œä¼˜å…ˆçº§è¶Šå¤§ï¼Œæ’åœ¨å‰é¢çš„æ¦‚ç‡ä¹Ÿå°±è¶Šå¤§ 2.2.4 meta ç½‘ç«™æè¿° metaæ ‡ç­¾å¯ä»¥è®¾ç½®ç½‘ç«™æè¿°ä¿¡æ¯ï¼Œç”¨äºåœ¨æœç´¢å¼•æ“æœç´¢æ—¶ï¼Œæ˜¾ç¤ºç½‘ç«™åŸºæœ¬æè¿°ä¿¡æ¯ã€‚ å¤§ä¿å¥ä¼šæ‰€ æœç´¢å¼•æ“æœç´¢åˆ° 2.2.5 meta è§¦å±ç¼©æ”¾ metaæ ‡ç­¾å¯ä»¥è®¾ç½®é¡µé¢æ˜¯å¦æ”¯æŒè§¦å±ç¼©æ”¾åŠŸèƒ½ï¼Œå…¶ä¸­å„å…ƒç´ çš„å«ä¹‰å¦‚ä¸‹ï¼š width=device-width ï¼Œè¡¨ç¤ºå®½åº¦æŒ‰ç…§è®¾å¤‡å±å¹•çš„å®½åº¦ã€‚ initial-scale=1.0ï¼Œåˆå§‹æ˜¾ç¤ºç¼©æ”¾æ¯”ä¾‹ã€‚ minimum-scale=0.5ï¼Œæœ€å°ç¼©æ”¾æ¯”ä¾‹ã€‚ maximum-scale=1.0ï¼Œæœ€å¤§ç¼©æ”¾æ¯”ä¾‹ã€‚ user-scalable=yesï¼Œæ˜¯å¦æ”¯æŒå¯ç¼©æ”¾æ¯”ä¾‹ï¼ˆè§¦å±ç¼©æ”¾ï¼‰ æ ‡é¢˜ --> å“ˆå“ˆå“ˆ 2.2 linkæ ‡ç­¾ éš”å£è€ç‹ éš”å£ç‹è€æ±‰çš„å¹¸ç¦ç”Ÿæ´» éš”å£è€ç‹ éš”å£ç‹è€æ±‰çš„å¹¸ç¦ç”Ÿæ´» 3.bodyæ ‡ç­¾ 3.1 h1-h6 æ ‡é¢˜æ ‡ç­¾ ä¸€çº§æ ‡é¢˜ äºŒçº§æ ‡é¢˜ ä¸‰çº§æ ‡é¢˜ å››çº§æ ‡é¢˜ äº”çº§æ ‡é¢˜ å…­çº§æ ‡é¢˜ éš”å£è€ç‹ ä¸€çº§æ ‡é¢˜ äºŒçº§æ ‡é¢˜ ä¸‰çº§æ ‡é¢˜ å››çº§æ ‡é¢˜ äº”çº§æ ‡é¢˜ å…­çº§æ ‡é¢˜ 3.2 br æ¢è¡Œæ ‡ç­¾ éš”å£è€ç‹ ä¸€çº§æ ‡é¢˜ 3.3 hr ä¸€è¡Œæ¨ªçº¿æ ‡ç­¾ éš”å£è€ç‹ ä¸€çº§æ ‡é¢˜ ä¸€çº§æ ‡é¢˜ 3.3 a è¶…é“¾æ¥æ ‡ç­¾ 3.3.1 ä¸åŠ hrefå±æ€§ï¼Œå°±æ˜¯æ™®é€šæ–‡æœ¬æ˜¾ç¤º pythonä»å…¥é—¨åˆ°æ”¾å¼ƒ éš”å£è€ç‹ ä¸€çº§æ ‡é¢˜ pythonä»å…¥é—¨åˆ°æ”¾å¼ƒ 3.3.2 é›†ä¸Šhrefå±æ€§ï¼Œä¸åŠ å€¼ï¼Œæ–‡å­—æœ‰é¢œè‰²æ•ˆæœï¼Œè¿˜æœ‰ä¸‹åˆ’çº¿ï¼Œå¹¶ä¸”ç‚¹å‡»åä¼šåˆ·æ–°å½“å‰çš„htmlé¡µé¢ pythonä»å…¥é—¨åˆ°æ”¾å¼ƒ éš”å£è€ç‹ ä¸€çº§æ ‡é¢˜ pythonä»å…¥é—¨åˆ°æ”¾å¼ƒ 3.3.3 åŠ ä¸Šhrefå±æ€§ï¼Œå¹¶ä¸”åŠ ä¸Šå€¼ï¼Œç‚¹å‡»åä¼šè·³è½¬è‡³å¯¹åº”çš„ç½‘å€ pythonçŸ­ç‰‡ éš”å£è€ç‹ ä¸€çº§æ ‡é¢˜ pythonä»å…¥é—¨åˆ°æ”¾å¼ƒ 3.3.4 é”šç‚¹ åœ¨é¡µé¢å†…å®¹è¿›è¡Œè·³è½¬ æè¿°:æ ‡ç­¾è®¾ç½®idå±æ€§=å€¼(xx) aæ ‡ç­¾hrefå±æ€§çš„å€¼å†™æ³•:href='#xx',ç‚¹å‡»è¿™ä¸ªaæ ‡ç­¾å°±èƒ½è·³è½¬åˆ°idå±æ€§ä¸ºxxçš„é‚£ä¸ªæ ‡ç­¾æ‰€åœ¨ä½ç½®. Title è¿™æ˜¯é¡¶éƒ¨ ç¬¬ä¸€ç«  å¼€å±€(é“¾æ¥) ç¬¬äºŒç«  æ¡äº†ä¸€åªç‹—(é“¾æ¥) ç¬¬ä¸‰ç«  ç»™ç‹—æ´—æ¾¡(é“¾æ¥) ç¬¬å››ç«  äºŒæ‰‹æ´—æ¾¡æ¶²æœ‰æ¯’(é“¾æ¥) ç¬¬äº”ç«  å¤§ç»“å±€(é“¾æ¥) ç¬¬ä¸€ç«  å¼€å±€ æ²¡å¹²å•¥å¥½äº‹å„¿!! æ²¡å¹²å•¥å¥½äº‹å„¿!! æ²¡å¹²å•¥å¥½äº‹å„¿!! ç¬¬äºŒç«  æ¡äº†ä¸€åªç‹— è‰ä¸›æœ‰åŠ¨é™!! èµ°è¿‡å»çœ‹çœ‹!! å§æ§½ï¼Œæ˜¯ä¸€æ¡ç‹—!! æŠŠç‹—æ¡èµ°!! ç¬¬ä¸‰ç«  ç»™ç‹—æ´—æ¾¡ ç‹—æœ‰ç‚¹è„!!! éœ€è¦ç»™ç‹—æ´—æ¾¡!!! ä¹°äº†ä¸€ç“¶äºŒæ‰‹æ´—æ¾¡æ¶²!!! å¼€å§‹ç»™ç‹—æ´—æ¾¡!!! æ´—å®Œäº†!!! ç¬¬å››ç«  äºŒæ‰‹æ´—æ¾¡æ¶²æœ‰æ¯’ ç»™ç‹—æ´—å®Œæ¾¡äº†!!! ä½†æ˜¯èº«ä½“æœ‰ç‚¹ä¸é€‚!!! é€æ¸å¼€å§‹éº»æœ¨!!! ç³Ÿç³•ï¼Œæ´—æ¾¡æ¶²æœ‰æ¯’!!! æƒ…å†µä¸ä¹è§‚!!! å§æ§½ï¼Œåæ‚”ä¹°äºŒæ‰‹çš„äº†!!! ä¸‹æ¬¡å†ä¹Ÿä¸ä¹°äºŒæ‰‹çš„äº†!!! ç¬¬äº”ç«  å¤§ç»“å±€ ä¸­æ¯’èº«äº¡!!! ä¸­æ¯’èº«äº¡!!! ä¸­æ¯’èº«äº¡!!! ä¸­æ¯’èº«äº¡!!! è¿”å›é¡¶éƒ¨ 3.4 img å›¾ç‰‡æ ‡ç­¾ å‚æ•°è¯´æ˜ srcå±æ€§:å›¾ç‰‡è·¯å¾„ å¿…é¡»å†™ altå±æ€§:å›¾ç‰‡åŠ è½½å¤±è´¥æˆ–è€…æ­£åœ¨åŠ è½½æ—¶æç¤ºçš„å†…å®¹ titleå±æ€§:é¼ æ ‡æ‚¬æµ®æ—¶æ˜¾ç¤ºçš„å†…å®¹ ä¸å¸¸ç”¨,é€šè¿‡cssæ¥æ§åˆ¶ width:è®¾ç½®å®½åº¦ height:è®¾ç½®é«˜åº¦ è®¾ç½®å›¾ç‰‡å¤§å° Title ä¸€çº§æ ‡é¢˜ imgä¸­width(è®¾ç½®å®½åº¦ï¼Œå•ä½:åƒç´ )ï¼Œheight(è®¾ç½®é«˜åº¦ï¼Œå•ä½:åƒç´ )è®¾ç½®å›¾ç‰‡å¤§å° è®¾ç½®é¼ æ ‡æ‚¬æµ®æ—¶å›¾ç‰‡æ˜¾ç¤ºçš„å†…å®¹ Title ä¸€çº§æ ‡é¢˜ 3.5 divå’Œspan æ™®é€šæ–‡æœ¬æ ‡ç­¾ divå’Œspané»˜è®¤æ˜¯æ²¡æœ‰ä»»ä½•ä¿®é¥°çš„æ–‡æœ¬æ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæ ·å¼ï¼Œä½†æ˜¯ä¸€èˆ¬åœ¨cssä¸­æŒ‡å®š divé»˜è®¤æ˜¯æ™®é€šæ–‡æœ¬ Title divé»˜è®¤æ˜¯æ™®é€šæ–‡æœ¬ divä¹Ÿå¯ä»¥æŒ‡å®šæ–‡æœ¬é¢œè‰²ï¼Œä¸€èˆ¬å†™åœ¨cssä¸­ Title divä¹Ÿå¯ä»¥æŒ‡å®šæ–‡æœ¬é¢œè‰²ï¼Œä¸€èˆ¬å†™åœ¨cssä¸­ spané»˜è®¤æ˜¯æ™®é€šæ–‡æœ¬ Title spané»˜è®¤æ˜¯æ™®é€šæ–‡æœ¬ spanä¹Ÿå¯ä»¥æŒ‡å®šæ–‡æœ¬é¢œè‰²ï¼Œä¸€èˆ¬å†™åœ¨cssä¸­ Title spanä¹Ÿå¯ä»¥æŒ‡å®šæ–‡æœ¬é¢œè‰²ï¼Œä¸€èˆ¬å†™åœ¨cssä¸­ 3.6 åˆ—è¡¨æ ‡ç­¾ 3.6.1 ul æ— åºæ ‡ç­¾ Title ç¯®çƒ è¶³çƒ æ’çƒ 3.6.2 ol æœ‰åºæ ‡ç­¾ Title ç¯®çƒ è¶³çƒ æ’çƒ 3.6.3 dl æè¿°åˆ—è¡¨æ ‡ç­¾ Title æ²³åŒ—çœ é‚¯éƒ¸ çŸ³å®¶åº„ å±±è¥¿çœ å¤ªåŸ è¿åŸ 3.7 table è¡¨æ ¼æ ‡ç­¾ å‚æ•°è¯´æ˜ id name hobby 1 å°æ˜ çœ‹ç”µå½± 2 å°æ´² æ‰“ç¯®çƒ æ²¡æœ‰è¾¹æ¡†çš„è¡¨æ ¼ Title id name hobby 1 å°æ˜ çœ‹ç”µå½± 2 å°æ´² æ‰“ç¯®çƒ 3 å°é¢– é€›è¡— åŠ ä¸Šè¾¹æ¡†çš„è¡¨æ ¼ Title id name hobby 1 å°æ˜ çœ‹ç”µå½± 2 å°æ´² æ‰“ç¯®çƒ 3 å°é¢– é€›è¡— è¡¨æ ¼åˆå¹¶(rowspan=\"2\") æè¡Œåˆå¹¶ Title id name hobby 1 å°æ˜ çœ‹ç”µå½± 2 å°æ´² 3 å°é¢– é€›è¡— è¡¨æ ¼åˆå¹¶(colspan=\"2\") æ¨ªåˆ—åˆå¹¶ Title id name hobby 1 å°æ˜ çœ‹ç”µå½± 2 å°æ´² æ‰“ç¯®çƒ 3 å°é¢– 3.8 input è¾“å…¥æ¡†æ ‡ç­¾ 3.8.1 ç”¨æˆ·åã€å¯†ç ã€ç™»é™†ã€é‡ç½®ã€æ³¨å†Œ Title ç”¨æˆ·åï¼š å¯†ç ï¼š 3.8.2 æ—¶é—´æ—¥æœŸè¾“å…¥æ¡† Title 3.8.3 æ–‡ä»¶é€‰æ‹©æ¡† Title 3.8.4 çº¯æ•°å­—è¾“å…¥æ¡† Title 3.9 select ä¸‹æ‹‰æ¡†æ ‡ç­¾ 3.9.1 å•é€‰ Title åŒ—äº¬ ä¸Šæµ· å¹¿å· æ·±åœ³ 3.9.2 å¤šé€‰ Title åŒ—äº¬ ä¸Šæµ· å¹¿å· æ·±åœ³ æ­å· é’å²› å“ˆå°”æ»¨ æˆéƒ½ 3.10 textarea å¤šè¡Œæ–‡æœ¬è¾“å…¥æ¡†æ ‡ç­¾ Title 3.11 form è¡¨å•æ ‡ç­¾ åœ¨ç½‘ç«™å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ç”¨æˆ·äº¤äº’ç›¸å…³çš„æ ‡ç­¾è®©ç”¨æˆ·è¾“å…¥å†…å®¹ï¼Œä½†å¦‚æœæƒ³è¦å†æµè§ˆå™¨ä¸ŠæŠŠè¾“å…¥çš„å†…å®¹æäº¤åˆ°åå°ï¼Œåˆ™éœ€è¦ è¡¨å• å’Œ æäº¤æŒ‰é’® ã€‚ formæ ‡ç­¾å†…ç½®å±æ€§ action=\"/xx/\" ï¼Œè¡¨ç¤ºè¡¨å•è¦æäº¤çš„åœ°å€ method=\"get\"ï¼Œè¡¨ç¤ºè¡¨å•çš„æäº¤æ–¹å¼ï¼ˆgetæˆ–postï¼‰ enctype=\"multipart/form-data\"ï¼Œå¦‚æœformå†…éƒ¨æœ‰æ–‡ä»¶ä¸Šä¼ ï¼Œå¿…é¡»åŠ ä¸Šæ­¤è®¾ç½® #actionå±æ€§: æŒ‡å®šæäº¤è·¯å¾„,æäº¤åˆ°å“ªé‡Œå» #formè¡¨å•æ ‡ç­¾ä¼šå°†åµŒå¥—åœ¨formæ ‡ç­¾é‡Œé¢çš„è¾“å…¥æ¡†çš„æ•°æ®å…¨éƒ¨æäº¤åˆ°æŒ‡å®šè·¯å¾„ formå†…éƒ¨ã€ç”¨æˆ·äº¤äº’ã€‘ç›¸å…³æ ‡ç­¾å¿…é¡»è®¾ç½®nameï¼Œä¸ç„¶æäº¤æ•°æ®ååç«¯æ— æ³•è·å–ï¼Œä¾‹å¦‚ä¸‹æ–¹çš„æ¨¡æ‹Ÿç™»é™†ç•Œé¢ä¸­ç”¨æˆ·ååçš„inputæ ‡ç­¾ä¸­æŒ‡å®šnameå±æ€§ // æäº¤è¡¨å•ä¹‹åï¼Œå®é™…ä¸Šä¼šå°†è¡¨å•ä¸­çš„æ•°æ®æ„é€ æˆä¸€ç§ç‰¹æ®Šçš„ç»“æ„ï¼Œå‘é€ç»™åå°ï¼Œç±»ä¼¼äºï¼š { user:ç”¨æˆ·è¾“å…¥çš„å§“å, pwd:ç”¨æˆ·è¾“å…¥çš„å¯†ç , ... } ç®€å•ç¼–è¾‘ä¸€ä¸ªæ¨¡æ‹Ÿç™»é™†çš„ç•Œé¢ Title ç”¨æˆ·åï¼š å¯†ç ï¼š è¿è¡Œä¸Šè¿°ä»£ç æ•ˆæœå¦‚ä¸‹ æ¥ä¸‹æ¥ç¼–å†™ä¸€ä¸ªç®€å•çš„tcpæœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ç»‘å®šæœ¬æœº8080ç«¯å£ from socket import * tcp_server = socket() tcp_server.bind(('127.0.0.1',8080)) tcp_server.listen() while True: conn, client_addr = tcp_server.accept() from_client_msg = conn.recv(1024) print(from_client_msg.decode('utf-8')) conn.send(b'HTTP/1.1 200 ok\\r\\n\\r\\n') # conn.send(b'lai le laodi!') with open('send.html', 'rb') as f: data = f.read() conn.send(data) conn.close() tcp_server.close() tcpæœåŠ¡ç«¯ç”¨åˆ°çš„ç»™å®¢æˆ·ç«¯è¿”å›çš„å†…å®¹send.htmlæ–‡ä»¶å†…å®¹å¦‚ä¸‹ Title æ­å–œç™»é™†æˆåŠŸï¼ï¼ï¼ è¿è¡Œæ¨¡æ‹Ÿç™»é™†ç•Œé¢çš„htmlæ–‡ä»¶ï¼Œéšä¾¿è¾“å…¥ä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åç‚¹å‡»ç™»é™† å› ä¸ºæ¨¡æ‹Ÿç™»é™†ç•Œé¢çš„htmlä»£ç ä¸­æŒ‡å®šäº†è®¿é—®æœ¬åœ°8080ç«¯å£ï¼Œå› æ­¤tcpæœåŠ¡ç«¯ä¼šè¿”å›æŒ‡å®šçš„send.htmlæ–‡ä»¶ä¸­çš„å†…å®¹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"web/css/2.cssåŸºç¡€çŸ¥è¯†.html":{"url":"web/css/2.cssåŸºç¡€çŸ¥è¯†.html","title":"css3åŸºç¡€çŸ¥è¯†","keywords":"","body":"cssåŸºæœ¬çŸ¥è¯† 1.cssæ ·å¼å¼•å…¥æ–¹å¼ ç¬¬ä¸€ç§æ–¹å¼ headæ ‡ç­¾ä¸­å¼•å…¥ åœ¨bodyä¸­å†™çš„æ ‡ç­¾åœ¨headæ ‡ç­¾ä¸‹çš„styleæ ‡ç­¾ä¸­å¼•å…¥æ ·å¼ Title div{ width: 200px; height: 200px; background-color: greenyellow; } æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ ç¬¬äºŒç§æ–¹å¼ å¤–éƒ¨cssæ–‡ä»¶å¼•å…¥(å¸¸ç”¨) /*cssä»£ç */ /*åˆ›å»ºä¸€ä¸ªcssæ–‡ä»¶ï¼Œåœ¨htmlæ–‡ä»¶ä¸­ä½¿ç”¨linkæ ‡ç­¾å¼•å…¥*/ div{ /*cssæ³¨é‡Šå†™æ³•*/ width: 200px; height: 200px; background-color: greenyellow; } Title æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ ç¬¬ä¸‰ç§æ–¹å¼ å†…è”æ ·å¼ï¼Œæ ‡ç­¾ä¸­å†™æ ·å¼ Title æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ 2.cssé€‰æ‹©å™¨ 2.1åŸºæœ¬é€‰æ‹©å™¨ 2.1.1å…ƒç´ é€‰æ‹©å™¨ å…ƒç´ é€‰æ‹©å™¨å†™æ³• æ ‡ç­¾åç§°{ csså±æ€§:å€¼ } div{ width:100px; } htmlä»£ç ç¤ºä¾‹ Title div{ width: 200px; height: 200px; background-color: greenyellow; } æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ 2.1.2idé€‰æ‹©å™¨ Title #d1{ width: 200px; height: 200px; background-color: greenyellow; } æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ 2.1.3ç±»é€‰æ‹©å™¨ Title .c1{ width: 200px; height: 200px; background-color: greenyellow; } æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ 2.2å±æ€§é€‰æ‹©å™¨ æ ¹æ®è‡ªå®šä¹‰å±æ€§æŸ¥æ‰¾ Title [xx]{ width: 200px; height: 200px; background-color: greenyellow; } æˆ‘æ˜¯ç¬¬ä¸€ä¸ªdivæ ‡ç­¾ æˆ‘æ˜¯ç¬¬äºŒä¸ªdivæ ‡ç­¾ æ ¹æ®è‡ªå®šä¹‰å±æ€§å€¼æŸ¥æ‰¾ Title [xx='x1']{ width: 200px; height: 200px; background-color: greenyellow; } æˆ‘æ˜¯ç¬¬ä¸€ä¸ªdivæ ‡ç­¾ æˆ‘æ˜¯ç¬¬äºŒä¸ªdivæ ‡ç­¾ 2.3åä»£é€‰æ‹©å™¨ ä»¥ä¸‹ä»£ç ä¸­ï¼Œåªæœ‰åœ¨divæ ‡ç­¾ä¸‹çš„aæ ‡ç­¾æ‰èƒ½ç”Ÿæ•ˆ(æœ‰é¢œè‰²) Title /*åªæœ‰åœ¨divæ ‡ç­¾ä¸‹çš„aæ ‡ç­¾(å¤šçº§æ ‡ç­¾éƒ½å¯ä»¥)æ‰èƒ½ç”Ÿæ•ˆ*/ div a{ color:orange; /* å­—ä½“é¢œè‰² */ } æˆ‘æ˜¯divæ ‡ç­¾çš„å­™å­ æˆ‘æ˜¯divæ ‡ç­¾çš„å„¿å­ æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ ç™¾åº¦ 2.4ç»„åˆé€‰æ‹©å™¨(é€—å·è¿æ¥) å¿…é¡»æ‰¾åˆ°aæ ‡ç­¾æ‰å¯ä»¥ç”Ÿæ•ˆ Title #d1 a,#d2 a{ color:orange; } æˆ‘æ˜¯div1 æˆ‘æ˜¯div2 æˆ‘æ˜¯div3 ç™¾åº¦ 3.cssæ ·å¼ç›¸å…³ 3.1é«˜åº¦ã€å®½åº¦ div1 span1 div{ height: 200px; width: 100px; background-color: pink; } span{ height: 200px; width: 100px; background-color: green; } Title div{ height: 200px; width: 100px; background-color: pink; } span{ height: 200px; width: 100px; background-color: green; } div1 span1 3.2å­—ä½“ç›¸å…³ Title div{ font-size: 20px; /* é»˜è®¤å­—ä½“å¤§å°æ˜¯16px */ color: olivedrab; font-family: 'å¾®è½¯é›…é»‘'; /* å­—ä½“æ ¼å¼ */ font-weight: 500; /* å­—ä½“ç²—ç»†ï¼Œ100-900ï¼Œé»˜è®¤æ˜¯400 */ } å†™ä½œæ—¥å½“åˆï¼Œ è°çŸ¥å­¦ç”Ÿè‹¦ã€‚ å‡ æœ¬å°ç ´ä¹¦ï¼Œ ä¸€åä¸€ä¸Šåˆã€‚ 3.3å­—ä½“å¯¹é½ Title div{ color: #2a8282; /*!*å³å¯¹é½*!*/ /*text-align: right;*/ /* æ°´å¹³å±…ä¸­*/ /*text-align: center; */ height: 100px; width: 200px; text-align: left; /*å’Œheighté«˜åº¦ç›¸åŒï¼Œæ ‡ç­¾æ–‡æœ¬å‚ç›´å±…ä¸­*/ line-height: 50px; } åªèº«èµ´å®´é¸¡æ¯›è£…ï¼ éƒ½æ˜¯åŒå­¦è£…é¸¡æ¯›ï¼ 3.4é¢œè‰²è®¾ç½® ä¸‰ç§æ–¹å¼: è‹±æ–‡å•è¯:red; åå…­è¿›åˆ¶: #ff746d; rgb: rgb(155, 255, 236); â€‹ å¸¦é€æ˜åº¦çš„: rgba(255, 0, 0,0.3); å•çº¯çš„å°±æ˜¯é¢œè‰²é€æ˜åº¦ â€‹ æ ‡ç­¾é€æ˜åº¦:opacity: 0.3; 0åˆ°1çš„æ•°å­—,è¿™æ˜¯æ•´ä¸ªæ ‡ç­¾çš„é€æ˜åº¦ rgbaæ˜¯å¸¦é€æ˜åº¦çš„ï¼Œç¬¬4ä¸ªæ•°è¶Šå°ï¼Œé€æ˜åº¦è¶Šé«˜ Title div{ color: rgba(255,0,0,0.3); } åªèº«èµ´å®´é¸¡æ¯›è£…ï¼ éƒ½æ˜¯åŒå­¦è£…é¸¡æ¯›ï¼ é€æ˜åº¦ä¸º0.3 opacityï¼Œæ•´ä¸ªæ ‡ç­¾çš„é€æ˜åº¦ Title div{ /*å•çº¯çš„é¢œè‰²é€æ˜åº¦*/ /*color: rgba(255,0,0,0.3);*/ /*æ•´ä¸ªæ ‡ç­¾çš„é€æ˜åº¦ */ opacity: 0.3; } åªèº«èµ´å®´é¸¡æ¯›è£…ï¼ éƒ½æ˜¯åŒå­¦è£…é¸¡æ¯›ï¼ 3.5èƒŒæ™¯ 3.5.1èƒŒæ™¯å›¾ç‰‡ Title .c1{ height: 1000px; width: 800px; background-image: url(\"cjk.jpeg\"); } èƒŒæ™¯å›¾ç‰‡ï¼Œé»˜è®¤ä¼šå¹³é“ºï¼Œå³è®¾ç½®äº†æ ·å¼çš„é«˜åº¦å’Œå®½åº¦ï¼Œå¦‚æœå›¾ç‰‡æ¯”è®¾ç½®çš„å°ï¼Œä¼šç»§ç»­æ˜¾ç¤ºå›¾ç‰‡çš„ä¸€éƒ¨åˆ† åŠ å‚æ•°background-repeat: no-repeat;è®¾ç½®èƒŒæ™¯å›¾ç‰‡ä¸å¹³é“º 3.5.2èƒŒæ™¯å›¾ç‰‡çš„ä½ç½® å…ˆæˆªå–ä¸€ä¸ª200x200åƒç´ çš„å›¾ç‰‡ï¼Œç„¶åèƒŒæ™¯é¢œè‰²ä¸º600x600åƒç´ ï¼Œæ•ˆæœå¦‚ä¸‹ï¼Œå›¾ç‰‡é»˜è®¤çš„ä½ç½®æ˜¯left top center centerç¤ºä¾‹ Title .c1{ height: 600px; width: 600px; background-color: pink; background-image: url(\"200.png\"); background-repeat: no-repeat; /*èƒŒæ™¯å›¾ç‰‡å±…ä¸­æ˜¾ç¤º*/ background-position: center center; /* ç®€å†™æ–¹å¼ */ background: #ff0000 url(\"200.png\") no-repeat center center; } 3.5.3èƒŒæ™¯é¢œè‰² Title .c1{ height: 200px; width: 200px; background-color: pink; } 200x200åƒç´ çš„èƒŒæ™¯é¢œè‰² 3.6è¾¹æ¡† border-width è¾¹æ¡†å®½åº¦ border-style è¾¹æ¡†æ ·å¼(dashedæ˜¯è™šçº¿ï¼Œsolidæ˜¯å®çº¿) border-color è¾¹æ¡†é¢œè‰² 3.6.1å¯¹4ä¸ªè¾¹æ¡†è®¾ç½® Title div{ width: 200px; height: 100px; /*è¾¹æ¡†ç®€å†™æ–¹å¼,è¾¹æ¡†ç²—ä¸º1pxï¼Œsolidæ˜¯å®çº¿*/ border: 1px solid red; } éƒ½æ˜¯åŒå­¦è£…é¸¡æ¯›ï¼ 3.6.2å•ç‹¬å¯¹ä¸€ä¸ªè¾¹æ¡†è®¾ç½® border-left å·¦è¾¹æ¡† border-right å³è¾¹æ¡† border-top ä¸Šè¾¹æ¡† border-bottom ä¸‹è¾¹æ¡† Title div{ width: 200px; height: 100px; /*è¾¹æ¡†ç®€å†™æ–¹å¼,è¾¹æ¡†ç²—ä¸º1pxï¼Œsolidæ˜¯å®çº¿*/ border-right: 1px solid red; } éƒ½æ˜¯åŒå­¦è£…é¸¡æ¯›ï¼ solid å®çº¿è¾¹æ¡† dashed è™šçº¿è¾¹æ¡† 3.7ç›’å­æ¨¡å‹ ç›’å­æ¨¡å‹çš„å„ä¸ªå€¼ margin: å¤–è¾¹è· è·ç¦»å…¶ä»–æ ‡ç­¾æˆ–è€…è‡ªå·±çˆ¶çº§æ ‡ç­¾çš„è·ç¦» padding: å†…è¾¹è· å†…å®¹å’Œè¾¹æ¡†ä¹‹é—´çš„è·ç¦» border: è¾¹æ¡† content: å†…å®¹éƒ¨åˆ† è®¾ç½®çš„widthå’Œheight 3.7.1å†…è¾¹è· padding Title #d1{ width: 200px; height: 100px; /*è¾¹æ¡†4åƒç´ ï¼Œå®çº¿ï¼Œçº¢è‰²*/ border: 4px solid red; /*ä¸Šä¸‹6px å·¦å³8px*/ /*padding: 6px 8px;*/ /*ä¸Š4å³2ä¸‹6å·¦8*/ /*padding: 4px 2px 6px 8px*/ /*å·¦ä¸Šå³ä¸‹*/ /*padding-left: 200px;*/ /*padding-top: 20px;*/ /*padding-right: 20px;*/ /*padding-bottom: 20px;*/ } æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ åŸå…ˆæ•ˆæœ padding: 4px 2px 6px 80pxæ•ˆæœ 3.7.2å¤–è¾¹è· margin Title .c1{ background-color: red; height: 100px; width: 100px; /*margin-left: -1000px;*/ /*margin: 10px 15px;*/ } .c2{ background-color: green; height: 20px; width: 20px; /*margin: 10px 15px;*/ margin-left: 20px; } éƒ½æ˜¯åŒå­¦è£…é¸¡æ¯›! 3.8displayå±æ€§ displayçš„å‡ ä¸ªå€¼: inline: å°†å—çº§æ ‡ç­¾å˜æˆäº†å†…è”æ ‡ç­¾ block:å°†å†…è”æ ‡ç­¾å˜æˆå—çº§æ ‡ç­¾ inline-block: åŒæ—¶å…·å¤‡å†…è”æ ‡ç­¾å’Œå—çº§æ ‡ç­¾çš„å±æ€§,ä¹Ÿå°±æ˜¯ä¸ç‹¬å ä¸€è¡Œ,ä½†æ˜¯å¯ä»¥è®¾ç½®é«˜åº¦å®½åº¦ none: è®¾ç½®æ ‡ç­¾éšè— Title span{ /*display: block;*/ /*display: none;*/ } .c1{ background-color: red; height: 100px; width: 100px; /*display: inline;*/ display: inline-block; /*display: none;*/ } .c2{ background-color: green; height: 100px; width: 100px; } æˆ‘æ˜¯spanæ ‡ç­¾ é¹…é¹…é¹…,æ›²é¡¹å‘å¤©æ­Œ! æ‹”æ¯›çƒ§å¼€æ°´,é“é”…ç‚–å¤§é¹…! display:noneéšè—æ ‡ç­¾ 3.9æµ®åŠ¨ æµ®åŠ¨çš„å…ƒç´ ,ä¸ç‹¬å ä¸€è¡Œ,å¹¶ä¸”å¯ä»¥è®¾ç½®é«˜åº¦å®½åº¦ Title body{ margin: 0; } .c1{ background-color: red; height: 100px; width: 200px; float: left; } .c2{ background-color: brown; height: 100px; width: 200px; float: right; } .c3{ background-color: pink; height: 100px; width: 100%; } åŸè¯—ä½œå¯¹--> å·¦å³æµ®åŠ¨æ•ˆæœ ç²‰è‰²æ ‡ç­¾è®¾ç½®äº†å®½åº¦100%ï¼Œä½†æ˜¯è®¾ç½®å·¦å³æµ®åŠ¨åä¼šè¦†ç›–è¿™ä¸ªç²‰è‰²æ ‡ç­¾ï¼Œè¿™ç§ç°è±¡å°±æ˜¯çˆ¶çº§æ ‡ç­¾å¡Œé™·(ccæ˜¯çˆ¶çº§æ ‡ç­¾ï¼Œå·¦å³æµ®åŠ¨çš„c1å’Œc2æ˜¯å„¿å­æ ‡ç­¾)ï¼Œå› ä¸ºå·¦å³ä¸¤è¾¹çš„æ ‡ç­¾è®¾ç½®äº†æµ®åŠ¨ï¼Œå·²ç»è„±ç¦»äº†æ–‡æ¡£æµï¼Œæ‰€ä»¥ç²‰è‰²çš„æ ‡ç­¾(å’ŒccåŒçº§çš„c3)ä¼šå‘ä¸Šé¡¶ï¼Œæ­£ç¡®æƒ…å†µåº”è¯¥ä¸ºç²‰è‰²å•ç‹¬å ä¸€è¡Œ è§£å†³çˆ¶çº§æ ‡ç­¾å¡Œé™·é—®é¢˜: æ–¹æ³•ä¸€ ç»™çˆ¶çº§æ ‡ç­¾åŠ é«˜åº¦ï¼Œæœ¬ç¤ºä¾‹ä¸­æ˜¯ç»™ccåŠ é«˜åº¦ æ–¹æ³•äºŒ æ¸…é™¤æµ®åŠ¨:clearå±æ€§ï¼Œæœ¬ç¤ºä¾‹ä¸­ç»™c3æ·»åŠ æ¸…é™¤æµ®åŠ¨ï¼Œclear:bothçš„æ„æ€æ˜¯æœ¬æ ‡ç­¾çš„ä¸Šè¾¹ä¸å…è®¸æœ‰æµ®åŠ¨å…ƒç´  .c3{ background-color: pink; height: 100px; width: 100%; clear: both; } æ–¹å¼ä¸‰(å¸¸ç”¨)ä¼ªå…ƒç´ é€‰æ‹©å™¨è§£å†³ cssæ ·å¼: .clearfix:after{ content: ''; #è¿™é‡Œè®¾ç½®ä¸ªç©ºå€¼ï¼Œå› ä¸ºæ˜¯ä¼ªå…ƒç´ ï¼Œæ‰€ä»¥æ— æ³•é€‰ä¸­ï¼Œå¹¶ä¸”å ä¸€è¡Œï¼Œè¿™æ ·å°±è§£å†³äº†çˆ¶çº§æ ‡ç­¾å¡Œé™·çš„é—®é¢˜ display: block; #å°†å†…è”æ ‡ç­¾å˜æˆå—çº§æ ‡ç­¾ï¼Œå ä¸€è¡Œ clear: both; } htmlä»£ç : åŸè¯—ä½œå¯¹--> è§£å†³åçš„æ•ˆæœ 3.10ä¼ªå…ƒç´ é€‰æ‹©å™¨ Title div{ background-color: pink; height: 100px; width: 200px; } div:after{ content: 'æˆ‘æ˜¯æ— æ³•é€‰ä¸­çš„0.0'; color:white; } è¿™æ˜¯c2 éƒ½æ˜¯åŒå­¦è£…é¸¡æ¯›! div:afterè¡¨ç¤ºæ‰¾åˆ°divæ ‡ç­¾åçš„å†…å®¹ä¸”å†…å®¹æ— æ³•é€‰ä¸­ 3.11ä¼ªç±»é€‰æ‹©å™¨ 3.11.1hoverã€pointer hoverè¡¨ç¤ºå½“é¼ æ ‡æ‚¬æµ®æ—¶çš„æ•ˆæœ pointerè¡¨ç¤ºé¼ æ ‡æ‚¬æµ®æ—¶æ˜¾ç¤ºå°æ‰‹ Title .c1{ background-color: red; height: 200px; width: 200px; } .c1:hover{ /*background-color: green;*/ background-image: url(\"200.png\"); cursor: pointer; } 3.11.2å…¶ä»–ä¼ªç±»é€‰æ‹©å™¨ /* aæ ‡ç­¾æœªè®¿é—®çš„æ—¶å€™è®¾ç½®æ•ˆæœ */ a:link{ color:yellow; } /* é¼ æ ‡æ‚¬æµ®ä¸Šå»æ—¶è®¾ç½®æ•ˆæœ */ a:hover{ color:black; } /* é¼ æ ‡å·¦é”®ç‚¹å‡»ä¸‹å»çš„è¿˜æ²¡æœ‰æŠ¬èµ·æ¥çš„æ—¶å€™,è®¾ç½®æ•ˆæœ */ a:active{ color:green; } /* é¼ æ ‡æŠ¬èµ·å,è®¿é—®è¿‡ä¹‹åè®¾ç½®æ•ˆæœ */ a:visited{ color:purple; } å®Œæ•´ä»£ç  æˆ‘ä¸é€‚åˆå­¦å‰ç«¯ a:link { color: #000000; } /* æœªè®¿é—®é“¾æ¥*/ a:visited { color: #00FF00; } /* å·²è®¿é—®é“¾æ¥ */ a:hover { color: #FF00FF; } /* é¼ æ ‡ç§»åŠ¨åˆ°é“¾æ¥ä¸Š */ a:active { color: #0000FF; } /* é¼ æ ‡ç‚¹å‡»æ—¶ */ è¿™æ˜¯ä¸€ä¸ªé“¾æ¥ æ³¨æ„ï¼š a:hover å¿…é¡»åœ¨ a:link å’Œ a:visited ä¹‹åï¼Œéœ€è¦ä¸¥æ ¼æŒ‰é¡ºåºæ‰èƒ½çœ‹åˆ°æ•ˆæœã€‚ æ³¨æ„ï¼š a:active å¿…é¡»åœ¨ a:hover ä¹‹åã€‚ 3.12æ–‡å­—è£…é¥° Title a{ text-decoration: none; } æ¥ç‚¹æˆ‘ï¼ï¼ï¼ æ²¡æœ‰å»é™¤è¶…é“¾æ¥ä¸‹åˆ’çº¿å‰çš„æ•ˆæœ å»é™¤è¶…é“¾æ¥ä¸‹åˆ’çº¿åçš„æ•ˆæœ 3.13å®šä½postion static: é™æ€å®šä½,ä¹Ÿå°±æ˜¯æ ‡ç­¾é»˜è®¤ relative: ç›¸å¯¹å®šä½,æŒ‰ç…§è‡ªå·±åŸæ¥çš„ä½ç½®è¿›è¡Œç§»åŠ¨ absolute: ç»å¯¹å®šä½,æŒ‰ç…§çˆ¶çº§æ ‡ç­¾æˆ–è€…ç¥–å…ˆè¾ˆå„¿æ ‡ç­¾è®¾ç½®äº†ç›¸å¯¹å®šä½çš„æ ‡ç­¾ä½ç½®è¿›è¡Œç§»åŠ¨,å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸å¯¹å®šä½æ ‡ç­¾,ä¼šæ‰¾åˆ°æ•´ä¸ªæ–‡æ¡£çš„ä½ç½®è¿›è¡Œç§»åŠ¨ fixed: å›ºå®šå®šä½, æŒ‰ç…§æµè§ˆå™¨çª—å£çš„ä½ç½®è¿›è¡Œç§»åŠ¨ å›ºå®šå®šä½ç¤ºä¾‹ Title body{ margin: 0; } .c1{ background-color: red; height: 1000px; width: 800px; } .c2{ background-color: green; height: 1000px; width: 800px; } .c3{ background-color: blue; height: 1000px; width: 800px; } .s1{ position: fixed; left: 1000px; bottom: 20px; height: 40px; width: 60px; background-color: aqua; line-height: 40px; text-align: center; } .s1 a{ color:white; text-decoration: none; font-size: 12px; } è¿™æ˜¯é¡¶éƒ¨ è¿”å›é¡¶éƒ¨ å®šä½ç¤ºä¾‹ 3.14é€‰æ‹©å™¨ä¼˜å…ˆçº§ /* csså±æ€§æœ‰ç»§æ‰¿çš„æ¦‚å¿µ æƒé‡0*/ /* æ ‡ç­¾(å…ƒç´ )é€‰æ‹©å™¨ æƒé‡1*/ /* ç±»é€‰æ‹©å™¨ æƒé‡10*/ /* idé€‰æ‹©å™¨ æƒé‡100*/ /* å†…è”æ ·å¼ æƒé‡1000*/ /* color:green!important; æ— æ•Œ! */ /* å¦‚æœä¼˜å…ˆçº§ç›¸åŒ,æŒ‰ç…§åé¢çš„ä¸ºå‡† */ åˆ«å¿˜äº†,classå±æ€§çš„å€¼å¯ä»¥å†™å¤šä¸ª ç®€å•ç¤ºä¾‹ Title .c1{ height: 100px; width: 100px; background-color: red; } #d1{ height: 100px; width: 100px; background-color: greenyellow; } æˆ‘æ˜¯ä¸€ä¸ªdivæ ‡ç­¾ idé€‰æ‹©å™¨ä¼˜å…ˆçº§å¤§äºç±»é€‰æ‹©å™¨ä¼˜å…ˆçº§ï¼Œæ‰€ä»¥æ˜¾ç¤ºçš„é¢œè‰²æ˜¯d1ä¸­çš„ç»¿é»„è‰² æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"web/js/3.jsåŸºç¡€.html":{"url":"web/js/3.jsåŸºç¡€.html","title":"javaScriptåŸºç¡€çŸ¥è¯†","keywords":"","body":"jsåŸºç¡€ 1.jsç®€ä»‹ -- javascript ECMAscript5 ECMAscript6 -- vue.js react .. ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆ 1 ECMAscript5çš„æ ¸å¿ƒ jsè¯­è¨€ 2 BOM æµè§ˆå™¨å¯¹è±¡æ¨¡å‹ jsæ“ä½œæµè§ˆå™¨,åšå‡ºå¯¹åº”çš„ä¸€äº›æ•ˆæœ 3 DOM æ–‡æ¡£å¯¹è±¡æ¨¡å‹ -- HTMLæ–‡ä»¶ 2.jsä»£ç å¼•å…¥æ–¹å¼ ä¸‰ç§æ–¹å¼ 1.headæ ‡ç­¾çš„scriptæ ‡ç­¾é‡Œé¢(alert('xx'), confirm('xx')) 2.bodyæ ‡ç­¾çš„scriptæ ‡ç­¾é‡Œé¢ 3.å¤–éƒ¨æ–‡ä»¶å¼•å…¥çš„æ–¹å¼æ¥ä½¿ç”¨ 3.1åˆ›å»ºä¸€ä¸ª.jsç»“å°¾çš„æ–‡ä»¶,å†™ä¸Šå’±ä»¬çš„jsä»£ç  æ¯”å¦‚:alert('are you ok?'); 3.2åœ¨æƒ³ä½¿ç”¨è¿™ä¸ªjsä»£ç çš„htmlæ–‡ä»¶ä¸­,headæ ‡ç­¾æˆ–è€…bodyæ ‡ç­¾ä¸‹é¢æˆ–è€…ä¸Šé¢å†™ä¸‹é¢çš„å†…å®¹ ç¬¬ä¸€ç§æ–¹å¼ headæ ‡ç­¾ä¸­scriptæ ‡ç­¾ä¸­å†™jsä»£ç  Title alert('are you ok?') æ•ˆæœå›¾ ç¬¬äºŒç§æ–¹å¼ bodyæ ‡ç­¾ä¸­çš„scriptæ ‡ç­¾ä¸­å†™jsä»£ç  Title alert('are you ok?') ç¬¬ä¸‰ç§æ–¹å¼ å¤–éƒ¨æ–‡ä»¶å¼•å…¥æ–¹å¼ ç¬¬ä¸€æ­¥ã€å…ˆåˆ›å»ºä¸€ä¸ª.jsç»“å°¾çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ alert('are you ok'); ç¬¬äºŒæ­¥ã€htmlæ–‡ä»¶ä¸­å¼•å…¥è¿™ä¸ªjsæ–‡ä»¶ Title alert('are you ok?') 3.jså˜é‡ å®šä¹‰æ–¹å¼ä¸€(åœ¨å‡½æ•°ä¸­æ˜¯å±€éƒ¨å˜é‡ï¼Œåœ¨å‡½æ•°å¤–æ˜¯å…¨å±€å˜é‡) var å˜é‡å = å€¼; å®šä¹‰æ–¹å¼äºŒ(éƒ½æ˜¯å…¨å±€å˜é‡) å˜é‡å = å€¼; 4.jsæ³¨é‡Š å•è¡Œæ³¨é‡Š //å•è¡Œæ³¨é‡Šå†…å®¹ // æ”¹å˜æ ‡é¢˜ï¼š document.getElementById(\"myH\").innerHTML = \"æˆ‘çš„ç¬¬ä¸€å¼ é¡µé¢\"; // æ”¹å˜æ®µè½ï¼š document.getElementById(\"myP\").innerHTML = \"æˆ‘çš„ç¬¬ä¸€ä¸ªæ®µè½ã€‚\"; å¤šè¡Œæ³¨é‡Š / å¤šè¡Œæ³¨é‡Šå†…å®¹/ /* ä¸‹é¢çš„ä»£ç ä¼šæ”¹å˜ ç½‘é¡µä¸­ id = \"myH\" çš„æ ‡é¢˜ ä»¥åŠ id = \"myP\" çš„æ®µè½ï¼š */ document.getElementById(\"myH\").innerHTML = \"æˆ‘çš„ç¬¬ä¸€å¼ é¡µé¢\"; document.getElementById(\"myP\").innerHTML = \"æˆ‘çš„ç¬¬ä¸€ä¸ªæ®µè½ã€‚\"; 5.jsæ•°æ®ç±»å‹ 5.1numberç±»å‹(æ•´æ•°,æµ®ç‚¹æ•°) var n = 11; var n2 = 11.11; æŸ¥çœ‹æ•°æ®ç±»å‹ typeof å˜é‡å; typeof n; -- numberç±»å‹ å˜é‡å£°æ˜,ä½†æ²¡æœ‰èµ‹å€¼çš„æ—¶å€™,å˜é‡çš„å€¼ä¸ºundefined 5.2stringç±»å‹(å­—ç¬¦ä¸²) ç¤ºä¾‹: var a = 'abcdef'; typeof a; --> \"string\" var a = new String('s'); typeof a; --> \"object\" å­—ç¬¦ä¸²çš„æ“ä½œæ–¹å¼ å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸² var s = 'å¥½å¥½å­¦ä¹ ï¼Œå¤©å¤©å‘ä¸Š'; ç´¢å¼•å–å€¼ s[1] --> 'å¥½' ç§»é™¤ç©ºæ ¼,ä¸èƒ½ç§»é™¤å­—ç¬¦ä¸²ä¸­çš„ç©ºæ ¼ s.trim(); #å»é™¤ä¸¤ç«¯çš„ç©ºæ ¼ s.trimLeft(); #å»é™¤å·¦è¾¹çš„ç©ºæ ¼ s.trimRight(); #å»é™¤å³è¾¹çš„ç©ºæ ¼ æ ¹æ®ç´¢å¼•è·å–å­—ç¬¦ //è¯­æ³• var value = name.charAt(index) //ç¤ºä¾‹ var s = 'hello'; s.charAt(4); --> 'o' æ ¹æ®ç´¢å¼•è·å–å­åºåˆ—(åˆ‡ç‰‡) //è¯­æ³• var values = name.substring(å¼€å§‹ä½ç½®ï¼Œç»“æŸä½ç½®) //ç¤ºä¾‹ var s = 'hello'; s.substring(1,3); --> \"el\" 5.3å¸ƒå°”ç±»å‹(booleanç±»å‹) var a = true; var b = false; typeof a; \"boolean\" jsçš„åŸºç¡€æ•°æ®ç±»å‹éƒ½æœ‰å¸ƒå°”å€¼å±æ€§, []--false 0,{},'',undefined,null,NaN å­—ç¬¦ä¸²è½¬æ•°å­—: var a = '11'; parseInt(a); var a = '23abc'; parseInt(a); 23 var a = 'asdfabc'; parseInt(a); -- NAN -- not a number typeof NaN; -- \"number\" NaN === NaN; -- false NaN == NaN; -- false 5.4undefinedå’Œnullç±»å‹ undefined å˜é‡å£°æ˜äº†,ä½†æ˜¯æ²¡æœ‰èµ‹å€¼,æ­¤æ—¶è¿™ä¸ªå˜é‡æ˜¯undefinedç±»å‹ //ç¤ºä¾‹ var b; b undefined typeof b; \"undefined\" null : å˜é‡ä¸ç”¨äº†,å°±å¯ä»¥ç»™å˜é‡èµ‹å€¼ä¸ºnull,--- objectç±»å‹ //ç¤ºä¾‹ var b = null; undefined b null typeof b; \"object\" 5.5æ•°ç»„(array) var name = [1,2,3]; //æ‹¬å·ä¸­çš„3è¡¨ç¤ºæ•°ç»„æœ‰3ä¸ªå…ƒç´  names; (3) [1, 2, 3] //âš ï¸ï¼Œæ•°ç»„ç±»å‹ä¹Ÿæ˜¯å­—ç¬¦ä¸² typeof names; \"string\" 5.5.1ç´¢å¼•å–å€¼ï¼Œä»0å¼€å§‹ //æ•°ç»„aä¸­çš„å…ƒç´  names = [1,2,3]; (3) [1, 2, 3] //ç´¢å¼•å–å€¼ï¼Œä»0å¼€å§‹ names[0]; 1 5.5.2å°¾éƒ¨è¿½åŠ å…ƒç´  //æ•°ç»„aä¸­çš„å…ƒç´  names = [1,2,3]; (3) [1, 2, 3] //è¿½åŠ æ•°å­— names.push(5); 4 names; (4) [1, 2, 3, 5] //è¿½åŠ å­—ç¬¦ä¸² names.push('å•Š'); 5 names; (5) [1, 2, 3, 5, \"å•Š\"] 5.5.3å°¾éƒ¨ç§»é™¤å…ƒç´  //æ•°ç»„namesä¸­çš„å…ƒç´  names; (5) [1, 2, 3, 5, \"å•Š\"] //ç§»é™¤å°¾éƒ¨å…ƒç´  names.pop(); \"å•Š\" names; (4) [1, 2, 3, 5] 5.5.4å¤´éƒ¨æ’å…¥å…ƒç´  //æ•°ç»„namesä¸­çš„å…ƒç´  names; (4) [1, 2, 3, 5] //å¤´éƒ¨æ’å…¥å…ƒç´  names.unshift(9); 5 names; (5) [9, 1, 2, 3, 5] 5.5.5å¤´éƒ¨ç§»é™¤å…ƒç´  //æ•°ç»„namesä¸­çš„å…ƒç´  names; (5) [9, 1, 2, 3, 5] //å¤´éƒ¨ç§»é™¤å…ƒç´  names.shift(); 9 names; (4) [1, 2, 3, 5] 5.5.6åœ¨æŒ‡å®šç´¢å¼•ä½ç½®æ’å…¥å…ƒç´  //è¯­æ³• names.splice(ä»å“ªåˆ (ç´¢å¼•),åˆ å‡ ä¸ª(ä¸ªæ•°),åˆ é™¤ä½ç½®æ›¿æ¢çš„æ–°å…ƒç´ (å¯ä¸å†™,å¯å†™å¤šä¸ª)) //æ•°ç»„namesä¸­çš„å…ƒç´  names = [1,2,3,5,6]; (5) [1, 2, 3, 5, 6] names; (5) [1, 2, 3, 5, 6] //åœ¨æŒ‡å®šç´¢å¼•ä½ç½®æ’å…¥å…ƒç´ ï¼Œè¿™é‡Œå…¶å®ä¸åˆ é™¤å·®ä¸å¤šï¼Œåªä¸è¿‡æ˜¯ç¬¬äºŒä¸ªå‚æ•°åˆ é™¤ä¸ªæ•°ä¸º0ï¼Œä¸åˆ é™¤å…ƒç´ ï¼Œæ’å…¥å…ƒç´  names.splice(1,0,'å‘µå‘µ'); [] names; (6) [1, \"å‘µå‘µ\", 2, 3, 5, 6] 5.5.7åœ¨æŒ‡å®šç´¢å¼•ä½ç½®æ›¿æ¢å…ƒç´  //è¯­æ³• è¯­æ³•å’Œåœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ ç›¸åŒï¼Œåªä¸è¿‡åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ åˆ é™¤çš„å…ƒç´ ä¸ªæ•°ä¸º0ï¼Œè€Œåœ¨æŒ‡å®šç´¢å¼•ä½ç½®æ›¿æ¢å…ƒç´ æ˜¯åˆ é™¤å…ƒç´ å¹¶æ›¿æ¢ names.splice(ä»å“ªåˆ (ç´¢å¼•),åˆ å‡ ä¸ª(ä¸ªæ•°),åˆ é™¤ä½ç½®æ›¿æ¢çš„æ–°å…ƒç´ (å¯ä¸å†™,å¯å†™å¤šä¸ª)) //æ•°ç»„namesä¸­çš„å…ƒç´  names; (5) [1, 2, 3, 5, 6] //åœ¨æŒ‡å®šç´¢å¼•ä½ç½®æ›¿æ¢å…ƒç´ ,ä»ç´¢å¼•1å¼€å§‹ï¼Œåˆ é™¤1ä¸ªå…ƒç´ ï¼Œå¹¶æ›¿æ¢ä¸ºå‘µå‘µ names.splice(1,1,'å‘µå‘µ'); [2] names; (5) [1, \"å‘µå‘µ\", 3, 5, 6] 5.5.8åœ¨æŒ‡å®šç´¢å¼•ä½ç½®åˆ é™¤å…ƒç´  //è¯­æ³• names.splice(ä»å“ªåˆ (ç´¢å¼•),åˆ å‡ ä¸ª(ä¸ªæ•°),åˆ é™¤ä½ç½®æ›¿æ¢çš„æ–°å…ƒç´ (å¯ä¸å†™,å¯å†™å¤šä¸ª)) //æ•°ç»„namesä¸­çš„å…ƒç´  names; (5) [1, 2, 3, 5, 6] //ç¤ºä¾‹1ï¼Œåªåˆ é™¤æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ ï¼Œä¸æ›¿æ¢ names.splice(1,3); (3) [2, 3, 5] names; (2) [1, 6] //ç¤ºä¾‹2ï¼Œåˆ é™¤æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ ï¼Œå¹¶æ›¿æ¢ names.splice(1,3,'å‘µå‘µ'); (3) [2, 3, 5] names; (3) [1, \"å‘µå‘µ\", 6] //ç¤ºä¾‹3ï¼Œåˆ é™¤æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ ï¼Œå¹¶æ›¿æ¢å¤šä¸ªï¼Œçœ‹æ•ˆæœ names.splice(1,3,'å‘µå‘µ','å“ˆå“ˆ',666); (3) [2, 3, 5] names; (5) [1, \"å‘µå‘µ\", \"å“ˆå“ˆ\", 666, 6] 5.5.9åˆ‡ç‰‡ //è¯­æ³• names.slice(å¼€å§‹ä½ç½®,ç»“æŸä½ç½®) //æ•°ç»„namesä¸­çš„å…ƒç´  names; (5) [1, 2, 3, 5, 6] //ä»ç´¢å¼•1å¼€å§‹åˆ°ç´¢å¼•3ç»“æŸï¼Œé¡¾å¤´ä¸é¡¾å°¾ names.slice(1,3); (2) [2, 3] 5.5.10æ•°ç»„åè½¬(ä¼šç›´æ¥ä¿®æ”¹åŸæ•°ç»„) //æ•°ç»„namesä¸­çš„å…ƒç´  names; (5) [1, 2, 3, 5, 6] //åŸæ•°ç»„åè½¬ names.reverse(); (5) [6, 5, 3, 2, 1] 5.5.11æ•°ç»„å…ƒç´ æ‹¼æ¥ //æ•°ç»„namesä¸­çš„å…ƒç´  names; (5) [1, 2, 3, 5, 6] //å°†æ•°ç»„å…ƒç´ è¿æ¥èµ·æ¥ä»¥æ„å»ºä¸€ä¸ªå­—ç¬¦ä¸² names.join('æ»š'); \"1æ»š2æ»š3æ»š5æ»š6\" 5.5.12è¿æ¥æ•°ç»„ //æ•°ç»„aä¸­çš„å…ƒç´  a = [1,2,3]; (3) [1, 2, 3] //æ•°ç»„bä¸­çš„å…ƒç´  b = ['a','b','c']; (3) [\"a\", \"b\", \"c\"] //è¿æ¥æ•°ç»„aå’Œb a.concat(b); (6) [1, 2, 3, \"a\", \"b\", \"c\"] 5.5.13å¯¹åŸæ•°ç»„è¿›è¡Œæ’åº //æ•°ç»„aä¸­çš„å…ƒç´  a = [11,32,2,66,7]; (5) [11, 32, 2, 66, 7] //å¯¹åŸæ•°ç»„è¿›è¡Œæ’åºï¼Œå‘ç°ç»“æœå¹¶ä¸æ˜¯æ­£ç¡®çš„ï¼Œæ’åºå¹¶æ²¡æœ‰æŒ‰ç…§æ•°å­—å¤§å°è¿›è¡Œæ’åºï¼Œè€Œæ˜¯æŒ‰ç…§æ•°å­—çš„ç¬¬ä¸€ä¸ªæ•°å­—è¿›è¡Œå¤§å°æ’åºçš„ a.sort(); (5) [11, 2, 32, 66, 7] å› æ­¤ï¼Œä¸ºäº†è§£å†³ä¸Šè¿°æ’åºé—®é¢˜ï¼Œéœ€è¦è‡ªå·±å®šä¹‰è§„åˆ™ //å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œä½¿ç”¨å†’æ³¡æ’åºæ³•è¿›è¡Œæ’åºæ‰èƒ½å¾—åˆ°æ­£ç¡®ç»“æœ function compare(a,b){ return a - b; /* å½“a-bå¤§äº0æ—¶ï¼Œä¸¤ä¸ªæ•°äº’æ¢ä½ç½®*/ } a.sort(compare); /* a-bæ˜¯å‡åºæ’åº */ (5) [2, 7, 11, 32, 66] //å€’å™æ’åº function compare(a,b){ return b - a; } a.sort(compare); (5) [66, 32, 11, 7, 2] 5.6è‡ªå®šä¹‰å¯¹è±¡(ç›¸å½“äºpythonçš„ä¸­çš„dict) // å£°æ˜ä¸€ä¸ªå¯¹è±¡ info = { name:'å°æ˜', 'age:18 } info {name: 'å°æ˜', age: 18} //æŸ¥çœ‹æ•°æ®ç±»å‹ typeof info; \"object\" //å¸¸ç”¨æ–¹æ³• //è·å–å€¼ï¼Œé€šè¿‡é”®è·å–å€¼å¿…é¡»åŠ å¼•å· info['name']; \"å°æ˜\" info.name; \"å°æ˜\" //ä¿®æ”¹å€¼ info.age = 22; 22 info; {name: \"å°æ˜\", age: 22} //æ–°å¢å€¼ info['gender'] = 'man'; \"man\" info; {name: \"å°æ˜\", age: 22, gender: \"man\"} //åˆ é™¤å€¼ delete info['age']; true info; {name: \"å°æ˜\"} 6.è¿ç®—ç¬¦ 6.1åˆ¤æ–­è¿ç®—ç¬¦ > = 6.2ç®—æœ¯è¿ç®—ç¬¦ + - * / % ++ -- ++ è‡ªå¢ 1 -- è‡ªå‡ 1 var a = 2; a++ å…ˆæ‰§è¡Œé€»è¾‘ åœ¨+1 ++a å…ˆ+1 åœ¨æ‰§è¡Œé€»è¾‘ ç®€å•ç¤ºä¾‹: if (++a === 4){ console.log('xxx'); } else{ console.log('ooo'); }; ç»“æœï¼š 000 7.æµç¨‹æ§åˆ¶è¯­å¥ 7.1åˆ¤æ–­è¯­å¥ 7.1.1 ifè¯­å¥ å•æ¡ä»¶ if (a == 1){ //åˆ¤æ–­æ¡ä»¶å†™åœ¨å°æ‹¬å·é‡Œé¢,å¤§æ‹¬å·é‡Œé¢å†™æ¡ä»¶åˆ¤æ–­æˆåŠŸåçš„ä»£ç å†…å®¹ console.log('1111'); } else{ console.log('222'); }; å¤šæ¡ä»¶ var a = 0; if(a > 1){ console.log('0'); //æµè§ˆå™¨æ˜¾ç¤ºç»“æœ //var h = document.getElementById('d1'); //h.innerText = 'å°æ˜'; }else if(a 7.1.2switchè¯­å¥ //numåªèƒ½æ˜¯æ•°å­—,caseåˆ¤æ–­çš„åªèƒ½æ˜¯æ•°å­— var num = 50; switch(num++){ case 10: console.log('æœªæˆå¹´'); break; case 18: console.log('æˆå¹´'); break; case 35: console.log('å¤§å”'); break; case 40: console.log('ä¸­å¹´äº†'); break; default: console.log('æ²¡æœ‰å‰é€”ã€‚ã€‚ã€‚'); }; 7.2å¾ªç¯è¯­å¥ 7.2.1forå¾ªç¯ //æ™®é€šå¾ªç¯ for (var i=0;i 7.2.2whileå¾ªç¯ var a = 0; while(a 8.å‡½æ•° 8.1æ™®é€šå‡½æ•° //å®šä¹‰ä¸€ä¸ªæ™®é€šå‡½æ•° function f1(a,b){ return a+b; } æ‰§è¡Œ: f1(1,2) --> 3 //æ­¤å†™æ³•ä¸èƒ½è¿”å›å¤šä¸ªå€¼ function f1(a,b){ return a,b; }; f1(1,2); ä¸èƒ½è¿”å›å¤šä¸ªå€¼: --> 2 //è¿”å›å¤šä¸ªå€¼ function f1(a,b){ return [a,b]; }; f1(1,2); (2) [1, 2] 8.2åŒ¿åå‡½æ•° âš ï¸âš ï¸âš ï¸åŒ¿åå‡½æ•°å¿…é¡»èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œå¦åˆ™ä¼šæŠ¥é”™ //å®šä¹‰ä¸€ä¸ªåŒ¿åå‡½æ•° var a = function(a,b,c){ return a+b+c; } a(1,2,3) 6 //åŒ¿åå‡½æ•°è¿˜å¯ä»¥å½“ä½œè‡ªå®šä¹‰å¯¹è±¡çš„å€¼ var d = { 'a':'b','f':function(a,b){ return a+b; } }; d.f(1,2); 3 8.3è‡ªæ‰§è¡Œå‡½æ•° (function () { alert('è‡ªæ‰§è¡Œå‡½æ•°!') })() 9.åºåˆ—åŒ– //åºåˆ—åŒ– JSON.stringifyï¼Œç›¸å½“äºpythonä¸­çš„json.dumpsï¼Œåºåˆ—åŒ–åä¼šå˜æˆjsonæ ¼å¼ï¼Œå…¨éƒ¨æ›¿æ¢ä¸ºåŒå¼•å· var d = {'a':'aa','b':'bb'}; undefined var d_json = JSON.stringify(d); undefined d_json \"{\"a\":\"aa\",\"b\":\"bb\"}\" //ååºåˆ—åŒ– JSON.parse d_json \"{\"a\":\"aa\",\"b\":\"bb\"}\" var reverse_json = JSON.parse(d_json); reverse_json {a: \"aa\", b: \"bb\"} 10.BOMå¯¹è±¡ æµè§ˆå™¨å¯¹è±¡æ¨¡å‹ 10.1å¼¹æ¡† alert('are you ok?'); confirm('are you sure?') alertå¼¹æ¡†(åªæœ‰ç¡®å®š) confirmå¼¹æ¡†(æœ‰ç¡®å®šå’Œå–æ¶ˆ) 10.2locationå¯¹è±¡ //è·å–å½“å‰é¡µé¢çš„åœ°å€ location.href; \"https://www.baidu.com/\" //è·³è½¬åˆ°è¿™ä¸ªç½‘å€ä¸Š location.href = 'http://www.baidu.com'; //åˆ·æ–°å½“å‰é¡µé¢ location.reload(); 10.3è®¡æ—¶å™¨ 10.3.1 ä¸€æ®µæ—¶é—´åæ‰§è¡ŒæŸä¸ªä»»åŠ¡ //å†™æ³•ä¸€ 1000æ˜¯æ¯«ç§’ï¼Œ1ç§’åæ‰“å°å‘µå‘µ var t = setTimeout(\"console.log('å‘µå‘µ')\",1000); //tå°±æ˜¯æµè§ˆå™¨ç”¨æ¥è®°å½•ä½ çš„è®¡æ—¶å™¨çš„æ ‡è¯†æ•°å­— t 2810 //æ¸…é™¤è®¡æ—¶å™¨ clearTimeout(t) //å†™æ³•äºŒ å¸¸é…åˆåŒ¿åå‡½æ•°ä½¿ç”¨ï¼Œ5ç§’åå¼¹æ¡† var t = setTimeout(function(){confirm('ä½ æ»¡18å²äº†å—?')},5000); 10.3.2 æ¯éš”ä¸€æ®µæ—¶é—´æ‰§è¡ŒæŸä¸ªä»»åŠ¡ var t = setInterval(function(){confirm('å¼¹ä¸ªæ¡†!!')},3000); //æ¸…é™¤è®¡æ—¶å™¨ clearInterval(t); 11.DOMå¯¹è±¡ htmlæ–‡æ¡£ 11.1ç›´æ¥æŸ¥æ‰¾é€‰æ‹©å™¨ htmlä»£ç : cssä»£ç : .c1{ background-color: green; height: 100px; width: 100px; } .c2{ background-color: red; /*height: 100px;*/ /*width: 100px;*/ color:red; } //æŒ‰æ ‡ç­¾åæŸ¥æ‰¾: var divEle = document.getElementsByTagName('div'); divEle HTMLCollection(2) [div#d1.c1, div#d2.c1.c2, d1: div#d1.c1, d2: div#d2.c1.c2] //æŒ‰idå€¼æŸ¥æ‰¾: var d1 = document.getElementById('d1'); ç¤ºä¾‹: d1.style.height = '600px'; ä¸Šè¿°æ“ä½œä¼šå°†idä¸ºd1çš„æ ‡ç­¾é«˜åº¦å˜ä¸º600px //æŒ‰ç±»å€¼æŸ¥æ‰¾:var a = document.getElementsByClassName('c1'); a HTMLCollection(2) [div#d1.c1, div#d2.c1.c2, d1: div#d1.c1, d2: div#d2.c1.c2] 11.2é—´æ¥æŸ¥æ‰¾é€‰æ‹©å™¨ htmlæ–‡ä»¶å†…å®¹ Title .c1{ border: 1px solid red; height: 100px; width: 100px; } äº¬ä¸œa ç™¾åº¦span div3 ä¿®æ”¹è¾¹æ¡†é¢œè‰² div1.style.borderColor=\"green\"; div1.nextElementSibling.style.color = 'blue'; æ‰¾ä¸‹ä¸€ä¸ªå…„å¼Ÿæ ‡ç­¾,å¹¶æ”¹æˆè“è‰² var div1 = document.getElementsByClassName('c1')[0]; div1.nextElementSibling.style.color = 'blue'; æ‰¾ä¸‹ä¸€ä¸ªå…„å¼Ÿæ ‡ç­¾,å¹¶æ”¹äº†è‰² div1.previousElementSibling; æ‰¾ä¸Šä¸€ä¸ªå…„å¼Ÿ div1.firstElementChild; æ‰¾ç¬¬ä¸€ä¸ªå„¿å­ div1.lastElementChild; æ‰¾æœ€åä¸€ä¸ªå„¿å­ div1.children; æ‰¾æ‰€æœ‰å„¿å­,æ˜¯ä¸€ä¸ªæ•°ç»„ div1.parentElement; æ‰¾åˆ°è‡ªå·±çš„çˆ¶çº§æ ‡ç­¾ 11.3æ–‡æœ¬æ“ä½œ htmlæ–‡ä»¶å†…å®¹ Title .c1{ border: 1px solid red; height: 100px; width: 100px; } äº¬ä¸œa ç™¾åº¦span div3 innerTextè·å–æ–‡æœ¬: var a = document.getElementById('jd'); a.innerText; åªè·å–æ–‡æœ¬å†…å®¹ innerTextè®¾ç½®æ–‡æœ¬: a.innerText = 'å‘µå‘µ';ä¸èƒ½è¯†åˆ«æ ‡ç­¾,å•çº¯çš„æ–‡æœ¬å†…å®¹æ˜¾ç¤º innerHTMLè·å–æ–‡æœ¬ var d = document.getElementsByClassName('c1')[0]; d.innerHTML; è·å–çš„å†…å®¹åŒ…å«æ ‡ç­¾ innerHTMLè®¾ç½®æ–‡æœ¬ var d = document.getElementsByClassName('c1')[0]; d.innerHTML = 'å‘µå‘µ'èƒ½å¤Ÿè¯†åˆ«æ ‡ç­¾,ç”Ÿæˆæ ‡ç­¾æ•ˆæœ //innerText è·å–æ–‡æœ¬: var a = document.getElementById('jd'); a.innerText; åªè·å–æ–‡æœ¬å†…å®¹ è®¾ç½®æ–‡æœ¬: a.innerText = 'å‘µå‘µ';ä¸èƒ½è¯†åˆ«æ ‡ç­¾,å•çº¯çš„æ–‡æœ¬å†…å®¹æ˜¾ç¤º //innerHTML è·å–æ–‡æœ¬ var d = document.getElementsByClassName('c1')[0]; d.innerHTML; è·å–çš„å†…å®¹åŒ…å«æ ‡ç­¾ è®¾ç½®æ–‡æœ¬: d.innerHTML = 'å‘µå‘µ'; èƒ½å¤Ÿè¯†åˆ«æ ‡ç­¾,ç”Ÿæˆæ ‡ç­¾æ•ˆæœ 11.4valueå€¼æ“ä½œ htmlæ–‡ä»¶ Title .c1{ border: 1px solid red; height: 100px; width: 100px; } äº¬ä¸œa ç™¾åº¦span div3 æ‰¾åˆ°æ ‡ç­¾ var inp = document.getElementById('username'); è·å–å€¼ inp.value ä¿®æ”¹å€¼ inp.value = 'å“ˆå“ˆ!'; ç¤ºä¾‹: var inp = document.getElementById('username'); æ‰¾åˆ°æ ‡ç­¾ inp.value; è·å–å€¼ inp.value = '200å—!'; ä¿®æ”¹å€¼ ä½¿ç”¨ç¤ºä¾‹ é—ªçƒæ•ˆæœ htmlæ–‡ä»¶ Title .c1{ height: 100px; width: 100px; background-color: red; } .c2{ height: 100px; width: 100px; background-color: green; } jsä»£ç  var div1 = document.getElementById('d1'); æ‰¾åˆ°c2å°±åˆ é™¤ï¼Œæ²¡æœ‰åˆ™åŠ¨æ€æ·»åŠ ï¼Œå› æ­¤åŠ¨æ€æ˜¾ç¤º var t = setInterval(\"div1.classList.toggle('c2')\",100); ç”¨æˆ·ç™»é™†è¾“å…¥ä¸ºç©ºè§¦å‘äº‹ä»¶ Title ç”¨æˆ·å: å¯†ç : --> æ³¨å†Œ var btnEle = document.getElementById('btn'); btnEle.onclick = function () { var unameEle = document.getElementById('username'); var uname = unameEle.value; var pwdEle = document.getElementById('password'); var pwd = pwdEle.value; if (uname.trim().length === 0){ unameEle.nextElementSibling.innerHTML = 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º!'; }else if(pwd.trim().length === 0){ unameEle.nextElementSibling.innerHTML = ''; pwdEle.nextElementSibling.innerHTML = 'å¯†ç ä¸èƒ½ä¸ºç©º!'; }else { document.getElementById('ss').innerText = 'ç™»å½•æˆåŠŸ!'; unameEle.nextElementSibling.innerHTML=''; pwdEle.nextElementSibling.innerHTML = ''; } } æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"macä½¿ç”¨è®°å½•/MACæœ¬æ·»åŠ å¤šä¸ªgithubè´¦å·.html":{"url":"macä½¿ç”¨è®°å½•/MACæœ¬æ·»åŠ å¤šä¸ªgithubè´¦å·.html","title":"macæ·»åŠ å¤šä¸ªgithubè´¦å·","keywords":"","body":"MACæœ¬æ·»åŠ å¤šä¸ªgithubè´¦å· ä½¿ç”¨éœ€æ±‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸¤ä¸ª github è´¦å·ï¼šä¸€ä¸ªæ˜¯å…¬å¸çš„ï¼Œå¦ä¸€ä¸ªæ˜¯ç§äººçš„ã€‚ç”±äº github æ˜¯ä½¿ç”¨ SSH key çš„ fingerprint (å¯¹åº”çš„å…¬é’¥id_rsa_pub)æ¥åˆ¤å®šä½ æ˜¯å“ªä¸ªè´¦æˆ·ï¼Œè€Œä¸æ˜¯é€šè¿‡ç”¨æˆ·åï¼Œå¦‚æœæ˜¯åœ¨å¤šå°ç”µè„‘ä¸Šä½¿ç”¨ä¸€ä¸ªè´¦å·ï¼Œå¯ä»¥ä¸ºè¯¥è´¦å·æ·»åŠ å¤šä¸ª SSH keyï¼Œå¦‚æœæ˜¯ä¸€å°ç”µè„‘ä½¿ç”¨å¤šä¸ªè´¦å·ï¼Œåˆ™åˆ†åˆ«ç”Ÿæˆå¤šä¸ª SSH key æ·»åŠ åˆ°å¯¹åº”çš„è´¦æˆ·å³å¯ã€‚æ‰€ä»¥æœ¬æ–‡è¦å®ç°çš„æ˜¯å…¬å·å’Œç§å·åœ¨ git ä¸ŠåŒæ—¶ä½¿ç”¨ï¼Œä¸¤è€…äº’ä¸å¹²æ‰°ã€‚ ç¬¬ä¸€æ­¥ã€ç”Ÿæˆå¤šä¸ªsshkey cd ~/.sshåˆ‡æ¢åˆ°ç”¨æˆ·å®¶ç›®å½•ï¼Œç„¶åç”Ÿæˆsshkeyï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¸€è·¯å›è½¦å³å¯ ssh-keygen -t rsa -f ~/.ssh/id_rsa_one -C \"one@xxx.com\" ssh-keygen -t rsa -f ~/.ssh/id_rsa_two -C \"two@xxx.com\" è¿™æ ·ä¼šåœ¨~/.sshç›®å½•ä¸‹ç”Ÿæˆå››ä¸ªæ–‡ä»¶ï¼š id_rsa.one //è´¦å·oneçš„ç§é’¥ id_rsa.one.pub //è´¦å·oneçš„å…¬é’¥ id_rsa.two //è´¦å·twoçš„ç§é’¥ id_rsa.two.pub //è´¦å·twoçš„å…¬é’¥ ç¬¬äºŒæ­¥ã€åˆ›å»ºé…ç½®æ–‡ä»¶config åœ¨ ~/.sshç›®å½•ä¸‹æ–°å»º config æ–‡ä»¶ï¼Œä»¤ä¸åŒ Host å®é™…æ˜ å°„åˆ°åŒä¸€ HostNameï¼Œä½†å¯†é’¥æ–‡ä»¶ä¸åŒï¼Œè¿™é‡Œä¸¾ä¾‹ä¸ºoneå’Œtwoï¼Œå¯è‡ªè¡Œä¿®æ”¹ä¸ºè‡ªå·±ä½¿ç”¨çš„ç”¨æˆ· # one (first account) Host one.github.com HostName github.com PreferredAuthentications publickey User one IdentityFile ~/.ssh/id_rsa_one # two(second account) Host two.github.com HostName github.com PreferredAuthentications publickey User two IdentityFile ~/.ssh/id_rsa_two ç¬¬ä¸‰æ­¥ã€githubæ·»åŠ sshkeyåŠæµ‹è¯• åˆ†åˆ«ç™»é™†ä¸¤ä¸ª github è´¦å·ï¼Œåœ¨ Settings â€”> SSH and GPG keys ä¸­ï¼Œç‚¹å‡» â€œnew SSH keyâ€ï¼ŒæŠŠ â€œid_rsa.one.pubâ€ å’Œ \"id_rsa.two.pub\"è¿™ä¸¤ä¸ªå…¬é’¥çš„å†…å®¹åˆ†åˆ«æ·»åŠ åˆ°ç›¸åº”çš„è´¦å·ä¸­ã€‚ ä¸ºäº†ç¡®è®¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ SSH è¿æ¥ githubï¼Œå¯é€šè¿‡è¾“å…¥ä¸‹é¢å‘½ä»¤æ¥éªŒè¯ //æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯• ssh -T git@one.github.com //è¿”å›ç»“æœå¦‚ä¸‹è¯´æ˜æ·»åŠ æˆåŠŸ Hi one! You've successfully authenticated, but GitHub does not provide shell access. ç¬¬å››æ­¥ã€é…ç½®gitä¿¡æ¯ å› ä¸ºä¸€å°ç”µè„‘ä¸Šé…ç½®äº†å¤šä¸ª github è´¦å·ï¼Œæ‰€ä»¥å°±ä¸èƒ½å†é…ç½®å…¨å±€çš„ç”¨æˆ·åå’Œé‚®ç®±äº†ï¼Œè€Œæ˜¯åœ¨ä¸åŒçš„ä»“åº“ä¸‹ï¼Œå¦‚æœéœ€è¦è¿æ¥ä¸åŒçš„ git è´¦å·ï¼Œé…ç½®ç›¸åº”çš„å±€éƒ¨ç”¨æˆ·åå’Œé‚®ç®±å³å¯ï¼Œå¦‚æœä¹‹å‰é…ç½®è¿‡å…¨å±€çš„ç”¨æˆ·åå’Œé‚®ç®±ï¼Œéœ€è¦å–æ¶ˆé…ç½® //å–æ¶ˆä¹‹å‰çš„å…¨å±€é…ç½® git config --global --unset user.name git config --global --unset user.email //è®¾ç½®å±€éƒ¨ç”¨æˆ·åå’Œé‚®ç®± git config --local user.name \"xx\" git config --local user.email \"xx@xx.com\" ç¬¬äº”æ­¥ã€ä½¿ç”¨git gitçš„ä½¿ç”¨ä¸€èˆ¬æ˜¯ä»å…¶ä»–ä»“åº“ç›´æ¥cloneæˆ–æœ¬åœ°æ–°å»ºä»“åº“ æ–¹å¼ä¸€ï¼šcloneä»“åº“åˆ°æœ¬åœ° åŸå…ˆå†™æ³• git clone git@github.com:ç”¨æˆ·å/ä»“åº“.git ç°åœ¨çš„å†™æ³• //è¿™é‡Œè·ç¦»äº†oneç”¨æˆ·çš„å†™æ³•ï¼Œtwoç”¨æˆ·çš„æ“ä½œä¸€æ · git clone git@one.github.com:oneçš„ç”¨æˆ·å/ä»“åº“.git å¦‚æœéœ€è¦é‡å»ºorigin //æ¸…ç©ºåŸæœ‰çš„ git remote rm origin //ä½¿ç”¨sshæ–¹å¼æ·»åŠ è¿œç¨‹ä»“åº“ git remote add origin git@one.github.com:one/ä»“åº“å.git âš ï¸âš ï¸âš ï¸è¿™é‡Œæœ‰ä¸ªå‘ï¼Œæ·»åŠ è¿œç¨‹ä»“åº“æ—¶ï¼Œä»githubä»“åº“çš„Clone or downloadä¸‹çš„Use SSHå¤åˆ¶çš„è·¯å¾„éœ€è¦ä¿®æ”¹ âš ï¸âš ï¸âš ï¸è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨sshæ–¹å¼æ·»åŠ è¿œç¨‹ä»“åº“åŸå…ˆå†™æ³•æ˜¯è¿™æ ·çš„ git@github.com:one/ä»“åº“å.git ç°åœ¨éœ€è¦ä¿®æ”¹ä¸ºå¦‚ä¸‹å†™æ³• it remote add origin git@one.github.com:one/ä»“åº“å.git æ–¹å¼äºŒã€æ¨é€æœ¬åœ°ä»“åº“ //åˆå§‹åŒ–æœ¬åœ°ä»“åº“ git init //åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¹¶æäº¤åˆ°æœ¬åœ°ä»“åº“ touch test git add . git commit -m \"first commit\" //pushåˆ°githubä¸Šå» git remote add origin git@one.github.com:one/ä»“åº“å.git git push origin master æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"macä½¿ç”¨è®°å½•/macä½¿ç”¨gitbookè®°å½•.html":{"url":"macä½¿ç”¨è®°å½•/macä½¿ç”¨gitbookè®°å½•.html","title":"macä½¿ç”¨gitbookè®°å½•","keywords":"","body":"macä½¿ç”¨gitbookè®°å½• 1.gitbookæ­å»º 1.1å®‰è£…node.js å®˜ç½‘ä¸‹è½½macç‰ˆæœ¬çš„node.js 1.2æ£€æµ‹node.jsæ˜¯å¦å®‰è£…æˆåŠŸ npm -v 6.12.1 1.3å®‰è£…gitbootå’Œå‘½ä»¤è¡Œå·¥å…·(-g ä»£è¡¨å…¨å±€å®‰è£…) //å®‰è£… sudo npm install -g gitbook sudo npm install -g gitbook-cli //æŸ¥çœ‹ç‰ˆæœ¬ gitbook -V CLI version: 2.3.2 GitBook version: 3.2.3 //æ›´æ–°gitbookå‘½ä»¤è¡Œå·¥å…· sudo npm update gitbook-cli -g //å¸è½½gitbookå‘½ä»¤ sudo npm uninstall gitbook-cli -g 2.gitbookçš„ä½¿ç”¨ 2.1åˆ›å»ºgitbookç›®å½• //åˆ›å»ºgitbookç›®å½• sudo mkdir /gitbook //åˆå§‹åŒ–gitbook cd /gitbook && sudo gitbook init //åˆå§‹åŒ–å®Œæˆåä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ README.md #é¡¹ç›®ä»‹ç»æ–‡ä»¶ SUMMARY.md #gitbookç›®å½•ç»“æ„ 2.2é…ç½®gitbookç”Ÿæˆä¹¦ç± 1.ç¼–è¾‘SUMMARY.mdï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹(è¿™é‡Œä»…åšç¤ºä¾‹) # Summary * [Linux](README.md) * [LinuxåŸºç¡€](README.md) * [Linuxå‘½ä»¤](README.md) * [vimå‘½ä»¤](README.md) * [vimå‘½ä»¤](linux/linuxå‘½ä»¤/vimå‘½ä»¤.md) âš ï¸vimå‘½ä»¤.mdçš„è·¯å¾„æ˜¯/gitbook/linux/linuxå‘½ä»¤ 2.æ„å»ºä¹¦ç±(âš ï¸æ„å»ºå‘½ä»¤å¿…é¡»åœ¨SUMMARY.mdåŒè·¯å¾„ä¸‹) sudo gitbook build 3.å¯åŠ¨gitbook sudo gitbook serve & gitbooké»˜è®¤ç›‘å¬4000ç«¯å£ å¯åŠ¨gitbookæŠ¥é”™ //gitbook serveå¯åŠ¨gitbookæŠ¥é”™å¦‚ä¸‹ Error: ENOENT: no such file or directory, stat '/gitbook/_book/gitbook/gitbook-plugin-livereload/plugin.js',Error: ENOENT: no such file or directory, stat '/gitbook/_book/gitbook/gitbook-plugin-livereload' //è§£å†³æ–¹æ³• æ‰¾åˆ°copyPluginAssets.jsæ–‡ä»¶ï¼Œå…¨éƒ¨æ›¿æ¢ å°† confirm: true æ”¹ä¸º confirm: false /Users/baixuebing/.gitbook/versions/3.2.3/lib/output/website/copyPluginAssets.js 3.ä¿®æ”¹gitbookä»£ç æ¡†å­—ä½“å¤§å° prismnode_modules/themes/themes/prism-base16-ateliersulphurpool.light.css 13ã€14è¡Œ font-size: 18px; line-height: 1.6; 4.è®¾ç½®gitbookå¼€æœºè‡ªå¯ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"macä½¿ç”¨è®°å½•/brewæ›¿æ¢å›½å†…æº.html":{"url":"macä½¿ç”¨è®°å½•/brewæ›¿æ¢å›½å†…æº.html","title":"brewæ›¿æ¢å›½å†…æº","keywords":"","body":"brewæ›¿æ¢å›½å†…æº //æ›¿æ¢brew.git: cd \"$(brew --repo)\" #ä¸­å›½ç§‘å¤§: git remote set-url origin https://mirrors.ustc.edu.cn/brew.git #æ¸…åå¤§å­¦: git remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git //æ›¿æ¢homebrew-core.git: cd \"$(brew --repo)/Library/Taps/homebrew/homebrew-core\" #ä¸­å›½ç§‘å¤§: git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git #æ¸…åå¤§å­¦: git remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git //æ›¿æ¢homebrew-bottles: #ä¸­å›½ç§‘å¤§: echo 'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles' >> ~/.bash_profile source ~/.bash_profile #æ¸…åå¤§å­¦: echo 'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles' >> ~/.bash_profile source ~/.bash_profile #åº”ç”¨ç”Ÿæ•ˆ: brew update é‡ç½®brew #é‡ç½®brew.git: cd \"$(brew --repo)\" git remote set-url origin https://github.com/Homebrew/brew.git #é‡ç½®homebrew-core.git: cd \"$(brew --repo)/Library/Taps/homebrew/homebrew-core\" git remote set-url origin https://github.com/Homebrew/homebrew-core.git æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"macä½¿ç”¨è®°å½•/mac sshå¯†é’¥è½¬æ¢é—®é¢˜.html":{"url":"macä½¿ç”¨è®°å½•/mac sshå¯†é’¥è½¬æ¢é—®é¢˜.html","title":"mac sshå¯†é’¥è½¬æ¢","keywords":"","body":"mac sshå¯†é’¥è½¬æ¢é—®é¢˜ ä¸€ã€é—®é¢˜æè¿° èƒŒæ™¯è¯´æ˜ è¿ç»´è·³æ¿æœºæ˜¯é€šè¿‡æœ¬æœºçš„å¯†é’¥æ–¹å¼ç™»é™†çš„ï¼Œå³æŠŠè¿ç»´æœ¬æœºçš„å…¬é’¥æ·»åŠ åˆ°è·³æ¿æœºçš„ authorized_keys æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡ç§é’¥ç™»é™† é—®é¢˜è¯´æ˜ macä½¿ç”¨å‘½ä»¤ ssh-keygen ç”Ÿæˆçš„rsaå¯†é’¥æ˜¯å¦‚ä¸‹æ ¼å¼çš„ -----BEGIN OPENSSH PRIVATE KEY----- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -----END OPENSSH PRIVATE KEY----- ä½¿ç”¨ ZenTermLite ç™»é™†æœåŠ¡å™¨æŠ¥é”™å¦‚ä¸‹ å¹¶ä¸”ä½¿ç”¨ FinallShell ç™»é™†æœåŠ¡å™¨æç¤ºå¦‚ä¸‹ äºŒã€å¯†é’¥æ ¼å¼è½¬æ¢ æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œå¯†é’¥æ ¼å¼è½¬æ¢å³å¯ ssh-keygen -p -m PEM -f ç§é’¥è·¯å¾„ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"gitæ€»ç»“/gitåˆæ¬¡ä½¿ç”¨ç®€å•è®°å½•.html":{"url":"gitæ€»ç»“/gitåˆæ¬¡ä½¿ç”¨ç®€å•è®°å½•.html","title":"gitåˆæ¬¡ä½¿ç”¨è®°å½•","keywords":"","body":"1.gitåˆæ¬¡ä½¿ç”¨ ç¬¬ä¸€æ­¥ã€åˆæ¬¡ä½¿ç”¨éœ€è¦è¿›è¡Œå…¨å±€é…ç½® æ“ä½œå‘½ä»¤ git config --global user.name \"ä½ çš„ç”¨æˆ·å\" git config --global user.email \"é‚®ç®±\" ç¬¬äºŒæ­¥ã€gitæœ¬åœ°ä»“åº“åˆå§‹åŒ– å®‰è£…å®Œgitåï¼Œéœ€è¦è¿›å…¥åˆ°å­˜æ”¾ä»£ç çš„ç›®å½•ä¸‹ï¼Œè¿›è¡Œåˆå§‹åŒ–(å¦‚æœå†æ¬¡åˆ›å»ºäº†ä¸€ä¸ªç›®å½•ï¼Œåˆ™éœ€è¦é‡æ–°åˆå§‹åŒ–) åˆå§‹åŒ–å‘½ä»¤ git init åˆå§‹åŒ–å®Œæˆåï¼Œä¼šåœ¨å½“å‰è·¯å¾„ä¸‹ç”Ÿæˆä¸€ä¸ª.gitç›®å½• ls -a . .. .git .idea test.py ç¬¬ä¸‰æ­¥ã€æäº¤ä»£ç è‡³æœ¬åœ°ä»“åº“ åˆå§‹åŒ–gitä»“åº“å®Œæˆåï¼Œéœ€è¦å°†ä»£ç ç›®å½•ä¸‹çš„å†…å®¹æäº¤è‡³æœ¬åœ°ä»“åº“ git add . #.è¡¨ç¤ºåŒ¹é…å½“å‰ä»£ç è·¯å¾„ä¸‹æ‰€æœ‰å†…å®¹ ç¬¬å››æ­¥ã€å‘ŠçŸ¥æœ¬åœ°ä»“åº“æäº¤çš„å†…å®¹ä¿¡æ¯ å°†ä»£ç è·¯å¾„ä¸‹çš„å†…å®¹æäº¤è‡³æœ¬åœ°ä»“åº“åï¼Œéœ€è¦å‘ŠçŸ¥æäº¤è‡³æœ¬åœ°ä»“åº“çš„å†…å®¹ä¿¡æ¯ git commit -m \"æäº¤çš„ä¿¡æ¯å†…å®¹\" ç¬¬äº”æ­¥ã€ä¸è¿œç¨‹ä»“åº“å»ºç«‹è¿æ¥ å°†ä»£ç ç›®å½•ä¸‹çš„æ–‡ä»¶æäº¤è‡³æœ¬åœ°ä»“åº“åï¼Œéœ€è¦ä¸è¿œç¨‹ä»“åº“å»ºç«‹è¿æ¥ä»è€Œå°†æœ¬åœ°ä»“åº“ä¸­çš„å†…å®¹æäº¤è‡³è¿œç¨‹ä»“åº“ git remote add origin è¿œç¨‹ä»“åº“åœ°å€ ç¬¬å…­æ­¥ã€å°†æœ¬åœ°ä»£ç ä»“åº“æ–‡ä»¶æ¨é€è‡³è¿œç¨‹ä»“åº“ ä¸è¿œç¨‹ä»“åº“å»ºç«‹è¿æ¥åï¼Œéœ€è¦å°†æœ¬åœ°ä»“åº“ä¸­çš„æ–‡ä»¶æ¨é€è‡³è¿œç¨‹ä»“åº“ git push -u origin master #è¾“å…¥è¿œç¨‹ä»“åº“çš„ç”¨æˆ·åå’Œå¯†ç å³å¯ 2.gitéåˆæ¬¡ä½¿ç”¨ ç¬¬ä¸€æ­¥ã€æäº¤ä»£ç è‡³æœ¬åœ°ä»“åº“ åˆå§‹åŒ–gitä»“åº“å®Œæˆåï¼Œéœ€è¦å°†ä»£ç ç›®å½•ä¸‹çš„å†…å®¹æäº¤è‡³æœ¬åœ°ä»“åº“ git add . #.è¡¨ç¤ºåŒ¹é…å½“å‰ä»£ç è·¯å¾„ä¸‹æ‰€æœ‰å†…å®¹ ç¬¬äºŒæ­¥ã€å‘ŠçŸ¥æœ¬åœ°ä»“åº“æäº¤çš„å†…å®¹ä¿¡æ¯ å°†ä»£ç è·¯å¾„ä¸‹çš„å†…å®¹æäº¤è‡³æœ¬åœ°ä»“åº“åï¼Œéœ€è¦å‘ŠçŸ¥æäº¤è‡³æœ¬åœ°ä»“åº“çš„å†…å®¹ä¿¡æ¯ git commit -m \"æäº¤çš„ä¿¡æ¯å†…å®¹\" ç¬¬ä¸‰æ­¥ã€å°†æœ¬åœ°ä»£ç ä»“åº“æ–‡ä»¶æ¨é€è‡³è¿œç¨‹ä»“åº“ ä¸è¿œç¨‹ä»“åº“å»ºç«‹è¿æ¥åï¼Œéœ€è¦å°†æœ¬åœ°ä»“åº“ä¸­çš„æ–‡ä»¶æ¨é€è‡³è¿œç¨‹ä»“åº“ git push -u origin master #è¾“å…¥è¿œç¨‹ä»“åº“çš„ç”¨æˆ·åå’Œå¯†ç å³å¯ 3.å…³äºgitæ‹‰å–ä»£ç å†²çªé—®é¢˜ 3.1 éµå®ˆåŸåˆ™ ä¸åˆ é™¤è¿œç¨‹ä»“åº“çš„ä»£ç  å¦‚éœ€åˆ é™¤ä»£ç ï¼Œåˆ™åªåˆ é™¤æœ¬åœ°çš„ 3.2æ‰‹è´±åˆ é™¤è¿œç¨‹ä»“åº“æ–‡ä»¶å¯¼è‡´ä»£ç å†²çªæ¢å¤æ¼”ç¤º 3.2.1 è¿œç¨‹ä»£ç ä»“åº“ä¸­æœ‰ä»¥ä¸‹å†…å®¹ï¼Œæ­¤æ—¶è¿œç¨‹ä»“åº“å’Œæœ¬åœ°ä»“åº“ä¸­çš„å†…å®¹ç›¸åŒ 3.2.2 æ‰‹åŠ¨åˆ é™¤è¿œç¨‹ä»“åº“ä¸­çš„testæ–‡ä»¶ï¼Œåˆ é™¤åå†…å®¹ä¸ºä¸‹ 3.2.3 æ‰‹åŠ¨åˆ é™¤è¿œç¨‹ä»“åº“æ–‡ä»¶åï¼Œè¿œç¨‹ä»“åº“å’Œæœ¬åœ°ä»“åº“ä¸­çš„å†…å®¹å°±ä¸åŒäº†ï¼Œæ­¤æ—¶å†æ¬¡æ–°å»ºæ–‡ä»¶æäº¤å°±ä¼šæœ‰å†²çª æœ¬åœ°ä»“åº“ä¸­æ–°å»ºæ–‡ä»¶test111ï¼Œå°è¯•æäº¤ï¼ŒæŠ¥é”™ è§£å†³æ–¹æ³• 3.2.4 å…ˆæ‹‰å–ä»£ç  git pull origin master è¾“å…¥æ‹‰å–ä»£ç çš„å‘½ä»¤åä¼šæç¤ºå¦‚ä¸‹ï¼Œæ„æ€ä¸ºè¯·è¾“å…¥ä¸€æ¡æäº¤æ¶ˆæ¯æ¥è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦åˆå¹¶ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©ä¸è¾“å…¥ 3.2.5 åŠ é€‰é¡¹ --allow-unrelated-histories (å…è®¸åˆå¹¶ä¸ç›¸å…³çš„å†å²è®°å½•)å†æ¬¡æ‹‰å– git pull origin master --allow-unrelated-histories 3.2.6 å†æ¬¡æäº¤ä»£ç å³å¯,ä¸ä¼šæŠ¥é”™ âš ï¸å› ä¸ºå·²ç»åˆ é™¤äº†è¿œç¨‹ä»“åº“ä¸­çš„ç›®å½•ï¼Œå› æ­¤æœ¬åœ°çš„ç›®å½•åœ¨æäº¤ä¹‹åä¹Ÿä¼šè¢«åˆ é™¤ å› æ­¤,ä¸è¦åˆ é™¤è¿œç¨‹ä»“åº“ä¸­çš„æ–‡ä»¶ï¼ï¼ï¼ git push origin master æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"gitæ€»ç»“/gitæ–°å»ºä»“åº“åè¿è¡ŒæŒ‡ä»¤è¯´æ˜.html":{"url":"gitæ€»ç»“/gitæ–°å»ºä»“åº“åè¿è¡ŒæŒ‡ä»¤è¯´æ˜.html","title":"gitæ–°å»ºä»“åº“åè¿è¡ŒæŒ‡ä»¤è¯´æ˜","keywords":"","body":"Command line instructionsï¼ˆå‘½ä»¤è¡ŒæŒ‡ä»¤ï¼‰ You can also upload existing files from your computer using the instructions below.ï¼ˆæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯´æ˜ä»æ‚¨çš„è®¡ç®—æœºä¸Šè½½ç°æœ‰æ–‡ä»¶ï¼‰ Git global setupï¼ˆgitå…¨å±€é…ç½®ï¼‰ git config --global user.name \"Administrator\" git config --global user.email \"admin@example.com\" gitæœ¬åœ°é…ç½® git config --local user.name \"ä½ çš„åå­—\" git config --local user.email \"é‚®ç®±\" Create a new repositoryï¼ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ä»“åº“ï¼‰ git clone http://gitlab.example.com/root/python-exercise.git cd python-exercise touch README.md git add README.md git commit -m \"add README\" git push -u origin master Push an existing folderï¼ˆæ¨é€ç°æœ‰æ–‡ä»¶å¤¹ï¼‰ cd existing_folder git init git remote add origin http://gitlab.example.com/root/python-exercise.git git add . git commit -m \"Initial commit\" git push -u origin master Push an existing Git repositoryï¼ˆæ¨é€ç°æœ‰gitä»“åº“ï¼‰ cd existing_repo git remote rename origin old-origin git remote add origin http://gitlab.example.com/root/python-exercise.git git push -u origin --all git push -u origin --tags æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"gitæ€»ç»“/gitå‘½ä»¤æ€»ç»“.html":{"url":"gitæ€»ç»“/gitå‘½ä»¤æ€»ç»“.html","title":"gitå‘½ä»¤æ€»ç»“","keywords":"","body":"ä¸€ã€gitç®€ä»‹ 1.1gitå·¥ä½œæµç¨‹ 1.2gitå››ç§çŠ¶æ€ äºŒã€gitå‘½ä»¤æ€»ç»“ 2.1gitå·¥ä½œåŒºåŸŸåŠæ–‡ä»¶é¢œè‰² git status æ–‡ä»¶ä¸‰ç§é¢œè‰²çš„å˜åŒ– çº¢è‰² æ–°å¢æ–‡ä»¶æˆ–è€…ä¿®æ”¹çš„æ—§æ–‡ä»¶-->æ‰§è¡Œå‘½ä»¤git add .æˆ–è€…git add æ–‡ä»¶å ç»¿è‰² gitå·²ç»ç®¡ç†èµ·æ¥çš„æ–‡ä»¶-->æ‰§è¡Œå‘½ä»¤git commit -m 'æè¿°ä¿¡æ¯' ç™½è‰² å·²ç»ç”Ÿæˆç‰ˆæœ¬çš„æ–‡ä»¶ 2.2gitæäº¤æ•°æ® 1.åˆ›å»ºæ–‡ä»¶ [root@test1 test]# touch aaa bbb 2.æŸ¥çœ‹gitæ–‡ä»¶çŠ¶æ€ï¼ˆæ­¤æ—¶æ–‡ä»¶æ˜¯çº¢è‰²çš„ï¼Œå±äºæ–°å¢æ–‡ä»¶ï¼‰ [root@test1 test]# git status On branch master Untracked files: (use \"git add ...\" to include in what will be committed) aaa bbb nothing added to commit but untracked files present (use \"git add\" to track) 3.æäº¤æ–‡ä»¶è‡³æš‚å­˜åŒº [root@test1 test]# git add . //æ­¤æ—¶å†æŸ¥çœ‹æ–‡ä»¶ï¼Œæ–‡ä»¶æ˜¯ç»¿è‰²çš„ï¼Œå·²è¢«gitç®¡ç†èµ·æ¥ [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: aaa new file: bbb 2.3gitåˆ é™¤æ•°æ® 2.3.1gitåˆ é™¤æš‚å­˜åŒºä¸­çš„æ–‡ä»¶git rm --cached //gitåˆ é™¤æš‚å­˜åŒºä¸­çš„æ–‡ä»¶ [root@test1 test]# git rm --cached aaa bbb rm 'aaa' rm 'bbb' //æ­¤æ—¶æ–‡ä»¶å˜å›çº¢è‰² [root@test1 test]# git status On branch master Untracked files: (use \"git add ...\" to include in what will be committed) aaa bbb nothing added to commit but untracked files present (use \"git add\" to track) 2.3.2gitåˆ é™¤å·¥ä½œåŒºå’Œæš‚å­˜åŒºä¸­çš„æ–‡ä»¶git rm -f æ–‡ä»¶å //æŸ¥çœ‹æš‚å­˜åŒºä¸­çš„æ–‡ä»¶ï¼Œæ­¤æ—¶æ˜¯ç»¿è‰²çš„ [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: aaa new file: bbb //åˆ é™¤å·¥ä½œåŒºçš„æ–‡ä»¶åŒæ—¶æš‚å­˜åŒºä¸­çš„æ–‡ä»¶ä¹Ÿä¼šåŒæ—¶è¢«åˆ é™¤ [root@test1 test]# git rm -f aaa bbb rm 'aaa' rm 'bbb' [root@test1 test]# ls [root@test1 test]# git status On branch master nothing to commit, working tree clean 2.4gitç§»åŠ¨æ•°æ® 2.4.1gitæäº¤æ•°æ®è‡³ç‰ˆæœ¬åº“git commit -m 'æè¿°ä¿¡æ¯' //åˆ›å»ºæ–‡ä»¶ [root@test1 test]# touch aaa bbb //æäº¤æ–‡ä»¶è‡³æš‚å­˜åŒº [root@test1 test]# git add . //æ­¤æ—¶æ–‡ä»¶æ˜¯ç»¿è‰²çš„ [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: aaa new file: bbb //æäº¤æ–‡ä»¶è‡³ç‰ˆæœ¬åº“ [root@test1 test]# git commit -m 'touch aaa bbb' [master 7215e51] touch aaa bbb 2 files changed, 0 insertions(+), 0 deletions(-) create mode 100644 aaa create mode 100644 bbb //æ­¤æ—¶å†æŸ¥çœ‹æ–‡ä»¶æš‚å­˜åŒºä¸­å·²ç»æ²¡æœ‰äº†ï¼Œå·²ç»è¢«gitç®¡ç†èµ·æ¥äº† [root@test1 test]# git status On branch master nothing to commit, working tree clean 2.4.2gitç§»åŠ¨æ•°æ®ï¼Œæœ‰æ—¶ä¼šå°†å·²ç»æ·»åŠ è‡³æš‚å­˜åŒºçš„æ–‡ä»¶é‡å‘½ågit mv åŸæ–‡ä»¶ æ–°æ–‡ä»¶ //æ­¤æ—¶æ–‡ä»¶æ˜¯ç»¿è‰²çš„ [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: aaa new file: bbb //ç°åœ¨æƒ³æŠŠæš‚å­˜åŒºä¸­çš„æ–‡ä»¶aaaä¿®æ”¹ä¸ºAAA root@test1 test]# git mv aaa AAA [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: AAA new file: bbb //æäº¤æ–‡ä»¶è‡³gitç‰ˆæœ¬åº“ [root@test1 test]# git commit -m 'change file aaa->AAA' [master 7de2d02] change file aaa->AAA 2 files changed, 0 insertions(+), 0 deletions(-) create mode 100644 AAA create mode 100644 bbb 2.5gitå†å²æ•°æ® 2.5.1gitæŸ¥çœ‹å†å²æ•°æ®git log //æŸ¥çœ‹å…¨éƒ¨æ—¥å¿— [root@test1 test]# git log commit 7de2d02e662b1c47cb23085240860bf6a8d0d800 (HEAD -> master) Author: ä»€ä¹ˆéƒ½ä¸ä¼š Date: Sun Feb 23 21:10:03 2020 +0800 change file aaa->AAA commit b32661c0627eb5cdac793c3e80bcc89f3d40a13d (origin/master) Author: ä»€ä¹ˆéƒ½ä¸ä¼š Date: Sun Feb 23 20:00:47 2020 +0800 æ¸…ç©ºæ–‡ä»¶ commit 61acb78adac52288805ab59992e9c260866186f0 Author: ä»€ä¹ˆéƒ½ä¸ä¼š Date: Sat Feb 22 22:16:24 2020 +0800 å¿½ç•¥æ–‡ä»¶æµ‹è¯• ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ //æŒ‡å®šæ˜¾ç¤ºæ—¥å¿—ä¸ªæ•° [root@test1 test]# git log -n 1 commit 7de2d02e662b1c47cb23085240860bf6a8d0d800 (HEAD -> master) Author: ä»€ä¹ˆéƒ½ä¸ä¼š Date: Sun Feb 23 21:10:03 2020 +0800 change file aaa->AAA 2.5.2gitä»¥ä¸€è¡Œçš„å½¢å¼æŸ¥çœ‹æ—¥å¿—git log --oneline //ä½†æ˜¯æ²¡æœ‰æ—¶é—´æ˜¾ç¤º [root@test1 test]# git log --oneline 7de2d02 (HEAD -> master) change file aaa->AAA b32661c (origin/master) æ¸…ç©ºæ–‡ä»¶ 61acb78 å¿½ç•¥æ–‡ä»¶æµ‹è¯• 4901535 å¿½ç•¥æ–‡ä»¶æµ‹è¯• 1b7cabd æäº¤å¿½ç•¥æ–‡ä»¶ a32513a (bug) masteræ¸…ç©ºæµ‹è¯•æ–‡ä»¶ 42f05ec æ–‡ä»¶å†…å®¹å°±æ˜¯æ–‡ä»¶å d66565f caonima 4ae41d2 æäº¤haha hehe test c266f9e touch hehe 7e353d7 å¢åŠ testæ–‡ä»¶å†…å®¹ 9f30440 touch test //æ›´é•¿æ˜¾ç¤ºcommitå· [root@test1 test]# git log --pretty=oneline 7de2d02e662b1c47cb23085240860bf6a8d0d800 (HEAD -> master) change file aaa->AAA b32661c0627eb5cdac793c3e80bcc89f3d40a13d (origin/master) æ¸…ç©ºæ–‡ä»¶ 61acb78adac52288805ab59992e9c260866186f0 å¿½ç•¥æ–‡ä»¶æµ‹è¯• 49015353f48daf06f8e14c8d11f692eae795caa1 å¿½ç•¥æ–‡ä»¶æµ‹è¯• 1b7cabd3ee779d68da6cf07241bd8a8dc1542ad4 æäº¤å¿½ç•¥æ–‡ä»¶ a32513a471688ba24dff4851ce7b2100314c5497 (bug) masteræ¸…ç©ºæµ‹è¯•æ–‡ä»¶ 42f05ec321aa987ecf5da2fc303ead235bd59822 æ–‡ä»¶å†…å®¹å°±æ˜¯æ–‡ä»¶å d66565f107148d0827bbed931616a5f21b9bc581 caonima 4ae41d2706308d05fae5ef2183e7f6933bd955e0 æäº¤haha hehe test c266f9ebd1d9bdac4fe8ce265484cf1c58ca6c68 touch hehe 7e353d71a408ec7414e42cbd51b39f208a16d618 å¢åŠ testæ–‡ä»¶å†…å®¹ 9f30440387a13fec21d0de2e0e55ce12e32cd5ae touch test 2.5.3æ˜¾ç¤ºå…·ä½“å†…å®¹å˜åŒ–git log -p [root@test1 test]# git log -p commit 7de2d02e662b1c47cb23085240860bf6a8d0d800 (HEAD -> master) Author: ä»€ä¹ˆéƒ½ä¸ä¼š Date: Sun Feb 23 21:10:03 2020 +0800 change file aaa->AAA diff --git a/AAA b/AAA new file mode 100644 index 0000000..e69de29 diff --git a/bbb b/bbb new file mode 100644 index 0000000..e69de29 ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 2.5.4ç®€è¦æ˜¾ç¤ºæ–‡ä»¶ä¿®æ”¹è¡Œæ•°git log --stat [root@test1 test]# git log --stat commit 7de2d02e662b1c47cb23085240860bf6a8d0d800 (HEAD -> master) Author: ä»€ä¹ˆéƒ½ä¸ä¼š Date: Sun Feb 23 21:10:03 2020 +0800 change file aaa->AAA AAA | 0 bbb | 0 2 files changed, 0 insertions(+), 0 deletions(-) ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 2.5.5æ ¹æ®ä¸åŒæ ¼å¼å±•ç¤ºå†å²æäº¤ä¿¡æ¯git hlog å¯ä»¥ä½¿ç”¨formatå‚æ•°æ¥æŒ‡å®šå…·ä½“çš„è¾“å‡ºæ ¼å¼ï¼Œè¿™æ ·éå¸¸ä¾¿äºåæœŸç¼–ç¨‹çš„æå–åˆ†æï¼Œå¸¸ç”¨çš„æ ¼å¼æœ‰ï¼š %s æäº¤è¯´æ˜ %cd æäº¤æ—¥æœŸ %an ä½œè€…çš„åå­— %cn æäº¤è€…çš„å§“å %ce æäº¤è€…çš„ç”µå­é‚®ä»¶ %H æäº¤å¯¹è±¡çš„å®Œæ•´SHA-1å“ˆå¸Œå­—ä¸² %h æäº¤å¯¹è±¡çš„ç®€çŸ­SHA-1å“ˆå¸Œå­—ä¸² %T æ ‘å¯¹è±¡çš„å®Œæ•´SHA-1å“ˆå¸Œå­—ä¸² %t æ ‘å¯¹è±¡çš„ç®€çŸ­SHA-1å“ˆå¸Œå­—ä¸² %P çˆ¶å¯¹è±¡çš„å®Œæ•´SHA-1å“ˆå¸Œå­—ä¸² %p çˆ¶å¯¹è±¡çš„ç®€çŸ­SHA-1å“ˆå¸Œå­—ä¸² %ad ä½œè€…çš„ä¿®è®¢æ—¶é—´ [root@test1 test]# git log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr)%Creset %cn\"' --abbrev-commit --date=relative * 7de2d02 - (HEAD -> master) change file aaa->AAA (73 minutes ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * b32661c - (origin/master) æ¸…ç©ºæ–‡ä»¶ (2 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * 61acb78 - å¿½ç•¥æ–‡ä»¶æµ‹è¯• (24 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * 4901535 - å¿½ç•¥æ–‡ä»¶æµ‹è¯• (24 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * 1b7cabd - æäº¤å¿½ç•¥æ–‡ä»¶ (24 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * a32513a - (bug) masteræ¸…ç©ºæµ‹è¯•æ–‡ä»¶ (24 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * 42f05ec - æ–‡ä»¶å†…å®¹å°±æ˜¯æ–‡ä»¶å (25 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * d66565f - caonima (25 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * 4ae41d2 - æäº¤haha hehe test (25 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * c266f9e - touch hehe (25 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * 7e353d7 - å¢åŠ testæ–‡ä»¶å†…å®¹ (27 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" * 9f30440 - touch test (28 hours ago) ä»€ä¹ˆéƒ½ä¸ä¼š\" //è®¾ç½®å‘½ä»¤åˆ«åï¼Œç”¨git hlogä»£æ›¿ä»¥ä¸Šå¤æ‚å‘½ä»¤ cat >>.git/config 2.6gitæ¢å¤æ•°æ® 2.6.1æ¢å¤å†å²æ•°æ® æƒ…å†µä¸€ï¼šä¿®æ”¹äº†æœ¬åœ°ç›®å½•çš„æ–‡ä»¶å¹¶ä¸”æäº¤åˆ°äº†æš‚å­˜åŒº 1.ç¤ºä¾‹æ–‡ä»¶aaaåŸå…ˆå†…å®¹ [root@test1 test]# [root@test1 test]# cat aaa aaa 2.æäº¤æ–‡ä»¶aaaè‡³æš‚å­˜åŒº [root@test1 test]# git add aaa //æ­¤æ—¶æ–‡ä»¶æ˜¯ç»¿è‰²ï¼Œå·²æäº¤è‡³æš‚å­˜åŒº [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: aaa 3.ä¿®æ”¹æ–‡ä»¶å†…å®¹ [root@test1 test]# echo test >>aaa [root@test1 test]# cat aaa aaa test 4.æŸ¥çœ‹æ–‡ä»¶çŠ¶æ€ [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: aaa Changes not staged for commit: (use \"git add ...\" to update what will be committed) (use \"git restore ...\" to discard changes in working directory) modified: aaa 5.ä»æš‚å­˜åŒºè¦†ç›–æœ¬åœ°ç›®å½•æ–‡ä»¶ [root@test1 test]# git checkout -- aaa [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: aaa 6.æŸ¥çœ‹æ–‡ä»¶ï¼Œæ­¤æ—¶æ–‡ä»¶å·²ç»æ¢å¤è‡³åŸå…ˆå†…å®¹ [root@test1 test]# cat aaa aaa æƒ…å†µäºŒï¼šä¿®æ”¹äº†å·¥ä½œç›®å½•æ–‡ä»¶åæäº¤åˆ°äº†æš‚å­˜åŒºå’Œæœ¬åœ°ä»“åº“ 1.åˆ›å»ºæ–‡ä»¶bbb [root@test1 test]# touch bbb 2.æŸ¥çœ‹æ–‡ä»¶çŠ¶æ€ï¼Œæ­¤æ—¶æ–‡ä»¶æ˜¯çº¢è‰²çš„ï¼Œè¿˜æ²¡æœ‰æäº¤åˆ°æš‚å­˜åŒº [root@test1 test]# git status On branch master Untracked files: (use \"git add ...\" to include in what will be committed) bbb nothing added to commit but untracked files present (use \"git add\" to track) 3.å¾€æ–‡ä»¶bbbä¸­å†™å…¥å†…å®¹ [root@test1 test]# echo bbb>bbb [root@test1 test]# cat bbb bbb 4.æäº¤æ–‡ä»¶bbbè‡³æš‚å­˜åŒº [root@test1 test]# git add bbb 5.æŸ¥çœ‹æ–‡ä»¶çŠ¶æ€ï¼Œæ­¤æ—¶æ–‡ä»¶æ˜¯ç»¿è‰²çš„ [root@test1 test]# git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) new file: bbb 6.æäº¤æ–‡ä»¶bbbè‡³æœ¬åœ°ä»“åº“ [root@test1 test]# git commit -m 'bbb' [master 1dbe8c2] bbb 1 file changed, 1 insertion(+) create mode 100644 bbb 7.æŸ¥çœ‹æ–‡ä»¶çŠ¶æ€ï¼Œæ­¤æ—¶æš‚å­˜åŒºä¸­çš„æ–‡ä»¶å·²ç»æäº¤åˆ°æœ¬åœ°ä»“åº“äº† [root@test1 test]# git status On branch master nothing to commit, working tree clean 8.å†æ¬¡å¾€æ–‡ä»¶bbbä¸­è¿½åŠ å†…å®¹ï¼Œå¤šæ¬¡è¿½åŠ å¹¶æäº¤ ç¬¬ä¸€æ¬¡ï¼Œè¿½åŠ å†…å®¹1åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶æäº¤è‡³æš‚å­˜åŒºå’Œæœ¬åœ°ä»“åº“ [root@test1 test]# echo 1 >> bbb [root@test1 test]# cat bbb bbb 1 [root@test1 test]# git add . [root@test1 test]# git commit -m 'echo 1 >> bbb' [master 65d12a7] echo 1 >> bbb 1 file changed, 1 insertion(+) ç¬¬äºŒæ¬¡ï¼Œè¿½åŠ å†…å®¹2åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶æäº¤è‡³æš‚å­˜åŒºå’Œæœ¬åœ°ä»“åº“ [root@test1 test]# echo 2 >> bbb [root@test1 test]# cat bbb bbb 1 2 [root@test1 test]# git add . [root@test1 test]# git commit -m 'echo 2 >> bbb' [master da5695e] echo 2 >> bbb 1 file changed, 1 insertion(+) 9.æ­¤æ—¶æ–‡ä»¶bbbå†…å®¹å¦‚ä¸‹ [root@test1 test]# cat bbb bbb 1 2 //æš‚å­˜åŒºä¸­æ²¡æœ‰å†…å®¹ [root@test1 test]# git status On branch master nothing to commit, working tree clean 10.æŸ¥çœ‹æ—¥å¿— [root@test1 test]# git log --oneline da5695e (HEAD -> master) echo 2 >> bbb 65d12a7 echo 1 >> bbb 1dbe8c2 bbb ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 11.æ¢å¤æ–‡ä»¶å†…å®¹åªæœ‰bbb [root@test1 test]# git reset --hard 1dbe8c2 HEAD is now at 1dbe8c2 bbb [root@test1 test]# cat bbb bbb 12.æ¢å¤æ–‡ä»¶å†…å®¹åªæœ‰bbbå’Œ1 [root@test1 test]# git reset --hard 65d12a7 HEAD is now at 65d12a7 echo 1 >> bbb [root@test1 test]# cat bbb bbb 1 #æ¢å¤è‡³ä¸€ä¸ªç‰ˆæœ¬åï¼Œé€šè¿‡git logå‘½ä»¤æŸ¥çœ‹åˆ°çš„æ—¥å¿—å°±åªæˆªæ­¢åˆ°å½“å‰ç‰ˆæœ¬ï¼Œä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„ä¸ä¼šè®°å½•ï¼Œå› æ­¤ï¼Œå¦‚æœéœ€è¦æŸ¥çœ‹å…¨éƒ¨æ—¥å¿—è®°å½•ï¼Œéœ€è¦ç”¨åˆ°å‘½ä»¤git reflogï¼Œæ­¤æ—¶å°±å¯ä»¥æ ¹æ®git reflogæ¢å¤è‡³ä»»æ„ç‰ˆæœ¬äº† [root@test1 test]# git reflog 65d12a7 (HEAD -> master) HEAD@{0}: reset: moving to 65d12a7 1dbe8c2 HEAD@{1}: reset: moving to 1dbe8c2 da5695e HEAD@{2}: commit: echo 2 >> bbb 65d12a7 (HEAD -> master) HEAD@{3}: commit: echo 1 >> bbb 1dbe8c2 HEAD@{4}: commit: bbb git reflogæŸ¥çœ‹å…¨éƒ¨æ—¥å¿—è®°å½• gitæ¢å¤ç‰ˆæœ¬è¯´æ˜ gitæœåŠ¡ç¨‹åºä¸­æœ‰ä¸€ä¸ªå«åšHEADçš„ç‰ˆæœ¬æŒ‡é’ˆï¼Œå½“ç”¨æˆ·ç”³è¯·è¿˜åŸæ•°æ®æ—¶ï¼Œå…¶å®å°±æ˜¯å°†HEADæŒ‡é’ˆæŒ‡å‘åˆ°æŸä¸ªç‰¹å®šçš„æäº¤ç‰ˆæœ¬ï¼Œä½†æ˜¯å› ä¸ºgitæ˜¯åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œä¸ºäº†é¿å…å†å²è®°å½•å†²çªï¼Œæ•…ä½¿ç”¨äº†SHA-1è®¡ç®—å‡ºåå…­è¿›åˆ¶çš„å“ˆå¸Œå­—ä¸²æ¥åŒºåˆ†æ¯ä¸ªæäº¤ç‰ˆæœ¬ï¼Œå¦å¤–é»˜è®¤çš„HEADç‰ˆæœ¬æŒ‡é’ˆä¼šæŒ‡å‘åˆ°æœ€è¿‘çš„ä¸€æ¬¡æäº¤ç‰ˆæœ¬è®°å½• gitæ¢å¤ç‰ˆæœ¬é‡ç‚¹ 1.æŸ¥çœ‹æ—¥å¿—ï¼Œè·å–å¯¹åº”çš„æ“ä½œHEADæŒ‡é’ˆ 2.æ ¹æ®è·å–åˆ°çš„HEADæŒ‡é’ˆç„¶åè¿›è¡Œ git reset --hard æŒ‡é’ˆç¼–å· 2.7gitåˆ†æ”¯ 2.7.1gitåˆ†æ”¯å‘½ä»¤æ€»ç»“ åˆ›å»ºåˆ†æ”¯ git branch åˆ†æ”¯å åˆ‡æ¢åˆ†æ”¯ git checkout åˆ†æ”¯å åˆ—å‡ºåˆ†æ”¯ git branch åˆ é™¤åˆ†æ”¯ git branch -d åˆ†æ”¯å åˆå¹¶åˆ†æ”¯ git merge åˆ†æ”¯å åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯ git checkout -b åˆ†æ”¯å(åˆ›å»ºåˆ†æ”¯çš„åŒæ—¶åˆ‡æ¢åˆ°è¿™ä¸ªåˆ†æ”¯) 2.7.2gitåˆ†æ”¯åˆå¹¶ //masteråˆ†æ”¯åˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥å†…å®¹ [root@test1 test]# echo 'masteråˆ†æ”¯åˆ›å»ºçš„å†…å®¹' > txt [root@test1 test]# git add . [root@test1 test]# git commit -m 'masteråˆ†æ”¯åˆ›å»ºçš„å†…å®¹' //åˆ›å»ºåˆ‡æ¢åˆ°devåˆ†æ”¯å¹¶å†™å…¥å†…å®¹ [root@test1 test]# git checkout -b dev Switched to a new branch 'dev' [root@test1 test]# git branch * dev master [root@test1 test]# cat txt masteråˆ†æ”¯åˆ›å»ºçš„å†…å®¹ [root@test1 test]# echo 'devåˆ†æ”¯åˆ›å»ºçš„å†…å®¹' >> txt [root@test1 test]# cat txt masteråˆ†æ”¯åˆ›å»ºçš„å†…å®¹ devåˆ†æ”¯åˆ›å»ºçš„å†…å®¹ [root@test1 test]# git add . [root@test1 test]# git commit -m 'devåˆ†æ”¯åˆ›å»ºçš„å†…å®¹' //åˆ‡æ¢åˆ°masteråˆ†æ”¯ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶æ–‡ä»¶çš„å†…å®¹è¿˜æ²¡æœ‰devåˆ†æ”¯å†™å…¥çš„å†…å®¹ï¼Œéœ€è¦åˆå¹¶æ‰å¯ä»¥æ˜¾ç¤º [root@test1 test]# git checkout master Switched to branch 'master' [root@test1 test]# git branch dev * master [root@test1 test]# cat txt masteråˆ†æ”¯åˆ›å»ºçš„å†…å®¹ //åˆå¹¶åˆ†æ”¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåˆå¹¶åˆ†æ”¯ådevåˆ†æ”¯å†™å…¥çš„å†…å®¹æ­¤æ—¶å·²ç»æœ‰äº† [root@test1 test]# git merge dev Updating 1f0edf7..a87487f Fast-forward txt | 1 + 1 file changed, 1 insertion(+) [root@test1 test]# cat txt masteråˆ†æ”¯åˆ›å»ºçš„å†…å®¹ devåˆ†æ”¯åˆ›å»ºçš„å†…å®¹ 2.7.3gitåˆå¹¶å†²çª åˆå¹¶å¹¶ä¸ä»…ä»…æ˜¯ç®€å•çš„æ–‡ä»¶æ·»åŠ ã€ç§»é™¤çš„æ“ä½œï¼Œgit ä¹Ÿä¼šåˆå¹¶ä¿®æ”¹ã€‚ //åœ¨masteråˆ†æ”¯åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶test.txtï¼Œæ³¨æ„âš ï¸è¿™é‡Œä¸ºäº†æ¼”ç¤ºå†²çªï¼Œä¸èƒ½å°†æ–‡ä»¶æäº¤è‡³masteråˆ†æ”¯ [root@test1 test]# git branch * master [root@test1 test]# touch test.txt [root@test1 test]# cat test.txt [root@test1 test]# //åˆ›å»ºä¸€ä¸ªdevåˆ†æ”¯å¹¶åˆ‡æ¢è¿‡å»ï¼Œç„¶åä¿®æ”¹test.txtæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶è®²test.txtæ–‡ä»¶çš„ä¿®æ”¹æäº¤åˆ°devåˆ†æ”¯ [root@test1 test]# git checkout -b dev Switched to a new branch 'dev' [root@test1 test]# cat test.txt [root@test1 test]# echo 'devåˆ†æ”¯ä¿®æ”¹test.txtæ–‡ä»¶' > test.txt [root@test1 test]# cat test.txt devåˆ†æ”¯ä¿®æ”¹test.txtæ–‡ä»¶ [root@test1 test]# git add . [root@test1 test]# git commit -m 'devåˆ†æ”¯ä¿®æ”¹test.txtæ–‡ä»¶' [dev 3d85604] devåˆ†æ”¯ä¿®æ”¹test.txtæ–‡ä»¶ 1 file changed, 1 insertion(+) create mode 100644 test.txt //åˆ‡æ¢å›masteråˆ†æ”¯ï¼Œæ­¤æ—¶çœ‹ä¸åˆ°test.txtæ–‡ä»¶ï¼Œå› ä¸ºæ–‡ä»¶å·²ç»è¢«æäº¤åˆ°devåˆ†æ”¯äº†ï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†æ¼”ç¤ºå†²çªæ‰‹åŠ¨å†æ¬¡å‘test.txtæ–‡ä»¶å†™å…¥å†…å®¹ [root@test1 test]# git branch dev * master [root@test1 test]# ls [root@test1 test]# [root@test1 test]# echo 'masteråˆ†æ”¯ä¿®æ”¹test.txtæ–‡ä»¶' > test.txt [root@test1 test]# git add . [root@test1 test]# git commit -m 'masteråˆ†æ”¯ä¿®æ”¹æ–‡ä»¶' [master 3eefd57] masteråˆ†æ”¯ä¿®æ”¹æ–‡ä»¶ 1 file changed, 1 insertion(+) create mode 100644 test.txt //åˆå¹¶devåˆ†æ”¯ï¼Œæ­¤æ—¶ä¼šæœ‰å†²çªæŠ¥é”™ [root@test1 test]# git merge dev CONFLICT (add/add): Merge conflict in test.txt Auto-merging test.txt Automatic merge failed; fix conflicts and then commit the result. //æŸ¥çœ‹æ–‡ä»¶ï¼Œæœ‰ç®­å¤´çš„åœ°æ–¹å°±æ˜¯æœ‰å†²çªçš„åœ°æ–¹ï¼Œåˆ é™¤è¿™éƒ¨åˆ†å†åˆå¹¶å°±å¯ä»¥äº† [root@test1 test]# cat test.txt >>>>>> dev //ä¿®æ”¹åçš„æ–‡ä»¶å¦‚ä¸‹ [root@test1 test]# cat test.txt masteråˆ†æ”¯ä¿®æ”¹test.txtæ–‡ä»¶ devåˆ†æ”¯ä¿®æ”¹test.txtæ–‡ä»¶ //git addå‘Šè¯‰gitæ–‡ä»¶å†²çªå·²è§£å†³ [root@test1 test]# git add . [root@test1 test]# git commit -m 'è§£å†³åˆå¹¶å†²çª' [master 6fd4fd2] è§£å†³åˆå¹¶å†²çª [root@test1 test]# git merge dev Already up to date. æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"markdownè¯­æ³•æ€»ç»“/markdownå¸¸ç”¨è¯­æ³•ç®€è®°.html":{"url":"markdownè¯­æ³•æ€»ç»“/markdownå¸¸ç”¨è¯­æ³•ç®€è®°.html","title":"markdownå¸¸ç”¨è¯­æ³•ç®€è®°","keywords":"","body":"Markdownå¸¸è§„è¯­æ³• ä¸€ã€æ ‡é¢˜ # 1ä¸ª#ä»£è¡¨ä¸€çº§æ ‡é¢˜ï¼Œmacå¿«æ·é”® command+1 ## 2ä¸ª#ä»£è¡¨äºŒçº§æ ‡é¢˜ï¼Œmacå¿«æ·é”® command+2 ### 3ä¸ª#ä»£è¡¨ä¸‰çº§æ ‡é¢˜ï¼Œmacå¿«æ·é”® command+3 #### 4ä¸ª#ä»£è¡¨å››çº§æ ‡é¢˜ï¼Œmacå¿«æ·é”® command+4 ##### 5ä¸ª#ä»£è¡¨äº”çº§æ ‡é¢˜ï¼Œmacå¿«æ·é”® command+5 ###### 6ä¸ª#ä»£è¡¨å…­çº§æ ‡é¢˜ï¼Œmacå¿«æ·é”® command+6 æœ€å°åˆ°å…­çº§æ ‡é¢˜ï¼Œ#å·åè¾¹å¿…é¡»æœ‰ä¸€ä¸ªç©ºæ ¼ ä¸€çº§æ ‡é¢˜ äºŒçº§æ ‡é¢˜ ä¸‰çº§æ ‡é¢˜ å››çº§æ ‡é¢˜ äº”çº§æ ‡é¢˜ å…­çº§æ ‡é¢˜ äºŒã€åˆ—è¡¨ æœ‰åºåˆ—è¡¨ æ•°å­—1. ç©ºæ ¼ æ— åºåˆ—è¡¨ -å·ç©ºæ ¼ +å·ç©ºæ ¼ *å·ç©ºæ ¼ å®å¿ƒé»‘åœ†ï¼Œæœ‰åºåˆ—è¡¨ç›¸åŒä½çº§ï¼ŒæŒ‰-å·ç„¶åç©ºæ ¼ ç©ºå¿ƒåœ†ï¼Œæœ‰åºåˆ—è¡¨ä¸‹ä¸€çº§ï¼ŒæŒ‰-å·ç„¶åç©ºæ ¼ å®å¿ƒé»‘æ–¹å—ï¼Œç©ºå¿ƒåœ†çš„ä¸‹ä¸€å­£ï¼ŒæŒ‰-å·ç„¶åç©ºæ ¼ ä¸‰ã€ä»£ç å— å¤šè¡Œä»£ç å— ä¸‰ä¸ª```ï¼Œä¸€å¯¹ å¤šè¡Œä»£ç å— å¤šè¡Œä»£ç å— ã€‚ã€‚ã€‚ å•è¡Œä»£ç å— ä¸¤ä¸ª``ï¼Œä¸€å¯¹ å•è¡Œä»£ç å— å››ã€è¡¨æ ¼ macå¿«æ·é”® command+option+T --- --- äº”ã€å›¾ç‰‡ å…­ã€è¶…é“¾æ¥ ç¤ºä¾‹ ç™¾åº¦ è¯­æ³• #ä¸­æ‹¬å·ä¸­å†™é“¾æ¥åç§°ï¼Œ()ä¸­å†™ç½‘å€ï¼Œç½‘å€å½¢å¼ä¸ºhttp://xxxæˆ–è€…https://xxx macå¿«æ·é”® command+K ä¸ƒã€åŠ ç²— ç¤ºä¾‹ åŠ ç²— è¯­æ³• **åŠ ç²—å†…å®¹** macå¿«æ·é”® command+B å…«ã€å€¾æ–œ ç¤ºä¾‹ å€¾æ–œ è¯­æ³• *å€¾æ–œ* macå¿«æ·é”® command+I ä¹ã€åˆ†å‰²çº¿ ç¤ºä¾‹ è¯­æ³• ---æˆ–è€…+++æˆ–è€…*** macå¿«æ·é”® command+option+- åã€é¢œè‰²ï¼ˆéœ€è¦å€ŸåŠ©å‰ç«¯æ ‡ç­¾å®ç°ï¼‰ ç¤ºä¾‹ é¢œè‰² è¯­æ³• å†…å®¹ æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "},"linux/linuxå†…æ ¸/Linuxå‡çº§å†…æ ¸.html":{"url":"linux/linuxå†…æ ¸/Linuxå‡çº§å†…æ ¸.html","title":"Linuxå‡çº§å†…æ ¸","keywords":"","body":"Linuxå‡çº§å†…æ ¸ CentOS7.6é»˜è®¤å†…æ ¸ç‰ˆæœ¬æ˜¯3.10 $ uname -r 3.10.0-1062.el7.x86_64 centos7å†…æ ¸ä¸‹è½½åœ°å€ å¯æ ¹æ®è‡ªå·±å®é™…éœ€æ±‚ä¸‹è½½å¯¹åº”ç‰ˆæœ¬ ç°åœ¨å‡çº§åˆ°æœ€æ–°ç‰ˆï¼Œç¼–è¾‘å®‰è£…æœ€æ–°å†…æ ¸è„šæœ¬ cat > /opt/kernel_update.sh æ³¡æ³¡åè‚¥çš‚o Â© gitbook.pptfz.top 2020 all right reservedï¼Œpowered by Gitbookæ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š ç§ƒç¬”å—æ³¢æ¹¾ï¼ï¼ï¼ "}}